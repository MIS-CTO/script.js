<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wannado Booking</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: auto !important; min-height: auto !important; overflow: visible !important; overflow-y: visible !important; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background: #ffffff; color: #1d1d1f; line-height: 1.5; padding: 0; margin: 0; }
    .container { max-width: 100%; width: 100%; margin: 0; padding: 0; height: auto !important; max-height: none !important; overflow: visible !important; }
    .header { text-align: left; margin-bottom: 32px; }
    .header h1 { font-size: 1.975rem; font-weight: 400; letter-spacing: 0.02em; margin-bottom: 0; }
    .filter-tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; justify-content: flex-start; }
    .filter-tab { padding: 0 24px; height: 50px; line-height: 50px; background: white; border: 1px solid rgba(0,0,0,0.1); border-radius: 0; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
    .filter-tab:hover { border-color: #333; }
    .filter-tab.active { background: #333; color: white; border-color: #333; }
    .wannado-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 16px; margin-bottom: 32px; align-items: stretch; height: auto !important; max-height: none !important; overflow: visible !important; }
    .wannado-card { width: 100%; aspect-ratio: 2/3; border-radius: 0; background: white; overflow: hidden; position: relative; display: flex; flex-direction: column; box-shadow: 0 2px 8px rgba(0,0,0,0.06); cursor: pointer; transition: all 0.3s ease; }
    .wannado-card:hover { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0,0,0,0.12); }
    .wannado-image { width: 100%; flex: 1; object-fit: contain; background: #f5f5f5; border-radius: 0; min-height: 0; }
    .wannado-image-placeholder { width: 100%; flex: 1; background: #f5f5f5; display: flex; align-items: center; justify-content: center; font-size: 64px; border-radius: 0; min-height: 0; }
    .wannado-info { padding: 12px 16px; flex-shrink: 0; }
    .wannado-collection { font-size: 12px; color: #86868b; margin-bottom: 4px; }
    .wannado-name { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .wannado-meta { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
    .wannado-price { font-size: 20px; font-weight: 700; color: #333; }
    .wannado-duration { font-size: 14px; color: #86868b; }
    .empty-state { text-align: center; padding: 60px 20px; color: #86868b; }
    .empty-state-icon { font-size: 64px; margin-bottom: 16px; }
    .loading { text-align: center; padding: 60px 20px; }
    .spinner { width: 40px; height: 40px; border: 3px solid #f0f0f0; border-top-color: #333; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; padding: 20px; overflow: hidden; box-sizing: border-box; }
    .modal-backdrop.active { display: flex; }
    .modal { background: white; border-radius: 0; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .modal-header { padding: 24px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: flex-start; position: sticky; top: 0; background: white; z-index: 10; }
    .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #86868b; line-height: 1; }
    .modal-body { padding: 24px; }
    .selected-wannado { display: flex; gap: 16px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid rgba(0,0,0,0.1); }
    .selected-wannado img { width: 100px; height: 100px; border-radius: 0; object-fit: cover; }
    .selected-wannado-info { flex: 1; }
    .selected-wannado-info h3 { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .selected-wannado-info .artist { font-size: 14px; color: #86868b; margin-bottom: 8px; }
    .selected-wannado-info .price { font-size: 24px; font-weight: 700; color: #333; }
    .steps { display: flex; gap: 8px; margin-bottom: 24px; }
    .step { flex: 1; height: 4px; background: #e0e0e0; border-radius: 0; }
    .step.active { background: #333; }
    .step.completed { background: #333; }
    .form-section { display: none; }
    .form-section.active { display: block; }
    .form-section h4 { font-size: 14px; font-weight: 600; color: #86868b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; }
    .calendar { background: #f8f9fa; border-radius: 0; padding: 16px; margin-bottom: 24px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .calendar-header h5 { font-size: 16px; font-weight: 600; }
    .calendar-nav { display: flex; gap: 8px; }
    .calendar-nav button { width: 32px; height: 32px; border: none; background: white; border-radius: 0; cursor: pointer; font-size: 16px; }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px; }
    .calendar-weekdays span { text-align: center; font-size: 12px; color: #86868b; font-weight: 500; }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day { aspect-ratio: 1; border: none; background: white; border-radius: 0; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s ease; }
    .calendar-day:hover:not(:disabled) { background: #333; color: white; }
    .calendar-day.selected { background: #333; color: white; }
    .calendar-day:disabled { background: #f0f0f0; color: #ccc; cursor: not-allowed; }
    .calendar-day.other-month { color: #ccc; }
    .time-slots { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 24px; }
    .time-slot { padding: 12px; border: 1px solid rgba(0,0,0,0.1); background: white; border-radius: 0; text-align: center; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s ease; }
    .time-slot:hover { border-color: #333; }
    .time-slot.selected { background: #333; color: white; border-color: #333; }
    .no-slots { text-align: center; padding: 20px; color: #86868b; font-size: 14px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; }
    .form-group input { width: 100%; padding: 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 0; font-size: 14px; font-family: inherit; transition: border-color 0.2s; }
    .form-group input:focus { outline: none; border-color: #333; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .btn-row { display: flex; gap: 12px; margin-top: 24px; }
    .btn { flex: 1; padding: 14px 24px; border: none; border-radius: 0; font-size: 16px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s ease; }
    .btn-secondary { background: #f5f5f7; color: #1d1d1f; }
    .btn-secondary:hover { background: #e8e8ed; }
    .btn-primary { background: #333; color: white; }
    .btn-primary:hover { background: #444; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .booking-summary { background: #f8f9fa; border-radius: 0; padding: 16px; margin-bottom: 24px; }
    .summary-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }
    .summary-row.total { border-top: 1px solid rgba(0,0,0,0.1); margin-top: 8px; padding-top: 16px; font-size: 18px; font-weight: 700; }
    .summary-row.total .value { color: #333; }
    /* Artist Profile Card */
    .artist-profile-card { aspect-ratio: 4/3; position: relative; width: 100%; overflow: hidden; cursor: pointer; grid-column: auto; grid-row: auto; }
    /* Sold Out Overlay */
    .wannado-card.sold-out { pointer-events: none; }
    .wannado-card.sold-out .wannado-image, .wannado-card.sold-out .wannado-image-placeholder { opacity: 0.5; filter: grayscale(50%); }
    .sold-out-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; font-size: 14px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; z-index: 5; }
    .artist-profile-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
    .artist-profile-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0) 100%); }
    .artist-profile-content { position: absolute; bottom: 0; left: 0; right: 0; padding: 24px; display: flex; justify-content: space-between; align-items: flex-end; }
    .artist-profile-left { display: flex; flex-direction: column; gap: 4px; }
    .artist-profile-label { font-size: 12px; color: rgba(255,255,255,0.8); font-weight: 400; }
    .artist-profile-name { font-size: 28px; font-weight: 600; color: white; }
    .visit-profile-btn { display: flex; align-items: center; gap: 12px; padding: 12px 20px; border: 1px solid rgba(255,255,255,0.8); border-radius: 0; color: white; font-size: 14px; font-weight: 500; background: transparent; transition: all 0.2s ease; }
    .visit-profile-btn:hover { background: rgba(255,255,255,0.1); }
    .visit-profile-btn .arrow { font-size: 18px; }
    @media (max-width: 900px) {
      .wannado-grid { grid-template-columns: 1fr 1fr; }
      .artist-profile-card { grid-column: span 2; aspect-ratio: 16/9; }
    }
    @media (max-width: 500px) {
      .wannado-grid { grid-template-columns: 1fr; }
      .artist-profile-card { grid-column: span 1; aspect-ratio: 4/3; }
      .container { padding: 16px; }
      .header h1 { font-size: 24px; }
      .wannado-info { padding: 12px; }
      .wannado-name { font-size: 16px; }
      .modal { border-radius: 0; max-height: 95vh; margin-top: auto; }
      .selected-wannado { flex-direction: column; align-items: center; text-align: center; }
      .form-row { grid-template-columns: 1fr; }
      .time-slots { grid-template-columns: repeat(2, 1fr); }
      .artist-profile-name { font-size: 22px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Wannado Collections</h1>
    </div>
    <div class="filter-tabs" id="filterTabs">
      <button class="filter-tab active" data-artist="all">Alle</button>
    </div>
    <div id="wannadoGrid" class="wannado-grid">
      <div class="loading">
        <div class="spinner"></div>
        <p>Lade Motive...</p>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="bookingModal">
    <div class="modal">
      <div class="modal-header">
        <div><h2>Termin buchen</h2></div>
        <button class="modal-close" onclick="closeBookingModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="selected-wannado" id="selectedWannadoPreview"></div>
        <div class="steps">
          <div class="step active" data-step="1"></div>
          <div class="step" data-step="2"></div>
          <div class="step" data-step="3"></div>
        </div>
        <div class="form-section active" id="step1">
          <h4>1. W√§hle Datum & Uhrzeit</h4>
          <div class="calendar">
            <div class="calendar-header">
              <button onclick="prevMonth()">‚Äπ</button>
              <h5 id="calendarMonth">Dezember 2025</h5>
              <button onclick="nextMonth()">‚Ä∫</button>
            </div>
            <div class="calendar-weekdays">
              <span>Mo</span><span>Di</span><span>Mi</span><span>Do</span><span>Fr</span><span>Sa</span><span>So</span>
            </div>
            <div class="calendar-days" id="calendarDays"></div>
          </div>
          <h4 style="margin-top:24px;">Verf√ºgbare Zeiten</h4>
          <div class="time-slots" id="timeSlots">
            <div class="no-slots">W√§hle zuerst ein Datum</div>
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="goToStep(2)" id="toStep2Btn" disabled>Weiter</button>
          </div>
        </div>
        <div class="form-section" id="step2">
          <h4>2. Deine Kontaktdaten</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Vorname *</label>
              <input type="text" id="firstName" required placeholder="Max">
            </div>
            <div class="form-group">
              <label>Nachname *</label>
              <input type="text" id="lastName" required placeholder="Mustermann">
            </div>
          </div>
          <div class="form-group">
            <label>E-Mail *</label>
            <input type="email" id="email" required placeholder="max@beispiel.de">
          </div>
          <div class="form-group">
            <label>Telefon *</label>
            <input type="tel" id="phone" required placeholder="+49 170 1234567">
          </div>
          <div class="form-group">
            <label>Instagram (optional)</label>
            <input type="text" id="instagram" placeholder="@dein_name">
          </div>
          <div class="btn-row">
            <button class="btn btn-secondary" onclick="goToStep(1)">Zur√ºck</button>
            <button class="btn btn-primary" onclick="goToStep(3)">Weiter</button>
          </div>
        </div>
        <div class="form-section" id="step3">
          <h4>3. Zusammenfassung</h4>
          <div class="booking-summary" id="bookingSummary"></div>
          <div class="btn-row">
            <button class="btn btn-secondary" onclick="goToStep(2)">Zur√ºck</button>
            <button class="btn btn-primary" onclick="proceedToPayment()" id="payBtn">Jetzt bezahlen</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://auxxyehgzkozdjylhqnx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1eHh5ZWhnemtvemRqeWxocW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDczODgsImV4cCI6MjA3NjEyMzM4OH0.bg8NunF2qkps28Aj0ZqY35eKK--QOu8NduCkFyqp5KA';
    const EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/create-wannado-checkout`;
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let allWannados = [], allArtists = [], selectedWannado = null, selectedDate = null, selectedTime = null, currentMonth = new Date(), artistAvailability = {};

    document.addEventListener('DOMContentLoaded', async () => { await loadWannados(); renderCalendar(); });

    async function loadWannados() {
      try {
        const { data, error } = await supabaseClient
          .from('wannados')
          .select('*, artist:artists(id, name, profile_picture_url, instagram), collection:wannado_collections!inner(id, name, is_active)')
          .eq('collection.is_active', true)
          .in('status', ['available', 'sold'])
          .order('sort_order', { ascending: true });
        if (error) throw error;
        allWannados = data || [];
        const artistMap = new Map();
        allWannados.forEach(w => { if (w.artist) artistMap.set(w.artist.id, w.artist); });
        allArtists = Array.from(artistMap.values());
        renderFilterTabs();
        renderWannados();
      } catch (err) {
        console.error('Error:', err);
        document.getElementById('wannadoGrid').innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><h3>Fehler beim Laden</h3><p>${err.message}</p></div>`;
      }
    }

    function renderFilterTabs() {
      const container = document.getElementById('filterTabs');
      if (allArtists.length <= 1) {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'flex';
      container.innerHTML = `<button class="filter-tab active" data-artist="all" onclick="filterByArtist('all')">Alle</button>${allArtists.map(a => `<button class="filter-tab" data-artist="${a.id}" onclick="filterByArtist('${a.id}')">${a.name}</button>`).join('')}`;
    }

    function renderWannados(filter = 'all') {
      const container = document.getElementById('wannadoGrid');
      let filtered = filter === 'all' ? allWannados : allWannados.filter(w => w.artist?.id === filter);

      if (!filtered.length) {
        container.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">üé®</div><h3>Keine Motive verf√ºgbar</h3></div>`;
        return;
      }

      // Gruppiere nach Artist
      const byArtist = {};
      filtered.forEach(w => {
        const artistId = w.artist?.id || 'unknown';
        if (!byArtist[artistId]) {
          byArtist[artistId] = { artist: w.artist, wannados: [] };
        }
        byArtist[artistId].wannados.push(w);
      });

      let html = '';

      Object.values(byArtist).forEach(group => {
        const artist = group.artist;
        const wannados = group.wannados;

        // Artist Profile Card
        html += `
          <div class="artist-profile-card" onclick="window.open('${artist?.instagram ? 'https://instagram.com/' + artist.instagram.replace('@','') : '#'}', '_blank')">
            <img src="${artist?.profile_picture_url || ''}" alt="${artist?.name}" class="artist-profile-bg">
            <div class="artist-profile-overlay"></div>
            <div class="artist-profile-content">
              <div class="artist-profile-left">
                <span class="artist-profile-label">Resident</span>
                <span class="artist-profile-name">${artist?.name || 'Artist'}</span>
              </div>
              <div class="artist-profile-right">
                <span class="visit-profile-btn">Visit profile <span class="arrow">‚Üí</span></span>
              </div>
            </div>
          </div>
        `;

        // Wannado Cards
        wannados.forEach(w => {
          const isSold = w.status === 'sold';
          const collectionName = w.collection?.name || 'Wannado Collection';

          html += `
            <div class="wannado-card ${isSold ? 'sold-out' : ''}" ${!isSold ? `onclick="selectWannado('${w.id}')"` : ''}>
              ${isSold ? '<div class="sold-out-badge">Sold Out</div>' : ''}
              ${w.image_url
                ? `<img src="${w.image_url}" class="wannado-image">`
                : `<div class="wannado-image-placeholder">üé®</div>`
              }
              <div class="wannado-info">
                <div class="wannado-collection">${collectionName}</div>
                <div class="wannado-name">${w.name}</div>
                <div class="wannado-meta">
                  <span class="wannado-price">${Number(w.price).toFixed(0)}‚Ç¨</span>
                  <span class="wannado-duration">ca. ${w.duration_hours}h</span>
                </div>
              </div>
            </div>
          `;
        });
      });

      container.innerHTML = html;
    }

    function filterByArtist(id) {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.toggle('active', t.dataset.artist === id));
      renderWannados(id);
    }

    function selectWannado(id) {
      selectedWannado = allWannados.find(w => w.id === id);
      if (!selectedWannado) return;
      selectedDate = null; selectedTime = null; currentMonth = new Date();
      document.getElementById('selectedWannadoPreview').innerHTML = `${selectedWannado.image_url ? `<img src="${selectedWannado.image_url}">` : `<div style="width:100px;height:100px;background:#f0f0f0;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:32px;">üé®</div>`}<div class="selected-wannado-info"><h3>${selectedWannado.name}</h3><div class="artist">von ${selectedWannado.artist?.name || 'Artist'} ¬∑ ca. ${selectedWannado.duration_hours}h</div><div class="price">${Number(selectedWannado.price).toFixed(0)}‚Ç¨</div></div>`;
      goToStep(1);
      document.getElementById('bookingModal').classList.add('active');
      document.body.style.overflow = 'hidden';
      loadArtistAvailability();
    }

    function closeBookingModal() {
      document.getElementById('bookingModal').classList.remove('active');
      document.body.style.overflow = 'visible';
    }

    async function loadArtistAvailability() {
      if (!selectedWannado?.artist?.id) return;
      try {
        const today = new Date();
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + 60);
        const todayStr = today.toISOString().split('T')[0];
        const endDateStr = endDate.toISOString().split('T')[0];

        const { data, error } = await supabaseClient
          .from('dienstplan')
          .select('id, start_date, end_date, state, working_start, working_end')
          .eq('artist_id', selectedWannado.artist.id)
          .eq('state', 'Available')
          .lte('start_date', endDateStr)
          .gte('end_date', todayStr)
          .order('start_date', { ascending: true });

        if (error) throw error;

        // Erstelle availability map f√ºr jeden Tag im Zeitraum
        artistAvailability = {};
        (data || []).forEach(entry => {
          const start = new Date(entry.start_date);
          const end = new Date(entry.end_date);
          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            artistAvailability[dateStr] = {
              working_start: entry.working_start?.substring(0,5) || '10:00',
              working_end: entry.working_end?.substring(0,5) || '20:00'
            };
          }
        });

        renderCalendar();
      } catch (err) {
        console.error('Error loading availability:', err);
      }
    }

    function renderCalendar() {
      const container = document.getElementById('calendarDays'), monthLabel = document.getElementById('calendarMonth');
      const year = currentMonth.getFullYear(), month = currentMonth.getMonth();
      const monthNames = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
      monthLabel.textContent = `${monthNames[month]} ${year}`;
      const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0), totalDays = lastDay.getDate();
      let startingDay = firstDay.getDay() - 1; if (startingDay < 0) startingDay = 6;
      let html = ''; const today = new Date(); today.setHours(0,0,0,0);
      for (let i = 0; i < startingDay; i++) html += `<button class="calendar-day other-month" disabled></button>`;
      for (let day = 1; day <= totalDays; day++) {
        const date = new Date(year, month, day), dateStr = date.toISOString().split('T')[0];
        const isPast = date < today, hasAvail = artistAvailability[dateStr], isSelected = selectedDate === dateStr;
        html += `<button class="calendar-day ${isSelected ? 'selected' : ''}" ${isPast || !hasAvail ? 'disabled' : ''} onclick="selectDate('${dateStr}')">${day}</button>`;
      }
      container.innerHTML = html;
    }

    function prevMonth() { currentMonth.setMonth(currentMonth.getMonth() - 1); renderCalendar(); }
    function nextMonth() { currentMonth.setMonth(currentMonth.getMonth() + 1); renderCalendar(); }

    async function selectDate(dateStr) {
      selectedDate = dateStr; selectedTime = null;
      document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
      event.target.classList.add('selected');
      await loadTimeSlots(dateStr);
      document.getElementById('toStep2Btn').disabled = true;
    }

    async function loadTimeSlots(dateStr) {
      const container = document.getElementById('timeSlots');
      container.innerHTML = '<div class="no-slots">Lade Zeiten...</div>';
      const avail = artistAvailability[dateStr];
      if (!avail) { container.innerHTML = '<div class="no-slots">Keine Verf√ºgbarkeit</div>'; return; }

      try {
        // Erstelle Start und Ende des Tages f√ºr die Abfrage
        const dayStart = dateStr + 'T00:00:00';
        const dayEnd = dateStr + 'T23:59:59';

        const { data, error } = await supabaseClient
          .from('appointments')
          .select('start, end')
          .eq('artist_id', selectedWannado.artist.id)
          .gte('start', dayStart)
          .lte('start', dayEnd)
          .in('status', ['scheduled', 'confirmed']);

        if (error) throw error;

        // Konvertiere start/end zu Zeiten f√ºr die Slot-Berechnung
        const appointments = (data || []).map(apt => {
          const startDate = new Date(apt.start);
          const endDate = new Date(apt.end);
          return {
            scheduled_start: startDate.getHours().toString().padStart(2,'0') + ':' + startDate.getMinutes().toString().padStart(2,'0'),
            scheduled_end: endDate.getHours().toString().padStart(2,'0') + ':' + endDate.getMinutes().toString().padStart(2,'0')
          };
        });

        const slots = calculateSlots(avail.working_start, avail.working_end, appointments, selectedWannado.duration_hours);
        if (!slots.length) { container.innerHTML = '<div class="no-slots">Keine freien Zeiten</div>'; return; }
        container.innerHTML = slots.map(s => `<button class="time-slot" onclick="selectTimeSlot('${s.start}','${s.end}')">${s.start} - ${s.end}</button>`).join('');
      } catch (err) {
        console.error('Error:', err);
        container.innerHTML = '<div class="no-slots">Fehler beim Laden</div>';
      }
    }

    function calculateSlots(workStart, workEnd, appointments, duration) {
      const slots = [], durationMin = duration * 60;
      const toMin = t => { const [h,m] = t.split(':').map(Number); return h*60+m; };
      const toTime = m => `${Math.floor(m/60).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}`;
      const startMin = toMin(workStart), endMin = toMin(workEnd);
      const booked = appointments.map(a => ({ start: toMin(a.scheduled_start), end: toMin(a.scheduled_end) })).sort((a,b) => a.start - b.start);
      let curr = startMin;
      for (const b of booked) {
        let s = curr;
        while (s + durationMin <= b.start) { slots.push({ start: toTime(s), end: toTime(s + durationMin) }); s += 60; }
        curr = Math.max(curr, b.end);
      }
      let s = curr;
      while (s + durationMin <= endMin) { slots.push({ start: toTime(s), end: toTime(s + durationMin) }); s += 60; }
      return slots;
    }

    function selectTimeSlot(start, end) {
      selectedTime = { start, end };
      document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
      event.target.classList.add('selected');
      document.getElementById('toStep2Btn').disabled = false;
    }

    function goToStep(step) {
      document.querySelectorAll('.step').forEach((s,i) => { s.classList.remove('active','completed'); if (i+1 < step) s.classList.add('completed'); if (i+1 === step) s.classList.add('active'); });
      document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');
      if (step === 3) updateSummary();
    }

    function updateSummary() {
      const dateStr = new Date(selectedDate).toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      document.getElementById('bookingSummary').innerHTML = `<div class="summary-row"><span>Motiv</span><span>${selectedWannado.name}</span></div><div class="summary-row"><span>Artist</span><span>${selectedWannado.artist?.name}</span></div><div class="summary-row"><span>Datum</span><span>${dateStr}</span></div><div class="summary-row"><span>Uhrzeit</span><span>${selectedTime.start} - ${selectedTime.end} Uhr</span></div><div class="summary-row"><span>Dauer</span><span>ca. ${selectedWannado.duration_hours}h</span></div><div class="summary-row total"><span>Gesamtpreis</span><span class="value">${Number(selectedWannado.price).toFixed(0)}‚Ç¨</span></div>`;
    }

    async function proceedToPayment() {
      const btn = document.getElementById('payBtn');
      btn.disabled = true; btn.textContent = 'Wird verarbeitet...';
      try {
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const instagram = document.getElementById('instagram').value.trim();
        if (!firstName || !lastName || !email || !phone) { alert('Bitte alle Pflichtfelder ausf√ºllen.'); goToStep(2); btn.disabled = false; btn.textContent = 'Jetzt bezahlen'; return; }
        const res = await fetch(EDGE_FUNCTION_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ wannado_id: selectedWannado.id, customer_email: email, customer_first_name: firstName, customer_last_name: lastName, customer_phone: phone, customer_instagram: instagram || null, selected_date: selectedDate, selected_start_time: selectedTime.start, selected_end_time: selectedTime.end }) });
        const result = await res.json();
        if (!res.ok) throw new Error(result.error || 'Fehler');
        if (result.checkout_url) window.top.location.href = result.checkout_url;
        else throw new Error('Keine Checkout-URL');
      } catch (err) { console.error('Error:', err); alert('Fehler: ' + err.message); btn.disabled = false; btn.textContent = 'Jetzt bezahlen'; }
    }

    document.getElementById('bookingModal').addEventListener('click', e => { if (e.target.id === 'bookingModal') closeBookingModal(); });
  </script>
</body>
</html>
