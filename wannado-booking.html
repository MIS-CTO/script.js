<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wannado Booking</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    @font-face { font-family: "Town 80"; src: url("https://cdn.prod.website-files.com/68b5db0f0b26c2723e743d3f/68c1c01886c4c9f12d2c8270_Town80Text-Book.ttf") format("truetype"); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: "Town 80"; src: url("https://cdn.prod.website-files.com/68b5db0f0b26c2723e743d3f/68c1c01839b39a437aef50b9_Town80Text-BookItalic.ttf") format("truetype"); font-weight: 400; font-style: italic; font-display: swap; }
    @font-face { font-family: "Town 80"; src: url("https://cdn.prod.website-files.com/68b5db0f0b26c2723e743d3f/68c1c0183a1db3419b61d312_Town80Text-Medium.ttf") format("truetype"); font-weight: 500; font-style: normal; font-display: swap; }
    @font-face { font-family: "Town 80"; src: url("https://cdn.prod.website-files.com/68b5db0f0b26c2723e743d3f/68c1c01882f4cb4556b96d37_Town80Text-Bold.ttf") format("truetype"); font-weight: 700; font-style: normal; font-display: swap; }
    @font-face { font-family: "Town 80"; src: url("https://cdn.prod.website-files.com/68b5db0f0b26c2723e743d3f/68c1c01862dc7cb8c4cee795_Town80Text-Light.ttf") format("truetype"); font-weight: 300; font-style: normal; font-display: swap; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: auto !important; min-height: auto !important; overflow: visible !important; overflow-y: visible !important; }
    body { font-family: "Town 80", system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background: #ffffff; color: #1d1d1f; line-height: 1.5; padding: 0; margin: 0; }
    .container { max-width: 100%; width: 100%; margin: 0; padding: 0; height: auto !important; max-height: none !important; overflow: visible !important; }
    .header { display: none; }
    .filter-tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; justify-content: flex-start; }
    .filter-tab { padding: 0 24px; height: 50px; line-height: 50px; width: 300px; text-align: center; background: white; border: 1px solid rgba(0,0,0,0.1); border-radius: 0; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; box-sizing: border-box; }
    .filter-tab:hover { border-color: #333; }
    .filter-tab.active { background: #333; color: white; border-color: #333; }
    .wannado-grid { display: flex; flex-direction: column; gap: 4px; width: 100%; margin-bottom: 32px; height: auto !important; max-height: none !important; overflow: visible !important; }
    .collection-row { width: 100%; }
    .collection-header { width: 100%; display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
    .collection-title { font-size: clamp(0.75rem, 1.5vw, 0.875rem); font-weight: 500; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
    .collection-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; width: 100%; }
    .wannado-card { width: 100%; aspect-ratio: 3/4; position: relative; overflow: hidden; cursor: pointer; }
    .artist-profile-card { aspect-ratio: 3/4; position: relative; width: 100%; overflow: hidden; cursor: pointer; }
    @keyframes fadeInLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
    .collection-cards > * { animation: fadeInLeft .4s cubic-bezier(.25,.1,.25,1) forwards; opacity: 0; }
    .collection-cards > *:nth-child(1) { animation-delay: 0s; }
    .collection-cards > *:nth-child(2) { animation-delay: .05s; }
    .collection-cards > *:nth-child(3) { animation-delay: .1s; }
    .collection-cards > *:nth-child(4) { animation-delay: .15s; }
    .collection-cards > *:nth-child(5) { animation-delay: .2s; }
    .collection-cards > *:nth-child(6) { animation-delay: .25s; }
    .collection-cards > *:nth-child(7) { animation-delay: .3s; }
    .collection-cards > *:nth-child(8) { animation-delay: .35s; }
    .wannado-card .card-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
    .wannado-card .card-image img { width: 100%; height: 100%; object-fit: cover; transition: transform .5s; }
    .wannado-card:hover .card-image img { transform: scale(1.05); }
    .wannado-card .card-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, rgba(0,0,0,.8) 0%, rgba(0,0,0,.4) 30%, rgba(0,0,0,0) 60%); z-index: 5; pointer-events: none; }
    .wannado-card .card-content { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; z-index: 10; display: flex; flex-direction: column; gap: 4px; }
    .wannado-card .card-name { margin: 0; font-size: 1.2rem; font-weight: 500; color: #fff; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,.3); }
    .wannado-card .card-meta { display: flex; justify-content: space-between; align-items: center; }
    .wannado-card .card-price { font-size: .9rem; font-weight: 500; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,.3); }
    .wannado-card .card-duration { font-size: .8rem; color: #999; text-shadow: 0 1px 2px rgba(0,0,0,.3); }
    .wannado-image-placeholder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f0f0f0; }
    .empty-state { text-align: center; padding: 60px 20px; color: #86868b; }
    .empty-state-icon { font-size: 64px; margin-bottom: 16px; }
    .loading { text-align: center; padding: 60px 20px; }
    .spinner { width: 40px; height: 40px; border: 3px solid #f0f0f0; border-top-color: #333; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; max-height: 100vh; background: rgba(255,255,255,1); z-index: 9999; align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto; box-sizing: border-box; }
    .modal-backdrop.active { display: flex; }
    body.modal-open { overflow: hidden; height: 100vh; }
    .modal { background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: calc(100vh - 40px); overflow-y: auto; box-shadow: none; }
    .modal-header { padding: 24px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: flex-start; position: sticky; top: 0; background: white; z-index: 10; }
    .modal-header h2 { font-size: clamp(1.25rem, 3vw, 1.5rem); }
    .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #86868b; line-height: 1; }
    .modal-body { padding: 24px; }
    .selected-wannado { display: flex; gap: 16px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid rgba(0,0,0,0.1); }
    .selected-wannado img { width: 100px; height: 100px; border-radius: 0; object-fit: cover; }
    .selected-wannado-info { flex: 1; }
    .selected-wannado-info h3 { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .selected-wannado-info .artist { font-size: 14px; color: #86868b; margin-bottom: 8px; }
    .selected-wannado-info .price { font-size: 24px; font-weight: 700; color: #333; }
    .steps { display: flex; gap: 8px; margin-bottom: 24px; }
    .step { flex: 1; height: 4px; background: #e0e0e0; border-radius: 0; }
    .step.active { background: #333; }
    .step.completed { background: #333; }
    .form-section { display: none; }
    .form-section.active { display: block; }
    .form-section h4 { font-size: clamp(0.75rem, 1.5vw, 0.875rem); font-weight: 600; color: #86868b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; }
    .calendar { background: #f8f9fa; border-radius: 0; padding: 16px; margin-bottom: 24px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .calendar-header h5 { font-size: 16px; font-weight: 600; }
    .calendar-nav { display: flex; gap: 8px; }
    .calendar-nav button { width: 32px; height: 32px; border: none; background: white; border-radius: 0; cursor: pointer; font-size: 16px; }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px; }
    .calendar-weekdays span { text-align: center; font-size: 12px; color: #86868b; font-weight: 500; }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day { aspect-ratio: 1; border: none; background: white; border-radius: 0; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s ease; }
    .calendar-day:hover:not(:disabled) { background: #333; color: white; }
    .calendar-day.selected { background: #333; color: white; }
    .calendar-day:disabled { background: #f0f0f0; color: #ccc; cursor: not-allowed; }
    .calendar-day.other-month { color: #ccc; }
    .time-slots { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 24px; }
    .time-slot { padding: 12px; border: 1px solid rgba(0,0,0,0.1); background: white; border-radius: 0; text-align: center; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s ease; }
    .time-slot:hover { border-color: #333; }
    .time-slot.selected { background: #333; color: white; border-color: #333; }
    .no-slots { text-align: center; padding: 20px; color: #86868b; font-size: 14px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; }
    .form-group input { width: 100%; padding: 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 0; font-size: 14px; font-family: inherit; transition: border-color 0.2s; }
    .form-group input:focus { outline: none; border-color: #333; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .btn-row { display: flex; gap: 12px; margin-top: 24px; }
    .btn { flex: 1; padding: 14px 24px; border: none; border-radius: 0; font-size: 16px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s ease; }
    .btn-secondary { background: #f5f5f7; color: #1d1d1f; }
    .btn-secondary:hover { background: #e8e8ed; }
    .btn-primary { background: #333; color: white; }
    .btn-primary:hover { background: #444; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .booking-summary { background: #f8f9fa; border-radius: 0; padding: 16px; margin-bottom: 24px; }
    .summary-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }
    .summary-row.total { border-top: 1px solid rgba(0,0,0,0.1); margin-top: 8px; padding-top: 16px; font-size: 18px; font-weight: 700; }
    .summary-row.total .value { color: #333; }
    /* Artist Profile Card */
    .artist-profile-card .card-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
    .artist-profile-card .card-image img { width: 100%; height: 100%; object-fit: cover; transition: transform .5s, opacity .5s; }
    .artist-profile-card .card-image .hover-img { position: absolute; top: 0; left: 0; opacity: 0; z-index: 2; }
    .artist-profile-card:hover .card-image .hover-img { opacity: 1; }
    .artist-profile-card:hover .card-image img:first-child { transform: scale(1.05); }
    .artist-profile-card .card-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, rgba(0,0,0,.8) 0%, rgba(0,0,0,.4) 30%, rgba(0,0,0,0) 60%); z-index: 5; pointer-events: none; }
    .artist-profile-card .card-content { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; z-index: 10; display: flex; flex-direction: column; gap: 12px; }
    .artist-profile-card .card-info { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
    .artist-profile-card .card-name { margin: 0; font-size: 1.4rem; font-weight: 500; color: #fff; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,.3); }
    .artist-profile-card .card-style { margin: 0; font-size: .8rem; color: #999; text-shadow: 0 1px 2px rgba(0,0,0,.3); }
    .artist-profile-card .card-buttons { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .artist-profile-btn { background: transparent; color: #fff; border: 1px solid #fff; padding: 8px 14px; font-size: 14px; font-weight: 500; white-space: nowrap; cursor: pointer; transition: all .2s; display: flex; align-items: center; gap: 6px; text-decoration: none; }
    .artist-profile-btn:hover { background: rgba(255,255,255,.1); }
    .artist-profile-btn svg { width: 14px; height: 14px; }
    /* Sold Out Overlay */
    .wannado-card.sold-out { pointer-events: none; }
    .wannado-card.sold-out .card-image img, .wannado-card.sold-out .wannado-image-placeholder { opacity: 0.5; filter: grayscale(50%); }
    .sold-out-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: none; color: white; padding: 12px 24px; font-size: 14px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; z-index: 15; text-shadow: 0 1px 4px rgba(0,0,0,0.8); }
    @media (max-width: 1024px) {
      .collection-cards { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 991px) {
      .collection-cards { grid-template-columns: repeat(2, 1fr); }
      .artist-profile-card .card-content { padding: 16px; gap: 10px; }
      .artist-profile-card .card-name { font-size: 1.2rem; }
      .artist-profile-card .card-style { font-size: .7rem; }
      .artist-profile-btn { padding: 6px 10px; font-size: 12px; }
      .wannado-card .card-content { padding: 16px; }
      .wannado-card .card-name { font-size: 1rem; }
    }
    @media (max-width: 480px) {
      .artist-profile-card .card-buttons { flex-direction: column; gap: 6px; }
      .artist-profile-btn { width: 100%; justify-content: center; }
      .modal { border-radius: 12px; max-height: 95vh; margin-top: auto; }
      .selected-wannado { flex-direction: column; align-items: center; text-align: center; }
      .form-row { grid-template-columns: 1fr; }
      .time-slots { grid-template-columns: repeat(2, 1fr); }
      .filter-tab:not(.active) { color: #000000 !important; }
      .filter-tab.active { color: #ffffff !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Wannado Collections</h1>
    </div>
    <div class="filter-tabs" id="filterTabs">
      <button class="filter-tab active" data-artist="all">Alle</button>
    </div>
    <div id="wannadoGrid" class="wannado-grid">
      <div class="loading">
        <div class="spinner"></div>
        <p>Lade Motive...</p>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="bookingModal">
    <div class="modal">
      <div class="modal-header">
        <div><h2>Termin buchen</h2></div>
        <button class="modal-close" onclick="closeBookingModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="selected-wannado" id="selectedWannadoPreview"></div>
        <div class="steps">
          <div class="step active" data-step="1"></div>
          <div class="step" data-step="2"></div>
          <div class="step" data-step="3"></div>
        </div>
        <div class="form-section active" id="step1">
          <h4>1. Wähle Datum & Uhrzeit</h4>
          <div class="calendar">
            <div class="calendar-header">
              <button onclick="prevMonth()">‹</button>
              <h5 id="calendarMonth">Dezember 2025</h5>
              <button onclick="nextMonth()">›</button>
            </div>
            <div class="calendar-weekdays">
              <span>Mo</span><span>Di</span><span>Mi</span><span>Do</span><span>Fr</span><span>Sa</span><span>So</span>
            </div>
            <div class="calendar-days" id="calendarDays"></div>
          </div>
          <h4 style="margin-top:24px;">Verfügbare Zeiten</h4>
          <div class="time-slots" id="timeSlots">
            <div class="no-slots">Wähle zuerst ein Datum</div>
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="goToStep(2)" id="toStep2Btn" disabled>Weiter</button>
          </div>
        </div>
        <div class="form-section" id="step2">
          <h4>2. Deine Kontaktdaten</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Vorname *</label>
              <input type="text" id="firstName" required placeholder="Max">
            </div>
            <div class="form-group">
              <label>Nachname *</label>
              <input type="text" id="lastName" required placeholder="Mustermann">
            </div>
          </div>
          <div class="form-group">
            <label>E-Mail *</label>
            <input type="email" id="email" required placeholder="max@beispiel.de">
          </div>
          <div class="form-group">
            <label>Telefon *</label>
            <input type="tel" id="phone" required placeholder="+49 170 1234567">
          </div>
          <div class="form-group">
            <label>Instagram (optional)</label>
            <input type="text" id="instagram" placeholder="@dein_name">
          </div>
          <div class="btn-row">
            <button class="btn btn-secondary" onclick="goToStep(1)">Zurück</button>
            <button class="btn btn-primary" onclick="goToStep(3)">Weiter</button>
          </div>
        </div>
        <div class="form-section" id="step3">
          <h4>3. Zusammenfassung</h4>
          <div class="booking-summary" id="bookingSummary"></div>
          <div class="btn-row">
            <button class="btn btn-secondary" onclick="goToStep(2)">Zurück</button>
            <button class="btn btn-primary" onclick="proceedToPayment()" id="payBtn">Jetzt bezahlen</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://auxxyehgzkozdjylhqnx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1eHh5ZWhnemtvemRqeWxocW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDczODgsImV4cCI6MjA3NjEyMzM4OH0.bg8NunF2qkps28Aj0ZqY35eKK--QOu8NduCkFyqp5KA';
    const EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/create-wannado-checkout`;
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const PROFILE_BASE_URL = 'https://www.mommyimsorry.com/residents/stuttgart';
    const SLUG_MAP = {
      'ata': 'ata', 'ben': 'ben', 'lily.shy': 'lily-shy', 'luka': 'luca',
      'marina art': 'marina', 'mary': 'maryrain', 'mela': 'mela',
      'silas': 'silas', 'toriatattooo': 'toria'
    };
    function getArtistSlug(name) {
      if (!name) return '';
      const lower = name.toLowerCase().trim();
      return SLUG_MAP[lower] || lower.replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    }
    const ARROW_SVG = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></svg>';

    let allWannados = [], allArtists = [], selectedWannado = null, selectedDate = null, selectedTime = null, currentMonth = new Date(), artistAvailability = {}, artistAppointments = [];

    document.addEventListener('DOMContentLoaded', async () => { await loadWannados(); renderCalendar(); });

    async function loadWannados() {
      try {
        const { data, error } = await supabaseClient
          .from('wannados')
          .select('*, artist:artists(id, name, profile_picture_url, background_image_url, instagram, style), collection:wannado_collections!inner(id, name, is_active)')
          .eq('collection.is_active', true)
          .in('status', ['available', 'sold'])
          .order('sort_order', { ascending: true });
        if (error) throw error;
        allWannados = data || [];
        const artistMap = new Map();
        allWannados.forEach(w => { if (w.artist) artistMap.set(w.artist.id, w.artist); });
        allArtists = Array.from(artistMap.values());
        renderFilterTabs();
        renderWannados();
      } catch (err) {
        console.error('Error:', err);
        document.getElementById('wannadoGrid').innerHTML = `<div class="empty-state"><div class="empty-state-icon">⚠️</div><h3>Fehler beim Laden</h3><p>${err.message}</p></div>`;
      }
    }

    function renderFilterTabs() {
      const container = document.getElementById('filterTabs');
      if (allArtists.length <= 1) {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'flex';
      container.innerHTML = `<button class="filter-tab active" data-artist="all" onclick="filterByArtist('all')">Alle</button>${allArtists.map(a => `<button class="filter-tab" data-artist="${a.id}" onclick="filterByArtist('${a.id}')">${a.name}</button>`).join('')}`;
    }

    function renderWannados(filter = 'all') {
      const container = document.getElementById('wannadoGrid');
      let filtered = filter === 'all' ? allWannados : allWannados.filter(w => w.artist?.id === filter);

      if (!filtered.length) {
        container.innerHTML = `<div class="empty-state"><h3>Keine Motive verfügbar</h3></div>`;
        return;
      }

      // Group wannados by collection_id
      const collections = {};
      filtered.forEach(w => {
        const colId = w.collection?.id || 'uncategorized';
        if (!collections[colId]) {
          collections[colId] = {
            name: w.collection?.name || 'Collection',
            artist: w.artist,
            items: []
          };
        }
        collections[colId].items.push(w);
      });

      let html = '';

      // Render each collection as its own row
      Object.values(collections).forEach(collection => {
        const artist = collection.artist;

        html += `<div class="collection-row">`;

        // Collection header with artist info
        html += `<div class="collection-header">
          <div class="collection-title">${collection.name} · ${artist?.name || 'Artist'}</div>
        </div>`;

        // Cards container
        html += `<div class="collection-cards">`;

        // Artist Profile Card (resident card pattern)
        const artistName = artist?.name || 'Artist';
        const artistStyle = artist?.style || 'Various Styles';
        const bg = artist?.background_image_url || '';
        const pfp = artist?.profile_picture_url || '';
        const img1 = bg || pfp || '';
        const img2 = bg && pfp ? pfp : '';
        const slug = getArtistSlug(artistName);
        const profileLink = `${PROFILE_BASE_URL}/${slug}`;

        html += `
          <div class="artist-profile-card">
            <div class="card-image">
              <img src="${img1}" alt="${artistName}" loading="lazy">
              ${img2 ? `<img class="hover-img" src="${img2}" alt="${artistName}" loading="lazy">` : ''}
            </div>
            <div class="card-overlay"></div>
            <div class="card-content">
              <div class="card-info">
                <h2 class="card-name">${artistName}</h2>
                <p class="card-style">${artistStyle}</p>
              </div>
              <div class="card-buttons">
                <a href="${profileLink}" target="_blank" class="artist-profile-btn" onclick="event.stopPropagation()">View Profile ${ARROW_SVG}</a>
              </div>
            </div>
          </div>
        `;

        // Wannado Cards
        collection.items.forEach(w => {
          const isSold = w.status === 'sold';

          html += `
            <div class="wannado-card ${isSold ? 'sold-out' : ''}" ${!isSold ? `onclick="selectWannado('${w.id}')"` : ''}>
              ${isSold ? '<div class="sold-out-badge">Sold Out</div>' : ''}
              ${w.image_url
                ? `<div class="card-image"><img src="${w.image_url}" alt="${w.name}" loading="lazy"></div>`
                : `<div class="wannado-image-placeholder"></div>`
              }
              <div class="card-overlay"></div>
              <div class="card-content">
                <span class="card-duration">ca. ${w.duration_hours}h</span>
                <h3 class="card-name">${w.name}</h3>
                <div class="card-meta">
                  <span class="card-price">${Number(w.price).toFixed(0)}€</span>
                </div>
              </div>
            </div>
          `;
        });

        html += `</div>`; // Close collection-cards
        html += `</div>`; // Close collection-row
      });

      container.innerHTML = html;
    }

    function filterByArtist(id) {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.toggle('active', t.dataset.artist === id));
      renderWannados(id);
    }

    function selectWannado(id) {
      selectedWannado = allWannados.find(w => w.id === id);
      if (!selectedWannado) return;
      selectedDate = null; selectedTime = null; currentMonth = new Date();
      document.getElementById('selectedWannadoPreview').innerHTML = `${selectedWannado.image_url ? `<img src="${selectedWannado.image_url}">` : `<div style="width:100px;height:100px;background:#f0f0f0;border-radius:12px;"></div>`}<div class="selected-wannado-info"><h3>${selectedWannado.name}</h3><div class="artist">von ${selectedWannado.artist?.name || 'Artist'} · ca. ${selectedWannado.duration_hours}h</div><div class="price">${Number(selectedWannado.price).toFixed(0)}€</div></div>`;
      goToStep(1);
      document.getElementById('bookingModal').classList.add('active');
      document.body.classList.add('modal-open');
      document.body.style.overflow = 'hidden';
      // Tell parent iframe to use 100vh
      window.parent.postMessage({ type: 'modal-open', height: '100vh' }, '*');
      loadArtistAvailability();
    }

    function closeBookingModal() {
      document.getElementById('bookingModal').classList.remove('active');
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      // Tell parent modal is closed
      window.parent.postMessage({ type: 'modal-close' }, '*');
      // Restore auto height after small delay to ensure DOM updates
      setTimeout(() => {
        sendHeight();
      }, 100);
    }

    async function loadArtistAvailability() {
      if (!selectedWannado?.artist?.id) return;
      try {
        const today = new Date();
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + 60);
        const fmtDate = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const todayStr = fmtDate(today);
        const endDateStr = fmtDate(endDate);

        const { data, error } = await supabaseClient
          .from('dienstplan')
          .select('id, start_date, end_date, state, working_start, working_end')
          .eq('artist_id', selectedWannado.artist.id)
          .in('state', ['Available', 'Verfügbar'])
          .lte('start_date', endDateStr)
          .gte('end_date', todayStr)
          .order('start_date', { ascending: true });

        if (error) throw error;

        // Erstelle availability map für jeden Tag im Zeitraum
        artistAvailability = {};
        (data || []).forEach(entry => {
          const [sy,sm,sd] = entry.start_date.split('-').map(Number);
          const [ey,em,ed] = entry.end_date.split('-').map(Number);
          const start = new Date(sy, sm-1, sd);
          const end = new Date(ey, em-1, ed);
          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            artistAvailability[fmtDate(d)] = {
              working_start: entry.working_start?.substring(0,5) || '10:00',
              working_end: entry.working_end?.substring(0,5) || '20:00'
            };
          }
        });

        // Load ALL existing appointments for this artist (same as consultation-booking pattern)
        const { data: apts } = await supabaseClient
          .from('appointments')
          .select('start, end')
          .eq('artist_id', selectedWannado.artist.id)
          .not('status', 'in', '("canceled","no_show","rescheduled")')
          .gte('start', todayStr);

        artistAppointments = apts || [];
        console.log('Loaded', artistAppointments.length, 'appointments for', selectedWannado.artist.name);

        renderCalendar();
      } catch (err) {
        console.error('Error loading availability:', err);
      }
    }

    function renderCalendar() {
      const container = document.getElementById('calendarDays'), monthLabel = document.getElementById('calendarMonth');
      const year = currentMonth.getFullYear(), month = currentMonth.getMonth();
      const monthNames = ['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
      monthLabel.textContent = `${monthNames[month]} ${year}`;
      const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0), totalDays = lastDay.getDate();
      let startingDay = firstDay.getDay() - 1; if (startingDay < 0) startingDay = 6;
      let html = ''; const today = new Date(); today.setHours(0,0,0,0);
      for (let i = 0; i < startingDay; i++) html += `<button class="calendar-day other-month" disabled></button>`;
      for (let day = 1; day <= totalDays; day++) {
        const date = new Date(year, month, day), dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isPast = date < today, hasAvail = artistAvailability[dateStr], isSelected = selectedDate === dateStr;
        html += `<button class="calendar-day ${isSelected ? 'selected' : ''}" ${isPast || !hasAvail ? 'disabled' : ''} onclick="selectDate('${dateStr}')">${day}</button>`;
      }
      container.innerHTML = html;
    }

    function prevMonth() { currentMonth.setMonth(currentMonth.getMonth() - 1); renderCalendar(); }
    function nextMonth() { currentMonth.setMonth(currentMonth.getMonth() + 1); renderCalendar(); }

    function selectDate(dateStr) {
      selectedDate = dateStr; selectedTime = null;
      document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
      event.target.classList.add('selected');
      loadTimeSlots(dateStr);
      document.getElementById('toStep2Btn').disabled = true;
    }

    function loadTimeSlots(dateStr) {
      const container = document.getElementById('timeSlots');
      const avail = artistAvailability[dateStr];
      if (!avail) { container.innerHTML = '<div class="no-slots">Keine Verfügbarkeit</div>'; return; }

      // Filter pre-loaded appointments for this date using overlap detection (consultation-booking pattern)
      const dayAppts = artistAppointments.filter(apt => {
        // Parse date from DB string "2026-01-29 12:00:00+00" — extract the date part
        const aptDateStr = apt.start.substring(0, 10);
        return aptDateStr === dateStr;
      }).map(apt => {
        // Extract HH:MM directly from DB string to avoid timezone conversion
        const sMatch = apt.start.match(/(\d{2}):(\d{2}):\d{2}/);
        const eMatch = apt.end.match(/(\d{2}):(\d{2}):\d{2}/);
        return {
          scheduled_start: sMatch ? `${sMatch[1]}:${sMatch[2]}` : '00:00',
          scheduled_end: eMatch ? `${eMatch[1]}:${eMatch[2]}` : '00:00'
        };
      });

      console.log(`Slots for ${dateStr}: ${dayAppts.length} appointments blocking`, dayAppts);

      const slots = calculateSlots(avail.working_start, avail.working_end, dayAppts, selectedWannado.duration_hours);
      if (!slots.length) { container.innerHTML = '<div class="no-slots">Keine freien Zeiten</div>'; return; }
      container.innerHTML = slots.map(s => `<button class="time-slot" onclick="selectTimeSlot('${s.start}','${s.end}')">${s.start} - ${s.end}</button>`).join('');
    }

    function calculateSlots(workStart, workEnd, appointments, duration) {
      const durationMin = duration * 60;
      const toMin = t => { const [h,m] = t.split(':').map(Number); return h*60+m; };
      const toTime = m => `${Math.floor(m/60).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}`;
      const startMin = toMin(workStart), endMin = toMin(workEnd);
      const booked = appointments.map(a => ({ start: toMin(a.scheduled_start), end: toMin(a.scheduled_end) })).sort((a,b) => a.start - b.start);

      // Generate candidate slots every 60 min, then filter out any that overlap with bookings
      const candidates = [];
      for (let s = startMin; s + durationMin <= endMin; s += 60) {
        candidates.push({ startMin: s, endMin: s + durationMin, start: toTime(s), end: toTime(s + durationMin) });
      }

      // Filter: remove any slot that overlaps with any booking
      return candidates.filter(slot => {
        return !booked.some(b => slot.startMin < b.end && slot.endMin > b.start);
      });
    }

    function selectTimeSlot(start, end) {
      selectedTime = { start, end };
      document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
      event.target.classList.add('selected');
      document.getElementById('toStep2Btn').disabled = false;
    }

    function goToStep(step) {
      document.querySelectorAll('.step').forEach((s,i) => { s.classList.remove('active','completed'); if (i+1 < step) s.classList.add('completed'); if (i+1 === step) s.classList.add('active'); });
      document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');
      if (step === 3) updateSummary();
    }

    function updateSummary() {
      const dateStr = new Date(selectedDate + 'T12:00:00').toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      document.getElementById('bookingSummary').innerHTML = `<div class="summary-row"><span>Motiv</span><span>${selectedWannado.name}</span></div><div class="summary-row"><span>Artist</span><span>${selectedWannado.artist?.name}</span></div><div class="summary-row"><span>Datum</span><span>${dateStr}</span></div><div class="summary-row"><span>Uhrzeit</span><span>${selectedTime.start} - ${selectedTime.end} Uhr</span></div><div class="summary-row"><span>Dauer</span><span>ca. ${selectedWannado.duration_hours}h</span></div><div class="summary-row total"><span>Gesamtpreis</span><span class="value">${Number(selectedWannado.price).toFixed(0)}€</span></div>`;
    }

    async function proceedToPayment() {
      const btn = document.getElementById('payBtn');
      btn.disabled = true; btn.textContent = 'Wird verarbeitet...';
      try {
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const instagram = document.getElementById('instagram').value.trim();
        if (!firstName || !lastName || !email || !phone) { alert('Bitte alle Pflichtfelder ausfüllen.'); goToStep(2); btn.disabled = false; btn.textContent = 'Jetzt bezahlen'; return; }
        const res = await fetch(EDGE_FUNCTION_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ wannado_id: selectedWannado.id, customer_email: email, customer_first_name: firstName, customer_last_name: lastName, customer_phone: phone, customer_instagram: instagram || null, selected_date: selectedDate, selected_start_time: selectedTime.start, selected_end_time: selectedTime.end }) });
        const result = await res.json();
        if (!res.ok) throw new Error(result.error || 'Fehler');
        if (result.checkout_url) window.top.location.href = result.checkout_url;
        else throw new Error('Keine Checkout-URL');
      } catch (err) { console.error('Error:', err); alert('Fehler: ' + err.message); btn.disabled = false; btn.textContent = 'Jetzt bezahlen'; }
    }

    document.getElementById('bookingModal').addEventListener('click', e => { if (e.target.id === 'bookingModal') closeBookingModal(); });

    // ==========================================
    // IFRAME HEIGHT COMMUNICATION
    // ==========================================
    function sendHeight() {
      const height = Math.max(
        document.body.scrollHeight,
        document.body.offsetHeight,
        document.documentElement.scrollHeight
      );
      window.parent.postMessage({ type: 'resize', height: height }, '*');
    }

    // Send height on load
    window.addEventListener('load', sendHeight);

    // Send height after wannados are loaded (after any async data fetch)
    // Add a small delay to ensure content is rendered
    setTimeout(sendHeight, 500);
    setTimeout(sendHeight, 1500);

    // Also observe DOM changes
    const resizeObserver = new ResizeObserver(() => {
      sendHeight();
    });
    resizeObserver.observe(document.body);
  </script>
</body>
</html>
