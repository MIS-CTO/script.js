<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Management System v84</title>
  
  <!-- iOS Web App Configuration -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Management System">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ“Š</text></svg>">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Geist Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ========================================
       macOS Light Mode Frosted Glass - CSS Variables
       ======================================== */
    :root {
      /* Backgrounds - Light Mode Frosted Glass */
      --macos-bg: #f5f5f7;
      --macos-panel: rgba(255, 255, 255, 0.7);
      --macos-elevated: rgba(255, 255, 255, 0.85);
      --macos-nav-bg: rgba(251, 251, 253, 1.0);

      /* Text Colors - Always Dark in Light Mode */
      --macos-text-primary: #1d1d1f;
      --macos-text-secondary: #86868b;
      --macos-text-tertiary: #a1a1a6;
      --macos-placeholder: #86868b;

      /* Accent Colors */
      --macos-accent-blue: #0071e3;
      --macos-accent-green: #34c759;
      --macos-accent-red: #ff3b30;
      --macos-accent-orange: #ff9500;
      --macos-accent-purple: #5856d6;

      /* System Fills - Light Mode */
      --macos-fill-primary: rgba(120, 120, 128, 0.20);
      --macos-fill-secondary: rgba(120, 120, 128, 0.16);
      --macos-fill-tertiary: rgba(120, 120, 128, 0.12);
      --macos-fill-quaternary: rgba(120, 120, 128, 0.08);

      /* Strokes - Enhanced for Light Mode */
      --macos-stroke-primary: rgba(0, 0, 0, 0.08);
      --macos-stroke-secondary: rgba(0, 0, 0, 0.04);

      /* Shadows - Subtle for Light Backgrounds */
      --macos-shadow-small: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
      --macos-shadow-medium: 0 3px 12px rgba(0,0,0,0.07), 0 1px 4px rgba(0,0,0,0.04);
      --macos-shadow-large: 0 10px 40px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);

      /* Frosted Glass Blur Effects */
      --macos-blur-strong: saturate(180%) blur(20px);
      --macos-blur-medium: saturate(160%) blur(15px);
      --macos-blur-light: saturate(140%) blur(10px);

      /* Border Radius System */
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 10px;
      --radius-xl: 12px;
      --radius-pill: 999px;

      /* Spacing System (8pt grid) */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 24px;
      --space-2xl: 32px;
      --space-3xl: 48px;

      /* Location Colors (preserved) */
      --location-primary: #43A047;
      --location-light: #E8F5E9;
      --location-dark: #2E7D32;
      --location-accent: #66BB6A;

      /* Legacy aliases for compatibility */
      --bg: var(--macos-bg);
      --ink: var(--macos-text-primary);
      --muted: var(--macos-text-secondary);
      --panel: var(--macos-panel);
      --stroke: var(--macos-stroke-primary);
      --brand: var(--macos-text-primary);
      --brand-ink: #ffffff;
      --accent: var(--macos-accent-blue);
      --radius: var(--radius-xl);
      --shadow: var(--macos-shadow-medium);

      /* Account Settings Page Variables */
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f7;
      --bg-tertiary: #fafafa;
      --text-primary: #1d1d1f;
      --text-secondary: #86868b;
      --text-tertiary: #a1a1a6;
      --border-color: rgba(0, 0, 0, 0.1);
      --border-color-strong: rgba(0, 0, 0, 0.2);
      --hover-bg: rgba(0, 0, 0, 0.05);
      --hover-bg-light: rgba(0, 0, 0, 0.03);
      --input-bg: #ffffff;
      --input-border: rgba(0, 0, 0, 0.1);
      --input-focus-border: rgba(0, 113, 227, 0.5);
      --button-primary-bg: #0071e3;
      --button-primary-hover: #0077ed;
      --button-primary-text: #ffffff;
      --button-secondary-bg: #ffffff;
      --button-secondary-hover: #f5f5f7;
      --button-secondary-text: #1d1d1f;
    }

    /* FORCE LIGHT MODE EVERYWHERE - Disable Dark Mode */
    @media (prefers-color-scheme: dark) {
      :root {
        /* Override dark mode - keep everything light */
        --macos-bg: #f5f5f7 !important;
        --macos-panel: rgba(255, 255, 255, 0.7) !important;
        --macos-elevated: rgba(255, 255, 255, 0.85) !important;
        --macos-nav-bg: rgba(251, 251, 253, 1.0) !important;
        --macos-text-primary: #1d1d1f !important;
        --macos-text-secondary: #86868b !important;
        --macos-text-tertiary: #a1a1a6 !important;
        --macos-stroke-primary: rgba(0, 0, 0, 0.08) !important;
        --macos-stroke-secondary: rgba(0, 0, 0, 0.04) !important;
      }
    }

    /* ========================================
       Force Light Mode on All Elements
       ======================================== */
    * {
      color-scheme: light !important;
    }

    html, body {
      background: var(--macos-bg) !important;
      color: var(--macos-text-primary) !important;
      color-scheme: light !important;
    }

    /* Emergency override for any dark backgrounds */
    [style*="background: rgb(28"],
    [style*="background: #1"],
    [style*="background: #2"],
    [style*="background: #3"] {
      background: var(--macos-panel) !important;
      color: var(--macos-text-primary) !important;
    }
    /* ========================================
       macOS Typography System
       ======================================== */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Geist", -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: var(--macos-bg);
      color: var(--macos-text-primary);
      margin: 0;
      font-size: 13px;
      line-height: 1.47;
      font-weight: 400;
      letter-spacing: -0.008em;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    /* Typography Styles */
    h1, .text-title-1 {
      font-size: 22px;
      line-height: 1.27;
      font-weight: 600;
      letter-spacing: -0.022em;
      color: var(--macos-text-primary);
    }

    h2, .text-title-2 {
      font-size: 17px;
      line-height: 1.29;
      font-weight: 600;
      letter-spacing: -0.018em;
      color: var(--macos-text-primary);
    }

    h3, .text-title-3 {
      font-size: 15px;
      line-height: 1.33;
      font-weight: 600;
      letter-spacing: -0.014em;
      color: var(--macos-text-primary);
    }

    .text-headline {
      font-size: 13px;
      line-height: 1.38;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .text-body {
      font-size: 13px;
      line-height: 1.47;
      font-weight: 400;
      letter-spacing: -0.008em;
    }

    .text-callout {
      font-size: 12px;
      line-height: 1.42;
      font-weight: 400;
      letter-spacing: -0.006em;
    }

    .text-subheadline {
      font-size: 11px;
      line-height: 1.36;
      font-weight: 400;
      letter-spacing: 0.0017em;
    }

    .text-footnote, .text-caption-1 {
      font-size: 10px;
      line-height: 1.40;
      font-weight: 400;
      letter-spacing: 0em;
    }

    .text-caption-2 {
      font-size: 9px;
      line-height: 1.33;
      font-weight: 400;
      letter-spacing: 0.0013em;
    }
    /* ========================================
       Navigation Bar - Frosted Glass
       ======================================== */
    nav {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      gap: 18px;
      align-items: center;
      background: var(--macos-nav-bg) !important;
      backdrop-filter: var(--macos-blur-strong);
      -webkit-backdrop-filter: var(--macos-blur-strong);
      padding: 12px 24px;
      border-bottom: 1px solid var(--macos-stroke-primary);
      height: 52px;
    }

    nav a {
      color: var(--macos-text-primary) !important;
      text-decoration: none;
      font-weight: 500;
      font-size: 13px;
      padding: 6px 8px;
      border-bottom: 2px solid transparent;
      opacity: 0.75;
      cursor: pointer;
      transition: opacity 0.2s ease, border-color 0.2s ease;
      letter-spacing: -0.008em;
    }

    nav a:hover {
      opacity: 1;
    }

    nav a.active {
      border-color: var(--macos-text-primary);
      opacity: 1;
      font-weight: 600;
    }
    /* ========================================
       Sections & Content Areas - Light Mode
       ======================================== */
    section {
      display: none;
      padding: 24px 5vw;
      max-width: 100%;
      margin: 0 auto;
      margin-top: 110px; /* 64px Header + 46px Navbar */
      min-height: calc(100vh - 110px);
    }

    section.active {
      display: block;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.022em;
      color: var(--macos-text-primary) !important;
    }

    /* ========================================
       Badges - Light with Colored Accents
       ======================================== */
    .badge {
      background: rgba(255, 255, 255, 0.9) !important;
      border: 1px solid var(--macos-stroke-primary);
      border-radius: 12px;
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 500;
      color: var(--macos-text-primary) !important;
      box-shadow: var(--macos-shadow-small);
      display: inline-block;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    /* Badge variants */
    .badge-resident,
    .badge-active {
      background: rgba(52, 199, 89, 0.15) !important;
      color: #1d6b2e !important;
      border-color: rgba(52, 199, 89, 0.3);
    }
    .calendar-controls {
      display:flex; gap:12px; margin-bottom:16px; align-items:center; flex-wrap:wrap;
    }
    /* ========================================
       Buttons - macOS Style
       ======================================== */
    .btn, .btn-primary {
      background: var(--macos-accent-blue);
      color: #ffffff;
      border: none;
      padding: 8px 20px;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.1s ease;
      letter-spacing: -0.008em;
      box-shadow: var(--macos-shadow-small);
      font-family: inherit;
    }

    .btn-primary:hover, .btn:hover {
      background: #0077ed;
      transform: translateY(-0.5px);
      box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
    }

    .btn-primary:active, .btn:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      background: var(--macos-fill-quaternary);
      color: var(--macos-text-primary);
      border: 1px solid var(--macos-stroke-primary);
      padding: 8px 20px;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease;
      letter-spacing: -0.008em;
      font-family: inherit;
    }

    .btn-secondary:hover {
      background: var(--macos-fill-tertiary);
    }

    .btn-nav {
      background: var(--macos-fill-tertiary);
      color: var(--macos-text-primary);
      border: none;
      padding: 7px 16px;
      border-radius: var(--radius-pill);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease;
      letter-spacing: -0.008em;
      font-family: inherit;
    }

    .btn-nav:hover {
      background: var(--macos-fill-secondary);
    }

    .btn-danger {
      background: var(--macos-accent-red);
      color: #ffffff;
      border: none;
      padding: 8px 20px;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease;
      font-family: inherit;
    }

    .btn-danger:hover {
      background: #ff453a;
    }

    /* ========================================
       Form Inputs - Frosted Glass
       ======================================== */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="search"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    select,
    textarea {
      padding: 8px 12px;
      border: 1px solid var(--macos-stroke-primary);
      border-radius: var(--radius-md);
      font-size: 13px;
      font-family: inherit;
      background: var(--macos-elevated) !important;
      color: var(--macos-text-primary) !important;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      letter-spacing: -0.008em;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--macos-accent-blue);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--macos-placeholder) !important;
      opacity: 1 !important;
    }

    /* Search bars - White with dark text */
    input[type="search"] {
      background: var(--macos-elevated) !important;
      border: 1px solid var(--macos-stroke-primary);
      color: var(--macos-text-primary) !important;
      border-radius: var(--radius-pill);
    }
    /* ========================================
       Tables - Frosted Glass
       ======================================== */
    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--macos-stroke-primary);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--macos-elevated);
      backdrop-filter: var(--macos-blur-medium);
      -webkit-backdrop-filter: var(--macos-blur-medium);
      box-shadow: var(--macos-shadow-medium);
    }

    thead {
      background: #f5f5f7 !important;
    }

    th {
      text-align: left;
      padding: 10px 16px;
      border-bottom: 1px solid var(--macos-stroke-primary);
      font-weight: 600;
      font-size: 11px;
      color: #6e6e73 !important;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    td {
      text-align: left;
      padding: 12px 16px;
      border-bottom: 1px solid var(--macos-stroke-secondary);
      font-size: 13px;
      color: var(--macos-text-primary) !important;
      background: rgba(255, 255, 255, 0.6);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover td {
      background: rgba(0, 0, 0, 0.02);
    }
    /* ========================================
       Calendar Container - Frosted Glass
       ======================================== */
    .calendar-container {
      background: var(--macos-panel) !important;
      backdrop-filter: var(--macos-blur-medium);
      -webkit-backdrop-filter: var(--macos-blur-medium);
      border: 1px solid var(--macos-stroke-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--macos-shadow-medium);
      overflow: auto;
      width: 100%;
    }
    .calendar-grid {
      display:grid; grid-template-columns:120px repeat(22, 1fr); min-width:100%;
    }
    .calendar-header { display:contents; }
    .slot-header {
      background:#F5F5F7; color:#1d1d1f; padding:14px; font-weight:600;
      text-align:center; border-bottom:1px solid rgba(0,0,0,0.1);
      border-right:1px solid rgba(0,0,0,0.1); position:sticky; left:0; z-index:10;
      min-height:56px; display:flex; align-items:center; justify-content:center;
      grid-column:1/2; font-size:14px; letter-spacing:-0.01em;
    }
    .hour-header {
      background:#F5F5F7; color:#86868b; padding:12px; font-weight:500;
      text-align:center; border-right:none; border-bottom:1px solid rgba(0,0,0,0.1);
      min-height:56px; display:flex; align-items:center; justify-content:center;
      font-size:13px; letter-spacing:-0.01em;
    }
    .slot-row { display:contents; }
    .slot-label {
      background:rgba(255,255,255,0.98);
      padding:14px;
      font-weight:500;
      border-right:1px solid rgba(0,0,0,0.08);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      left:0;
      z-index:5;
      min-height:100px;
      display:flex;
      align-items:center;
      justify-content:center;
      grid-column:1;
      font-size:13px;
      color:#86868b;
    }
    .slot-label.empty {
      min-height:40px;
      background:rgba(240,240,240,0.98);
      color:#999;
      font-size:12px;
      font-weight:400;
    }
    .slot-label.empty .slot-number {
      font-weight:500;
      color:#666;
    }
    .slot-label.empty .empty-text {
      margin-left:6px;
      font-style:italic;
    }
    .category-header {
      background:#F5F5F7; color:#1d1d1f; padding:12px 14px; font-weight:600;
      border-right:1px solid rgba(0,0,0,0.1); border-bottom:1px solid rgba(0,0,0,0.1);
      position:sticky; left:0; z-index:6; min-height:48px;
      display:flex; align-items:center; justify-content:flex-start; grid-column:1/2;
      font-size:14px; letter-spacing:-0.01em;
    }
    .category-spacer {
      background:#FAFAFA; border-right:none; border-bottom:1px solid rgba(0,0,0,0.06);
      min-height:48px;
    }
    .slot-cell {
      border-bottom:1px solid rgba(0,0,0,0.06);
      border-right:1px solid rgba(0,0,0,0.06);
      min-height:100px;
      padding:6px;
      position:relative;
      background:rgba(255,255,255,0.8);
      transition:background 0.15s ease;
    }
    .slot-cell.empty-slot {
      min-height:50px;
      background:rgba(245,245,245,0.6);
      cursor:default;
    }
    .slot-cell.empty-slot:hover {
      background:rgba(245,245,245,0.6);
    }
    .slot-row.empty-row .slot-label {
      min-height:50px;
      background:rgba(249,249,249,0.5);
      color:var(--muted);
      font-size:12px;
    }
    .slot-row.empty-row .slot-label::after {
      content: " - Empty";
      font-weight:400;
      font-size:11px;
      color:#999;
      margin-left:4px;
    }
    .slot-row.empty-row .slot-cell {
      min-height:50px;
    }
    .slot-cell.half-hour { border-right:1px solid rgba(0,0,0,0.04); }
    .slot-cell:hover { background:rgba(0,113,227,0.02); }
    .event {
      background:rgba(255,255,255,0.95);
      color:#1d1d1f;
      padding:8px 10px;
      border-radius:6px;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.2s ease;
      word-break:break-word;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:flex-start;
      border-left:4px solid var(--location-primary);
      box-shadow:0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
      overflow:hidden;
      line-height:1.3;
    }
    .event:hover {
      box-shadow:0 4px 12px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.06);
      transform:translateY(-1px);
      z-index:10;
    }
    .event.guest {
      border-left-color:#42A5F5;
    }
    .event.resident {
      border-left-color:var(--location-primary);
    }
    .event.events {
      border-left-color:#5856D6;
    }
    
    /* Booking Type Colors - Light backgrounds with colored borders */
    .event[data-type="consultation"] {
      background:rgba(102, 187, 106, 0.15);
      border-left-color:#43A047;
    }
    .event[data-type="new_tattoo"] {
      background:rgba(236, 64, 122, 0.15);
      border-left-color:#C2185B;
    }
    .event[data-type="continuing_tattoo"] {
      background:rgba(66, 165, 245, 0.15);
      border-left-color:#1976D2;
    }
    .event[data-type="touch_up"] {
      background:rgba(255, 235, 59, 0.25);
      border-left-color:#FBC02D;
    }
    .event[data-type="selfbooking"] {
      background:rgba(141, 110, 99, 0.15);
      border-left-color:#5D4037;
    }
    .event[data-type="wannado"] {
      background:rgba(171, 71, 188, 0.15);
      border-left-color:#7B1FA2;
    }
    .event[data-type="internal"] {
      background:rgba(239, 83, 80, 0.15);
      border-left-color:#C62828;
    }
    .event[data-type="move"] {
      background:rgba(38, 198, 218, 0.15);
      border-left-color:#00838F;
    }
    .event[data-type="reserved"] {
      background:rgba(120, 144, 156, 0.15);
      border-left-color:#455A64;
    }
    .event[data-type="no_show"] {
      background:rgba(189, 189, 189, 0.1);
      border-left-color:#757575;
    }
    
    /* ========================================
       Dienstplan Grid - Frosted Glass
       ======================================== */
    .dienstplan-grid {
      background: var(--macos-panel) !important;
      backdrop-filter: var(--macos-blur-medium);
      -webkit-backdrop-filter: var(--macos-blur-medium);
      border: 1px solid var(--macos-stroke-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--macos-shadow-medium);
      overflow: auto;
    }
    
    .category-section {
      border-bottom:1px solid rgba(0,0,0,0.06);
    }
    
    .category-section:last-child {
      border-bottom:none;
    }
    
    .category-header-btn {
      width:100%;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      background:#f5f5f5;
      color:#1d1d1f;
      border:none;
      padding:12px 16px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:background 0.2s ease;
      font-family:inherit;
      text-align:left;
    }
    
    .category-header-btn:hover {
      background:#e8e8e8;
    }
    
    .category-header-btn .arrow {
      margin-right:8px;
      transition:transform 0.3s ease;
      font-size:12px;
      display:inline-block;
      width:16px;
    }
    
    .category-header-btn.active .arrow {
      transform:rotate(90deg);
    }
    
    .category-content {
      display:none;
    }
    
    .category-content.active {
      display:block;
    }
    
    .person-row-container {
      display:contents;
    }
    
    .dienstplan-table {
      width:100%;
      display:grid;
      grid-template-columns:150px repeat(31, 80px);
      border-collapse:collapse;
    }
    
    .dp-header-row {
      display:contents;
    }
    
    .dp-name-header {
      background:rgba(249,249,249,0.98);
      padding:12px;
      font-weight:600;
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      left:0;
      z-index:5;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      font-size:13px;
      color:#666;
      background:rgba(255,255,255,0.98);
    }
    
    .dp-day-header {
      background:var(--location-light);
      padding:8px 4px;
      font-weight:400;
      text-align:center;
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      font-size:11px;
      min-height:50px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
    }
    
    .dp-day-header .weekday {
      font-weight:500;
      color:#666;
      font-size:10px;
    }
    
    .dp-day-header .day-num {
      font-size:13px;
      font-weight:600;
      color:#1d1d1f;
    }
    
    .dp-row {
      display:contents;
    }
    
    .dp-name-cell {
      background:rgba(255,255,255,0.98);
      padding:10px 12px 10px 32px;
      font-weight:400;
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      left:0;
      z-index:4;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      font-size:13px;
      color:#1d1d1f;
    }
    
    .dp-cell {
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      min-height:40px;
      background:rgba(255,255,255,0.8);
      transition:background 0.15s ease;
      cursor:pointer;
    }
    
    .dp-cell:hover {
      background:rgba(0,113,227,0.04);
    }
    
    .dp-cell.working {
      background:var(--location-accent);
    }
    
    .dp-cell.off {
      background:#FFEBEE;
    }
    
    .dp-cell.vacation {
      background:#FFF3E0;
    }
    
    /* Apple-style Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 51px;
      height: 31px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e5e5ea;
      transition: .3s;
      border-radius: 15.5px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 27px;
      width: 27px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 27px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 3px 1px rgba(0,0,0,0.06);
    }
    
    input:checked + .toggle-slider {
      background-color: #34c759;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    
    .current-time-indicator {
      position: absolute;
      top: 100px;
      bottom: 0;
      width: 2px;
      background: #ff3b30;
      z-index: 20;
      pointer-events: none;
    }
    
    .current-time-indicator::before {
      content: '';
      position: absolute;
      left: -3px;
      top: 0;
      width: 8px;
      height: 8px;
      background: #ff3b30;
      border-radius: 50%;
    }

    /* ========================================
       Artist Info Events - Compact & Full Color
       ======================================== */
    .artist-info-event {
      opacity: 1 !important;
      font-size: 12px !important;
      padding: 4px 8px !important;
      min-height: 30px !important;
      max-height: 30px !important;
      height: 30px !important;
      border-left: none !important;
      font-weight: 600 !important;
      border-radius: 6px !important;
      overflow: hidden !important;
      cursor: pointer !important;
      transition: transform 0.1s ease, box-shadow 0.1s ease !important;
    }

    .artist-info-event:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .artist-info-event::before {
      content: 'ðŸ“Œ';
      margin-right: 4px;
      font-size: 10px;
    }

    /* Regular calendar items (not artist infos) */
    .cal-item:not(.artist-info-event) {
      min-height: 60px;
      padding: 8px;
      border-left-width: 4px;
    }

    /* ========================================
       Modals & Dialogs - Frosted Glass Overlay
       ======================================== */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-backdrop.active {
      display: flex;
      opacity: 1;
    }

    .modal {
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: var(--macos-blur-strong);
      -webkit-backdrop-filter: var(--macos-blur-strong);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--macos-shadow-large);
      transform: scale(0.95);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-backdrop.active .modal {
      transform: scale(1);
    }

    .modal h3 {
      color: var(--macos-text-primary) !important;
      font-weight: 600;
      font-size: 17px;
      letter-spacing: -0.018em;
      margin: 0 0 var(--space-lg);
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .form-group label {
      font-size: 13px;
      font-weight: 500;
      color: var(--macos-text-secondary);
      letter-spacing: -0.008em;
    }

    .modal-actions {
      display: flex;
      gap: var(--space-md);
      justify-content: flex-end;
      margin-top: var(--space-xl);
    }
    
    .btn {
      padding:10px 20px;
      border-radius:8px;
      border:none;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.2s ease;
      font-family:inherit;
    }
    
    .btn-primary {
      background:var(--accent);
      color:white;
    }
    
    .btn-primary:hover {
      background:#0077ED;
    }
    
    .btn-secondary {
      background:#f5f5f5;
      color:var(--ink);
    }
    
    .btn-secondary:hover {
      background:#e5e5e5;
    }
    
    .btn-danger {
      background:#ff3b30;
      color:white;
    }
    
    .btn-danger:hover {
      background:#ff2d20;
    }
    
    .btn-icon {
      background:transparent;
      border:none;
      cursor:pointer;
      padding:6px;
      border-radius:6px;
      color:var(--muted);
      transition:all 0.2s ease;
      font-size:16px;
    }
    
    .btn-icon:hover {
      background:rgba(0,0,0,0.05);
      color:var(--ink);
    }
    
    /* Artist List Styles */
    .artist-list {
      list-style:none;
      padding:0;
      margin:16px 0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .artist-item {
      background:white;
      border:1px solid rgba(0,0,0,0.06);
      border-radius:10px;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition:all 0.2s ease;
    }
    
    .artist-item:hover {
      border-color:rgba(0,0,0,0.12);
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
    }
    
    .artist-info {
      display:flex;
      align-items:center;
      gap:12px;
      flex:1;
    }
    
    .artist-name {
      font-weight:500;
      font-size:15px;
    }
    
    .artist-badge {
      background:var(--location-light);
      color:var(--location-dark);
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:500;
    }
    
    .artist-badge.guest {
      background:#e3f2fd;
      color:#1565c0;
    }
    
    .artist-location {
      background:#FFF3E0;
      color:#E65100;
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:500;
    }
    
    .artist-rank {
      background:#F3E5F5;
      color:#7B1FA2;
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:500;
    }
    
    .customer-rank {
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:600;
    }
    
    .customer-rank.bronze {
      background:#D7CCC8;
      color:#4E342E;
    }
    
    .customer-rank.silver {
      background:#E0E0E0;
      color:#424242;
    }
    
    .customer-rank.gold {
      background:#FFF9C4;
      color:#F57F17;
    }
    
    .customer-rank.platinum {
      background:#E1F5FE;
      color:#01579B;
    }
    
    /* Sort Controls */
    .sort-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }
    
    .artist-instagram {
      color:var(--muted);
      font-size:13px;
      margin-left:8px;
    }
    
    .artist-actions {
      display:flex;
      gap:4px;
    }
    
    /* Customer Table Styles */
    /* Artist Table Styles */
    #artistsTable tbody tr {
      transition:background 0.15s ease;
    }
    
    #artistsTable tbody tr:hover {
      background:rgba(0,113,227,0.02);
    }
    #customersTable tbody tr {
      transition:background 0.15s ease;
    }
    
    #customersTable tbody tr:hover {
      background:rgba(0,113,227,0.02);
    }
    /* Artists Table Styles */
    #artistsTable tbody tr {
      transition:background 0.15s ease;
    }
    
    #artistsTable tbody tr:hover {
      background:rgba(0,113,227,0.02);
    }
    
    
    /* Responsive */
    @media (max-width: 768px) {
      .artist-item {
        flex-direction:column;
        align-items:flex-start;
        gap:12px;
      }
      
      .artist-actions {
        width:100%;
        justify-content:flex-end;
      }
    }
    
    /* Request Management Styles */
    .request-item {
      padding:16px;
      border-radius:10px;
      margin-bottom:8px;
      cursor:pointer;
      transition:all 0.2s;
      border:1px solid rgba(0,0,0,0.06);
      background:white;
    }
    .request-item:hover {
      background:rgba(0,113,227,0.04);
      border-color:var(--accent);
      transform:translateX(2px);
    }
    .request-item.active {
      background:rgba(0,113,227,0.08);
      border-color:var(--accent);
      box-shadow:0 2px 8px rgba(0,113,227,0.15);
    }
    .request-item.new-status {
      background:#fff3cd;
      border-color:#ffc107;
    }
    .request-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .request-id {
      font-size:11px;
      color:var(--muted);
      font-weight:600;
      font-family:monospace;
    }
    .request-badge {
      padding:4px 10px;
      border-radius:12px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .request-badge.open_request { background:#dc3545; color:white; }
    .request-badge.pending { background:#ffc107; color:#000; }
    .request-badge.scheduled { background:#28a745; color:white; }
    .request-badge.finished { background:#6c757d; color:white; }
    .request-badge.canceled { background:#dc3545; color:white; }

    /* Priority Badges */
    .priority-badge {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 10px;
      border-radius:12px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .priority-badge.urgent {
      background:#FEE2E2;
      color:#991B1B;
    }
    .priority-badge.high {
      background:#FED7AA;
      color:#9A3412;
    }
    .priority-badge.normal {
      background:#D1FAE5;
      color:#065F46;
    }
    .priority-badge.low {
      background:#F3F4F6;
      color:#6B7280;
    }

    /* Reference Images */
    .reference-images {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .reference-image-thumb {
      width:80px;
      height:80px;
      border-radius:8px;
      overflow:hidden;
      cursor:pointer;
      border:2px solid rgba(0,0,0,0.06);
      transition:all 0.2s;
    }
    .reference-image-thumb:hover {
      transform:scale(1.05);
      border-color:var(--accent);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .reference-image-thumb img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    /* Image Upload Area */
    .image-upload-area {
      border:2px dashed rgba(0,0,0,0.15);
      border-radius:12px;
      padding:32px;
      text-align:center;
      background:rgba(0,113,227,0.03);
      transition:all 0.3s;
      cursor:pointer;
      margin-top:12px;
    }
    .image-upload-area:hover {
      border-color:var(--accent);
      background:rgba(0,113,227,0.08);
    }
    .image-upload-area.drag-over {
      border-color:var(--accent);
      background:rgba(0,113,227,0.15);
      transform:scale(1.02);
    }
    .image-upload-icon {
      font-size:48px;
      margin-bottom:12px;
      opacity:0.6;
    }
    .image-upload-text {
      font-size:14px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .image-upload-hint {
      font-size:12px;
      color:var(--muted);
      opacity:0.7;
    }

    /* Editable Reference Images */
    .reference-images-editable {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .reference-image-editable {
      position:relative;
      width:120px;
      height:120px;
      border-radius:12px;
      overflow:hidden;
      border:2px solid rgba(0,0,0,0.1);
      transition:all 0.2s;
    }
    .reference-image-editable:hover {
      border-color:var(--accent);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .reference-image-editable img {
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .reference-image-delete {
      position:absolute;
      top:6px;
      right:6px;
      width:28px;
      height:28px;
      border-radius:50%;
      background:rgba(220,53,69,0.95);
      color:white;
      border:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      font-weight:bold;
      opacity:0;
      transition:all 0.2s;
      backdrop-filter:blur(10px);
    }
    .reference-image-editable:hover .reference-image-delete {
      opacity:1;
    }
    .reference-image-delete:hover {
      background:rgba(220,53,69,1);
      transform:scale(1.1);
    }

    /* No Data Placeholder */
    .no-data-placeholder {
      color:#9ca3af;
      font-size:13px;
      font-style:italic;
    }

    /* ========================================
       Project Grouping Styles
       ======================================== */

    /* Project Group Container */
    .project-group {
      margin-bottom: 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      overflow: hidden;
      background: white;
      transition: all 0.2s ease;
    }

    .project-group:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* Project Header */
    .project-header {
      padding: 16px;
      background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    .project-header:hover {
      background: linear-gradient(135deg, #eef1f5 0%, #f9fafb 100%);
    }

    .project-info {
      flex: 1;
    }

    .project-info h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: #1d1d1f;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .customer-name {
      font-size: 14px;
      color: var(--macos-text-primary);
      font-weight: 500;
      margin-right: 12px;
    }

    .project-stats {
      display: inline-flex;
      gap: 12px;
      font-size: 13px;
      color: #86868b;
      flex-wrap: wrap;
    }

    .project-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      margin-left: 12px;
    }

    .project-status.completed {
      background: #d1f4e0;
      color: #0d6832;
    }

    .project-status.in-progress {
      background: #fef3c7;
      color: #92400e;
    }

    .project-status.requested {
      background: #dbeafe;
      color: #1e40af;
    }

    /* Project Details */
    .project-details {
      padding: 16px;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      background: #fafafa;
      display: none;
    }

    .project-details.expanded {
      display: block;
    }

    .requests-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .requests-section h5 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--macos-text-primary);
    }

    /* Expand Button */
    .expand-btn {
      background: none;
      border: none;
      font-size: 18px;
      color: #86868b;
      cursor: pointer;
      transition: transform 0.2s;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .expand-btn:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .expand-btn.expanded {
      transform: rotate(180deg);
    }

    /* Project Group Header (for tables) */
    .project-group-header {
      background: rgba(0, 113, 227, 0.05);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .project-group-header:hover {
      background: rgba(0, 113, 227, 0.1);
    }

    .project-group-header td {
      padding: 12px 16px !important;
    }

    .project-group-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .project-badge {
      display: inline-block;
      padding: 4px 8px;
      background: #0071e3;
      color: white;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 12px;
    }

    .group-count {
      color: #86868b;
      font-size: 13px;
    }

    .expand-icon {
      margin-left: auto;
      font-size: 14px;
      color: #86868b;
      transition: transform 0.2s;
    }

    .expand-icon.expanded {
      transform: rotate(90deg);
    }

    .project-detail-row {
      background: white;
      display: none;
    }

    .project-detail-row.visible {
      display: table-row;
    }

    /* View Mode Toggle */
    .view-mode-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 10px;
      width: fit-content;
    }

    .toggle-btn {
      padding: 8px 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      font-weight: 500;
      color: var(--macos-text-primary);
    }

    .toggle-btn:hover {
      background: #f5f5f7;
      border-color: rgba(0, 0, 0, 0.15);
    }

    .toggle-btn.active {
      background: #0071e3;
      color: white;
      border-color: #0071e3;
      box-shadow: 0 2px 4px rgba(0, 113, 227, 0.2);
    }

    /* Customer Project Timeline Styles */
    .customer-project-card {
      position: relative;
      padding: 16px;
      padding-left: 24px;
      background: white;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .customer-project-card:hover {
      border-color: rgba(0, 113, 227, 0.3);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .project-status-indicator {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .customer-project-card.completed .project-status-indicator {
      background: #34c759;
    }

    .customer-project-card.in_progress .project-status-indicator {
      background: #ff9500;
    }

    .customer-project-card.requested .project-status-indicator {
      background: #007aff;
    }

    .project-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .project-number-small {
      font-size: 12px;
      font-weight: 600;
      color: #0071e3;
      font-family: 'Geist', -apple-system, sans-serif;
    }

    .project-status-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 10px;
      font-weight: 600;
    }

    .status-completed {
      background: #d1f4e0;
      color: #0d6832;
    }

    .status-in_progress {
      background: #fff3cd;
      color: #856404;
    }

    .status-requested {
      background: #e3f2fd;
      color: #1565c0;
    }

    .project-artist {
      font-size: 14px;
      font-weight: 500;
      color: #1d1d1f;
      margin-bottom: 6px;
    }

    .project-stats {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #86868b;
      margin-bottom: 6px;
    }

    .project-timeline-dates {
      font-size: 12px;
      color: #86868b;
    }

    /* Appointment Item Styles */
    .appointment-item {
      padding: 12px;
      background: white;
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .appointment-item:last-child {
      margin-bottom: 0;
    }

    .appointment-date {
      font-size: 14px;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 6px;
      font-family: 'Geist', -apple-system, sans-serif;
    }

    .appointment-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .booking-type {
      font-size: 13px;
      color: #86868b;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-scheduled, .status-badge.status-scheduled {
      background: #d1f4e0;
      color: #0d6832;
    }

    .status-finished, .status-badge.status-finished, .status-badge.status-completed {
      background: #e3f2fd;
      color: #1565c0;
    }

    .status-canceled, .status-badge.status-canceled, .status-badge.status-cancelled {
      background: #ffebee;
      color: #c62828;
    }

    .status-archived, .status-badge.status-archived {
      background: rgba(142, 142, 147, 0.1);
      color: #8E8E93;
    }

    /* ============================================
       STATE BADGES (DEUTSCH) - Appointment State Management
       ============================================ */
    .state-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 600;
      margin-right: 8px;
    }

    .state-badge.confirmed {
      background: #d1f4e0;
      color: #0d6832;
    }

    .state-badge.unknown {
      background: #e0e0e0;
      color: #666;
    }

    .state-badge.no-show {
      background: #ffebee;
      color: #c62828;
    }

    .state-badge.rescheduled {
      background: #fff3cd;
      color: #856404;
    }

    .state-badge.reserved {
      background: #e3f2fd;
      color: #1565c0;
    }

    /* ============================================
       STATUS BADGES (ENGLISH) - Auto-calculated Status
       ============================================ */
    .status-badge.scheduled {
      background: #e3f2fd;
      color: #1565c0;
    }

    .status-badge.finished {
      background: #d1f4e0;
      color: #0d6832;
    }

    .status-badge.canceled {
      background: #ffebee;
      color: #c62828;
    }

    .status-badge.no-show {
      background: #fce4ec;
      color: #c2185b;
    }

    .status-badge.reserved {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .status-badge.unknown {
      background: #e0e0e0;
      color: #666;
    }

    .status-badge.rescheduled {
      background: #fff3cd;
      color: #856404;
    }

    .status-badge.archived {
      background: rgba(142, 142, 147, 0.1);
      color: #8E8E93;
    }

    /* ============================================
       PAYMENT BADGES
       ============================================ */
    .payment-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .payment-badge.unpaid {
      background: #fff3cd;
      color: #856404;
    }

    .payment-badge.deposit {
      background: #d1ecf1;
      color: #0c5460;
    }

    .payment-badge.paid {
      background: #d4edda;
      color: #155724;
    }

    .payment-badge.refunded {
      background: #f8d7da;
      color: #721c24;
    }

    /* ============================================
       EDIT STATE MODAL - Interactive State Options
       ============================================ */
    .state-options .state-option {
      display: block;
      cursor: pointer;
    }

    .state-options .state-option input[type="radio"] {
      display: none;
    }

    .state-options .option-content {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #fafafa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .state-options .state-option:hover .option-content {
      background: #f0f0f0;
      border-color: #0071e3;
    }

    .state-options .state-option.selected .option-content,
    .state-options .state-option input:checked + .option-content {
      background: #e3f2fd;
      border-color: #0071e3;
      box-shadow: 0 2px 8px rgba(0, 113, 227, 0.2);
    }

    .appointment-notes {
      margin-top: 8px;
      font-size: 13px;
      color: #6e6e73;
      font-style: italic;
    }

    /* Image Modal */
    .image-modal {
      display:none;
      position:fixed;
      z-index:10000;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.9);
      align-items:center;
      justify-content:center;
    }
    .image-modal.active {
      display:flex;
    }
    .image-modal img {
      max-width:90%;
      max-height:90%;
      border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,0.5);
    }
    .image-modal-close {
      position:absolute;
      top:20px;
      right:20px;
      font-size:40px;
      color:white;
      cursor:pointer;
      background:rgba(0,0,0,0.5);
      width:50px;
      height:50px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background 0.2s;
    }
    .image-modal-close:hover {
      background:rgba(0,0,0,0.8);
    }

    /* Artist Preference List */
    .artist-preference-list {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .artist-preference-item {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 10px;
      background:rgba(0,113,227,0.1);
      color:var(--accent);
      border-radius:12px;
      font-size:12px;
      font-weight:600;
    }

    /* Artist Preference Tags */
    .artist-preference-tags {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
    }
    .artist-tag {
      display:inline-block;
      padding:6px 12px;
      background:#f3f4f6;
      border:1px solid #d1d5db;
      border-radius:6px;
      font-size:13px;
      font-weight:600;
      color:#374151;
    }
    .artist-tag-small {
      display:inline-block;
      padding:4px 10px;
      background:#f3f4f6;
      border:1px solid #d1d5db;
      border-radius:6px;
      font-size:11px;
      font-weight:600;
      color:#374151;
    }

    .request-name {
      font-size:15px;
      font-weight:600;
      margin-bottom:4px;
      color:var(--ink);
    }
    .request-date {
      font-size:12px;
      color:var(--muted);
    }
    
    /* Request Detail Styles */
    .detail-section {
      margin-bottom:32px;
    }
    .detail-section h3 {
      font-size:18px;
      font-weight:600;
      margin-bottom:16px;
      color:var(--ink);
      border-bottom:2px solid rgba(0,0,0,0.06);
      padding-bottom:8px;
    }
    .detail-grid {
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:16px;
    }
    .detail-item {
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .detail-label {
      font-size:11px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.8px;
    }
    .detail-value {
      font-size:15px;
      color:var(--ink);
      font-weight:500;
    }
    .action-buttons {
      display:flex;
      gap:12px;
      margin-top:32px;
      padding-top:24px;
      border-top:1px solid rgba(0,0,0,0.06);
      flex-wrap:wrap;
    }
    .btn {
      padding:12px 24px;
      border-radius:10px;
      border:none;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      font-family:inherit;
    }
    .btn-primary {
      background:var(--accent);
      color:white;
    }
    .btn-primary:hover {
      background:#0077ed;
      box-shadow:0 4px 12px rgba(0,113,227,0.3);
      transform:translateY(-1px);
    }
    .btn-success {
      background:#28a745;
      color:white;
    }
    .btn-success:hover {
      background:#218838;
      box-shadow:0 4px 12px rgba(40,167,69,0.3);
      transform:translateY(-1px);
    }
    .btn-danger {
      background:#dc3545;
      color:white;
    }
    .btn-danger:hover {
      background:#c82333;
      box-shadow:0 4px 12px rgba(220,53,69,0.3);
      transform:translateY(-1px);
    }
    .btn-secondary {
      background:#f5f5f7;
      color:var(--ink);
    }
    .btn-secondary:hover {
      background:#e8e8ed;
    }

    /* Login & Profile Styles - Fullscreen */
    .login-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #ffffff;
      z-index: 999999;
      align-items: center;
      justify-content: center;
    }
    .login-backdrop.active {
      display: flex;
    }
    .login-modal {
      background: transparent;
      border-radius: 0;
      padding: 40px;
      width: 100%;
      max-width: 420px;
      position: relative;
    }
    .login-welcome {
      text-align: center;
      margin-bottom: 32px;
    }
    .login-welcome h2 {
      margin: 0 0 8px 0;
      font-size: 28px;
      font-weight: 600;
    }
    .login-welcome p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }
    .login-form .form-group {
      margin-bottom: 20px;
    }
    .login-form label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--ink);
    }
    .login-form input[type="text"],
    .login-form input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .login-form input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }
    .login-remember {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
    }
    .login-remember input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .login-remember label {
      font-size: 14px;
      cursor: pointer;
      margin: 0;
    }
    .login-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .skip-button {
      background: transparent;
      color: var(--muted);
      border: 1px dashed #ddd;
      text-decoration: none;
      font-size: 13px;
    }
    .skip-button:hover {
      background: #f5f5f5;
      color: var(--ink);
      border-color: #ccc;
    }
    .profile-button {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: #f5f5f7;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 24px;
      color: var(--ink);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: auto;
    }
    .profile-button:hover {
      background: #e8e8ed;
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .profile-button svg {
      width: 20px;
      height: 20px;
    }
    .profile-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(0, 0, 0, 0.1);
    }
    .profile-view {
      max-height: 80vh;
      overflow-y: auto;
    }
    .profile-header {
      text-align: center;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid #eee;
    }
    .profile-avatar-large {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 16px;
      border: 4px solid #f5f5f5;
      display: block;
    }
    .profile-info-group {
      margin-bottom: 20px;
    }
    .profile-info-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .profile-info-value {
      padding: 12px 16px;
      background: #f9f9f9;
      border-radius: 8px;
      font-size: 14px;
      color: var(--ink);
    }
    .profile-role-badge {
      display: inline-block;
      padding: 6px 12px;
      background: var(--accent);
      color: white;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .password-toggle {
      position: relative;
    }
    .password-toggle button {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      padding: 4px 8px;
    }
    .dashboard-welcome {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 32px;
      padding: 0;
      background: transparent;
      border-radius: 0;
      color: var(--text-primary);
    }
    .dashboard-welcome-avatar {
      display: none;
    }
    .dashboard-welcome-text h1 {
      margin: 0 0 4px 0;
      font-size: 28px;
      font-weight: 600;
    }
    .dashboard-welcome-text p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* ========================================
       DASHBOARD LAYOUT
       ======================================== */

    .dashboard-view {
      padding: 40px 24px;
    }

    .dashboard-grid {
      display: flex;
      flex-direction: column;
      gap: 24px;
      max-width: 1400px;
    }

    .dashboard-main {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .dashboard-bottom-row {
      display: grid;
      grid-template-columns: 30% 70%;
      gap: 24px;
    }

    .container-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .container-section-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0;
      padding-left: 4px;
    }

    .dashboard-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    /* ========================================
       PINNED EVENTS
       ======================================== */

    .pinned-events-card {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      max-height: 500px;
    }

    .event-item {
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background-color 0.2s ease;
      border-radius: 4px;
      margin: 0 -4px;
      padding-left: 4px;
      padding-right: 4px;
    }

    .event-item:hover {
      background: var(--hover-bg-light);
    }

    .event-item:last-child {
      border-bottom: none;
    }

    .event-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .event-meta {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .event-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      background: var(--hover-bg-light);
      color: var(--text-secondary);
    }

    .event-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* ========================================
       SCHWARZES BRETT
       ======================================== */

    .schwarzes-brett-card {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      position: relative;
      max-height: 500px;
    }

    .brett-item {
      padding: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }

    .brett-item:hover {
      background: var(--hover-bg-light);
      border-color: var(--border-color-strong);
    }

    .brett-item:last-child {
      margin-bottom: 0;
    }

    .brett-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .brett-author {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .brett-time {
      font-size: 12px;
      color: var(--text-tertiary);
    }

    .brett-content {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .brett-footer {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brett-tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      background: var(--hover-bg);
      color: var(--text-secondary);
    }

    .brett-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* ========================================
       ADD BUTTON
       ======================================== */

    .add-btn {
      width: 100%;
      height: 40px;
      margin-top: 12px;
      border: 1px dashed var(--border-color);
      background: transparent;
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .add-btn:hover {
      border-color: var(--border-color-strong);
      background: var(--hover-bg-light);
      color: var(--text-primary);
    }

    /* ========================================
       NEW MESSAGE POPUP
       ======================================== */

    .new-message-popup {
      display: none;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .new-message-popup.active {
      display: block;
    }

    .popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .popup-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0;
    }

    .popup-close {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.15s ease;
    }

    .popup-close:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
    }

    .popup-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg);
      font-size: 14px;
      color: var(--text-primary);
      resize: vertical;
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin-bottom: 12px;
    }

    .popup-textarea::placeholder {
      color: var(--text-secondary);
    }

    .popup-textarea:focus {
      outline: none;
      border-color: var(--input-focus-border);
    }

    /* Customer Rank Badges */
    .rank-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 6px;
      vertical-align: middle;
    }

    .rank-badge.rank-platinum {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1d1d1f;
      box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
    }

    .rank-badge.rank-gold {
      background: #FF8C00;
      color: white;
      box-shadow: 0 2px 4px rgba(255, 140, 0, 0.3);
    }

    .rank-badge.rank-silver {
      background: #C0C0C0;
      color: #1d1d1f;
      box-shadow: 0 2px 4px rgba(192, 192, 192, 0.3);
    }

    .rank-badge.rank-bronze {
      background: #CD7F32;
      color: white;
      box-shadow: 0 2px 4px rgba(205, 127, 50, 0.3);
    }

    /* Artist Rank Badges */
    .rank-badge.rank-R1 {
      background: #FEE2E2;
      color: #991B1B;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .rank-badge.rank-R2 {
      background: #FED7AA;
      color: #9A3412;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .rank-badge.rank-R3 {
      background: #FEF3C7;
      color: #92400E;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .rank-badge.rank-R4 {
      background: #D1FAE5;
      color: #065F46;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .rank-badge.rank-R5 {
      background: #DBEAFE;
      color: #1E40AF;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    /* Artist Type Badges */
    .type-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    .type-badge.guest {
      background: #E0E7FF;
      color: #3730A3;
    }

    .type-badge.resident {
      background: #D1FAE5;
      color: #065F46;
    }

    /* Status Badges */
    .status-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.active {
      background: #D1FAE5;
      color: #065F46;
    }

    .status-badge.inactive {
      background: #FEE2E2;
      color: #991B1B;
    }

    /* Location Badge */
    .location-badge {
      background: var(--location-light);
      color: var(--location-primary);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    /* Blacklist Badge */
    .blacklist-badge {
      background: #FEE2E2;
      color: #991B1B;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 8px;
      font-weight: 600;
    }

    /* Pagination */
    .pagination-controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      margin-top: 24px;
    }

    .btn-pagination {
      padding: 8px 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .btn-pagination:hover {
      background: var(--location-light);
      border-color: var(--location-primary);
    }

    .btn-pagination.active {
      background: var(--location-primary);
      color: white;
      border-color: var(--location-primary);
      font-weight: 600;
    }

    .pagination-dots {
      color: var(--muted);
      padding: 0 8px;
    }

    /* Filter Select Focus Styles */
    .filter-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }

    /* ========================================
       Analytics Charts - Frosted Glass
       ======================================== */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 24px;
    }

    .chart-card {
      background: var(--macos-panel) !important;
      backdrop-filter: var(--macos-blur-medium);
      -webkit-backdrop-filter: var(--macos-blur-medium);
      border-radius: var(--radius-xl);
      padding: 24px;
      box-shadow: var(--macos-shadow-medium);
      border: 1px solid var(--macos-stroke-primary);
    }

    .chart-card h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--macos-text-primary) !important;
    }

    /* Pie Charts - Smaller Size (max 20vw) */
    .chart-card canvas {
      max-width: 20vw;
      max-height: 20vw;
      margin: 0 auto;
      display: block;
    }

    /* Timeline and Bar Charts - Keep Full Width */
    #bookingsTimeline,
    #revenueTimeline,
    #revenueByStatusChart {
      max-width: 100% !important;
      max-height: 600px !important;
    }

    /* Time Range Tabs */
    .time-range-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .time-tab {
      padding: 8px 16px;
      border: 1px solid var(--stroke);
      background: transparent;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ink);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .time-tab.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .time-tab:hover:not(.active) {
      background: rgba(0, 113, 227, 0.06);
    }

    /* Analytics Filters */
    .analytics-filters {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 16px;
    }

    .analytics-filters select {
      min-width: 200px;
    }

    /* Data Tables for Analytics */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .data-table th {
      text-align: left;
      padding: 8px 12px;
      font-weight: 600;
      color: var(--macos-text-secondary);
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .data-table td {
      padding: 8px 12px;
      color: var(--macos-text-primary);
      border-bottom: 1px solid rgba(0,0,0,0.04);
    }

    .data-table tbody tr:hover {
      background: rgba(0,0,0,0.02);
    }

    .data-table tfoot tr {
      border-top: 2px solid rgba(0,0,0,0.1);
      background: rgba(0,0,0,0.02);
    }

    .data-table tfoot td {
      padding: 12px;
      border-bottom: none;
    }

    /* Responsive Charts */
    @media (max-width: 1024px) {
      .charts-grid {
        grid-template-columns: 1fr !important;
      }
    }

    @media (max-width: 768px) {
      .time-range-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .time-tab {
        white-space: nowrap;
      }

      .analytics-filters {
        flex-direction: column;
        align-items: stretch;
      }

      .analytics-filters select {
        width: 100%;
      }
    }

    /* ========================================
       PROJECT DASHBOARD STYLES
       ======================================== */

    /* KPI Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .kpi-card {
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.2s;
    }

    .kpi-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }

    .kpi-card.active {
      background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
      border-color: #ff9500;
    }

    .kpi-card.completed {
      background: linear-gradient(135deg, #d1f4e0 0%, #ffffff 100%);
      border-color: #34c759;
    }

    .kpi-card.revenue {
      background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
      border-color: #0071e3;
    }

    .kpi-icon {
      font-size: 32px;
      line-height: 1;
    }

    .kpi-content {
      flex: 1;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 700;
      color: #1d1d1f;
      font-family: 'Geist', sans-serif;
      line-height: 1.2;
    }

    .kpi-label {
      font-size: 13px;
      color: #86868b;
      margin-top: 4px;
    }

    /* Performance Table */
    .performance-table-wrapper {
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    .performance-table {
      width: 100%;
      border-collapse: collapse;
    }

    .performance-table thead {
      background: #f5f7fa;
    }

    .performance-table th {
      padding: 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: #1d1d1f;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(0, 0, 0, 0.06);
    }

    .performance-table td {
      padding: 16px;
      font-size: 14px;
      color: #1d1d1f;
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
    }

    .performance-table tbody tr:hover {
      background: #fafafa;
    }

    .performance-table .artist-name,
    .performance-table .customer-name {
      font-weight: 600;
    }

    .performance-table .revenue {
      font-weight: 600;
      color: #34c759;
    }

    .badge-success {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: #d1f4e0;
      color: #0d6832;
    }

    .badge-warning {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: #fff3cd;
      color: #856404;
    }

    /* Charts Container */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-top: 32px;
    }

    .chart-card {
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 12px;
      padding: 24px;
      min-height: 350px;
    }

    .chart-card canvas {
      max-height: 300px;
    }

    .stats-summary {
      background: linear-gradient(135deg, #0071e3 0%, #0056b3 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .stats-summary h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .dashboard-section {
      margin-bottom: 48px;
    }

    .dashboard-section h2 {
      margin-bottom: 24px;
      font-size: 24px;
      font-weight: 600;
      color: #1d1d1f;
    }

    /* Loading Progress Bar - Pop-up Style (Bottom Right) */
    .loading-overlay {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.3s ease, transform 0.3s ease;
      transform: translateY(0);
      pointer-events: none; /* Don't block clicks on the page */
    }

    .loading-overlay.hidden {
      opacity: 0;
      transform: translateY(20px);
    }

    .loading-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 20px 24px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
      min-width: 320px;
      pointer-events: auto; /* Allow clicks on the modal itself */
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .progress-line {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #0071e3 0%, #00a8ff 100%);
      border-radius: inherit;
      transition: width 0.15s linear;
      box-shadow: 0 0 8px rgba(0, 113, 227, 0.5);
    }

    .progress-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #fff;
    }

    .progress-percent {
      font-weight: 600;
      font-size: 15px;
      font-variant-numeric: tabular-nums;
      color: #fff;
    }

    .progress-text {
      color: rgba(255, 255, 255, 0.8);
      font-size: 13px;
      font-weight: 500;
      margin-top: 4px;
      line-height: 1.4;
    }

    /* Close button for progress bar */
    .progress-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
      opacity: 0;
    }

    .loading-container:hover .progress-close {
      opacity: 1;
    }

    .progress-close:hover {
      background: rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
    }

    /* Responsive Design for Mobile */
    @media (max-width: 768px) {
      .loading-overlay {
        bottom: 16px;
        right: 16px;
        left: 16px;
      }

      .loading-container {
        min-width: unset;
        width: 100%;
      }
    }

    /* Initial Fullscreen Loader */
    .initial-loader {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--macos-bg);
      z-index: 1000000;
      align-items: center;
      justify-content: center;
    }
    .initial-loader.active {
      display: flex;
    }
    .loader-content {
      text-align: center;
    }
    .loader-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--macos-fill-tertiary);
      border-top-color: var(--macos-accent-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 20px;
    }
    .loader-text {
      font-size: 15px;
      font-weight: 500;
      color: var(--macos-text-secondary);
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========================================
       HEADER SECTION
       ======================================== */

    .header-section {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 0 24px;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      border-bottom: none;
    }

    [data-theme="dark"] .header-section {
      background: #1c1c1e;
      border-bottom: none;
    }

    .header-title {
      color: rgba(0, 0, 0, 0.9);
      font-size: 15px;
      margin: 0;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    [data-theme="dark"] .header-title {
      color: rgba(255, 255, 255, 0.9);
    }

    .header-title:hover {
      color: rgba(0, 0, 0, 0.6);
    }

    [data-theme="dark"] .header-title:hover {
      color: rgba(255, 255, 255, 0.6);
    }

    .nav-icons {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .icon-button {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: var(--bg);
      border: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    [data-theme="dark"] .icon-button {
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .icon-button:hover {
      background: rgba(0, 0, 0, 0.04);
      border-color: rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] .icon-button:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .icon-button svg {
      width: 18px;
      height: 18px;
      color: rgba(0, 0, 0, 0.6);
    }

    [data-theme="dark"] .icon-button svg {
      color: rgba(255, 255, 255, 0.6);
    }

    /* Feedback Button */
    .feedback-button {
      height: 35px;
      padding: 0 12px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      font-size: 14px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.9);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    [data-theme="dark"] .feedback-button {
      background: #1c1c1e;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.9);
    }

    .feedback-button:hover {
      background: rgba(0, 0, 0, 0.04);
      border-color: rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] .feedback-button:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
    }

    /* Profile Dropdown */
    .profile-dropdown {
      position: fixed;
      top: 72px;
      right: 24px;
      width: 256px;
      max-height: 449px;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.02),
                  0px 2px 4px rgba(0, 0, 0, 0.02),
                  0px 8px 16px -4px rgba(0, 0, 0, 0.08),
                  0px 24px 32px -8px rgba(0, 0, 0, 0.12);
      padding: 8px;
      display: none;
      flex-direction: column;
      z-index: 1001;
      overflow-y: auto;
      box-sizing: border-box;
    }

    [data-theme="dark"] .profile-dropdown {
      background: #1c1c1e;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .profile-dropdown.active {
      display: flex;
    }

    .profile-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      margin: -8px -8px 4px -8px;
      width: calc(100% + 16px);
      box-sizing: border-box;
    }

    [data-theme="dark"] .profile-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .profile-username {
      font-size: 14px;
      font-weight: 600;
      color: rgba(0, 0, 0, 0.9);
      margin-bottom: 4px;
      text-align: left;
    }

    [data-theme="dark"] .profile-username {
      color: rgba(255, 255, 255, 0.9);
    }

    .profile-email {
      font-size: 13px;
      color: rgba(0, 0, 0, 0.5);
      text-align: left;
    }

    [data-theme="dark"] .profile-email {
      color: rgba(255, 255, 255, 0.5);
    }

    .dropdown-item {
      padding: 0 12px;
      height: 40px;
      width: 100%;
      font-size: 14px;
      font-weight: 350;
      color: rgba(0, 0, 0, 0.5);
      cursor: pointer;
      border-radius: 6px;
      transition: color 0.15s ease, background-color 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-sizing: border-box;
    }

    [data-theme="dark"] .dropdown-item {
      color: rgba(255, 255, 255, 0.5);
    }

    .dropdown-item:hover {
      background: rgba(0, 0, 0, 0.04);
      color: rgba(0, 0, 0, 0.9);
    }

    [data-theme="dark"] .dropdown-item:hover {
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.9);
    }

    .dropdown-item svg {
      width: 16px;
      height: 16px;
      color: rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .dropdown-item svg {
      color: rgba(255, 255, 255, 0.5);
    }

    .dropdown-separator {
      height: 1px;
      background: rgba(0, 0, 0, 0.1);
      margin: 8px -8px;
      width: calc(100% + 16px);
    }

    [data-theme="dark"] .dropdown-separator {
      background: rgba(255, 255, 255, 0.1);
    }

    .keyboard-shortcut {
      display: flex;
      gap: 4px;
      align-items: center;
      font-size: 12px;
      color: rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .keyboard-shortcut {
      color: rgba(255, 255, 255, 0.5);
    }

    .theme-options {
      display: flex;
      gap: 4px;
    }

    .theme-btn {
      padding: 4px 8px;
      min-width: 28px;
      height: 24px;
      border-radius: 6px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.15s ease, border-color 0.15s ease;
      font-size: 12px;
      color: rgba(0, 0, 0, 0.5);
      font-weight: 400;
    }

    [data-theme="dark"] .theme-btn {
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: #1c1c1e;
      color: rgba(255, 255, 255, 0.5);
    }

    .theme-btn:hover {
      background: rgba(0, 0, 0, 0.04);
      border-color: rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] .theme-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .theme-btn.active {
      background: rgba(0, 0, 0, 0.08);
      border-color: rgba(0, 0, 0, 0.15);
      color: rgba(0, 0, 0, 0.9);
    }

    [data-theme="dark"] .theme-btn.active {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.9);
    }

    .theme-btn svg {
      width: 14px;
      height: 14px;
      color: currentColor;
    }

    .upgrade-btn {
      margin-top: 8px;
      width: 100%;
      height: 32px;
      padding: 0 12px;
      background: rgba(0, 0, 0, 0.9);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    [data-theme="dark"] .upgrade-btn {
      background: rgba(255, 255, 255, 0.9);
      color: #1c1c1e;
    }

    .upgrade-btn:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    [data-theme="dark"] .upgrade-btn:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    .upgrade-btn svg {
      color: currentColor;
    }

    /* Notifications Dropdown */
    .notifications-dropdown {
      position: fixed;
      top: 72px;
      right: 71px;
      width: 400px;
      height: 500px;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.02),
                  0px 2px 4px rgba(0, 0, 0, 0.02),
                  0px 8px 16px -4px rgba(0, 0, 0, 0.08),
                  0px 24px 32px -8px rgba(0, 0, 0, 0.12);
      display: none;
      flex-direction: column;
      z-index: 1001;
    }

    [data-theme="dark"] .notifications-dropdown {
      background: #1c1c1e;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .notifications-dropdown.active {
      display: flex;
    }

    .notifications-tabs {
      display: flex;
      gap: 24px;
      padding: 16px 20px 0 20px;
      border-bottom: 2px solid rgba(0, 0, 0, 0.1);
      position: relative;
    }

    [data-theme="dark"] .notifications-tabs {
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .notification-tab {
      font-size: 14px;
      font-weight: 350;
      color: rgba(0, 0, 0, 0.5);
      cursor: pointer;
      padding-bottom: 16px;
      position: relative;
      transition: color 0.2s ease;
    }

    [data-theme="dark"] .notification-tab {
      color: rgba(255, 255, 255, 0.5);
    }

    .notification-tab:hover {
      color: rgba(0, 0, 0, 0.9);
    }

    [data-theme="dark"] .notification-tab:hover {
      color: rgba(255, 255, 255, 0.9);
    }

    .notification-tab.active {
      color: rgba(0, 0, 0, 0.9);
    }

    [data-theme="dark"] .notification-tab.active {
      color: rgba(255, 255, 255, 0.9);
    }

    .notification-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1;
    }

    [data-theme="dark"] .notification-tab.active::after {
      background: rgba(255, 255, 255, 0.9);
    }

    .notifications-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .empty-icon {
      width: 48px;
      height: 48px;
      color: rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .empty-icon {
      color: rgba(255, 255, 255, 0.5);
    }

    .empty-text {
      font-size: 14px;
      color: rgba(0, 0, 0, 0.5);
      margin: 0;
    }

    [data-theme="dark"] .empty-text {
      color: rgba(255, 255, 255, 0.5);
    }

    /* Feedback Dropdown */
    .feedback-dropdown {
      position: fixed;
      top: 72px;
      right: 118px;
      width: 340px;
      height: 260px;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.02),
                  0px 2px 4px rgba(0, 0, 0, 0.02),
                  0px 8px 16px -4px rgba(0, 0, 0, 0.08),
                  0px 24px 32px -8px rgba(0, 0, 0, 0.12);
      padding: 16px;
      display: none;
      flex-direction: column;
      gap: 12px;
      z-index: 1001;
    }

    [data-theme="dark"] .feedback-dropdown {
      background: #1c1c1e;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .feedback-dropdown.active {
      display: flex;
    }

    .feedback-select {
      width: 100%;
      height: 44px;
      padding: 0 12px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: #ffffff;
      font-size: 14px;
      color: rgba(0, 0, 0, 0.9);
      cursor: pointer;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2386868b' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    [data-theme="dark"] .feedback-select {
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: #1c1c1e;
      color: rgba(255, 255, 255, 0.9);
    }

    .feedback-textarea {
      width: 100%;
      flex: 1;
      padding: 12px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: #ffffff;
      font-size: 14px;
      color: rgba(0, 0, 0, 0.9);
      resize: none;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100px;
    }

    [data-theme="dark"] .feedback-textarea {
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: #1c1c1e;
      color: rgba(255, 255, 255, 0.9);
    }

    .feedback-textarea::placeholder {
      color: rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .feedback-textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .feedback-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .feedback-emojis {
      display: flex;
      gap: 4px;
    }

    .emoji-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
      border-radius: 6px;
      transition: background-color 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .emoji-btn:hover {
      background: rgba(0, 0, 0, 0.04);
    }

    [data-theme="dark"] .emoji-btn:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .feedback-send-btn {
      height: 36px;
      padding: 0 20px;
      background: rgba(0, 0, 0, 0.9);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.15s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    [data-theme="dark"] .feedback-send-btn {
      background: rgba(255, 255, 255, 0.9);
      color: #1c1c1e;
    }

    .feedback-send-btn:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    [data-theme="dark"] .feedback-send-btn:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    /* ========================================
       NAVBAR - CLEAN & SIMPLE
       ======================================== */

    .navbar-container {
      display: flex;
      gap: 0; /* â­ Kein Gap */
      padding: 0 24px; /* Padding fÃ¼r Alignment mit Header */
      background: #ffffff; /* â­ WEIÃŸ */
      opacity: 1; /* â­ Komplett undurchsichtig */
      border-radius: 0; /* â­ KEINE rounded corners */
      backdrop-filter: none; /* â­ KEIN Blur */
      position: fixed; /* â­ Fixed unter Header */
      top: 64px; /* â­ Unter dem Header */
      left: 0;
      right: 0;
      z-index: 999; /* Unter dem Header */
      height: 46px;
      align-items: center;
      border-bottom: 1px solid var(--border-color); /* Subtile Trennlinie */
    }

    [data-theme="dark"] .navbar-container {
      background: #1c1c1e;
      opacity: 1;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-link {
      padding: 12px 20px; /* â­ Mehr Padding fÃ¼r bessere KlickflÃ¤che */
      border-radius: 0; /* â­ KEINE rounded corners */
      text-decoration: none;
      color: rgba(0, 0, 0, 0.5); /* â­ Heller fÃ¼r inactive */
      font-size: 14px;
      font-weight: 400; /* â­ Normal weight */
      transition: color 0.2s ease;
      cursor: pointer;
      position: relative;
      z-index: 1;
      white-space: nowrap;
      background: transparent; /* â­ KEIN Background */
      border: none; /* â­ KEIN Border */
    }

    [data-theme="dark"] .nav-link {
      color: rgba(255, 255, 255, 0.5);
    }

    .nav-link:hover {
      color: rgba(0, 0, 0, 0.7); /* â­ Nur Text dunkler */
    }

    [data-theme="dark"] .nav-link:hover {
      color: rgba(255, 255, 255, 0.7);
    }

    .nav-link.active {
      color: rgba(0, 0, 0, 0.9); /* â­ Text ganz dunkel */
      font-weight: 500; /* â­ Medium weight */
      background: transparent; /* â­ KEIN Background */
      border: none; /* â­ KEIN Border */
    }

    [data-theme="dark"] .nav-link.active {
      color: rgba(255, 255, 255, 0.9);
      background: transparent;
    }

    /* ========================================
       HOVER BACKGROUND (Grauer Container)
       ======================================== */

    .hover-background {
      position: absolute;
      height: calc(100% - 16px);
      background: rgba(0, 0, 0, 0.06);
      border-radius: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      opacity: 0;
      top: 8px;
      z-index: 0;
    }

    [data-theme="dark"] .hover-background {
      background: rgba(255, 255, 255, 0.08);
    }

    /* ========================================
       ACTIVE INDIKATOR-LINIE (Am Bottom)
       ======================================== */

    .active-indicator {
      position: absolute;
      bottom: -1px;
      height: 2px;
      background: rgba(0, 0, 0, 0.9);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 2;
    }

    [data-theme="dark"] .active-indicator {
      background: rgba(255, 255, 255, 0.9);
    }

    /* ========================================
       MOBILE FOOTER NAVIGATION
       ======================================== */

    .mobile-footer-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      padding: 8px 16px 24px 16px;
      justify-content: space-around;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] .mobile-footer-nav {
      background: rgba(18, 18, 18, 0.95);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
    }

    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 12px;
    }

    .mobile-nav-item:active {
      transform: scale(0.95);
      background: rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] .mobile-nav-item:active {
      background: rgba(255, 255, 255, 0.05);
    }

    .mobile-nav-icon {
      width: 24px;
      height: 24px;
      stroke: rgba(0, 0, 0, 0.5);
      transition: all 0.2s ease;
    }

    [data-theme="dark"] .mobile-nav-icon {
      stroke: rgba(255, 255, 255, 0.5);
    }

    .mobile-nav-item.active .mobile-nav-icon {
      stroke: rgba(0, 0, 0, 0.9);
    }

    [data-theme="dark"] .mobile-nav-item.active .mobile-nav-icon {
      stroke: rgba(255, 255, 255, 0.9);
    }

    .mobile-nav-label {
      font-size: 11px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.5);
      transition: all 0.2s ease;
    }

    [data-theme="dark"] .mobile-nav-label {
      color: rgba(255, 255, 255, 0.5);
    }

    .mobile-nav-item.active .mobile-nav-label {
      color: rgba(0, 0, 0, 0.9);
    }

    [data-theme="dark"] .mobile-nav-item.active .mobile-nav-label {
      color: rgba(255, 255, 255, 0.9);
    }

    /* ========================================
       ACCOUNT SETTINGS PAGE
       ======================================== */

    /* Settings View Container */
    .settings-view {
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 110px);
      background: var(--bg-secondary);
    }

    /* Account Settings Top Section */
    .account-settings-header {
      background: var(--bg-secondary);
      padding: 40px 40px 32px 40px;
      border-bottom: 1px solid var(--border-color);
    }

    .account-settings-title {
      font-size: 32px;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0;
    }

    /* Settings Content Wrapper (Sidebar + Content) */
    .settings-content-wrapper {
      display: flex;
      flex: 1;
      background: var(--bg-secondary);
    }

    /* ========================================
       SETTINGS SIDEBAR
       ======================================== */

    .settings-sidebar {
      width: 280px;
      background: transparent;
      padding: 24px 0;
      border-right: 1px solid var(--border-color);
    }

    .search-container {
      padding: 0 24px 24px 24px;
    }

    .search-input {
      width: 100%;
      height: 36px;
      padding: 0 12px 0 36px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg);
      font-size: 13px;
      color: var(--text-primary);
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='11' cy='11' r='8' stroke='%2386868b' stroke-width='2'/%3E%3Cpath d='M21 21L16.65 16.65' stroke='%2386868b' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      background-size: 16px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--input-focus-border);
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    .sidebar-nav {
      list-style: none;
      padding: 0 12px;
      margin: 0;
    }

    .nav-item {
      padding: 8px 12px;
      font-size: 14px;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 6px;
      margin-bottom: 2px;
      transition: background-color 0.15s ease, color 0.15s ease;
    }

    .nav-item:hover {
      background: var(--hover-bg-light);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--hover-bg);
      color: var(--text-primary);
      font-weight: 400;
    }

    /* ========================================
       SETTINGS CONTENT AREA
       ======================================== */

    .settings-content {
      flex: 1;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
    }

    .settings-main-content {
      flex: 1;
      overflow-y: auto;
    }

    /* Tab Content */
    .tab-content {
      display: none;
      padding: 40px;
    }

    .tab-content.active {
      display: block;
    }

    /* ========================================
       SETTINGS CARDS
       ======================================== */

    .settings-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .card-section {
      padding: 24px 0;
    }

    .card-section:first-child {
      padding-top: 0;
    }

    .card-section:not(:last-child) {
      border-bottom: 1px solid var(--border-color);
    }

    .section-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .section-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 16px;
    }

    /* ========================================
       AVATAR SECTION
       ======================================== */

    .avatar-container {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-top: 16px;
    }

    .avatar-display {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      flex-shrink: 0;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .avatar-display:hover {
      transform: scale(1.05);
    }

    .avatar-display img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .avatar-actions {
      display: flex;
      gap: 12px;
    }

    /* ========================================
       BUTTONS
       ======================================== */

    .btn {
      height: 36px;
      padding: 0 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: background-color 0.15s ease, border-color 0.15s ease;
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .btn-primary {
      background: var(--button-primary-bg);
      color: var(--button-primary-text);
    }

    .btn-primary:hover {
      background: var(--button-primary-hover);
    }

    .btn-secondary {
      background: var(--button-secondary-bg);
      color: var(--button-secondary-text);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--button-secondary-hover);
      border-color: var(--border-color-strong);
    }

    .btn-danger {
      background: transparent;
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
    }

    /* ========================================
       USER INFO GRID
       ======================================== */

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 16px;
    }

    .info-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .field-value {
      font-size: 14px;
      color: var(--text-primary);
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    /* ========================================
       INPUT FIELDS
       ======================================== */

    .input-group {
      margin-bottom: 16px;
    }

    .input-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .input-field {
      width: 100%;
      height: 44px;
      padding: 0 12px;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      background: var(--input-bg);
      font-size: 14px;
      color: var(--text-primary);
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      transition: border-color 0.15s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--input-focus-border);
    }

    .input-field::placeholder {
      color: var(--text-tertiary);
    }

    .input-helper {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 6px;
    }

    .save-container {
      display: flex;
      justify-content: flex-end;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      margin-top: 16px;
    }

    /* Hidden File Input */
    #avatarUpload {
      display: none;
    }

    /* ========================================
       ACTIVITY TAB
       ======================================== */

    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .activity-item {
      padding: 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      display: flex;
      gap: 12px;
    }

    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--hover-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .activity-icon svg {
      width: 20px;
      height: 20px;
      color: var(--text-secondary);
    }

    .activity-details {
      flex: 1;
    }

    .activity-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .activity-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .activity-time {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    /* ========================================
       MOBILE RESPONSIVE - ACCOUNT SETTINGS
       ======================================== */

    @media (max-width: 768px) {
      .account-settings-header {
        padding: 20px 16px;
      }

      .account-settings-title {
        font-size: 24px;
      }

      .settings-content-wrapper {
        flex-direction: column;
      }

      .settings-sidebar {
        width: 100%;
        padding: 16px 0;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }

      .search-container {
        padding: 0 16px 16px 16px;
      }

      .sidebar-nav {
        padding: 0 16px;
        display: flex;
        overflow-x: auto;
        gap: 8px;
      }

      .nav-item {
        white-space: nowrap;
        margin-bottom: 0;
      }

      .tab-content {
        padding: 20px 16px;
      }

      .info-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .avatar-container {
        flex-direction: column;
        align-items: flex-start;
      }

      .avatar-actions {
        width: 100%;
      }

      .avatar-actions button {
        flex: 1;
      }
    }

    /* ========================================
       RESPONSIVE
       ======================================== */

    @media (max-width: 768px) {
      /* Header adjustments for mobile */
      .header-section {
        padding: 0 16px;
        height: 56px;
      }

      .header-title {
        font-size: 14px;
      }

      /* Feedback Button auf Mobile verstecken */
      .feedback-button {
        display: none;
      }

      .icon-button {
        width: 32px;
        height: 32px;
      }

      .icon-button svg {
        width: 16px;
        height: 16px;
      }

      /* Profile Button nur auf Desktop */
      .icon-button.profile {
        display: none;
      }

      /* Navbar unter kleineren Header */
      .navbar-container {
        display: none !important;
        top: 56px;
        height: 42px;
      }

      /* Section adjustments for mobile */
      section {
        margin-top: 56px; /* Nur Header auf Mobile */
        margin-bottom: 72px; /* Platz fÃ¼r Footer Nav */
        min-height: calc(100vh - 128px);
      }

      .mobile-footer-nav {
        display: flex !important;
      }

      /* Raum fÃ¼r Mobile Footer */
      body {
        padding-bottom: 80px;
      }

      /* Dropdowns Anpassung fÃ¼r Mobile */
      .profile-dropdown {
        top: 60px;
        right: 16px;
        width: calc(100vw - 32px);
        max-width: 320px;
      }

      .notifications-dropdown {
        top: 60px;
        right: 16px;
        left: 16px;
        width: auto;
        height: 400px;
      }

      .feedback-dropdown {
        top: 60px;
        right: 16px;
        width: calc(100vw - 32px);
      }
    }
  </style>
</head>
<body>
  <!-- Fullscreen Initial Loading Indicator -->
  <div id="initialLoader" class="initial-loader active">
    <div class="loader-content">
      <div class="loader-spinner"></div>
      <div class="loader-text">Lade Daten...</div>
    </div>
  </div>

  <!-- Loading Progress Bar Overlay (Pop-up) -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-container">
      <button class="progress-close" onclick="ProgressBar.hide()" title="Close progress bar">âœ•</button>
      <div class="progress-text" id="progressText">Loading data...</div>
      <div class="progress-info">
        <div class="progress-line">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-percent" id="progressPercent">0%</div>
      </div>
    </div>
  </div>

  <!-- Header Section -->
  <div class="header-section">
    <h2 class="header-title">Culture over Money Dashboard</h2>

    <div class="nav-icons">
      <!-- Feedback Button (nur Desktop) -->
      <button class="feedback-button" id="feedbackButton">
        Feedback
      </button>

      <!-- Notification Bell -->
      <button class="icon-button notification" id="notificationButton">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 22C13.1 22 14 21.1 14 20H10C10 21.1 10.9 22 12 22ZM18 16V11C18 7.93 16.37 5.36 13.5 4.68V4C13.5 3.17 12.83 2.5 12 2.5C11.17 2.5 10.5 3.17 10.5 4V4.68C7.64 5.36 6 7.92 6 11V16L4 18V19H20V18L18 16Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
      </button>

      <!-- Profile Icon (Desktop only) -->
      <button class="icon-button profile" id="profileButton">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="1.5"/>
          <path d="M20 20C20 16.134 16.418 13 12 13C7.582 13 4 16.134 4 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Profile Dropdown -->
  <div class="profile-dropdown" id="profileDropdown">
    <div class="profile-header">
      <div class="profile-username" id="profileDropdownUsername">User name</div>
      <div class="profile-email" id="profileDropdownEmail">user@example.com</div>
    </div>

    <div class="dropdown-item" id="dashboardLinkDropdown">Dashboard</div>
    <div class="dropdown-item" id="accountSettingsLink">Account Settings</div>

    <div class="dropdown-separator"></div>

    <div class="dropdown-item" id="commandMenuLink">
      <span>Command Menu</span>
      <div class="keyboard-shortcut">
        <button class="theme-btn" style="pointer-events: none;">âŒ˜</button>
        <button class="theme-btn" style="pointer-events: none;">K</button>
      </div>
    </div>

    <div class="dropdown-item" id="themeToggleItem">
      <span>Theme</span>
      <div class="theme-options">
        <button class="theme-btn active" id="lightThemeBtn" data-theme="light">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="1.5"/>
            <path d="M12 1V3M12 21V23M23 12H21M3 12H1M20.485 20.485L19.071 19.071M4.929 4.929L3.515 3.515M20.485 3.515L19.071 4.929M4.929 19.071L3.515 20.485" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
        <button class="theme-btn" id="darkThemeBtn" data-theme="dark">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="dropdown-separator"></div>

    <div class="dropdown-item" id="homePageLink">
      <span>Home Page</span>
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>

    <div class="dropdown-separator"></div>

    <button class="upgrade-btn" id="logoutBtn">
      <span>Log Out</span>
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px;">
        <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9M16 17L21 12M21 12L16 7M21 12H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <!-- Notifications Dropdown -->
  <div class="notifications-dropdown" id="notificationsDropdown">
    <div class="notifications-tabs">
      <div class="notification-tab active" id="inboxTab">Inbox</div>
      <div class="notification-tab" id="updatesTab">Updates</div>
    </div>

    <div class="notifications-content">
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="empty-icon">
          <rect x="3" y="6" width="18" height="13" rx="2" stroke="currentColor" stroke-width="1.5"/>
          <path d="M3 9L12 14L21 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <p class="empty-text">No new notifications</p>
      </div>
    </div>
  </div>

  <!-- Feedback Dropdown -->
  <div class="feedback-dropdown" id="feedbackDropdown">
    <select class="feedback-select" id="feedbackSelect">
      <option value="">Select a topic...</option>
      <option value="bug">Bug Report</option>
      <option value="feature">Feature Request</option>
      <option value="other">Other</option>
    </select>

    <textarea class="feedback-textarea" id="feedbackTextarea" placeholder="Your feedback..."></textarea>

    <div class="feedback-actions">
      <div class="feedback-emojis">
        <button class="emoji-btn" data-emoji="ðŸ˜¢">ðŸ˜¢</button>
        <button class="emoji-btn" data-emoji="â˜¹ï¸">â˜¹ï¸</button>
        <button class="emoji-btn" data-emoji="ðŸ™‚">ðŸ™‚</button>
        <button class="emoji-btn" data-emoji="ðŸ˜„">ðŸ˜„</button>
      </div>
      <button class="feedback-send-btn" id="feedbackSendBtn">Send</button>
    </div>
  </div>

  <!-- Navigation Bar - Main (Desktop) -->
  <nav class="navbar-container" id="mainNavbar">
    <div class="hover-background"></div>
    <div class="active-indicator"></div>
    <a class="nav-link active" href="#" data-view="dashboard" id="tab-dashboard">Dashboard</a>
    <a class="nav-link" href="#" data-view="requests" id="tab-requests">Requests</a>
    <a class="nav-link" href="#" data-view="calendar" id="tab-calendar">Calendar</a>
    <a class="nav-link" href="#" data-view="waitlist" id="tab-waitlist">Waitlist</a>
    <a class="nav-link" href="#" data-view="artists" id="tab-artists">Artists</a>
    <a class="nav-link" href="#" data-view="customers" id="tab-customers">Customers</a>
    <a class="nav-link" href="#" data-view="dienstplan" id="tab-dienstplan">Dienstplan</a>
    <a class="nav-link" href="#" data-view="agreements" id="tab-agreements">Agreements</a>
    <a class="nav-link" href="#" data-view="analytics" id="tab-analytics">Analytics</a>
  </nav>

  <!-- Navigation Bar - Account Settings (Desktop only) -->
  <nav class="navbar-container" id="settingsNavbar" style="display: none;">
    <div class="hover-background"></div>
    <a class="nav-link" href="#" id="returnToDashboard">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px; margin-right: 6px; display: inline-block; vertical-align: middle;">
        <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Return to Dashboard
    </a>
    <a class="nav-link active" href="#" data-tab="activity">Activity</a>
    <a class="nav-link" href="#" data-tab="settings">Settings</a>
  </nav>

  <section id="dashboard-section" class="active">
    <!-- Welcome Banner (shown when logged in) -->
    <div id="dashboardWelcome" class="dashboard-welcome" style="display: none;">
      <div class="dashboard-welcome-text">
        <h1 id="dashboardWelcomeText">Willkommen</h1>
        <p>SchÃ¶n dich wiederzusehen!</p>
      </div>
    </div>

    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
      <h2 style="margin:0;">Dashboard</h2>
      <span id="versionBadge" style="background:rgba(0,113,227,0.1); color:var(--accent); padding:6px 12px; border-radius:8px; font-size:13px; font-weight:600; font-family:monospace;">v84</span>
    </div>
    <div>
      <span class="badge" id="badge-pending">Pending: â€”</span>
      <span class="badge" id="badge-scheduled">Scheduled: â€”</span>
      <span class="badge" id="badge-residents">Residents: â€”</span>
      <span class="badge" id="badge-guests">Guests: â€”</span>
      <span class="badge" id="badge-agreements-completed">Agreements: â€”</span>
      <span class="badge" id="badge-agreements-pending">Missing: â€”</span>
    </div>

    <!-- Dashboard Grid Layout -->
    <div class="dashboard-grid" style="margin-top: 32px;">
      <!-- Bottom Row: Pinned Events + Schwarzes Brett -->
      <div class="dashboard-bottom-row">
        <!-- Pinned Events Section -->
        <div class="container-section">
          <h3 class="container-section-title">Pinned Events</h3>
          <div class="dashboard-card pinned-events-card" id="pinnedEventsContainer">
            <div class="event-empty">Lade Events...</div>
          </div>
        </div>

        <!-- Schwarzes Brett Section -->
        <div class="container-section">
          <h3 class="container-section-title">Schwarzes Brett</h3>
          <div class="dashboard-card schwarzes-brett-card" id="schwarzesBrettContainer">
            <!-- New Message Popup -->
            <div class="new-message-popup" id="newMessagePopup">
              <div class="popup-header">
                <h4 class="popup-title">Neue Nachricht</h4>
                <button class="popup-close" id="closePopupBtn">âœ•</button>
              </div>
              <textarea class="popup-textarea" id="messageContent" placeholder="Deine Nachricht..."></textarea>
              <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <select id="messageCategory" style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); font-size: 14px; color: var(--text-primary); font-family: inherit;">
                  <option value="Info">Info</option>
                  <option value="Design">Design</option>
                  <option value="System">System</option>
                  <option value="Portfolio">Portfolio</option>
                  <option value="Guest Spot">Guest Spot</option>
                </select>
                <select id="messageLocation" style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); font-size: 14px; color: var(--text-primary); font-family: inherit;">
                  <option value="All Locations">All Locations</option>
                  <option value="Stuttgart">Stuttgart</option>
                  <option value="MÃ¼nchen">MÃ¼nchen</option>
                  <option value="KÃ¶ln">KÃ¶ln</option>
                  <option value="Berlin">Berlin</option>
                  <option value="Paris">Paris</option>
                </select>
              </div>
              <button id="submitMessageBtn" style="width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; font-family: inherit;">
                VerÃ¶ffentlichen
              </button>
            </div>

            <!-- Messages Container -->
            <div id="brettMessages">
              <div class="brett-empty">Lade Nachrichten...</div>
            </div>

            <!-- Add Button -->
            <button class="add-btn" id="addMessageBtn">+ Neue Nachricht</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="requests-section">
    <h2>Request Management</h2>

    <!-- Location Filter Buttons -->
    <div style="position:relative; background:white; border-radius:28px; padding:6px; margin-bottom:16px; display:inline-flex; gap:0; border:1px solid rgba(0,0,0,0.06);">
      <div id="requestsLocationIndicator" style="position:absolute; top:6px; left:6px; height:calc(100% - 12px); background:#f5f5f7; border-radius:22px; transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow:0 1px 3px rgba(0,0,0,0.08); z-index:1; pointer-events:none;"></div>
      <button class="request-location-tab active" data-location="all" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#1d1d1f; font-family:inherit; transition:color 0.2s; white-space:nowrap;">
        Alle Locations
      </button>
      <button class="request-location-tab" data-location="mommy" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">
        Mommy I'm Sorry
      </button>
      <button class="request-location-tab" data-location="gon" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">
        GON
      </button>
      <button class="request-location-tab" data-location="muttersohne" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">
        MuttersÃ¶hne
      </button>
      <button class="request-location-tab" data-location="pardon" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">
        Pardon Paris
      </button>
    </div>

    <!-- Sub Navigation -->
    <div style="position:relative; background:white; border-radius:28px; padding:6px; margin-bottom:24px; display:inline-flex; gap:0; border:1px solid rgba(0,0,0,0.06);">
      <div id="requestsIndicator" style="position:absolute; top:6px; left:6px; height:calc(100% - 12px); background:#f5f5f7; border-radius:22px; transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow:0 1px 3px rgba(0,0,0,0.08); z-index:1; pointer-events:none;"></div>
      <button class="request-tab active" data-status="open_request" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#1d1d1f; font-family:inherit; transition:color 0.2s; white-space:nowrap;">
        New Requests
        <span id="badge-new" style="display:inline-block; background:#dc3545; color:white; font-size:10px; font-weight:700; padding:2px 6px; border-radius:10px; margin-left:6px; min-width:18px; text-align:center;">0</span>
      </button>
      <button class="request-tab" data-status="my-requests" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">My Requests</button>
      <button class="request-tab" data-status="pending" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">In Progress</button>
      <button class="request-tab" data-status="scheduled" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Scheduled</button>
      <button class="request-tab" data-status="finished" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Finished</button>
      <button class="request-tab" data-status="canceled" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Canceled</button>
      <button class="request-tab" data-status="archived" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Archived</button>
    </div>

    <!-- Create Request Button (Only visible in New Requests tab) -->
    <div id="createRequestBtnContainer" style="display:flex; justify-content:flex-start; margin-bottom:16px;">
      <button id="createRequestBtn" class="btn-nav" style="background:#1d1d1f; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Create Request</span>
      </button>
    </div>

    <!-- Refresh Controls -->
    <div style="display:flex; align-items:center; justify-content:flex-end; gap:12px; margin-bottom:16px;">
      <label style="display:flex; align-items:center; gap:8px; font-size:14px; color:var(--ink); cursor:pointer;">
        <input type="checkbox" id="autoRefreshToggle" style="cursor:pointer;">
        <span>Auto-Refresh (30s)</span>
      </label>
      <button id="refreshRequestsBtn" style="display:flex; align-items:center; gap:8px; padding:10px 20px; background:rgba(0,113,227,0.1); color:var(--accent); border:1px solid rgba(0,113,227,0.2); border-radius:8px; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s; font-family:inherit;">
        <svg id="refreshIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transition:transform 0.5s;">
          <polyline points="23 4 23 10 17 10"></polyline>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        <span id="refreshBtnText">Neue Requests laden</span>
      </button>
    </div>

    <!-- Two Column Layout -->
    <div style="display:grid; grid-template-columns:350px 1fr; gap:24px; height:calc(100vh - 250px);">
      <!-- Request List -->
      <div id="requestsList" style="background:rgba(255,255,255,0.95); border-radius:12px; padding:16px; box-shadow:var(--shadow); overflow-y:auto; border:1px solid rgba(0,0,0,0.06);">
        <!-- Requests will be loaded here -->
      </div>
      
      <!-- Request Detail Panel -->
      <div id="requestDetail" style="background:rgba(255,255,255,0.95); border-radius:12px; padding:32px; box-shadow:var(--shadow); overflow-y:auto; border:1px solid rgba(0,0,0,0.06);">
        <div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--muted); font-size:16px;">
          Select a request to view details
        </div>
      </div>
    </div>
  </section>

  <section id="calendar-section">
    <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
      <h2 style="margin:0; font-size:28px; font-weight:700;">Booking Calendar</h2>
      <div id="currentDateDisplayTop" style="font-weight:700; font-size:28px; color:var(--ink);"></div>
    </div>
    
    <!-- Event Type Legend -->
    <div style="display:flex; gap:16px; margin-bottom:50px; padding:16px 20px; background:rgba(255,255,255,0.95); border-radius:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,0.06);">
      <span style="font-weight:500; font-size:13px; color:var(--muted);">Booking Types:</span>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#66BB6A;"></div>
        <span style="font-size:13px; color:var(--ink);">Consultation</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#EC407A;"></div>
        <span style="font-size:13px; color:var(--ink);">New Tattoo</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#42A5F5;"></div>
        <span style="font-size:13px; color:var(--ink);">Continuing Tattoo</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#FFEB3B;"></div>
        <span style="font-size:13px; color:var(--ink);">Touch Up</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#8D6E63;"></div>
        <span style="font-size:13px; color:var(--ink);">Selfbooking</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#AB47BC;"></div>
        <span style="font-size:13px; color:var(--ink);">WannaDo</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#EF5350;"></div>
        <span style="font-size:13px; color:var(--ink);">Internal</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#26C6DA;"></div>
        <span style="font-size:13px; color:var(--ink);">Move</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#78909C;"></div>
        <span style="font-size:13px; color:var(--ink);">Reserved</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#FFFFFF; border:1px solid #BDBDBD;"></div>
        <span style="font-size:13px; color:var(--ink);">No Show</span>
      </div>
    </div>
    
    <div class="calendar-controls">
      <div style="display:flex; align-items:center; gap:8px; margin-right:40px;">
        <label style="font-weight:600; font-size:14px;">Location:</label>
        <select id="locationDropdown" style="min-width:200px;"></select>
      </div>
      <button id="prevDayBtn" class="btn-nav">â€¹ Prev</button>
      <input type="date" id="datePickerInput">
      <button id="todayBtn" class="btn-nav">Today</button>
      <button id="nextDayBtn" class="btn-nav" style="margin-right:40px;">Next â€º</button>
      <div style="display:flex; gap:24px; align-items:center; margin-left:auto;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
          <span style="font-weight:700;">Events</span>
          <label class="toggle-switch">
            <input type="checkbox" id="checkEvents" checked>
            <span class="toggle-slider"></span>
          </label>
        </label>
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
          <span style="font-weight:700;">Residents</span>
          <label class="toggle-switch">
            <input type="checkbox" id="checkResidents" checked>
            <span class="toggle-slider"></span>
          </label>
        </label>
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
          <span style="font-weight:700;">Guests</span>
          <label class="toggle-switch">
            <input type="checkbox" id="checkGuests" checked>
            <span class="toggle-slider"></span>
          </label>
        </label>
      </div>
    </div>
    
    <!-- Create Buttons Row -->
    <div style="margin-bottom:16px; display:flex; gap:12px;">
      <button id="createEventBtn" class="btn-nav" style="background:#333; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Create Event</span>
      </button>
      <button id="createBookingBtn" class="btn-nav" style="background:#333; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Create Booking</span>
      </button>
    </div>
    
    <div id="locationInfo" style="margin-bottom:12px; padding:10px 16px; background:rgba(255,255,255,0.95); border-radius:10px; font-size:13px; color:var(--muted); box-shadow:0 1px 3px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);"></div>
    <div class="calendar-container" id="calendarContainer"></div>
  </section>

  <section id="dienstplan-section">
    <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
      <h2 style="margin:0; font-size:28px; font-weight:700;">Dienstplan</h2>
      <div id="dienstplanMonth" style="font-weight:700; font-size:28px; color:var(--ink);"></div>
    </div>
    
    <!-- Status Legend -->
    <div style="display:flex; gap:16px; margin-bottom:24px; padding:16px 20px; background:rgba(255,255,255,0.95); border-radius:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,0.06);">
      <span style="font-weight:500; font-size:13px; color:var(--muted);">Status:</span>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#2196F3;"></div>
        <span style="font-size:13px; color:var(--ink);">Home office</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#FF9800;"></div>
        <span style="font-size:13px; color:var(--ink);">Business trip</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#4CAF50;"></div>
        <span style="font-size:13px; color:var(--ink);">Vacation</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#9C27B0;"></div>
        <span style="font-size:13px; color:var(--ink);">Others</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#F44336;"></div>
        <span style="font-size:13px; color:var(--ink);">Sick</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#795548;"></div>
        <span style="font-size:13px; color:var(--ink);">Guestspot</span>
      </div>
    </div>
    
    <div class="calendar-controls" style="margin-bottom:24px;">
      <div style="display:flex; align-items:center; gap:8px; margin-right:40px;">
        <label style="font-weight:600; font-size:14px;">Location:</label>
        <select id="dienstplanLocationDropdown" style="min-width:200px;"></select>
      </div>
      <button id="prevMonthBtn" class="btn-nav">â€¹ Vorheriger Monat</button>
      <button id="currentMonthBtn" class="btn-nav">Aktueller Monat</button>
      <button id="nextMonthBtn" class="btn-nav">NÃ¤chster Monat â€º</button>
    </div>
    
    <div id="dienstplanContainer" style="width:100%; overflow-x:auto; overflow-y:visible;"></div>
  </section>

  <section id="artists-section">
    <h2>Artists</h2>

    <!-- Search Bar and Add Button Row -->
    <div style="display:flex; justify-content:space-between; align-items:center; gap:20px; margin-bottom:20px; flex-wrap:wrap;">
      <div style="position:relative; flex:1; min-width:300px; max-width:500px;">
        <svg style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:16px; height:16px; pointer-events:none;" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="artistSearchInput" placeholder="Search artists by name or Instagram..." style="width:100%; padding:12px 16px 12px 42px; font-size:15px; border:1px solid rgba(0,0,0,0.1); border-radius:999px;">
      </div>
      
      <button id="addArtistBtn" class="btn-nav" style="background:#1d1d1f; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Add Artist</span>
      </button>
    </div>

    <!-- Filter Row -->
    <div class="filter-section" style="background:rgba(255,255,255,0.95); border:1px solid rgba(0,0,0,0.06); border-radius:12px; padding:20px; margin-bottom:24px; box-shadow:var(--shadow);">
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr auto; gap:12px; align-items:center; margin-bottom:16px;">

        <!-- Location Filter -->
        <select id="artistLocationFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">ðŸ“ Alle Locations</option>
          <option value="NULL">âš ï¸ Ohne Location</option>
          <!-- Locations werden dynamisch geladen -->
        </select>

        <!-- Rank Filter -->
        <select id="artistRankFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">ðŸ† Alle Ranks</option>
          <option value="R1">R1</option>
          <option value="R2">R2</option>
          <option value="R3">R3</option>
          <option value="R4">R4</option>
          <option value="R5">R5</option>
        </select>

        <!-- Type Filter -->
        <select id="artistTypeFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">ðŸ‘¥ Alle Types</option>
          <option value="resident">Resident Artist</option>
          <option value="guest">Guest Artist</option>
        </select>

        <!-- Status Filter -->
        <select id="artistStatusFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">âœ… Alle Status</option>
          <option value="active">Aktiv</option>
          <option value="inactive">Inaktiv</option>
        </select>

        <!-- Clear Filters Button -->
        <button class="btn-secondary" onclick="clearArtistFilters()" style="padding:10px 20px; background:rgba(0,0,0,0.05); border:1px solid rgba(0,0,0,0.1); border-radius:8px; cursor:pointer; white-space:nowrap;">
          ðŸ”„ Filter zurÃ¼cksetzen
        </button>
      </div>

      <!-- Results Count -->
      <div style="font-size:14px; color:var(--muted);">
        <span id="artistsResultCount" style="font-weight:600; color:var(--ink);">0</span> Artists gefunden
      </div>
    </div>

    <table id="artistsTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Instagram</th>
          <th>Phone</th>
          <th>Type</th>
          <th>Location</th>
          <th>Rank</th>
          <th>Status</th>
          <th style="text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody id="artistsTableBody"></tbody>
    </table>
  </section>

  <section id="customers-section">
    <h2>Customers</h2>

    <!-- Search Bar and Add Button Row -->
    <div style="display:flex; justify-content:space-between; align-items:center; gap:20px; margin-bottom:20px; flex-wrap:wrap;">
      <div style="position:relative; flex:1; min-width:300px; max-width:500px;">
        <svg style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:16px; height:16px; pointer-events:none;" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input 
          type="text" 
          id="customerSearchInput" 
          placeholder="Search customers by name, email or phone..." 
          style="width:100%; padding:12px 16px 12px 42px; font-size:15px; border:1px solid rgba(0,0,0,0.1); border-radius:999px;">
      </div>
      
      <button id="addCustomerBtn" class="btn-nav" style="background:#1d1d1f; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Add Customer</span>
      </button>
    </div>

    <!-- Filter Row -->
    <div class="filter-section" style="background:rgba(255,255,255,0.95); border:1px solid rgba(0,0,0,0.06); border-radius:12px; padding:20px; margin-bottom:24px; box-shadow:var(--shadow);">
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:12px; align-items:center; margin-bottom:16px;">

        <!-- Rank Filter -->
        <select id="customerRankFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">ðŸ† Alle Ranks</option>
          <option value="Bronze">ðŸ¥‰ Bronze</option>
          <option value="Silver">ðŸ¥ˆ Silver</option>
          <option value="Gold">ðŸ¥‡ Gold</option>
          <option value="Platinum">ðŸ’Ž Platinum</option>
        </select>

        <!-- Blacklist Filter -->
        <select id="customerBlacklistFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">ðŸ‘¥ Alle Customers</option>
          <option value="false">âœ… Nicht Blacklisted</option>
          <option value="true">ðŸš« Blacklisted</option>
        </select>

        <!-- Total Bookings Filter -->
        <select id="customerBookingsFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">ðŸ“Š Alle Bookings</option>
          <option value="0">0 Bookings</option>
          <option value="1-2">1-2 Bookings</option>
          <option value="3-5">3-5 Bookings</option>
          <option value="6-10">6-10 Bookings</option>
          <option value="11+">11+ Bookings</option>
        </select>

        <!-- Clear Filters Button -->
        <button class="btn-secondary" onclick="clearCustomerFilters()" style="padding:10px 20px; background:rgba(0,0,0,0.05); border:1px solid rgba(0,0,0,0.1); border-radius:8px; cursor:pointer; white-space:nowrap;">
          ðŸ”„ Filter zurÃ¼cksetzen
        </button>
      </div>

      <!-- Results Count -->
      <div style="font-size:14px; color:var(--muted);">
        <span id="customersResultCount" style="font-weight:600; color:var(--ink);">0</span> Customers gefunden
      </div>
    </div>

    <table id="customersTable">
      <thead>
        <tr>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Instagram</th>
          <th>Rank</th>
          <th>Created</th>
          <th style="text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody id="customersTableBody"></tbody>
    </table>
  </section>

  <section id="analytics-section">
    <h2>Analytics</h2>

    <!-- Filters -->
    <div class="analytics-filters">
      <select id="analyticsLocationFilter" class="filter-select">
        <option value="">All Locations</option>
        <!-- Will be populated dynamically -->
      </select>

      <select id="analyticsDateRangeFilter" class="filter-select">
        <option value="all">Alle ZeitrÃ¤ume</option>
        <option value="today">Heute</option>
        <option value="week">Diese Woche</option>
        <option value="month" selected>Dieser Monat</option>
        <option value="quarter">Dieses Quartal</option>
        <option value="year">Dieses Jahr</option>
        <option value="last30">Letzte 30 Tage</option>
        <option value="last90">Letzte 90 Tage</option>
        <option value="last365">Letztes Jahr</option>
      </select>

      <div style="display: flex; gap: 8px; align-items: center;">
        <label style="font-size: 13px; color: var(--muted);">Von:</label>
        <input type="date" id="analyticsStartDate" class="filter-select" style="min-width: 150px;">
        <label style="font-size: 13px; color: var(--muted);">Bis:</label>
        <input type="date" id="analyticsEndDate" class="filter-select" style="min-width: 150px;">
      </div>
    </div>

    <!-- Chart Grid -->
    <div class="charts-grid">

      <!-- Wrapper 1: Booking Sources & Artist Distribution -->
      <div class="chart-card" style="grid-column: 1 / -1;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">

          <!-- Booking Sources -->
          <div>
            <h3>Booking Sources</h3>
            <div style="position: relative; width: 100%; height: 400px;">
              <canvas id="bookingOriginsPie" style="width: 100%; height: 400px;"></canvas>
            </div>
          </div>

          <!-- Appointments nach Resident Artist -->
          <div>
            <h3>Appointments nach Resident Artist</h3>
            <canvas id="artistDistributionChart"></canvas>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 20px;">
              <div style="background: rgba(255,255,255,0.3); padding: 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05);">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Total Appointments</div>
                <div style="font-size: 16px; font-weight: 600;" id="artistTotalRequests">0</div>
              </div>
              <div style="background: rgba(255,255,255,0.3); padding: 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05);">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Umgesetzte Termine</div>
                <div style="font-size: 16px; font-weight: 600;" id="artistCompletedAppointments">0 (0%)</div>
              </div>
              <div style="background: rgba(255,255,255,0.3); padding: 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05);">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Nicht umgesetzt</div>
                <div style="font-size: 16px; font-weight: 600;" id="artistNotCompleted">0 (0%)</div>
              </div>
              <div style="background: rgba(255,255,255,0.3); padding: 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05);">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Beliebig</div>
                <div style="font-size: 16px; font-weight: 600;" id="artistAny">0 (0%)</div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Wrapper 2: Bookings Over Time & Requests/Appointments Overview -->
      <div class="chart-card" style="grid-column: 1 / -1;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">

          <!-- Bookings Over Time -->
          <div>
            <h3>Bookings Over Time</h3>

            <div style="position: relative; width: 100%; height: 400px; margin-top: 16px;">
              <canvas id="bookingsTimeline" style="width: 600px; height: 400px;"></canvas>
            </div>
          </div>

          <!-- Requests & Appointments Overview -->
          <div>
            <h3>Requests & Appointments Overview</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; padding: 20px;">
              <!-- Total Requests -->
              <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; background: rgba(0, 113, 227, 0.05); border-radius: 12px;">
                <div style="font-size: 14px; color: var(--muted); margin-bottom: 8px;">Total Requests</div>
                <div style="font-size: 56px; font-weight: 700; color: var(--accent);" id="requestsCount">0</div>
                <div style="font-size: 14px; color: var(--muted); margin-top: 8px;">Customer Requests</div>
              </div>
              <!-- Total Appointments -->
              <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; background: rgba(52, 199, 89, 0.05); border-radius: 12px;">
                <div style="font-size: 14px; color: var(--muted); margin-bottom: 8px;">Total Appointments</div>
                <div style="font-size: 56px; font-weight: 700; color: var(--success);" id="appointmentsCount">0</div>
                <div style="font-size: 14px; color: var(--muted); margin-top: 8px;">Scheduled Appointments</div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- REQUEST & APPOINTMENT STATUS BREAKDOWN CHARTS -->
      <div class="chart-card" style="grid-column: 1 / -1;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- Request Status Chart -->
          <div id="requestStatusChart"></div>

          <!-- Appointment Status Chart -->
          <div id="appointmentStatusChart"></div>
        </div>
      </div>

      <!-- REVENUE OVERVIEW & TIMELINE (Horizontal Layout) -->
      <div class="chart-card" style="grid-column: 1 / -1;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">

          <!-- Revenue Overview -->
          <div>
            <h3>Umsatz-Ãœbersicht</h3>
            <div style="display: flex; flex-direction: column; gap: 24px; padding: 20px;">
              <!-- Total Revenue -->
              <div style="text-align: center;">
                <div style="font-size: 13px; color: var(--muted); margin-bottom: 8px;">Gesamtumsatz</div>
                <div style="font-size: 48px; font-weight: 700; color: var(--accent);" id="totalRevenue">â‚¬0</div>
              </div>

              <!-- Revenue Stats Grid -->
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                <div style="text-align: center; padding: 16px; background: rgba(0, 113, 227, 0.05); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Bezahlte Projekte</div>
                  <div style="font-size: 24px; font-weight: 600; color: #0071e3;" id="paidProjects">0</div>
                </div>
                <div style="text-align: center; padding: 16px; background: rgba(255, 149, 0, 0.05); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Ausstehend</div>
                  <div style="font-size: 24px; font-weight: 600; color: #ff9500;" id="pendingRevenue">â‚¬0</div>
                </div>
                <div style="text-align: center; padding: 16px; background: rgba(52, 199, 89, 0.05); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Durchschnitt</div>
                  <div style="font-size: 24px; font-weight: 600; color: #34c759;" id="avgProjectPrice">â‚¬0</div>
                </div>
                <div style="text-align: center; padding: 16px; background: rgba(142, 142, 147, 0.05); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Projekte</div>
                  <div style="font-size: 24px; font-weight: 600; color: #8e8e93;" id="totalProjects">0</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Revenue Timeline -->
          <div>
            <h3>Umsatz im Zeitverlauf</h3>
            <div style="position: relative; height: 400px;">
              <canvas id="revenueTimeline"></canvas>
            </div>
          </div>

        </div>
      </div>

      <!-- Revenue by Payment Status Chart (New Format) -->
      <div class="chart-card">
        <div id="revenueByPaymentStatusChart">
          <!-- Will be populated dynamically by loadRevenueByPaymentStatus() -->
        </div>
      </div>

      <!-- Revenue by Payment Status Card (Full Width) -->
      <div class="chart-card" style="grid-column: 1 / -1; width: 100%;">
        <h3>Umsatz nach Zahlungsstatus</h3>

        <!-- Revenue Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
          <div style="background: rgba(52, 199, 89, 0.05); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(52, 199, 89, 0.2);">
            <div style="font-size: 28px; margin-bottom: 8px;">ðŸ’°</div>
            <div style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 8px;">Komplett Bezahlt</div>
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 4px;" id="paidAmount">0,00 â‚¬</div>
            <div style="font-size: 13px; color: var(--muted);" id="paidCount">0 Projekte</div>
          </div>
          <div style="background: rgba(255, 149, 0, 0.05); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(255, 149, 0, 0.2);">
            <div style="font-size: 28px; margin-bottom: 8px;">â³</div>
            <div style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 8px;">Offen</div>
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 4px;" id="pendingAmount">0,00 â‚¬</div>
            <div style="font-size: 13px; color: var(--muted);" id="pendingCount">0 Projekte</div>
          </div>
          <div style="background: rgba(0, 113, 227, 0.05); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(0, 113, 227, 0.2);">
            <div style="font-size: 28px; margin-bottom: 8px;">ðŸ’³</div>
            <div style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 8px;">Anzahlung Bezahlt</div>
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 4px;" id="partialAmount">0,00 â‚¬</div>
            <div style="font-size: 13px; color: var(--muted);" id="partialCount">0 Projekte</div>
          </div>
        </div>

        <!-- Revenue Bar Chart -->
        <div style="position: relative; height: 500px; margin-bottom: 24px;">
          <canvas id="revenueByStatusChart"></canvas>
        </div>

        <!-- Revenue Details Table -->
        <table class="data-table">
          <thead>
            <tr>
              <th>Payment Status</th>
              <th style="text-align: right;">Anzahl Projekte</th>
              <th style="text-align: right;">Gesamt Umsatz</th>
              <th style="text-align: right;">Durchschnitt</th>
              <th style="text-align: right;">% vom Gesamt</th>
            </tr>
          </thead>
          <tbody id="revenueByStatusTable"></tbody>
          <tfoot>
            <tr style="border-top: 2px solid rgba(0,0,0,0.1); background: rgba(0,0,0,0.02);">
              <td><strong>Gesamt</strong></td>
              <td style="text-align: right;"><strong id="revenueTotalProjects">0</strong></td>
              <td style="text-align: right;"><strong id="revenueTotalAmount">0,00 â‚¬</strong></td>
              <td style="text-align: right;"><strong id="revenueAvgAmount">0,00 â‚¬</strong></td>
              <td style="text-align: right;"><strong>100%</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>

    </div>

    <!-- PROJECT-BASED ANALYTICS -->
    <div class="dashboard-section" style="margin-top: 48px;">
      <h2>ðŸ“ˆ Project Analytics</h2>

      <!-- Project KPI Summary -->
      <div id="analyticsProjectKPIs" class="kpi-grid" style="margin-bottom: 32px;"></div>

      <!-- Project Charts -->
      <div class="charts-grid">
        <div class="chart-card">
          <canvas id="projectsTimelineChart"></canvas>
        </div>
        <div class="chart-card">
          <canvas id="revenueByMonthChart"></canvas>
        </div>
        <div class="chart-card">
          <canvas id="topArtistsChart"></canvas>
        </div>
      </div>
    </div>

    <!-- ARTIST PERFORMANCE REPORT -->
    <div class="dashboard-section" style="margin-top: 32px;">
      <h2>ðŸŽ¨ Artist Performance</h2>
      <div id="artistPerformanceTable"></div>
    </div>

    <!-- MULTI-PROJECT CUSTOMERS (VIP) -->
    <div class="dashboard-section" style="margin-top: 32px;">
      <h2>ðŸ‘¥ VIP Customers (Multi-Project Customers)</h2>
      <div id="multiProjectCustomersTable"></div>
    </div>

  </section>

  <!-- ============================================ -->
  <!-- WAITLIST SECTION -->
  <!-- ============================================ -->
  <section id="waitlist-section">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px;">
      <div>
        <h2 style="margin:0 0 8px 0;">Guest Artist Waitlist</h2>
        <p style="color:var(--muted); font-size:14px; margin:0;">
          Manage upcoming guest artist slots
        </p>
      </div>

      <button id="addWaitlistSlotButton" class="btn-nav" style="background:#1d1d1f; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Add Slot</span>
      </button>
    </div>

    <!-- Location Filter (optional, if using location-specific slots) -->
    <div style="margin-bottom:24px;">
      <div style="position:relative; background:#e8e8ed; border-radius:28px; padding:6px; display:inline-flex; gap:0;">
        <div id="waitlistLocationIndicator" style="position:absolute; top:6px; left:6px; height:calc(100% - 12px); background:white; border-radius:22px; transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow:0 3px 8px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08); z-index:1; pointer-events:none;"></div>

        <button class="waitlist-location-tab active" data-location="all" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; color:#1d1d1f; font-weight:600; font-size:14px; cursor:pointer; border-radius:22px; transition:color 0.2s;">
          All Locations
        </button>

        <!-- Add location buttons dynamically -->
        <div id="waitlistLocationButtons" style="position:relative; z-index:2; display:flex; gap:0;"></div>
      </div>
    </div>

    <!-- Active Slots Display -->
    <div id="waitlistSlotsContainer">
      <!-- Slots will be rendered here -->
    </div>

    <!-- Empty State -->
    <div id="waitlistEmptyState" style="display:none; text-align:center; padding:80px 20px; color:var(--muted);">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 16px; opacity:0.3;">
        <path d="M9 11l3 3L22 4"></path>
        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
      </svg>
      <h3 style="margin:0 0 8px 0; color:#1d1d1f;">No Guest Artists Scheduled</h3>
      <p style="margin:0 0 24px 0;">Click "Add Slot" to schedule a guest artist</p>
    </div>
  </section>

  <section id="agreements-section">
    <h2>Agreements</h2>
    <div style="margin-bottom:24px;">
      <p style="color:var(--muted); font-size:14px;">Manage your agreements and contracts</p>
    </div>

    <!-- Agreements List Section -->
    <div style="margin-top:48px;">
      <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
        <h2 style="margin:0; font-size:22px; font-weight:600;">Today's Agreements</h2>
        <div id="agreementsDateDisplay" style="font-weight:600; font-size:22px; color:var(--ink);"></div>
      </div>
      
      <div class="calendar-controls" style="margin-bottom:24px;">
        <button id="agreementsPrevDayBtn" class="btn-nav">â€¹ Prev</button>
        <input type="date" id="agreementsDatePickerInput">
        <button id="agreementsTodayBtn" class="btn-nav">Today</button>
        <button id="agreementsNextDayBtn" class="btn-nav">Next â€º</button>
      </div>
      
      <table id="agreementsTable">
        <thead>
          <tr>
            <th>Customer Name</th>
            <th>Email</th>
            <th>Artist</th>
            <th>Time</th>
            <th style="text-align:center;">Signed</th>
          </tr>
        </thead>
        <tbody id="agreementsTableBody"></tbody>
      </table>
    </div>
  </section>

  <section id="profile-section">
    <div style="max-width: 800px; margin: 0 auto;">
      <h2 style="margin-bottom: 32px;">Profil</h2>

      <!-- Profile Header -->
      <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 48px; padding: 32px; background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <img id="profilePageAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23ddd'/%3E%3Ctext x='50' y='65' text-anchor='middle' font-size='40' fill='%23666'%3EðŸ‘¤%3C/text%3E%3C/svg%3E" alt="Profilbild" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #f5f5f7; margin-bottom: 20px;">
        <h2 id="profilePageName" style="margin: 0 0 8px 0; font-size: 28px; font-weight: 600;">Username</h2>
        <span id="profilePageRoleBadge" class="profile-role-badge" style="font-size: 13px; padding: 6px 16px; border-radius: 999px; background: #f5f5f7; color: var(--ink); font-weight: 600;">USER</span>
      </div>

      <!-- Profile Information Cards -->
      <div style="display: grid; gap: 24px;">

        <!-- Account Info Card -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;">Account Information</h3>

          <div style="display: grid; gap: 16px;">
            <div>
              <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Benutzername</label>
              <div id="profilePageUsername" style="font-size: 15px; font-weight: 500;">â€”</div>
            </div>

            <div>
              <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Rolle</label>
              <div id="profilePageRoleText" style="font-size: 15px; font-weight: 500;">â€”</div>
            </div>

            <div>
              <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Passwort</label>
              <div style="display: flex; gap: 12px; align-items: center;">
                <span id="profilePagePassword">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                <button type="button" class="btn btn-secondary" onclick="showPasswordChangeFormPage()" style="font-size: 13px; padding: 6px 12px;">Ã„ndern</button>
              </div>
            </div>
          </div>

          <!-- Password Change Form (Hidden by default) -->
          <div id="profilePagePasswordChangeForm" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid #eee;">
            <h4 style="margin: 0 0 16px 0; font-size: 16px;">Passwort Ã¤ndern</h4>
            <div style="display: grid; gap: 12px;">
              <div>
                <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Neues Passwort</label>
                <input type="password" id="profilePageNewPassword" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
              </div>
              <div>
                <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Passwort bestÃ¤tigen</label>
                <input type="password" id="profilePageConfirmPassword" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
              </div>
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button type="button" class="btn btn-secondary" onclick="hidePasswordChangeFormPage()" style="flex: 1;">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="changePasswordPage()" style="flex: 1;">Speichern</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Avatar Card -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;">Profilbild</h3>

          <!-- Current Avatar Preview -->
          <div id="profilePageCurrentAvatarPreview" style="text-align: center; margin-bottom: 24px;">
            <img id="profilePageCurrentAvatarImg" src="" alt="Aktuelles Profilbild" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #f5f5f7;">
          </div>

          <!-- Drag & Drop Zone -->
          <div
            id="profilePageAvatarDropZone"
            style="border: 2px dashed #d1d5db; border-radius: 12px; padding: 40px 20px; text-align: center; background: #f9fafb; cursor: pointer; transition: all 0.3s; margin-bottom: 20px;"
            ondragover="handleProfileDragOver(event)"
            ondragleave="handleProfileDragLeave(event)"
            ondrop="handleProfileDrop(event)"
            onclick="document.getElementById('profilePageAvatarFileInput').click()">
            <div style="font-size: 48px; margin-bottom: 12px;">ðŸ“¸</div>
            <div style="font-size: 16px; font-weight: 500; color: var(--ink); margin-bottom: 8px;">
              Bild hier ablegen oder klicken
            </div>
            <div style="font-size: 13px; color: var(--muted);">
              PNG, JPG oder GIF (max. 5MB)
            </div>
          </div>

          <!-- Hidden File Input -->
          <input
            type="file"
            id="profilePageAvatarFileInput"
            accept="image/*"
            style="display: none;"
            onchange="handleProfileFileSelect(event)">

          <!-- Preview Selected Image -->
          <div id="profilePageAvatarPreviewContainer" style="display: none; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 14px; font-weight: 500; color: var(--ink); margin-bottom: 12px;">Vorschau:</div>
            <img id="profilePageAvatarPreview" src="" alt="Vorschau" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent);">
            <div id="profilePageAvatarFileName" style="font-size: 13px; color: var(--muted); margin-top: 8px;"></div>
          </div>

          <!-- Upload Progress -->
          <div id="profilePageUploadProgress" style="display: none; margin-bottom: 20px;">
            <div style="font-size: 13px; color: var(--muted); margin-bottom: 8px;">Uploading...</div>
            <div style="background: #e5e7eb; border-radius: 999px; height: 8px; overflow: hidden;">
              <div id="profilePageUploadProgressBar" style="background: var(--accent); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
          </div>

          <button type="button" class="btn btn-primary" id="profilePageUploadAvatarBtn" onclick="uploadAvatarFromProfilePage()" disabled style="width: 100%; opacity: 0.5;">Hochladen</button>
        </div>

        <!-- Logout Button -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
          <button type="button" class="btn btn-danger" onclick="logout()" style="width: 100%;">Abmelden</button>
        </div>

      </div>
    </div>
  </section>

  <!-- Account Settings View -->
  <section id="accountSettings-section" style="display: none; padding: 0; margin-top: 110px;">
    <div class="settings-view">
      <!-- Account Settings Top Section -->
      <div class="account-settings-header">
        <h1 class="account-settings-title" id="mainTitle">Account Activity</h1>
      </div>

      <!-- Settings Content Wrapper (Sidebar + Content) -->
      <div class="settings-content-wrapper">
        <!-- Settings Sidebar -->
        <div class="settings-sidebar">
          <div class="search-container">
            <input type="text" class="search-input" placeholder="Search...">
          </div>

          <ul class="sidebar-nav">
            <li class="nav-item active" data-section="activity">Activity</li>
            <li class="nav-item" data-section="avatar">Avatar</li>
            <li class="nav-item" data-section="user-info">User Information</li>
            <li class="nav-item" data-section="notifications">Notifications</li>
            <li class="nav-item" data-section="statistics">Statistics</li>
          </ul>
        </div>

        <!-- Settings Content -->
        <div class="settings-content">
          <!-- Settings Main Content -->
          <div class="settings-main-content">
            <!-- Activity Tab Content -->
            <div class="tab-content active" id="activityTab">
              <div class="activity-list">
                <div class="activity-item">
                  <div class="activity-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="activity-details">
                    <div class="activity-title">Logged in from Stuttgart, Germany</div>
                    <div class="activity-description">You successfully signed in to your account from a new device.</div>
                    <div class="activity-time">2 hours ago</div>
                  </div>
                </div>

                <div class="activity-item">
                  <div class="activity-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 16V12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 8H12.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="activity-details">
                    <div class="activity-title">Profile updated</div>
                    <div class="activity-description">You changed your notification preferences.</div>
                    <div class="activity-time">1 day ago</div>
                  </div>
                </div>

                <div class="activity-item">
                  <div class="activity-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="activity-details">
                    <div class="activity-title">Password changed</div>
                    <div class="activity-description">You successfully updated your account password.</div>
                    <div class="activity-time">3 days ago</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Settings Tab Content -->
            <div class="tab-content" id="settingsTab">
              <!-- Avatar Card -->
              <div class="settings-card">
                <div class="card-section">
                  <h3 class="section-title">Avatar</h3>
                  <p class="section-description">
                    This is your avatar.<br>
                    Click on the avatar to upload a custom one from your files.
                  </p>

                  <div class="avatar-container">
                    <div class="avatar-display" id="avatarDisplay" onclick="document.getElementById('avatarUpload').click()">
                      <!-- Gradient background by default -->
                    </div>

                    <div class="avatar-actions">
                      <button class="btn btn-primary" onclick="document.getElementById('avatarUpload').click()">
                        Upload
                      </button>
                      <button class="btn btn-danger" id="deleteAvatarBtn">
                        Delete
                      </button>
                    </div>
                  </div>

                  <input type="file" id="avatarUpload" accept="image/*">

                  <p class="section-description" style="margin-top: 16px; margin-bottom: 0;">
                    An avatar is optional but strongly recommended.
                  </p>
                </div>
              </div>

              <!-- User Information Card -->
              <div class="settings-card">
                <div class="card-section">
                  <h3 class="section-title">User Information</h3>
                  <p class="section-description">
                    Your username and role are managed by your administrator.
                  </p>

                  <div class="info-grid">
                    <div class="info-field">
                      <label class="field-label">Username</label>
                      <div class="field-value" id="usernameDisplay">david.mueller</div>
                    </div>

                    <div class="info-field">
                      <label class="field-label">Role</label>
                      <div class="field-value" id="roleDisplay">Management</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Notifications Card -->
              <div class="settings-card">
                <div class="card-section">
                  <h3 class="section-title">Notifications</h3>
                  <p class="section-description">
                    Manage how you receive notifications about your account.
                  </p>

                  <div class="input-group">
                    <label class="input-label" for="phoneInput">Phone Number</label>
                    <input
                      type="tel"
                      id="phoneInput"
                      class="input-field"
                      placeholder="+49 123 456789"
                      value=""
                    >
                    <p class="input-helper">We'll use this to send you SMS notifications.</p>
                  </div>

                  <div class="input-group">
                    <label class="input-label" for="emailInput">Email Address</label>
                    <input
                      type="email"
                      id="emailInput"
                      class="input-field"
                      placeholder="your.email@example.com"
                      value=""
                    >
                    <p class="input-helper">Primary email for account notifications.</p>
                  </div>

                  <div class="save-container">
                    <button class="btn btn-primary" id="saveNotificationsBtn">
                      Save Changes
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Add Artist Modal -->
  <div class="modal-backdrop" id="addArtistModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3>Add New Artist</h3>
      <form class="modal-form" id="addArtistForm">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="addArtistName" required placeholder="Artist name">
        </div>
        <div class="form-group">
          <label>Instagram Handle</label>
          <input type="text" id="addArtistInstagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="addArtistType">
            <option value="resident">Resident</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        <div class="form-group">
          <label>Location</label>
          <select id="addArtistLocation" required>
            <option value="">-- Select Location --</option>
          </select>
        </div>
        <div class="form-group">
          <label>City Location</label>
          <select id="addArtistCityLocation" required>
            <option value="">-- Select Location --</option>
            <option value="Stuttgart">Stuttgart</option>
            <option value="KÃ¶ln">KÃ¶ln</option>
            <option value="MÃ¼nchen">MÃ¼nchen</option>
            <option value="Berlin">Berlin</option>
          </select>
        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="addArtistRank" required>
            <option value="">-- Select Rank --</option>
            <option value="R1">R1</option>
            <option value="R2">R2</option>
            <option value="R3">R3</option>
            <option value="R4">R4</option>
            <option value="R5">R5</option>
          </select>
        </div>
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="addArtistActive" checked>
            Active
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelAddArtist">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Artist</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Artist Modal -->
  <div class="modal-backdrop" id="editArtistModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3>Edit Artist</h3>
      <form class="modal-form" id="editArtistForm">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="editArtistName" required>
        </div>
        <div class="form-group">
          <label>Instagram Handle</label>
          <input type="text" id="editArtistInstagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="editArtistType">
            <option value="resident">Resident</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        <div class="form-group">
          <label>Location</label>
          <select id="editArtistLocation">
            <option value="">-- Select Location --</option>
            <option value="Stuttgart">Stuttgart</option>
            <option value="KÃ¶ln">KÃ¶ln</option>
            <option value="Berlin">Berlin</option>
            <option value="MÃ¼nchen">MÃ¼nchen</option>
          </select>
        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="editArtistRank">
            <option value="">-- No Rank --</option>
            <option value="R1">R1</option>
            <option value="R2">R2</option>
            <option value="R3">R3</option>
            <option value="R4">R4</option>
            <option value="R5">R5</option>
          </select>
        </div>
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="editArtistActive" style="width:auto; padding:0;">
            Active
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelEditArtist">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Artist Profile Modal -->
  <div class="modal-backdrop" id="viewArtistProfileModal">
    <div class="modal" style="max-width:700px; max-height:90vh; overflow-y:auto;">
      <h3 style="color:var(--macos-text-primary); font-weight:500; margin-bottom:24px;">Artist Profile</h3>
      <div id="viewArtistProfileContent" style="padding:0;">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div class="modal-actions" style="display:flex; justify-content:space-between; margin-top:24px; gap:8px;">
        <button type="button" class="btn btn-danger" id="deleteArtistFromProfileBtn" style="margin-right:auto;">Delete</button>
        <div style="display:flex; gap:8px;">
          <button type="button" class="btn btn-secondary" onclick="closeViewProfile()">Close</button>
          <button type="button" class="btn btn-primary" id="editArtistFromProfileBtn">Edit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assign Team Member Modal -->
  <div class="modal-backdrop" id="assignModal">
    <div class="modal">
      <h3 style="color:var(--ink); font-weight:500;">Assign to Team Member</h3>
      <form class="modal-form" id="assignForm">
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Team Member</label>
          <select id="assignTeamMember" required>
            <option value="">-- Select Team Member --</option>
            <option value="member1">Name 1</option>
            <option value="member2">Name 2</option>
            <option value="member3">Name 3</option>
          </select>
        </div>
        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelAssign" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Assign</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Schedule Appointment Modal -->
  <div class="modal-backdrop" id="scheduleModal">
    <div class="modal">
      <h3 style="color:var(--ink); font-weight:500;">Schedule Appointment</h3>
      <form class="modal-form" id="scheduleForm">
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Artist</label>
          <select id="scheduleArtist" required>
            <option value="">-- Select Artist --</option>
          </select>
        </div>
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Date</label>
          <input type="date" id="scheduleDate" required>
        </div>
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Start Time</label>
          <select id="scheduleStartTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">End Time</label>
          <select id="scheduleEndTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelSchedule" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Request Modal -->
  <div class="modal-backdrop" id="editRequestModal">
    <div class="modal" style="max-width:700px; max-height:90vh; overflow-y:auto;">
      <h3 style="color:var(--ink); font-weight:500;">Edit Request</h3>
      <form class="modal-form" id="editRequestForm" style="max-height:calc(90vh - 150px); overflow-y:auto;">

        <!-- Customer Information -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Customer Information</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Vorname</label>
            <input type="text" id="editFirstName" required>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Nachname</label>
            <input type="text" id="editLastName" required>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Email</label>
            <input type="email" id="editEmail" required>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Phone</label>
            <input type="tel" id="editPhone" required>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Instagram</label>
            <input type="text" id="editInstagram" placeholder="@username">
          </div>
        </div>

        <!-- Request Details -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Request Details</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Priority</label>
            <select id="editPriority">
              <option value="">-- Select Priority --</option>
              <option value="low">Low ðŸ’¤</option>
              <option value="normal">Normal âœ“</option>
              <option value="high">High âš¡</option>
              <option value="urgent">Urgent ðŸ”¥</option>
            </select>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Placement</label>
            <input type="text" id="editPlacement">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Size</label>
            <input type="text" id="editSize">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Style</label>
            <input type="text" id="editStyle">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Colorway</label>
            <input type="text" id="editColorway">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Description</label>
            <textarea id="editDescription" rows="4"></textarea>
          </div>
        </div>

        <!-- Artist Assignment -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Artist Assignment</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Search Artist</label>
            <input type="text" id="editArtistSearch" placeholder="Type to search artists...">
            <div id="editArtistSearchResults" style="display:none; max-height:200px; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); border-radius:8px; margin-top:8px; background:white;"></div>
            <input type="hidden" id="editArtistId">
            <div id="editSelectedArtist" style="margin-top:8px; font-size:13px; color:var(--muted);"></div>
          </div>
        </div>

        <!-- Appointment Details -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Appointment Details</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Date</label>
            <input type="date" id="editScheduledDate">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Start Time</label>
            <input type="time" id="editStartTime">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">End Time</label>
            <input type="time" id="editEndTime">
          </div>
        </div>

        <!-- Status Management -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Status Management</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Status</label>
            <select id="editStatus">
              <option value="open_request">New Request</option>
              <option value="pending">Pending</option>
              <option value="scheduled">Scheduled</option>
              <option value="finished">Finished</option>
              <option value="canceled">Canceled</option>
            </select>
          </div>
        </div>

        <!-- Quick Actions -->
        <div style="margin-bottom:24px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.1);">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Quick Actions</h4>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn" onclick="resetRequestToOpen()" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">
              ðŸ”„ Reset to Open
            </button>
            <button type="button" class="btn" onclick="deleteRequestPermanently()" style="background:#dc3545; color:white; border:none;">
              ðŸ—‘ï¸ Delete Permanently
            </button>
          </div>
        </div>

        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelEditRequest" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Request Modal -->
  <div class="modal-backdrop" id="createRequestModal">
    <div class="modal" style="max-width:700px; max-height:90vh; overflow-y:auto;">
      <h3 style="color:var(--ink); font-weight:500;">Create New Request</h3>
      <form class="modal-form" id="createRequestForm" style="max-height:calc(90vh - 150px); overflow-y:auto;">

        <!-- Customer Information -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Customer Information</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Vorname</label>
            <input type="text" id="createFirstName" required>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Nachname</label>
            <input type="text" id="createLastName" required>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Email</label>
            <input type="email" id="createEmail" required>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Phone</label>
            <input type="tel" id="createPhone" required>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Instagram</label>
            <input type="text" id="createInstagram" placeholder="@username">
          </div>
        </div>

        <!-- Request Details -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Request Details</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Booking Source</label>
            <select id="createOrigin" required>
              <option value="">-- Select Booking Source --</option>
              <option value="Booking form">Booking form</option>
              <option value="Whatsapp">Whatsapp</option>
              <option value="Instagram">Instagram</option>
              <option value="Facebook">Facebook</option>
              <option value="Phone">Phone</option>
              <option value="E-mail">E-mail</option>
              <option value="Walk-in">Walk-in</option>
              <option value="Self-Booking">Self-Booking</option>
            </select>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Priority</label>
            <select id="createPriority">
              <option value="">-- Select Priority --</option>
              <option value="low">Low ðŸ’¤</option>
              <option value="normal" selected>Normal âœ“</option>
              <option value="high">High âš¡</option>
              <option value="urgent">Urgent ðŸ”¥</option>
            </select>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Placement</label>
            <input type="text" id="createPlacement" placeholder="e.g., Arm, Leg, Back">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Size</label>
            <input type="text" id="createSize" placeholder="e.g., 10x10 cm">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Style</label>
            <input type="text" id="createStyle" placeholder="e.g., Traditional, Realism">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Colorway</label>
            <input type="text" id="createColorway" placeholder="e.g., Black & Grey, Full Color">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Description</label>
            <textarea id="createDescription" rows="4" placeholder="Describe the tattoo idea..."></textarea>
          </div>
        </div>

        <!-- Location Selection -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Location</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Select Location</label>
            <select id="createLocation" required>
              <option value="">-- Select Location --</option>
              <!-- Locations will be loaded dynamically -->
            </select>
          </div>
        </div>

        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelCreateRequest" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Create Request</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Appointment Modal -->
  <div class="modal-backdrop" id="editAppointmentModal">
    <div class="modal">
      <h3 style="color:var(--ink); font-weight:500;">Edit Appointment</h3>
      <form class="modal-form" id="editAppointmentForm">
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Artist</label>
          <select id="editAppointmentArtist" required>
            <option value="">-- Select Artist --</option>
          </select>
        </div>
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Date</label>
          <input type="date" id="editAppointmentDate" required>
        </div>
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Start Time</label>
          <select id="editAppointmentStartTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">End Time</label>
          <select id="editAppointmentEndTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelEditAppointment" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cancel Appointment Modal -->
  <div class="modal-backdrop" id="cancelModal">
    <div class="modal">
      <h3 style="color:var(--ink); font-weight:500;">Cancel Appointment</h3>
      <p style="margin-bottom:20px; color:var(--muted); font-size:14px;">Are you sure you want to cancel this appointment?</p>
      <form class="modal-form" id="cancelForm">
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Cancellation Reason</label>
          <textarea id="cancelReason" placeholder="Please provide a reason for cancellation..." required style="border-radius:10px;"></textarea>
        </div>
        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelCancelModal" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">No, Keep it</button>
          <button type="submit" class="btn" style="background:#dc3545; color:white; border:none;">Yes, Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal-backdrop" id="addCustomerModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3>Add New Customer</h3>
      <form class="modal-form" id="addCustomerForm">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="addCustomerFirstName" required>
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="addCustomerLastName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="addCustomerEmail" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="addCustomerPhone">
        </div>
        <div class="form-group">
          <label>Instagram</label>
          <input type="text" id="addCustomerInstagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="addCustomerRank">
            <option value="">-- No Rank --</option>
            <option value="Bronze">Bronze</option>
            <option value="Silver">Silver</option>
            <option value="Gold">Gold</option>
            <option value="Platinum">Platinum</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelAddCustomer">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Customer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Customer Modal -->
  <div class="modal-backdrop" id="editCustomerModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3>Edit Customer</h3>
      <form class="modal-form" id="editCustomerForm">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="editCustomerFirstName" required>
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="editCustomerLastName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="editCustomerEmail" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="editCustomerPhone">
        </div>
        <div class="form-group">
          <label>Instagram</label>
          <input type="text" id="editCustomerInstagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="editCustomerRank">
            <option value="">-- No Rank --</option>
            <option value="Bronze">Bronze</option>
            <option value="Silver">Silver</option>
            <option value="Gold">Gold</option>
            <option value="Platinum">Platinum</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelEditCustomer">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Customer Profile Modal -->
  <div class="modal-backdrop" id="customerProfileModal">
    <div class="modal" style="max-width:900px; max-height:90vh; overflow-y:auto;">
      <div class="profile-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(0,0,0,0.1);">
        <div>
          <h3 id="customerProfileName" style="margin:0 0 8px 0; color:var(--macos-text-primary); font-weight:600; font-size:24px;">Customer Profile</h3>
          <div id="customerProfileRankBadge"></div>
        </div>
        <button type="button" class="btn btn-secondary" onclick="closeCustomerProfile()" style="padding:8px 16px;">Close</button>
      </div>

      <!-- Customer Details Section (Editable) -->
      <div class="profile-section" style="margin-bottom:32px;">
        <h4 style="font-size:17px; font-weight:600; color:var(--macos-text-primary); margin-bottom:16px;">Customer Details</h4>
        <form id="customerDetailsForm" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:16px; padding:20px; background:rgba(255,255,255,0.7); backdrop-filter:saturate(180%) blur(20px); border-radius:12px; border:1px solid rgba(0,0,0,0.1);">
          <div class="form-group" style="margin:0;">
            <label style="font-size:13px; color:var(--macos-text-secondary); display:block; margin-bottom:6px;">First Name</label>
            <input type="text" id="profileCustomerFirstName" required style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.2); border-radius:8px; font-size:14px;">
          </div>
          <div class="form-group" style="margin:0;">
            <label style="font-size:13px; color:var(--macos-text-secondary); display:block; margin-bottom:6px;">Last Name</label>
            <input type="text" id="profileCustomerLastName" required style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.2); border-radius:8px; font-size:14px;">
          </div>
          <div class="form-group" style="margin:0;">
            <label style="font-size:13px; color:var(--macos-text-secondary); display:block; margin-bottom:6px;">Email</label>
            <input type="email" id="profileCustomerEmail" required style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.2); border-radius:8px; font-size:14px;">
          </div>
          <div class="form-group" style="margin:0;">
            <label style="font-size:13px; color:var(--macos-text-secondary); display:block; margin-bottom:6px;">Phone</label>
            <input type="tel" id="profileCustomerPhone" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.2); border-radius:8px; font-size:14px;">
          </div>
          <div class="form-group" style="margin:0;">
            <label style="font-size:13px; color:var(--macos-text-secondary); display:block; margin-bottom:6px;">Instagram</label>
            <input type="text" id="profileCustomerInstagram" placeholder="@username" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.2); border-radius:8px; font-size:14px;">
          </div>
          <div class="form-group" style="margin:0;">
            <label style="font-size:13px; color:var(--macos-text-secondary); display:block; margin-bottom:6px;">Rank</label>
            <select id="profileCustomerRank" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.2); border-radius:8px; font-size:14px;">
              <option value="">-- No Rank --</option>
              <option value="Bronze">Bronze</option>
              <option value="Silver">Silver</option>
              <option value="Gold">Gold</option>
              <option value="Platinum">Platinum</option>
            </select>
          </div>
          <div style="grid-column:1/-1; display:flex; gap:12px; margin-top:8px;">
            <button type="button" class="btn btn-primary" onclick="saveCustomerDetails()" style="padding:8px 16px;">Save Changes</button>
            <button type="button" class="btn btn-danger" onclick="deleteCustomerFromProfile()" style="padding:8px 16px;">Delete Customer</button>
          </div>
        </form>
      </div>

      <!-- Requests & Appointments Section with Toggle -->
      <div class="profile-section" style="margin-bottom:32px;">
        <!-- Toggle Buttons -->
        <div style="display:flex; gap:8px; margin-bottom:16px; background:rgba(0,0,0,0.05); border-radius:10px; padding:4px;">
          <button id="showRequestsBtn" class="view-toggle-btn active" onclick="toggleCustomerView('requests')" style="flex:1; padding:10px 20px; border:none; background:rgba(255,255,255,0.9); border-radius:8px; font-size:14px; font-weight:600; color:var(--macos-text-primary); cursor:pointer; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            Requests
          </button>
          <button id="showAppointmentsBtn" class="view-toggle-btn" onclick="toggleCustomerView('appointments')" style="flex:1; padding:10px 20px; border:none; background:transparent; border-radius:8px; font-size:14px; font-weight:600; color:var(--macos-text-secondary); cursor:pointer; transition:all 0.2s ease;">
            Appointments
          </button>
        </div>

        <!-- Requests Content -->
        <div id="customerRequestsView" class="customer-view-content" style="display:block;">
          <div id="customerRequestsList" style="display:flex; flex-direction:column; gap:12px;">
            <!-- Requests will be loaded here -->
          </div>
        </div>

        <!-- Appointments Content -->
        <div id="customerAppointmentsView" class="customer-view-content" style="display:none;">
          <div id="customerAppointmentsList" style="display:flex; flex-direction:column; gap:12px;">
            <!-- Appointments will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- File Upload Modal -->
  <div class="modal-backdrop" id="fileUploadModal">
    <div class="modal">
      <h3>Agreement Files</h3>
      <div style="margin-bottom:20px;">
        <div id="existingFiles" style="margin-bottom:16px;">
          <!-- Existing files will be shown here -->
        </div>
        <div style="border:2px dashed rgba(0,0,0,0.2); border-radius:12px; padding:32px; text-align:center; background:rgba(0,0,0,0.02);">
          <input type="file" id="fileUploadInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display:none;">
          <div style="font-size:48px; margin-bottom:12px;">ðŸ“Ž</div>
          <button type="button" class="btn btn-primary" onclick="document.getElementById('fileUploadInput').click()">Choose Files</button>
          <p style="margin-top:12px; font-size:13px; color:var(--muted);">PDF, DOC, DOCX, JPG, PNG accepted</p>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="closeFileUpload">Close</button>
      </div>
    </div>
  </div>

  <!-- Create Event Modal -->
  <div class="modal-backdrop" id="createEventModal">
    <div class="modal" style="max-width:600px;">
      <h3>Create New Event</h3>
      <form class="modal-form" id="createEventForm">
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="createEventTitle" placeholder="e.g. Team Meeting, Workshop, etc." required>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <input type="text" id="createEventType" placeholder="e.g. Meeting, Training, Workshop" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="createEventDescription" placeholder="Event details and notes..." style="border-radius:10px; min-height:80px; resize:vertical;"></textarea>
        </div>
        
        <div class="form-group">
          <label>Visible for Groups</label>
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px; background:rgba(0,0,0,0.02); border-radius:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:600; grid-column:1/-1; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:4px;">
              <input type="checkbox" id="groupCheckboxAll" style="width:auto; padding:0;">
              All Groups
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="geschÃ¤ftsfÃ¼hrung" style="width:auto; padding:0;">
              GeschÃ¤ftsfÃ¼hrung
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="management" style="width:auto; padding:0;">
              Management
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="booking_team" style="width:auto; padding:0;">
              Booking Team
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="mediadepartment" style="width:auto; padding:0;">
              Mediadepartment
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="resident_artists" style="width:auto; padding:0;">
              Resident Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="guest_artists" style="width:auto; padding:0;">
              Guest Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="azubis" style="width:auto; padding:0;">
              Azubis
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="andere" style="width:auto; padding:0;">
              Andere
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
            <input type="checkbox" id="createEventAttendanceRequired" style="width:auto; padding:0;">
            <span style="font-weight:500;">Anwesenheitspflicht</span>
          </label>
          <p style="font-size:12px; color:var(--muted); margin:4px 0 0 24px;">Markieren Sie dieses Event als verpflichtend fÃ¼r alle ausgewÃ¤hlten Gruppen</p>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="createEventDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="createEventStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="createEventEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelCreateEvent">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Event</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Booking Modal -->
  <div class="modal-backdrop" id="editBookingModal">
    <div class="modal" style="max-width:600px;">
      <h3>Edit Booking</h3>
      <form class="modal-form" id="editBookingForm">
        <input type="hidden" id="editBookingId">
        
        <div class="form-group">
          <label>Customer Name</label>
          <input type="text" id="editBookingCustomer" placeholder="Customer Name" required>
        </div>
        
        <div class="form-group">
          <label>Booking Type</label>
          <select id="editBookingType" required>
            <option value="">-- Select Type --</option>
            <option value="consultation">Consultation</option>
            <option value="new_tattoo">New Tattoo</option>
            <option value="continuing_tattoo">Continuing Tattoo</option>
            <option value="touch_up">Touch Up</option>
            <option value="selfbooking">Selfbooking</option>
            <option value="wannado">WannaDo</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Artist</label>
          <input type="text" id="editBookingArtistName" disabled style="background:#f5f5f5;">
          <input type="hidden" id="editBookingArtistId">
          <p style="font-size:12px; color:var(--muted); margin:4px 0 0 0;">Artist cannot be changed after booking creation</p>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="editBookingDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="editBookingStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="editBookingEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteBookingBtn">Delete Booking</button>
          <div style="flex:1;"></div>
          <button type="button" class="btn btn-secondary" id="cancelEditBooking">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Appointment Details Modal -->
  <div class="modal-backdrop" id="appointmentDetailsModal">
    <div class="modal" style="max-width:800px; max-height:90vh; overflow-y:auto;">
      <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:16px;">
        <h3 style="margin:0;">ðŸ“… Appointment Details</h3>
        <button type="button" class="btn btn-icon" onclick="closeAppointmentDetailsModal()" style="padding:4px 12px; font-size:20px; line-height:1;">Ã—</button>
      </div>
      <div id="appointmentDetailsContent" style="display:flex; flex-direction:column; gap:24px;">
        <!-- Content will be dynamically inserted -->
      </div>
      <div class="modal-actions" style="margin-top:24px; border-top:1px solid rgba(0,0,0,0.1); padding-top:16px;">
        <button type="button" class="btn btn-secondary" onclick="closeAppointmentDetailsModal()">SchlieÃŸen</button>
        <button type="button" class="btn btn-primary" id="appointmentDetailsEditBtn">Status Ã¤ndern</button>
      </div>
    </div>
  </div>

  <!-- Create Booking Modal -->
  <div class="modal-backdrop" id="createBookingModal">
    <div class="modal" style="max-width:600px;">
      <h3>Create New Booking</h3>
      <form class="modal-form" id="createBookingForm">
        <div class="form-group">
          <label>Customer Name</label>
          <input type="text" id="createBookingCustomer" placeholder="e.g. John Doe" required>
        </div>
        
        <div class="form-group">
          <label>Booking Type</label>
          <select id="createBookingType" required>
            <option value="">-- Select Type --</option>
            <option value="consultation">Consultation</option>
            <option value="new_tattoo">New Tattoo</option>
            <option value="continuing_tattoo">Continuing Tattoo</option>
            <option value="touch_up">Touch Up</option>
            <option value="selfbooking">Selfbooking</option>
            <option value="wannado">WannaDo</option>
            <option value="internal">Internal</option>
            <option value="move">Move</option>
            <option value="reserved">Reserved</option>
            <option value="no_show">No Show</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Artist Type</label>
          <select id="createBookingArtistType" required>
            <option value="">-- Select Artist Type --</option>
            <option value="resident">Resident</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Search Artist</label>
          <input type="text" id="createBookingArtistSearch" placeholder="Type to search artist..." disabled>
          <input type="hidden" id="createBookingArtistId">
          <div id="artistSearchResults" style="display:none; max-height:200px; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); border-radius:8px; margin-top:4px; background:white;"></div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="createBookingDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="createBookingStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="createBookingEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelCreateBooking">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Booking</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit/View Event Modal -->
  <div class="modal-backdrop" id="editEventModal">
    <div class="modal" style="max-width:600px;">
      <h3 id="editEventModalTitle">Event Details</h3>
      <form class="modal-form" id="editEventForm">
        <input type="hidden" id="editEventId">
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="editEventTitle" required>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <input type="text" id="editEventType" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="editEventDescription" rows="3" style="border-radius:10px; resize:vertical;"></textarea>
        </div>
        
        <div class="form-group" id="editEventArtistGroup" style="display:none;">
          <label>Artist</label>
          <input type="text" id="editEventArtistName" readonly style="background:rgba(0,0,0,0.05);">
        </div>
        
        <div class="form-group" id="editEventGroupsContainer">
          <label>Visible for Groups</label>
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px; background:rgba(0,0,0,0.02); border-radius:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:600; grid-column:1/-1; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:4px;">
              <input type="checkbox" id="editGroupCheckboxAll" style="width:auto; padding:0;">
              All Groups
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="geschÃ¤ftsfÃ¼hrung" style="width:auto; padding:0;">
              GeschÃ¤ftsfÃ¼hrung
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="management" style="width:auto; padding:0;">
              Management
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="booking_team" style="width:auto; padding:0;">
              Booking Team
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="mediadepartment" style="width:auto; padding:0;">
              Mediadepartment
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="resident_artists" style="width:auto; padding:0;">
              Resident Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="guest_artists" style="width:auto; padding:0;">
              Guest Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="azubis" style="width:auto; padding:0;">
              Azubis
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="andere" style="width:auto; padding:0;">
              Andere
            </label>
          </div>
        </div>
        
        <div class="form-group" id="editEventAttendanceGroup">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
            <input type="checkbox" id="editEventAttendanceRequired" style="width:auto; padding:0;">
            <span style="font-weight:500;">Anwesenheitspflicht</span>
          </label>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="editEventDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="editEventStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="editEventEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete Event</button>
          <div style="flex:1;"></div>
          <button type="button" class="btn btn-secondary" id="cancelEditEvent">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ============================================
       TATTOO STUDIO MANAGEMENT SYSTEM v81
       ============================================

       FIXES IN v81:
       âœ… Added: 4 Location filter buttons in Request Tab (Alle, Mommy, GON, MuttersÃ¶hne, Pardon Paris)
       âœ… Added: Location filtering logic for requests (filters by location.name)
       âœ… Added: initRequestLocationTabs() function with animated indicator
       âœ… Added: currentRequestLocation state variable
       âœ… Updated: loadRequests() to filter by both status and location
       âœ… Updated: Version number from v80 to v81

       FIXES IN v80:
       âœ… Fixed: Artist location now displays correctly in table (shows city_location field)
       âœ… Fixed: Add Artist modal HTML structure (removed extra closing div tag, added missing closing select tag)
       âœ… Fixed: Cache refresh for Artists and Customers after add/edit/delete operations

       Request Management now supports location-based filtering for better organization.
       ============================================ */

    const SUPABASE_URL = "https://auxxyehgzkozdjylhqnx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1eHh5ZWhnemtvemRqeWxocW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDczODgsImV4cCI6MjA3NjEyMzM4OH0.bg8NunF2qkps28Aj0ZqY35eKK--QOu8NduCkFyqp5KA";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ========================================
    // GLOBAL CHART INSTANCES (Declared early to avoid TDZ errors)
    // ========================================
    let requestStatusChartInstance = null;
    let appointmentStatusChartInstance = null;
    let projectsTimelineChartInstance = null;
    let revenueByMonthChartInstance = null;
    let topArtistsChartInstance = null;
    let originsPieChart = null;
    let timelineChart = null;
    let revenueTimelineChart = null;
    let artistDistributionChartInstance = null;
    let revenueByStatusChartInstance = null;

    // ==========================================
    // NAVBAR INDICATORS (Hover + Active)
    // ==========================================
    function setupNavbarHover() {
      const container = document.querySelector('nav.navbar-container');
      if (!container) return;

      const hoverBg = container.querySelector('.hover-background');
      const activeIndicator = container.querySelector('.active-indicator');
      if (!hoverBg || !activeIndicator) return;

      const links = container.querySelectorAll('.nav-link');

      // Funktion: Active-Indikator positionieren
      function updateActiveIndicator() {
        const activeLink = container.querySelector('.nav-link.active');
        if (activeLink) {
          const rect = activeLink.getBoundingClientRect();
          const containerRect = container.getBoundingClientRect();
          activeIndicator.style.width = rect.width + 'px';
          activeIndicator.style.left = (rect.left - containerRect.left) + 'px';
        }
      }

      // Initial Position
      updateActiveIndicator();

      // Hover: Grauer Container bewegt sich
      links.forEach(link => {
        link.addEventListener('mouseenter', function() {
          if (window.innerWidth > 768) {
            const rect = this.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            hoverBg.style.width = rect.width + 'px';
            hoverBg.style.left = (rect.left - containerRect.left) + 'px';
            hoverBg.style.opacity = '1';
          }
        });
      });

      // Mouse leave: Hover-Background ausblenden
      container.addEventListener('mouseleave', function() {
        hoverBg.style.opacity = '0';
      });

      // Update bei Tab-Click
      links.forEach(link => {
        link.addEventListener('click', function() {
          setTimeout(updateActiveIndicator, 10);
        });
      });

      // Update bei Resize
      window.addEventListener('resize', updateActiveIndicator);
    }

    // ==========================================
    // MOBILE NAVIGATION
    // ==========================================
    function setupMobileNavigation() {
      const mobileFooterNav = document.querySelector('.mobile-footer-nav');
      const isMobile = window.innerWidth <= 768;

      if (isMobile && mobileFooterNav) {
        mobileFooterNav.style.display = 'flex';
      } else if (mobileFooterNav) {
        mobileFooterNav.style.display = 'none';
      }
    }

    // ========================================
    // RETRY LOGIC FOR NETWORK REQUESTS
    // ========================================

    /**
     * Retry a Supabase request with exponential backoff
     * @param {Function} requestFn - Async function that returns a Supabase query
     * @param {number} maxRetries - Maximum number of retries (default: 3)
     * @param {number} baseDelay - Base delay in ms (default: 1000)
     * @returns {Promise} - The successful result or throws final error
     */
    async function retryWithBackoff(requestFn, maxRetries = 3, baseDelay = 1000) {
      let lastError = null;

      for (let attempt = 0; attempt <= maxRetries; attempt++) {
        try {
          const result = await requestFn();

          // Check for Supabase error
          if (result.error) {
            throw result.error;
          }

          return result;
        } catch (error) {
          lastError = error;

          // Don't retry on final attempt
          if (attempt === maxRetries) {
            break;
          }

          // Calculate exponential backoff delay
          const delay = baseDelay * Math.pow(2, attempt);
          const jitter = Math.random() * 200; // Add jitter to prevent thundering herd
          const totalDelay = delay + jitter;

          console.warn(`âš ï¸ Request failed (attempt ${attempt + 1}/${maxRetries + 1}), retrying in ${Math.round(totalDelay)}ms...`, error.message);

          // Wait before retrying
          await new Promise(resolve => setTimeout(resolve, totalDelay));
        }
      }

      // All retries failed
      console.error('âŒ All retry attempts failed:', lastError);
      throw lastError;
    }

    // ========================================
    // LOADING PROGRESS BAR SYSTEM
    // ========================================

    const ProgressBar = {
      overlay: null,
      fill: null,
      percent: null,
      text: null,
      currentProgress: 0,

      init() {
        this.overlay = document.getElementById('loadingOverlay');
        this.fill = document.getElementById('progressFill');
        this.percent = document.getElementById('progressPercent');
        this.text = document.getElementById('progressText');
      },

      show(message = 'Loading data...') {
        if (!this.overlay) this.init();
        this.currentProgress = 0;
        this.overlay.classList.remove('hidden');
        this.updateProgress(0, message);
      },

      updateProgress(progress, message = null) {
        if (!this.overlay) this.init();
        this.currentProgress = Math.min(100, Math.max(0, progress));
        this.fill.style.width = this.currentProgress + '%';
        this.percent.textContent = Math.round(this.currentProgress) + '%';
        if (message) {
          this.text.textContent = message;
        }
      },

      hide() {
        if (!this.overlay) this.init();
        this.updateProgress(100, 'Complete!');
        setTimeout(() => {
          this.overlay.classList.add('hidden');
        }, 300);
      },

      // Simulate progress for async operations
      simulateProgress(startPercent, endPercent, duration, message) {
        return new Promise((resolve) => {
          const start = this.currentProgress || startPercent;
          const diff = endPercent - start;
          const steps = 20;
          const stepDuration = duration / steps;
          let currentStep = 0;

          const interval = setInterval(() => {
            currentStep++;
            const progress = start + (diff * (currentStep / steps));
            this.updateProgress(progress, message);

            if (currentStep >= steps) {
              clearInterval(interval);
              resolve();
            }
          }, stepDuration);
        });
      }
    };

    // ========================================
    // PAYMENT SYSTEM CONFIGURATION
    // ========================================

    // Stripe Configuration (TEST MODE for now)
    // ðŸ” IMPORTANT: Replace these placeholders with your actual Stripe API keys
    const STRIPE_SECRET_KEY = 'INSERT_STRIPE_SECRET_KEY_HERE'; // Get from https://dashboard.stripe.com/test/apikeys
    const STRIPE_PUBLISHABLE_KEY = 'INSERT_STRIPE_PUBLISHABLE_KEY_HERE'; // Get from https://dashboard.stripe.com/test/apikeys

    // Resend Configuration (for email sending)
    // ðŸ” IMPORTANT: Replace this placeholder with your actual Resend API key
    const RESEND_API_KEY = 'INSERT_RESEND_API_KEY_HERE'; // Get from https://resend.com/api-keys

    // Email Configuration
    const EMAIL_FROM = 'onboarding@resend.dev'; // Testing email - no domain verification needed
    const EMAIL_REPLY_TO = 'info@mommyimsorry.com';

    // Business Information (used in email template)
    const BUSINESS_INFO = {
      name: 'Mommy I\'m Sorry Verwaltung GmbH',
      iban: 'DE65 6005 0101 0405 7944 09',
      address: 'TÃ¼binger Str. 73',
      city: '70178 Stuttgart',
      phone: '071151875672',
      email: 'Info@mommyimsorry.com',
      instagram: '@mommyimsorry',
      faq_url: 'https://www.mommyimsorry.com/faq'
    };

    // ============================================
    // PERMISSION HELPER FUNCTIONS
    // ============================================

    // Permission check function
    async function userHasPermission(permission) {
      try {
        const { data, error } = await supabase.rpc('user_has_permission', {
          p_permission: permission
        });

        if (error) {
          console.error('Permission check error:', error);
          return false;
        }

        return data === true;
      } catch (err) {
        console.error('Permission check failed:', err);
        return false;
      }
    }

    // Get current user role
    async function getCurrentUserRole() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return 'guest';

        const { data: profile } = await supabase
          .from('profiles')
          .select('role')
          .eq('id', user.id)
          .single();

        return profile?.role || 'user';
      } catch (err) {
        console.error('Error getting user role:', err);
        return 'guest';
      }
    }

    let currentDate = new Date();
    let dienstplanDate = new Date();
    let agreementsDate = new Date();
    let events = [];
    let loadedDateRangeStart = null;
    let loadedDateRangeEnd = null;
    let allArtists = [];
    let allTeamMembers = [];
    let allLocations = []; // FIXED: Declare allLocations globally to prevent undefined errors
    let currentTimeIndicatorInterval = null; // FIXED: Track interval to prevent memory leak

    // Sorting state
    let artistSortConfig = { field: 'name', order: 'asc' };
    let customerSortConfig = { field: 'created_at', order: 'desc' };
    let currentEditingEvent = null;
    let selectedLocationId = null;
    let selectedDienstplanLocationId = null;
    let selectedAgreementsLocationId = null;
    let currentLocationName = '';
    let openCategories = new Set();
    let currentAgreementEventId = null;
    let agreementFiles = [];
    
    // Category visibility state
    let visibleCategories = {
      events: true,
      residents: true,
      guests: true
    };

    // Google-inspirierte Farbschemata pro Location
    const locationColors = {
      'mommy': {
        primary: '#8E24AA',      // Purple
        light: '#F3E5F5',
        dark: '#6A1B9A',
        accent: '#BA68C8'
      },
      'gon': {
        primary: '#1976D2',      // Blue
        light: '#E3F2FD',
        dark: '#0D47A1',
        accent: '#42A5F5'
      },
      'muttersÃ¶hne': {
        primary: '#43A047',      // Green
        light: '#E8F5E9',
        dark: '#2E7D32',
        accent: '#66BB6A'
      },
      'pardon': {
        primary: '#E53935',      // Red
        light: '#FFEBEE',
        dark: '#C62828',
        accent: '#EF5350'
      },
      'default': {
        primary: '#111827',      // Dark Gray
        light: '#F3F4F6',
        dark: '#0F172A',
        accent: '#6B7280'
      }
    };

    function getLocationColors(locationName) {
      const name = (locationName || '').toLowerCase();
      if (name.includes('mommy')) return locationColors.mommy;
      if (name.includes('gon')) return locationColors.gon;
      if (name.includes('muttersÃ¶hne') || name.includes('muttersohne')) return locationColors.muttersÃ¶hne;
      if (name.includes('pardon')) return locationColors.pardon;
      return locationColors.default;
    }

    function getCurrentLocationName() {
      const select = document.querySelector('#dienstplanLocationDropdown option:checked');
      return select ? select.textContent : '';
    }

    // ============================================
    // UI PERMISSIONS INITIALIZATION
    // ============================================

    async function initializePermissions() {
      try {
        // Check if user is logged in
        const { data: { user } } = await supabase.auth.getUser();

        // âœ… CHANGED: Always show buttons by default (anon key allows public access)
        // Only hide if explicitly no permission when logged in
        console.log('User login status:', user ? 'Logged in' : 'Anonymous (using anon key)');

        // If no user logged in, show all buttons (anon key provides access)
        if (!user) {
          console.log('âœ… Anonymous access - all buttons visible with anon key');
          return; // Exit early - keep all buttons visible
        }

        // Check all permissions in parallel for faster load
        const [
          canCreateBooking,
          canCreateEvent,
          canManageArtists,
          canManageCustomers,
          canManageRequests,
          canManageDienstplan
        ] = await Promise.all([
          userHasPermission('calendar.create_booking'),
          userHasPermission('calendar.create_event'),
          userHasPermission('artists.manage'),
          userHasPermission('customers.manage'),
          userHasPermission('requests.manage'),
          userHasPermission('dienstplan.manage')
        ]);

        console.log('Permissions loaded:', {
          canCreateBooking,
          canCreateEvent,
          canManageArtists,
          canManageCustomers,
          canManageRequests,
          canManageDienstplan
        });

        // Hide/show buttons based on permissions
        if (!canCreateBooking) {
          const createBookingBtns = document.querySelectorAll('[onclick*="createBooking"]');
          createBookingBtns.forEach(btn => btn.style.display = 'none');
        }

        if (!canCreateEvent) {
          const createEventBtns = document.querySelectorAll('[onclick*="createEvent"]');
          createEventBtns.forEach(btn => btn.style.display = 'none');
        }

        if (!canManageArtists) {
          const artistBtns = document.querySelectorAll('#addArtistBtn, [onclick*="addArtist"], [onclick*="editArtist"], [onclick*="deleteArtist"]');
          artistBtns.forEach(btn => btn.style.display = 'none');
        }

        if (!canManageCustomers) {
          const customerBtns = document.querySelectorAll('#addCustomerBtn, [onclick*="addCustomer"], [onclick*="editCustomer"], [onclick*="deleteCustomer"]');
          customerBtns.forEach(btn => btn.style.display = 'none');
        }

        if (!canManageRequests) {
          const requestBtns = document.querySelectorAll('[onclick*="assignRequest"], [onclick*="scheduleAppointment"]');
          requestBtns.forEach(btn => btn.style.display = 'none');
        }

        if (!canManageDienstplan) {
          // Make dienstplan cells read-only
          const dienstplanCells = document.querySelectorAll('.dp-cell');
          dienstplanCells.forEach(cell => {
            cell.style.cursor = 'not-allowed';
            cell.style.pointerEvents = 'none';
          });
        }
      } catch (err) {
        console.error('Error initializing permissions:', err);
      }
    }

    function hideManagementButtons() {
      const selectors = [
        '[onclick*="createBooking"]',
        '[onclick*="createEvent"]',
        '#addArtistBtn',
        '[onclick*="addArtist"]',
        '[onclick*="editArtist"]',
        '[onclick*="deleteArtist"]',
        '#addCustomerBtn',
        '[onclick*="addCustomer"]',
        '[onclick*="editCustomer"]',
        '[onclick*="deleteCustomer"]',
        '[onclick*="assignRequest"]',
        '[onclick*="scheduleAppointment"]'
      ];

      selectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => el.style.display = 'none');
      });

      // Make dienstplan read-only
      const dienstplanCells = document.querySelectorAll('.dp-cell');
      dienstplanCells.forEach(cell => {
        cell.style.cursor = 'not-allowed';
        cell.style.pointerEvents = 'none';
      });
    }



    // Sorting Functions
    function sortArtists(artists, field, order) {
      const sorted = [...artists].sort((a, b) => {
        let aVal, bVal;
        
        if (field === 'name') {
          aVal = (a.name || '').toLowerCase();
          bVal = (b.name || '').toLowerCase();
        } else if (field === 'rank') {
          const rankOrder = { 'R1': 1, 'R2': 2, 'R3': 3, 'R4': 4, 'R5': 5 };
          aVal = rankOrder[a.rank] || 999;
          bVal = rankOrder[b.rank] || 999;
        } else if (field === 'location') {
          aVal = (a.city_location || '').toLowerCase();
          bVal = (b.city_location || '').toLowerCase();
        }
        
        if (aVal < bVal) return order === 'asc' ? -1 : 1;
        if (aVal > bVal) return order === 'asc' ? 1 : -1;
        return 0;
      });
      
      return sorted;
    }
    
    function sortCustomers(customers, field, order) {
      const sorted = [...customers].sort((a, b) => {
        let aVal, bVal;
        
        if (field === 'name') {
          aVal = `${a.first_name || ''} ${a.last_name || ''}`.toLowerCase();
          bVal = `${b.first_name || ''} ${b.last_name || ''}`.toLowerCase();
        } else if (field === 'rank') {
          const rankOrder = { 'Bronze': 1, 'Silver': 2, 'Gold': 3, 'Platinum': 4 };
          aVal = rankOrder[a.rank] || 0;
          bVal = rankOrder[b.rank] || 0;
        } else if (field === 'created') {
          aVal = new Date(a.created_at).getTime();
          bVal = new Date(b.created_at).getTime();
        }
        
        if (aVal < bVal) return order === 'asc' ? -1 : 1;
        if (aVal > bVal) return order === 'asc' ? 1 : -1;
        return 0;
      });
      
      return sorted;
    }

    function applyLocationTheme(colors) {
      const root = document.documentElement;
      root.style.setProperty('--location-primary', colors.primary);
      root.style.setProperty('--location-light', colors.light);
      root.style.setProperty('--location-dark', colors.dark);
      root.style.setProperty('--location-accent', colors.accent);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const tabs = document.querySelectorAll("nav a[id^='tab-']");
      const sections = document.querySelectorAll("section");

      // Load data and permissions in parallel for faster initial load
      await Promise.all([
        loadInitialData(),
        initializePermissions()
      ]);

      // Hide initial loader after data is loaded
      const initialLoader = document.getElementById('initialLoader');
      if (initialLoader) {
        initialLoader.classList.remove('active');
      }

      // Request tabs initialization function
      function initRequestTabs() {
        const requestTabs = document.querySelectorAll('.request-tab');
        const requestsIndicator = document.getElementById('requestsIndicator');
        
        console.log('Init Request tabs found:', requestTabs.length);
        console.log('Init Indicator element:', requestsIndicator);
        
        if (!requestsIndicator || requestTabs.length === 0) {
          console.error('Missing indicator or tabs');
          return;
        }
        
        function updateRequestsIndicator(tab) {
          if (!requestsIndicator || !tab) return;
          
          const tabRect = tab.getBoundingClientRect();
          const containerRect = tab.parentElement.getBoundingClientRect();
          const left = tabRect.left - containerRect.left;
          const width = tabRect.width;
          
          console.log('Updating indicator - Left:', left, 'Width:', width);
          
          requestsIndicator.style.width = `${width}px`;
          requestsIndicator.style.transform = `translateX(${left}px)`;
        }
        
        // Initialize indicator position
        setTimeout(() => {
          const activeTab = document.querySelector('.request-tab.active');
          if (activeTab) {
            console.log('Initializing indicator for active tab');
            updateRequestsIndicator(activeTab);
          }
        }, 50);
        
        // Add click listeners
        requestTabs.forEach((tab, index) => {
          console.log('Adding click listener to tab', index, tab.textContent);
          
          // Remove old listeners by cloning
          const newTab = tab.cloneNode(true);
          tab.parentNode.replaceChild(newTab, tab);
          
          newTab.addEventListener('click', function(e) {
            console.log('Tab clicked:', this.textContent, 'Status:', this.dataset.status);
            
            // Update current status
            currentRequestStatus = this.dataset.status;
            console.log('Updated currentRequestStatus to:', currentRequestStatus);
            
            document.querySelectorAll('.request-tab').forEach(t => {
              t.classList.remove('active');
              t.style.color = '#86868b';
            });
            this.classList.add('active');
            this.style.color = '#1d1d1f';
            
            updateRequestsIndicator(this);

            // Show/hide Create Request button based on tab
            const createRequestBtnContainer = document.getElementById('createRequestBtnContainer');
            if (createRequestBtnContainer) {
              if (this.dataset.status === 'open_request') {
                createRequestBtnContainer.style.display = 'flex';
              } else {
                createRequestBtnContainer.style.display = 'none';
              }
            }

            // Close detail view when switching tabs
            selectedRequestId = null;
            closeRequestDetail();

            loadRequests();
          });
        });
      }

      // âœ… NEW: Request Location tabs initialization function
      function initRequestLocationTabs() {
        const locationTabs = document.querySelectorAll('.request-location-tab');
        const locationIndicator = document.getElementById('requestsLocationIndicator');

        console.log('Init Request Location tabs found:', locationTabs.length);
        console.log('Init Location Indicator element:', locationIndicator);

        if (!locationIndicator || locationTabs.length === 0) {
          console.error('Missing location indicator or tabs');
          return;
        }

        function updateLocationIndicator(tab) {
          if (!locationIndicator || !tab) return;

          const tabRect = tab.getBoundingClientRect();
          const containerRect = tab.parentElement.getBoundingClientRect();
          const left = tabRect.left - containerRect.left;
          const width = tabRect.width;

          console.log('Updating location indicator - Left:', left, 'Width:', width);

          locationIndicator.style.width = `${width}px`;
          locationIndicator.style.transform = `translateX(${left}px)`;
        }

        // Initialize indicator position
        setTimeout(() => {
          const activeTab = document.querySelector('.request-location-tab.active');
          if (activeTab) {
            console.log('Initializing location indicator for active tab');
            updateLocationIndicator(activeTab);
          }
        }, 50);

        // Add click listeners
        locationTabs.forEach((tab, index) => {
          console.log('Adding click listener to location tab', index, tab.textContent);

          // Remove old listeners by cloning
          const newTab = tab.cloneNode(true);
          tab.parentNode.replaceChild(newTab, tab);

          newTab.addEventListener('click', function(e) {
            console.log('Location tab clicked:', this.textContent, 'Location:', this.dataset.location);

            // Update current location
            currentRequestLocation = this.dataset.location;
            console.log('Updated currentRequestLocation to:', currentRequestLocation);

            document.querySelectorAll('.request-location-tab').forEach(t => {
              t.classList.remove('active');
              t.style.color = '#86868b';
            });
            this.classList.add('active');
            this.style.color = '#1d1d1f';

            updateLocationIndicator(this);

            // Close detail view when switching location
            selectedRequestId = null;
            closeRequestDetail();

            loadRequests();
          });
        });
      }

      // Refresh Requests Functionality
      let autoRefreshInterval = null;
      let isRefreshing = false;

      async function refreshRequests() {
        if (isRefreshing) return;

        isRefreshing = true;
        const refreshBtn = document.getElementById('refreshRequestsBtn');
        const refreshIcon = document.getElementById('refreshIcon');
        const refreshText = document.getElementById('refreshBtnText');

        // Add loading state
        if (refreshBtn) {
          refreshBtn.disabled = true;
          refreshBtn.style.opacity = '0.7';
          refreshBtn.style.cursor = 'not-allowed';
        }
        if (refreshIcon) {
          refreshIcon.style.transform = 'rotate(360deg)';
        }
        if (refreshText) {
          refreshText.textContent = 'LÃ¤dt...';
        }

        try {
          const beforeCount = allRequests.length;
          await loadRequests();
          const afterCount = allRequests.length;
          const newRequestsCount = afterCount - beforeCount;

          // Show success notification
          if (refreshText) {
            refreshText.textContent = `âœ“ ${allRequests.length} Requests geladen`;
          }

          // Reset button after 2 seconds
          setTimeout(() => {
            if (refreshText) refreshText.textContent = 'Neue Requests laden';
            if (refreshBtn) {
              refreshBtn.disabled = false;
              refreshBtn.style.opacity = '1';
              refreshBtn.style.cursor = 'pointer';
            }
            if (refreshIcon) {
              refreshIcon.style.transform = 'rotate(0deg)';
            }
          }, 2000);

          console.log(`âœ… Refreshed: ${allRequests.length} total requests${newRequestsCount > 0 ? ` (+${newRequestsCount} new)` : ''}`);
        } catch (error) {
          console.error('âŒ Refresh failed:', error);
          if (refreshText) refreshText.textContent = 'âŒ Fehler';

          setTimeout(() => {
            if (refreshText) refreshText.textContent = 'Neue Requests laden';
            if (refreshBtn) {
              refreshBtn.disabled = false;
              refreshBtn.style.opacity = '1';
              refreshBtn.style.cursor = 'pointer';
            }
            if (refreshIcon) {
              refreshIcon.style.transform = 'rotate(0deg)';
            }
          }, 2000);
        } finally {
          isRefreshing = false;
        }
      }

      // Auto-Refresh Functionality
      function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);

        autoRefreshInterval = setInterval(() => {
          // Only refresh if no modal is open and we're on the requests section
          const isModalOpen = document.querySelector('.modal.active') ||
                              document.getElementById('requestDetail').querySelector('h2');
          const isRequestsSection = document.getElementById('requests-section').classList.contains('active');

          if (!isModalOpen && isRequestsSection && !isRefreshing) {
            console.log('ðŸ”„ Auto-refreshing requests...');
            refreshRequests();
          }
        }, 30000); // 30 seconds

        console.log('âœ… Auto-refresh enabled (30s interval)');
      }

      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          console.log('âŒ Auto-refresh disabled');
        }
      }

      // Initialize Refresh Button
      document.getElementById('refreshRequestsBtn')?.addEventListener('click', refreshRequests);

      // Initialize Auto-Refresh Toggle
      document.getElementById('autoRefreshToggle')?.addEventListener('change', (e) => {
        if (e.target.checked) {
          startAutoRefresh();
        } else {
          stopAutoRefresh();
        }
      });

      // Image Modal Functions
      window.openImageModal = function(imageUrl) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        if (modal && modalImg) {
          modalImg.src = imageUrl;
          modal.classList.add('active');
        }
      };

      window.closeImageModal = function() {
        const modal = document.getElementById('imageModal');
        if (modal) {
          modal.classList.remove('active');
        }
      };

      function showSection(tab) {
        tabs.forEach(x => x.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));
        tab.classList.add("active");
        
        const tabName = tab.id.replace("tab-", "");
        const target = document.getElementById(tabName + "-section");
        if (target) {
          target.classList.add("active");
          if (tabName === "dashboard") {
            loadDashboard();
            loadPinnedEvents();
            loadSchwarzesBrett();
          }
          else if (tabName === "requests") {
            loadRequests();
            initRequestTabs();
            initRequestLocationTabs(); // âœ… NEW: Initialize location filter tabs
          }
          else if (tabName === "calendar") renderCalendar();
          else if (tabName === "dienstplan") renderDienstplan();
          else if (tabName === "agreements") {
            updateAgreementsDateDisplay();
            loadAgreements();
          }
          else if (tabName === "artists") loadArtists();
          else if (tabName === "customers") loadCustomers();
        }
      }

      tabs.forEach(tab => tab.addEventListener("click", (e) => {
        e.preventDefault();
        showSection(tab);
      }));

      async function loadInitialData() {
        try {
          console.log('ðŸ“¥ Loading initial data with retry logic...');

          // Load data SEQUENTIALLY with retry logic to avoid network overload
          // Artists
          const artistsResult = await retryWithBackoff(() =>
            supabase.from('artists').select('*')
          );
          allArtists = artistsResult.data || [];
          console.log('âœ… Artists loaded:', allArtists.length);

          // Team Members
          const teamMembersResult = await retryWithBackoff(() =>
            supabase.from('dienstplan_resources')
              .select('*')
              .order('sort_order', { ascending: true })
              .order('name', { ascending: true })
          );
          allTeamMembers = teamMembersResult.data || [];
          console.log('âœ… Team members loaded:', allTeamMembers.length);

          // Locations
          const locationsResult = await retryWithBackoff(() =>
            supabase.from('locations').select('*').order('name', { ascending: true })
          );
          const locations = locationsResult.data || [];
          allLocations = locations;
          console.log('âœ… Locations loaded:', allLocations.length);
          
          if (locations && locations.length > 0) {
            // Finde "mommy i'm sorry" oder nimm die erste Location
            const mommyLocation = locations.find(l => l.name.toLowerCase().includes("mommy"));
            selectedLocationId = mommyLocation ? mommyLocation.id : locations[0].id;
            selectedDienstplanLocationId = selectedLocationId;
            
            // Set initial location name and theme
            const initialLocation = locations.find(l => l.id === selectedLocationId);
            if (initialLocation) {
              currentLocationName = initialLocation.name;
              const colors = getLocationColors(currentLocationName);
              applyLocationTheme(colors);
            }
            
            const locSelect = document.getElementById('locationDropdown');
            locSelect.innerHTML = locations.map(l => 
              `<option value="${l.id}" ${l.id === selectedLocationId ? 'selected' : ''}>${l.name}</option>`
            ).join('');
            
            locSelect.onchange = async (e) => {
              selectedLocationId = e.target.value;
              console.log('Location changed to:', selectedLocationId);
              
              // Get location name and apply theme
              const selectedLocation = locations.find(l => l.id === selectedLocationId);
              if (selectedLocation) {
                currentLocationName = selectedLocation.name;
                const colors = getLocationColors(currentLocationName);
                applyLocationTheme(colors);
              }
              
              await loadEvents();
              renderCalendar();
            };
            
            // Dienstplan Location Dropdown
            const dienstplanLocSelect = document.getElementById('dienstplanLocationDropdown');
            dienstplanLocSelect.innerHTML = locations.map(l => 
              `<option value="${l.id}" ${l.id === selectedDienstplanLocationId ? 'selected' : ''}>${l.name}</option>`
            ).join('');
            
            dienstplanLocSelect.onchange = (e) => {
              selectedDienstplanLocationId = e.target.value;
              console.log('Dienstplan location changed to:', selectedDienstplanLocationId);
              renderDienstplan();
            };

            // Artist Location Filter Dropdown
            const artistLocFilter = document.getElementById('artistLocationFilter');
            if (artistLocFilter) {
              // Keep existing options (Alle Locations, Ohne Location) and add dynamic locations
              const locationOptions = locations.map(l =>
                `<option value="${l.id}">${l.name}</option>`
              ).join('');
              artistLocFilter.innerHTML = `
                <option value="">ðŸ“ Alle Locations</option>
                <option value="NULL">âš ï¸ Ohne Location</option>
                ${locationOptions}
              `;
            }

          }

          // Load events and dashboard in parallel
          await Promise.all([
            loadEvents(),
            loadDashboard(),
            loadPinnedEvents(),
            loadSchwarzesBrett()
          ]);
        } catch(err) {
          console.error("Load error:", err);
          alert("Error loading data: " + err.message);
        }
      }

      // ============================================
      // PROJECT METRICS CALCULATION (GLOBAL)
      // ============================================
      /**
       * Calculate project metrics from requests and appointments
       * Supports both old signature (appointments only) and new signature (requests, appointments)
       */
      window.calculateProjectMetrics = function calculateProjectMetrics(requestsOrAppointments, appointments) {
        console.log('ðŸ“Š Calculating project metrics...', {
          arg1Count: requestsOrAppointments?.length || 0,
          arg2Count: appointments?.length || 0
        });

        // Support old signature: calculateProjectMetrics(appointments)
        if (!appointments && Array.isArray(requestsOrAppointments)) {
          appointments = requestsOrAppointments;
          requestsOrAppointments = [];
          console.log('  â†³ Using legacy signature (appointments only)');
        }

        const requests = Array.isArray(requestsOrAppointments) ? requestsOrAppointments : [];
        appointments = appointments || [];

        if (requests.length === 0 && appointments.length === 0) {
          console.warn('âš ï¸ No requests or appointments provided for project metrics');
          return {
            totalProjects: 0,
            activeProjects: 0,
            completedProjects: 0,
            canceledProjects: 0,
            total_projects: 0,
            active_projects: 0,
            finished_projects: 0,
            total_revenue: 0,
            avg_project_value: 0,
            projects_with_appointments: 0,
            avg_appointments_per_project: 0,
            totalRevenue: 0,
            avgAppointmentsPerProject: 0,
            completionRate: 0,
            projectsArray: []
          };
        }

        // Group by project_id
        const projectsMap = new Map();

        // Process requests
        requests.forEach(req => {
          if (!req.project_id) return;

          if (!projectsMap.has(req.project_id)) {
            projectsMap.set(req.project_id, {
              project_id: req.project_id,
              project_number: req.project_number,
              project_title: req.project_title,
              customer_email: req.email,
              customer_id: req.customer_id,
              customer_name: null,
              requests: [],
              appointments: [],
              total_price: 0,
              total_revenue: 0,
              status: req.status
            });
          }

          const project = projectsMap.get(req.project_id);
          project.requests.push(req);
          if (req.total_amount) {
            project.total_price += parseFloat(req.total_amount) || 0;
            project.total_revenue += parseFloat(req.total_amount) || 0;
          }
        });

        // Process appointments
        appointments.forEach(apt => {
          const projId = apt.project_id || apt.project_number;
          if (!projId) return;

          if (!projectsMap.has(projId)) {
            projectsMap.set(projId, {
              project_id: projId,
              project_number: apt.project_number,
              project_title: apt.project_title,
              customer_email: apt.customer_email,
              customer_id: apt.customer_id,
              customer_name: null,
              requests: [],
              appointments: [],
              total_price: 0,
              total_revenue: 0,
              status: apt.status
            });
          }

          const project = projectsMap.get(projId);
          project.appointments.push(apt);

          // Customer name
          if (apt.first_name || apt.last_name) {
            project.customer_name = `${apt.first_name || ''} ${apt.last_name || ''}`.trim();
          }

          // Calculate revenue
          const revenue = parseFloat(apt.payment_amount || apt.price || apt.total_amount || 0);
          project.total_price += revenue;
          project.total_revenue += revenue;
        });

        const projects = Array.from(projectsMap.values());

        // Count projects by status using PROPER completion logic
        let completedProjects = 0;
        let activeProjects = 0;
        let canceledProjects = 0;
        let finishedProjects = 0;

        projects.forEach(project => {
          if (project.appointments.length > 0) {
            const statuses = project.appointments.map(a => a.status);

            // Check if ALL appointments are finished
            const allFinished = statuses.every(s => s === 'finished');

            // Check if has any scheduled
            const hasScheduled = statuses.some(s => s === 'scheduled');

            // Check if ALL appointments are canceled
            const allCanceled = statuses.every(s => s === 'canceled');

            if (allFinished) {
              completedProjects++;
              finishedProjects++;
              project.project_status = 'completed';
            } else if (allCanceled) {
              canceledProjects++;
              project.project_status = 'canceled';
            } else if (hasScheduled) {
              activeProjects++;
              project.project_status = 'active';
            } else {
              // Mixed finished/canceled but no scheduled = completed
              completedProjects++;
              finishedProjects++;
              project.project_status = 'completed';
            }
          } else {
            // Use request status if no appointments
            if (['open_request', 'pending', 'scheduled'].includes(project.status)) {
              activeProjects++;
              project.project_status = 'active';
            } else if (project.status === 'finished') {
              completedProjects++;
              finishedProjects++;
              project.project_status = 'completed';
            } else if (project.status === 'canceled') {
              canceledProjects++;
              project.project_status = 'canceled';
            }
          }
        });

        // Calculate metrics
        const totalProjects = projects.length;
        const totalRevenue = projects.reduce((sum, p) => sum + p.total_revenue, 0);
        const avgProjectValue = totalProjects > 0 ? totalRevenue / totalProjects : 0;
        const projectsWithAppointments = projects.filter(p => p.appointments.length > 0).length;
        const avgAppointmentsPerProject = totalProjects > 0
          ? projects.reduce((sum, p) => sum + p.appointments.length, 0) / totalProjects
          : 0;
        const completionRate = totalProjects > 0 ? (completedProjects / totalProjects) * 100 : 0;

        const metrics = {
          // New format
          total_projects: totalProjects,
          active_projects: activeProjects,
          finished_projects: finishedProjects,
          total_revenue: totalRevenue,
          avg_project_value: avgProjectValue,
          projects_with_appointments: projectsWithAppointments,
          avg_appointments_per_project: avgAppointmentsPerProject,
          // Legacy format (for backward compatibility)
          totalProjects,
          activeProjects,
          completedProjects,
          canceledProjects,
          totalRevenue,
          avgAppointmentsPerProject,
          completionRate,
          projectsArray: projects
        };

        console.log('âœ… Project metrics calculated:', metrics);
        return metrics;
      }

      // ============================================
      // COMPLETE DASHBOARD STATS FUNCTION
      // ============================================
      async function loadDashboard() {
        console.log('ðŸ“Š Loading Dashboard Statistics...');

        try {
          // Show progress bar
          ProgressBar.show('Starting to load dashboard...');

          // 1. LOAD ALL REQUESTS WITH STATUS (Handle 34K+ rows with pagination)
          console.log('ðŸ“¥ Loading all requests...');
          ProgressBar.updateProgress(10, 'Loading requests...');
          let allRequests = [];
          let from = 0;
          const batchSize = 1000;
          let hasMore = true;

          while (hasMore) {
            const { data: batch, error: reqError } = await supabase
              .from('requests')
              .select('status, created_at')
              .range(from, from + batchSize - 1);

            if (reqError) throw reqError;

            if (batch && batch.length > 0) {
              allRequests = allRequests.concat(batch);
              from += batchSize;
              hasMore = batch.length === batchSize;
              console.log(`  â†³ Loaded ${allRequests.length} requests so far...`);
              // Update progress (10% to 40%)
              const requestProgress = 10 + Math.min(30, (allRequests.length / 1000) * 3);
              ProgressBar.updateProgress(requestProgress, `Loading requests (${allRequests.length} loaded)...`);
            } else {
              hasMore = false;
            }
          }

          console.log('âœ… Loaded', allRequests?.length || 0, 'total requests');
          ProgressBar.updateProgress(40, 'Requests loaded. Loading appointments...');

          // 2. COUNT REQUESTS BY STATUS (INCLUDING ARCHIVED)
          const requestCounts = {
            open_request: 0,
            pending: 0,
            scheduled: 0,
            finished: 0,
            canceled: 0,
            archived: 0  // â† NEW STATUS
          };

          (allRequests || []).forEach(req => {
            if (requestCounts.hasOwnProperty(req.status)) {
              requestCounts[req.status]++;
            }
          });

          console.log('ðŸ“Š Request counts:', requestCounts);

          // 3. LOAD ALL APPOINTMENTS WITH STATUS AND DATES (Handle 1K+ rows with pagination)
          console.log('ðŸ“¥ Loading all appointments...');
          let allAppointments = [];
          from = 0;
          hasMore = true;

          while (hasMore) {
            const { data: batch, error: aptError } = await supabase
              .from('appointments')
              .select('status, start, end, created_at')
              .range(from, from + batchSize - 1);

            if (aptError) throw aptError;

            if (batch && batch.length > 0) {
              allAppointments = allAppointments.concat(batch);
              from += batchSize;
              hasMore = batch.length === batchSize;
              console.log(`  â†³ Loaded ${allAppointments.length} appointments so far...`);
              // Update progress (40% to 65%)
              const appointmentProgress = 40 + Math.min(25, (allAppointments.length / 1000) * 25);
              ProgressBar.updateProgress(appointmentProgress, `Loading appointments (${allAppointments.length} loaded)...`);
            } else {
              hasMore = false;
            }
          }

          console.log('âœ… Loaded', allAppointments?.length || 0, 'total appointments');
          ProgressBar.updateProgress(70, 'Calculating statistics...');

          // 4. COUNT APPOINTMENTS BY STATUS
          const appointmentCounts = {
            scheduled: 0,
            finished: 0,
            canceled: 0,
            no_show: 0,
            rescheduled: 0,
            reserved: 0,
            unknown: 0
          };

          // Count today's appointments
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);

          let todayAppointments = 0;

          (allAppointments || []).forEach(apt => {
            // Count by status
            if (appointmentCounts.hasOwnProperty(apt.status)) {
              appointmentCounts[apt.status]++;
            }

            // Count today's appointments
            if (apt.start) {
              const aptDate = new Date(apt.start);
              if (aptDate >= today && aptDate < tomorrow) {
                todayAppointments++;
              }
            }
          });

          console.log('ðŸ“… Appointment counts:', appointmentCounts);
          console.log('ðŸ“… Today\'s appointments:', todayAppointments);

          // 5. LOAD CUSTOMERS & ARTISTS COUNTS
          const { count: customerCount } = await supabase
            .from('customers')
            .select('*', { count: 'exact', head: true });

          const { count: artistCount } = await supabase
            .from('artists')
            .select('*', { count: 'exact', head: true });

          // 6. UPDATE LEGACY BADGES (keep for compatibility)
          const badge1 = document.getElementById('badge-pending');
          const badge2 = document.getElementById('badge-scheduled');
          const badge3 = document.getElementById('badge-residents');
          const badge4 = document.getElementById('badge-guests');
          const badge5 = document.getElementById('badge-agreements-completed');
          const badge6 = document.getElementById('badge-agreements-pending');

          if (badge1) badge1.textContent = `Pending: ${requestCounts.pending}`;
          if (badge2) badge2.textContent = `Scheduled: ${requestCounts.scheduled}`;
          if (badge3) badge3.textContent = `Residents: ${artistCount || 0}`;
          if (badge4) badge4.textContent = `Guests: 0`;
          if (badge5) badge5.textContent = `Open Requests: ${requestCounts.open_request}`;
          if (badge6) badge6.textContent = `Today's Events: ${todayAppointments}`;

          // 7. UPDATE DASHBOARD CHARTS
          ProgressBar.updateProgress(80, 'Rendering charts...');
          updateRequestStatusBreakdown(requestCounts, allRequests?.length || 0);
          updateAppointmentStatusBreakdown(appointmentCounts, allAppointments?.length || 0);

          // 8. Load project overview KPIs
          ProgressBar.updateProgress(90, 'Loading project metrics...');
          await loadProjectOverviewKPIs();

          console.log('âœ… Dashboard statistics loaded successfully');
          ProgressBar.hide();

        } catch(err) {
          console.error("âŒ Dashboard error:", err);
          ProgressBar.hide();
        }
      }

      // ============================================
      // PINNED EVENTS - LOAD FROM SUPABASE
      // ============================================
      async function loadPinnedEvents() {
        console.log('ðŸ“ Loading Pinned Events...');

        const container = document.getElementById('pinnedEventsContainer');
        if (!container) return;

        try {
          const { data: events, error } = await supabase
            .from('pinned_events')
            .select('*')
            .eq('is_active', true)
            .order('date', { ascending: true });

          if (error) throw error;

          if (!events || events.length === 0) {
            container.innerHTML = '<div class="event-empty">Keine Events vorhanden</div>';
            return;
          }

          const eventsHTML = events.map(event => {
            const eventDate = new Date(event.date);
            const formattedDate = eventDate.toLocaleDateString('de-DE', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            });
            const formattedTime = eventDate.toLocaleTimeString('de-DE', {
              hour: '2-digit',
              minute: '2-digit'
            });

            return `
              <div class="event-item">
                <div class="event-title">${event.title}</div>
                <div class="event-meta">
                  <span>ðŸ“… ${formattedDate} ${formattedTime}</span>
                  ${event.badge ? `<span class="event-badge">${event.badge}</span>` : ''}
                </div>
              </div>
            `;
          }).join('');

          container.innerHTML = eventsHTML;
          console.log('âœ… Loaded', events.length, 'pinned events');

        } catch (err) {
          console.error('âŒ Error loading pinned events:', err);
          container.innerHTML = '<div class="event-empty">Fehler beim Laden der Events</div>';
        }
      }

      // ============================================
      // SCHWARZES BRETT - LOAD FROM SUPABASE
      // ============================================
      async function loadSchwarzesBrett() {
        console.log('ðŸ“‹ Loading Schwarzes Brett...');

        const container = document.getElementById('brettMessages');
        if (!container) return;

        try {
          const { data: messages, error } = await supabase
            .from('schwarzes_brett')
            .select('*')
            .eq('is_active', true)
            .order('created_at', { ascending: false })
            .limit(10);

          if (error) throw error;

          if (!messages || messages.length === 0) {
            container.innerHTML = '<div class="brett-empty">Keine Nachrichten vorhanden</div>';
            return;
          }

          const messagesHTML = messages.map(msg => {
            const createdDate = new Date(msg.created_at);
            const timeAgo = getTimeAgo(createdDate);

            return `
              <div class="brett-item">
                <div class="brett-header">
                  <span class="brett-author">${msg.author}</span>
                  <span class="brett-time">${timeAgo}</span>
                </div>
                <div class="brett-content">${msg.content}</div>
                <div class="brett-footer">
                  <span class="brett-tag">${msg.category}</span>
                  <span class="brett-tag">ðŸ“ ${msg.location}</span>
                </div>
              </div>
            `;
          }).join('');

          container.innerHTML = messagesHTML;
          console.log('âœ… Loaded', messages.length, 'messages');

        } catch (err) {
          console.error('âŒ Error loading schwarzes brett:', err);
          container.innerHTML = '<div class="brett-empty">Fehler beim Laden der Nachrichten</div>';
        }
      }

      // ============================================
      // HELPER: TIME AGO
      // ============================================
      function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Gerade eben';
        if (diffMins < 60) return `vor ${diffMins} Min`;
        if (diffHours < 24) return `vor ${diffHours} Std`;
        if (diffDays === 1) return 'Gestern';
        if (diffDays < 7) return `vor ${diffDays} Tagen`;

        return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }

      // ============================================
      // SCHWARZES BRETT - ADD NEW MESSAGE
      // ============================================
      async function addNewMessage(content, category, location) {
        console.log('ðŸ“ Adding new message...');

        try {
          // Get current user
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) {
            alert('Du musst angemeldet sein, um eine Nachricht zu posten.');
            return;
          }

          // Get user profile for author name
          const { data: profile } = await supabase
            .from('profiles')
            .select('name')
            .eq('id', user.id)
            .single();

          const authorName = profile?.name || 'Anonymous';

          const { error } = await supabase
            .from('schwarzes_brett')
            .insert([{
              author: authorName,
              author_id: user.id,
              content: content,
              category: category,
              location: location,
              is_active: true
            }]);

          if (error) throw error;

          console.log('âœ… Message added successfully');

          // Reload messages
          await loadSchwarzesBrett();

          // Close popup and reset form
          document.getElementById('newMessagePopup').classList.remove('active');
          document.getElementById('messageContent').value = '';

        } catch (err) {
          console.error('âŒ Error adding message:', err);
          alert('Fehler beim HinzufÃ¼gen der Nachricht: ' + err.message);
        }
      }

      // ============================================
      // EVENT LISTENERS FOR SCHWARZES BRETT
      // ============================================
      document.getElementById('addMessageBtn')?.addEventListener('click', function() {
        document.getElementById('newMessagePopup').classList.add('active');
      });

      document.getElementById('closePopupBtn')?.addEventListener('click', function() {
        document.getElementById('newMessagePopup').classList.remove('active');
      });

      document.getElementById('submitMessageBtn')?.addEventListener('click', async function() {
        const content = document.getElementById('messageContent').value.trim();
        const category = document.getElementById('messageCategory').value;
        const location = document.getElementById('messageLocation').value;

        if (!content) {
          alert('Bitte gib eine Nachricht ein.');
          return;
        }

        await addNewMessage(content, category, location);
      });

      // ============================================
      // UPDATE REQUEST STATUS BREAKDOWN CHART (PIE)
      // ============================================
      function updateRequestStatusBreakdown(counts, total) {
        console.log('ðŸ“Š Updating request status breakdown');

        const container = document.getElementById('requestStatusChart');

        if (!container) {
          console.warn('âš ï¸ Request status chart container not found');
          return;
        }

        // Prepare data for pie chart
        const statusData = [
          { key: 'archived', label: 'Archived', color: '#8E8E93', count: counts.archived || 0 },
          { key: 'finished', label: 'Finished', color: '#34C759', count: counts.finished || 0 },
          { key: 'open_request', label: 'Open Request', color: '#FFA500', count: counts.open_request || 0 },
          { key: 'scheduled', label: 'Scheduled', color: '#007AFF', count: counts.scheduled || 0 },
          { key: 'canceled', label: 'Canceled', color: '#FF3B30', count: counts.canceled || 0 },
          { key: 'pending', label: 'Pending', color: '#FFCC00', count: counts.pending || 0 }
        ];

        // Filter and sort
        const filteredData = statusData.filter(s => s.count > 0).sort((a, b) => b.count - a.count);

        // Generate legend
        const legendItems = filteredData.map(s => {
          const percentage = ((s.count / total) * 100).toFixed(1);
          return `
            <div style="display: flex; align-items: center; gap: 10px; font-size: 13px; padding: 4px 0;">
              <span style="width: 12px; height: 12px; background: ${s.color}; border-radius: 50%; flex-shrink: 0;"></span>
              <span style="flex: 1;">${s.label}: <strong>${s.count.toLocaleString('de-DE')}</strong> (${percentage}%)</span>
            </div>
          `;
        }).join('');

        container.innerHTML = `
          <div style="margin-bottom: 16px;">
            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #1d1d1f;">
              Request Status Breakdown
            </h3>
            <p style="margin: 0; font-size: 14px; color: #86868b;">
              ${total.toLocaleString('de-DE')} Total Requests
            </p>
          </div>

          <div style="position: relative; width: 300px; max-width: 300px; height: 300px; margin: 0 auto 20px;">
            <canvas id="requestStatusPieCanvas" width="300" height="300" style="display: block; box-sizing: border-box;"></canvas>
          </div>

          <div style="display: flex; flex-direction: column; gap: 4px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.1);">
            ${legendItems}
          </div>
        `;

        // Create pie chart after DOM is ready
        requestAnimationFrame(() => {
          const canvas = document.getElementById('requestStatusPieCanvas');
          if (!canvas) {
            console.error('âŒ Request status pie canvas not found after render');
            return;
          }

          console.log('âœ… Creating request status pie chart with', filteredData.length, 'segments');

          if (requestStatusChartInstance) {
            requestStatusChartInstance.destroy();
          }

          try {
            requestStatusChartInstance = new Chart(canvas, {
              type: 'pie',
              data: {
                labels: filteredData.map(s => s.label),
                datasets: [{
                  data: filteredData.map(s => s.count),
                  backgroundColor: filteredData.map(s => s.color),
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${label}: ${value.toLocaleString('de-DE')} (${percentage}%)`;
                      }
                    }
                  }
                }
              }
            });
            console.log('âœ… Request status pie chart created successfully');
          } catch (error) {
            console.error('âŒ Error creating request status pie chart:', error);
          }
        });
      }

      // ============================================
      // UPDATE APPOINTMENT STATUS BREAKDOWN (PIE)
      // ============================================
      function updateAppointmentStatusBreakdown(counts, total) {
        console.log('ðŸ“Š Updating appointment status breakdown');

        const container = document.getElementById('appointmentStatusChart');

        if (!container) {
          console.warn('âš ï¸ Appointment status chart container not found');
          return;
        }

        // Prepare data for pie chart
        const statusData = [
          { key: 'finished', label: 'Finished', color: '#34C759', count: counts.finished || 0 },
          { key: 'scheduled', label: 'Scheduled', color: '#007AFF', count: counts.scheduled || 0 },
          { key: 'no_show', label: 'No Show', color: '#FF3B30', count: counts.no_show || 0 },
          { key: 'rescheduled', label: 'Rescheduled', color: '#FF9500', count: counts.rescheduled || 0 },
          { key: 'canceled', label: 'Canceled', color: '#FF2D55', count: counts.canceled || 0 },
          { key: 'reserved', label: 'Reserved', color: '#5856D6', count: counts.reserved || 0 },
          { key: 'unknown', label: 'Unknown', color: '#8E8E93', count: counts.unknown || 0 }
        ];

        // Filter and sort
        const filteredData = statusData.filter(s => s.count > 0).sort((a, b) => b.count - a.count);

        // Generate legend
        const legendItems = filteredData.map(s => {
          const percentage = ((s.count / total) * 100).toFixed(1);
          return `
            <div style="display: flex; align-items: center; gap: 10px; font-size: 13px; padding: 4px 0;">
              <span style="width: 12px; height: 12px; background: ${s.color}; border-radius: 50%; flex-shrink: 0;"></span>
              <span style="flex: 1;">${s.label}: <strong>${s.count.toLocaleString('de-DE')}</strong> (${percentage}%)</span>
            </div>
          `;
        }).join('');

        container.innerHTML = `
          <div style="margin-bottom: 16px;">
            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #1d1d1f;">
              Appointment Status Breakdown
            </h3>
            <p style="margin: 0; font-size: 14px; color: #86868b;">
              ${total.toLocaleString('de-DE')} Total Appointments
            </p>
          </div>

          <div style="position: relative; width: 300px; max-width: 300px; height: 300px; margin: 0 auto 20px;">
            <canvas id="appointmentStatusPieCanvas" width="300" height="300" style="display: block; box-sizing: border-box;"></canvas>
          </div>

          <div style="display: flex; flex-direction: column; gap: 4px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.1);">
            ${legendItems}
          </div>
        `;

        // Create pie chart after DOM is ready
        requestAnimationFrame(() => {
          const canvas = document.getElementById('appointmentStatusPieCanvas');
          if (!canvas) {
            console.error('âŒ Appointment status pie canvas not found after render');
            return;
          }

          console.log('âœ… Creating appointment status pie chart with', filteredData.length, 'segments');

          if (appointmentStatusChartInstance) {
            appointmentStatusChartInstance.destroy();
          }

          try {
            appointmentStatusChartInstance = new Chart(canvas, {
              type: 'pie',
              data: {
                labels: filteredData.map(s => s.label),
                datasets: [{
                  data: filteredData.map(s => s.count),
                  backgroundColor: filteredData.map(s => s.color),
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${label}: ${value.toLocaleString('de-DE')} (${percentage}%)`;
                      }
                    }
                  }
                }
              }
            });
            console.log('âœ… Appointment status pie chart created successfully');
          } catch (error) {
            console.error('âŒ Error creating appointment status pie chart:', error);
          }
        });
      }

      // ============================================
      // PROJECT OVERVIEW KPIs (Dashboard only)
      // ============================================
      async function loadProjectOverviewKPIs() {
        console.log('ðŸ“¦ Loading Project Overview KPIs for Dashboard...');

        try {
          const { data: appointments, error } = await supabase
            .from('appointments')
            .select(`
              id,
              project_number,
              customer_id,
              status,
              payment_amount,
              total_amount
            `)
            .not('project_number', 'is', null)
            .not('customer_id', 'is', null);

          if (error) throw error;

          // Calculate metrics
          const metrics = window.calculateProjectMetrics(appointments || []);

          // Update ONLY KPI cards on dashboard
          const kpiContainer = document.getElementById('projectKPIs');
          if (kpiContainer) {
            kpiContainer.innerHTML = `
              <div class="kpi-grid">
                <div class="kpi-card">
                  <div class="kpi-icon">ðŸ“¦</div>
                  <div class="kpi-content">
                    <div class="kpi-value">${metrics.totalProjects.toLocaleString()}</div>
                    <div class="kpi-label">Total Projects</div>
                  </div>
                </div>

                <div class="kpi-card active">
                  <div class="kpi-icon">ðŸ”„</div>
                  <div class="kpi-content">
                    <div class="kpi-value">${metrics.activeProjects.toLocaleString()}</div>
                    <div class="kpi-label">Active Projects</div>
                  </div>
                </div>

                <div class="kpi-card completed">
                  <div class="kpi-icon">âœ…</div>
                  <div class="kpi-content">
                    <div class="kpi-value">${metrics.completedProjects.toLocaleString()}</div>
                    <div class="kpi-label">Completed Projects</div>
                  </div>
                </div>

                <div class="kpi-card revenue">
                  <div class="kpi-icon">ðŸ’°</div>
                  <div class="kpi-content">
                    <div class="kpi-value">â‚¬${metrics.totalRevenue.toLocaleString('de-DE', { maximumFractionDigits: 0 })}</div>
                    <div class="kpi-label">Total Revenue</div>
                  </div>
                </div>

                <div class="kpi-card">
                  <div class="kpi-icon">ðŸ“Š</div>
                  <div class="kpi-content">
                    <div class="kpi-value">${metrics.avgAppointmentsPerProject.toFixed(1)}</div>
                    <div class="kpi-label">Avg Sessions/Project</div>
                  </div>
                </div>

                <div class="kpi-card">
                  <div class="kpi-icon">âœ¨</div>
                  <div class="kpi-content">
                    <div class="kpi-value">${metrics.completionRate.toFixed(1)}%</div>
                    <div class="kpi-label">Completion Rate</div>
                  </div>
                </div>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error loading project overview KPIs:', error);
        }
      }

      // Helper function to get project status badge
      function getProjectStatusBadge(appointments) {
        const statuses = appointments.map(a => a.status);
        const allFinished = statuses.every(s => s === 'finished');
        const hasScheduled = statuses.some(s => s === 'scheduled');
        const allCanceled = statuses.every(s => s === 'canceled');

        if (allFinished) {
          return '<span class="project-status-badge completed">âœ… Completed</span>';
        } else if (allCanceled) {
          return '<span class="project-status-badge canceled">âŒ Canceled</span>';
        } else if (hasScheduled) {
          return '<span class="project-status-badge active">ðŸ”„ Active</span>';
        } else {
          return '<span class="project-status-badge completed">âœ… Completed</span>';
        }
      }

      window.loadProjectsTimelineChart = function loadProjectsTimelineChart(appointments) {
        const chartCanvas = document.getElementById('projectsTimelineChart');
        if (!chartCanvas) return;

        // Destroy existing chart
        if (projectsTimelineChartInstance) {
          projectsTimelineChartInstance.destroy();
          projectsTimelineChartInstance = null;
        }

        // Group projects by month
        const projectsByMonth = {};
        const processedProjects = new Set();

        appointments.forEach(apt => {
          if (!apt.start || !apt.project_number) return;
          if (processedProjects.has(apt.project_number)) return;

          const date = new Date(apt.start);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

          projectsByMonth[monthKey] = (projectsByMonth[monthKey] || 0) + 1;
          processedProjects.add(apt.project_number);
        });

        // Sort by date
        const sortedMonths = Object.keys(projectsByMonth).sort();
        const counts = sortedMonths.map(m => projectsByMonth[m]);

        // Create chart
        projectsTimelineChartInstance = new Chart(chartCanvas, {
          type: 'line',
          data: {
            labels: sortedMonths.map(m => {
              const [year, month] = m.split('-');
              return new Date(year, month - 1).toLocaleDateString('de-DE', {
                month: 'short',
                year: 'numeric'
              });
            }),
            datasets: [{
              label: 'New Projects',
              data: counts,
              borderColor: '#0071e3',
              backgroundColor: 'rgba(0, 113, 227, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: 'Projects Started Over Time',
                font: {
                  size: 16,
                  weight: '600',
                  family: "'Helvetica Neue', sans-serif"
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 100
                }
              }
            }
          }
        });
      }

      window.loadRevenueByMonthChart = function loadRevenueByMonthChart(appointments) {
        const chartCanvas = document.getElementById('revenueByMonthChart');
        if (!chartCanvas) return;

        // Destroy existing chart
        if (revenueByMonthChartInstance) {
          revenueByMonthChartInstance.destroy();
          revenueByMonthChartInstance = null;
        }

        // Group revenue by month
        const revenueByMonth = {};

        appointments.forEach(apt => {
          if (!apt.start) return;

          const date = new Date(apt.start);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

          const revenue = parseFloat(apt.payment_amount || apt.total_amount || 0);
          revenueByMonth[monthKey] = (revenueByMonth[monthKey] || 0) + revenue;
        });

        // Sort by date
        const sortedMonths = Object.keys(revenueByMonth).sort();
        const revenues = sortedMonths.map(m => revenueByMonth[m]);

        // Create chart
        revenueByMonthChartInstance = new Chart(chartCanvas, {
          type: 'bar',
          data: {
            labels: sortedMonths.map(m => {
              const [year, month] = m.split('-');
              return new Date(year, month - 1).toLocaleDateString('de-DE', {
                month: 'short',
                year: 'numeric'
              });
            }),
            datasets: [{
              label: 'Revenue (â‚¬)',
              data: revenues,
              backgroundColor: '#34c759',
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: 'Revenue by Month',
                font: {
                  size: 16,
                  weight: '600',
                  family: "'Helvetica Neue', sans-serif"
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'â‚¬' + value.toLocaleString('de-DE');
                  }
                }
              }
            }
          }
        });
      }

      window.loadTopArtistsChart = function loadTopArtistsChart(appointments) {
        const chartCanvas = document.getElementById('topArtistsChart');
        if (!chartCanvas) return;

        // Destroy existing chart
        if (topArtistsChartInstance) {
          topArtistsChartInstance.destroy();
          topArtistsChartInstance = null;
        }

        // Count unique projects per artist
        const artistProjects = {};
        const processedProjects = new Set();

        appointments.forEach(apt => {
          if (!apt.artist_id || !apt.project_number) return;

          const key = `${apt.artist_id}-${apt.project_number}`;
          if (processedProjects.has(key)) return;

          artistProjects[apt.artist_id] = (artistProjects[apt.artist_id] || 0) + 1;
          processedProjects.add(key);
        });

        // Sort and get top 10
        const sorted = Object.entries(artistProjects)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        if (sorted.length === 0) {
          if (chartCanvas.getContext) {
            chartCanvas.getContext('2d').clearRect(0, 0, chartCanvas.width, chartCanvas.height);
          }
          return;
        }

        // Fetch artist names
        fetchArtistNames(sorted.map(([id]) => id)).then(artistNames => {
          const labels = sorted.map(([id]) => artistNames[id] || 'Unknown');
          const counts = sorted.map(([, count]) => count);

          topArtistsChartInstance = new Chart(chartCanvas, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Projects',
                data: counts,
                backgroundColor: '#ff9500',
                borderRadius: 6
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: 'y',
              plugins: {
                legend: {
                  display: false
                },
                title: {
                  display: true,
                  text: 'Top Artists by Projects',
                  font: {
                    size: 16,
                    weight: '600',
                    family: "'Helvetica Neue', sans-serif"
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true
                }
              }
            }
          });
        });
      }

      async function fetchArtistNames(artistIds) {
        if (!artistIds || artistIds.length === 0) return {};

        const { data: artists } = await supabase
          .from('artists')
          .select('id, name')
          .in('id', artistIds);

        const nameMap = {};
        (artists || []).forEach(artist => {
          nameMap[artist.id] = artist.name;
        });

        return nameMap;
      }

      window.loadArtistPerformanceReport = async function loadArtistPerformanceReport() {
        console.log('ðŸ“Š Loading Artist Performance Report...');

        try {
          const { data: appointments, error } = await supabase
            .from('appointments')
            .select(`
              *
            `)
            .not('project_number', 'is', null);

          if (error) {
            console.error('Error:', error);
            return;
          }

          // Fetch all artists for name mapping
          const { data: artists } = await supabase
            .from('artists')
            .select('id, name, email');

          const artistMap = {};
          (artists || []).forEach(artist => {
            artistMap[artist.id] = artist;
          });

          // Group by artist
          const artistStats = {};

          (appointments || []).forEach(apt => {
            const artistId = apt.artist_id;
            if (!artistId) return;

            // Initialize
            if (!artistStats[artistId]) {
              artistStats[artistId] = {
                artist_name: artistMap[artistId]?.name || 'Unknown',
                total_appointments: 0,
                unique_projects: new Set(),
                total_revenue: 0,
                completed_projects: new Set(),
                active_projects: new Set()
              };
            }

            const stats = artistStats[artistId];
            stats.total_appointments++;
            stats.unique_projects.add(apt.project_number);

            // Revenue
            const revenue = parseFloat(apt.payment_amount || apt.total_amount || 0);
            stats.total_revenue += revenue;

            // Project status
            if (apt.status === 'finished') {
              stats.completed_projects.add(apt.project_number);
            } else if (apt.status === 'scheduled') {
              stats.active_projects.add(apt.project_number);
            }
          });

          // Convert to array and calculate final metrics
          const artistsArray = Object.values(artistStats).map(stats => ({
            artist_name: stats.artist_name,
            total_projects: stats.unique_projects.size,
            total_appointments: stats.total_appointments,
            total_revenue: stats.total_revenue,
            completed_projects: stats.completed_projects.size,
            active_projects: stats.active_projects.size,
            avg_revenue_per_project: stats.total_revenue / (stats.unique_projects.size || 1),
            completion_rate: stats.unique_projects.size > 0 ? (stats.completed_projects.size / stats.unique_projects.size) * 100 : 0
          }));

          // Sort by total revenue
          artistsArray.sort((a, b) => b.total_revenue - a.total_revenue);

          // Render table
          renderArtistPerformanceTable(artistsArray);
        } catch (error) {
          console.error('Error loading artist performance report:', error);
        }
      }

      function renderArtistPerformanceTable(artists) {
        const container = document.getElementById('artistPerformanceTable');
        if (!container) return;

        if (artists.length === 0) {
          container.innerHTML = '<p style="color: #86868b; text-align: center;">No artist data available</p>';
          return;
        }

        container.innerHTML = `
          <div class="performance-table-wrapper">
            <table class="performance-table">
              <thead>
                <tr>
                  <th>Artist</th>
                  <th>Projects</th>
                  <th>Appointments</th>
                  <th>Revenue</th>
                  <th>Avg/Project</th>
                  <th>Completed</th>
                  <th>Active</th>
                  <th>Completion %</th>
                </tr>
              </thead>
              <tbody>
                ${artists.map(artist => `
                  <tr>
                    <td class="artist-name">${artist.artist_name}</td>
                    <td>${artist.total_projects}</td>
                    <td>${artist.total_appointments}</td>
                    <td class="revenue">â‚¬${artist.total_revenue.toLocaleString('de-DE', { maximumFractionDigits: 0 })}</td>
                    <td>â‚¬${artist.avg_revenue_per_project.toLocaleString('de-DE', { maximumFractionDigits: 0 })}</td>
                    <td><span class="badge-success">${artist.completed_projects}</span></td>
                    <td><span class="badge-warning">${artist.active_projects}</span></td>
                    <td>${artist.completion_rate.toFixed(1)}%</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }

      window.loadMultiProjectCustomerReport = async function loadMultiProjectCustomerReport() {
        console.log('ðŸ‘¥ Loading Multi-Project Customer Report...');

        try {
          const { data: appointments } = await supabase
            .from('appointments')
            .select('*')
            .not('project_number', 'is', null)
            .not('customer_id', 'is', null);

          // Group by customer
          const customerStats = {};

          (appointments || []).forEach(apt => {
            const customerId = apt.customer_id;
            const customerKey = apt.customer_email || customerId;

            if (!customerStats[customerKey]) {
              customerStats[customerKey] = {
                customer_name: `${apt.first_name || ''} ${apt.last_name || ''}`.trim() || 'Unknown',
                customer_email: apt.customer_email,
                projects: new Set(),
                total_appointments: 0,
                total_spent: 0
              };
            }

            customerStats[customerKey].projects.add(apt.project_number);
            customerStats[customerKey].total_appointments++;
            customerStats[customerKey].total_spent += parseFloat(apt.payment_amount || apt.total_amount || 0);
          });

          // Filter multi-project customers
          const multiProjectCustomers = Object.values(customerStats)
            .filter(c => c.projects.size > 1)
            .map(c => ({
              ...c,
              projects: c.projects.size
            }))
            .sort((a, b) => b.projects - a.projects);

          console.log('Found', multiProjectCustomers.length, 'multi-project customers');

          renderMultiProjectCustomerTable(multiProjectCustomers);
        } catch (error) {
          console.error('Error loading multi-project customer report:', error);
        }
      }

      function renderMultiProjectCustomerTable(customers) {
        const container = document.getElementById('multiProjectCustomersTable');
        if (!container) return;

        if (customers.length === 0) {
          container.innerHTML = '<p style="color: #86868b; text-align: center;">No multi-project customers found</p>';
          return;
        }

        container.innerHTML = `
          <div class="stats-summary">
            <h3>ðŸŒŸ VIP Customers: ${customers.length} customers with multiple projects</h3>
          </div>
          <div class="performance-table-wrapper">
            <table class="performance-table">
              <thead>
                <tr>
                  <th>Customer</th>
                  <th>Email</th>
                  <th>Projects</th>
                  <th>Total Appointments</th>
                  <th>Total Spent</th>
                  <th>Avg per Project</th>
                </tr>
              </thead>
              <tbody>
                ${customers.map(customer => `
                  <tr>
                    <td class="customer-name">${customer.customer_name}</td>
                    <td>${customer.customer_email || '-'}</td>
                    <td><strong>${customer.projects}</strong></td>
                    <td>${customer.total_appointments}</td>
                    <td class="revenue">â‚¬${customer.total_spent.toLocaleString('de-DE', { maximumFractionDigits: 0 })}</td>
                    <td>â‚¬${(customer.total_spent / customer.projects).toLocaleString('de-DE', { maximumFractionDigits: 0 })}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }

      let allRequests = [];
      let currentRequestStatus = 'open_request';
      let currentRequestLocation = 'all'; // âœ… NEW: Track selected location filter
      let selectedRequestId = null;
      // currentUser is declared globally outside this scope

      async function loadRequests() {
        try {
          ProgressBar.show('Loading requests...');
          console.log('ðŸ“‹ Loading requests for status:', currentRequestStatus, 'location:', currentRequestLocation);

          ProgressBar.updateProgress(30, 'Fetching requests from database...');
          const { data, error } = await supabase
            .from('requests')
            .select(`
              *,
              customer:customers(id, first_name, last_name, email, phone, rank, instagram),
              artist:artists(id, name, email, instagram),
              location:locations(id, name, city)
            `)
            .order('created_at', { ascending: false });

          if (error) throw error;

          allRequests = data || [];
          console.log('âœ… Loaded', allRequests.length, 'requests');
          ProgressBar.updateProgress(70, 'Filtering and rendering...');

          // Filter by status
          let filteredRequests = allRequests;
          if (currentRequestStatus === 'my-requests') {
            // Filter by assigned user
            filteredRequests = allRequests.filter(r =>
              r.assigned_to_user_id === currentUser?.id ||
              r.assigned_to === currentUser?.username
            );
          } else if (currentRequestStatus !== 'all') {
            filteredRequests = allRequests.filter(r => r.status === currentRequestStatus);
          }

          // âœ… NEW: Filter by location
          if (currentRequestLocation !== 'all') {
            filteredRequests = filteredRequests.filter(r => {
              const locationName = (r.location?.name || '').toLowerCase();

              if (currentRequestLocation === 'mommy') {
                return locationName.includes('mommy');
              } else if (currentRequestLocation === 'gon') {
                return locationName.includes('gon');
              } else if (currentRequestLocation === 'muttersohne') {
                return locationName.includes('muttersÃ¶hne') || locationName.includes('muttersohne');
              } else if (currentRequestLocation === 'pardon') {
                return locationName.includes('pardon');
              }
              return true;
            });
          }

          console.log('ðŸ“Š Filtered to', filteredRequests.length, 'requests for status:', currentRequestStatus, 'location:', currentRequestLocation);
          renderRequestsList(filteredRequests);
          updateRequestBadges();
          ProgressBar.hide();
        } catch(err) {
          console.error("âŒ Requests error:", err);
          ProgressBar.hide();
          document.getElementById('requestsList').innerHTML = `
            <div style="text-align:center; padding:40px; color:#E53935;">
              <div style="font-size:48px; margin-bottom:16px;">âš ï¸</div>
              <div style="font-size:16px; font-weight:600; margin-bottom:8px;">Fehler beim Laden</div>
              <div style="font-size:14px; color:var(--muted);">${err.message}</div>
            </div>
          `;
        }
      }
      
      function renderRequestsList(requests) {
        const listEl = document.getElementById('requestsList');
        
        // Check if viewing "My Requests" without being logged in
        if (currentRequestStatus === 'my-requests' && !currentUser) {
          listEl.innerHTML = `
            <div style="text-align:center; padding:60px 20px; color:var(--muted);">
              <div style="font-size:48px; margin-bottom:16px;">ðŸ”’</div>
              <div style="font-size:18px; font-weight:600; margin-bottom:8px; color:var(--ink);">Nicht angemeldet</div>
              <div style="font-size:14px;">Bitte melden Sie sich an, um Ihre zugewiesenen Requests zu sehen.</div>
            </div>
          `;
          return;
        }
        
        if (requests.length === 0) {
          let emptyMessage = 'No requests found';
          if (currentRequestStatus === 'my-requests') {
            emptyMessage = 'Sie haben keine zugewiesenen Requests';
          } else if (currentRequestStatus === 'open_request') {
            emptyMessage = 'Keine neuen Requests';
          } else if (currentRequestStatus === 'pending') {
            emptyMessage = 'Keine Requests in Bearbeitung';
          } else if (currentRequestStatus === 'scheduled') {
            emptyMessage = 'Keine geplanten Termine';
          } else if (currentRequestStatus === 'finished') {
            emptyMessage = 'Keine abgeschlossenen Requests';
          } else if (currentRequestStatus === 'canceled') {
            emptyMessage = 'Keine stornierten Requests';
          } else if (currentRequestStatus === 'archived') {
            emptyMessage = 'Keine archivierten Requests';
          }

          listEl.innerHTML = `<div style="text-align:center; padding:40px; color:var(--muted);">${emptyMessage}</div>`;
          return;
        }
        
        // Status display names mapping
        const statusNames = {
          'open_request': 'New',
          'pending': 'Pending',
          'scheduled': 'Scheduled',
          'finished': 'Finished',
          'canceled': 'Canceled'
        };
        
        listEl.innerHTML = requests.map(req => {
          // Get customer name directly from requests table (first_name, last_name columns)
          const customerName = `${req.first_name || ''} ${req.last_name || ''}`.trim() || 'Unbekannt';

          // Customer rank badge
          const rankBadge = req.customer?.rank
            ? `<span class="rank-badge rank-${req.customer.rank.toLowerCase()}">${req.customer.rank}</span>`
            : '';

          // Location badge
          const locationBadge = req.location?.name
            ? `<span style="font-size:11px; color:var(--muted);">ðŸ“ ${req.location.name}</span>`
            : '';

          // Request number or ID
          const requestNumber = req.request_number || `#${req.id.substring(0, 8).toUpperCase()}`;

          // Priority badge
          const priorityBadge = req.priority && req.priority !== 'normal'
            ? `<span class="priority-badge ${req.priority}">
                ${req.priority === 'urgent' ? 'ðŸ”¥' : req.priority === 'high' ? 'âš¡' : req.priority === 'low' ? 'ðŸ’¤' : ''}
                ${req.priority.toUpperCase()}
              </span>`
            : '';

          // Instagram badge (from customer relation or request field)
          const instagram = req.customer?.instagram || req.instagram;
          const instagramBadge = instagram
            ? `<span style="font-size:11px; color:var(--muted);">ðŸ“· @${instagram.replace('@', '')}</span>`
            : '';

          // Reference images indicator
          const hasImages = req.reference_images && req.reference_images.length > 0;
          const imagesBadge = hasImages
            ? `<span style="font-size:11px; color:var(--accent);">ðŸ–¼ï¸ ${req.reference_images.length} ${req.reference_images.length === 1 ? 'Bild' : 'Bilder'}</span>`
            : '';

          // Artist preference tags
          const artistPreferenceTags = req.artist_preference && req.artist_preference.trim()
            ? req.artist_preference.split(',')
                .map(name => name.trim())
                .filter(name => name.length > 0)
                .map(name => `<span class="artist-tag-small">${name}</span>`)
                .join('')
            : '';

          return `
            <div class="request-item ${req.status === 'open_request' ? 'new-status' : ''}" data-id="${req.id}">
              <div class="request-header">
                <div class="request-id">${requestNumber}</div>
                <div style="display:flex; gap:6px; align-items:center;">
                  ${priorityBadge}
                  <div class="request-badge ${req.status}">${statusNames[req.status] || req.status}</div>
                </div>
              </div>
              <div class="request-name">
                ${customerName}
                ${rankBadge}
              </div>
              ${req.placement ? `<div style="font-size:12px; color:var(--muted); margin-top:4px;">ðŸ“ ${req.placement}</div>` : ''}
              <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;">
                ${locationBadge}
                ${instagramBadge}
                ${imagesBadge}
              </div>
              ${artistPreferenceTags ? `
                <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:8px;">
                  ${artistPreferenceTags}
                </div>
              ` : ''}
              <div class="request-date">${new Date(req.created_at).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
            </div>
          `;
        }).join('');
        
        // Add click handlers with toggle functionality
        document.querySelectorAll('.request-item').forEach(item => {
          item.addEventListener('click', () => {
            const isAlreadyActive = item.classList.contains('active');
            
            // Remove active class from all items
            document.querySelectorAll('.request-item').forEach(i => i.classList.remove('active'));
            
            if (isAlreadyActive) {
              // If clicking on already active item, close detail view
              selectedRequestId = null;
              closeRequestDetail();
            } else {
              // Otherwise, open the clicked item
              item.classList.add('active');
              selectedRequestId = item.dataset.id;
              showRequestDetail(selectedRequestId);
            }
          });
        });
      }
      
      function closeRequestDetail() {
        const detailEl = document.getElementById('requestDetail');
        detailEl.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--muted); font-size:16px;">
            Select a request to view details
          </div>
        `;
      }
      
      function showRequestDetail(requestId) {
        const request = allRequests.find(r => r.id === requestId);
        if (!request) return;

        console.log('ðŸ“‹ Showing request detail:', request);

        const detailEl = document.getElementById('requestDetail');

        // Status display names
        const statusNames = {
          'open_request': 'New',
          'pending': 'Pending',
          'scheduled': 'Scheduled',
          'finished': 'Finished',
          'canceled': 'Canceled'
        };

        // Get customer data directly from requests table (first_name, last_name, email, customer_phone columns)
        // Use customer relation only for rank and instagram
        const customer = {
          first_name: request.first_name,
          last_name: request.last_name,
          email: request.email,
          phone: request.customer_phone,
          rank: request.customer?.rank || null,
          instagram: request.customer?.instagram || request.instagram || null
        };

        const customerName = `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unbekannt';

        // Rank badge styling
        const rankBadgeStyle = customer.rank ? {
          'Platinum': 'background:#FFD700; color:#1d1d1f;',
          'Gold': 'background:#FF8C00; color:white;',
          'Silver': 'background:#C0C0C0; color:#1d1d1f;',
          'Bronze': 'background:#CD7F32; color:white;'
        }[customer.rank] || '' : '';

        let actions = '';

        // Show Edit button only in "My Requests" tab
        if (currentRequestStatus === 'my-requests') {
          actions = `<button class="btn" onclick="editRequest('${request.id}')" style="background:var(--ink); color:white; border:none;">Edit Request</button>`;
        } else {
          // Show status-based actions for other tabs
          if (request.status === 'open_request') {
            actions = `<button class="btn" onclick="assignRequest()" style="background:var(--ink); color:white; border:none;">Assign to Team Member</button>`;
          } else if (request.status === 'pending') {
            actions = `<button class="btn" onclick="scheduleAppointment()" style="background:var(--ink); color:white; border:none;">Schedule Appointment</button>`;
          } else if (request.status === 'scheduled') {
            actions = `
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn" onclick="editAppointment()" style="background:var(--ink); color:white; border:none; flex:1; min-width:140px;">Edit Appointment</button>
                <button class="btn" onclick="resetAppointment()" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1); flex:1; min-width:140px;">Reset</button>
                <button class="btn" onclick="cancelAppointmentRequest()" style="background:#ff9500; color:white; border:none; flex:1; min-width:140px;">Cancel</button>
                <button class="btn" onclick="deleteRequest()" style="background:#dc3545; color:white; border:none; flex:1; min-width:140px;">Delete</button>
              </div>
            `;
          }
        }

        detailEl.innerHTML = `
          <div style="margin-bottom:24px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
              <h2 style="margin:0; font-size:24px; font-weight:600;">
                ${request.request_number || `#${request.id.substring(0, 8).toUpperCase()}`}
              </h2>
              <span class="request-badge ${request.status}" style="font-size:13px; padding:6px 16px;">
                ${statusNames[request.status] || request.status}
              </span>
            </div>
            ${request.location ? `
              <div style="color:var(--muted); font-size:14px;">
                ðŸ“ ${request.location.name}${request.location.city ? ` (${request.location.city})` : ''}
              </div>
            ` : ''}
          </div>

          <div class="detail-section">
            <h3>Customer Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Vorname</div>
                <div class="detail-value">${customer.first_name || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Nachname</div>
                <div class="detail-value">
                  ${customer.last_name || '<span class="no-data-placeholder">No entry data</span>'}
                  ${customer.rank ? `
                    <span style="display:inline-block; margin-left:8px; padding:4px 10px; border-radius:999px; font-size:11px; font-weight:600; ${rankBadgeStyle}">
                      ${customer.rank}
                    </span>
                  ` : ''}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Email</div>
                <div class="detail-value">
                  ${customer.email ? `<a href="mailto:${customer.email}" style="color:var(--accent);">${customer.email}</a>` : '<span class="no-data-placeholder">No entry data</span>'}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Phone</div>
                <div class="detail-value">
                  ${customer.phone ? `<a href="tel:${customer.phone}" style="color:var(--accent);">${customer.phone}</a>` : '<span class="no-data-placeholder">No entry data</span>'}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Instagram</div>
                <div class="detail-value">
                  ${customer.instagram ? `<a href="https://instagram.com/${customer.instagram}" target="_blank" style="color:var(--accent);">@${customer.instagram}</a>` : '<span class="no-data-placeholder">No entry data</span>'}
                </div>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <h3>Request Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Priority</div>
                <div class="detail-value">
                  ${request.priority ? `
                    <span class="priority-badge ${request.priority}">
                      ${request.priority === 'urgent' ? 'ðŸ”¥' : request.priority === 'high' ? 'âš¡' : request.priority === 'normal' ? 'âœ“' : 'ðŸ’¤'}
                      ${request.priority.toUpperCase()}
                    </span>
                  ` : '<span class="no-data-placeholder">No entry data</span>'}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Placement</div>
                <div class="detail-value">${request.placement || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Size</div>
                <div class="detail-value">${request.size || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Style</div>
                <div class="detail-value">${request.style || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Colorway</div>
                <div class="detail-value">${request.colorway || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Booking Type</div>
                <div class="detail-value">${request.booking_type || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Origin</div>
                <div class="detail-value">${request.origin || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
            </div>

            <div class="detail-item" style="margin-top:16px;">
              <div class="detail-label">Artist PrÃ¤ferenz</div>
              <div class="detail-value">
                ${request.artist_preference && request.artist_preference.trim() ? `
                  <div class="artist-preference-tags">
                    ${request.artist_preference.split(',')
                      .map(name => name.trim())
                      .filter(name => name.length > 0)
                      .map(name => `<span class="artist-tag">${name}</span>`)
                      .join('')}
                  </div>
                ` : '<span class="no-data-placeholder">No entry data</span>'}
              </div>
            </div>

            <div class="detail-item" style="margin-top:16px;">
              <div class="detail-label">Description</div>
              <div class="detail-value" style="white-space:pre-wrap;">${request.description || '<span class="no-data-placeholder">No entry data</span>'}</div>
            </div>

            <div class="detail-item" style="margin-top:16px;">
              <div class="detail-label">Reference Images${request.reference_images && request.reference_images.length > 0 ? ` (${request.reference_images.length})` : ''}</div>
              <div class="detail-value">
                ${request.reference_images && request.reference_images.length > 0 ? `
                  <div class="reference-images">
                    ${request.reference_images.map((img, idx) => `
                      <div class="reference-image-thumb" onclick="openImageModal('${img}')">
                        <img src="${img}" alt="Reference ${idx + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                      </div>
                    `).join('')}
                  </div>
                ` : '<span class="no-data-placeholder">No entry data</span>'}
              </div>
            </div>
          </div>

          ${request.artist || request.assigned_to ? `
            <div class="detail-section">
              <h3>Assignment</h3>
              <div class="detail-grid">
                ${request.artist ? `
                  <div class="detail-item">
                    <div class="detail-label">Artist</div>
                    <div class="detail-value">
                      ${request.artist.name}
                      ${request.artist.email ? `<br/><small style="color:var(--muted);">${request.artist.email}</small>` : ''}
                      ${request.artist.instagram ? `<br/><a href="https://instagram.com/${request.artist.instagram}" target="_blank" style="color:var(--accent); font-size:13px;">@${request.artist.instagram}</a>` : ''}
                    </div>
                  </div>
                ` : request.assigned_to ? `
                  <div class="detail-item">
                    <div class="detail-label">Assigned To</div>
                    <div class="detail-value">${request.assigned_to}</div>
                  </div>
                ` : ''}
              </div>
            </div>
          ` : ''}

          ${request.scheduled_date || request.payment_status ? `
            <div class="detail-section">
              <h3>Appointment & Payment</h3>
              <div class="detail-grid">
                ${request.scheduled_date ? `
                  <div class="detail-item">
                    <div class="detail-label">Scheduled Date</div>
                    <div class="detail-value">${new Date(request.scheduled_date).toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                  </div>
                ` : ''}
                ${request.start_time ? `
                  <div class="detail-item">
                    <div class="detail-label">Start Time</div>
                    <div class="detail-value">${request.start_time}</div>
                  </div>
                ` : ''}
                ${request.end_time ? `
                  <div class="detail-item">
                    <div class="detail-label">End Time</div>
                    <div class="detail-value">${request.end_time}</div>
                  </div>
                ` : ''}
                ${request.payment_status ? `
                  <div class="detail-item">
                    <div class="detail-label">Payment Status</div>
                    <div class="detail-value">
                      <span style="padding:4px 12px; border-radius:999px; font-size:12px; font-weight:500; ${
                        request.payment_status === 'fully_paid' ? 'background:#D1FAE5; color:#065F46;' :
                        request.payment_status === 'deposit_paid' ? 'background:#DBEAFE; color:#1E40AF;' :
                        request.payment_status === 'refunded' ? 'background:#FEE2E2; color:#991B1B;' :
                        'background:#FEF3C7; color:#92400E;'
                      }">
                        ${request.payment_status}
                      </span>
                    </div>
                  </div>
                ` : ''}
                ${request.total_amount ? `
                  <div class="detail-item">
                    <div class="detail-label">Total Amount</div>
                    <div class="detail-value">${request.total_amount}â‚¬</div>
                  </div>
                ` : ''}
              </div>
            </div>
          ` : ''}

          ${request.cancel_reason ? `
            <div class="detail-section">
              <h3>Cancellation</h3>
              <div class="detail-item">
                <div class="detail-label">Reason</div>
                <div class="detail-value">${request.cancel_reason}</div>
              </div>
            </div>
          ` : ''}

          ${request.notes ? `
            <div class="detail-section">
              <h3>Notes</h3>
              <div class="detail-value" style="white-space:pre-wrap;">${request.notes}</div>
            </div>
          ` : ''}

          <div class="detail-section">
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Created At</div>
                <div class="detail-value">${new Date(request.created_at).toLocaleString('de-DE')}</div>
              </div>
              ${request.updated_at && request.updated_at !== request.created_at ? `
                <div class="detail-item">
                  <div class="detail-label">Updated At</div>
                  <div class="detail-value">${new Date(request.updated_at).toLocaleString('de-DE')}</div>
                </div>
              ` : ''}
            </div>
          </div>

          ${actions ? `<div class="action-buttons">${actions}</div>` : ''}

          <!-- Payment Workflow Section -->
          ${request.status === 'pending' && !request.stripe_payment_link ? `
            <div style="margin-top:24px;">
              <button onclick="openPaymentWorkflowModal('${request.id}')"
                      class="btn"
                      style="background:var(--macos-accent-green); color:white; width:100%; padding:14px; border-radius:10px; font-weight:600; cursor:pointer; transition:all 0.2s; border:none; font-size:14px;"
                      onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(52,199,89,0.3)';"
                      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                ðŸ’³ Zahlungsabwicklung starten
              </button>
            </div>
          ` : ''}

          ${request.stripe_payment_link ? `
            <div style="background:rgba(52,199,89,0.1); padding:16px; border-radius:10px; margin-top:24px; border:1px solid rgba(52,199,89,0.3);">
              <div style="display:flex; align-items:start; gap:12px;">
                <span style="font-size:24px;">âœ…</span>
                <div style="flex:1;">
                  <div style="font-size:15px; font-weight:600; color:var(--macos-accent-green); margin-bottom:6px;">Zahlungslink versendet</div>
                  <div style="font-size:13px; color:var(--macos-text-secondary); margin-bottom:8px;">
                    ${request.payment_link_sent_at ? 'Versendet am: ' + new Date(request.payment_link_sent_at).toLocaleString('de-DE') : ''}
                  </div>
                  <div style="font-size:12px; margin-top:8px;">
                    <a href="${request.stripe_payment_link}" target="_blank" style="color:var(--macos-accent-blue); text-decoration:none; word-break:break-all;">
                      ðŸ”— ${request.stripe_payment_link}
                    </a>
                  </div>
                  ${request.total_price ? `
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(52,199,89,0.2);">
                      <div style="font-size:13px; color:var(--macos-text-secondary); margin-bottom:4px;">
                        <strong>Gesamtpreis:</strong> â‚¬${request.total_price.toFixed(2)}
                      </div>
                      ${request.deposit_amount ? `
                        <div style="font-size:13px; color:var(--macos-text-secondary);">
                          <strong>Terminkaution (50%):</strong> â‚¬${request.deposit_amount.toFixed(2)}
                        </div>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
          ` : ''}
        `;
      }
      
      function updateRequestBadges() {
        const newCount = allRequests.filter(r => r.status === 'open_request').length;
        const badgeEl = document.getElementById('badge-new');
        if (badgeEl) {
          badgeEl.textContent = newCount;
          badgeEl.style.display = newCount > 0 ? 'inline-block' : 'none';
        }
      }
      
      // Request Tab Switching is handled in initRequestTabs()
      
      // Assign Request
      window.assignRequest = async function() {
        // Load all users with 'Booking Team' role from profiles
        const { data: bookingTeam } = await supabase
          .from('profiles')
          .select('id, username')
          .eq('role', 'Booking Team');

        const teamMemberSelect = document.getElementById('assignTeamMember');
        teamMemberSelect.innerHTML = '<option value="">-- Select Team Member --</option>' +
          (bookingTeam || []).map(m => `<option value="${m.id}">${m.username}</option>`).join('');

        document.getElementById('assignModal').classList.add('active');
      };
      
      document.getElementById('cancelAssign')?.addEventListener('click', () => {
        document.getElementById('assignModal').classList.remove('active');
      });
      
      document.getElementById('assignForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const userId = document.getElementById('assignTeamMember').value;

        // Get username for display
        const { data: user } = await supabase
          .from('profiles')
          .select('username')
          .eq('id', userId)
          .single();

        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'pending',
              assigned_to_user_id: userId,
              assigned_to: user?.username || 'Unknown' // For display purposes
            })
            .eq('id', selectedRequestId);

          if (error) throw error;

          document.getElementById('assignModal').classList.remove('active');
          document.getElementById('assignForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('Request assigned successfully!');
        } catch (err) {
          alert('Error assigning request: ' + err.message);
        }
      });
      
      // Schedule Appointment
      window.scheduleAppointment = async function() {
        // Load artists
        const { data: artists } = await supabase.from('artists').select('*');
        const artistSelect = document.getElementById('scheduleArtist');
        artistSelect.innerHTML = '<option value="">-- Select Artist --</option>' +
          (artists || []).map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        
        document.getElementById('scheduleModal').classList.add('active');
      };
      
      document.getElementById('cancelSchedule')?.addEventListener('click', () => {
        document.getElementById('scheduleModal').classList.remove('active');
      });
      
      document.getElementById('scheduleForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const artistId = document.getElementById('scheduleArtist').value;
        const date = document.getElementById('scheduleDate').value;
        const startTime = document.getElementById('scheduleStartTime').value;
        const endTime = document.getElementById('scheduleEndTime').value;
        
        try {
          // Get artist name
          const { data: artist } = await supabase
            .from('artists')
            .select('name')
            .eq('id', artistId)
            .single();
          
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'scheduled',
              artist_id: artistId,
              artist_name: artist?.name,
              scheduled_date: date,
              start_time: startTime,
              end_time: endTime
            })
            .eq('id', selectedRequestId);
          
          if (error) throw error;
          
          document.getElementById('scheduleModal').classList.remove('active');
          document.getElementById('scheduleForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('Appointment scheduled successfully!');
        } catch (err) {
          alert('Error scheduling appointment: ' + err.message);
        }
      });
      
      // Cancel Appointment
      window.cancelAppointment = function() {
        document.getElementById('cancelModal').classList.add('active');
      };
      
      document.getElementById('cancelCancelModal')?.addEventListener('click', () => {
        document.getElementById('cancelModal').classList.remove('active');
      });
      
      document.getElementById('cancelForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const reason = document.getElementById('cancelReason').value;
        
        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'canceled',
              cancel_reason: reason
            })
            .eq('id', selectedRequestId);
          
          if (error) throw error;
          
          document.getElementById('cancelModal').classList.remove('active');
          document.getElementById('cancelForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('Appointment canceled');
        } catch (err) {
          alert('Error canceling appointment: ' + err.message);
        }
      });

      // Edit Request Functions
      let editingRequestId = null;

      window.editRequest = async function(requestId) {
        editingRequestId = requestId;
        selectedRequestId = requestId;

        // Find the request
        const request = allRequests.find(r => r.id === requestId);
        if (!request) {
          alert('Request not found');
          return;
        }

        console.log('âœï¸ Editing request in full frame:', request);

        const detailEl = document.getElementById('requestDetail');

        // Status display names
        const statusNames = {
          'open_request': 'New',
          'pending': 'Pending',
          'scheduled': 'Scheduled',
          'finished': 'Finished',
          'canceled': 'Canceled'
        };

        // Get customer data
        const customer = {
          first_name: request.first_name,
          last_name: request.last_name,
          email: request.email,
          phone: request.customer_phone,
          rank: request.customer?.rank || null,
          instagram: request.customer?.instagram || request.instagram || null
        };

        // Rank badge styling
        const rankBadgeStyle = customer.rank ? {
          'Platinum': 'background:#FFD700; color:#1d1d1f;',
          'Gold': 'background:#FF8C00; color:white;',
          'Silver': 'background:#C0C0C0; color:#1d1d1f;',
          'Bronze': 'background:#CD7F32; color:white;'
        }[customer.rank] || '' : '';

        detailEl.innerHTML = `
          <form id="fullFrameEditForm" style="height:100%; display:flex; flex-direction:column;">
            <div style="flex:1; overflow-y:auto;">
              <div style="margin-bottom:24px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                  <h2 style="margin:0; font-size:24px; font-weight:600;">
                    Edit Request: ${request.request_number || `#${request.id.substring(0, 8).toUpperCase()}`}
                  </h2>
                  <span class="request-badge ${request.status}" style="font-size:13px; padding:6px 16px;">
                    ${statusNames[request.status] || request.status}
                  </span>
                </div>
                ${request.location ? `
                  <div style="color:var(--muted); font-size:14px;">
                    ðŸ“ ${request.location.name}${request.location.city ? ` (${request.location.city})` : ''}
                  </div>
                ` : ''}
              </div>

              <!-- Customer Information -->
              <div class="detail-section">
                <h3>Customer Information</h3>
                <div class="detail-grid">
                  <div class="detail-item">
                    <div class="detail-label">Vorname</div>
                    <input type="text" id="fullEditFirstName" value="${request.first_name || ''}" required
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Nachname
                      ${customer.rank ? `
                        <span style="display:inline-block; margin-left:8px; padding:4px 10px; border-radius:999px; font-size:11px; font-weight:600; ${rankBadgeStyle}">
                          ${customer.rank}
                        </span>
                      ` : ''}
                    </div>
                    <input type="text" id="fullEditLastName" value="${request.last_name || ''}" required
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <input type="email" id="fullEditEmail" value="${request.email || ''}" required
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Phone</div>
                    <input type="tel" id="fullEditPhone" value="${request.customer_phone || ''}" required
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Instagram</div>
                    <input type="text" id="fullEditInstagram" value="${request.instagram || ''}" placeholder="@username"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                </div>
              </div>

              <!-- Request Details -->
              <div class="detail-section">
                <h3>Request Details</h3>
                <div class="detail-grid">
                  <div class="detail-item">
                    <div class="detail-label">Priority</div>
                    <select id="fullEditPriority" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                      <option value="">-- Select Priority --</option>
                      <option value="low" ${request.priority === 'low' ? 'selected' : ''}>Low ðŸ’¤</option>
                      <option value="normal" ${request.priority === 'normal' ? 'selected' : ''}>Normal âœ“</option>
                      <option value="high" ${request.priority === 'high' ? 'selected' : ''}>High âš¡</option>
                      <option value="urgent" ${request.priority === 'urgent' ? 'selected' : ''}>Urgent ðŸ”¥</option>
                    </select>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Placement</div>
                    <input type="text" id="fullEditPlacement" value="${request.placement || ''}" placeholder="No entry data"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Size</div>
                    <input type="text" id="fullEditSize" value="${request.size || ''}" placeholder="No entry data"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Style</div>
                    <input type="text" id="fullEditStyle" value="${request.style || ''}" placeholder="No entry data"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Colorway</div>
                    <input type="text" id="fullEditColorway" value="${request.colorway || ''}" placeholder="No entry data"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item" style="grid-column:1/-1;">
                    <div class="detail-label">Description</div>
                    <textarea id="fullEditDescription" rows="4" placeholder="No entry data"
                              style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; resize:vertical;">${request.description || ''}</textarea>
                  </div>
                </div>
              </div>

              <!-- Reference Images -->
              <div class="detail-section">
                <h3>Reference Images</h3>
                <div id="existingReferenceImages" class="reference-images-editable">
                  ${request.reference_images && request.reference_images.length > 0
                    ? request.reference_images.map((img, idx) => `
                      <div class="reference-image-editable" data-image-url="${img}">
                        <img src="${img}" alt="Reference ${idx + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                        <button type="button" class="reference-image-delete" onclick="deleteReferenceImage('${img}')" title="Delete image">Ã—</button>
                      </div>
                    `).join('')
                    : '<div class="no-data-placeholder">No reference images</div>'
                  }
                </div>

                <input type="file" id="imageUploadInput" accept="image/jpeg,image/jpg,image/png,image/webp" multiple style="display:none;">

                <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageUploadInput').click()">
                  <div class="image-upload-icon">ðŸ“¸</div>
                  <div class="image-upload-text"><strong>Click to upload</strong> or drag and drop</div>
                  <div class="image-upload-hint">JPG, PNG, WebP (Max 5MB per file)</div>
                </div>

                <div id="uploadProgress" style="display:none; margin-top:12px;">
                  <div style="background:rgba(0,0,0,0.05); border-radius:8px; height:8px; overflow:hidden;">
                    <div id="uploadProgressBar" style="background:var(--accent); height:100%; width:0%; transition:width 0.3s;"></div>
                  </div>
                  <div id="uploadProgressText" style="font-size:12px; color:var(--muted); margin-top:6px; text-align:center;"></div>
                </div>
              </div>

              <!-- Artist Assignment -->
              <div class="detail-section">
                <h3>Artist Assignment</h3>
                <div class="detail-item">
                  <div class="detail-label">Search Artist</div>
                  <input type="text" id="fullEditArtistSearch" placeholder="Type to search artists..."
                         style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  <div id="fullEditArtistSearchResults" style="display:none; max-height:200px; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); border-radius:8px; margin-top:8px; background:white;"></div>
                  <input type="hidden" id="fullEditArtistId" value="${request.artist_id || ''}">
                  <div id="fullEditSelectedArtist" style="margin-top:8px; font-size:13px; color:var(--muted);">
                    ${request.artist ? `Selected: ${request.artist.name}` : ''}
                  </div>
                </div>
              </div>

              <!-- Appointment Details -->
              <div class="detail-section">
                <h3>Appointment Details</h3>
                <div class="detail-grid">
                  <div class="detail-item">
                    <div class="detail-label">Date</div>
                    <input type="date" id="fullEditScheduledDate" value="${request.scheduled_date || ''}"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Start Time</div>
                    <input type="time" id="fullEditStartTime" value="${request.start_time || ''}"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">End Time</div>
                    <input type="time" id="fullEditEndTime" value="${request.end_time || ''}"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                </div>
              </div>

              <!-- Status Management -->
              <div class="detail-section">
                <h3>Status Management</h3>
                <div class="detail-item">
                  <div class="detail-label">Status</div>
                  <select id="fullEditStatus" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                    <option value="open_request" ${request.status === 'open_request' ? 'selected' : ''}>New Request</option>
                    <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="scheduled" ${request.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                    <option value="finished" ${request.status === 'finished' ? 'selected' : ''}>Finished</option>
                    <option value="canceled" ${request.status === 'canceled' ? 'selected' : ''}>Canceled</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Action Buttons (Fixed Footer) -->
            <div style="margin-top:24px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.1); background:rgba(255,255,255,0.95);">
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
                <button type="submit" class="btn" style="background:var(--ink); color:white; border:none; flex:1; min-width:140px;">
                  ðŸ’¾ Save Changes
                </button>
                <button type="button" class="btn" onclick="scheduleFromEdit()" style="background:#007AFF; color:white; border:none; flex:1; min-width:140px;">
                  ðŸ“… Schedule
                </button>
                <button type="button" class="btn" onclick="cancelFullFrameEdit()" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1); flex:1; min-width:140px;">
                  âœ• Cancel
                </button>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button type="button" class="btn" onclick="resetRequestToOpenFullFrame()" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1); flex:1; min-width:140px;">
                  ðŸ”„ Reset to Open
                </button>
                <button type="button" class="btn" onclick="deleteRequestPermanentlyFullFrame()" style="background:#dc3545; color:white; border:none; flex:1; min-width:140px;">
                  ðŸ—‘ï¸ Delete
                </button>
              </div>
            </div>
          </form>
        `;

        // Setup artist search for full frame edit
        const fullEditArtistSearch = document.getElementById('fullEditArtistSearch');
        const fullEditArtistSearchResults = document.getElementById('fullEditArtistSearchResults');

        if (fullEditArtistSearch) {
          fullEditArtistSearch.addEventListener('input', async (e) => {
            const query = e.target.value.trim().toLowerCase();

            if (query.length < 2) {
              fullEditArtistSearchResults.style.display = 'none';
              return;
            }

            const filteredArtists = allArtists.filter(artist =>
              artist.name.toLowerCase().includes(query)
            );

            if (filteredArtists.length === 0) {
              fullEditArtistSearchResults.innerHTML = '<div style="padding:12px; color:var(--muted); font-size:13px;">No artists found</div>';
              fullEditArtistSearchResults.style.display = 'block';
              return;
            }

            fullEditArtistSearchResults.innerHTML = filteredArtists.map(artist => `
              <div
                onclick="selectFullEditArtist('${artist.id}', '${artist.name.replace(/'/g, "\\'")}')"
                style="padding:12px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.05); transition:background 0.2s;"
                onmouseover="this.style.background='rgba(0,0,0,0.03)'"
                onmouseout="this.style.background='white'">
                <div style="font-weight:500; font-size:14px;">${artist.name}</div>
                ${artist.specialty ? `<div style="font-size:12px; color:var(--muted); margin-top:2px;">${artist.specialty}</div>` : ''}
              </div>
            `).join('');

            fullEditArtistSearchResults.style.display = 'block';
          });
        }

        // Setup form submission
        document.getElementById('fullFrameEditForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await saveFullFrameEdit();
        });

        // Setup image upload handlers
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imageUploadInput = document.getElementById('imageUploadInput');

        // Drag and drop handlers
        imageUploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          imageUploadArea.classList.add('drag-over');
        });

        imageUploadArea.addEventListener('dragleave', (e) => {
          e.preventDefault();
          imageUploadArea.classList.remove('drag-over');
        });

        imageUploadArea.addEventListener('drop', async (e) => {
          e.preventDefault();
          imageUploadArea.classList.remove('drag-over');
          const files = Array.from(e.dataTransfer.files).filter(file =>
            file.type.match(/^image\/(jpeg|jpg|png|webp)$/i)
          );
          if (files.length > 0) {
            await uploadReferenceImages(files);
          }
        });

        // File input handler
        imageUploadInput.addEventListener('change', async (e) => {
          const files = Array.from(e.target.files);
          if (files.length > 0) {
            await uploadReferenceImages(files);
          }
          imageUploadInput.value = ''; // Reset input
        });
      };

      // Helper functions for full frame edit
      window.selectFullEditArtist = function(artistId, artistName) {
        document.getElementById('fullEditArtistId').value = artistId;
        document.getElementById('fullEditArtistSearch').value = artistName;
        document.getElementById('fullEditSelectedArtist').textContent = `Selected: ${artistName}`;
        document.getElementById('fullEditArtistSearchResults').style.display = 'none';
      };

      // Upload reference images
      window.uploadReferenceImages = async function(files) {
        if (!editingRequestId) return;

        const maxSize = 5 * 1024 * 1024; // 5MB
        const validFiles = files.filter(file => {
          if (file.size > maxSize) {
            alert(`File ${file.name} is too large. Maximum size is 5MB.`);
            return false;
          }
          return true;
        });

        if (validFiles.length === 0) return;

        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadProgressText = document.getElementById('uploadProgressText');

        try {
          uploadProgress.style.display = 'block';
          uploadProgressText.textContent = 'Uploading...';

          const request = allRequests.find(r => r.id === editingRequestId);
          const currentImages = request?.reference_images || [];
          const newImageUrls = [];

          for (let i = 0; i < validFiles.length; i++) {
            const file = validFiles[i];
            const progress = ((i + 1) / validFiles.length) * 100;
            uploadProgressBar.style.width = `${progress * 0.8}%`; // Reserve 20% for DB update
            uploadProgressText.textContent = `Uploading ${i + 1} of ${validFiles.length}...`;

            const fileExt = file.name.split('.').pop();
            const fileName = `${editingRequestId}_${Date.now()}_${i}.${fileExt}`;

            // Upload to Supabase Storage
            const { data: uploadData, error: uploadError } = await supabase.storage
              .from('request-images')
              .upload(fileName, file, {
                cacheControl: '3600',
                upsert: false
              });

            if (uploadError) throw uploadError;

            // Get public URL
            const { data: { publicUrl } } = supabase.storage
              .from('request-images')
              .getPublicUrl(fileName);

            newImageUrls.push(publicUrl);
          }

          // Update database with new images
          uploadProgressBar.style.width = '90%';
          uploadProgressText.textContent = 'Saving...';

          const updatedImages = [...currentImages, ...newImageUrls];

          const { error: updateError } = await supabase
            .from('requests')
            .update({ reference_images: updatedImages })
            .eq('id', editingRequestId);

          if (updateError) throw updateError;

          uploadProgressBar.style.width = '100%';
          uploadProgressText.textContent = 'Upload complete!';

          // Reload the request
          await loadRequests();
          const updatedRequest = allRequests.find(r => r.id === editingRequestId);

          // Update the image display
          const existingReferenceImages = document.getElementById('existingReferenceImages');
          if (updatedRequest.reference_images && updatedRequest.reference_images.length > 0) {
            existingReferenceImages.innerHTML = updatedRequest.reference_images.map((img, idx) => `
              <div class="reference-image-editable" data-image-url="${img}">
                <img src="${img}" alt="Reference ${idx + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                <button type="button" class="reference-image-delete" onclick="deleteReferenceImage('${img}')" title="Delete image">Ã—</button>
              </div>
            `).join('');
          }

          setTimeout(() => {
            uploadProgress.style.display = 'none';
            uploadProgressBar.style.width = '0%';
          }, 2000);

        } catch (err) {
          console.error('Error uploading images:', err);
          alert('âŒ Error uploading images: ' + err.message);
          uploadProgress.style.display = 'none';
          uploadProgressBar.style.width = '0%';
        }
      };

      // Delete reference image
      window.deleteReferenceImage = async function(imageUrl) {
        if (!editingRequestId) return;

        const confirmed = confirm('Are you sure you want to delete this image?');
        if (!confirmed) return;

        try {
          const request = allRequests.find(r => r.id === editingRequestId);
          const currentImages = request?.reference_images || [];
          const updatedImages = currentImages.filter(img => img !== imageUrl);

          // Update database
          const { error: updateError } = await supabase
            .from('requests')
            .update({ reference_images: updatedImages })
            .eq('id', editingRequestId);

          if (updateError) throw updateError;

          // Extract filename from URL and delete from storage
          const urlParts = imageUrl.split('/');
          const fileName = urlParts[urlParts.length - 1];

          const { error: deleteError } = await supabase.storage
            .from('request-images')
            .remove([fileName]);

          if (deleteError) {
            console.warn('Warning: Could not delete file from storage:', deleteError);
          }

          // Reload the request
          await loadRequests();
          const updatedRequest = allRequests.find(r => r.id === editingRequestId);

          // Update the image display
          const existingReferenceImages = document.getElementById('existingReferenceImages');
          if (updatedRequest.reference_images && updatedRequest.reference_images.length > 0) {
            existingReferenceImages.innerHTML = updatedRequest.reference_images.map((img, idx) => `
              <div class="reference-image-editable" data-image-url="${img}">
                <img src="${img}" alt="Reference ${idx + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                <button type="button" class="reference-image-delete" onclick="deleteReferenceImage('${img}')" title="Delete image">Ã—</button>
              </div>
            `).join('');
          } else {
            existingReferenceImages.innerHTML = '<div class="no-data-placeholder">No reference images</div>';
          }

        } catch (err) {
          console.error('Error deleting image:', err);
          alert('âŒ Error deleting image: ' + err.message);
        }
      };

      window.saveFullFrameEdit = async function() {
        if (!editingRequestId) return;

        try {
          const updateData = {
            first_name: document.getElementById('fullEditFirstName').value,
            last_name: document.getElementById('fullEditLastName').value,
            email: document.getElementById('fullEditEmail').value,
            customer_phone: document.getElementById('fullEditPhone').value,
            instagram: document.getElementById('fullEditInstagram').value,
            priority: document.getElementById('fullEditPriority').value,
            placement: document.getElementById('fullEditPlacement').value,
            size: document.getElementById('fullEditSize').value,
            style: document.getElementById('fullEditStyle').value,
            colorway: document.getElementById('fullEditColorway').value,
            description: document.getElementById('fullEditDescription').value,
            scheduled_date: document.getElementById('fullEditScheduledDate').value || null,
            start_time: document.getElementById('fullEditStartTime').value || null,
            end_time: document.getElementById('fullEditEndTime').value || null,
            status: document.getElementById('fullEditStatus').value,
            artist_id: document.getElementById('fullEditArtistId').value || null
          };

          const { error } = await supabase
            .from('requests')
            .update(updateData)
            .eq('id', editingRequestId);

          if (error) throw error;

          await loadRequests();
          showRequestDetail(editingRequestId);

          alert('âœ… Request updated successfully!');
          editingRequestId = null;
        } catch (err) {
          console.error('Error updating request:', err);
          alert('âŒ Error updating request: ' + err.message);
        }
      };

      window.cancelFullFrameEdit = function() {
        if (editingRequestId) {
          showRequestDetail(editingRequestId);
          editingRequestId = null;
        } else {
          closeRequestDetail();
        }
      };

      window.scheduleFromEdit = async function() {
        if (!editingRequestId) return;

        // First save current changes
        const confirmed = confirm('Do you want to save your changes before scheduling?');
        if (confirmed) {
          await saveFullFrameEdit();
        }

        // Open schedule modal
        selectedRequestId = editingRequestId;
        await scheduleAppointment();
      };

      window.resetRequestToOpenFullFrame = async function() {
        if (!editingRequestId) return;

        const confirmed = confirm('Are you sure you want to reset this request to "Open Request" status?\n\nThis will remove any assignment and scheduling information.');
        if (!confirmed) return;

        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'open_request',
              assigned_to: null,
              assigned_to_user_id: null,
              artist_id: null,
              scheduled_date: null,
              start_time: null,
              end_time: null
            })
            .eq('id', editingRequestId);

          if (error) throw error;

          await loadRequests();
          showRequestDetail(editingRequestId);

          alert('âœ… Request has been reset to Open Request status');
          editingRequestId = null;
        } catch (err) {
          console.error('Error resetting request:', err);
          alert('âŒ Error resetting request: ' + err.message);
        }
      };

      window.deleteRequestPermanentlyFullFrame = async function() {
        if (!editingRequestId) return;

        const confirmed1 = confirm('âš ï¸ WARNING: Are you sure you want to DELETE this request permanently?\n\nThis action CANNOT be undone and will remove the request from ALL databases!');
        if (!confirmed1) return;

        const confirmed2 = confirm('âš ï¸ FINAL WARNING: This will permanently delete the request and ALL associated data.\n\nType "DELETE" in the next dialog to confirm.');
        if (!confirmed2) return;

        const deleteConfirmation = prompt('Type "DELETE" to confirm permanent deletion:');
        if (deleteConfirmation !== 'DELETE') {
          alert('Deletion cancelled - confirmation text did not match.');
          return;
        }

        try {
          const { error } = await supabase
            .from('requests')
            .delete()
            .eq('id', editingRequestId);

          if (error) throw error;

          await loadRequests();
          closeRequestDetail();

          alert('âœ… Request has been permanently deleted');
          editingRequestId = null;
        } catch (err) {
          console.error('Error deleting request:', err);
          alert('âŒ Error deleting request: ' + err.message);
        }
      };

      // Artist search functionality for edit form
      const editArtistSearch = document.getElementById('editArtistSearch');
      const editArtistSearchResults = document.getElementById('editArtistSearchResults');

      if (editArtistSearch) {
        editArtistSearch.addEventListener('input', async (e) => {
          const query = e.target.value.trim().toLowerCase();

          if (query.length < 2) {
            editArtistSearchResults.style.display = 'none';
            return;
          }

          // Filter artists
          const filteredArtists = allArtists.filter(artist =>
            artist.name.toLowerCase().includes(query)
          );

          if (filteredArtists.length === 0) {
            editArtistSearchResults.innerHTML = '<div style="padding:12px; color:var(--muted); font-size:13px;">No artists found</div>';
            editArtistSearchResults.style.display = 'block';
            return;
          }

          editArtistSearchResults.innerHTML = filteredArtists.map(artist => `
            <div
              onclick="selectEditArtist('${artist.id}', '${artist.name.replace(/'/g, "\\'")}')"
              style="padding:12px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.05); transition:background 0.2s;"
              onmouseover="this.style.background='rgba(0,0,0,0.03)'"
              onmouseout="this.style.background='white'">
              <div style="font-weight:500; font-size:14px;">${artist.name}</div>
              ${artist.specialty ? `<div style="font-size:12px; color:var(--muted); margin-top:2px;">${artist.specialty}</div>` : ''}
            </div>
          `).join('');

          editArtistSearchResults.style.display = 'block';
        });
      }

      // Select artist from search results
      window.selectEditArtist = function(artistId, artistName) {
        document.getElementById('editArtistId').value = artistId;
        document.getElementById('editArtistSearch').value = artistName;
        document.getElementById('editSelectedArtist').textContent = `Selected: ${artistName}`;
        document.getElementById('editArtistSearchResults').style.display = 'none';
      };

      document.getElementById('cancelEditRequest')?.addEventListener('click', () => {
        document.getElementById('editRequestModal').classList.remove('active');
        editingRequestId = null;
      });

      // Submit handler for edit request form
      document.getElementById('editRequestForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!editingRequestId) return;

        try {
          const updateData = {
            first_name: document.getElementById('editFirstName').value,
            last_name: document.getElementById('editLastName').value,
            email: document.getElementById('editEmail').value,
            customer_phone: document.getElementById('editPhone').value,
            instagram: document.getElementById('editInstagram').value,
            priority: document.getElementById('editPriority').value,
            placement: document.getElementById('editPlacement').value,
            size: document.getElementById('editSize').value,
            style: document.getElementById('editStyle').value,
            colorway: document.getElementById('editColorway').value,
            description: document.getElementById('editDescription').value,
            scheduled_date: document.getElementById('editScheduledDate').value || null,
            start_time: document.getElementById('editStartTime').value || null,
            end_time: document.getElementById('editEndTime').value || null,
            status: document.getElementById('editStatus').value,
            artist_id: document.getElementById('editArtistId').value || null
          };

          const { error } = await supabase
            .from('requests')
            .update(updateData)
            .eq('id', editingRequestId);

          if (error) throw error;

          document.getElementById('editRequestModal').classList.remove('active');
          await loadRequests();

          // Reload detail view if still showing this request
          if (selectedRequestId === editingRequestId) {
            showRequestDetail(selectedRequestId);
          }

          // Show appropriate success message
          if (updateData.status === 'scheduled') {
            alert('âœ… Request scheduled successfully!\n\nðŸ“… An appointment has been automatically created in the appointments table.');
            console.log('âœ… Request scheduled - Appointment auto-created by SQL trigger');
          } else {
            alert('âœ… Request updated successfully!');
          }

          editingRequestId = null;
        } catch (err) {
          console.error('Error updating request:', err);
          alert('âŒ Error updating request: ' + err.message);
        }
      });

      // Create Request Button - Opens Create Request Modal
      document.getElementById('createRequestBtn')?.addEventListener('click', () => {
        // Load locations into dropdown
        const locationSelect = document.getElementById('createLocation');
        if (locationSelect && allLocations) {
          locationSelect.innerHTML = '<option value="">-- Select Location --</option>';
          allLocations.forEach(location => {
            const option = document.createElement('option');
            option.value = location.id;
            option.textContent = `${location.name}${location.city ? ` (${location.city})` : ''}`;
            locationSelect.appendChild(option);
          });
        }
        document.getElementById('createRequestModal').classList.add('active');
      });

      // Cancel Create Request
      document.getElementById('cancelCreateRequest')?.addEventListener('click', () => {
        document.getElementById('createRequestModal').classList.remove('active');
        document.getElementById('createRequestForm').reset();
      });

      // Submit handler for create request form
      document.getElementById('createRequestForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        try {
          const requestData = {
            first_name: document.getElementById('createFirstName').value,
            last_name: document.getElementById('createLastName').value,
            email: document.getElementById('createEmail').value,
            customer_phone: document.getElementById('createPhone').value,
            instagram: document.getElementById('createInstagram').value || null,
            priority: document.getElementById('createPriority').value || 'normal',
            placement: document.getElementById('createPlacement').value || null,
            size: document.getElementById('createSize').value || null,
            style: document.getElementById('createStyle').value || null,
            colorway: document.getElementById('createColorway').value || null,
            description: document.getElementById('createDescription').value || null,
            location_id: document.getElementById('createLocation').value,
            status: 'open_request',
            origin: document.getElementById('createOrigin').value,
            booking_type: 'request'
          };

          const { data, error } = await supabase
            .from('requests')
            .insert([requestData])
            .select();

          if (error) throw error;

          document.getElementById('createRequestModal').classList.remove('active');
          document.getElementById('createRequestForm').reset();
          await loadRequests();

          alert('âœ… Request created successfully!');
        } catch (err) {
          console.error('Error creating request:', err);
          alert('âŒ Error creating request: ' + err.message);
        }
      });

      window.resetRequestToOpen = async function() {
        if (!editingRequestId) return;

        // Confirmation dialog
        const confirmed = confirm('Are you sure you want to reset this request to "Open Request" status?\n\nThis will remove any assignment and scheduling information.');

        if (!confirmed) return;

        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'open_request',
              assigned_to: null,
              assigned_to_user_id: null,
              artist_id: null,
              scheduled_date: null,
              start_time: null,
              end_time: null
            })
            .eq('id', editingRequestId);

          if (error) throw error;

          document.getElementById('editRequestModal').classList.remove('active');
          await loadRequests();

          // Close detail view or reload it
          selectedRequestId = null;
          closeRequestDetail();

          alert('âœ… Request has been reset to Open Request status');
          editingRequestId = null;
        } catch (err) {
          console.error('Error resetting request:', err);
          alert('âŒ Error resetting request: ' + err.message);
        }
      };

      window.deleteRequestPermanently = async function() {
        if (!editingRequestId) return;

        // First confirmation
        const confirmed1 = confirm('âš ï¸ WARNING: Are you sure you want to DELETE this request permanently?\n\nThis action CANNOT be undone and will remove the request from ALL databases!');

        if (!confirmed1) return;

        // Second confirmation
        const confirmed2 = confirm('âš ï¸ FINAL WARNING: This will permanently delete the request and ALL associated data.\n\nType "DELETE" in the next dialog to confirm.');

        if (!confirmed2) return;

        // Third confirmation with text input
        const deleteConfirmation = prompt('Type "DELETE" to confirm permanent deletion:');

        if (deleteConfirmation !== 'DELETE') {
          alert('âŒ Deletion cancelled. You must type "DELETE" exactly to confirm.');
          return;
        }

        try {
          // Delete from requests table
          const { error } = await supabase
            .from('requests')
            .delete()
            .eq('id', editingRequestId);

          if (error) throw error;

          document.getElementById('editRequestModal').classList.remove('active');
          await loadRequests();

          // Close detail view
          selectedRequestId = null;
          closeRequestDetail();

          alert('âœ… Request has been permanently deleted from all databases');
          editingRequestId = null;
        } catch (err) {
          console.error('Error deleting request:', err);
          alert('âŒ Error deleting request: ' + err.message);
        }
      };

      // Edit Appointment for Scheduled Requests
      window.editAppointment = async function() {
        const request = allRequests.find(r => r.id === selectedRequestId);
        if (!request) return;

        // Load artists
        const { data: artists } = await supabase.from('artists').select('*');
        const artistSelect = document.getElementById('editAppointmentArtist');
        artistSelect.innerHTML = '<option value="">-- Select Artist --</option>' +
          (artists || []).map(a => `<option value="${a.id}">${a.name}</option>`).join('');

        // Pre-fill form with current values
        document.getElementById('editAppointmentArtist').value = request.artist_id || '';
        document.getElementById('editAppointmentDate').value = request.scheduled_date || '';
        document.getElementById('editAppointmentStartTime').value = request.start_time || '';
        document.getElementById('editAppointmentEndTime').value = request.end_time || '';

        document.getElementById('editAppointmentModal').classList.add('active');
      };

      document.getElementById('cancelEditAppointment')?.addEventListener('click', () => {
        document.getElementById('editAppointmentModal').classList.remove('active');
      });

      document.getElementById('editAppointmentForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const artistId = document.getElementById('editAppointmentArtist').value;
        const date = document.getElementById('editAppointmentDate').value;
        const startTime = document.getElementById('editAppointmentStartTime').value;
        const endTime = document.getElementById('editAppointmentEndTime').value;

        try {
          // Get artist name
          const { data: artist } = await supabase
            .from('artists')
            .select('name')
            .eq('id', artistId)
            .single();

          const { error } = await supabase
            .from('requests')
            .update({
              artist_id: artistId,
              scheduled_date: date,
              start_time: startTime,
              end_time: endTime
            })
            .eq('id', selectedRequestId);

          if (error) throw error;

          document.getElementById('editAppointmentModal').classList.remove('active');
          document.getElementById('editAppointmentForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('âœ… Appointment updated successfully!');
        } catch (err) {
          console.error('Error updating appointment:', err);
          alert('âŒ Error updating appointment: ' + err.message);
        }
      });

      // Reset Appointment (clear appointment details but keep status scheduled)
      window.resetAppointment = async function() {
        if (!confirm('Are you sure you want to reset this appointment?\n\nThis will clear the artist, date, and time details but keep the request in "Scheduled" status.')) {
          return;
        }

        try {
          const { error } = await supabase
            .from('requests')
            .update({
              artist_id: null,
              scheduled_date: null,
              start_time: null,
              end_time: null
            })
            .eq('id', selectedRequestId);

          if (error) throw error;

          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('âœ… Appointment details reset successfully!');
        } catch (err) {
          console.error('Error resetting appointment:', err);
          alert('âŒ Error resetting appointment: ' + err.message);
        }
      };

      // Cancel Appointment Request (set status to canceled)
      window.cancelAppointmentRequest = function() {
        document.getElementById('cancelModal').classList.add('active');
      };

      // Delete Request (direct delete with confirmation)
      window.deleteRequest = async function() {
        if (!confirm('âš ï¸ WARNING: Are you sure you want to DELETE this request permanently?\n\nThis action CANNOT be undone!')) {
          return;
        }

        try {
          const { error } = await supabase
            .from('requests')
            .delete()
            .eq('id', selectedRequestId);

          if (error) throw error;

          selectedRequestId = null;
          await loadRequests();
          closeRequestDetail();
          alert('âœ… Request deleted successfully!');
        } catch (err) {
          console.error('Error deleting request:', err);
          alert('âŒ Error deleting request: ' + err.message);
        }
      };

      // Auto-move scheduled to finished (check every minute)
      setInterval(async () => {
        const now = new Date();
        const scheduledRequests = allRequests.filter(r => r.status === 'scheduled' && r.scheduled_date && r.end_time);
        
        for (const req of scheduledRequests) {
          const endDateTime = new Date(`${req.scheduled_date}T${req.end_time}`);
          if (now > endDateTime) {
            await supabase
              .from('requests')
              .update({ status: 'finished' })
              .eq('id', req.id);
          }
        }
        
        if (scheduledRequests.length > 0) {
          await loadRequests();
        }
      }, 60000); // Check every minute

      let currentEditArtistId = null;
      let currentEditCustomerId = null;

      
      // Open Add Artist Modal
      document.getElementById('addArtistBtn')?.addEventListener('click', () => {
        // Reset form
        document.getElementById('addArtistForm')?.reset();
        
        // Open modal (location dropdown is static HTML, no need to populate)
        document.getElementById('addArtistModal').classList.add('active');
      });
      
      // Close Add Artist Modal
      document.getElementById('cancelAddArtist')?.addEventListener('click', () => {
        document.getElementById('addArtistModal').classList.remove('active');
      });
      
      // ============================================
      // ARTISTS FILTER FUNCTIONALITY
      // ============================================

      let artistsCache = [];
      let artistsFiltered = [];
      let currentArtistsPage = 1;
      const artistsPageSize = 50;

      async function loadArtists(page = 1) {
        console.log('ðŸ‘¤ Loading artists (page ' + page + ')...');

        try {
          ProgressBar.show('Loading artists...');

          // Load from cache or database
          if (artistsCache.length === 0) {
            ProgressBar.updateProgress(30, 'Fetching artists from database...');
            const { data, error } = await supabase
              .from('artists')
              .select(`
                *,
                location:locations(id, name, city)
              `)
              .order('name');

            if (error) throw error;

            artistsCache = data || [];
            console.log('âœ… Loaded', artistsCache.length, 'artists into cache');
          }

          ProgressBar.updateProgress(60, 'Applying filters...');
          // Apply filters
          applyArtistFilters();

          // Apply sorting
          const sorted = sortArtists(artistsFiltered, artistSortConfig.field, artistSortConfig.order);

          // Pagination
          const startIndex = (page - 1) * artistsPageSize;
          const endIndex = startIndex + artistsPageSize;
          const paginatedArtists = sorted.slice(startIndex, endIndex);

          ProgressBar.updateProgress(80, 'Rendering table...');
          // Render table
          renderArtistsTable(paginatedArtists);

          // Update results count
          document.getElementById('artistsResultCount').textContent = artistsFiltered.length;

          // Render pagination
          renderArtistsPagination(page);

          currentArtistsPage = page;
          ProgressBar.hide();

        } catch (error) {
          console.error('âŒ Failed to load artists:', error);
          ProgressBar.hide();
          const tbody = document.getElementById('artistsTableBody');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#E53935;">Fehler beim Laden der Artists: ' + error.message + '</td></tr>';
          }
        }
      }

      // Apply Artist Filters
      function applyArtistFilters() {
        const searchTerm = document.getElementById('artistSearchInput')?.value.toLowerCase().trim() || '';
        const locationFilter = document.getElementById('artistLocationFilter')?.value || '';
        const rankFilter = document.getElementById('artistRankFilter')?.value || '';
        const typeFilter = document.getElementById('artistTypeFilter')?.value || '';
        const statusFilter = document.getElementById('artistStatusFilter')?.value || '';

        artistsFiltered = artistsCache.filter(artist => {
          // Search filter (Name, Email, Instagram)
          if (searchTerm) {
            const matchesSearch =
              (artist.name && artist.name.toLowerCase().includes(searchTerm)) ||
              (artist.email && artist.email.toLowerCase().includes(searchTerm)) ||
              (artist.instagram && artist.instagram.toLowerCase().includes(searchTerm));

            if (!matchesSearch) return false;
          }

          // Location filter
          if (locationFilter) {
            if (locationFilter === 'NULL') {
              if (artist.location_id !== null) return false;
            } else {
              if (artist.location_id !== locationFilter) return false;
            }
          }

          // Rank filter
          if (rankFilter) {
            if (artist.rank !== rankFilter) return false;
          }

          // Type filter (Guest/Resident)
          if (typeFilter) {
            const isGuest = artist.is_guest === true;
            if (typeFilter === 'guest' && !isGuest) return false;
            if (typeFilter === 'resident' && isGuest) return false;
          }

          // Status filter (Active/Inactive)
          if (statusFilter) {
            const isActive = artist.active === true;
            if (statusFilter === 'active' && !isActive) return false;
            if (statusFilter === 'inactive' && isActive) return false;
          }

          return true;
        });

        console.log('ðŸ” Filtered:', artistsFiltered.length, 'of', artistsCache.length, 'artists');
      }

      // Filter Artists (debounced for search input)
      let filterArtistsTimeout;
      function filterArtists() {
        clearTimeout(filterArtistsTimeout);
        filterArtistsTimeout = setTimeout(() => {
          loadArtists(1); // Reset to page 1 when filtering
        }, 300);
      }

      // Clear Artist Filters
      function clearArtistFilters() {
        document.getElementById('artistSearchInput').value = '';
        document.getElementById('artistLocationFilter').value = '';
        document.getElementById('artistRankFilter').value = '';
        document.getElementById('artistTypeFilter').value = '';
        document.getElementById('artistStatusFilter').value = '';

        loadArtists(1);
      }

      // Render Artists Table
      function renderArtistsTable(artists) {
        const tbody = document.getElementById('artistsTableBody');
        if (!tbody) return;

        if (artists.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--muted);">Keine Artists gefunden. Versuche andere Filter-Einstellungen.</td></tr>';
          return;
        }

        tbody.innerHTML = artists.map(artist => {
          // âœ… FIXED: Show location from city_location field (text) or location relation
          const locationDisplay = artist.city_location
            ? `<span class="location-badge">${artist.city_location}</span>`
            : (artist.location && artist.location.name)
              ? `<span class="location-badge">${artist.location.name}</span>`
              : '<span style="color:#E53935;">âš ï¸ Keine</span>';

          return `
            <tr>
              <td>${artist.name || '-'}</td>
              <td>${artist.instagram ? `<span style="color:var(--muted); font-size:13px;">@${artist.instagram}</span>` : '-'}</td>
              <td>${artist.phone || '-'}</td>
              <td><span class="type-badge ${artist.is_guest ? 'guest' : 'resident'}">${artist.is_guest ? 'ðŸ‘¥ Guest' : 'ðŸ  Resident'}</span></td>
              <td>${locationDisplay}</td>
              <td><span class="rank-badge rank-${artist.rank || 'R1'}">${artist.rank || 'R1'}</span></td>
              <td><span class="status-badge ${artist.active ? 'active' : 'inactive'}">${artist.active ? 'âœ… Aktiv' : 'âŒ Inaktiv'}</span></td>
              <td style="text-align:right;">
                <button class="btn btn-primary" onclick="viewArtistProfile('${artist.id}')" style="padding:6px 16px; font-size:13px;">View Profile</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Render Artists Pagination
      function renderArtistsPagination(currentPage) {
        const totalPages = Math.ceil(artistsFiltered.length / artistsPageSize);
        const container = document.getElementById('artistsTableBody')?.parentElement?.parentElement;

        if (!container) return;

        // Remove old pagination if exists
        let paginationEl = container.querySelector('.pagination-controls');
        if (paginationEl) paginationEl.remove();

        if (totalPages <= 1) return;

        let html = '<div class="pagination-controls">';

        // Previous
        if (currentPage > 1) {
          html += `<button class="btn-pagination" onclick="loadArtists(${currentPage - 1})">â—€ ZurÃ¼ck</button>`;
        }

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<button class="btn-pagination ${i === currentPage ? 'active' : ''}" onclick="loadArtists(${i})">${i}</button>`;
          } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<span class="pagination-dots">...</span>';
          }
        }

        // Next
        if (currentPage < totalPages) {
          html += `<button class="btn-pagination" onclick="loadArtists(${currentPage + 1})">Weiter â–¶</button>`;
        }

        html += '</div>';
        container.insertAdjacentHTML('beforeend', html);
      }

      let allCustomers = [];
      
      // Customers Cache & Pagination
      let customersCache = [];
      let customersFiltered = [];
      let currentCustomersPage = 1;
      const customersPageSize = 50;

      async function loadCustomers(page = 1) {
        console.log('ðŸ‘¥ Loading customers (page ' + page + ')...');

        try {
          ProgressBar.show('Loading customers...');

          // Load from cache or database
          if (customersCache.length === 0) {
            console.log('ðŸ”„ Loading ALL customers from Supabase in batches...');
            ProgressBar.updateProgress(20, 'Fetching customers from database...');

            let allData = [];
            let from = 0;
            const batchSize = 1000;
            let hasMore = true;

            // Load all customers in batches of 1000
            while (hasMore) {
              const { data, error, count } = await supabase
                .from('customers')
                .select('*', { count: 'exact' })
                .order('created_at', { ascending: false })
                .range(from, from + batchSize - 1);

              if (error) throw error;

              if (data && data.length > 0) {
                allData = allData.concat(data);
                console.log(`ðŸ“¦ Loaded batch: ${from + 1} to ${from + data.length} (Total so far: ${allData.length})`);
                from += batchSize;

                // Update progress (20% to 50%)
                const customerProgress = 20 + Math.min(30, (allData.length / 1000) * 3);
                ProgressBar.updateProgress(customerProgress, `Loading customers (${allData.length} loaded)...`);

                // Check if we got less than batch size, meaning we're done
                if (data.length < batchSize) {
                  hasMore = false;
                }
              } else {
                hasMore = false;
              }
            }

            customersCache = allData;
            allCustomers = customersCache; // Keep for compatibility
            console.log('âœ… Loaded ALL', customersCache.length, 'customers into cache');
          }

          ProgressBar.updateProgress(60, 'Applying filters...');
          // Apply filters
          applyCustomerFilters();

          // Apply sorting
          const sorted = sortCustomers(customersFiltered, customerSortConfig.field, customerSortConfig.order);

          // Pagination
          const startIndex = (page - 1) * customersPageSize;
          const endIndex = startIndex + customersPageSize;
          const paginatedCustomers = sorted.slice(startIndex, endIndex);

          ProgressBar.updateProgress(80, 'Rendering table...');
          // Render table
          renderCustomersTable(paginatedCustomers);

          // Update results count
          document.getElementById('customersResultCount').textContent = customersFiltered.length;

          // Render pagination
          renderCustomersPagination(page);

          currentCustomersPage = page;
          ProgressBar.hide();

        } catch (error) {
          console.error('âŒ Failed to load customers:', error);
          ProgressBar.hide();
          const tbody = document.getElementById('customersTableBody');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#E53935;">Fehler beim Laden der Customers: ' + error.message + '</td></tr>';
          }
        }
      }

      // Make loadCustomers globally accessible for pagination onclick handlers
      window.loadCustomers = loadCustomers;

      // Apply Customer Filters
      function applyCustomerFilters() {
        const searchTerm = document.getElementById('customerSearchInput')?.value.toLowerCase().trim() || '';
        const rankFilter = document.getElementById('customerRankFilter')?.value || '';
        const blacklistFilter = document.getElementById('customerBlacklistFilter')?.value || '';
        const bookingsFilter = document.getElementById('customerBookingsFilter')?.value || '';

        console.log('ðŸ” [Filter Debug] Starting filter with', customersCache.length, 'total customers');
        console.log('ðŸ” [Filter Debug] Search term:', searchTerm ? `"${searchTerm}"` : '(none)');
        console.log('ðŸ” [Filter Debug] Rank filter:', rankFilter || '(none)');
        console.log('ðŸ” [Filter Debug] Blacklist filter:', blacklistFilter || '(none)');
        console.log('ðŸ” [Filter Debug] Bookings filter:', bookingsFilter || '(none)');

        let filteredBySearch = customersCache;

        customersFiltered = customersCache.filter(customer => {
          // Search filter (Name, Email, Phone, Instagram)
          if (searchTerm) {
            const matchesSearch =
              (customer.first_name && customer.first_name.toLowerCase().includes(searchTerm)) ||
              (customer.last_name && customer.last_name.toLowerCase().includes(searchTerm)) ||
              (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
              (customer.phone && customer.phone.toLowerCase().includes(searchTerm)) ||
              (customer.instagram && customer.instagram.toLowerCase().includes(searchTerm));

            if (!matchesSearch) return false;
          }

          // Rank filter
          if (rankFilter) {
            if (customer.rank !== rankFilter) return false;
          }

          // Blacklist filter
          if (blacklistFilter) {
            const isBlacklisted = customer.blacklisted === true;
            if (blacklistFilter === 'true' && !isBlacklisted) return false;
            if (blacklistFilter === 'false' && isBlacklisted) return false;
          }

          // Bookings range filter
          if (bookingsFilter) {
            const bookingsCount = customer.total_bookings || 0;
            if (bookingsFilter === '0' && bookingsCount !== 0) return false;
            if (bookingsFilter === '1-2' && (bookingsCount < 1 || bookingsCount > 2)) return false;
            if (bookingsFilter === '3-5' && (bookingsCount < 3 || bookingsCount > 5)) return false;
            if (bookingsFilter === '6-10' && (bookingsCount < 6 || bookingsCount > 10)) return false;
            if (bookingsFilter === '11+' && bookingsCount < 11) return false;
          }

          return true;
        });

        console.log('âœ… [Filter Debug] Final filtered count:', customersFiltered.length, 'of', customersCache.length, 'customers');

        if (searchTerm && customersFiltered.length === 0) {
          console.warn('âš ï¸ [Filter Debug] Search returned 0 results. Check if search term exists in any customer fields.');
        }
      }

      // Filter Customers with Debouncing
      let filterCustomersTimeout;
      function filterCustomers() {
        clearTimeout(filterCustomersTimeout);
        filterCustomersTimeout = setTimeout(() => {
          loadCustomers(1); // Reset to page 1 when filtering
        }, 300);
      }

      // Clear Customer Filters
      function clearCustomerFilters() {
        document.getElementById('customerSearchInput').value = '';
        document.getElementById('customerRankFilter').value = '';
        document.getElementById('customerBlacklistFilter').value = '';
        document.getElementById('customerBookingsFilter').value = '';
        loadCustomers(1);
      }

      // Render Customers Table
      function renderCustomersTable(customers) {
        const tbody = document.getElementById('customersTableBody');

        if (!tbody) {
          console.error('âŒ customersTableBody not found');
          return;
        }

        if (customers.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--muted);">Keine Customers gefunden</td></tr>';
          return;
        }

        tbody.innerHTML = customers.map(customer => {
          // Rank badge
          const rankBadge = customer.rank
            ? `<span class="rank-badge rank-${customer.rank.toLowerCase()}">${customer.rank}</span>`
            : '-';

          // Blacklist badge
          const blacklistBadge = customer.blacklisted
            ? '<span style="background:#FEE2E2; color:#991B1B; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:600;">ðŸš« Blacklisted</span>'
            : '';

          // Instagram link
          const instagramDisplay = customer.instagram
            ? `<a href="https://instagram.com/${customer.instagram.replace('@', '')}" target="_blank" style="color:var(--accent);">@${customer.instagram.replace('@', '')}</a>`
            : '-';

          return `
            <tr>
              <td>${customer.first_name || '-'}</td>
              <td>${customer.last_name || '-'}</td>
              <td>${customer.email || '-'}</td>
              <td>${customer.phone || '-'}</td>
              <td>${instagramDisplay}</td>
              <td>${rankBadge} ${blacklistBadge}</td>
              <td style="font-size:13px; color:var(--muted);">${new Date(customer.created_at).toLocaleDateString()}</td>
              <td style="text-align:right;">
                <button class="btn btn-primary" onclick="openCustomerProfile('${customer.id}')" style="padding:6px 16px; font-size:13px;">View Profile</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Render Customers Pagination
      function renderCustomersPagination(currentPage) {
        const totalPages = Math.ceil(customersFiltered.length / customersPageSize);
        const container = document.getElementById('customersTableBody')?.parentElement?.parentElement;

        if (!container) return;

        // Remove old pagination if exists
        let paginationEl = container.querySelector('.pagination-controls');
        if (paginationEl) paginationEl.remove();

        if (totalPages <= 1) return;

        let html = '<div class="pagination-controls">';

        // Previous
        if (currentPage > 1) {
          html += `<button class="btn-pagination" onclick="loadCustomers(${currentPage - 1})">â—€ ZurÃ¼ck</button>`;
        }

        // Page numbers with ellipsis
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<button class="btn-pagination ${i === currentPage ? 'active' : ''}" onclick="loadCustomers(${i})">${i}</button>`;
          } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<span class="pagination-dots">...</span>';
          }
        }

        // Next
        if (currentPage < totalPages) {
          html += `<button class="btn-pagination" onclick="loadCustomers(${currentPage + 1})">Weiter â–¶</button>`;
        }

        html += '</div>';
        container.insertAdjacentHTML('beforeend', html);
      }

      // Agreements Functions
      async function loadAgreements() {
        try {
          const dateStr = agreementsDate.toISOString().split('T')[0];

          // Load agreements from agreements table for the selected date
          const { data: agreementData, error } = await supabase
            .from('agreements')
            .select('*')
            .gte('signed_at', `${dateStr}T00:00:00`)
            .lte('signed_at', `${dateStr}T23:59:59`)
            .order('signed_at', { ascending: false });  // Newest first

          if (error) {
            // Check if table doesn't exist (404)
            if (error.code === 'PGRST116' || error.message.includes('relation') || error.message.includes('does not exist')) {
              console.log('Agreements table not yet created - showing empty state');
              renderAgreements([]);
              return;
            }
            throw error;
          }

          console.log(`Agreements loaded for ${dateStr}:`, agreementData?.length);

          // Get artist details
          const agreements = (agreementData || []).map((agreement) => {
            let artistName = '-';
            if (agreement.artist_id) {
              const artist = allArtists.find(a => a.id === agreement.artist_id);
              if (artist) {
                artistName = artist.name;
              }
            }

            const signedTime = new Date(agreement.signed_at);
            const timeStr = signedTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

            return {
              id: agreement.id,
              customerName: agreement.full_name || 'Unknown',
              customerEmail: agreement.email || '-',
              artistName,
              time: timeStr,
              language: agreement.language,
              signatureData: agreement.signature_data
            };
          });

          renderAgreements(agreements);
        } catch (err) {
          console.log("Agreements table not available:", err.message);
          renderAgreements([]);
        }
      }
      
      function renderAgreements(agreements) {
        const tbody = document.getElementById('agreementsTableBody');
        
        if (!agreements || agreements.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px; color:var(--muted);">No agreements for this date</td></tr>';
          return;
        }
        
        tbody.innerHTML = agreements.map(agreement => `
          <tr style="transition:background 0.15s ease;">
            <td>
              <span style="font-weight:500;">${agreement.customerName}</span>
            </td>
            <td>${agreement.customerEmail}</td>
            <td>${agreement.artistName}</td>
            <td style="font-weight:500;">${agreement.time}</td>
            <td style="text-align:center;">
              ${agreement.signatureData 
                ? '<span style="color:#34c759; font-size:20px; font-weight:600;">âœ“</span>' 
                : '<span style="color:#ff3b30; font-size:20px; font-weight:600;">âœ•</span>'}
            </td>
          </tr>
        `).join('');
      }
      
      function updateAgreementsDateDisplay() {
        const dateDisplayEl = document.getElementById('agreementsDateDisplay');
        const datePickerEl = document.getElementById('agreementsDatePickerInput');
        
        if (datePickerEl) {
          datePickerEl.value = agreementsDate.toISOString().split('T')[0];
        }
        
        if (dateDisplayEl) {
          const day = agreementsDate.getDate();
          const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 
                              'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
          const month = monthNames[agreementsDate.getMonth()];
          const year = agreementsDate.getFullYear();
          const weekdayShort = agreementsDate.toLocaleDateString('de-DE', { weekday: 'short' });
          dateDisplayEl.textContent = `${weekdayShort} ${day}. ${month} ${year}`;
        }
      }
      
      // Agreements Date Navigation
      document.getElementById('agreementsPrevDayBtn')?.addEventListener('click', () => {
        agreementsDate.setDate(agreementsDate.getDate() - 1);
        updateAgreementsDateDisplay();
        loadAgreements();
      });
      
      document.getElementById('agreementsNextDayBtn')?.addEventListener('click', () => {
        agreementsDate.setDate(agreementsDate.getDate() + 1);
        updateAgreementsDateDisplay();
        loadAgreements();
      });
      
      document.getElementById('agreementsTodayBtn')?.addEventListener('click', () => {
        agreementsDate = new Date();
        updateAgreementsDateDisplay();
        loadAgreements();
      });
      
      document.getElementById('agreementsDatePickerInput')?.addEventListener('change', (e) => {
        agreementsDate = new Date(e.target.value + 'T12:00:00');
        updateAgreementsDateDisplay();
        loadAgreements();
      });
      
      // Customer Detail Modal
      window.showCustomerDetail = async function(customerId) {
        if (!customerId) return;
        
        try {
          const { data: customer, error } = await supabase
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();
          
          if (error) throw error;
          if (!customer) return;
          
          const content = document.getElementById('customerDetailContent');
          content.innerHTML = `
            <div class="detail-item">
              <div class="detail-label">Name</div>
              <div class="detail-value">${customer.first_name || ''} ${customer.last_name || ''}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Email</div>
              <div class="detail-value">${customer.email || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Phone</div>
              <div class="detail-value">${customer.phone || '-'}</div>
            </div>
            ${customer.rank ? `
              <div class="detail-item">
                <div class="detail-label">Rank</div>
                <div class="detail-value"><span class="customer-rank ${customer.rank.toLowerCase()}">${customer.rank}</span></div>
              </div>
            ` : ''}
            <div class="detail-item">
              <div class="detail-label">Customer Since</div>
              <div class="detail-value">${new Date(customer.created_at).toLocaleDateString('de-DE')}</div>
            </div>
          `;
          
          document.getElementById('customerDetailModal').classList.add('active');
        } catch (err) {
          console.error('Error loading customer:', err);
          alert('Error loading customer details');
        }
      };
      
      document.getElementById('closeCustomerDetail')?.addEventListener('click', () => {
        document.getElementById('customerDetailModal').classList.remove('active');
      });
      
      // File Upload Modal
      window.openFileUpload = async function(eventId) {
        currentAgreementEventId = eventId;
        
        try {
          const { data: event, error } = await supabase
            .from('events')
            .select('title, agreement_file_url, agreement_file_name')
            .eq('id', eventId)
            .single();
          
          if (error) throw error;
          
          // Show existing files if any
          const existingSection = document.getElementById('existingFiles');
          if (event.agreement_file_url) {
            existingSection.innerHTML = `
              <div style="background:var(--location-light); padding:12px; border-radius:8px; margin-bottom:12px;">
                <div style="font-size:13px; font-weight:600; color:var(--location-dark); margin-bottom:4px;">Current File:</div>
                <div style="font-size:14px; color:var(--ink);">${event.agreement_file_name || 'agreement.pdf'}</div>
              </div>
            `;
          } else {
            existingSection.innerHTML = '<div style="color:var(--muted); font-size:13px; margin-bottom:12px;">No files uploaded yet</div>';
          }
          
          document.getElementById('fileUploadModal').classList.add('active');
        } catch (err) {
          console.error('Error loading file info:', err);
        }
      };

      document.getElementById('cancelFileUpload')?.addEventListener('click', () => {
        document.getElementById('fileUploadModal').classList.remove('active');
        document.getElementById('fileUploadInput').value = '';
      });
      
      document.getElementById('fileUploadInput')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          // In a real implementation, upload to Supabase Storage
          // For now, we'll just store the filename
          const { error } = await supabase
            .from('events')
            .update({
              agreement_file_name: file.name,
              agreement_file_url: `uploads/${file.name}` // Placeholder
            })
            .eq('id', currentAgreementEventId);
          
          if (error) throw error;
          
          alert('File uploaded successfully!');
          document.getElementById('fileUploadModal').classList.remove('active');
          document.getElementById('fileUploadInput').value = '';
          loadAgreements();
        } catch (err) {
          console.error('Error uploading file:', err);
          alert('Error uploading file: ' + err.message);
        }
      });


      async function loadEvents() {
        try {
          if (!selectedLocationId) {
            console.log('No location selected');
            events = [];
            return;
          }

          // Parse time without timezone conversion
          const parseLocalTime = (timeStr) => {
            const [datePart, timePart] = timeStr.split('T');
            const [hours, minutes] = timePart.split(':').map(Number);
            return hours + minutes / 60;
          };

          // Calculate date range: Â±2 weeks from current date for better performance
          const startDate = new Date(currentDate);
          startDate.setDate(startDate.getDate() - 14);
          const endDate = new Date(currentDate);
          endDate.setDate(endDate.getDate() + 14);

          const startDateStr = startDate.toISOString().split('T')[0];
          const endDateStr = endDate.toISOString().split('T')[0];

          // Store the loaded date range for future reference
          loadedDateRangeStart = new Date(startDateStr);
          loadedDateRangeEnd = new Date(endDateStr);

          console.log(`Loading events for date range: ${startDateStr} to ${endDateStr}`);

          // 1. Load events from events table with date range filter
          const { data: eventsData, error: eventsError } = await supabase
            .from('events')
            .select('*')
            .eq('location_id', selectedLocationId)
            .gte('start_time', startDateStr)
            .lte('start_time', endDateStr + 'T23:59:59');

          if (eventsError) throw eventsError;

          console.log(`Events loaded for location ${selectedLocationId}:`, eventsData?.length || 0);

          const processedEvents = (eventsData || []).map(e => {
            const artist = allArtists.find(a => a.id === e.artist_id);

            const startHour = parseLocalTime(e.start_time);
            const endHour = parseLocalTime(e.end_time);

            // Determine category:
            // - If no artist_id, it's an 'events' category event
            // - If artist exists and is guest, it's 'guest'
            // - If artist exists and is not guest, it's 'resident'
            let category = 'events';
            if (e.artist_id && artist) {
              category = artist.is_guest ? 'guest' : 'resident';
            }

            return {
              id: e.id,
              date: e.start_time.split('T')[0],
              category: category,
              slot: e.slot || 1, // Use slot from database, default to 1 if not set
              title: e.title || artist?.name || 'Event',
              type: e.type || null,
              artistName: artist?.name || null,
              artistId: artist?.id || e.artist_id || null,
              customerName: e.title || null,
              customerId: null, // Events don't have customers
              attendanceRequired: e.attendance_required || false,
              startHour: startHour,
              endHour: endHour,
              startTimeRaw: e.start_time,
              endTimeRaw: e.end_time,
              isAppointment: false // Flag to distinguish from appointments table entries
            };
          });

          // 2. Load appointments from appointments table with date range filter and batch loading
          let allAppointmentsData = [];
          let hasMore = true;
          let page = 0;
          const pageSize = 1000;

          while (hasMore) {
            const { data: appointmentsBatch, error: appointmentsError } = await supabase
              .from('appointments')
              .select(`
                *,
                customer:customers(first_name, last_name),
                artist:artists(id, name, is_guest)
              `)
              .eq('location_id', selectedLocationId)
              .gte('start', startDateStr)
              .lte('start', endDateStr + 'T23:59:59')
              .not('start', 'is', null)
              .not('end', 'is', null)
              .order('start', { ascending: true })
              .range(page * pageSize, (page + 1) * pageSize - 1);

            if (appointmentsError) {
              console.error('Error loading appointments batch:', appointmentsError);
              hasMore = false;
              break;
            }

            if (appointmentsBatch && appointmentsBatch.length > 0) {
              allAppointmentsData = [...allAppointmentsData, ...appointmentsBatch];
              console.log(`Loaded batch ${page + 1}: ${appointmentsBatch.length} appointments`);

              // If we got less than pageSize, we've reached the end
              if (appointmentsBatch.length < pageSize) {
                hasMore = false;
              } else {
                page++;
              }
            } else {
              hasMore = false;
            }
          }

          console.log(`Total appointments loaded for location ${selectedLocationId}:`, allAppointmentsData.length);

          const processedAppointments = (allAppointmentsData || []).map(apt => {
            const artist = apt.artist || allArtists.find(a => a.email === apt.artist_email);

            const startHour = parseLocalTime(apt.start);
            const endHour = parseLocalTime(apt.end);

            // Determine category based on artist
            let category = 'resident'; // Default to resident
            if (artist && artist.is_guest) {
              category = 'guest';
            }

            // Build customer name
            const customerName = apt.customer
              ? `${apt.customer.first_name || ''} ${apt.customer.last_name || ''}`.trim()
              : null;

            return {
              id: apt.id,
              date: apt.start.split('T')[0],
              category: category,
              slot: apt.slot || 1,
              title: customerName || 'Customer',
              type: apt.booking_type || null,
              artistName: artist?.name || null,
              artistId: artist?.id || apt.artist_id || null,
              customerName: customerName,
              customerId: apt.customer_id || null,
              attendanceRequired: false,
              startHour: startHour,
              endHour: endHour,
              startTimeRaw: apt.start,
              endTimeRaw: apt.end,
              isAppointment: true, // Flag to distinguish from events table entries
              // Include all payment and appointment data
              paymentStatus: apt.payment_status || 'unpaid',
              paymentAmount: apt.payment_amount,
              depositAmount: apt.deposit_amount,
              totalAmount: apt.total_amount,
              priceEstimate: apt.price_estimate,
              stripePaymentLink: apt.stripe_payment_link,
              projectNumber: apt.project_number,
              customerEmail: apt.customer_email,
              customerPhone: apt.customer_phone,
              placement: apt.placement,
              size: apt.size,
              style: apt.style,
              colorway: apt.colorway,
              instagram: apt.instagram,
              internalNotes: apt.internal_notes,
              customerNotes: apt.customer_notes,
              status: apt.status,
              durationMinutes: apt.duration_minutes,
              workProcess: apt.work_process || null,
              fullData: apt // Store full appointment data for modal
            };
          });

          // 3. Load ARTIST INFOS (internal artist blocks/notes)
          console.log('ðŸ“Œ Loading artist infos...');
          let allArtistInfosData = [];
          page = 0;
          hasMore = true;

          while (hasMore) {
            const { data: artistInfosBatch, error: artistInfosError } = await supabase
              .from('artist_infos')
              .select(`
                *,
                artist:artists(id, name, is_guest, email)
              `)
              .eq('location_id', selectedLocationId)
              .gte('start', startDateStr)
              .lte('start', endDateStr + 'T23:59:59')
              .not('start', 'is', null)
              .not('end', 'is', null)
              .order('start', { ascending: true })
              .range(page * pageSize, (page + 1) * pageSize - 1);

            if (artistInfosError) {
              console.warn('âš ï¸ Error loading artist infos batch:', artistInfosError);
              console.warn('   Artist infos table may not exist yet - skipping');
              hasMore = false;
              break;
            }

            if (artistInfosBatch && artistInfosBatch.length > 0) {
              allArtistInfosData = [...allArtistInfosData, ...artistInfosBatch];
              console.log(`Loaded artist infos batch ${page + 1}: ${artistInfosBatch.length} items`);

              if (artistInfosBatch.length < pageSize) {
                hasMore = false;
              } else {
                page++;
              }
            } else {
              hasMore = false;
            }
          }

          console.log(`âœ… Total artist infos loaded:`, allArtistInfosData.length);

          // Process artist infos
          const processedArtistInfos = (allArtistInfosData || []).map(info => {
            const artist = info.artist || allArtists.find(a => a.id === info.artist_id);

            const startHour = parseLocalTime(info.start);
            const endHour = parseLocalTime(info.end);

            return {
              id: `artist-info-${info.id}`,
              originalId: info.id,
              date: info.start.split('T')[0],
              category: 'artist_info', // Special category for artist infos
              slot: info.slot || 1,
              title: info.notice || 'Artist Note',
              type: 'artist_info',
              artistName: artist?.name || 'Unknown Artist',
              artistId: info.artist_id,
              customerName: null, // Artist infos have no customers
              customerId: null,
              attendanceRequired: false,
              startHour: startHour,
              endHour: endHour,
              startTimeRaw: info.start,
              endTimeRaw: info.end,
              isAppointment: false,
              isArtistInfo: true, // Flag for special rendering
              notice: info.notice,
              fullData: info
            };
          });

          // 4. Combine events, appointments, and artist infos
          events = [...processedEvents, ...processedAppointments, ...processedArtistInfos];

          console.log(`Total items in calendar: ${events.length} (${processedEvents.length} events + ${processedAppointments.length} appointments + ${processedArtistInfos.length} artist infos)`);

          // Update Location Info
          const { data: locationData } = await supabase
            .from('locations')
            .select('name')
            .eq('id', selectedLocationId)
            .single();

          const infoDiv = document.getElementById('locationInfo');
          if (infoDiv) {
            const dateRangeText = `${startDateStr} to ${endDateStr}`;
            infoDiv.textContent = `ðŸ“ ${locationData?.name || 'Location'} â€¢ ${events.length} item${events.length !== 1 ? 's' : ''} (${processedEvents.length} events, ${processedAppointments.length} appointments, ${processedArtistInfos.length} artist notes) â€¢ Date range: ${dateRangeText}`;
          }

          console.log('Processed calendar items:', events);
        } catch(err) {
          console.error("Events error:", err);
          events = [];
        }
      }

      // Make loadEvents globally available
      window.loadEvents = loadEvents;

      // ============================================
      // CREATE EVENT / BOOKING FUNCTIONS (STUBS)
      // ============================================
      // NOTE: These functions are referenced by onclick handlers in the HTML
      // but their full implementation is not yet complete

      window.createEvent = function createEvent() {
        console.warn('âš ï¸ createEvent() called but not fully implemented');
        alert('Event-Erstellung:\n\nDiese Funktion wird derzeit entwickelt.\n\nBitte verwenden Sie vorerst alternative Methoden zum Erstellen von Events oder kontaktieren Sie den Administrator.');
        // TODO: Implement full event creation flow
        // - Show modal with event form
        // - Collect event details (title, start, end, artist_id, location_id)
        // - Validate input
        // - Insert into events table
        // - Reload calendar
      };

      window.createBooking = function createBooking() {
        console.warn('âš ï¸ createBooking() called but not fully implemented');
        alert('Booking-Erstellung:\n\nDiese Funktion wird derzeit entwickelt.\n\nBitte verwenden Sie vorerst alternative Methoden zum Erstellen von Bookings oder kontaktieren Sie den Administrator.');
        // TODO: Implement full booking creation flow
        // - Show modal with booking form
        // - Collect booking details (customer, artist, type, start, end, location_id)
        // - Validate input
        // - Insert into appointments table
        // - Reload calendar
      };

      // ============================================
      // ARTIST INFO MODAL
      // ============================================
      window.openArtistInfoModal = function openArtistInfoModal(infoId, eventData) {
        console.log('ðŸ“Œ Opening artist info modal:', infoId, eventData);

        // Create modal if it doesn't exist
        let modal = document.getElementById('artistInfoModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'artistInfoModal';
          modal.className = 'modal-backdrop';
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
          `;
          document.body.appendChild(modal);

          // Close on backdrop click
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeArtistInfoModal();
            }
          });
        }

        // Format dates
        const formatDateTime = (dateStr) => {
          if (!dateStr) return 'N/A';
          const date = new Date(dateStr);
          return date.toLocaleString('de-DE', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        };

        modal.innerHTML = `
          <div style="background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="padding: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                  ðŸ“Œ Artist Note
                </h2>
                <button onclick="closeArtistInfoModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #86868b; line-height: 1; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.05)'" onmouseout="this.style.background='none'">Ã—</button>
              </div>

              <div style="background: rgba(0,0,0,0.03); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                <div style="font-size: 14px; color: #86868b; margin-bottom: 4px;">Artist</div>
                <div style="font-size: 18px; font-weight: 600;">${eventData.artistName || 'Unknown Artist'}</div>
              </div>

              <div style="background: rgba(0,0,0,0.03); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                <div style="font-size: 14px; color: #86868b; margin-bottom: 4px;">Note</div>
                <div style="font-size: 16px; white-space: pre-wrap;">${eventData.notice || 'No note'}</div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div style="background: rgba(0,0,0,0.03); padding: 16px; border-radius: 12px;">
                  <div style="font-size: 14px; color: #86868b; margin-bottom: 4px;">Start</div>
                  <div style="font-size: 16px; font-weight: 600;">${formatDateTime(eventData.startTimeRaw)}</div>
                </div>
                <div style="background: rgba(0,0,0,0.03); padding: 16px; border-radius: 12px;">
                  <div style="font-size: 14px; color: #86868b; margin-bottom: 4px;">End</div>
                  <div style="font-size: 16px; font-weight: 600;">${formatDateTime(eventData.endTimeRaw)}</div>
                </div>
              </div>

              <div style="padding: 16px; background: rgba(255, 193, 7, 0.1); border-radius: 12px; border-left: 4px solid #FFC107;">
                <div style="font-size: 13px; color: #856404; font-weight: 500;">
                  â„¹ï¸ Artist notes are internal blocks for scheduling and do not count in statistics.
                </div>
              </div>
            </div>
          </div>
        `;

        modal.style.display = 'flex';
      };

      window.closeArtistInfoModal = function closeArtistInfoModal() {
        const modal = document.getElementById('artistInfoModal');
        if (modal) {
          modal.style.display = 'none';
        }
      };

      // ============================================
      // CREATE ARTIST INFO FUNCTION
      // ============================================
      window.createArtistInfo = async function createArtistInfo(artistId, start, end, notice) {
        try {
          console.log('ðŸ“Œ Creating artist info:', { artistId, start, end, notice });

          if (!artistId || !start || !end) {
            throw new Error('Artist ID, start, and end times are required');
          }

          if (!selectedLocationId) {
            throw new Error('No location selected');
          }

          const { data: newInfo, error } = await supabase
            .from('artist_infos')
            .insert({
              artist_id: artistId,
              location_id: selectedLocationId,
              start: start,
              end: end,
              notice: notice || ''
            })
            .select()
            .single();

          if (error) throw error;

          console.log('âœ… Created artist info:', newInfo);
          alert('âœ… Artist Note erfolgreich erstellt!');

          // Reload calendar events
          await loadEvents();
          renderCalendar();

          return newInfo;

        } catch (error) {
          console.error('âŒ Error creating artist info:', error);
          alert('Fehler beim Erstellen der Artist Note: ' + error.message);
          throw error;
        }
      };

      // Show create artist info modal (stub - to be implemented later)
      window.showCreateArtistInfoModal = function showCreateArtistInfoModal() {
        console.warn('âš ï¸ showCreateArtistInfoModal() called but not fully implemented');
        alert('Artist Note Erstellung:\n\nDiese Funktion wird derzeit entwickelt.\n\nVerwenden Sie vorerst die API oder kontaktieren Sie den Administrator.');
        // TODO: Implement full UI modal for creating artist infos
        // - Show form with artist selector, date/time pickers, notice textarea
        // - Validate and call createArtistInfo()
      };

      // Helper function to check if current date is outside loaded range
      function isDateOutsideLoadedRange() {
        if (!loadedDateRangeStart || !loadedDateRangeEnd) {
          return true; // No data loaded yet
        }

        const currentDateOnly = new Date(currentDate);
        currentDateOnly.setHours(0, 0, 0, 0);

        return currentDateOnly < loadedDateRangeStart || currentDateOnly > loadedDateRangeEnd;
      }

      // Smart function to change date and reload if necessary
      async function changeDateAndReloadIfNeeded(newDate) {
        const oldDate = new Date(currentDate);
        currentDate = newDate;

        // Check if we need to reload events
        if (isDateOutsideLoadedRange()) {
          console.log('Date is outside loaded range, reloading events...');
          await loadEvents();
        }

        renderCalendar();
      }

      // Find available slot for a given date, category, start and end hour
      function findAvailableSlot(date, category, startHour, endHour) {
        // Get all events for this date and category
        const dateEvents = events.filter(e => 
          e.date === date && 
          e.category === category
        );
        
        // Check each slot from 1-10
        for (let slot = 1; slot <= 10; slot++) {
          // Check if this slot has any overlapping events
          const hasConflict = dateEvents.some(e => 
            e.slot === slot &&
            !(endHour <= e.startHour || startHour >= e.endHour)
          );
          
          if (!hasConflict) {
            return slot; // Found a free slot
          }
        }
        
        return null; // All slots are occupied
      }


      // Helper function to get readable event type labels
      function getEventTypeLabel(type) {
        const typeLabels = {
          'consultation': 'Consultation',
          'new_tattoo': 'New Tattoo',
          'continuing_tattoo': 'Continuing',
          'touch_up': 'Touch Up',
          'selfbooking': 'Selfbooking',
          'wannado': 'WannaDo',
          'internal': 'Internal',
          'move': 'Move',
          'reserved': 'Reserved',
          'no_show': 'No Show'
        };
        return typeLabels[type] || type;
      }
      
      function renderCalendar() {
        const dateStr = currentDate.toISOString().split('T')[0];
        document.getElementById('datePickerInput').value = dateStr;

        // Update date display (z.B. "Mo. 20. Oktober 2025")
        const dateDisplayTop = document.getElementById('currentDateDisplayTop');
        if (dateDisplayTop) {
          const day = currentDate.getDate();
          const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni',
                              'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
          const month = monthNames[currentDate.getMonth()];
          const year = currentDate.getFullYear();
          const weekdayShort = currentDate.toLocaleDateString('de-DE', { weekday: 'short' });
          const formattedDate = `${weekdayShort} ${day}. ${month} ${year}`;
          dateDisplayTop.textContent = formattedDate;
        }

        // Check if today
        const today = new Date();
        const isToday = dateStr === today.toISOString().split('T')[0];

        const container = document.getElementById('calendarContainer');
        if (!container) return;

        let html = '<div class="calendar-grid" style="position:relative;">';

        html += '<div class="calendar-header"><div class="slot-header">Slots</div>';
        for (let h = 10; h <= 20; h++) html += `<div class="hour-header" style="grid-column:span 2;">${h}:00</div>`;
        html += '</div>';

        // Define categories to render
        const categoriesToRender = [
          { key: 'events', label: 'Events', visible: visibleCategories.events },
          { key: 'resident', label: 'Residents', visible: visibleCategories.residents },
          { key: 'guest', label: 'Guests', visible: visibleCategories.guests },
          { key: 'artist_info', label: 'Artist Notes', visible: true } // Always show artist infos
        ];

        categoriesToRender.forEach(({ key, label, visible }) => {
          const cat = key === 'events' ? 'events' : key;

          // Always show category header
          html += '<div class="calendar-header"><div class="category-header">' + label + '</div>';
          for (let h = 10; h <= 20; h++) html += '<div class="category-spacer" style="grid-column:span 2;"></div>';
          html += '</div>';

          // Only show slots if visible
          if (visible) {
            // Get all events for this category and date
            const categoryEvents = events.filter(e =>
              e.date === dateStr && e.category === cat
            );

            console.log(`ðŸ“… Rendering ${categoryEvents.length} ${label} for ${dateStr}`);

            // CRITICAL: Each appointment gets its OWN ROW
            // Sort by start time
            const sortedEvents = categoryEvents.sort((a, b) => a.startHour - b.startHour);

            // If no events, show at least one empty slot
            if (sortedEvents.length === 0) {
              html += `<div class="slot-row empty-row"><div class="slot-label">Slot 1</div>`;

              // Empty cells
              for (let h = 10; h <= 20; h++) {
                html += `<div class="slot-cell"></div>`;
                html += `<div class="slot-cell half-hour"></div>`;
              }

              html += '</div>';
            } else {
              // Render each event in its own row
              sortedEvents.forEach((evt, index) => {
                const slotNumber = index + 1;
                const artistName = evt.artistName || '';
                const slotLabel = artistName ? `Slot ${slotNumber} - ${artistName}` : `Slot ${slotNumber}`;

                html += `<div class="slot-row"><div class="slot-label">${slotLabel}</div>`;

                // Create cells for time slots 10:00 - 21:00
                const cells = [];
                for (let h = 10; h <= 20; h++) {
                  [0, 0.5].forEach(offset => {
                    const currentTime = h + offset;
                    cells.push({
                      time: currentTime,
                      isEventStart: false,
                      span: 0
                    });
                  });
                }

                // Mark where this event starts and its span
                const startIndex = Math.max(0, Math.floor((evt.startHour - 10) * 2));
                const endIndex = Math.min(cells.length, Math.floor((evt.endHour - 10) * 2));
                const span = endIndex - startIndex;

                if (span > 0 && startIndex < cells.length) {
                  cells[startIndex].isEventStart = true;
                  cells[startIndex].span = span;
                  cells[startIndex].event = evt;

                  // Mark occupied cells
                  for (let i = startIndex + 1; i < endIndex && i < cells.length; i++) {
                    cells[i].occupied = true;
                  }
                }

                // Render cells
                cells.forEach((cell, index) => {
                  if (cell.occupied) {
                    // Skip - covered by span
                    return;
                  }

                  if (cell.isEventStart && cell.event) {
                    // This is the start of an event
                    const isHalfHour = (index % 2) === 1;
                    const typeAttr = cell.event.type ? `data-type="${cell.event.type}"` : '';

                    // Format start and end time
                    const startHour = Math.floor(cell.event.startHour);
                    const startMin = Math.round((cell.event.startHour % 1) * 60);
                    const endHour = Math.floor(cell.event.endHour);
                    const endMin = Math.round((cell.event.endHour % 1) * 60);
                    const startTimeStr = `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}`;
                    const endTimeStr = `${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`;
                    const timeStr = `${startTimeStr} - ${endTimeStr}`;

                    // Type label mapping
                    const typeLabels = {
                      'consultation': 'Beratung',
                      'new_tattoo': 'Neustechen',
                      'continuing_tattoo': 'Weiterstechen',
                      'touch_up': 'Nachstechen',
                      'selfbooking': 'Selfbooking',
                      'wannado': 'WannaDo',
                      'internal': 'Intern',
                      'move': 'Verschiebung',
                      'reserved': 'Reserviert',
                      'no_show': 'No Show'
                    };

                    const typeLabel = cell.event.type ? typeLabels[cell.event.type] || cell.event.type : '';

                    // Payment status text labels
                    const paymentLabels = {
                      'unpaid': 'Unbezahlt',
                      'deposit_paid': 'Anzahlung erhalten',
                      'fully_paid': 'VollstÃ¤ndig bezahlt',
                      'refunded': 'RÃ¼ckerstattet'
                    };
                    const paymentLabel = cell.event.isAppointment && cell.event.paymentStatus
                      ? paymentLabels[cell.event.paymentStatus] || paymentLabels['unpaid']
                      : '';

                    // Build content based on category
                    let content = '';
                    let isArtistInfoEvent = cell.event.isArtistInfo === true;

                    if (isArtistInfoEvent) {
                      // Artist Info: Compact display with just notice text
                      content = `<div style="font-weight:600; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${cell.event.title}</div>`;
                    } else if (cat === 'events') {
                      // For events: time, title, and type
                      const titleContent = cell.event.artistId
                        ? `<div style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:2px; cursor:pointer; text-decoration:underline;" onclick="event.stopPropagation(); viewArtistProfile('${cell.event.artistId}');">${cell.event.title}</div>`
                        : `<div style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:2px;">${cell.event.title}</div>`;

                      content = `
                        <div style="font-weight:600; font-size:12px; margin-bottom:3px;">${timeStr}</div>
                        ${titleContent}
                        ${typeLabel ? `<div style="font-size:10px; color:rgba(0,0,0,0.5); font-weight:500; text-transform:uppercase; letter-spacing:0.3px;">${typeLabel}</div>` : ''}
                      `;
                    } else {
                      // For bookings: time + name in one line, then type, payment status, work_process
                      const customerName = cell.event.customerName || 'Kunde';
                      const customerLink = cell.event.customerId
                        ? `<span style="cursor:pointer; text-decoration:underline;" onclick="event.stopPropagation(); openCustomerProfile('${cell.event.customerId}');">${customerName}</span>`
                        : customerName;

                      // Work process label
                      const workProcessLabel = cell.event.workProcess
                        ? `<div style="font-size:9px; margin-top:2px; opacity:0.7; font-style:italic;">${cell.event.workProcess}</div>`
                        : '';

                      content = `
                        <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:3px; gap:6px;">
                          <span style="font-weight:600; font-size:11px; color:rgba(0,0,0,0.7); white-space:nowrap;">${timeStr}</span>
                          <span style="font-weight:600; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1; text-align:right;">${customerLink}</span>
                        </div>
                        ${typeLabel ? `<div style="font-size:10px; font-weight:500; margin-bottom:2px; opacity:0.8;">${typeLabel}</div>` : ''}
                        ${paymentLabel ? `<div style="font-size:9px; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; color:rgba(0,0,0,0.6); margin-bottom:2px;">${paymentLabel}</div>` : ''}
                        ${workProcessLabel}
                      `;
                    }

                    // Add attendance required indicator for events
                    const attendanceIndicator = (cat === 'events' && cell.event.attendanceRequired) ?
                      `<div style="position:absolute; top:8px; right:8px; width:8px; height:8px; background:#ff3b30; border-radius:50%; box-shadow:0 1px 3px rgba(255,59,48,0.4);"></div>` : '';

                    // Artist Info: Use special CSS class and click handler
                    const artistInfoClass = isArtistInfoEvent ? 'artist-info-event' : '';
                    const clickHandler = isArtistInfoEvent
                      ? `onclick="openArtistInfoModal('${cell.event.originalId}', ${JSON.stringify(cell.event).replace(/"/g, '&quot;')})"`
                      : `onclick="openEditEventModal('${cell.event.id}')"`;

                    html += `<div class="slot-cell ${isHalfHour ? 'half-hour' : ''}" style="grid-column: span ${cell.span}; position: relative;">
                      <div class="event ${cat} ${artistInfoClass}" ${typeAttr} data-event-id="${cell.event.id}" ${clickHandler} style="position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px; display:flex; flex-direction:column; justify-content:${isArtistInfoEvent ? 'center' : 'flex-start'}; align-items:flex-start; overflow:hidden;">
                        ${content}
                        ${attendanceIndicator}
                      </div>
                    </div>`;
                  } else {
                    // Empty cell
                    const isHalfHour = (index % 2) === 1;
                    html += `<div class="slot-cell ${isHalfHour ? 'half-hour' : ''}"></div>`;
                  }
                });

                html += '</div>';
              });
            }
          }
        });

        html += '</div>';
        container.innerHTML = html;

        // Add current time indicator if today
        // Clear old interval if exists (prevent memory leak)
        if (currentTimeIndicatorInterval) {
          clearInterval(currentTimeIndicatorInterval);
          currentTimeIndicatorInterval = null;
        }

        if (isToday) {
          addCurrentTimeIndicator();
          // Update every minute and track interval
          currentTimeIndicatorInterval = setInterval(updateCurrentTimeIndicator, 60000);
        }
      }

      // Make renderCalendar globally available
      window.renderCalendar = renderCalendar;

      function addCurrentTimeIndicator() {
        const now = new Date();
        const currentHour = now.getHours() + now.getMinutes() / 60;
        
        // Only show if current time is within calendar range (10-20)
        if (currentHour < 10 || currentHour > 20) return;
        
        updateCurrentTimeIndicator();
      }
      
      function updateCurrentTimeIndicator() {
        // Remove old indicator
        const oldIndicator = document.querySelector('.current-time-indicator');
        if (oldIndicator) oldIndicator.remove();
        
        const now = new Date();
        const currentHour = now.getHours() + now.getMinutes() / 60;
        
        // Only show if current time is within calendar range
        if (currentHour < 10 || currentHour > 20) return;
        
        const calendarGrid = document.querySelector('.calendar-grid');
        if (!calendarGrid) return;
        
        // Calculate position (10:00 = 0%, 20:00 = 100%)
        const startHour = 10;
        const endHour = 20;
        const totalHours = endHour - startHour;
        const hoursFromStart = currentHour - startHour;
        const percentage = (hoursFromStart / totalHours) * 100;
        
        // Calculate pixel position
        // Grid has 1 slot column (120px) + 22 time columns
        const slotColumnWidth = 120;
        const gridWidth = calendarGrid.offsetWidth;
        const timeColumnsWidth = gridWidth - slotColumnWidth;
        const pixelPosition = slotColumnWidth + (timeColumnsWidth * percentage / 100);
        
        const indicator = document.createElement('div');
        indicator.className = 'current-time-indicator';
        indicator.style.left = `${pixelPosition}px`;
        indicator.style.top = '0';
        indicator.style.bottom = '0';
        
        calendarGrid.appendChild(indicator);
      }

      document.getElementById('prevDayBtn').addEventListener('click', async () => {
        const newDate = new Date(currentDate);
        newDate.setDate(newDate.getDate() - 1);
        await changeDateAndReloadIfNeeded(newDate);
      });

      document.getElementById('nextDayBtn').addEventListener('click', async () => {
        const newDate = new Date(currentDate);
        newDate.setDate(newDate.getDate() + 1);
        await changeDateAndReloadIfNeeded(newDate);
      });

      document.getElementById('todayBtn').addEventListener('click', async () => {
        await changeDateAndReloadIfNeeded(new Date());
      });

      document.getElementById('datePickerInput').addEventListener('change', async (e) => {
        await changeDateAndReloadIfNeeded(new Date(e.target.value));
      });
      
      // Add Artist Button - Opens Add Artist Modal
      document.getElementById('addArtistBtn')?.addEventListener('click', async () => {
        // Populate location dropdown
        const { data: locations } = await supabase.from('locations').select('*').order('name', { ascending: true });
        const locSelect = document.getElementById('addArtistLocation');
        if (locSelect && locations) {
          locSelect.innerHTML = '<option value="">-- Select Location --</option>' + 
            locations.map(l => `<option value="${l.id}" ${l.id === selectedLocationId ? 'selected' : ''}>${l.name}</option>`).join('');
        }
        
        // Open modal
        document.getElementById('addArtistModal').classList.add('active');
      });
      
      // Cancel Add Artist
      document.getElementById('cancelAddArtist')?.addEventListener('click', () => {
        document.getElementById('addArtistModal').classList.remove('active');
        document.getElementById('addArtistForm').reset();
      });
      
      // Submit Add Artist Form
      document.getElementById('addArtistForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('addArtistName').value.trim();
        const instagram = document.getElementById('addArtistInstagram').value.trim();
        const type = document.getElementById('addArtistType').value;
        const locationId = document.getElementById('addArtistLocation').value;
        const active = document.getElementById('addArtistActive').checked;
        
        if (!name || !locationId) return alert('Please enter name and select location');
        
        try {
          const { error } = await supabase.from('artists').insert({
            name,
            instagram: instagram || null,
            is_guest: type === 'guest',
            active,
            location_id: locationId
          });
          
          if (error) throw error;

          document.getElementById('addArtistModal').classList.remove('active');
          document.getElementById('addArtistForm').reset();
          artistsCache = []; // âœ… Clear cache to force reload
          await loadInitialData();
          await loadArtists();
          alert('Artist added successfully!');
        } catch(err) {
          alert('Error: ' + err.message);
        }
      });
      
      // Add Customer Button - Opens Add Customer Modal
      document.getElementById('addCustomerBtn')?.addEventListener('click', () => {
        document.getElementById('addCustomerModal').classList.add('active');
      });
      
      // Cancel Add Customer
      document.getElementById('cancelAddCustomer')?.addEventListener('click', () => {
        document.getElementById('addCustomerModal').classList.remove('active');
        document.getElementById('addCustomerForm').reset();
      });
      
      // Submit Add Customer Form
      document.getElementById('addCustomerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const firstName = document.getElementById('addCustomerFirstName').value.trim();
        const lastName = document.getElementById('addCustomerLastName').value.trim();
        const email = document.getElementById('addCustomerEmail').value.trim();
        const phone = document.getElementById('addCustomerPhone').value.trim();
        const instagram = document.getElementById('addCustomerInstagram').value.trim();
        const rank = document.getElementById('addCustomerRank').value;

        if (!firstName || !lastName || !email) {
          return alert('Please fill in first name, last name, and email');
        }

        try {
          const { error } = await supabase.from('customers').insert({
            first_name: firstName,
            last_name: lastName,
            email,
            phone: phone || null,
            instagram: instagram || null,
            rank: rank || null
          });

          if (error) throw error;

          document.getElementById('addCustomerModal').classList.remove('active');
          document.getElementById('addCustomerForm').reset();
          customersCache = []; // âœ… Clear cache to force reload
          await loadCustomers();
          alert('âœ… Customer added successfully!');
        } catch(err) {
          alert('âŒ Error: ' + err.message);
        }
      });
      
      // Artist Filter Event Listeners
      document.getElementById('artistSearchInput')?.addEventListener('input', filterArtists);
      document.getElementById('artistLocationFilter')?.addEventListener('change', filterArtists);
      document.getElementById('artistRankFilter')?.addEventListener('change', filterArtists);
      document.getElementById('artistTypeFilter')?.addEventListener('change', filterArtists);
      document.getElementById('artistStatusFilter')?.addEventListener('change', filterArtists);

      // Customer Filter Event Listeners
      document.getElementById('customerSearchInput')?.addEventListener('input', filterCustomers);
      document.getElementById('customerRankFilter')?.addEventListener('change', filterCustomers);
      document.getElementById('customerBlacklistFilter')?.addEventListener('change', filterCustomers);
      document.getElementById('customerBookingsFilter')?.addEventListener('change', filterCustomers);
      
      // Edit Artist Functions
      window.editArtist = async function(artistId) {
        const artist = allArtists.find(a => a.id === artistId);
        if (!artist) return;
        
        currentEditArtistId = artistId;
        
        document.getElementById('editArtistName').value = artist.name;
        document.getElementById('editArtistInstagram').value = artist.instagram || '';
        document.getElementById('editArtistType').value = artist.is_guest ? 'guest' : 'resident';
        
        // Set location dropdown (static values, so just select current)
        document.getElementById('editArtistLocation').value = artist.city_location || '';
        document.getElementById('editArtistRank').value = artist.rank || '';
        document.getElementById('editArtistActive').checked = artist.active;
        
        document.getElementById('editArtistModal').classList.add('active');
      };
      
      document.getElementById('cancelEditArtist')?.addEventListener('click', () => {
        document.getElementById('editArtistModal').classList.remove('active');
        currentEditArtistId = null;
      });
      
      document.getElementById('editArtistForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('editArtistName').value.trim();
        const instagram = document.getElementById('editArtistInstagram').value.trim();
        const type = document.getElementById('editArtistType').value;
        const active = document.getElementById('editArtistActive').checked;
        
        if (!name) return alert('Name is required');
        
        try {
          const location = document.getElementById('editArtistLocation').value;
          const rank = document.getElementById('editArtistRank').value;
          
          const { error } = await supabase
            .from('artists')
            .update({
              name,
              instagram: instagram || null,
              is_guest: type === 'guest',
              city_location: location || null,
              rank: rank || null,
              active
            })
            .eq('id', currentEditArtistId);
          
          if (error) throw error;

          document.getElementById('editArtistModal').classList.remove('active');
          currentEditArtistId = null;

          // Clear cache and reload all data to ensure fresh info
          artistsCache = []; // âœ… Clear cache to force reload
          await loadInitialData();
          await loadArtists();
          renderCalendar();
          alert('Artist updated successfully!');
        } catch (err) {
          alert('Error updating artist: ' + err.message);
        }
      });
      
      // Delete Artist Function
      window.deleteArtist = async function(artistId) {
        const artist = allArtists.find(a => a.id === artistId);
        if (!artist) return;

        if (!confirm(`Are you sure you want to delete "${artist.name}"? This action cannot be undone.`)) {
          return;
        }

        try {
          const { error } = await supabase
            .from('artists')
            .delete()
            .eq('id', artistId);

          if (error) throw error;

          artistsCache = []; // âœ… Clear cache to force reload
          await loadInitialData();
          await loadArtists();
          renderCalendar();
          alert('Artist deleted successfully!');
        } catch (err) {
          alert('Error deleting artist: ' + err.message);
        }
      };

      // View Artist Profile Functions
      window.viewArtistProfile = async function(artistId) {
        const artist = allArtists.find(a => a.id === artistId);
        if (!artist) {
          alert('âŒ Artist not found');
          return;
        }

        // Show modal immediately with loading state
        document.getElementById('viewArtistProfileModal').classList.add('active');
        document.querySelector('#viewArtistProfileModal h3').textContent = `Artist Profile - ${artist.name}`;

        // Populate modal with artist data
        const content = document.getElementById('viewArtistProfileContent');

        // Format Instagram handle
        const instagramDisplay = artist.instagram
          ? `<a href="https://instagram.com/${artist.instagram.replace('@', '')}" target="_blank" style="color:var(--location-primary); text-decoration:none;">@${artist.instagram.replace('@', '')}</a>`
          : '<span style="color:var(--muted);">-</span>';

        // Format location
        const locationDisplay = artist.city_location
          ? `<span class="location-badge">${artist.city_location}</span>`
          : (artist.location && artist.location.name)
            ? `<span class="location-badge">${artist.location.name}</span>`
            : '<span style="color:var(--muted);">-</span>';

        // Format type badge
        const typeDisplay = `<span class="type-badge ${artist.is_guest ? 'guest' : 'resident'}">${artist.is_guest ? 'ðŸ‘¥ Guest' : 'ðŸ  Resident'}</span>`;

        // Format rank badge
        const rankDisplay = `<span class="rank-badge rank-${artist.rank || 'R1'}">${artist.rank || 'R1'}</span>`;

        // Format status badge
        const statusDisplay = `<span class="status-badge ${artist.active ? 'active' : 'inactive'}">${artist.active ? 'âœ… Aktiv' : 'âŒ Inaktiv'}</span>`;

        content.innerHTML = `
          <div style="display:grid; gap:20px;">
            <div>
              <h2 style="font-size:24px; font-weight:600; color:var(--macos-text-primary); margin:0 0 8px 0;">${artist.name || '-'}</h2>
            </div>

            <div style="display:grid; gap:16px;">
              <div style="display:grid; grid-template-columns: 140px 1fr; gap:12px; align-items:start;">
                <span style="color:var(--muted); font-size:13px; font-weight:500;">Instagram:</span>
                <span style="font-size:14px;">${instagramDisplay}</span>
              </div>

              <div style="display:grid; grid-template-columns: 140px 1fr; gap:12px; align-items:center;">
                <span style="color:var(--muted); font-size:13px; font-weight:500;">Type:</span>
                <div>${typeDisplay}</div>
              </div>

              <div style="display:grid; grid-template-columns: 140px 1fr; gap:12px; align-items:center;">
                <span style="color:var(--muted); font-size:13px; font-weight:500;">Location:</span>
                <div>${locationDisplay}</div>
              </div>

              <div style="display:grid; grid-template-columns: 140px 1fr; gap:12px; align-items:center;">
                <span style="color:var(--muted); font-size:13px; font-weight:500;">Rank:</span>
                <div>${rankDisplay}</div>
              </div>

              <div style="display:grid; grid-template-columns: 140px 1fr; gap:12px; align-items:center;">
                <span style="color:var(--muted); font-size:13px; font-weight:500;">Status:</span>
                <div>${statusDisplay}</div>
              </div>

              ${artist.email ? `
              <div style="display:grid; grid-template-columns: 140px 1fr; gap:12px; align-items:start;">
                <span style="color:var(--muted); font-size:13px; font-weight:500;">Email:</span>
                <span style="font-size:14px; color:var(--macos-text-primary);">${artist.email}</span>
              </div>
              ` : ''}

              ${artist.phone ? `
              <div style="display:grid; grid-template-columns: 140px 1fr; gap:12px; align-items:start;">
                <span style="color:var(--muted); font-size:13px; font-weight:500;">Phone:</span>
                <span style="font-size:14px; color:var(--macos-text-primary);">${artist.phone}</span>
              </div>
              ` : ''}

              ${artist.bio ? `
              <div style="display:grid; grid-template-columns: 140px 1fr; gap:12px; align-items:start;">
                <span style="color:var(--muted); font-size:13px; font-weight:500;">Bio:</span>
                <span style="font-size:14px; color:var(--macos-text-primary); line-height:1.6;">${artist.bio}</span>
              </div>
              ` : ''}
            </div>

            <!-- Projects Section -->
            <div style="margin-top:32px; padding-top:24px; border-top:1px solid rgba(0,0,0,0.1);">
              <h4 style="font-size:17px; font-weight:600; color:var(--macos-text-primary); margin-bottom:16px;">Completed Projects</h4>
              <div id="artistProjectsList" style="display:flex; flex-direction:column; gap:12px;">
                <div style="padding:20px; text-align:center; color:var(--macos-text-secondary);">Loading projects...</div>
              </div>
            </div>
          </div>
        `;

        // Set up button event listeners
        document.getElementById('deleteArtistFromProfileBtn').onclick = () => deleteArtistFromProfile(artistId);
        document.getElementById('editArtistFromProfileBtn').onclick = () => editArtistFromProfile(artistId);

        // Load artist projects asynchronously
        try {
          console.log('ðŸ” Loading projects for artist:', artistId);

          const { data: projects, error } = await supabase
            .from('appointments')
            .select(`
              *,
              customer:customers(first_name, last_name, email, instagram),
              location:locations(name, city)
            `)
            .eq('artist_id', artistId)
            .not('artist_id', 'is', null)
            .order('start', { ascending: false });

          if (error) {
            console.error('Error loading artist projects:', error);
            document.getElementById('artistProjectsList').innerHTML =
              '<div style="padding:20px; text-align:center; color:var(--macos-accent-red);">Error loading projects</div>';
            return;
          }

          console.log('âœ… Projects loaded:', projects?.length || 0);
          renderArtistProjectsSection(projects || []);

        } catch (err) {
          console.error('âŒ Error loading artist projects:', err);
          document.getElementById('artistProjectsList').innerHTML =
            '<div style="padding:20px; text-align:center; color:var(--macos-accent-red);">Error loading projects</div>';
        }
      };

      function renderArtistProjectsSection(appointments) {
        const container = document.getElementById('artistProjectsList');

        if (!container) {
          console.error('âŒ artistProjectsList container not found');
          return;
        }

        if (!appointments || appointments.length === 0) {
          container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--macos-text-secondary); background:rgba(0,0,0,0.02); border-radius:8px;">No appointments found</div>';
          return;
        }

        // Group appointments by project_number
        const projectGroups = {};

        appointments.forEach(appointment => {
          const projectNum = appointment.project_number || `no-project`;

          if (!projectGroups[projectNum]) {
            projectGroups[projectNum] = {
              project_number: projectNum,
              appointments: [],
              customer_name: null,
              customer_email: null,
              first_appointment: null,
              last_appointment: null
            };
          }

          projectGroups[projectNum].appointments.push(appointment);

          // Set customer info (all appointments in project have same customer)
          if (appointment.customer) {
            projectGroups[projectNum].customer_name =
              `${appointment.customer.first_name || ''} ${appointment.customer.last_name || ''}`.trim();
            projectGroups[projectNum].customer_email = appointment.customer.email;
          }
        });

        // Calculate date ranges for each project
        Object.values(projectGroups).forEach(project => {
          project.appointments.sort((a, b) => new Date(a.start) - new Date(b.start));
          project.first_appointment = project.appointments[0]?.start;
          project.last_appointment = project.appointments[project.appointments.length - 1]?.start;
        });

        console.log('ðŸ“Š Grouped into', Object.keys(projectGroups).length, 'projects');

        // Convert to array and sort by most recent
        const projects = Object.values(projectGroups)
          .sort((a, b) => new Date(b.last_appointment) - new Date(a.last_appointment));

        // Render project cards
        container.innerHTML = projects.map((project, index) => {
          const projectId = project.project_number.replace(/[^a-zA-Z0-9]/g, '-');

          return `
            <div class="project-card" data-project-number="${project.project_number}">
              <div class="project-header" onclick="toggleArtistProjectDetails('${projectId}')">
                <div class="project-info">
                  <div class="project-title">
                    <span class="project-badge">${project.project_number === 'no-project' ? 'Ungrouped' : project.project_number}</span>
                    <span class="customer-name">${project.customer_name || project.customer_email || 'Unknown Customer'}</span>
                  </div>
                  <div class="project-meta">
                    <span class="appointment-count">${project.appointments.length} ${project.appointments.length === 1 ? 'session' : 'sessions'}</span>
                    <span class="date-range">
                      ${formatProjectDate(project.first_appointment)}
                      ${project.appointments.length > 1 ? ' â†’ ' + formatProjectDate(project.last_appointment) : ''}
                    </span>
                  </div>
                </div>
                <button class="expand-btn" aria-label="Toggle details">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>

              <div class="project-details" id="project-details-${projectId}" style="display: none;">
                ${project.appointments.map(appointment => {
                  const statusClass = appointment.status ? `status-${appointment.status}` : '';
                  return `
                    <div class="appointment-item" style="cursor:pointer; transition:all 0.2s;" onclick="openAppointmentFromProfile('${appointment.id}')" onmouseover="this.style.backgroundColor='rgba(0,0,0,0.03)'" onmouseout="this.style.backgroundColor=''">
                      <div class="appointment-date">
                        ${formatProjectDateTime(appointment.start)}
                      </div>
                      <div class="appointment-info">
                        <span class="booking-type">${appointment.booking_type || 'Appointment'}</span>
                        ${appointment.status ? `<span class="status-badge ${statusClass}">${appointment.status}</span>` : ''}
                      </div>
                      ${appointment.notes ? `<div class="appointment-notes">${appointment.notes}</div>` : ''}
                      ${appointment.placement ? `<div class="appointment-notes">ðŸ“ ${appointment.placement}</div>` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
      }

      // Toggle function for artist project details
      window.toggleArtistProjectDetails = function(projectId) {
        const detailsEl = document.getElementById(`project-details-${projectId}`);
        const card = document.querySelector(`[data-project-number]`);

        if (!detailsEl) return;

        const isVisible = detailsEl.style.display !== 'none';

        // Toggle visibility
        detailsEl.style.display = isVisible ? 'none' : 'block';

        // Rotate expand button
        const expandBtn = detailsEl.previousElementSibling?.querySelector('.expand-btn svg');
        if (expandBtn) {
          expandBtn.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
        }
      };

      // Helper function for project dates
      function formatProjectDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }

      // Helper function for project date-time
      function formatProjectDateTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('de-DE', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      window.closeViewProfile = function() {
        document.getElementById('viewArtistProfileModal').classList.remove('active');
        // Clear content
        document.getElementById('viewArtistProfileContent').innerHTML = '';
        document.querySelector('#viewArtistProfileModal h3').textContent = 'Artist Profile';
      };

      window.deleteArtistFromProfile = async function(artistId) {
        const artist = allArtists.find(a => a.id === artistId);
        if (!artist) {
          alert('âŒ Artist not found');
          return;
        }

        // First confirmation
        if (!confirm(`Are you sure you want to delete ${artist.name}? This action cannot be undone.`)) {
          return;
        }

        // Second confirmation
        if (!confirm(`âš ï¸ FINAL WARNING: This will permanently delete the artist. Click OK to confirm.`)) {
          return;
        }

        try {
          const { error } = await supabase
            .from('artists')
            .delete()
            .eq('id', artistId);

          if (error) throw error;

          // Close modal
          closeViewProfile();

          // Clear cache and reload
          artistsCache = [];
          await loadInitialData();
          await loadArtists();
          renderCalendar();
          alert('Artist deleted successfully!');
        } catch (err) {
          alert('Error deleting artist: ' + err.message);
        }
      };

      window.editArtistFromProfile = function(artistId) {
        // Close view profile modal
        closeViewProfile();
        // Open edit modal
        editArtist(artistId);
      };
      
      // Edit Customer Functions
      window.editCustomer = async function(customerId) {
        try {
          const { data, error } = await supabase
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();
          
          if (error) throw error;
          if (!data) return;
          
          currentEditCustomerId = customerId;
          
          console.log('Loading customer for edit:', data);
          console.log('Customer rank:', data.rank);
          
          document.getElementById('editCustomerFirstName').value = data.first_name || '';
          document.getElementById('editCustomerLastName').value = data.last_name || '';
          document.getElementById('editCustomerEmail').value = data.email || '';
          document.getElementById('editCustomerPhone').value = data.phone || '';
          document.getElementById('editCustomerInstagram').value = data.instagram || '';
          document.getElementById('editCustomerRank').value = data.rank || '';
          
          console.log('Rank field set to:', document.getElementById('editCustomerRank').value);
          
          document.getElementById('editCustomerModal').classList.add('active');
        } catch (err) {
          alert('Error loading customer: ' + err.message);
        }
      };
      
      document.getElementById('cancelEditCustomer')?.addEventListener('click', () => {
        document.getElementById('editCustomerModal').classList.remove('active');
        currentEditCustomerId = null;
      });
      
      document.getElementById('editCustomerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const firstName = document.getElementById('editCustomerFirstName').value.trim();
        const lastName = document.getElementById('editCustomerLastName').value.trim();
        const email = document.getElementById('editCustomerEmail').value.trim();
        const phone = document.getElementById('editCustomerPhone').value.trim();
        const instagram = document.getElementById('editCustomerInstagram').value.trim();
        const rank = document.getElementById('editCustomerRank').value;

        if (!firstName || !lastName || !email) {
          return alert('First name, last name, and email are required');
        }

        try {
          console.log('Updating customer with rank:', rank);
          console.log('Customer ID to update:', currentEditCustomerId);

          const updateData = {
            first_name: firstName,
            last_name: lastName,
            email,
            phone: phone || null,
            instagram: instagram || null,
            rank: rank || null
          };
          
          console.log('Update data:', updateData);
          
          const { data, error } = await supabase
            .from('customers')
            .update(updateData)
            .eq('id', currentEditCustomerId)
            .select();
          
          console.log('Update result:', data, 'Error:', error);
          
          if (error) throw error;
          
          if (!data || data.length === 0) {
            console.error('WARNING: Update returned no data. Customer ID might be wrong:', currentEditCustomerId);
            alert('Warning: Customer was updated but could not verify the result. Please refresh the page.');
          }
          
          console.log('Customer updated successfully, reloading list...');
          
          document.getElementById('editCustomerModal').classList.remove('active');
          currentEditCustomerId = null;

          // Clear cache and reload customers to show updated data
          customersCache = []; // âœ… Clear cache to force reload
          await loadCustomers();

          alert('Customer updated successfully!');
        } catch (err) {
          alert('Error updating customer: ' + err.message);
        }
      });
      
      // Delete Customer Function
      window.deleteCustomer = async function(customerId) {
        try {
          const { data, error } = await supabase
            .from('customers')
            .select('first_name, last_name')
            .eq('id', customerId)
            .single();

          if (error) throw error;
          if (!data) return;

          if (!confirm(`Are you sure you want to delete "${data.first_name} ${data.last_name}"? This action cannot be undone.`)) {
            return;
          }

          const { error: deleteError } = await supabase
            .from('customers')
            .delete()
            .eq('id', customerId);

          if (deleteError) throw deleteError;

          customersCache = []; // âœ… Clear cache to force reload
          await loadCustomers();
          alert('Customer deleted successfully!');
        } catch (err) {
          alert('Error deleting customer: ' + err.message);
        }
      };

      // Customer Profile Functions
      let currentCustomerProfileId = null;

      window.openCustomerProfile = async function(customerId) {
        console.log('ðŸ” Opening customer profile for:', customerId);
        currentCustomerProfileId = customerId;

        try {
          // Show loading state
          document.getElementById('customerProfileModal').classList.add('active');
          document.getElementById('customerProfileName').textContent = 'Loading...';

          // 1. Fetch customer data
          const { data: customer, error: customerError } = await supabase
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();

          if (customerError) throw customerError;
          if (!customer) {
            alert('Customer not found');
            closeCustomerProfile();
            return;
          }

          console.log('âœ… Customer loaded:', customer);

          // 2. Fetch customer's requests
          const { data: requests, error: requestsError } = await supabase
            .from('requests')
            .select('*')
            .eq('customer_id', customerId)
            .order('created_at', { ascending: false });

          if (requestsError) {
            console.error('Error loading requests:', requestsError);
          }

          console.log('âœ… Requests loaded:', requests?.length || 0);

          // 3. Fetch customer's appointments
          const { data: appointments, error: appointmentsError } = await supabase
            .from('appointments')
            .select(`
              *,
              artist:artists(name, instagram),
              location:locations(name, city)
            `)
            .eq('customer_id', customerId)
            .order('start', { ascending: false });

          if (appointmentsError) {
            console.error('Error loading appointments:', appointmentsError);
          }

          console.log('âœ… Appointments loaded:', appointments?.length || 0);

          // 4. Render the profile
          renderCustomerProfile(customer, requests || [], appointments || []);

        } catch (err) {
          console.error('âŒ Error loading customer profile:', err);
          alert('Error loading customer profile: ' + err.message);
          closeCustomerProfile();
        }
      };

      function renderCustomerProfile(customer, requests, appointments) {
        // Update header
        document.getElementById('customerProfileName').textContent =
          `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unnamed Customer';

        // Render rank badge
        const rankBadge = customer.rank
          ? `<span class="rank-badge rank-${customer.rank.toLowerCase()}" style="display:inline-block; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; text-transform:uppercase;">${customer.rank}</span>`
          : '';
        document.getElementById('customerProfileRankBadge').innerHTML = rankBadge;

        // Fill form fields
        document.getElementById('profileCustomerFirstName').value = customer.first_name || '';
        document.getElementById('profileCustomerLastName').value = customer.last_name || '';
        document.getElementById('profileCustomerEmail').value = customer.email || '';
        document.getElementById('profileCustomerPhone').value = customer.phone || '';
        document.getElementById('profileCustomerInstagram').value = customer.instagram || '';
        document.getElementById('profileCustomerRank').value = customer.rank || '';

        // Render project timeline (NEW: combines requests and appointments)
        renderCustomerProjectsTimeline(requests, appointments);

        // Render requests section
        renderCustomerRequestsSection(requests);

        // Render appointments section
        renderCustomerAppointmentsSection(appointments);
      }

      // NEW: Customer Project Timeline
      function renderCustomerProjectsTimeline(requests, appointments) {
        const container = document.getElementById('customerProjectsTimeline');

        if (!container) {
          console.log('âš ï¸ customerProjectsTimeline container not found - add to HTML');
          return;
        }

        // Group by project_number
        const projects = groupCustomerProjects(requests, appointments);

        console.log('ðŸ“¦ Customer has', Object.keys(projects).length, 'projects');

        const projectsArray = Object.values(projects)
          .sort((a, b) => {
            const aDate = a.appointments[0]?.start || '2000-01-01';
            const bDate = b.appointments[0]?.start || '2000-01-01';
            return new Date(bDate) - new Date(aDate);
          });

        if (projectsArray.length === 0) {
          container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--muted);">No projects yet</div>';
          return;
        }

        container.innerHTML = projectsArray.map(project => `
          <div class="customer-project-card ${project.status}">
            <div class="project-status-indicator"></div>
            <div class="project-content">
              <div class="project-header-row">
                <span class="project-number-small">${project.project_number}</span>
                <span class="project-status-badge status-${project.status}">
                  ${project.status === 'completed' ? 'âœ… Completed' :
                    project.status === 'in_progress' ? 'ðŸ”„ In Progress' :
                    project.status === 'requested' ? 'ðŸ“‹ Requested' : 'â“ Unknown'}
                </span>
              </div>
              <div class="project-artist">
                with ${project.artist_name || 'Artist TBD'}
              </div>
              <div class="project-stats">
                <span>${project.appointments.length} appointments</span>
                ${project.requests.length > 0 ? `<span>â€¢</span><span>${project.requests.length} requests</span>` : ''}
              </div>
              ${project.appointments.length > 0 ? `
                <div class="project-timeline-dates">
                  ${formatProjectDate(project.appointments[0].start)}
                  ${project.appointments.length > 1 ? 'â†’ ' + formatProjectDate(project.appointments[project.appointments.length - 1].start) : ''}
                </div>
              ` : ''}
            </div>
          </div>
        `).join('');
      }

      function groupCustomerProjects(requests, appointments) {
        const projects = {};

        // Group appointments
        appointments.forEach(appointment => {
          const projectNumber = appointment.project_number || 'no-project';

          if (!projects[projectNumber]) {
            projects[projectNumber] = {
              project_number: projectNumber,
              requests: [],
              appointments: [],
              artist_name: null,
              status: 'unknown'
            };
          }

          projects[projectNumber].appointments.push(appointment);
          if (appointment.artist) {
            projects[projectNumber].artist_name = appointment.artist.name;
          }
        });

        // Add requests if they have project_number
        requests.forEach(request => {
          if (request.project_number && projects[request.project_number]) {
            projects[request.project_number].requests.push(request);
          }
        });

        // Calculate project status
        Object.values(projects).forEach(project => {
          const hasFinished = project.appointments.some(a => a.status === 'finished' || a.status === 'completed');
          const hasScheduled = project.appointments.some(a => a.status === 'scheduled');

          if (hasFinished && !hasScheduled) {
            project.status = 'completed';
          } else if (hasScheduled) {
            project.status = 'in_progress';
          } else if (project.requests.length > 0) {
            project.status = 'requested';
          } else {
            project.status = 'unknown';
          }

          // Sort appointments by date
          project.appointments.sort((a, b) => new Date(a.start) - new Date(b.start));
        });

        return projects;
      }

      function renderCustomerRequestsSection(requests) {
        const container = document.getElementById('customerRequestsList');

        if (!requests || requests.length === 0) {
          container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--macos-text-secondary); background:rgba(0,0,0,0.02); border-radius:8px;">No requests found</div>';
          return;
        }

        // Group requests by project_number
        const projectGroups = {};

        requests.forEach(request => {
          const projectNum = request.project_number || `ungrouped-req-${request.id}`;
          if (!projectGroups[projectNum]) {
            projectGroups[projectNum] = {
              project_number: projectNum,
              requests: []
            };
          }
          projectGroups[projectNum].requests.push(request);
        });

        console.log('ðŸ“Š Customer requests grouped into', Object.keys(projectGroups).length, 'projects');

        const sortedProjects = Object.values(projectGroups).sort((a, b) =>
          new Date(b.requests[0].created_at) - new Date(a.requests[0].created_at)
        );

        container.innerHTML = sortedProjects.map(project => {
          // If only one request and no project number, show it directly
          if (project.requests.length === 1 && project.project_number.startsWith('ungrouped')) {
            const request = project.requests[0];
            const statusColors = {
              'open_request': { bg: 'rgba(255, 149, 0, 0.1)', color: '#ff9500' },
              'pending': { bg: 'rgba(255, 204, 0, 0.1)', color: '#ffcc00' },
              'scheduled': { bg: 'rgba(0, 113, 227, 0.1)', color: '#0071e3' },
              'finished': { bg: 'rgba(52, 199, 89, 0.1)', color: '#34c759' },
              'canceled': { bg: 'rgba(255, 59, 48, 0.1)', color: '#ff3b30' }
            };
            const statusStyle = statusColors[request.status] || statusColors['open_request'];

            const bookingTypeBadge = request.booking_type
              ? `<span style="background:rgba(0,0,0,0.06); padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; text-transform:uppercase;">${request.booking_type.replace('_', ' ')}</span>`
              : '';

            return `
              <div class="request-card" style="background:rgba(255,255,255,0.7); backdrop-filter:saturate(180%) blur(20px); border-radius:8px; padding:16px; border:1px solid rgba(0,0,0,0.1); transition:all 0.2s ease; cursor:pointer;" onclick="editRequest('${request.id}')" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                  <div>
                    <span style="font-size:12px; color:var(--macos-text-secondary);">Request #${request.id.substring(0, 8)}</span>
                    <div style="margin-top:4px;">${bookingTypeBadge}</div>
                  </div>
                  <span style="background:${statusStyle.bg}; color:${statusStyle.color}; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:600; text-transform:uppercase;">${request.status.replace('_', ' ')}</span>
                </div>
                <div style="font-size:13px; color:var(--macos-text-secondary); margin-bottom:8px;">
                  Created: ${new Date(request.created_at).toLocaleDateString()}
                  ${request.scheduled_date ? `â€¢ Scheduled: ${new Date(request.scheduled_date).toLocaleDateString()}` : ''}
                </div>
                ${request.placement ? `<div style="font-size:13px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Placement:</strong> ${request.placement}</div>` : ''}
                ${request.size ? `<div style="font-size:13px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Size:</strong> ${request.size}</div>` : ''}
                ${request.style ? `<div style="font-size:13px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Style:</strong> ${request.style}</div>` : ''}
                ${request.description ? `<div style="font-size:13px; color:var(--macos-text-secondary); margin-top:8px; line-height:1.5;">${request.description.substring(0, 150)}${request.description.length > 150 ? '...' : ''}</div>` : ''}
              </div>
            `;
          }

          // Multiple requests in same project - show as grouped
          const firstRequest = project.requests[0];
          const lastRequest = project.requests[project.requests.length - 1];

          return `
            <div class="project-group">
              <div class="project-header" onclick="toggleProjectDetails(this)">
                <div class="project-info">
                  <h4>${project.project_number}</h4>
                  <div>
                    <span class="project-stats">
                      ${project.requests.length} Request${project.requests.length > 1 ? 's' : ''} â€¢
                      ${new Date(firstRequest.created_at).toLocaleDateString('de-DE')}
                    </span>
                  </div>
                </div>
                <button class="expand-btn">â–¼</button>
              </div>

              <div class="project-details">
                ${project.requests.map(request => {
                  const statusColors = {
                    'open_request': { bg: 'rgba(255, 149, 0, 0.1)', color: '#ff9500' },
                    'pending': { bg: 'rgba(255, 204, 0, 0.1)', color: '#ffcc00' },
                    'scheduled': { bg: 'rgba(0, 113, 227, 0.1)', color: '#0071e3' },
                    'finished': { bg: 'rgba(52, 199, 89, 0.1)', color: '#34c759' },
                    'canceled': { bg: 'rgba(255, 59, 48, 0.1)', color: '#ff3b30' }
                  };
                  const statusStyle = statusColors[request.status] || statusColors['open_request'];

                  const bookingTypeBadge = request.booking_type
                    ? `<span style="background:rgba(0,0,0,0.06); padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; text-transform:uppercase;">${request.booking_type.replace('_', ' ')}</span>`
                    : '';

                  return `
                    <div class="request-card" style="background:rgba(255,255,255,0.9); border-radius:8px; padding:14px; margin-bottom:8px; border:1px solid rgba(0,0,0,0.08); cursor:pointer; transition:all 0.2s;" onclick="editRequest('${request.id}')" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                        <div>
                          <span style="font-size:12px; color:var(--macos-text-secondary);">Request #${request.id.substring(0, 8)}</span>
                          <div style="margin-top:4px;">${bookingTypeBadge}</div>
                        </div>
                        <span style="background:${statusStyle.bg}; color:${statusStyle.color}; padding:3px 8px; border-radius:4px; font-size:10px; font-weight:600; text-transform:uppercase;">${request.status.replace('_', ' ')}</span>
                      </div>
                      <div style="font-size:12px; color:var(--macos-text-secondary); margin-bottom:6px;">
                        Created: ${new Date(request.created_at).toLocaleDateString()}
                      </div>
                      ${request.placement ? `<div style="font-size:12px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Placement:</strong> ${request.placement}</div>` : ''}
                      ${request.size ? `<div style="font-size:12px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Size:</strong> ${request.size}</div>` : ''}
                      ${request.style ? `<div style="font-size:12px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Style:</strong> ${request.style}</div>` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
      }

      function renderCustomerAppointmentsSection(appointments) {
        const container = document.getElementById('customerAppointmentsList');

        if (!appointments || appointments.length === 0) {
          container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--macos-text-secondary); background:rgba(0,0,0,0.02); border-radius:8px;">No appointments found</div>';
          return;
        }

        // Group appointments by project_number
        const projectGroups = {};

        appointments.forEach(appointment => {
          const projectNum = appointment.project_number || `ungrouped-apt-${appointment.id}`;
          if (!projectGroups[projectNum]) {
            projectGroups[projectNum] = {
              project_number: projectNum,
              appointments: [],
              artist: appointment.artist
            };
          }
          projectGroups[projectNum].appointments.push(appointment);
        });

        console.log('ðŸ“Š Customer appointments grouped into', Object.keys(projectGroups).length, 'projects');

        // Calculate project statistics
        Object.values(projectGroups).forEach(project => {
          project.appointments.sort((a, b) => new Date(a.start) - new Date(b.start));
          project.totalAppointments = project.appointments.length;
          project.firstAppointment = project.appointments[0];
          project.lastAppointment = project.appointments[project.appointments.length - 1];

          // Determine project status
          if (project.appointments.every(a => a.status === 'completed')) {
            project.status = 'Completed';
          } else if (project.appointments.some(a => a.status === 'scheduled')) {
            project.status = 'In Progress';
          } else {
            project.status = 'Scheduled';
          }
        });

        const sortedProjects = Object.values(projectGroups).sort((a, b) =>
          new Date(b.firstAppointment.start) - new Date(a.firstAppointment.start)
        );

        container.innerHTML = sortedProjects.map(project => {
          const artistName = project.artist ? project.artist.name : 'Unassigned';
          const artistInstagram = project.artist?.instagram
            ? ` (@${project.artist.instagram})`
            : '';

          const startDate = new Date(project.firstAppointment.start).toLocaleDateString('de-DE');
          const endDate = new Date(project.lastAppointment.start).toLocaleDateString('de-DE');
          const dateRange = startDate === endDate ? startDate : `${startDate} - ${endDate}`;

          const statusClass = project.status.toLowerCase().replace(' ', '-');

          return `
            <div class="project-group">
              <div class="project-header" onclick="toggleProjectDetails(this)">
                <div class="project-info">
                  <h4>${project.project_number.startsWith('ungrouped') ? 'No Project #' : project.project_number}</h4>
                  <div>
                    <span class="customer-name">${artistName}${artistInstagram}</span>
                    <span class="project-stats">
                      ${project.totalAppointments} Appointment${project.totalAppointments > 1 ? 's' : ''} â€¢ ${dateRange}
                    </span>
                    <span class="project-status ${statusClass}">${project.status}</span>
                  </div>
                </div>
                <button class="expand-btn">â–¼</button>
              </div>

              <div class="project-details">
                ${project.appointments.map(appointment => {
                  const statusColors = {
                    'scheduled': { bg: 'rgba(0, 113, 227, 0.1)', color: '#0071e3' },
                    'completed': { bg: 'rgba(52, 199, 89, 0.1)', color: '#34c759' },
                    'cancelled': { bg: 'rgba(255, 59, 48, 0.1)', color: '#ff3b30' }
                  };
                  const statusStyle = statusColors[appointment.status] || statusColors['scheduled'];

                  const paymentColors = {
                    'paid': { bg: 'rgba(52, 199, 89, 0.1)', color: '#34c759' },
                    'unpaid': { bg: 'rgba(255, 59, 48, 0.1)', color: '#ff3b30' },
                    'partial': { bg: 'rgba(255, 149, 0, 0.1)', color: '#ff9500' }
                  };
                  const paymentStyle = paymentColors[appointment.payment_state] || paymentColors['unpaid'];

                  const locationInfo = appointment.location
                    ? `${appointment.location.name} - ${appointment.location.city}`
                    : 'No location';

                  const bookingTypeBadge = appointment.booking_type
                    ? `<span style="background:rgba(0,0,0,0.06); padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; text-transform:uppercase;">${appointment.booking_type.replace('_', ' ')}</span>`
                    : '';

                  return `
                    <div class="project-card" style="background:rgba(255,255,255,0.9); border-radius:8px; padding:14px; margin-bottom:8px; border:1px solid rgba(0,0,0,0.08); cursor:pointer; transition:all 0.2s;" onclick="openAppointmentFromProfile('${appointment.id}')" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                        <div>
                          <span style="font-size:14px; font-weight:600; color:var(--macos-text-primary);">${new Date(appointment.start).toLocaleString('de-DE')}</span>
                          <div style="margin-top:4px;">${bookingTypeBadge}</div>
                        </div>
                        <div style="display:flex; gap:6px;">
                          <span style="background:${statusStyle.bg}; color:${statusStyle.color}; padding:3px 8px; border-radius:4px; font-size:10px; font-weight:600; text-transform:uppercase;">${appointment.status}</span>
                          <span style="background:${paymentStyle.bg}; color:${paymentStyle.color}; padding:3px 8px; border-radius:4px; font-size:10px; font-weight:600; text-transform:uppercase;">${appointment.payment_state || 'unpaid'}</span>
                        </div>
                      </div>
                      <div style="font-size:12px; color:var(--macos-text-primary); margin-bottom:6px;">
                        <strong>Location:</strong> ${locationInfo}
                      </div>
                      ${appointment.placement ? `<div style="font-size:12px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Placement:</strong> ${appointment.placement}</div>` : ''}
                      ${appointment.size || appointment.style ? `<div style="font-size:12px; color:var(--macos-text-primary); margin-bottom:4px;">${appointment.size ? `<strong>Size:</strong> ${appointment.size}` : ''} ${appointment.size && appointment.style ? '|' : ''} ${appointment.style ? `<strong>Style:</strong> ${appointment.style}` : ''}</div>` : ''}
                      ${appointment.description ? `<div style="font-size:12px; color:var(--macos-text-secondary); margin-top:6px; line-height:1.4;">${appointment.description.substring(0, 100)}${appointment.description.length > 100 ? '...' : ''}</div>` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
      }

      window.saveCustomerDetails = async function() {
        if (!currentCustomerProfileId) {
          alert('Error: No customer selected');
          return;
        }

        const firstName = document.getElementById('profileCustomerFirstName').value.trim();
        const lastName = document.getElementById('profileCustomerLastName').value.trim();
        const email = document.getElementById('profileCustomerEmail').value.trim();
        const phone = document.getElementById('profileCustomerPhone').value.trim();
        const instagram = document.getElementById('profileCustomerInstagram').value.trim();
        const rank = document.getElementById('profileCustomerRank').value;

        if (!firstName || !lastName || !email) {
          alert('First name, last name, and email are required');
          return;
        }

        try {
          console.log('ðŸ’¾ Saving customer details...');

          const updateData = {
            first_name: firstName,
            last_name: lastName,
            email,
            phone: phone || null,
            instagram: instagram || null,
            rank: rank || null
          };

          const { data, error } = await supabase
            .from('customers')
            .update(updateData)
            .eq('id', currentCustomerProfileId)
            .select();

          if (error) throw error;

          console.log('âœ… Customer updated successfully');

          // Clear cache and reload
          customersCache = [];
          await loadCustomers();

          // Re-fetch customer data to update the modal
          const { data: updatedCustomer } = await supabase
            .from('customers')
            .select('*')
            .eq('id', currentCustomerProfileId)
            .single();

          if (updatedCustomer) {
            // Update the display
            document.getElementById('customerProfileName').textContent =
              `${updatedCustomer.first_name || ''} ${updatedCustomer.last_name || ''}`.trim();

            const rankBadge = updatedCustomer.rank
              ? `<span class="rank-badge rank-${updatedCustomer.rank.toLowerCase()}" style="display:inline-block; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; text-transform:uppercase;">${updatedCustomer.rank}</span>`
              : '';
            document.getElementById('customerProfileRankBadge').innerHTML = rankBadge;
          }

          alert('âœ… Customer details saved successfully!');

        } catch (err) {
          console.error('âŒ Error saving customer details:', err);
          alert('Error saving customer details: ' + err.message);
        }
      };

      window.deleteCustomerFromProfile = async function() {
        if (!currentCustomerProfileId) {
          alert('Error: No customer selected');
          return;
        }

        try {
          const { data: customer } = await supabase
            .from('customers')
            .select('first_name, last_name')
            .eq('id', currentCustomerProfileId)
            .single();

          if (!customer) {
            alert('Customer not found');
            return;
          }

          if (!confirm(`âš ï¸ Are you sure you want to delete "${customer.first_name} ${customer.last_name}"?\n\nThis will also delete all their requests and appointments. This action cannot be undone.`)) {
            return;
          }

          if (!confirm(`ðŸš¨ FINAL WARNING: This will permanently delete the customer and all related data. Click OK to confirm.`)) {
            return;
          }

          console.log('ðŸ—‘ï¸ Deleting customer...');

          const { error } = await supabase
            .from('customers')
            .delete()
            .eq('id', currentCustomerProfileId);

          if (error) throw error;

          console.log('âœ… Customer deleted successfully');

          // Close modal
          closeCustomerProfile();

          // Clear cache and reload
          customersCache = [];
          await loadCustomers();

          alert('âœ… Customer deleted successfully!');

        } catch (err) {
          console.error('âŒ Error deleting customer:', err);
          alert('Error deleting customer: ' + err.message);
        }
      };

      window.closeCustomerProfile = function() {
        document.getElementById('customerProfileModal').classList.remove('active');
        currentCustomerProfileId = null;
      };

      // Toggle between Requests and Appointments view in Customer Profile
      window.toggleCustomerView = function(view) {
        const requestsBtn = document.getElementById('showRequestsBtn');
        const appointmentsBtn = document.getElementById('showAppointmentsBtn');
        const requestsView = document.getElementById('customerRequestsView');
        const appointmentsView = document.getElementById('customerAppointmentsView');

        if (view === 'requests') {
          // Show Requests
          requestsView.style.display = 'block';
          appointmentsView.style.display = 'none';

          // Update button styles
          requestsBtn.style.background = 'rgba(255,255,255,0.9)';
          requestsBtn.style.color = 'var(--macos-text-primary)';
          requestsBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
          appointmentsBtn.style.background = 'transparent';
          appointmentsBtn.style.color = 'var(--macos-text-secondary)';
          appointmentsBtn.style.boxShadow = 'none';
        } else if (view === 'appointments') {
          // Show Appointments
          requestsView.style.display = 'none';
          appointmentsView.style.display = 'block';

          // Update button styles
          appointmentsBtn.style.background = 'rgba(255,255,255,0.9)';
          appointmentsBtn.style.color = 'var(--macos-text-primary)';
          appointmentsBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
          requestsBtn.style.background = 'transparent';
          requestsBtn.style.color = 'var(--macos-text-secondary)';
          requestsBtn.style.boxShadow = 'none';
        }
      };

      // Close modals on backdrop click
      document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.addEventListener('click', (e) => {
          if (e.target === backdrop) {
            backdrop.classList.remove('active');
          }
        });
      });
      
      // Create Event Functions
      document.getElementById('createEventBtn')?.addEventListener('click', () => {
        // Set current date as default
        const dateInput = document.getElementById('createEventDate');
        if (dateInput) {
          dateInput.value = currentDate.toISOString().split('T')[0];
        }
        
        // Open modal
        document.getElementById('createEventModal').classList.add('active');
      });
      
      // "All Groups" checkbox handler
      document.getElementById('groupCheckboxAll')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const groupCheckboxes = document.querySelectorAll('.group-checkbox');
        groupCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });
      
      // Individual group checkbox handler - uncheck "All" if any individual is unchecked
      document.querySelectorAll('.group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const allCheckbox = document.getElementById('groupCheckboxAll');
          if (allCheckbox) {
            allCheckbox.checked = allChecked;
          }
        });
      });
      
      document.getElementById('cancelCreateEvent')?.addEventListener('click', () => {
        document.getElementById('createEventModal').classList.remove('active');
        document.getElementById('createEventForm').reset();
      });
      
      document.getElementById('createEventForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('createEventTitle').value.trim();
        const type = document.getElementById('createEventType').value.trim();
        const description = document.getElementById('createEventDescription').value.trim();
        const date = document.getElementById('createEventDate').value;
        const startHour = parseFloat(document.getElementById('createEventStartTime').value);
        const endHour = parseFloat(document.getElementById('createEventEndTime').value);
        const attendanceRequired = document.getElementById('createEventAttendanceRequired').checked;
        
        // Collect selected groups
        const selectedGroups = [];
        const groupCheckboxes = document.querySelectorAll('.group-checkbox:checked');
        groupCheckboxes.forEach(checkbox => {
          selectedGroups.push(checkbox.value);
        });
        
        // Validation
        if (!title || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Events category is always 'events'
        const category = 'events';
        
        // Find available slot
        const slot = findAvailableSlot(date, category, startHour, endHour);
        
        if (slot === null) {
          return alert('All slots are occupied for this time range. Please choose a different time or date.');
        }
        
        try {
          // Create event in Supabase
          const { data, error } = await supabase.from('events').insert({
            title,
            type,
            description: description || null,
            visible_groups: selectedGroups.length > 0 ? selectedGroups : null,
            attendance_required: attendanceRequired,
            slot: slot,
            artist_id: null,
            location_id: selectedLocationId,
            start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
            end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
          });
          
          if (error) throw error;
          
          // Add to local events array
          events.push({
            id: data?.[0]?.id || Date.now(),
            title,
            type,
            description,
            visible_groups: selectedGroups,
            attendance_required: attendanceRequired,
            date,
            slot,
            startHour,
            endHour,
            category,
            artist_id: null
          });
          
          // Close modal and reset form
          document.getElementById('createEventModal').classList.remove('active');
          document.getElementById('createEventForm').reset();
          
          // Uncheck all group checkboxes
          groupCheckboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) checkbox.checked = false;
          });
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event created successfully!');
        } catch (err) {
          console.error('Error creating event:', err);
          alert('Error creating event: ' + err.message);
        }
      });
      
      // Create Booking Button - Opens Create Booking Modal
      document.getElementById('createBookingBtn')?.addEventListener('click', () => {
        // Set current date as default
        const dateInput = document.getElementById('createBookingDate');
        if (dateInput) {
          dateInput.value = currentDate.toISOString().split('T')[0];
        }
        
        // Reset artist search
        document.getElementById('createBookingArtistSearch').value = '';
        document.getElementById('createBookingArtistSearch').disabled = true;
        document.getElementById('createBookingArtistId').value = '';
        document.getElementById('artistSearchResults').style.display = 'none';
        
        // Open modal
        document.getElementById('createBookingModal').classList.add('active');
      });
      
      // Artist Type change handler
      document.getElementById('createBookingArtistType')?.addEventListener('change', (e) => {
        const artistType = e.target.value;
        const searchInput = document.getElementById('createBookingArtistSearch');
        
        if (artistType) {
          searchInput.disabled = false;
          searchInput.value = '';
          document.getElementById('createBookingArtistId').value = '';
          document.getElementById('artistSearchResults').style.display = 'none';
        } else {
          searchInput.disabled = true;
          searchInput.value = '';
          document.getElementById('createBookingArtistId').value = '';
          document.getElementById('artistSearchResults').style.display = 'none';
        }
      });
      
      // Artist search functionality
      document.getElementById('createBookingArtistSearch')?.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        const artistType = document.getElementById('createBookingArtistType').value;
        const resultsDiv = document.getElementById('artistSearchResults');
        
        if (!searchTerm || !artistType) {
          resultsDiv.style.display = 'none';
          return;
        }
        
        // Filter artists by type and search term
        const isGuest = artistType === 'guest';
        const filteredArtists = allArtists.filter(artist => 
          artist.is_guest === isGuest && 
          artist.active &&
          artist.name.toLowerCase().includes(searchTerm)
        );
        
        if (filteredArtists.length === 0) {
          resultsDiv.innerHTML = '<div style="padding:12px; color:var(--muted); font-size:13px;">No artists found</div>';
          resultsDiv.style.display = 'block';
          return;
        }
        
        resultsDiv.innerHTML = filteredArtists.map(artist => `
          <div class="artist-search-result" data-id="${artist.id}" data-name="${artist.name}" style="padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.06); font-size:14px; transition:background 0.15s;">
            ${artist.name}${artist.instagram ? ` <span style="color:var(--muted); font-size:12px;">@${artist.instagram}</span>` : ''}
          </div>
        `).join('');
        
        resultsDiv.style.display = 'block';
        
        // Add click handlers
        document.querySelectorAll('.artist-search-result').forEach(item => {
          item.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(0,113,227,0.06)';
          });
          item.addEventListener('mouseleave', function() {
            this.style.background = '';
          });
          item.addEventListener('click', function() {
            const artistId = this.dataset.id;
            const artistName = this.dataset.name;
            document.getElementById('createBookingArtistSearch').value = artistName;
            document.getElementById('createBookingArtistId').value = artistId;
            resultsDiv.style.display = 'none';
          });
        });
      });
      
      
      // Create Booking Modal Handlers
      document.getElementById('cancelCreateBooking')?.addEventListener('click', () => {
        document.getElementById('createBookingModal').classList.remove('active');
        document.getElementById('createBookingForm').reset();
      });
      
      document.getElementById('createBookingForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const customerName = document.getElementById('createBookingCustomer').value.trim();
        const type = document.getElementById('createBookingType').value;
        const artistId = document.getElementById('createBookingArtistId').value;
        const date = document.getElementById('createBookingDate').value;
        const startHour = parseFloat(document.getElementById('createBookingStartTime').value);
        const endHour = parseFloat(document.getElementById('createBookingEndTime').value);
        
        // Validation
        if (!customerName || !type || !artistId || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Determine category based on artist
        const artist = allArtists.find(a => a.id === artistId);
        const category = artist?.is_guest ? 'guest' : 'resident';
        
        // Find available slot
        const slot = findAvailableSlot(date, category, startHour, endHour);
        
        if (slot === null) {
          return alert('All slots are occupied for this time range. Please choose a different time or date.');
        }
        
        try {
          // Create booking in Supabase events table
          const { data, error } = await supabase.from('events').insert({
            title: customerName,
            type,
            slot: slot,
            artist_id: artistId,
            location_id: selectedLocationId,
            start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
            end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
          });
          
          if (error) throw error;
          
          // Add to local events array
          events.push({
            id: data?.[0]?.id || Date.now(),
            title: customerName,
            type,
            date,
            slot,
            startHour,
            endHour,
            category,
            artist_id: artistId
          });
          
          // Close modal and reset form
          document.getElementById('createBookingModal').classList.remove('active');
          document.getElementById('createBookingForm').reset();
          document.getElementById('createBookingArtistSearch').disabled = true;
          document.getElementById('createBookingArtistId').value = '';
          document.getElementById('artistSearchResults').style.display = 'none';
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Booking created successfully!');
        } catch (err) {
          console.error('Error creating booking:', err);
          alert('Error creating booking: ' + err.message);
        }
      });


      // Edit Event Modal Functions
      window.openEditEventModal = async function(eventId) {
        const event = events.find(e => e.id === eventId);
        if (!event) return;
        
        currentEditingEvent = event;
        
        // Load full event data from Supabase
        const { data, error } = await supabase
          .from('events')
          .select('*')
          .eq('id', eventId)
          .single();
        
        if (error) {
          console.error('Error loading event:', error);
          alert('Error loading event details');
          return;
        }
        
        // Fill form with event data
        document.getElementById('editEventTitle').value = data.title || '';
        document.getElementById('editEventType').value = data.type || '';
        document.getElementById('editEventDescription').value = data.description || '';
        document.getElementById('editEventDate').value = event.date;
        
        // Set time dropdowns with formatted values
        const startTimeValue = event.startHour.toString();
        const endTimeValue = event.endHour.toString();
        
        console.log('Setting start time to:', startTimeValue, 'Available options:', 
          Array.from(document.getElementById('editEventStartTime').options).map(o => o.value));
        console.log('Setting end time to:', endTimeValue, 'Available options:', 
          Array.from(document.getElementById('editEventEndTime').options).map(o => o.value));
        
        document.getElementById('editEventStartTime').value = startTimeValue;
        document.getElementById('editEventEndTime').value = endTimeValue;
        
        // Fallback: if value not set, try to find closest match
        if (!document.getElementById('editEventStartTime').value) {
          console.warn('Start time not set, trying fallback');
          const startSelect = document.getElementById('editEventStartTime');
          for (let option of startSelect.options) {
            if (parseFloat(option.value) === event.startHour) {
              startSelect.value = option.value;
              break;
            }
          }
        }
        
        if (!document.getElementById('editEventEndTime').value) {
          console.warn('End time not set, trying fallback');
          const endSelect = document.getElementById('editEventEndTime');
          for (let option of endSelect.options) {
            if (parseFloat(option.value) === event.endHour) {
              endSelect.value = option.value;
              break;
            }
          }
        }
        
        // Handle artist display (for bookings)
        if (data.artist_id) {
          const artist = allArtists.find(a => a.id === data.artist_id);
          document.getElementById('editEventArtistName').value = artist?.name || 'Unknown Artist';
          document.getElementById('editEventArtistGroup').style.display = 'block';
          document.getElementById('editEventGroupsContainer').style.display = 'none';
          document.getElementById('editEventAttendanceGroup').style.display = 'none';
          document.getElementById('editEventModalTitle').textContent = 'Booking Details';
        } else {
          document.getElementById('editEventArtistGroup').style.display = 'none';
          document.getElementById('editEventGroupsContainer').style.display = 'block';
          document.getElementById('editEventAttendanceGroup').style.display = 'block';
          document.getElementById('editEventModalTitle').textContent = 'Event Details';
          
          // Set visible groups checkboxes
          const visibleGroups = data.visible_groups || [];
          document.querySelectorAll('.edit-group-checkbox').forEach(checkbox => {
            checkbox.checked = visibleGroups.includes(checkbox.value);
          });
          
          // Set "All Groups" checkbox
          const allChecked = document.querySelectorAll('.edit-group-checkbox').length === visibleGroups.length;
          document.getElementById('editGroupCheckboxAll').checked = allChecked;
          
          // Set attendance required
          document.getElementById('editEventAttendanceRequired').checked = data.attendance_required || false;
        }
        
        // Open modal
        document.getElementById('editEventModal').classList.add('active');
      };
      
      // "All Groups" checkbox handler for edit modal
      document.getElementById('editGroupCheckboxAll')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox');
        groupCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });
      
      // Individual group checkbox handler for edit modal
      document.querySelectorAll('.edit-group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.edit-group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const allCheckbox = document.getElementById('editGroupCheckboxAll');
          if (allCheckbox) {
            allCheckbox.checked = allChecked;
          }
        });
      });
      
      // Cancel edit event
      document.getElementById('cancelEditEvent')?.addEventListener('click', () => {
        document.getElementById('editEventModal').classList.remove('active');
        currentEditingEvent = null;
      });
      
      // Delete event
      document.getElementById('deleteEventBtn')?.addEventListener('click', async () => {
        if (!currentEditingEvent) return;
        
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .delete()
            .eq('id', currentEditingEvent.id);
          
          if (error) throw error;
          
          // Remove from local array
          events = events.filter(e => e.id !== currentEditingEvent.id);
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          currentEditingEvent = null;
          
          // Refresh calendar
          renderCalendar();
          
          alert('Event deleted successfully!');
        } catch (err) {
          console.error('Error deleting event:', err);
          alert('Error deleting event: ' + err.message);
        }
      });
      
      // Save edited event
      document.getElementById('editEventForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentEditingEvent) return;
        
        const title = document.getElementById('editEventTitle').value.trim();
        const type = document.getElementById('editEventType').value.trim();
        const description = document.getElementById('editEventDescription').value.trim();
        const date = document.getElementById('editEventDate').value;
        const startHour = parseFloat(document.getElementById('editEventStartTime').value);
        const endHour = parseFloat(document.getElementById('editEventEndTime').value);
        
        // Validation
        if (!title || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Prepare update data
        const updateData = {
          title,
          type,
          description: description || null,
          start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
          end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
        };
        
        // Add event-specific fields (not for bookings)
        if (currentEditingEvent.category === 'events') {
          const selectedGroups = [];
          const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox:checked');
          groupCheckboxes.forEach(checkbox => {
            selectedGroups.push(checkbox.value);
          });
          
          updateData.visible_groups = selectedGroups.length > 0 ? selectedGroups : null;
          updateData.attendance_required = document.getElementById('editEventAttendanceRequired').checked;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .update(updateData)
            .eq('id', currentEditingEvent.id);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          currentEditingEvent = null;
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event updated successfully!');
        } catch (err) {
          console.error('Error updating event:', err);
          alert('Error updating event: ' + err.message);
        }
      });
      
      // Show Appointment Details Modal
      // ============================================
      // HELPER: State Badge (DEUTSCH)
      // ============================================
      window.getStateBadge = function(state) {
        const badges = {
          'Zugesagt': '<span class="state-badge confirmed">âœ… Zugesagt</span>',
          'Unbekannt': '<span class="state-badge unknown">â“ Unbekannt</span>',
          'Ill/No Show': '<span class="state-badge no-show">ðŸ‘» Ill/No Show</span>',
          'Verschoben': '<span class="state-badge rescheduled">ðŸ”„ Verschoben</span>',
          'Reserviert': '<span class="state-badge reserved">ðŸ“Œ Reserviert</span>'
        };
        return badges[state] || '<span class="state-badge unknown">â“ Unbekannt</span>';
      };

      // ============================================
      // HELPER: Status Badge (ENGLISH)
      // ============================================
      window.getStatusBadge = function(status) {
        const badges = {
          'scheduled': '<span class="status-badge scheduled">ðŸ“… Scheduled</span>',
          'finished': '<span class="status-badge finished">âœ… Finished</span>',
          'canceled': '<span class="status-badge canceled">âŒ Canceled</span>',
          'no_show': '<span class="status-badge no-show">ðŸ‘» No Show</span>',
          'reserved': '<span class="status-badge reserved">ðŸ“Œ Reserved</span>',
          'unknown': '<span class="status-badge unknown">â“ Unknown</span>',
          'rescheduled': '<span class="status-badge rescheduled">ðŸ”„ Rescheduled</span>'
        };
        return badges[status] || badges['unknown'];
      };

      // ============================================
      // HELPER: Payment Badge
      // ============================================
      window.getPaymentStatusBadge = function(paymentStatus) {
        const badges = {
          'unpaid': '<span class="payment-badge unpaid">ðŸ’³ Unbezahlt</span>',
          'deposit_paid': '<span class="payment-badge deposit">ðŸ’° Anzahlung</span>',
          'fully_paid': '<span class="payment-badge paid">âœ… Bezahlt</span>',
          'refunded': '<span class="payment-badge refunded">â†©ï¸ RÃ¼ckerstattet</span>'
        };
        return badges[paymentStatus] || badges['unpaid'];
      };

      // ============================================
      // COMPLETE APPOINTMENT DETAILS POPUP
      // ============================================
      window.showAppointmentDetails = async function(appointmentId) {
        console.log('ðŸ“‹ Loading complete appointment details:', appointmentId);

        // Fetch complete appointment data
        const { data: appointment, error } = await supabase
          .from('appointments')
          .select(`
            *,
            customer:customers(id, first_name, last_name, email, phone, instagram),
            artist:artists(id, name, email, instagram, phone),
            location:locations(id, name, city)
          `)
          .eq('id', appointmentId)
          .single();

        if (error || !appointment) {
          console.error('Error loading appointment:', error);
          alert('Failed to load appointment details');
          return;
        }

        console.log('âœ… Loaded appointment:', appointment);

        // Render complete details
        const content = document.getElementById('appointmentDetailsContent');
        const modal = document.getElementById('appointmentDetailsModal');

        if (!content || !modal) return;

        const customerName = `${appointment.first_name || ''} ${appointment.last_name || ''}`.trim() ||
                             `${appointment.customer?.first_name || ''} ${appointment.customer?.last_name || ''}`.trim() ||
                             'Unknown Customer';

        const artistName = appointment.artist?.name || 'Unknown Artist';

        // Format dates
        const startDateTime = appointment.start ? new Date(appointment.start).toLocaleString('de-DE', {
          weekday: 'short',
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : '-';

        const endTime = appointment.end ? new Date(appointment.end).toLocaleTimeString('de-DE', {
          hour: '2-digit',
          minute: '2-digit'
        }) : '-';

        // Get badges
        const stateBadge = getStateBadge(appointment.state);
        const statusBadge = getStatusBadge(appointment.status);
        const paymentBadge = getPaymentStatusBadge(appointment.payment_status);

        content.innerHTML = `
          <!-- Header Row -->
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:16px; border-bottom:2px solid rgba(0,0,0,0.1);">
            <div>
              <h3 style="margin:0 0 8px 0; font-size:20px; font-weight:700; color:#1d1d1f;">${appointment.project_number || 'Kein Projekt'}</h3>
              <span style="font-size:13px; color:#86868b;">ðŸ“ ${appointment.location?.name || 'Unknown Location'} ${appointment.location?.city ? '- ' + appointment.location.city : ''}</span>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              ${stateBadge}
              ${statusBadge}
            </div>
          </div>

          <!-- Two Column Layout -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">

            <!-- LEFT COLUMN -->
            <div style="display:flex; flex-direction:column; gap:20px;">

              <!-- Customer Information -->
              <div style="background:#fafafa; padding:16px; border-radius:8px;">
                <h4 style="margin:0 0 12px 0; font-size:15px; font-weight:600; color:#1d1d1f;">ðŸ‘¤ Customer Information</h4>
                <div style="display:flex; flex-direction:column; gap:10px;">
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">VORNAME</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.first_name || appointment.customer?.first_name || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">NACHNAME</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.last_name || appointment.customer?.last_name || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">EMAIL</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.customer_email || appointment.customer?.email || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">PHONE</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.customer_phone || appointment.customer?.phone || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0;">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">INSTAGRAM</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.instagram || appointment.customer?.instagram || 'No entry data'}</span>
                  </div>
                </div>
              </div>

              <!-- Request Details -->
              <div style="background:#fafafa; padding:16px; border-radius:8px;">
                <h4 style="margin:0 0 12px 0; font-size:15px; font-weight:600; color:#1d1d1f;">ðŸ“‹ Request Details</h4>
                <div style="display:flex; flex-direction:column; gap:10px;">
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">PLACEMENT</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.placement || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">SIZE</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.size || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">STYLE</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.style || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">COLORWAY</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.colorway || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0;">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">BOOKING TYPE</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.booking_type || 'No entry data'}</span>
                  </div>
                </div>
              </div>

            </div>

            <!-- RIGHT COLUMN -->
            <div style="display:flex; flex-direction:column; gap:20px;">

              <!-- Appointment Details -->
              <div style="background:#fafafa; padding:16px; border-radius:8px;">
                <h4 style="margin:0 0 12px 0; font-size:15px; font-weight:600; color:#1d1d1f;">ðŸ“… Appointment Details</h4>
                <div style="display:flex; flex-direction:column; gap:10px;">
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">ARTIST</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${artistName}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">START</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${startDateTime}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">END</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${endTime}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">CREATOR</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.creator_email || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0;">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">WORK PROCESS</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.work_process || 'No entry data'}</span>
                  </div>
                </div>
              </div>

              <!-- Payment Information -->
              <div style="background:#fafafa; padding:16px; border-radius:8px;">
                <h4 style="margin:0 0 12px 0; font-size:15px; font-weight:600; color:#1d1d1f;">ðŸ’° Payment Information</h4>
                <div style="display:flex; flex-direction:column; gap:10px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">PAYMENT STATUS</span>
                    ${paymentBadge}
                  </div>
                  ${appointment.price ? `
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">PRICE</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:600;">â‚¬${parseFloat(appointment.price).toFixed(2)}</span>
                  </div>
                  ` : ''}
                  ${appointment.price_estimate ? `
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">PRICE ESTIMATE</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">â‚¬${parseFloat(appointment.price_estimate).toFixed(2)}</span>
                  </div>
                  ` : ''}
                  ${appointment.deposit_amount ? `
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">DEPOSIT</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">â‚¬${parseFloat(appointment.deposit_amount).toFixed(2)}</span>
                  </div>
                  ` : ''}
                  ${appointment.payment_amount ? `
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">PAID</span>
                    <span style="font-size:14px; color:#34c759; font-weight:600;">â‚¬${parseFloat(appointment.payment_amount).toFixed(2)}</span>
                  </div>
                  ` : ''}
                  ${appointment.total_amount ? `
                  <div style="display:flex; justify-content:space-between; padding:6px 0;">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">TOTAL</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">â‚¬${parseFloat(appointment.total_amount).toFixed(2)}</span>
                  </div>
                  ` : ''}
                </div>
              </div>

              ${appointment.customer_notes || appointment.internal_notes || appointment.description || appointment.notice ? `
              <!-- Notes & Description -->
              <div style="background:#fafafa; padding:16px; border-radius:8px;">
                <h4 style="margin:0 0 12px 0; font-size:15px; font-weight:600; color:#1d1d1f;">ðŸ“ Notes & Description</h4>
                ${appointment.description ? `
                <div style="background:white; padding:10px; border-radius:6px; margin-bottom:8px;">
                  <strong style="display:block; font-size:11px; color:#86868b; margin-bottom:6px;">DESCRIPTION</strong>
                  <p style="font-size:13px; color:#1d1d1f; margin:0; line-height:1.5;">${appointment.description}</p>
                </div>
                ` : ''}
                ${appointment.notice ? `
                <div style="background:white; padding:10px; border-radius:6px; margin-bottom:8px;">
                  <strong style="display:block; font-size:11px; color:#86868b; margin-bottom:6px;">NOTICE</strong>
                  <p style="font-size:13px; color:#1d1d1f; margin:0; line-height:1.5;">${appointment.notice}</p>
                </div>
                ` : ''}
                ${appointment.customer_notes ? `
                <div style="background:white; padding:10px; border-radius:6px; margin-bottom:8px;">
                  <strong style="display:block; font-size:11px; color:#86868b; margin-bottom:6px;">CUSTOMER NOTES</strong>
                  <p style="font-size:13px; color:#1d1d1f; margin:0; line-height:1.5;">${appointment.customer_notes}</p>
                </div>
                ` : ''}
                ${appointment.internal_notes ? `
                <div style="background:white; padding:10px; border-radius:6px;">
                  <strong style="display:block; font-size:11px; color:#86868b; margin-bottom:6px;">INTERNAL NOTES</strong>
                  <p style="font-size:13px; color:#1d1d1f; margin:0; line-height:1.5;">${appointment.internal_notes}</p>
                </div>
                ` : ''}
              </div>
              ` : ''}

            </div>

          </div>
        `;

        // Set up buttons
        document.getElementById('appointmentDetailsEditBtn').onclick = () => {
          editAppointmentState(appointmentId, appointment.state || 'Unbekannt');
        };

        modal.classList.add('active');
      };

      // Close Appointment Details Modal
      window.closeAppointmentDetailsModal = function() {
        const modal = document.getElementById('appointmentDetailsModal');
        if (modal) {
          modal.classList.remove('active');
        }
      };

      // ============================================
      // EDIT APPOINTMENT STATE MODAL
      // ============================================
      window.editAppointmentState = async function(appointmentId, currentState) {
        console.log('âœï¸ Edit state for appointment:', appointmentId, 'Current:', currentState);

        // First, close the details modal
        closeAppointmentDetailsModal();

        // Create or get the edit state modal
        let modal = document.getElementById('editStateModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'editStateModal';
          modal.className = 'modal-backdrop';
          document.body.appendChild(modal);
        }

        modal.innerHTML = `
          <div class="modal" style="max-width:500px;">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <h3 style="margin:0;">Appointment Status Ã¤ndern</h3>
              <button type="button" class="btn btn-icon" onclick="closeEditStateModal()" style="padding:4px 12px; font-size:20px;">Ã—</button>
            </div>

            <div class="modal-body">
              <p style="color:#666; font-size:14px; margin:0 0 20px 0;">WÃ¤hle den neuen Status fÃ¼r diesen Termin:</p>

              <div class="state-options" style="display:flex; flex-direction:column; gap:12px;">
                <label class="state-option ${currentState === 'Zugesagt' ? 'selected' : ''}" style="display:block; cursor:pointer;">
                  <input type="radio" name="state" value="Zugesagt" ${currentState === 'Zugesagt' ? 'checked' : ''} style="display:none;">
                  <div class="option-content" style="display:flex; align-items:center; gap:12px; padding:16px; background:#fafafa; border:2px solid ${currentState === 'Zugesagt' ? '#0071e3' : '#e0e0e0'}; border-radius:8px; transition:all 0.2s;">
                    <span style="font-size:24px;">âœ…</span>
                    <span style="font-size:15px; font-weight:600; color:#1d1d1f;">Zugesagt</span>
                  </div>
                </label>

                <label class="state-option ${currentState === 'Unbekannt' ? 'selected' : ''}" style="display:block; cursor:pointer;">
                  <input type="radio" name="state" value="Unbekannt" ${currentState === 'Unbekannt' ? 'checked' : ''} style="display:none;">
                  <div class="option-content" style="display:flex; align-items:center; gap:12px; padding:16px; background:#fafafa; border:2px solid ${currentState === 'Unbekannt' ? '#0071e3' : '#e0e0e0'}; border-radius:8px; transition:all 0.2s;">
                    <span style="font-size:24px;">â“</span>
                    <span style="font-size:15px; font-weight:600; color:#1d1d1f;">Unbekannt</span>
                  </div>
                </label>

                <label class="state-option ${currentState === 'Ill/No Show' ? 'selected' : ''}" style="display:block; cursor:pointer;">
                  <input type="radio" name="state" value="Ill/No Show" ${currentState === 'Ill/No Show' ? 'checked' : ''} style="display:none;">
                  <div class="option-content" style="display:flex; align-items:center; gap:12px; padding:16px; background:#fafafa; border:2px solid ${currentState === 'Ill/No Show' ? '#0071e3' : '#e0e0e0'}; border-radius:8px; transition:all 0.2s;">
                    <span style="font-size:24px;">ðŸ‘»</span>
                    <span style="font-size:15px; font-weight:600; color:#1d1d1f;">Didn't Show Up</span>
                  </div>
                </label>

                <label class="state-option ${currentState === 'Verschoben' ? 'selected' : ''}" style="display:block; cursor:pointer;">
                  <input type="radio" name="state" value="Verschoben" ${currentState === 'Verschoben' ? 'checked' : ''} style="display:none;">
                  <div class="option-content" style="display:flex; align-items:center; gap:12px; padding:16px; background:#fafafa; border:2px solid ${currentState === 'Verschoben' ? '#0071e3' : '#e0e0e0'}; border-radius:8px; transition:all 0.2s;">
                    <span style="font-size:24px;">ðŸ”„</span>
                    <span style="font-size:15px; font-weight:600; color:#1d1d1f;">Rescheduled</span>
                  </div>
                </label>

                <label class="state-option ${currentState === 'Reserviert' ? 'selected' : ''}" style="display:block; cursor:pointer;">
                  <input type="radio" name="state" value="Reserviert" ${currentState === 'Reserviert' ? 'checked' : ''} style="display:none;">
                  <div class="option-content" style="display:flex; align-items:center; gap:12px; padding:16px; background:#fafafa; border:2px solid ${currentState === 'Reserviert' ? '#0071e3' : '#e0e0e0'}; border-radius:8px; transition:all 0.2s;">
                    <span style="font-size:24px;">ðŸ“Œ</span>
                    <span style="font-size:15px; font-weight:600; color:#1d1d1f;">Reserved</span>
                  </div>
                </label>
              </div>
            </div>

            <div class="modal-actions" style="margin-top:24px; display:flex; gap:12px; justify-content:flex-end;">
              <button type="button" class="btn btn-secondary" onclick="closeEditStateModal()">Abbrechen</button>
              <button type="button" class="btn btn-primary" onclick="saveAppointmentState('${appointmentId}')">Speichern</button>
            </div>
          </div>
        `;

        // Add click handlers to labels
        modal.querySelectorAll('.state-option').forEach(option => {
          option.addEventListener('click', function() {
            // Remove selected class from all
            modal.querySelectorAll('.state-option').forEach(opt => {
              opt.classList.remove('selected');
              opt.querySelector('.option-content').style.background = '#fafafa';
              opt.querySelector('.option-content').style.borderColor = '#e0e0e0';
            });
            // Add to clicked one
            this.classList.add('selected');
            this.querySelector('.option-content').style.background = '#e3f2fd';
            this.querySelector('.option-content').style.borderColor = '#0071e3';
            // Check the radio
            this.querySelector('input[type="radio"]').checked = true;
          });
        });

        modal.classList.add('active');
      };

      window.saveAppointmentState = async function(appointmentId) {
        const selectedState = document.querySelector('#editStateModal input[name="state"]:checked')?.value;

        if (!selectedState) {
          alert('Bitte wÃ¤hle einen Status aus');
          return;
        }

        console.log('ðŸ’¾ Saving state:', selectedState, 'for appointment:', appointmentId);

        try {
          // Update appointment state
          // SQL trigger will automatically update status based on state + end time
          const { data, error } = await supabase
            .from('appointments')
            .update({
              state: selectedState,
              updated_at: new Date().toISOString()
            })
            .eq('id', appointmentId)
            .select()
            .single();

          if (error) throw error;

          console.log('âœ… State updated successfully:', data);

          // Close modal
          closeEditStateModal();

          // Reload calendar
          await loadInitialData();
          renderCalendar();

          // Show success message
          alert('Status erfolgreich aktualisiert!');

        } catch (error) {
          console.error('âŒ Error updating state:', error);
          alert('Fehler beim Aktualisieren des Status: ' + error.message);
        }
      };

      window.closeEditStateModal = function() {
        const modal = document.getElementById('editStateModal');
        if (modal) {
          modal.classList.remove('active');
        }
      };

      // Edit Event Modal Functions
      window.openEditEventModal = async function(eventId) {
        const event = events.find(e => e.id === eventId);
        if (!event) {
          console.error('Event not found:', eventId);
          return;
        }

        // Check if this is an appointment (from appointments table) or event (from events table)
        if (event.isAppointment) {
          // Show appointment details modal instead
          showAppointmentDetails(eventId);
        } else {
          // Load from events table
          const { data: fullEvent, error } = await supabase
            .from('events')
            .select('*')
            .eq('id', eventId)
            .single();

          if (error) {
            console.error('Error loading event:', error);
            alert('Error loading event details');
            return;
          }

          // Check if this is a booking (has artist_id) or an event
          if (fullEvent.artist_id) {
            // This is a booking - open booking modal
            openEditBookingModal(eventId, fullEvent, event);
          } else {
            // This is an event - open event modal
            openEditEventModalInternal(eventId, fullEvent, event);
          }
        }
      };

      // Helper function to open appointment directly from profile view
      window.openAppointmentFromProfile = async function(appointmentId) {
        try {
          // Load appointment from appointments table
          const { data: fullAppointment, error } = await supabase
            .from('appointments')
            .select(`
              *,
              customer:customers(id, first_name, last_name, email, instagram),
              artist:artists(id, name, instagram, is_guest),
              location:locations(name, city)
            `)
            .eq('id', appointmentId)
            .single();

          if (error) {
            console.error('Error loading appointment:', error);
            alert('Error loading appointment details');
            return;
          }

          // Create a minimal event object for compatibility
          const startHour = parseLocalTime(fullAppointment.start);
          const endHour = parseLocalTime(fullAppointment.end);
          const event = {
            id: appointmentId,
            date: fullAppointment.start.split('T')[0],
            startHour: startHour,
            endHour: endHour,
            isAppointment: true
          };

          // Open appointment modal
          openEditBookingModal(appointmentId, fullAppointment, event);
        } catch (err) {
          console.error('Error opening appointment:', err);
          alert('Error opening appointment: ' + err.message);
        }
      };

      // Helper function to parse local time from ISO string
      const parseLocalTime = (timeStr) => {
        const [datePart, timePart] = timeStr.split('T');
        const [hours, minutes] = timePart.split(':').map(Number);
        return hours + minutes / 60;
      };

      // Internal function to open event modal
      function openEditEventModalInternal(eventId, fullEvent, event) {
        // Populate form fields
        document.getElementById('editEventId').value = eventId;
        document.getElementById('editEventTitle').value = fullEvent.title || '';
        document.getElementById('editEventType').value = fullEvent.type || '';
        document.getElementById('editEventDescription').value = fullEvent.description || '';
        document.getElementById('editEventDate').value = event.date;
        document.getElementById('editEventStartTime').value = event.startHour.toString();
        document.getElementById('editEventEndTime').value = event.endHour.toString();
        document.getElementById('editEventAttendanceRequired').checked = fullEvent.attendance_required || false;
        
        // Clear all group checkboxes first
        document.querySelectorAll('.edit-group-checkbox').forEach(cb => cb.checked = false);
        
        // Set selected groups
        if (fullEvent.visible_groups && Array.isArray(fullEvent.visible_groups)) {
          fullEvent.visible_groups.forEach(group => {
            const checkbox = document.querySelector(`.edit-group-checkbox[value="${group}"]`);
            if (checkbox) checkbox.checked = true;
          });
          
          // Check if all groups are selected
          const allCheckboxes = document.querySelectorAll('.edit-group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          document.getElementById('editGroupCheckboxAll').checked = allChecked;
        }
        
        // Open modal
        document.getElementById('editEventModal').classList.add('active');
      }
      
      // Function to open booking modal
      function openEditBookingModal(bookingId, fullBooking, booking) {
        // Find artist
        const artist = allArtists.find(a => a.id === fullBooking.artist_id);
        
        // Populate form fields
        document.getElementById('editBookingId').value = bookingId;
        document.getElementById('editBookingCustomer').value = fullBooking.title || '';
        document.getElementById('editBookingType').value = fullBooking.type || '';
        document.getElementById('editBookingArtistName').value = artist?.name || 'Unknown Artist';
        document.getElementById('editBookingArtistId').value = fullBooking.artist_id;
        document.getElementById('editBookingDate').value = booking.date;
        document.getElementById('editBookingStartTime').value = booking.startHour.toString();
        document.getElementById('editBookingEndTime').value = booking.endHour.toString();
        
        // Open modal
        document.getElementById('editBookingModal').classList.add('active');
      }
      
      // Edit "All Groups" checkbox handler
      document.getElementById('editGroupCheckboxAll')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox');
        groupCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });
      
      // Individual edit group checkbox handler
      document.querySelectorAll('.edit-group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.edit-group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const allCheckbox = document.getElementById('editGroupCheckboxAll');
          if (allCheckbox) {
            allCheckbox.checked = allChecked;
          }
        });
      });
      
      // Cancel edit event
      document.getElementById('cancelEditEvent')?.addEventListener('click', () => {
        document.getElementById('editEventModal').classList.remove('active');
      });
      
      // Submit edit event form
      document.getElementById('editEventForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const eventId = document.getElementById('editEventId').value;
        const title = document.getElementById('editEventTitle').value.trim();
        const type = document.getElementById('editEventType').value.trim();
        const description = document.getElementById('editEventDescription').value.trim();
        const date = document.getElementById('editEventDate').value;
        const startHour = parseFloat(document.getElementById('editEventStartTime').value);
        const endHour = parseFloat(document.getElementById('editEventEndTime').value);
        const attendanceRequired = document.getElementById('editEventAttendanceRequired').checked;
        
        // Collect selected groups
        const selectedGroups = [];
        const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox:checked');
        groupCheckboxes.forEach(checkbox => {
          selectedGroups.push(checkbox.value);
        });
        
        // Validation
        if (!title || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Get current event to check if date/time changed
        const currentEvent = events.find(e => e.id === eventId);
        let newSlot = currentEvent?.slot || 1;
        
        // If date or time changed, find a new available slot
        if (currentEvent && (currentEvent.date !== date || currentEvent.startHour !== startHour || currentEvent.endHour !== endHour)) {
          // Temporarily remove current event from events array for slot calculation
          const tempEvents = events.filter(e => e.id !== eventId);
          const oldEvents = events;
          events = tempEvents;
          
          const availableSlot = findAvailableSlot(date, 'events', startHour, endHour);
          
          // Restore events array
          events = oldEvents;
          
          if (availableSlot === null) {
            return alert('All slots are occupied for this new time range. Please choose a different time or date.');
          }
          newSlot = availableSlot;
        }
        
        try {
          // Update event in Supabase
          const { error } = await supabase
            .from('events')
            .update({
              title,
              type,
              description: description || null,
              visible_groups: selectedGroups.length > 0 ? selectedGroups : null,
              attendance_required: attendanceRequired,
              slot: newSlot,
              start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
              end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
            })
            .eq('id', eventId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event updated successfully!');
        } catch (err) {
          console.error('Error updating event:', err);
          alert('Error updating event: ' + err.message);
        }
      });
      
      // Delete event
      document.getElementById('deleteEventBtn')?.addEventListener('click', async () => {
        const eventId = document.getElementById('editEventId').value;
        
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .delete()
            .eq('id', eventId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event deleted successfully!');
        } catch (err) {
          console.error('Error deleting event:', err);
          alert('Error deleting event: ' + err.message);
        }
      });
      
      // Edit Booking Modal Functions
      document.getElementById('cancelEditBooking')?.addEventListener('click', () => {
        document.getElementById('editBookingModal').classList.remove('active');
      });
      
      // Submit edit booking form
      document.getElementById('editBookingForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const bookingId = document.getElementById('editBookingId').value;
        const customerName = document.getElementById('editBookingCustomer').value.trim();
        const type = document.getElementById('editBookingType').value;
        const artistId = document.getElementById('editBookingArtistId').value;
        const date = document.getElementById('editBookingDate').value;
        const startHour = parseFloat(document.getElementById('editBookingStartTime').value);
        const endHour = parseFloat(document.getElementById('editBookingEndTime').value);
        
        // Validation
        if (!customerName || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Get current booking to check if date/time changed
        const currentBooking = events.find(e => e.id === bookingId);
        let newSlot = currentBooking?.slot || 1;
        
        // If date or time changed, find a new available slot
        if (currentBooking && (currentBooking.date !== date || currentBooking.startHour !== startHour || currentBooking.endHour !== endHour)) {
          // Determine category
          const artist = allArtists.find(a => a.id === artistId);
          const category = artist?.is_guest ? 'guest' : 'resident';
          
          // Temporarily remove current booking from events array for slot calculation
          const tempEvents = events.filter(e => e.id !== bookingId);
          const oldEvents = events;
          events = tempEvents;
          
          const availableSlot = findAvailableSlot(date, category, startHour, endHour);
          
          // Restore events array
          events = oldEvents;
          
          if (availableSlot === null) {
            return alert('All slots are occupied for this new time range. Please choose a different time or date.');
          }
          newSlot = availableSlot;
        }
        
        try {
          // Update booking in Supabase
          const { error } = await supabase
            .from('events')
            .update({
              title: customerName,
              type,
              slot: newSlot,
              start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
              end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
            })
            .eq('id', bookingId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editBookingModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Booking updated successfully!');
        } catch (err) {
          console.error('Error updating booking:', err);
          alert('Error updating booking: ' + err.message);
        }
      });
      
      // Delete booking
      document.getElementById('deleteBookingBtn')?.addEventListener('click', async () => {
        const bookingId = document.getElementById('editBookingId').value;
        
        if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .delete()
            .eq('id', bookingId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editBookingModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Booking deleted successfully!');
        } catch (err) {
          console.error('Error deleting booking:', err);
          alert('Error deleting booking: ' + err.message);
        }
      });
      
      // Category checkboxes
      document.getElementById('checkEvents').addEventListener('change', (e) => {
        visibleCategories.events = e.target.checked;
        renderCalendar();
      });
      
      document.getElementById('checkResidents').addEventListener('change', (e) => {
        visibleCategories.residents = e.target.checked;
        renderCalendar();
      });
      
      document.getElementById('checkGuests').addEventListener('change', (e) => {
        visibleCategories.guests = e.target.checked;
        renderCalendar();
      });
      
      document.getElementById('prevMonthBtn')?.addEventListener('click', () => {
        dienstplanDate.setMonth(dienstplanDate.getMonth() - 1);
        renderDienstplan();
      });
      
      document.getElementById('nextMonthBtn')?.addEventListener('click', () => {
        dienstplanDate.setMonth(dienstplanDate.getMonth() + 1);
        renderDienstplan();
      });
      
      document.getElementById('currentMonthBtn')?.addEventListener('click', () => {
        dienstplanDate = new Date();
        renderDienstplan();
      });
    });

    function renderDienstplan() {
      const monthDisplay = document.getElementById('dienstplanMonth');
      const container = document.getElementById('dienstplanContainer');
      if (!monthDisplay || !container) return;
      
      const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 
                          'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
      const month = monthNames[dienstplanDate.getMonth()];
      const year = dienstplanDate.getFullYear();
      monthDisplay.textContent = `${month} ${year}`;
      
      // Get location colors
      const locationData = document.querySelector('#dienstplanLocationDropdown option:checked')?.textContent || '';
      const colors = getLocationColors(locationData);
      
      const daysInMonth = new Date(dienstplanDate.getFullYear(), dienstplanDate.getMonth() + 1, 0).getDate();

      // Filter by selected location if applicable
      let filteredMembers = allTeamMembers;
      if (selectedDienstplanLocationId) {
        filteredMembers = allTeamMembers.filter(m =>
          // Show all non-artist roles
          m.category !== 'Resident Artists' ||
          // OR show artists only if they match the location
          (m.category === 'Resident Artists' && m.city_location === getCurrentLocationName())
        );
      }

      // Group team members by category
      const categories = [];
      const categoryNames = ['GeschÃ¤ftsfÃ¼hrung', 'Management', 'Booking Team', 'Mediadepartment', 'Resident Artists', 'Guest Artists', 'Azubis', 'Andere'];
      
      categoryNames.forEach(categoryName => {
        const members = filteredMembers.filter(m => m.category === categoryName && m.active);
        if (members.length > 0 || categoryName === 'Resident Artists' || categoryName === 'Guest Artists') {
          // For Artist categories, use artists instead
          if (categoryName === 'Resident Artists') {
            let residentArtists = allArtists.filter(a => !a.is_guest && a.active);
            // Filter by location if selected
            if (selectedDienstplanLocationId) {
              residentArtists = residentArtists.filter(a => a.city_location === getCurrentLocationName());
            }
            if (residentArtists.length > 0) {
              categories.push({
                name: categoryName,
                people: residentArtists.map(a => a.name)
              });
            }
          } else if (categoryName === 'Guest Artists') {
            const guestArtists = allArtists.filter(a => a.is_guest && a.active);
            if (guestArtists.length > 0) {
              categories.push({
                name: categoryName,
                people: guestArtists.map(a => a.name)
              });
            }
          } else {
            categories.push({
              name: categoryName,
              people: members.map(m => m.name)
            });
          }
        }
      });
      
      let html = '<table style="width:auto; min-width:100%; border-collapse:collapse; background:white; table-layout:fixed;">';
      
      // Header row with days
      html += '<thead><tr>';
      html += '<th style="position:sticky; left:0; z-index:20; background:rgba(249,249,249,0.98); padding:12px; text-align:left; border-right:1px solid rgba(0,0,0,0.06); border-bottom:1px solid rgba(0,0,0,0.06); font-size:13px; color:#666; width:150px; min-width:150px; max-width:150px;">Resources</th>';
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(dienstplanDate.getFullYear(), dienstplanDate.getMonth(), day);
        const weekday = date.toLocaleDateString('de-DE', { weekday: 'short' }).toUpperCase();
        
        // Check if this is today
        const today = new Date();
        const isToday = date.getDate() === today.getDate() && 
                        date.getMonth() === today.getMonth() && 
                        date.getFullYear() === today.getFullYear();
        
        const todayStyle = isToday ? 'background:#ff3b30; color:white;' : `background:${colors.light};`;
        
        html += `<th style="${todayStyle} padding:8px 4px; text-align:center; border-right:1px solid rgba(0,0,0,0.06); border-bottom:1px solid rgba(0,0,0,0.06); font-size:11px; width:80px; min-width:80px; max-width:80px;">
                   <div style="font-size:13px; font-weight:600; ${isToday ? 'color:white;' : 'color:#1d1d1f;'}">${day}</div>
                   <div style="font-size:10px; font-weight:500; ${isToday ? 'color:rgba(255,255,255,0.9);' : 'color:#666;'} margin-top:2px;">${weekday}</div>
                 </th>`;
      }
      html += '</tr></thead>';
      
      html += '<tbody>';
      
      categories.forEach((cat, catIndex) => {
        // Category header row
        html += `<tr class="category-row">
                   <td colspan="${daysInMonth + 1}" style="padding:0; border-bottom:1px solid rgba(0,0,0,0.06);">
                     <button class="category-header-btn" data-category="${catIndex}" style="width:100%; display:flex; align-items:center; justify-content:flex-start; background:#f5f5f5; color:#1d1d1f; border:none; padding:12px 16px; font-size:14px; font-weight:600; cursor:pointer; text-align:left; font-family:inherit;">
                       <span class="arrow" style="margin-right:8px; font-size:12px; display:inline-block; width:16px; transition:transform 0.3s ease;">â–¶</span>
                       <span>${cat.name}</span>
                     </button>
                   </td>
                 </tr>`;
        
        // People rows (hidden by default)
        cat.people.forEach((person, personIndex) => {
          html += `<tr class="person-row" data-category="${catIndex}" style="display:none;">
                     <td style="position:sticky; left:0; z-index:10; background:rgba(255,255,255,0.98); padding:10px 12px 10px 32px; text-align:left; border-right:1px solid rgba(0,0,0,0.06); border-bottom:1px solid rgba(0,0,0,0.06); font-size:13px; color:#1d1d1f; width:150px; min-width:150px; max-width:150px;">${person}</td>`;
          
          for (let day = 1; day <= daysInMonth; day++) {
            html += `<td style="border-right:1px solid rgba(0,0,0,0.06); border-bottom:1px solid rgba(0,0,0,0.06); background:rgba(255,255,255,0.8); cursor:pointer; padding:0; width:80px; min-width:80px; max-width:80px;">
                       <div class="dp-cell" data-cat="${catIndex}" data-person="${personIndex}" data-day="${day}" style="width:100%; height:100%; min-height:40px;"></div>
                     </td>`;
          }
          
          html += '</tr>';
        });
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
      
      // Add event listeners
      document.querySelectorAll('.category-header-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const catIndex = this.dataset.category;
          const arrow = this.querySelector('.arrow');
          const personRows = document.querySelectorAll(`.person-row[data-category="${catIndex}"]`);
          const isOpen = openCategories.has(catIndex);
          
          if (isOpen) {
            personRows.forEach(row => row.style.display = 'none');
            arrow.style.transform = 'rotate(0deg)';
            openCategories.delete(catIndex);
          } else {
            personRows.forEach(row => row.style.display = 'table-row');
            arrow.style.transform = 'rotate(90deg)';
            openCategories.add(catIndex);
          }
        });
      });
      
      // Restore previously open categories
      openCategories.forEach(catIndex => {
        const btn = document.querySelector(`.category-header-btn[data-category="${catIndex}"]`);
        const arrow = btn?.querySelector('.arrow');
        const personRows = document.querySelectorAll(`.person-row[data-category="${catIndex}"]`);
        
        if (btn && arrow) {
          personRows.forEach(row => row.style.display = 'table-row');
          arrow.style.transform = 'rotate(90deg)';
        }
      });
      
      // Cell click handlers with location colors
      document.querySelectorAll('.dp-cell').forEach(cell => {
        cell.addEventListener('click', function() {
          if (!this.classList.contains('working') && !this.classList.contains('off') && !this.classList.contains('vacation')) {
            this.classList.add('working');
            this.style.background = colors.accent;
          } else if (this.classList.contains('working')) {
            this.classList.remove('working');
            this.classList.add('off');
            this.style.background = '#FFEBEE';
          } else if (this.classList.contains('off')) {
            this.classList.remove('off');
            this.classList.add('vacation');
            this.style.background = '#FFF3E0';
          } else {
            this.classList.remove('vacation');
            this.style.background = '';
          }
        });
      });
    }
  </script>

  <!-- Login Modal -->
  <div class="login-backdrop" id="loginBackdrop">
    <div class="login-modal" id="loginModalContent">
      <!-- Login Form View -->
      <div id="loginFormView">
        <div class="login-welcome">
          <h2>Willkommen zurÃ¼ck!</h2>
          <p>Bitte melde dich an, um fortzufahren</p>
        </div>
        <form class="login-form" id="loginForm">
          <div class="form-group">
            <label for="loginUsername">Benutzername</label>
            <input type="text" id="loginUsername" autocomplete="username" required>
          </div>
          <div class="form-group">
            <label for="loginPassword">Passwort</label>
            <input type="password" id="loginPassword" autocomplete="current-password" required>
          </div>
          <div class="login-remember">
            <input type="checkbox" id="rememberMe">
            <label for="rememberMe">Angemeldet bleiben</label>
          </div>
          <div class="login-actions">
            <button type="submit" class="btn btn-primary" style="width: 100%;">Anmelden</button>
          </div>
        </form>
      </div>

      <!-- Profile View -->
      <div id="profileView" class="profile-view" style="display: none;">
        <div class="profile-header">
          <img id="profileAvatarLarge" class="profile-avatar-large" src="" alt="Profilbild">
          <h2 id="profileName" style="margin: 0; font-size: 22px;">Username</h2>
        </div>

        <div class="profile-info-group">
          <label>Benutzername</label>
          <div class="profile-info-value" id="profileUsernameValue">â€”</div>
        </div>

        <div class="profile-info-group">
          <label>Passwort</label>
          <div class="password-toggle">
            <div class="profile-info-value" id="profilePasswordValue">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</div>
            <button type="button" onclick="togglePassword()">Anzeigen</button>
          </div>
          <button type="button" class="btn btn-secondary" onclick="showPasswordChangeForm()" style="width: 100%; margin-top: 8px;">Passwort Ã¤ndern</button>
        </div>

        <div id="passwordChangeForm" class="profile-info-group" style="display: none;">
          <label>Neues Passwort</label>
          <input type="password" id="newPassword" placeholder="Neues Passwort" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <input type="password" id="confirmPassword" placeholder="Passwort bestÃ¤tigen" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <div style="display: flex; gap: 8px;">
            <button type="button" class="btn btn-primary" onclick="changePassword()" style="flex: 1;">Speichern</button>
            <button type="button" class="btn btn-secondary" onclick="hidePasswordChangeForm()" style="flex: 1;">Abbrechen</button>
          </div>
        </div>

        <div class="profile-info-group">
          <label>Rolle</label>
          <div>
            <span class="profile-role-badge" id="profileRoleValue">USER</span>
          </div>
        </div>

        <div class="profile-info-group">
          <label>Profilbild</label>
          <button type="button" class="btn btn-primary" onclick="openAvatarUploadModal()" style="width: 100%;">Profilbild editieren</button>
        </div>

        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #eee; display: flex; gap: 12px;">
          <button type="button" class="btn btn-secondary" onclick="closeLoginModal()" style="flex: 1;">SchlieÃŸen</button>
          <button type="button" class="btn btn-danger" onclick="logout()" style="flex: 1;">Abmelden</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Avatar Upload Modal -->
  <div class="modal-backdrop" id="avatarUploadModal">
    <div class="modal" style="max-width: 500px;">
      <h3 style="color:var(--ink); font-weight:500; margin-bottom:20px;">Profilbild editieren</h3>

      <!-- Current Avatar Preview -->
      <div id="currentAvatarPreview" style="text-align:center; margin-bottom:24px;">
        <img id="currentAvatarImg" src="" alt="Aktuelles Profilbild" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:3px solid #f5f5f7;">
      </div>

      <!-- Drag & Drop Zone -->
      <div
        id="avatarDropZone"
        style="border:2px dashed #d1d5db; border-radius:12px; padding:40px 20px; text-align:center; background:#f9fafb; cursor:pointer; transition:all 0.3s; margin-bottom:20px;"
        ondragover="handleDragOver(event)"
        ondragleave="handleDragLeave(event)"
        ondrop="handleDrop(event)"
        onclick="document.getElementById('avatarFileInput').click()">
        <div style="font-size:48px; margin-bottom:12px;">ðŸ“¸</div>
        <div style="font-size:16px; font-weight:500; color:var(--ink); margin-bottom:8px;">
          Bild hier ablegen oder klicken
        </div>
        <div style="font-size:13px; color:var(--muted);">
          PNG, JPG oder GIF (max. 5MB)
        </div>
      </div>

      <!-- Hidden File Input -->
      <input
        type="file"
        id="avatarFileInput"
        accept="image/*"
        style="display:none;"
        onchange="handleFileSelect(event)">

      <!-- Preview Selected Image -->
      <div id="avatarPreviewContainer" style="display:none; margin-bottom:20px; text-align:center;">
        <div style="font-size:14px; font-weight:500; color:var(--ink); margin-bottom:12px;">Vorschau:</div>
        <img id="avatarPreview" src="" alt="Vorschau" style="width:150px; height:150px; border-radius:50%; object-fit:cover; border:3px solid var(--accent);">
        <div id="avatarFileName" style="font-size:13px; color:var(--muted); margin-top:8px;"></div>
      </div>

      <!-- Upload Progress -->
      <div id="uploadProgress" style="display:none; margin-bottom:20px;">
        <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">Uploading...</div>
        <div style="background:#e5e7eb; border-radius:999px; height:8px; overflow:hidden;">
          <div id="uploadProgressBar" style="background:var(--accent); height:100%; width:0%; transition:width 0.3s;"></div>
        </div>
      </div>

      <div class="modal-actions" style="gap:8px;">
        <button type="button" class="btn btn-secondary" onclick="closeAvatarUploadModal()" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1); flex:1;">Abbrechen</button>
        <button type="button" class="btn" id="uploadAvatarBtn" onclick="uploadAvatarFromModal()" disabled style="background:var(--ink); color:white; border:none; flex:1; opacity:0.5;">Hochladen</button>
      </div>
    </div>
  </div>

  <!-- ========================================
       PAYMENT WORKFLOW MODAL
       ======================================== -->
  <div class="modal-backdrop" id="paymentWorkflowModal" style="display:none;">
    <div class="modal" style="max-width:900px; max-height:90vh; overflow-y:auto;">

      <!-- Header -->
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(0,0,0,0.1);">
        <h3 style="color:var(--macos-text-primary); font-weight:600; margin:0; font-size:20px;">
          ðŸ’³ Zahlungsabwicklung
        </h3>
        <button onclick="closePaymentWorkflowModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--macos-text-secondary); padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:6px; transition:all 0.2s;">
          Ã—
        </button>
      </div>

      <!-- SECTION 1: Customer Info Summary -->
      <div style="background:rgba(255,255,255,0.9); backdrop-filter:saturate(180%) blur(20px); padding:20px; border-radius:12px; margin-bottom:16px; border:1px solid rgba(0,0,0,0.08);">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
          <span style="font-size:20px;">ðŸ‘¤</span>
          <h4 style="font-size:15px; font-weight:600; margin:0; color:var(--macos-text-primary);">Kundeninformationen</h4>
        </div>
        <div id="paymentCustomerSummary" style="font-size:13px; line-height:1.6;"></div>
      </div>

      <!-- SECTION 2: Tattoo Details Summary -->
      <div style="background:rgba(255,255,255,0.9); backdrop-filter:saturate(180%) blur(20px); padding:20px; border-radius:12px; margin-bottom:16px; border:1px solid rgba(0,0,0,0.08);">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
          <span style="font-size:20px;">ðŸŽ¨</span>
          <h4 style="font-size:15px; font-weight:600; margin:0; color:var(--macos-text-primary);">Tattoo Details</h4>
        </div>
        <div id="paymentTattooSummary" style="font-size:13px; line-height:1.6;"></div>
      </div>

      <!-- SECTION 3: Appointment Details -->
      <div style="background:rgba(255,255,255,0.9); backdrop-filter:saturate(180%) blur(20px); padding:20px; border-radius:12px; margin-bottom:16px; border:1px solid rgba(0,0,0,0.08);">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
          <span style="font-size:20px;">ðŸ“…</span>
          <h4 style="font-size:15px; font-weight:600; margin:0; color:var(--macos-text-primary);">Termindetails</h4>
        </div>
        <div id="paymentAppointmentSummary" style="font-size:13px; line-height:1.6;"></div>
      </div>

      <!-- SECTION 4: Price Input -->
      <div style="background:linear-gradient(135deg, rgba(0,113,227,0.05), rgba(0,113,227,0.12)); backdrop-filter:saturate(180%) blur(20px); padding:24px; border-radius:12px; margin-bottom:16px; border:2px solid rgba(0,113,227,0.3);">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:16px;">
          <span style="font-size:20px;">ðŸ’¶</span>
          <h4 style="font-size:15px; font-weight:600; margin:0; color:var(--macos-accent-blue);">Preisgestaltung</h4>
        </div>

        <div class="form-group" style="margin-bottom:0;">
          <label style="font-size:13px; font-weight:600; color:var(--macos-text-primary); display:block; margin-bottom:8px;">
            Gesamtpreis (EUR)
          </label>
          <input type="number"
                 id="paymentTotalPrice"
                 placeholder="z.B. 500.00"
                 step="0.01"
                 min="0"
                 style="width:100%; padding:14px 16px; border:1px solid rgba(0,0,0,0.15); border-radius:10px; font-size:17px; font-weight:600; background:white; transition:all 0.2s;"
                 onfocus="this.style.borderColor='var(--macos-accent-blue)'; this.style.boxShadow='0 0 0 3px rgba(0,113,227,0.1)';"
                 onblur="this.style.borderColor='rgba(0,0,0,0.15)'; this.style.boxShadow='none';">
        </div>

        <div id="paymentDepositDisplay" style="margin-top:20px; padding:16px; background:rgba(255,255,255,0.95); border-radius:10px; display:none; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span style="font-size:14px; color:var(--macos-text-secondary);">Gesamtpreis:</span>
            <span id="displayTotalPrice" style="font-size:16px; font-weight:600; color:var(--macos-text-primary);">â‚¬0.00</span>
          </div>
          <div style="height:1px; background:rgba(0,0,0,0.08); margin:10px 0;"></div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:14px; color:var(--macos-text-secondary);">Terminkaution (50%):</span>
            <span id="displayDepositPrice" style="font-size:18px; font-weight:700; color:var(--macos-accent-green);">â‚¬0.00</span>
          </div>
        </div>
      </div>

      <!-- SECTION 5: Confirmation Checkbox -->
      <div style="margin-bottom:24px; padding:20px; background:rgba(255,159,10,0.08); border-radius:10px; border-left:4px solid var(--macos-accent-orange);">
        <label style="display:flex; align-items:start; cursor:pointer; user-select:none;">
          <input type="checkbox"
                 id="paymentConfirmCheckbox"
                 style="margin-right:12px; margin-top:3px; width:20px; height:20px; cursor:pointer; accent-color:var(--macos-accent-orange);">
          <span style="font-size:13px; line-height:1.6;">
            <strong style="display:block; margin-bottom:4px; color:var(--macos-text-primary);">
              Ich bestÃ¤tige, dass alle Kundeninformationen, Tattoo-Details und der Termin korrekt sind.
            </strong>
            <span style="color:var(--macos-text-secondary);">
              Nach dem Absenden wird automatisch ein Stripe Payment Link generiert und eine BestÃ¤tigungsmail an den Kunden versendet.
            </span>
          </span>
        </label>
      </div>

      <!-- SECTION 6: Action Buttons -->
      <div class="modal-actions" style="display:flex; gap:12px; margin-top:24px;">
        <button type="button"
                class="btn btn-secondary"
                onclick="closePaymentWorkflowModal()"
                style="flex:1; background:var(--macos-fill-primary); color:var(--macos-text-primary); border:1px solid var(--macos-stroke-primary); padding:12px; border-radius:10px; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s;"
                onmouseover="this.style.background='var(--macos-fill-secondary)';"
                onmouseout="this.style.background='var(--macos-fill-primary)';">
          Abbrechen
        </button>
        <button type="button"
                id="sendPaymentLinkBtn"
                onclick="executePaymentWorkflow()"
                disabled
                style="flex:2; background:var(--macos-accent-green); color:white; padding:12px 32px; border-radius:10px; font-weight:600; border:none; cursor:not-allowed; opacity:0.5; font-size:14px; transition:all 0.2s;">
          ðŸ“§ Zahlungslink versenden
        </button>
      </div>

      <!-- Loading State Overlay -->
      <div id="paymentWorkflowLoading" style="display:none; position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.95); backdrop-filter:saturate(180%) blur(20px); border-radius:16px; flex-direction:column; align-items:center; justify-content:center; z-index:10;">
        <div style="font-size:48px; margin-bottom:16px; animation:spin 2s linear infinite;">â³</div>
        <div style="font-size:16px; font-weight:600; color:var(--macos-text-primary); margin-bottom:8px;">Zahlungslink wird erstellt...</div>
        <div style="font-size:13px; color:var(--macos-text-secondary);">Email wird an Kunden versendet</div>
      </div>

    </div>
  </div>

  <style>
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  </style>

  <script>
    // ============================================
    // AUTH & PROFILE SYSTEM
    // ============================================

    let currentUser = null;

    // Check for saved session on page load
    async function initAuth() {
      try {
        console.log('ðŸ”„ Initializing authentication...');
        const rememberMe = localStorage.getItem('rememberMe') === 'true';
        const savedUsername = localStorage.getItem('username');

        if (rememberMe && savedUsername) {
          console.log('ðŸ”‘ Found saved session for:', savedUsername);

          // Verify user still exists and get fresh data (case-insensitive)
          const { data: profiles, error } = await supabase
            .from('profiles')
            .select('id, username, email, role, password_hash, avatar_url')
            .ilike('username', savedUsername);

          if (error) {
            console.error('âŒ Database error during session restore:', error);
            localStorage.removeItem('rememberMe');
            localStorage.removeItem('username');
            localStorage.removeItem('userRole');
            localStorage.removeItem('avatarUrl');
          } else if (profiles && profiles.length > 0) {
            const profile = profiles[0];
            console.log('âœ… Session restored successfully for:', profile.username);
            currentUser = profile;
            localStorage.setItem('userRole', profile.role || 'user');

            // Update localStorage with fresh avatar URL from database
            if (profile.avatar_url) {
              localStorage.setItem('avatarUrl', profile.avatar_url);
            } else {
              localStorage.removeItem('avatarUrl');
            }

            // Update UI with complete profile data
            updateUIForUser(profile);
            await initializePermissions();
            return;
          } else {
            console.log('âš ï¸ Saved user not found - clearing session');
            localStorage.removeItem('rememberMe');
            localStorage.removeItem('username');
            localStorage.removeItem('userRole');
            localStorage.removeItem('avatarUrl');
          }
        }

        // Show login modal if not logged in
        console.log('ðŸ“‹ No session found - showing login modal');
        setTimeout(() => {
          document.getElementById('loginBackdrop').classList.add('active');
        }, 500);
      } catch (err) {
        console.error('ðŸ’¥ Init auth failed:', err);
      }
    }

    // Test Database Connection (for debugging)
    async function testDatabaseConnection() {
      console.log('ðŸ§ª Testing database connection to profiles table...');

      try {
        // Test 1: Select all profiles
        const { data: allProfiles, error: error1 } = await supabase
          .from('profiles')
          .select('*');

        console.log('âœ… Test 1 - All profiles:', allProfiles);
        console.log('âŒ Error 1:', error1);

        // Test 2: Select specific username
        const { data: fayProfile, error: error2 } = await supabase
          .from('profiles')
          .select('*')
          .eq('username', 'Fay');

        console.log('âœ… Test 2 - Fay (exact match):', fayProfile);
        console.log('âŒ Error 2:', error2);

        // Test 3: Select with ilike
        const { data: fayProfileIlike, error: error3 } = await supabase
          .from('profiles')
          .select('*')
          .ilike('username', 'Fay');

        console.log('âœ… Test 3 - Fay (ilike):', fayProfileIlike);
        console.log('âŒ Error 3:', error3);

        // Display results
        let message = 'ðŸ“Š Database Test Results:\n\n';
        message += `Total profiles: ${allProfiles?.length || 0}\n`;
        message += `Fay found (exact): ${fayProfile?.length || 0}\n`;
        message += `Fay found (ilike): ${fayProfileIlike?.length || 0}\n\n`;

        if (allProfiles && allProfiles.length > 0) {
          message += 'Available usernames:\n';
          message += allProfiles.map(p => `- ${p.username}`).join('\n');
        }

        if (error1 || error2 || error3) {
          message += '\n\nâš ï¸ ERRORS DETECTED:\n';
          if (error1) message += `Error 1: ${error1.message}\n`;
          if (error2) message += `Error 2: ${error2.message}\n`;
          if (error3) message += `Error 3: ${error3.message}\n`;
        }

        alert(message);
        console.log('ðŸ“‹ Full test results:', { allProfiles, fayProfile, fayProfileIlike });

      } catch (err) {
        console.error('ðŸ’¥ Database test failed:', err);
        alert('Database test failed: ' + err.message);
      }
    }

    // Login function
    async function handleLogin(e) {
      e.preventDefault();

      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const rememberMe = document.getElementById('rememberMe').checked;

      if (!username || !password) {
        alert('Bitte fÃ¼lle alle Felder aus');
        return;
      }

      // Visual feedback
      const submitButton = e.target.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.textContent = 'Anmelden...';
      submitButton.disabled = true;

      try {
        console.log('ðŸ” Login attempt for:', username);

        // Query user by username (case-insensitive)
        const { data: profiles, error } = await supabase
          .from('profiles')
          .select('id, username, email, role, password_hash, avatar_url')
          .ilike('username', username);

        console.log('ðŸ“Š Query result:', { profiles, error, count: profiles?.length });

        if (error) {
          console.error('âŒ Database error:', error);
          alert('Datenbankfehler: ' + error.message);
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        if (!profiles || profiles.length === 0) {
          console.log('âš ï¸ User not found:', username);
          // Try to see all profiles for debugging (remove in production)
          const { data: allProfiles } = await supabase.from('profiles').select('username');
          console.log('ðŸ“‹ Available usernames:', allProfiles?.map(p => p.username));
          alert('Benutzername nicht gefunden');
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        const profile = profiles[0];
        console.log('ðŸ‘¤ Found user:', profile.username, '| Role:', profile.role);

        // Check if password_hash exists
        if (!profile.password_hash) {
          console.error('âŒ No password set for user:', username);
          alert('Kein Passwort fÃ¼r diesen Benutzer gesetzt. Bitte kontaktiere einen Administrator.');
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        // Check password using bcrypt for hashed passwords
        let passwordMatch = false;

        // Check if password_hash looks like a bcrypt hash (starts with $2a$, $2b$, $2y$)
        if (profile.password_hash.startsWith('$2')) {
          // Use bcrypt to compare
          console.log('ðŸ” Comparing password using bcrypt...');
          passwordMatch = await bcrypt.compare(password, profile.password_hash);
        } else {
          // Direct comparison for plain-text passwords (development/testing only)
          console.log('âš ï¸ Using direct password comparison (not recommended for production)');
          passwordMatch = profile.password_hash === password;
        }

        if (!passwordMatch) {
          console.log('âŒ Wrong password for:', username);
          alert('Falsches Passwort');
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        // Login successful
        console.log('âœ… Login successful for:', profile.username);
        currentUser = profile;

        if (rememberMe) {
          localStorage.setItem('rememberMe', 'true');
          localStorage.setItem('username', profile.username);
          localStorage.setItem('userRole', profile.role || 'user');
          if (profile.avatar_url) {
            localStorage.setItem('avatarUrl', profile.avatar_url);
            console.log('ðŸ’¾ Session saved to localStorage (including avatar)');
          } else {
            console.log('ðŸ’¾ Session saved to localStorage');
          }
        }

        // Update UI
        updateUIForUser(profile);
        closeLoginModal();

        alert(`Willkommen zurÃ¼ck, ${profile.username}!`);

        // Reload data
        await initializePermissions();
        await loadEvents();
        renderCalendar();

        // Reset button state
        submitButton.textContent = originalText;
        submitButton.disabled = false;

      } catch (err) {
        console.error('ðŸ’¥ Login failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      }
    }

    // Update UI for logged-in user
    function updateUIForUser(profile) {
      console.log('ðŸŽ¨ Updating UI for user:', profile.username);
      console.log('ðŸ–¼ï¸ Avatar URL:', profile.avatar_url || 'No avatar URL found');

      // Update profile dropdown
      const profileDropdownUsername = document.getElementById('profileDropdownUsername');
      const profileDropdownEmail = document.getElementById('profileDropdownEmail');

      if (profileDropdownUsername) {
        profileDropdownUsername.textContent = profile.username || 'User name';
      }
      if (profileDropdownEmail) {
        profileDropdownEmail.textContent = profile.email || 'user@example.com';
      }

      // Update Account Settings Page
      const usernameDisplay = document.getElementById('usernameDisplay');
      const roleDisplay = document.getElementById('roleDisplay');
      const emailInput = document.getElementById('emailInput');
      const phoneInput = document.getElementById('phoneInput');
      const avatarDisplay = document.getElementById('avatarDisplay');

      if (usernameDisplay) {
        usernameDisplay.textContent = profile.username || 'username';
      }
      if (roleDisplay) {
        roleDisplay.textContent = (profile.role || 'user').charAt(0).toUpperCase() + (profile.role || 'user').slice(1);
      }
      if (emailInput) {
        emailInput.value = profile.email || '';
      }
      // phoneInput wird aus localStorage geladen

      // Update avatar in Account Settings
      if (avatarDisplay && profile.avatar_url) {
        avatarDisplay.style.background = 'none';
        avatarDisplay.innerHTML = `<img src="${profile.avatar_url}" alt="Avatar">`;
      }

      // Show welcome message
      const dashboardWelcome = document.getElementById('dashboardWelcome');
      const dashboardWelcomeText = document.getElementById('dashboardWelcomeText');
      const dashboardAvatar = document.getElementById('dashboardAvatar');

      if (dashboardWelcome) {
        dashboardWelcome.style.display = 'flex';
        dashboardWelcomeText.textContent = `Willkommen ${profile.username}`;

        if (profile.avatar_url && dashboardAvatar) {
          dashboardAvatar.src = profile.avatar_url;
          dashboardAvatar.onerror = function() {
            console.error('âŒ Failed to load dashboard avatar:', profile.avatar_url);
          };
          console.log('âœ… Dashboard avatar updated:', profile.avatar_url);
        }
      }

      // Update profile modal fields
      const profileUsername = document.getElementById('profileUsername');
      const profileEmail = document.getElementById('profileEmail');
      const profileRole = document.getElementById('profileRole');
      const profileAvatarPreview = document.getElementById('profileAvatarPreview');

      if (profileUsername) profileUsername.value = profile.username || '';
      if (profileEmail) profileEmail.value = profile.email || '';
      if (profileRole) profileRole.value = profile.role || 'user';
      if (profileAvatarPreview && profile.avatar_url) {
        profileAvatarPreview.src = profile.avatar_url;
      }
    }

    // Close login modal
    function closeLoginModal() {
      document.getElementById('loginBackdrop').classList.remove('active');

      // Reset to login view and hide password change form
      setTimeout(() => {
        document.getElementById('loginFormView').style.display = 'block';
        document.getElementById('profileView').style.display = 'none';
        hidePasswordChangeForm();
      }, 300); // Wait for backdrop animation to finish
    }

    // Logout
    async function logout() {
      if (confirm('MÃ¶chtest du dich wirklich abmelden?')) {
        console.log('ðŸšª Logging out user:', currentUser?.username);

        currentUser = null;
        localStorage.removeItem('rememberMe');
        localStorage.removeItem('username');
        localStorage.removeItem('userRole');
        localStorage.removeItem('avatarUrl');

        console.log('ðŸ—‘ï¸ Session data cleared (including avatar)');

        // Reset UI
        const dashboardWelcome = document.getElementById('dashboardWelcome');
        if (dashboardWelcome) {
          dashboardWelcome.style.display = 'none';
        }

        alert('Du wurdest abgemeldet');

        // Show login modal again
        setTimeout(() => {
          document.getElementById('loginBackdrop').classList.add('active');
        }, 100);

        console.log('âœ… Logout complete');
      }
    }

    // Profile button click handler
    function toggleProfileMenu() {
      if (currentUser) {
        // Navigate to profile section (full-page view)
        const tabs = document.querySelectorAll("nav a[id^='tab-']");
        const sections = document.querySelectorAll("section");

        // Deactivate all tabs and sections
        tabs.forEach(t => t.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));

        // Activate profile section
        const profileSection = document.getElementById('profile-section');
        if (profileSection) {
          profileSection.classList.add('active');
          loadProfilePage();
        }
      } else {
        // Show login modal
        document.getElementById('loginBackdrop').classList.add('active');
        document.getElementById('loginFormView').style.display = 'block';
        document.getElementById('profileView').style.display = 'none';
      }
    }

    // Show profile view with user data
    function showProfileView() {
      console.log('ðŸ“‹ Opening profile view for:', currentUser.username);
      console.log('ðŸ–¼ï¸ Profile avatar URL:', currentUser.avatar_url || 'No avatar URL');

      // Switch to profile view
      document.getElementById('loginFormView').style.display = 'none';
      document.getElementById('profileView').style.display = 'block';
      document.getElementById('loginBackdrop').classList.add('active');

      // Update profile view with current user data
      document.getElementById('profileName').textContent = currentUser.username;
      document.getElementById('profileUsernameValue').textContent = currentUser.username;
      document.getElementById('profileRoleValue').textContent = (currentUser.role || 'user').toUpperCase();

      // Update avatar if exists
      const avatarLarge = document.getElementById('profileAvatarLarge');
      if (currentUser.avatar_url) {
        avatarLarge.src = currentUser.avatar_url;
        avatarLarge.style.display = 'block';
        avatarLarge.onerror = function() {
          console.error('âŒ Failed to load large profile avatar:', currentUser.avatar_url);
          avatarLarge.style.display = 'none';
        };
        console.log('âœ… Large profile avatar set:', currentUser.avatar_url);
      } else {
        avatarLarge.style.display = 'none';
      }

      // Reset password display and hide change form
      document.getElementById('profilePasswordValue').textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
      hidePasswordChangeForm();
    }

    // Toggle password visibility
    function togglePassword() {
      const passwordValue = document.getElementById('profilePasswordValue');
      const toggleBtn = event.target;

      if (passwordValue.textContent === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
        // Show password
        passwordValue.textContent = currentUser.password_hash || 'Nicht gesetzt';
        toggleBtn.textContent = 'Verbergen';
      } else {
        // Hide password
        passwordValue.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        toggleBtn.textContent = 'Anzeigen';
      }
    }

    // Upload avatar
    async function uploadAvatar() {
      const fileInput = document.getElementById('avatarUpload');
      const file = fileInput.files[0];

      if (!file) {
        alert('Bitte wÃ¤hle ein Bild aus');
        return;
      }

      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Die Datei ist zu groÃŸ. Maximal 5MB erlaubt.');
        return;
      }

      // Check file type
      if (!file.type.startsWith('image/')) {
        alert('Bitte wÃ¤hle eine Bilddatei aus');
        return;
      }

      try {
        console.log('ðŸ“¤ Uploading avatar for:', currentUser.username);

        // Generate unique filename (without subdirectory to avoid RLS issues)
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;

        // Upload to Supabase Storage (root of bucket to avoid RLS policy issues)
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: true
          });

        if (uploadError) {
          console.error('âŒ Upload error:', uploadError);
          alert('Fehler beim Hochladen: ' + uploadError.message);
          return;
        }

        // Get public URL
        const { data: { publicUrl } } = supabase.storage
          .from('avatars')
          .getPublicUrl(fileName);

        console.log('âœ… Avatar uploaded:', publicUrl);

        // Update profile in database
        const { error: updateError } = await supabase
          .from('profiles')
          .update({ avatar_url: publicUrl })
          .eq('id', currentUser.id);

        if (updateError) {
          console.error('âŒ Database update error:', updateError);
          alert('Fehler beim Speichern: ' + updateError.message);
          return;
        }

        // Update current user object
        currentUser.avatar_url = publicUrl;

        // Update UI
        updateUIForUser(currentUser);
        document.getElementById('profileAvatarLarge').src = publicUrl;
        document.getElementById('profileAvatarLarge').style.display = 'block';

        alert('âœ… Profilbild erfolgreich hochgeladen!');
        console.log('âœ… Profile updated successfully');

      } catch (err) {
        console.error('ðŸ’¥ Avatar upload failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
      }
    }

    // ============================================
    // AVATAR UPLOAD MODAL FUNCTIONS
    // ============================================

    let selectedAvatarFile = null;

    // Open Avatar Upload Modal
    function openAvatarUploadModal() {
      // Show current avatar if exists
      const currentAvatarImg = document.getElementById('currentAvatarImg');
      const currentAvatarPreview = document.getElementById('currentAvatarPreview');

      if (currentUser && currentUser.avatar_url) {
        currentAvatarImg.src = currentUser.avatar_url;
        currentAvatarPreview.style.display = 'block';
      } else {
        currentAvatarPreview.style.display = 'none';
      }

      // Reset form
      selectedAvatarFile = null;
      document.getElementById('avatarFileInput').value = '';
      document.getElementById('avatarPreviewContainer').style.display = 'none';
      document.getElementById('uploadProgress').style.display = 'none';
      document.getElementById('uploadAvatarBtn').disabled = true;
      document.getElementById('uploadAvatarBtn').style.opacity = '0.5';

      // Show modal
      document.getElementById('avatarUploadModal').classList.add('active');
    }

    // Close Avatar Upload Modal
    function closeAvatarUploadModal() {
      document.getElementById('avatarUploadModal').classList.remove('active');
      selectedAvatarFile = null;
    }

    // Handle drag over
    function handleDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      const dropZone = document.getElementById('avatarDropZone');
      dropZone.style.borderColor = 'var(--accent)';
      dropZone.style.background = '#e0f2fe';
    }

    // Handle drag leave
    function handleDragLeave(event) {
      event.preventDefault();
      event.stopPropagation();
      const dropZone = document.getElementById('avatarDropZone');
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '#f9fafb';
    }

    // Handle drop
    function handleDrop(event) {
      event.preventDefault();
      event.stopPropagation();

      const dropZone = document.getElementById('avatarDropZone');
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '#f9fafb';

      const files = event.dataTransfer.files;
      if (files.length > 0) {
        processAvatarFile(files[0]);
      }
    }

    // Handle file select
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        processAvatarFile(file);
      }
    }

    // Process selected file
    function processAvatarFile(file) {
      // Check file type
      if (!file.type.startsWith('image/')) {
        alert('Bitte wÃ¤hle eine Bilddatei aus (PNG, JPG, GIF)');
        return;
      }

      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Die Datei ist zu groÃŸ. Maximal 5MB erlaubt.');
        return;
      }

      selectedAvatarFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('avatarPreview').src = e.target.result;
        document.getElementById('avatarFileName').textContent = file.name;
        document.getElementById('avatarPreviewContainer').style.display = 'block';

        // Enable upload button
        document.getElementById('uploadAvatarBtn').disabled = false;
        document.getElementById('uploadAvatarBtn').style.opacity = '1';
      };
      reader.readAsDataURL(file);
    }

    // Upload avatar from modal
    async function uploadAvatarFromModal() {
      if (!selectedAvatarFile) {
        alert('Bitte wÃ¤hle ein Bild aus');
        return;
      }

      const uploadBtn = document.getElementById('uploadAvatarBtn');
      const progressDiv = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('uploadProgressBar');

      try {
        // Disable button and show progress
        uploadBtn.disabled = true;
        uploadBtn.style.opacity = '0.5';
        progressDiv.style.display = 'block';
        progressBar.style.width = '30%';

        console.log('ðŸ“¤ Uploading avatar for:', currentUser.username);

        // Generate unique filename (without subdirectory to avoid RLS issues)
        const fileExt = selectedAvatarFile.name.split('.').pop();
        const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;

        progressBar.style.width = '50%';

        // Upload to Supabase Storage (root of bucket to avoid RLS policy issues)
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(fileName, selectedAvatarFile, {
            cacheControl: '3600',
            upsert: true
          });

        if (uploadError) {
          console.error('âŒ Upload error:', uploadError);
          alert('Fehler beim Hochladen: ' + uploadError.message);
          progressDiv.style.display = 'none';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          return;
        }

        progressBar.style.width = '70%';

        // Get public URL
        const { data: { publicUrl } } = supabase.storage
          .from('avatars')
          .getPublicUrl(fileName);

        console.log('âœ… Avatar uploaded:', publicUrl);

        progressBar.style.width = '90%';

        // Update profile in database
        const { error: updateError } = await supabase
          .from('profiles')
          .update({ avatar_url: publicUrl })
          .eq('id', currentUser.id);

        if (updateError) {
          console.error('âŒ Database update error:', updateError);
          alert('Fehler beim Speichern: ' + updateError.message);
          progressDiv.style.display = 'none';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          return;
        }

        progressBar.style.width = '100%';

        // Update current user object
        currentUser.avatar_url = publicUrl;

        // Save avatar URL to localStorage for persistence
        localStorage.setItem('avatarUrl', publicUrl);
        console.log('ðŸ’¾ Avatar URL saved to localStorage');

        // Update UI
        updateUIForUser(currentUser);
        document.getElementById('profileAvatarLarge').src = publicUrl;
        document.getElementById('profileAvatarLarge').style.display = 'block';

        // Close modal after short delay
        setTimeout(() => {
          closeAvatarUploadModal();
          alert('âœ… Profilbild erfolgreich hochgeladen!');
        }, 500);

        console.log('âœ… Profile updated successfully');

      } catch (err) {
        console.error('ðŸ’¥ Avatar upload failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
        progressDiv.style.display = 'none';
        uploadBtn.disabled = false;
        uploadBtn.style.opacity = '1';
      }
    }

    // ============================================
    // PROFILE PAGE FUNCTIONS
    // ============================================

    let selectedProfileAvatarFile = null;

    // Load profile page
    function loadProfilePage() {
      if (!currentUser) {
        alert('Bitte melden Sie sich zuerst an');
        return;
      }

      // Update profile information
      document.getElementById('profilePageName').textContent = currentUser.username;
      document.getElementById('profilePageUsername').textContent = currentUser.username;
      document.getElementById('profilePageRoleText').textContent = (currentUser.role || 'user').toUpperCase();
      document.getElementById('profilePageRoleBadge').textContent = (currentUser.role || 'user').toUpperCase();

      // Update avatar
      const profilePageAvatar = document.getElementById('profilePageAvatar');
      const profilePageCurrentAvatarImg = document.getElementById('profilePageCurrentAvatarImg');

      if (currentUser.avatar_url) {
        profilePageAvatar.src = currentUser.avatar_url;
        profilePageCurrentAvatarImg.src = currentUser.avatar_url;
        document.getElementById('profilePageCurrentAvatarPreview').style.display = 'block';
      } else {
        document.getElementById('profilePageCurrentAvatarPreview').style.display = 'none';
      }

      // Reset upload form
      selectedProfileAvatarFile = null;
      document.getElementById('profilePageAvatarFileInput').value = '';
      document.getElementById('profilePageAvatarPreviewContainer').style.display = 'none';
      document.getElementById('profilePageUploadProgress').style.display = 'none';
      document.getElementById('profilePageUploadAvatarBtn').disabled = true;
      document.getElementById('profilePageUploadAvatarBtn').style.opacity = '0.5';
    }

    // Handle drag over for profile page
    function handleProfileDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      const dropZone = document.getElementById('profilePageAvatarDropZone');
      dropZone.style.borderColor = 'var(--accent)';
      dropZone.style.background = '#e0f2fe';
    }

    // Handle drag leave for profile page
    function handleProfileDragLeave(event) {
      event.preventDefault();
      event.stopPropagation();
      const dropZone = document.getElementById('profilePageAvatarDropZone');
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '#f9fafb';
    }

    // Handle drop for profile page
    function handleProfileDrop(event) {
      event.preventDefault();
      event.stopPropagation();

      const dropZone = document.getElementById('profilePageAvatarDropZone');
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '#f9fafb';

      const files = event.dataTransfer.files;
      if (files.length > 0) {
        processProfileAvatarFile(files[0]);
      }
    }

    // Handle file select for profile page
    function handleProfileFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        processProfileAvatarFile(file);
      }
    }

    // Process selected file for profile page
    function processProfileAvatarFile(file) {
      // Check file type
      if (!file.type.startsWith('image/')) {
        alert('Bitte wÃ¤hle eine Bilddatei aus (PNG, JPG, GIF)');
        return;
      }

      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Die Datei ist zu groÃŸ. Maximal 5MB erlaubt.');
        return;
      }

      selectedProfileAvatarFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('profilePageAvatarPreview').src = e.target.result;
        document.getElementById('profilePageAvatarFileName').textContent = file.name;
        document.getElementById('profilePageAvatarPreviewContainer').style.display = 'block';

        // Enable upload button
        document.getElementById('profilePageUploadAvatarBtn').disabled = false;
        document.getElementById('profilePageUploadAvatarBtn').style.opacity = '1';
      };
      reader.readAsDataURL(file);
    }

    // Upload avatar from profile page
    async function uploadAvatarFromProfilePage() {
      if (!selectedProfileAvatarFile) {
        alert('Bitte wÃ¤hle ein Bild aus');
        return;
      }

      const uploadBtn = document.getElementById('profilePageUploadAvatarBtn');
      const progressDiv = document.getElementById('profilePageUploadProgress');
      const progressBar = document.getElementById('profilePageUploadProgressBar');

      try {
        // Disable button and show progress
        uploadBtn.disabled = true;
        uploadBtn.style.opacity = '0.5';
        progressDiv.style.display = 'block';
        progressBar.style.width = '30%';

        console.log('ðŸ“¤ Uploading avatar for:', currentUser.username);

        // Generate unique filename (without subdirectory to avoid RLS issues)
        const fileExt = selectedProfileAvatarFile.name.split('.').pop();
        const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;

        progressBar.style.width = '50%';

        // Upload to Supabase Storage (root of bucket to avoid RLS policy issues)
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(fileName, selectedProfileAvatarFile, {
            cacheControl: '3600',
            upsert: true
          });

        if (uploadError) {
          console.error('âŒ Upload error:', uploadError);
          alert('Fehler beim Hochladen: ' + uploadError.message);
          progressDiv.style.display = 'none';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          return;
        }

        progressBar.style.width = '70%';

        // Get public URL
        const { data: { publicUrl } } = supabase.storage
          .from('avatars')
          .getPublicUrl(fileName);

        console.log('âœ… Avatar uploaded:', publicUrl);

        progressBar.style.width = '90%';

        // Update profile in database
        const { error: updateError } = await supabase
          .from('profiles')
          .update({ avatar_url: publicUrl })
          .eq('id', currentUser.id);

        if (updateError) {
          console.error('âŒ Database update error:', updateError);
          alert('Fehler beim Speichern: ' + updateError.message);
          progressDiv.style.display = 'none';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          return;
        }

        progressBar.style.width = '100%';

        // Update current user object
        currentUser.avatar_url = publicUrl;

        // Save avatar URL to localStorage for persistence
        localStorage.setItem('avatarUrl', publicUrl);
        console.log('ðŸ’¾ Avatar URL saved to localStorage');

        // Update UI
        updateUIForUser(currentUser);
        document.getElementById('profilePageAvatar').src = publicUrl;
        document.getElementById('profilePageCurrentAvatarImg').src = publicUrl;
        document.getElementById('profilePageCurrentAvatarPreview').style.display = 'block';

        // Reset form
        setTimeout(() => {
          selectedProfileAvatarFile = null;
          document.getElementById('profilePageAvatarFileInput').value = '';
          document.getElementById('profilePageAvatarPreviewContainer').style.display = 'none';
          progressDiv.style.display = 'none';
          uploadBtn.disabled = true;
          uploadBtn.style.opacity = '0.5';
          alert('âœ… Profilbild erfolgreich hochgeladen!');
        }, 500);

        console.log('âœ… Profile updated successfully');

      } catch (err) {
        console.error('ðŸ’¥ Avatar upload failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
        progressDiv.style.display = 'none';
        uploadBtn.disabled = false;
        uploadBtn.style.opacity = '1';
      }
    }

    // Show password change form for profile page
    function showPasswordChangeFormPage() {
      document.getElementById('profilePagePasswordChangeForm').style.display = 'block';
    }

    // Hide password change form for profile page
    function hidePasswordChangeFormPage() {
      document.getElementById('profilePagePasswordChangeForm').style.display = 'none';
      document.getElementById('profilePageNewPassword').value = '';
      document.getElementById('profilePageConfirmPassword').value = '';
    }

    // Change password from profile page
    async function changePasswordPage() {
      const newPassword = document.getElementById('profilePageNewPassword').value;
      const confirmPassword = document.getElementById('profilePageConfirmPassword').value;

      // Validation
      if (!newPassword || !confirmPassword) {
        alert('Bitte fÃ¼lle beide Felder aus');
        return;
      }

      if (newPassword.length < 6) {
        alert('Das Passwort muss mindestens 6 Zeichen lang sein');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('Die PasswÃ¶rter stimmen nicht Ã¼berein');
        return;
      }

      try {
        console.log('ðŸ”‘ Changing password for:', currentUser.username);

        // Hash password using bcrypt
        const hashedPassword = await bcrypt.hash(newPassword, 10);

        // Update password in database
        const { error } = await supabase
          .from('profiles')
          .update({ password_hash: hashedPassword })
          .eq('id', currentUser.id);

        if (error) {
          console.error('âŒ Password update error:', error);
          alert('Fehler beim Ã„ndern des Passworts: ' + error.message);
          return;
        }

        console.log('âœ… Password changed successfully');
        alert('âœ… Passwort erfolgreich geÃ¤ndert!');
        hidePasswordChangeFormPage();

      } catch (err) {
        console.error('ðŸ’¥ Password change failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
      }
    }

    // Show password change form
    function showPasswordChangeForm() {
      document.getElementById('passwordChangeForm').style.display = 'block';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    // Hide password change form
    function hidePasswordChangeForm() {
      document.getElementById('passwordChangeForm').style.display = 'none';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    // Change password
    async function changePassword() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validation
      if (!newPassword || !confirmPassword) {
        alert('Bitte fÃ¼lle beide Felder aus');
        return;
      }

      if (newPassword.length < 6) {
        alert('Das Passwort muss mindestens 6 Zeichen lang sein');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('Die PasswÃ¶rter stimmen nicht Ã¼berein');
        return;
      }

      try {
        console.log('ðŸ”‘ Changing password for:', currentUser.username);

        // Hash password using bcrypt
        const hashedPassword = await bcrypt.hash(newPassword, 10);

        // Update password in database
        const { error } = await supabase
          .from('profiles')
          .update({ password_hash: hashedPassword })
          .eq('id', currentUser.id);

        if (error) {
          console.error('âŒ Password update error:', error);
          alert('Fehler beim Ã„ndern des Passworts: ' + error.message);
          return;
        }

        // Update current user object
        currentUser.password_hash = hashedPassword;

        // Hide form and show success message
        hidePasswordChangeForm();
        alert('âœ… Passwort erfolgreich geÃ¤ndert!');
        console.log('âœ… Password changed successfully');

      } catch (err) {
        console.error('ðŸ’¥ Password change failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
      }
    }

    // ============================================
    // DEBUG HELPER FUNCTIONS
    // ============================================

    // Test database connection
    async function testDatabaseConnection() {
      console.log('ðŸ”Œ Testing database connection...');
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('count')
          .limit(1);

        if (error) {
          console.error('âŒ Database connection failed:', error);
          return false;
        }

        console.log('âœ… Database connection successful');
        return true;
      } catch (err) {
        console.error('ðŸ’¥ Database connection test failed:', err);
        return false;
      }
    }

    // List all users in profiles table
    async function debugListUsers() {
      console.log('ðŸ“‹ Fetching all users from profiles table...');
      try {
        const { data: profiles, error } = await supabase
          .from('profiles')
          .select('id, username, role, email, created_at')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('âŒ Error fetching users:', error);
          return;
        }

        console.log('âœ… Found', profiles.length, 'users:');
        console.table(profiles);
        return profiles;
      } catch (err) {
        console.error('ðŸ’¥ Failed to list users:', err);
      }
    }

    // Test login with username/password
    async function debugTestLogin(username, password) {
      console.log('ðŸ§ª Testing login for:', username);
      try {
        // Query user by username (case-insensitive)
        const { data: profiles, error } = await supabase
          .from('profiles')
          .select('*')
          .ilike('username', username);

        if (error) {
          console.error('âŒ Database error:', error);
          return false;
        }

        if (!profiles || profiles.length === 0) {
          console.log('âš ï¸ User not found:', username);
          return false;
        }

        const profile = profiles[0];
        console.log('ðŸ‘¤ Found user:', profile.username);
        console.log('ðŸ”‘ Has password_hash:', !!profile.password_hash);
        console.log('ðŸŽ­ Role:', profile.role);

        if (!profile.password_hash) {
          console.error('âŒ No password set for user');
          return false;
        }

        const passwordMatch = profile.password_hash === password;
        if (passwordMatch) {
          console.log('âœ… Password matches!');
        } else {
          console.log('âŒ Password does not match');
        }

        return passwordMatch;
      } catch (err) {
        console.error('ðŸ’¥ Debug login test failed:', err);
        return false;
      }
    }

    // Make debug functions available globally
    window.testDatabaseConnection = testDatabaseConnection;
    window.debugListUsers = debugListUsers;
    window.debugTestLogin = debugTestLogin;

    // ========================================
    // ANALYTICS SECTION
    // ========================================

    let currentTimeRange = 'weekly';
    let appointmentsData = []; // For timeline chart
    let requestsData = []; // For origin chart
    let allRequestsData = []; // For requests count (including canceled)
    let projectsData = []; // For revenue analytics

    // Load analytics data from Supabase
    // Load appointments data for Timeline Chart (uses created_at)
    async function loadAppointmentsData(locationFilter = null) {
      try {
        console.log('ðŸ“Š Loading appointments data for timeline...');
        console.log('ðŸ“Š Location filter:', locationFilter || 'None');
        console.log('ðŸ“Š Current user:', currentUser ? currentUser.username : 'Not logged in');

        // First, try to count total appointments to check if we have access
        console.log('ðŸ” Checking table access...');
        const { count, error: countError } = await supabase
          .from('appointments')
          .select('*', { count: 'exact', head: true });

        console.log('ðŸ“Š Total appointments in table (accessible):', count);
        if (countError) {
          console.error('âŒ Count error:', countError);
        }

        // PAGINATED LOADING: Load ALL appointments in batches of 1000
        console.log('ðŸš¨ APPOINTMENTS QUERY VERSION: 2025-11-13-v7 PAGINATED - loading ALL records in batches');
        console.log('â³ Fetching all appointments from Supabase using pagination...');

        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;
        let batchNumber = 1;

        while (hasMore) {
          console.log(`ðŸ“¦ Loading batch ${batchNumber} (records ${from} to ${from + batchSize - 1})...`);

          let query = supabase
            .from('appointments')
            .select('booking_type, state, created_at, location_id, id')
            .not('created_at', 'is', null)  // Only get appointments with created_at
            .order('created_at', { ascending: true })  // Load OLDEST first to get 2024 AND 2025 data
            .range(from, from + batchSize - 1);  // Paginate with range

          // Don't apply location filter if it's an empty string or invalid
          if (locationFilter && locationFilter !== '' && locationFilter !== 'null') {
            query = query.eq('location_id', locationFilter);
          }

          const { data, error } = await query;

          if (error) {
            console.error('âŒ Supabase error on batch', batchNumber, ':', error);
            throw error;
          }

          if (data && data.length > 0) {
            allData = allData.concat(data);
            console.log(`âœ… Batch ${batchNumber}: Loaded ${data.length} records. Total so far: ${allData.length}`);
            from += batchSize;
            hasMore = data.length === batchSize;  // If we got less than batchSize, we're done
            batchNumber++;
          } else {
            hasMore = false;
          }
        }

        console.log(`âœ… Successfully loaded ${allData.length} of ${count || 'unknown'} appointments`);
        if (allData.length < count) {
          console.warn(`âš ï¸ WARNING: Only loaded ${allData.length} out of ${count} appointments!`);
        } else {
          console.log(`ðŸŽ‰ SUCCESS: All ${allData.length} appointments loaded!`);
        }

        // If no data at all, return empty array
        if (!allData || allData.length === 0) {
          console.warn('âš ï¸ Appointments table is empty');
          return [];
        }

        // DEBUG: Show sample of created_at values
        console.log('ðŸ“… Sample created_at values (first 5):', allData.slice(0, 5).map(apt => apt.created_at));

        // DEBUG: Show date range of loaded appointments
        const dates = allData.map(apt => new Date(apt.created_at)).filter(d => !isNaN(d.getTime()));
        if (dates.length > 0) {
          const minDate = new Date(Math.min(...dates));
          const maxDate = new Date(Math.max(...dates));
          console.log('ðŸ“… Date range:', minDate.toLocaleDateString('de-DE'), 'to', maxDate.toLocaleDateString('de-DE'));
          console.log('ðŸ“… Valid dates:', dates.length, 'out of', allData.length, 'appointments');
          console.log(`ðŸ“Š Total appointments loaded: ${allData.length}`);
          console.log(`ðŸ“… Oldest appointment: ${minDate.toLocaleDateString('de-DE')}`);
          console.log(`ðŸ“… Newest appointment: ${maxDate.toLocaleDateString('de-DE')}`);
        }

        // Analyze state distribution
        const stateCounts = {};
        allData.forEach(apt => {
          const state = apt.state || 'null';
          stateCounts[state] = (stateCounts[state] || 0) + 1;
        });
        console.log('ðŸ“Š State distribution:', stateCounts);

        // Filter for relevant states (if they exist)
        // Accept: scheduled, finished, completed, confirmed, or any state that's not cancelled
        const filteredData = allData.filter(apt => {
          const state = apt.state?.toLowerCase();
          return state &&
                 state !== 'cancelled' &&
                 state !== 'canceled' &&
                 state !== 'rejected';
        });

        console.log(`âœ… ${filteredData.length} appointments after filtering (excluding cancelled/rejected)`);

        // If filtering removes all data, use all data anyway
        if (filteredData.length === 0 && allData.length > 0) {
          console.warn('âš ï¸ All appointments filtered out, using all appointments instead');
          return allData;
        }

        return filteredData.length > 0 ? filteredData : allData;

      } catch (err) {
        console.error('âŒ Appointments data load failed:', err);
        console.error('âŒ Error details:', {
          message: err.message,
          code: err.code,
          details: err.details,
          hint: err.hint
        });
        return [];
      }
    }

    // Load requests data for Origin Pie Chart (uses created_at and origin)
    async function loadRequestsData(locationFilter = null) {
      try {
        console.log('ðŸ“Š Loading requests data for origin chart...');
        console.log('ðŸ“Š Location filter:', locationFilter || 'None');

        // First, count total requests
        const { count, error: countError } = await supabase
          .from('requests')
          .select('*', { count: 'exact', head: true });

        console.log('ðŸ“Š Total requests in table:', count);
        if (countError) {
          console.error('âŒ Count error:', countError);
        }

        // PAGINATED LOADING: Load ALL requests in batches of 1000
        console.log('ðŸš¨ REQUESTS ORIGIN QUERY VERSION: 2025-11-13-v7 PAGINATED - loading ALL records in batches');
        console.log('â³ Analyzing all requests for origin chart using pagination...');

        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;
        let batchNumber = 1;

        while (hasMore) {
          console.log(`ðŸ“¦ Loading requests batch ${batchNumber} (records ${from} to ${from + batchSize - 1})...`);

          let query = supabase
            .from('requests')
            .select('origin, status, created_at, location_id')
            .neq('status', 'canceled')  // Exclude canceled requests
            .range(from, from + batchSize - 1);  // Paginate with range

          if (locationFilter) {
            query = query.eq('location_id', locationFilter);
          }

          const { data, error } = await query;

          if (error) {
            console.error('âŒ Supabase error on batch', batchNumber, ':', error);
            throw error;
          }

          if (data && data.length > 0) {
            allData = allData.concat(data);
            console.log(`âœ… Batch ${batchNumber}: Loaded ${data.length} records. Total so far: ${allData.length}`);
            from += batchSize;
            hasMore = data.length === batchSize;  // If we got less than batchSize, we're done
            batchNumber++;
          } else {
            hasMore = false;
          }
        }

        console.log(`âœ… Successfully loaded ${allData.length} of ${count || 'unknown'} requests for origin chart`);
        if (allData.length < count) {
          console.warn(`âš ï¸ WARNING: Only loaded ${allData.length} out of ${count} requests!`);
        } else {
          console.log(`ðŸŽ‰ SUCCESS: All ${allData.length} requests loaded for origin analysis!`);
        }

        // ðŸ” DEBUG: Analyze origin values distribution
        console.log('ðŸ” DEBUG: Analyzing origin values in loaded requests...');
        const originDebug = {};
        let nullCount = 0;
        allData.forEach(req => {
          if (req.origin) {
            const origin = req.origin.trim();
            originDebug[origin] = (originDebug[origin] || 0) + 1;
          } else {
            nullCount++;
          }
        });
        console.log('ðŸ” Origin value distribution:', originDebug);
        console.log('ðŸ” Requests with NULL/empty origin:', nullCount);
        console.log('ðŸ” If most are NULL, check: 1) requests table schema, 2) data migration, 3) Webflow form field mapping');

        // If no data, log warning but don't throw error
        if (!allData || allData.length === 0) {
          console.warn('âš ï¸ No requests found in database');
          return [];
        }

        return allData;
      } catch (err) {
        console.error('âŒ Requests data load failed:', err);
        console.error('âŒ Error details:', {
          message: err.message,
          code: err.code,
          details: err.details
        });
        // Don't use alert() - just log and return empty array
        return [];
      }
    }

    // Load ALL requests data (including canceled) for count display
    async function loadAllRequestsData(locationFilter = null) {
      try {
        console.log('ðŸ“Š Loading ALL requests data for count...');
        console.log('ðŸ“Š Location filter:', locationFilter || 'None');

        // First, count total requests
        const { count, error: countError } = await supabase
          .from('requests')
          .select('*', { count: 'exact', head: true });

        console.log('ðŸ“Š Total requests in table:', count);
        if (countError) {
          console.error('âŒ Count error:', countError);
        }

        // PAGINATED LOADING: Load ALL requests in batches of 1000
        console.log('ðŸš¨ ALL REQUESTS COUNT QUERY VERSION: 2025-11-13-v7 PAGINATED - loading ALL records in batches');
        console.log('â³ Processing all requests for count display using pagination...');

        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;
        let batchNumber = 1;

        while (hasMore) {
          console.log(`ðŸ“¦ Loading all requests batch ${batchNumber} (records ${from} to ${from + batchSize - 1})...`);

          let query = supabase
            .from('requests')
            .select('id, status, created_at, location_id')
            .range(from, from + batchSize - 1);  // Paginate with range

          if (locationFilter && locationFilter !== '' && locationFilter !== 'null') {
            query = query.eq('location_id', locationFilter);
          }

          const { data, error } = await query;

          if (error) {
            console.error('âŒ Supabase error on batch', batchNumber, ':', error);
            throw error;
          }

          if (data && data.length > 0) {
            allData = allData.concat(data);
            console.log(`âœ… Batch ${batchNumber}: Loaded ${data.length} records. Total so far: ${allData.length}`);
            from += batchSize;
            hasMore = data.length === batchSize;  // If we got less than batchSize, we're done
            batchNumber++;
          } else {
            hasMore = false;
          }
        }

        console.log(`âœ… Successfully loaded ${allData.length} of ${count || 'unknown'} total requests (including canceled)`);
        if (allData.length < count) {
          console.warn(`âš ï¸ WARNING: Only loaded ${allData.length} out of ${count} total requests!`);
        } else {
          console.log(`ðŸŽ‰ SUCCESS: All ${allData.length} requests loaded for count display!`);
        }

        if (!allData || allData.length === 0) {
          console.warn('âš ï¸ No requests found in database');
          return [];
        }

        return allData;
      } catch (err) {
        console.error('âŒ All requests data load failed:', err);
        return [];
      }
    }

    // Render Pie Chart for Booking Origins
    async function renderOriginsPieChart(data) {
      console.log('ðŸ“Š Rendering origins pie chart with', data.length, 'requests');

      // Mapping from database values to chart categories
      const originMapping = {
        // Booking form variations
        'Contactform': 'booking_form',
        'contactform': 'booking_form',
        'booking_form': 'booking_form',
        'Booking Form': 'booking_form',
        'Booking form': 'booking_form',

        // WhatsApp variations
        'WhatsApp': 'whatsapp',
        'whatsapp': 'whatsapp',
        'Whatsapp': 'whatsapp',

        // Instagram variations
        'Instagram': 'instagram',
        'instagram': 'instagram',

        // Facebook variations
        'Facebook': 'facebook',
        'facebook': 'facebook',

        // Email variations
        'Email': 'email',
        'email': 'email',
        'E-Mail': 'email',
        'E-mail': 'email',

        // Phone variations
        'Phone': 'phone',
        'phone': 'phone',
        'Telefon': 'phone',

        // Walk-In variations
        'Walk-In': 'walk_in',
        'walk_in': 'walk_in',
        'Walk In': 'walk_in',
        'Walk in': 'walk_in',

        // Self-Booking variations
        'Self-Booking': 'self_booking',
        'self_booking': 'self_booking',
        'Self Booking': 'self_booking'
      };

      // Count origins
      const originCounts = {
        'booking_form': 0,
        'whatsapp': 0,
        'instagram': 0,
        'facebook': 0,
        'phone': 0,
        'email': 0,
        'walk_in': 0,
        'self_booking': 0
      };

      // Track unknown origins for debugging
      const unknownOrigins = new Set();

      data.forEach(req => {
        // Trim whitespace and handle null/undefined
        const rawOrigin = req.origin?.trim();

        if (rawOrigin && rawOrigin !== '') {
          // Map the database value to a chart category
          const mappedOrigin = originMapping[rawOrigin];

          if (mappedOrigin) {
            originCounts[mappedOrigin]++;
          } else {
            // Unknown origin value - log for debugging
            unknownOrigins.add(rawOrigin);
          }
        }
        // Note: Requests without origin value are not counted
      });

      console.log('ðŸ“Š Origin counts:', originCounts);
      console.log('ðŸ“Š Total requests processed:', data.length);
      console.log('ðŸ“Š Requests WITH origin:', data.filter(r => r.origin?.trim()).length);
      console.log('ðŸ“Š Requests WITHOUT origin:', data.filter(r => !r.origin?.trim()).length);
      if (unknownOrigins.size > 0) {
        console.warn('âš ï¸ Unknown origin values found:', Array.from(unknownOrigins));
        console.warn('âš ï¸ Add these to originMapping if they should be tracked');
      }

      // Labels and colors (order must match originCounts)
      const labels = [
        'Booking form',
        'Whatsapp',
        'Instagram',
        'Facebook',
        'Phone',
        'E-mail',
        'Walk-in',
        'Self-Booking'
      ];

      const colors = [
        '#0071e3', // Accent (Booking Form)
        '#25D366', // WhatsApp Green
        '#E1306C', // Instagram Pink
        '#1877F2', // Facebook Blue
        '#34C759', // Phone Green (iOS)
        '#EA4335', // Email Red
        '#7B1FA2', // Walk-In Purple
        '#00897B'  // Self-Booking Teal
      ];

      // Filter out categories with 0 count for cleaner chart
      const chartLabels = [];
      const chartData = [];
      const chartColors = [];

      labels.forEach((label, index) => {
        const key = Object.keys(originCounts)[index];
        const count = originCounts[key];
        // Always show all categories, even with 0 count
        chartLabels.push(label);
        chartData.push(count);
        chartColors.push(colors[index]);
      });

      const chartDataConfig = {
        labels: chartLabels,
        datasets: [{
          data: chartData,
          backgroundColor: chartColors,
          borderWidth: 2,
          borderColor: '#fff'
        }]
      };

      // Destroy existing chart
      if (originsPieChart) {
        originsPieChart.destroy();
      }

      const ctx = document.getElementById('bookingOriginsPie');
      if (!ctx) {
        console.error('âŒ Canvas element not found: bookingOriginsPie');
        return;
      }

      originsPieChart = new Chart(ctx.getContext('2d'), {
        type: 'pie',
        data: chartDataConfig,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                padding: 12,
                font: {
                  size: 12,
                  family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      console.log('âœ… Pie chart rendered successfully');
      console.log(`ðŸ“Š Total requests in chart: ${data.length}`);
      console.log(`ðŸ“Š Displayed categories: ${chartLabels.length} (excluding empty)`);
    }

    // Render Requests Count Display
    async function renderRequestsCount(data) {
      console.log('ðŸ“Š Rendering requests count with', data.length, 'requests');

      const countElement = document.getElementById('requestsCount');
      if (!countElement) {
        console.error('âŒ Count element not found: requestsCount');
        return;
      }

      // Animate the count
      const targetCount = data.length;
      let currentCount = 0;
      const duration = 1000; // 1 second
      const steps = 30;
      const increment = targetCount / steps;
      const stepDuration = duration / steps;

      const counter = setInterval(() => {
        currentCount += increment;
        if (currentCount >= targetCount) {
          countElement.textContent = targetCount.toLocaleString('de-DE');
          clearInterval(counter);
        } else {
          countElement.textContent = Math.floor(currentCount).toLocaleString('de-DE');
        }
      }, stepDuration);

      console.log('âœ… Requests count rendered successfully');
    }

    // Render Appointments Count Display
    async function renderAppointmentsCount(data) {
      console.log('ðŸ“Š Rendering appointments count with', data.length, 'appointments');

      const countElement = document.getElementById('appointmentsCount');
      if (!countElement) {
        console.error('âŒ Count element not found: appointmentsCount');
        return;
      }

      // Animate the count
      const targetCount = data.length;
      let currentCount = 0;
      const duration = 1000; // 1 second
      const steps = 30;
      const increment = targetCount / steps;
      const stepDuration = duration / steps;

      const counter = setInterval(() => {
        currentCount += increment;
        if (currentCount >= targetCount) {
          countElement.textContent = targetCount.toLocaleString('de-DE');
          clearInterval(counter);
        } else {
          countElement.textContent = Math.floor(currentCount).toLocaleString('de-DE');
        }
      }, stepDuration);

      console.log('âœ… Appointments count rendered successfully');
    }

    // ========================================
    // DATE RANGE FILTER FUNCTIONS
    // ========================================

    // Get date range from filter
    function getDateRange() {
      const rangeFilter = document.getElementById('analyticsDateRangeFilter')?.value || 'all';
      const startDateInput = document.getElementById('analyticsStartDate')?.value;
      const endDateInput = document.getElementById('analyticsEndDate')?.value;

      const now = new Date();
      let startDate = null;
      let endDate = null;

      // If custom dates are set, use them
      if (startDateInput && endDateInput) {
        startDate = new Date(startDateInput);
        endDate = new Date(endDateInput);
        endDate.setHours(23, 59, 59, 999); // End of day
        console.log('ðŸ“… Using custom date range:', startDate, 'to', endDate);
        return { startDate, endDate };
      }

      // Otherwise use predefined ranges
      switch (rangeFilter) {
        case 'today':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
          break;
        case 'week':
          const dayOfWeek = now.getDay();
          const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday as first day
          startDate = new Date(now);
          startDate.setDate(now.getDate() - diff);
          startDate.setHours(0, 0, 0, 0);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'quarter':
          const currentQuarter = Math.floor(now.getMonth() / 3);
          startDate = new Date(now.getFullYear(), currentQuarter * 3, 1);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'year':
          startDate = new Date(now.getFullYear(), 0, 1);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'last30':
          startDate = new Date(now);
          startDate.setDate(now.getDate() - 30);
          startDate.setHours(0, 0, 0, 0);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'last90':
          startDate = new Date(now);
          startDate.setDate(now.getDate() - 90);
          startDate.setHours(0, 0, 0, 0);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'last365':
          startDate = new Date(now);
          startDate.setDate(now.getDate() - 365);
          startDate.setHours(0, 0, 0, 0);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'all':
        default:
          startDate = null;
          endDate = null;
          break;
      }

      if (startDate && endDate) {
        console.log('ðŸ“… Date range:', rangeFilter, '-', startDate.toLocaleDateString('de-DE'), 'to', endDate.toLocaleDateString('de-DE'));
      } else {
        console.log('ðŸ“… Date range: All time');
      }

      return { startDate, endDate };
    }

    // Filter data by date range
    function filterByDateRange(data, dateField = 'created_at') {
      const { startDate, endDate } = getDateRange();

      if (!startDate || !endDate) {
        return data; // No filter, return all data
      }

      return data.filter(item => {
        const itemDate = new Date(item[dateField]);
        if (isNaN(itemDate.getTime())) return false;
        return itemDate >= startDate && itemDate <= endDate;
      });
    }

    // Filter projects by revenue time range (separate from global filter)
    function filterProjectsByRevenueDateRange(projects, rangeType) {
      // Use cachedProjects if projects parameter is not provided or invalid
      const projectsToFilter = projects || cachedProjects;

      // Check if projects are loaded
      if (!projectsToFilter || projectsToFilter.length === 0) {
        console.warn('âš ï¸ No projects loaded yet for filtering');
        return [];
      }

      const now = new Date();
      let startDate = null;

      switch(rangeType) {
        case 'week': {
          // Start of current week (Monday)
          const day = now.getDay();
          const diff = now.getDate() - day + (day === 0 ? -6 : 1);
          startDate = new Date(now.getFullYear(), now.getMonth(), diff);
          startDate.setHours(0, 0, 0, 0);
          break;
        }
        case 'month': {
          // Start of current month
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          startDate.setHours(0, 0, 0, 0);
          break;
        }
        case 'year': {
          // Start of current year
          startDate = new Date(now.getFullYear(), 0, 1);
          startDate.setHours(0, 0, 0, 0);
          break;
        }
        case 'all':
        default:
          // No filtering, return all projects
          return projectsToFilter;
      }

      // Filter projects by created_at date
      return projectsToFilter.filter(project => {
        if (!project.created_at) return false;
        const projectDate = new Date(project.created_at);
        return projectDate >= startDate;
      });
    }

    // Filter requests/appointments by time range
    function filterByTimeRange(data, rangeType) {
      const now = new Date();
      let startDate = null;

      switch(rangeType) {
        case 'week': {
          // Start of current week (Monday)
          const day = now.getDay();
          const diff = now.getDate() - day + (day === 0 ? -6 : 1);
          startDate = new Date(now.getFullYear(), now.getMonth(), diff);
          startDate.setHours(0, 0, 0, 0);
          break;
        }
        case 'month': {
          // Start of current month
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          startDate.setHours(0, 0, 0, 0);
          break;
        }
        case 'year': {
          // Start of current year
          startDate = new Date(now.getFullYear(), 0, 1);
          startDate.setHours(0, 0, 0, 0);
          break;
        }
        case 'all':
        default:
          // No filtering, return all data
          return data;
      }

      // Filter by created_at date
      return data.filter(item => {
        if (!item.created_at) return false;
        const itemDate = new Date(item.created_at);
        return itemDate >= startDate;
      });
    }

    // ========================================
    // REVENUE ANALYTICS FUNCTIONS
    // ========================================

    // Global variable to cache projects for filtering
    let cachedProjects = [];

    // Load projects data for revenue analytics
    async function loadProjectsData(locationFilter = null) {
      console.log('ðŸ“Š Loading projects data...');

      try {
        // Load ALL projects with pagination
        let allProjects = [];
        let start = 0;
        const batchSize = 1000;

        while (true) {
          let query = supabase
            .from('projects')
            .select(`
              id,
              project_number,
              customer_email,
              state,
              price,
              payment_state,
              created_at,
              updated_at,
              location:locations(name)
            `)
            .order('created_at', { ascending: false })
            .range(start, start + batchSize - 1);

          if (locationFilter && locationFilter !== 'all' && locationFilter !== null) {
            query = query.eq('location_id', locationFilter);
          }

          const { data, error } = await query;

          if (error) throw error;
          if (!data || data.length === 0) break;

          allProjects = allProjects.concat(data);
          console.log(`  â†³ Loaded ${allProjects.length} projects so far...`);

          if (data.length < batchSize) break;
          start += batchSize;
        }

        console.log(`âœ… Loaded ${allProjects.length} total projects`);

        // IMPORTANT: Store in global variable for filtering
        cachedProjects = allProjects;

        // Count by state
        const stateCounts = {
          'Aktiv': 0,
          'Unbekannt': 0,
          'Offen': 0,
          'other': 0
        };

        let totalRevenue = 0;
        let projectsWithPrice = 0;

        allProjects.forEach(project => {
          // Count by state
          if (stateCounts.hasOwnProperty(project.state)) {
            stateCounts[project.state]++;
          } else {
            stateCounts['other']++;
          }

          // Sum revenue
          if (project.price && project.price > 0) {
            totalRevenue += parseFloat(project.price);
            projectsWithPrice++;
          }
        });

        console.log('ðŸ“Š Project counts by state:', stateCounts);
        console.log('ðŸ’° Total revenue:', totalRevenue.toFixed(2), 'â‚¬');

        // Render projects table (optional)
        renderProjectsTable(allProjects, stateCounts, totalRevenue, projectsWithPrice);

        // Return data for other functions to use
        return allProjects;

      } catch (error) {
        console.error('âŒ Error loading projects:', error);
        return [];
      }
    }

    function renderProjectsTable(projects, stateCounts, totalRevenue, projectsWithPrice) {
      const container = document.getElementById('projectsTableContainer');

      if (!container) {
        // Container doesn't exist - this is OK, projects table is optional
        console.log('â„¹ï¸ Projects table container not found (optional feature)');
        return;
      }

      const total = projects.length;
      const avgRevenue = projectsWithPrice > 0 ? (totalRevenue / projectsWithPrice).toFixed(2) : 0;

      container.innerHTML = `
        <div style="margin-bottom: 24px;">
          <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 600;">
            Projects Overview
          </h3>
          <p style="margin: 0; font-size: 14px; color: #86868b;">
            ${total.toLocaleString('de-DE')} Total Projects
          </p>
        </div>

        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div style="background: #f5f5f7; padding: 20px; border-radius: 12px;">
            <div style="font-size: 13px; color: #86868b; margin-bottom: 4px;">Total Projects</div>
            <div style="font-size: 32px; font-weight: 700; color: #1d1d1f;">${total.toLocaleString('de-DE')}</div>
          </div>

          <div style="background: #f5f5f7; padding: 20px; border-radius: 12px;">
            <div style="font-size: 13px; color: #86868b; margin-bottom: 4px;">Total Revenue</div>
            <div style="font-size: 32px; font-weight: 700; color: #34C759;">${totalRevenue.toLocaleString('de-DE', {minimumFractionDigits: 2})} â‚¬</div>
          </div>

          <div style="background: #f5f5f7; padding: 20px; border-radius: 12px;">
            <div style="font-size: 13px; color: #86868b; margin-bottom: 4px;">Avg Revenue</div>
            <div style="font-size: 32px; font-weight: 700; color: #007AFF;">${avgRevenue.toLocaleString('de-DE')} â‚¬</div>
          </div>

          <div style="background: #f5f5f7; padding: 20px; border-radius: 12px;">
            <div style="font-size: 13px; color: #86868b; margin-bottom: 4px;">Active Projects</div>
            <div style="font-size: 32px; font-weight: 700; color: #FF9500;">${stateCounts['Aktiv'].toLocaleString('de-DE')}</div>
          </div>
        </div>

        <!-- Status Breakdown -->
        <div style="margin-bottom: 24px;">
          <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Project Status Breakdown</h4>

          <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
              <span>Aktiv</span>
              <span style="font-weight: 600;">${stateCounts['Aktiv'].toLocaleString('de-DE')} (${((stateCounts['Aktiv']/total)*100).toFixed(1)}%)</span>
            </div>
            <div style="height: 8px; background: #e5e5e7; border-radius: 4px; overflow: hidden;">
              <div style="height: 100%; background: #34C759; width: ${(stateCounts['Aktiv']/total)*100}%;"></div>
            </div>
          </div>

          <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
              <span>Unbekannt</span>
              <span style="font-weight: 600;">${stateCounts['Unbekannt'].toLocaleString('de-DE')} (${((stateCounts['Unbekannt']/total)*100).toFixed(1)}%)</span>
            </div>
            <div style="height: 8px; background: #e5e5e7; border-radius: 4px; overflow: hidden;">
              <div style="height: 100%; background: #8E8E93; width: ${(stateCounts['Unbekannt']/total)*100}%;"></div>
            </div>
          </div>

          <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
              <span>Offen</span>
              <span style="font-weight: 600;">${stateCounts['Offen'].toLocaleString('de-DE')} (${((stateCounts['Offen']/total)*100).toFixed(1)}%)</span>
            </div>
            <div style="height: 8px; background: #e5e5e7; border-radius: 4px; overflow: hidden;">
              <div style="height: 100%; background: #FFA500; width: ${(stateCounts['Offen']/total)*100}%;"></div>
            </div>
          </div>
        </div>
      `;
    }

    // Render Revenue Statistics
    async function renderRevenueStats(projects) {
      console.log('ðŸ’° Rendering revenue statistics with', projects.length, 'projects');

      // Initialize stats
      const stats = {
        'Komplett bezahlt': { count: 0, revenue: 0 },
        'Offen': { count: 0, revenue: 0 },
        'Anzahlung bezahlt': { count: 0, revenue: 0 },
        'Unbekannt': { count: 0, revenue: 0 }
      };

      // Process each project
      projects.forEach(project => {
        const price = parseFloat(project.price) || 0;
        const paymentState = (project.payment_state || '').trim();

        // Determine category
        let category = 'Unbekannt';

        const stateLower = paymentState.toLowerCase();

        if (stateLower.includes('komplett bezahlt') || stateLower === 'komplett bezahlt') {
          category = 'Komplett bezahlt';
        } else if (stateLower.includes('anzahlung bezahlt') || stateLower === 'anzahlung bezahlt') {
          category = 'Anzahlung bezahlt';
        } else if (stateLower.includes('offen') || stateLower === 'offen') {
          category = 'Offen';
        }

        if (stats[category]) {
          stats[category].count++;
          stats[category].revenue += price;
        }
      });

      // Calculate GESAMT UMSATZ (only "Komplett bezahlt")
      const gesamtUmsatz = stats['Komplett bezahlt'].revenue;
      const totalCount = Object.values(stats).reduce((sum, s) => sum + s.count, 0);

      console.log('ðŸ’° Revenue breakdown:', {
        'Komplett bezahlt': `${stats['Komplett bezahlt'].revenue.toFixed(2)} â‚¬ (${stats['Komplett bezahlt'].count} projects)`,
        'Anzahlung bezahlt': `${stats['Anzahlung bezahlt'].revenue.toFixed(2)} â‚¬ (${stats['Anzahlung bezahlt'].count} projects)`,
        'Offen': `${stats['Offen'].revenue.toFixed(2)} â‚¬ (${stats['Offen'].count} projects)`,
        'Unbekannt': `${stats['Unbekannt'].revenue.toFixed(2)} â‚¬ (${stats['Unbekannt'].count} projects)`
      });
      console.log(`ðŸ’° GESAMT UMSATZ (nur Komplett bezahlt): ${gesamtUmsatz.toFixed(2)} â‚¬`);

      // Update DOM - Main totalRevenue shows GESAMT UMSATZ
      const totalRevenueEl = document.getElementById('totalRevenue');
      if (totalRevenueEl) {
        totalRevenueEl.textContent = gesamtUmsatz.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }

      // Update DOM - Paid Projects shows "Komplett bezahlt"
      const paidProjectsEl = document.getElementById('paidProjects');
      if (paidProjectsEl) {
        paidProjectsEl.textContent = stats['Komplett bezahlt'].count;
      }

      // Update DOM - Pending Revenue shows "Offen"
      const pendingRevenueEl = document.getElementById('pendingRevenue');
      if (pendingRevenueEl) {
        pendingRevenueEl.textContent = stats['Offen'].revenue.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }

      // Update DOM - Average Price
      const avgProjectPriceEl = document.getElementById('avgProjectPrice');
      if (avgProjectPriceEl && totalCount > 0) {
        const totalRevenue = Object.values(stats).reduce((sum, s) => sum + s.revenue, 0);
        const avgPrice = totalRevenue / totalCount;
        avgProjectPriceEl.textContent = avgPrice.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }

      // Update DOM - Total Projects
      const totalProjectsEl = document.getElementById('totalProjects');
      if (totalProjectsEl) {
        totalProjectsEl.textContent = totalCount;
      }

      // Update additional elements if they exist
      const vollbezahltAmount = document.getElementById('vollbezahltAmount');
      const vollbezahltCount = document.getElementById('vollbezahltCount');
      if (vollbezahltAmount) {
        vollbezahltAmount.textContent = stats['Komplett bezahlt'].revenue.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }
      if (vollbezahltCount) {
        vollbezahltCount.textContent = stats['Komplett bezahlt'].count + ' Projekte';
      }

      const offenAmount = document.getElementById('offenAmount');
      const offenCount = document.getElementById('offenCount');
      if (offenAmount) {
        offenAmount.textContent = stats['Offen'].revenue.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }
      if (offenCount) {
        offenCount.textContent = stats['Offen'].count + ' Projekte';
      }

      const anzahlungAmount = document.getElementById('anzahlungAmount');
      const anzahlungCount = document.getElementById('anzahlungCount');
      if (anzahlungAmount) {
        anzahlungAmount.textContent = stats['Anzahlung bezahlt'].revenue.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }
      if (anzahlungCount) {
        anzahlungCount.textContent = stats['Anzahlung bezahlt'].count + ' Projekte';
      }

      const gesamtUmsatzElement = document.getElementById('gesamtUmsatz');
      if (gesamtUmsatzElement) {
        gesamtUmsatzElement.textContent = gesamtUmsatz.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }

      // Update table rows if they exist
      updateRevenueTable(stats, gesamtUmsatz);

      console.log('âœ… Revenue stats rendered successfully');
    }

    // Helper function to update the revenue table
    function updateRevenueTable(stats, gesamtUmsatz) {
      // Find table rows and update them
      const rows = document.querySelectorAll('[data-payment-status]');

      rows.forEach(row => {
        const status = row.getAttribute('data-payment-status');

        if (stats[status]) {
          const countCell = row.querySelector('.count-cell');
          const revenueCell = row.querySelector('.revenue-cell');
          const avgCell = row.querySelector('.avg-cell');
          const percentCell = row.querySelector('.percent-cell');

          if (countCell) countCell.textContent = stats[status].count;
          if (revenueCell) {
            revenueCell.textContent = stats[status].revenue.toLocaleString('de-DE', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            }) + ' â‚¬';
          }
          if (avgCell && stats[status].count > 0) {
            const avg = stats[status].revenue / stats[status].count;
            avgCell.textContent = avg.toLocaleString('de-DE', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            }) + ' â‚¬';
          }
          if (percentCell && gesamtUmsatz > 0) {
            const percent = (stats[status].revenue / gesamtUmsatz * 100).toFixed(1);
            percentCell.textContent = percent + ' %';
          }
        }
      });

      // Update GESAMT row
      const gesamtRow = document.querySelector('[data-payment-status="Gesamt"]');
      if (gesamtRow) {
        const totalCount = Object.values(stats).reduce((sum, s) => sum + s.count, 0);
        const totalRevenue = Object.values(stats).reduce((sum, s) => sum + s.revenue, 0);

        const countCell = gesamtRow.querySelector('.count-cell');
        const revenueCell = gesamtRow.querySelector('.revenue-cell');
        const avgCell = gesamtRow.querySelector('.avg-cell');
        const percentCell = gesamtRow.querySelector('.percent-cell');

        if (countCell) countCell.textContent = totalCount;
        if (revenueCell) {
          revenueCell.textContent = totalRevenue.toLocaleString('de-DE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }) + ' â‚¬';
        }
        if (avgCell && totalCount > 0) {
          const avg = totalRevenue / totalCount;
          avgCell.textContent = avg.toLocaleString('de-DE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }) + ' â‚¬';
        }
        if (percentCell) {
          percentCell.textContent = '100 %';
        }
      }
    }

    // Render Revenue Timeline Chart
    async function renderRevenueTimeline(data) {
      console.log('ðŸ’° Rendering revenue timeline with', data.length, 'projects');

      if (data.length === 0) {
        console.warn('âš ï¸ No data for revenue timeline');
        return;
      }

      // Group by month
      const monthlyRevenue = {};

      data.forEach(project => {
        const date = new Date(project.created_at);
        if (isNaN(date.getTime())) return;

        const key = date.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
        const price = parseFloat(project.price) || 0;

        if (!monthlyRevenue[key]) {
          monthlyRevenue[key] = { total: 0, count: 0 };
        }

        monthlyRevenue[key].total += price;
        monthlyRevenue[key].count += 1;
      });

      // Sort by date
      const sortedKeys = Object.keys(monthlyRevenue).sort((a, b) => {
        return new Date(a) - new Date(b);
      });

      // Take last 12 months
      const last12Months = sortedKeys.slice(-12);

      const chartData = {
        labels: last12Months,
        datasets: [{
          label: 'Umsatz (â‚¬)',
          data: last12Months.map(key => monthlyRevenue[key].total),
          borderColor: '#0071e3',
          backgroundColor: 'rgba(0, 113, 227, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: '#0071e3',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointHoverRadius: 6
        }]
      };

      // Destroy existing chart
      if (revenueTimelineChart) {
        revenueTimelineChart.destroy();
      }

      const ctx = document.getElementById('revenueTimeline');
      if (!ctx) {
        console.error('âŒ Canvas element not found: revenueTimeline');
        return;
      }

      revenueTimelineChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  const key = context.label;
                  const count = monthlyRevenue[key]?.count || 0;
                  return [
                    `Umsatz: â‚¬${value.toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`,
                    `Projekte: ${count}`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'â‚¬' + value.toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                },
                font: {
                  size: 11,
                  family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
                }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });

      console.log('âœ… Revenue timeline chart rendered successfully');
    }

    // Group appointments data by time range (uses created_at)
    function groupDataByTimeRange(data, range) {
      const now = new Date();
      const groups = {};

      console.log('ðŸ“… Grouping', data.length, 'appointments by range:', range);
      console.log('ðŸ“… Current date:', now.toLocaleDateString('de-DE'));

      // DEBUG counters
      let validDates = 0;
      let invalidDates = 0;
      let outOfRange = 0;

      data.forEach((appointment, index) => {
        // Use created_at to track when bookings were made
        const date = new Date(appointment.created_at);

        // Check if date is valid
        if (isNaN(date.getTime())) {
          invalidDates++;
          if (index < 5) {
            console.warn('âš ï¸ Invalid date found:', appointment.created_at);
          }
          return;
        }

        validDates++;
        let key;

        switch(range) {
          case 'weekly':
            // Last 12 weeks (84 days)
            if (date >= new Date(now - 12 * 7 * 24 * 60 * 60 * 1000)) {
              key = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            } else {
              outOfRange++;
            }
            break;

          case 'monthly':
            // Last 12 months (365 days)
            if (date >= new Date(now - 365 * 24 * 60 * 60 * 1000)) {
              key = date.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
            } else {
              outOfRange++;
            }
            break;

          case 'yearly':
            // Last 3 years (1095 days), grouped by month
            if (date >= new Date(now - 3 * 365 * 24 * 60 * 60 * 1000)) {
              key = date.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
            } else {
              outOfRange++;
            }
            break;

          case 'all':
            // All time, grouped by month
            key = date.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
            break;
        }

        if (key) {
          groups[key] = (groups[key] || 0) + 1;
        }
      });

      console.log('ðŸ“Š Grouping stats:', {
        validDates,
        invalidDates,
        outOfRange,
        groupsCreated: Object.keys(groups).length
      });

      // Sort keys chronologically
      const sortedKeys = Object.keys(groups).sort((a, b) => {
        const parseDate = (str) => {
          if (str.includes('.')) {
            // Format: "09.11"
            const [day, month] = str.split('.');
            return new Date(now.getFullYear(), parseInt(month) - 1, parseInt(day));
          } else {
            // Format: "Nov 2025"
            return new Date(str);
          }
        };
        return parseDate(a) - parseDate(b);
      });

      console.log('âœ… Grouped into', sortedKeys.length, 'time buckets');

      // DEBUG: Show first few groups
      if (sortedKeys.length > 0) {
        const sampleGroups = sortedKeys.slice(0, 5).map(k => `${k}: ${groups[k]}`);
        console.log('ðŸ“Š Sample groups:', sampleGroups);
        console.log('ðŸ“Š Total appointments in groups:', sortedKeys.reduce((sum, k) => sum + groups[k], 0));
      }

      return {
        labels: sortedKeys,
        values: sortedKeys.map(k => groups[k])
      };
    }

    // Render Line Chart for Bookings Timeline
    async function renderBookingsTimeline(data, timeRange = 'weekly') {
      console.log('ðŸ“Š Rendering timeline chart for range:', timeRange);

      currentTimeRange = timeRange;

      // Group data by time range
      const groupedData = groupDataByTimeRange(data, timeRange);

      console.log('ðŸ“ˆ Timeline data points:', groupedData.labels.length);

      const chartData = {
        labels: groupedData.labels,
        datasets: [{
          label: 'Bookings',
          data: groupedData.values,
          borderColor: '#0071e3',
          backgroundColor: 'rgba(0,113,227,0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6,
          pointBackgroundColor: '#0071e3',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        }]
      };

      // Destroy existing chart
      if (timelineChart) {
        timelineChart.destroy();
      }

      const ctx = document.getElementById('bookingsTimeline');
      if (!ctx) {
        console.error('âŒ Canvas element not found: bookingsTimeline');
        return;
      }

      timelineChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(29,29,31,0.95)',
              padding: 12,
              cornerRadius: 8,
              titleFont: {
                size: 13,
                weight: '600'
              },
              bodyFont: {
                size: 12
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                font: {
                  size: 11
                }
              },
              grid: {
                color: 'rgba(0,0,0,0.06)'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11
                },
                maxRotation: 45,
                minRotation: 0
              },
              grid: {
                display: false
              }
            }
          }
        }
      });

      console.log('âœ… Timeline chart rendered successfully');
    }

    // Test Supabase connection and tables
    async function testSupabaseConnection() {
      console.log('ðŸ§ª Testing Supabase connection...');

      try {
        // Test 1: Check requests table
        console.log('ðŸ§ª Test 1: Checking requests table...');
        const { data: testRequests, error: reqError } = await supabase
          .from('requests')
          .select('id')
          .limit(1);

        if (reqError) {
          console.error('âŒ Requests table error:', reqError);
        } else {
          console.log('âœ… Requests table accessible:', testRequests?.length || 0, 'records');
        }

        // Test 2: Check appointments table
        console.log('ðŸ§ª Test 2: Checking appointments table...');
        const { data: testAppointments, error: aptError } = await supabase
          .from('appointments')
          .select('id')
          .limit(1);

        if (aptError) {
          console.error('âŒ Appointments table error:', aptError);
        } else {
          console.log('âœ… Appointments table accessible:', testAppointments?.length || 0, 'records');
        }

        // Test 3: Count total records
        console.log('ðŸ§ª Test 3: Counting total records...');
        const { count: reqCount } = await supabase
          .from('requests')
          .select('*', { count: 'exact', head: true });

        const { count: aptCount } = await supabase
          .from('appointments')
          .select('*', { count: 'exact', head: true });

        console.log('ðŸ“Š Total requests:', reqCount || 0);
        console.log('ðŸ“Š Total appointments:', aptCount || 0);

        // Test 4: Analyze appointment status distribution (if table not empty)
        if (aptCount > 0) {
          console.log('ðŸ§ª Test 4: Analyzing appointment status distribution...');
          const { data: statusSample } = await supabase
            .from('appointments')
            .select('status')
            .limit(1000); // Sample first 1000

          if (statusSample && statusSample.length > 0) {
            const statusCounts = {};
            statusSample.forEach(apt => {
              const status = apt.status || 'null';
              statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            console.log('ðŸ“Š Status distribution (sample of', statusSample.length, 'appointments):', statusCounts);
            console.log('ðŸ“Š Available statuses:', Object.keys(statusCounts).join(', '));

            // Check if we have the expected statuses
            const hasScheduled = statusCounts['scheduled'] || statusCounts['Scheduled'];
            const hasFinished = statusCounts['finished'] || statusCounts['Finished'] || statusCounts['completed'];

            if (!hasScheduled && !hasFinished) {
              console.warn('âš ï¸ WARNING: No appointments with status "scheduled" or "finished" found!');
              console.warn('âš ï¸ Timeline will use ALL appointments regardless of status');
            }
          }
        } else {
          console.warn('âš ï¸ Appointments table is empty - Timeline will show no data');
        }

        return true;
      } catch (err) {
        console.error('âŒ Supabase connection test failed:', err);
        return false;
      }
    }

    // ============================================
    // LOAD ANALYTICS - COMPLETE DATA
    // ============================================
    async function loadAnalytics() {
      console.log('ðŸ“Š Loading Analytics Page...');
      console.log('ðŸ“Š ANALYTICS VERSION: 2025-11-15 - Complete Fix');

      try {
        // Show progress bar
        ProgressBar.show('Starting to load analytics data...');

        // Show loading state
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          analyticsContent.innerHTML = '<div style="text-align:center; padding:40px;"><div class="spinner"></div><p>Loading analytics data...</p></div>';
        }

        ProgressBar.updateProgress(10, 'Loading requests...');

        // Load ALL requests (no pagination limit)
        console.log('ðŸ“¥ Loading all requests for analytics...');
        let allRequests = [];
        let page = 0;
        const pageSize = 1000;
        let hasMore = true;

        while (hasMore) {
          const { data: requestsBatch, error: reqError } = await supabase
            .from('requests')
            .select('*')
            .order('created_at', { ascending: false })
            .range(page * pageSize, (page + 1) * pageSize - 1);

          if (reqError) {
            console.error('Error loading requests batch:', reqError);
            break;
          }

          if (requestsBatch && requestsBatch.length > 0) {
            allRequests = [...allRequests, ...requestsBatch];
            // Update progress during request loading (10% to 35%)
            const requestProgress = 10 + (25 * Math.min(page / 10, 1));
            ProgressBar.updateProgress(requestProgress, `Loading requests (${allRequests.length} loaded)...`);

            if (page % 5 === 0) { // Log every 5 batches
              console.log(`  â†³ Loaded ${allRequests.length} requests so far...`);
            }

            if (requestsBatch.length < pageSize) {
              hasMore = false;
            } else {
              page++;
            }
          } else {
            hasMore = false;
          }
        }

        console.log(`âœ… Loaded ${allRequests.length} total requests`);
        ProgressBar.updateProgress(40, `Loaded ${allRequests.length} requests. Loading appointments...`);

        // Load ALL appointments (no pagination limit)
        console.log('ðŸ“¥ Loading all appointments for analytics...');
        let allAppointments = [];
        page = 0;
        hasMore = true;

        while (hasMore) {
          const { data: appointmentsBatch, error: aptError } = await supabase
            .from('appointments')
            .select('*')
            .order('created_at', { ascending: false })
            .range(page * pageSize, (page + 1) * pageSize - 1);

          if (aptError) {
            console.error('Error loading appointments batch:', aptError);
            break;
          }

          if (appointmentsBatch && appointmentsBatch.length > 0) {
            allAppointments = [...allAppointments, ...appointmentsBatch];
            // Update progress during appointment loading (40% to 65%)
            const appointmentProgress = 40 + (25 * Math.min(page / 10, 1));
            ProgressBar.updateProgress(appointmentProgress, `Loading appointments (${allAppointments.length} loaded)...`);

            if (page % 5 === 0) { // Log every 5 batches
              console.log(`  â†³ Loaded ${allAppointments.length} appointments so far...`);
            }

            if (appointmentsBatch.length < pageSize) {
              hasMore = false;
            } else {
              page++;
            }
          } else {
            hasMore = false;
          }
        }

        console.log(`âœ… Loaded ${allAppointments.length} total appointments`);
        ProgressBar.updateProgress(70, 'Calculating analytics...');

        // Calculate analytics data
        console.log('ðŸ“Š Calculating analytics...');

        // Request status breakdown
        const requestStatusCounts = {
          archived: 0,
          finished: 0,
          open_request: 0,
          scheduled: 0,
          canceled: 0,
          pending: 0
        };

        allRequests.forEach(req => {
          const status = req.status || 'unknown';
          if (requestStatusCounts.hasOwnProperty(status)) {
            requestStatusCounts[status]++;
          } else {
            requestStatusCounts[status] = 1;
          }
        });

        // Appointment status breakdown
        const appointmentStatusCounts = {
          finished: 0,
          scheduled: 0,
          no_show: 0,
          rescheduled: 0,
          canceled: 0,
          unknown: 0
        };

        allAppointments.forEach(apt => {
          const status = apt.status || 'unknown';
          if (appointmentStatusCounts.hasOwnProperty(status)) {
            appointmentStatusCounts[status]++;
          } else {
            appointmentStatusCounts[status] = 1;
          }
        });

        // Filter by current time range (from analytics page filter)
        const timeRangeFilter = document.getElementById('analyticsTimeRange')?.value || 'all';
        const locationFilter = document.getElementById('analyticsLocationFilter')?.value || '';

        let filteredRequests = allRequests;
        let filteredAppointments = allAppointments;

        // Apply location filter
        if (locationFilter && locationFilter !== '') {
          filteredRequests = filteredRequests.filter(req => req.location_id === locationFilter);
          filteredAppointments = filteredAppointments.filter(apt => apt.location_id === locationFilter);
        }

        // Apply time range filter
        if (timeRangeFilter !== 'all') {
          const now = new Date();
          let startDate = null;

          switch(timeRangeFilter) {
            case 'week':
              const day = now.getDay();
              const diff = now.getDate() - day + (day === 0 ? -6 : 1);
              startDate = new Date(now.getFullYear(), now.getMonth(), diff);
              startDate.setHours(0, 0, 0, 0);
              break;
            case 'month':
              startDate = new Date(now.getFullYear(), now.getMonth(), 1);
              startDate.setHours(0, 0, 0, 0);
              break;
            case 'year':
              startDate = new Date(now.getFullYear(), 0, 1);
              startDate.setHours(0, 0, 0, 0);
              break;
          }

          if (startDate) {
            filteredRequests = filteredRequests.filter(req => {
              const reqDate = new Date(req.created_at);
              return reqDate >= startDate;
            });

            filteredAppointments = filteredAppointments.filter(apt => {
              const aptDate = new Date(apt.created_at);
              return aptDate >= startDate;
            });
          }
        }

        // Calculate project metrics
        ProgressBar.updateProgress(75, 'Calculating metrics...');
        const projectMetrics = window.calculateProjectMetrics(allRequests, allAppointments);

        // Render analytics sections
        ProgressBar.updateProgress(80, 'Rendering charts...');
        console.log('ðŸŽ¨ Rendering analytics sections...');

        renderRequestsOverview(filteredRequests, filteredAppointments);
        ProgressBar.updateProgress(85, 'Rendering status breakdowns...');
        renderRequestStatusBreakdown(allRequests, requestStatusCounts);
        renderAppointmentStatusBreakdown(allAppointments, appointmentStatusCounts);
        ProgressBar.updateProgress(90, 'Rendering revenue data...');
        renderRevenueOverview(allRequests, allAppointments);
        renderRevenueTimeline(allRequests);
        ProgressBar.updateProgress(95, 'Finalizing charts...');
        renderAppointmentsByArtist(allAppointments);
        renderRevenueByPaymentStatus(allRequests);
        renderProjectAnalytics(projectMetrics);
        renderArtistPerformance(allAppointments);
        renderVIPCustomers(allRequests);

        console.log('âœ… Analytics page loaded successfully');
        ProgressBar.hide();

      } catch (error) {
        console.error('âŒ Error loading analytics:', error);
        ProgressBar.hide();
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          analyticsContent.innerHTML = `
            <div style="text-align:center; padding:40px;">
              <p style="color:var(--error); font-size:18px; margin-bottom:10px;">âš ï¸ Error Loading Analytics</p>
              <p style="color:var(--muted); font-size:14px;">${error.message}</p>
              <button onclick="loadAnalytics()" style="margin-top:20px; padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">
                Retry
              </button>
            </div>
          `;
        }
      }
    }

    // ============================================
    // RENDER REQUESTS OVERVIEW
    // ============================================
    function renderRequestsOverview(requests, appointments) {
      const totalRequests = requests.length;
      const customerRequests = requests.filter(r =>
        r.booking_type !== 'internal' && r.booking_type !== 'reserved'
      ).length;
      const totalAppointments = appointments.length;
      const scheduledAppointments = appointments.filter(a => a.status === 'scheduled').length;

      const overviewHTML = `
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:30px;">
          <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Total Requests</div>
            <div style="font-size:32px; font-weight:600; color:var(--primary);">${totalRequests.toLocaleString()}</div>
          </div>
          <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Customer Requests</div>
            <div style="font-size:32px; font-weight:600; color:var(--primary);">${customerRequests.toLocaleString()}</div>
          </div>
          <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Total Appointments</div>
            <div style="font-size:32px; font-weight:600; color:var(--success);">${totalAppointments.toLocaleString()}</div>
          </div>
          <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Scheduled Appointments</div>
            <div style="font-size:32px; font-weight:600; color:var(--success);">${scheduledAppointments.toLocaleString()}</div>
          </div>
        </div>
      `;

      // Find or create overview container
      let container = document.getElementById('requestsOverviewContainer');
      if (!container) {
        // Insert at the top of analytics content
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'requestsOverviewContainer';
          analyticsContent.insertBefore(container, analyticsContent.firstChild);
        }
      }

      if (container) {
        container.innerHTML = overviewHTML;
      }
    }

    // ============================================
    // RENDER REQUEST STATUS BREAKDOWN
    // ============================================
    function renderRequestStatusBreakdown(requests, statusCounts) {
      const total = requests.length;

      const breakdownHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">Request Status Breakdown</h3>
          <p style="color:var(--muted); margin-bottom:20px;">${total.toLocaleString()} Total Requests</p>

          <!-- Pie Chart -->
          <div style="position: relative; width: 300px; max-width: 100%; height: 300px; margin: 0 auto 30px;">
            <canvas id="analyticsRequestStatusPieCanvas" width="300" height="300"></canvas>
          </div>

          <!-- Bullet Point List -->
          <div style="display:flex; flex-direction:column; gap:12px;">
            ${Object.entries(statusCounts).map(([status, count]) => {
              const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
              const color = getStatusColor(status);
              return `
                <div style="display:flex; align-items:center; gap:12px;">
                  <div style="width:12px; height:12px; border-radius:50%; background:${color};"></div>
                  <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                      <span style="font-weight:500; text-transform:capitalize;">${formatStatusName(status)}: ${count.toLocaleString()}</span>
                      <span style="color:var(--muted);">(${percentage}%)</span>
                    </div>
                    <div style="height:8px; background:#f0f0f0; border-radius:4px; overflow:hidden;">
                      <div style="height:100%; background:${color}; width:${percentage}%;"></div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      let container = document.getElementById('requestStatusBreakdownContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'requestStatusBreakdownContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = breakdownHTML;

        // Create pie chart after DOM is updated
        requestAnimationFrame(() => {
          const canvas = document.getElementById('analyticsRequestStatusPieCanvas');
          if (!canvas) {
            console.error('âŒ Analytics request status pie canvas not found');
            return;
          }

          // Prepare data for chart
          const chartData = Object.entries(statusCounts)
            .filter(([_, count]) => count > 0)
            .map(([status, count]) => ({
              label: formatStatusName(status),
              count: count,
              color: getStatusColor(status)
            }))
            .sort((a, b) => b.count - a.count);

          console.log('âœ… Creating analytics request status pie chart with', chartData.length, 'segments');

          try {
            new Chart(canvas, {
              type: 'pie',
              data: {
                labels: chartData.map(d => d.label),
                datasets: [{
                  data: chartData.map(d => d.count),
                  backgroundColor: chartData.map(d => d.color),
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${label}: ${value.toLocaleString('de-DE')} (${percentage}%)`;
                      }
                    }
                  }
                }
              }
            });
            console.log('âœ… Analytics request status pie chart created successfully');
          } catch (error) {
            console.error('âŒ Error creating analytics request status pie chart:', error);
          }
        });
      }
    }

    // ============================================
    // RENDER APPOINTMENT STATUS BREAKDOWN
    // ============================================
    function renderAppointmentStatusBreakdown(appointments, statusCounts) {
      const total = appointments.length;

      const breakdownHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">Appointment Status Breakdown</h3>
          <p style="color:var(--muted); margin-bottom:20px;">${total.toLocaleString()} Total Appointments</p>

          <!-- Pie Chart -->
          <div style="position: relative; width: 300px; max-width: 100%; height: 300px; margin: 0 auto 30px;">
            <canvas id="analyticsAppointmentStatusPieCanvas" width="300" height="300"></canvas>
          </div>

          <!-- Bullet Point List -->
          <div style="display:flex; flex-direction:column; gap:12px;">
            ${Object.entries(statusCounts).map(([status, count]) => {
              const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
              const color = getStatusColor(status);
              return `
                <div style="display:flex; align-items:center; gap:12px;">
                  <div style="width:12px; height:12px; border-radius:50%; background:${color};"></div>
                  <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                      <span style="font-weight:500; text-transform:capitalize;">${formatStatusName(status)}: ${count.toLocaleString()}</span>
                      <span style="color:var(--muted);">(${percentage}%)</span>
                    </div>
                    <div style="height:8px; background:#f0f0f0; border-radius:4px; overflow:hidden;">
                      <div style="height:100%; background:${color}; width:${percentage}%;"></div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      let container = document.getElementById('appointmentStatusBreakdownContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'appointmentStatusBreakdownContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = breakdownHTML;

        // Create pie chart after DOM is updated
        requestAnimationFrame(() => {
          const canvas = document.getElementById('analyticsAppointmentStatusPieCanvas');
          if (!canvas) {
            console.error('âŒ Analytics appointment status pie canvas not found');
            return;
          }

          // Prepare data for chart
          const chartData = Object.entries(statusCounts)
            .filter(([_, count]) => count > 0)
            .map(([status, count]) => ({
              label: formatStatusName(status),
              count: count,
              color: getStatusColor(status)
            }))
            .sort((a, b) => b.count - a.count);

          console.log('âœ… Creating analytics appointment status pie chart with', chartData.length, 'segments');

          try {
            new Chart(canvas, {
              type: 'pie',
              data: {
                labels: chartData.map(d => d.label),
                datasets: [{
                  data: chartData.map(d => d.count),
                  backgroundColor: chartData.map(d => d.color),
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${label}: ${value.toLocaleString('de-DE')} (${percentage}%)`;
                      }
                    }
                  }
                }
              }
            });
            console.log('âœ… Analytics appointment status pie chart created successfully');
          } catch (error) {
            console.error('âŒ Error creating analytics appointment status pie chart:', error);
          }
        });
      }
    }

    // ============================================
    // RENDER REVENUE OVERVIEW
    // ============================================
    function renderRevenueOverview(requests, appointments) {
      // Calculate revenue from requests
      const requestsWithPrice = requests.filter(r => r.total_amount && r.payment_status === 'fully_paid');
      const requestRevenue = requestsWithPrice.reduce((sum, r) => sum + (parseFloat(r.total_amount) || 0), 0);

      // Calculate revenue from appointments
      const appointmentsWithPrice = appointments.filter(a => a.price && a.payment_status === 'fully_paid');
      const appointmentRevenue = appointmentsWithPrice.reduce((sum, a) => sum + (parseFloat(a.price) || 0), 0);

      const totalRevenue = requestRevenue + appointmentRevenue;
      const paidProjects = requestsWithPrice.length + appointmentsWithPrice.length;

      const overviewHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">Umsatz-Ãœbersicht</h3>

          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Gesamtumsatz</div>
              <div style="font-size:28px; font-weight:600; color:var(--success);">
                â‚¬${totalRevenue.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
              </div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Bezahlte Projekte</div>
              <div style="font-size:28px; font-weight:600; color:var(--primary);">
                ${paidProjects.toLocaleString()}
              </div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Ausstehend</div>
              <div style="font-size:28px; font-weight:600; color:var(--warning);">
                â‚¬${(0).toLocaleString('de-DE', { minimumFractionDigits: 2 })}
              </div>
            </div>
          </div>
        </div>
      `;

      let container = document.getElementById('revenueOverviewContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'revenueOverviewContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = overviewHTML;
      }
    }

    // ============================================
    // RENDER APPOINTMENTS BY ARTIST
    // ============================================
    function renderAppointmentsByArtist(appointments) {
      // Group by artist
      const artistMap = new Map();

      appointments.forEach(apt => {
        if (!apt.artist_id) return;

        const artistName = apt.artist_name || 'Unknown Artist';
        if (!artistMap.has(artistName)) {
          artistMap.set(artistName, {
            name: artistName,
            total: 0,
            finished: 0,
            scheduled: 0,
            noShow: 0
          });
        }

        const artist = artistMap.get(artistName);
        artist.total++;
        if (apt.status === 'finished') artist.finished++;
        if (apt.status === 'scheduled') artist.scheduled++;
        if (apt.status === 'no_show') artist.noShow++;
      });

      const artists = Array.from(artistMap.values())
        .sort((a, b) => b.total - a.total)
        .slice(0, 10); // Top 10

      const appointmentsHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">Appointments nach Resident Artist</h3>

          <div style="display:flex; gap:30px; margin-bottom:20px;">
            <div>
              <div style="font-size:14px; color:var(--muted);">Total Appointments</div>
              <div style="font-size:24px; font-weight:600;">${appointments.length.toLocaleString()}</div>
            </div>
            <div>
              <div style="font-size:14px; color:var(--muted);">Ungesetzte Termine</div>
              <div style="font-size:24px; font-weight:600;">
                ${appointments.filter(a => !a.artist_id).length.toLocaleString()}
                <span style="font-size:14px; color:var(--muted);">
                  (${appointments.length > 0 ? ((appointments.filter(a => !a.artist_id).length / appointments.length) * 100).toFixed(0) : 0}%)
                </span>
              </div>
            </div>
            <div>
              <div style="font-size:14px; color:var(--muted);">Nicht umgesetzt</div>
              <div style="font-size:24px; font-weight:600;">0 <span style="font-size:14px; color:var(--muted);">(0%)</span></div>
            </div>
            <div>
              <div style="font-size:14px; color:var(--muted);">Belegbar</div>
              <div style="font-size:24px; font-weight:600;">0 <span style="font-size:14px; color:var(--muted);">(0%)</span></div>
            </div>
          </div>

          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:2px solid #e0e0e0;">
                <th style="text-align:left; padding:12px 8px; font-weight:600;">Artist</th>
                <th style="text-align:right; padding:12px 8px; font-weight:600;">Total</th>
                <th style="text-align:right; padding:12px 8px; font-weight:600;">Finished</th>
                <th style="text-align:right; padding:12px 8px; font-weight:600;">Scheduled</th>
                <th style="text-align:right; padding:12px 8px; font-weight:600;">No Show</th>
              </tr>
            </thead>
            <tbody>
              ${artists.map(artist => `
                <tr style="border-bottom:1px solid #f0f0f0;">
                  <td style="padding:12px 8px;">${artist.name}</td>
                  <td style="text-align:right; padding:12px 8px; font-weight:600;">${artist.total}</td>
                  <td style="text-align:right; padding:12px 8px;">${artist.finished}</td>
                  <td style="text-align:right; padding:12px 8px;">${artist.scheduled}</td>
                  <td style="text-align:right; padding:12px 8px;">${artist.noShow}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      let container = document.getElementById('appointmentsByArtistContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'appointmentsByArtistContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = appointmentsHTML;
      }
    }

    // ============================================
    // RENDER REVENUE BY PAYMENT STATUS
    // ============================================
    function renderRevenueByPaymentStatus(requests) {
      const paymentGroups = {
        'Komplett bezahlt': { count: 0, revenue: 0 },
        'Offen': { count: 0, revenue: 0 },
        'Anzahlung bezahlt': { count: 0, revenue: 0 }
      };

      requests.forEach(req => {
        if (!req.total_amount) return;

        const amount = parseFloat(req.total_amount) || 0;

        if (req.payment_status === 'fully_paid') {
          paymentGroups['Komplett bezahlt'].count++;
          paymentGroups['Komplett bezahlt'].revenue += amount;
        } else if (req.payment_status === 'deposit_paid') {
          paymentGroups['Anzahlung bezahlt'].count++;
          paymentGroups['Anzahlung bezahlt'].revenue += amount;
        } else {
          paymentGroups['Offen'].count++;
          paymentGroups['Offen'].revenue += amount;
        }
      });

      const total = Object.values(paymentGroups).reduce((sum, g) => sum + g.revenue, 0);

      const paymentHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">Umsatz nach Zahlungsstatus</h3>

          <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; margin-bottom:20px;">
            ${Object.entries(paymentGroups).map(([status, data]) => {
              const bgColor = status === 'Komplett bezahlt' ? '#d4edda' :
                             status === 'Anzahlung bezahlt' ? '#fff3cd' : '#f8d7da';
              return `
                <div style="text-align:center; padding:20px; background:${bgColor}; border-radius:8px;">
                  <div style="font-size:14px; margin-bottom:8px;">ðŸ’° ${status}</div>
                  <div style="font-size:24px; font-weight:600; margin-bottom:4px;">
                    â‚¬${data.revenue.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </div>
                  <div style="font-size:12px; color:var(--muted);">${data.count} Projekte</div>
                </div>
              `;
            }).join('')}
          </div>

          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:2px solid #e0e0e0;">
                <th style="text-align:left; padding:12px 8px;">PAYMENT STATUS</th>
                <th style="text-align:right; padding:12px 8px;">ANZAHL PROJEKTE</th>
                <th style="text-align:right; padding:12px 8px;">GESAMT UMSATZ</th>
                <th style="text-align:right; padding:12px 8px;">DURCHSCHNITT</th>
                <th style="text-align:right; padding:12px 8px;">% VOM GESAMT</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(paymentGroups).map(([status, data]) => {
                const avg = data.count > 0 ? data.revenue / data.count : 0;
                const percentage = total > 0 ? (data.revenue / total) * 100 : 0;
                return `
                  <tr style="border-bottom:1px solid #f0f0f0;">
                    <td style="padding:12px 8px; font-weight:500;">${status}</td>
                    <td style="text-align:right; padding:12px 8px;">${data.count}</td>
                    <td style="text-align:right; padding:12px 8px;">â‚¬${data.revenue.toLocaleString('de-DE', { minimumFractionDigits: 2 })}</td>
                    <td style="text-align:right; padding:12px 8px;">â‚¬${avg.toLocaleString('de-DE', { minimumFractionDigits: 2 })}</td>
                    <td style="text-align:right; padding:12px 8px;">${percentage.toFixed(0)}%</td>
                  </tr>
                `;
              }).join('')}
              <tr style="border-top:2px solid #e0e0e0; font-weight:600;">
                <td style="padding:12px 8px;">Gesamt</td>
                <td style="text-align:right; padding:12px 8px;">
                  ${Object.values(paymentGroups).reduce((sum, g) => sum + g.count, 0)}
                </td>
                <td style="text-align:right; padding:12px 8px;">
                  â‚¬${total.toLocaleString('de-DE', { minimumFractionDigits: 2 })}
                </td>
                <td style="text-align:right; padding:12px 8px;">
                  â‚¬${(total / Object.values(paymentGroups).reduce((sum, g) => sum + g.count, 0)).toLocaleString('de-DE', { minimumFractionDigits: 2 })}
                </td>
                <td style="text-align:right; padding:12px 8px;">100%</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;

      let container = document.getElementById('revenueByPaymentStatusContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'revenueByPaymentStatusContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = paymentHTML;
      }
    }

    // ============================================
    // RENDER PROJECT ANALYTICS
    // ============================================
    function renderProjectAnalytics(metrics) {
      const analyticsHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">ðŸ“Š Project Analytics</h3>

          <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:16px;">
            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Total Projects</div>
              <div style="font-size:28px; font-weight:600;">${metrics.total_projects.toLocaleString()}</div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Active Projects</div>
              <div style="font-size:28px; font-weight:600; color:var(--warning);">${metrics.active_projects.toLocaleString()}</div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Finished Projects</div>
              <div style="font-size:28px; font-weight:600; color:var(--success);">${metrics.finished_projects.toLocaleString()}</div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Total Revenue</div>
              <div style="font-size:24px; font-weight:600; color:var(--success);">
                â‚¬${metrics.total_revenue.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
              </div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Avg Project Value</div>
              <div style="font-size:24px; font-weight:600;">
                â‚¬${metrics.avg_project_value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
              </div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Avg Appointments/Project</div>
              <div style="font-size:24px; font-weight:600;">${metrics.avg_appointments_per_project.toFixed(1)}</div>
            </div>
          </div>
        </div>
      `;

      let container = document.getElementById('projectAnalyticsContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'projectAnalyticsContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = analyticsHTML;
      }
    }

    // ============================================
    // RENDER ARTIST PERFORMANCE
    // ============================================
    function renderArtistPerformance(appointments) {
      const performanceHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">ðŸŽ¨ Artist Performance</h3>
          <div style="height:200px; display:flex; align-items:center; justify-content:center; background:#f8f9fa; border-radius:8px;">
            <p style="color:var(--muted);">Detailed artist performance metrics coming soon</p>
          </div>
        </div>
      `;

      let container = document.getElementById('artistPerformanceContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'artistPerformanceContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = performanceHTML;
      }
    }

    // ============================================
    // RENDER VIP CUSTOMERS
    // ============================================
    function renderVIPCustomers(requests) {
      const vipHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">ðŸ‘¥ VIP Customers (Multi-Project Customers)</h3>
          <div style="height:200px; display:flex; align-items:center; justify-content:center; background:#f8f9fa; border-radius:8px;">
            <p style="color:var(--muted);">VIP customer analysis coming soon</p>
          </div>
        </div>
      `;

      let container = document.getElementById('vipCustomersContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'vipCustomersContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = vipHTML;
      }
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function getStatusColor(status) {
      const colors = {
        'archived': '#9E9E9E',
        'finished': '#4CAF50',
        'open_request': '#FFC107',
        'scheduled': '#2196F3',
        'canceled': '#F44336',
        'pending': '#FF9800',
        'no_show': '#E91E63',
        'rescheduled': '#9C27B0',
        'unknown': '#757575'
      };
      return colors[status] || '#757575';
    }

    function formatStatusName(status) {
      const names = {
        'archived': 'Archived',
        'finished': 'Finished',
        'open_request': 'Open Request',
        'scheduled': 'Scheduled',
        'canceled': 'Canceled',
        'pending': 'Pending',
        'no_show': 'No Show',
        'rescheduled': 'Rescheduled',
        'unknown': 'Unknown'
      };
      return names[status] || status;
    }

    // Initialize analytics with data
    async function initAnalytics() {
      console.log('ðŸŽ¯ Initializing analytics...');

      try {
        // Show progress bar
        ProgressBar.show('Starting to load analytics...');

        // Test Supabase connection first
        ProgressBar.updateProgress(5, 'Testing connection...');
        await testSupabaseConnection();

        // Load location filter dropdown
        ProgressBar.updateProgress(10, 'Loading filters...');
        await loadAnalyticsLocationFilter();

        // Load and render initial charts
        const locationFilter = document.getElementById('analyticsLocationFilter')?.value || null;

        // Load requests data for Origin Chart
        ProgressBar.updateProgress(20, 'Loading requests data...');
        requestsData = await loadRequestsData(locationFilter);
        const filteredRequests = filterByDateRange(requestsData, 'created_at');
        await renderOriginsPieChart(filteredRequests);

        // Load ALL requests data for Count Display (including canceled)
        ProgressBar.updateProgress(30, 'Loading all requests data...');
        allRequestsData = await loadAllRequestsData(locationFilter);
        const filteredAllRequestsForCount = filterByDateRange(allRequestsData, 'created_at');
        await renderRequestsCount(filteredAllRequestsForCount);

        // Load appointments data for Timeline Chart
        ProgressBar.updateProgress(40, 'Loading appointments data...');
        appointmentsData = await loadAppointmentsData(locationFilter);
        const filteredAppointments = filterByDateRange(appointmentsData, 'created_at');
        await renderBookingsTimeline(filteredAppointments, 'monthly');
        await renderAppointmentsCount(filteredAppointments);

        // Load projects data for Revenue Analytics
        ProgressBar.updateProgress(50, 'Loading projects data...');
        projectsData = await loadProjectsData(locationFilter);
        const filteredProjects = filterByDateRange(projectsData, 'created_at');
        await renderRevenueStats(filteredProjects);
        await renderRevenueTimeline(filteredProjects);

        // Load NEW analytics components
        ProgressBar.updateProgress(60, 'Rendering status breakdowns...');
        await loadRequestStatus(filteredRequests);
        await loadArtistDistribution(filteredAppointments);
        await loadRevenueByPaymentStatus();

        // Load Project-Based Analytics (moved from Dashboard)
        ProgressBar.updateProgress(70, 'Loading project analytics...');
        await loadProjectAnalytics();

        // Calculate and render Pie Charts for Request and Appointment Status
        ProgressBar.updateProgress(80, 'Rendering pie charts...');

        // Calculate request status counts
        const requestStatusCounts = {
          archived: 0,
          finished: 0,
          open_request: 0,
          scheduled: 0,
          canceled: 0,
          pending: 0
        };

        allRequestsData.forEach(req => {
          const status = req.status || 'unknown';
          if (requestStatusCounts.hasOwnProperty(status)) {
            requestStatusCounts[status]++;
          } else {
            requestStatusCounts[status] = 1;
          }
        });

        // Calculate appointment status counts
        const appointmentStatusCounts = {
          finished: 0,
          scheduled: 0,
          no_show: 0,
          rescheduled: 0,
          canceled: 0,
          reserved: 0,
          unknown: 0
        };

        appointmentsData.forEach(apt => {
          const status = apt.status || 'unknown';
          if (appointmentStatusCounts.hasOwnProperty(status)) {
            appointmentStatusCounts[status]++;
          } else {
            appointmentStatusCounts[status] = 1;
          }
        });

        // Render pie charts
        ProgressBar.updateProgress(90, 'Finalizing charts...');
        renderRequestStatusBreakdown(allRequestsData, requestStatusCounts);
        renderAppointmentStatusBreakdown(appointmentsData, appointmentStatusCounts);

        console.log('âœ… Analytics initialized');
        ProgressBar.hide();

      } catch (error) {
        console.error('âŒ Error initializing analytics:', error);
        ProgressBar.hide();
      }
    }

    // ============================================
    // PROJECT-BASED ANALYTICS (for Analytics Tab)
    // ============================================
    async function loadProjectAnalytics() {
      console.log('ðŸ“ˆ Loading Project-Based Analytics...');

      try {
        // Fetch all appointments with full project info
        const { data: appointments, error } = await supabase
          .from('appointments')
          .select(`
            id,
            project_number,
            customer_id,
            artist_id,
            status,
            start,
            payment_status,
            payment_amount,
            deposit_amount,
            total_amount,
            first_name,
            last_name
          `)
          .not('project_number', 'is', null)
          .not('customer_id', 'is', null);

        if (error) throw error;

        console.log('ðŸ“¦ Loaded', appointments?.length || 0, 'appointments for project analytics');

        // Calculate metrics
        const metrics = window.calculateProjectMetrics(appointments || []);

        // Update Analytics KPI cards
        const analyticsKpiContainer = document.getElementById('analyticsProjectKPIs');
        if (analyticsKpiContainer) {
          analyticsKpiContainer.innerHTML = `
            <div class="kpi-card">
              <div class="kpi-icon">ðŸ“¦</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.totalProjects.toLocaleString()}</div>
                <div class="kpi-label">Total Projects</div>
              </div>
            </div>

            <div class="kpi-card active">
              <div class="kpi-icon">ðŸ”„</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.activeProjects.toLocaleString()}</div>
                <div class="kpi-label">Active Projects</div>
              </div>
            </div>

            <div class="kpi-card completed">
              <div class="kpi-icon">âœ…</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.completedProjects.toLocaleString()}</div>
                <div class="kpi-label">Completed Projects</div>
              </div>
            </div>

            <div class="kpi-card revenue">
              <div class="kpi-icon">ðŸ’°</div>
              <div class="kpi-content">
                <div class="kpi-value">â‚¬${metrics.totalRevenue.toLocaleString('de-DE', { maximumFractionDigits: 0 })}</div>
                <div class="kpi-label">Total Revenue</div>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon">ðŸ“Š</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.avgAppointmentsPerProject.toFixed(1)}</div>
                <div class="kpi-label">Avg Sessions/Project</div>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon">âœ¨</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.completionRate.toFixed(1)}%</div>
                <div class="kpi-label">Completion Rate</div>
              </div>
            </div>
          `;
        }

        // Load charts
        loadProjectsTimelineChart(appointments || []);
        loadRevenueByMonthChart(appointments || []);
        loadTopArtistsChart(appointments || []);

        // Load tables
        await loadArtistPerformanceReport();
        await loadMultiProjectCustomerReport();

      } catch (error) {
        console.error('Error loading project analytics:', error);
      }
    }

    // NEW ANALYTICS FUNCTIONS

    // German number formatting utilities
    function formatCurrency(amount) {
      return new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount || 0);
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('de-DE').format(num || 0);
    }

    // Load Request Status (DEPRECATED - now handled by Dashboard charts)
    async function loadRequestStatus(requests) {
      // This function is deprecated. Request status is now shown in the Dashboard
      // with updateRequestStatusBreakdown() as a pie chart in Analytics tab.
      console.log('â„¹ï¸ loadRequestStatus called (deprecated, request status shown in Analytics tab)');
      return;
    }

    // Load Artist Distribution (appointments by resident artists only)
    async function loadArtistDistribution(appointments) {
      try {
        console.log('ðŸŽ¨ Loading artist distribution from appointments...');

        // Load ALL appointments with artist data (with pagination)
        let appointmentsWithArtist = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;

        while (hasMore) {
          const { data: batch, error } = await supabase
            .from('appointments')
            .select(`
              id,
              artist_id,
              artist_email,
              status,
              artists!appointments_artist_id_fkey (
                id,
                email,
                is_guest,
                name
              )
            `)
            .not('artist_id', 'is', null)
            .range(from, from + batchSize - 1);

          if (error) {
            console.error('âŒ Error loading appointments with artists:', error);
            throw error;
          }

          if (batch && batch.length > 0) {
            appointmentsWithArtist = appointmentsWithArtist.concat(batch);
            from += batchSize;
            hasMore = batch.length === batchSize;
            console.log(`  â†³ Loaded ${appointmentsWithArtist.length} appointments with artists so far...`);
          } else {
            hasMore = false;
          }
        }

        console.log(`ðŸŽ¨ Loaded ${appointmentsWithArtist?.length || 0} total appointments with artists`);

        // Filter for resident artists only (is_guest = false)
        const residentAppointments = appointmentsWithArtist?.filter(apt =>
          apt.artists && !apt.artists.is_guest
        ) || [];

        console.log(`ðŸŽ¨ Filtered to ${residentAppointments.length} resident artist appointments`);

        // Aggregate by artist
        const artistCounts = {};
        let completedCount = 0;
        let anyCount = 0;

        residentAppointments.forEach(apt => {
          const artistName = apt.artists?.name || apt.artist_email?.split('@')[0] || 'Unknown';
          artistCounts[artistName] = (artistCounts[artistName] || 0) + 1;

          if (apt.status === 'finished') {
            completedCount++;
          }

          if (!apt.artist_email && !apt.artist_id) {
            anyCount++;
          }
        });

        const total = residentAppointments.length;
        const notCompleted = total - completedCount;

        // Group small artists (< 10 appointments)
        const threshold = 10;
        const filteredArtists = {};
        let otherCount = 0;

        Object.entries(artistCounts).forEach(([name, count]) => {
          if (count >= threshold) {
            filteredArtists[name.charAt(0).toUpperCase() + name.slice(1)] = count;
          } else {
            otherCount += count;
          }
        });

        if (otherCount > 0) {
          filteredArtists['Sonstige (< 10 Appointments)'] = otherCount;
        }

        console.log('ðŸŽ¨ Artist counts:', artistCounts);
        console.log('ðŸŽ¨ Filtered artists (>= 10):', filteredArtists);

        // Sort by count
        const sorted = Object.entries(filteredArtists).sort((a, b) => b[1] - a[1]);
        const labels = sorted.map(([name]) => name);
        const values = sorted.map(([, count]) => count);

        // Render chart
        const ctx = document.getElementById('artistDistributionChart');
        if (!ctx) return;

        if (artistDistributionChartInstance) {
          artistDistributionChartInstance.destroy();
        }

        const chartColors = [
          '#34c759', '#9c27b0', '#e91e63', '#0071e3', '#ff9500',
          '#5856d6', '#ff2d55', '#30b0c7', '#ff6482', '#64d2ff'
        ];

        artistDistributionChartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: values,
              backgroundColor: chartColors.slice(0, labels.length),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '60%',
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  font: {
                    family: '-apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif',
                    size: 11
                  },
                  padding: 10,
                  usePointStyle: true
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });

        // Update stats
        document.getElementById('artistTotalRequests').textContent = formatNumber(total);
        const completedPercent = total > 0 ? (completedCount / total * 100).toFixed(1) : 0;
        document.getElementById('artistCompletedAppointments').textContent =
          `${formatNumber(completedCount)} (${completedPercent} %)`;
        const notCompletedPercent = total > 0 ? (notCompleted / total * 100).toFixed(1) : 0;
        document.getElementById('artistNotCompleted').textContent =
          `${formatNumber(notCompleted)} (${notCompletedPercent} %)`;
        const anyPercent = total > 0 ? (anyCount / total * 100).toFixed(1) : 0;
        document.getElementById('artistAny').textContent =
          `${formatNumber(anyCount)} (${anyPercent} %)`;

      } catch (error) {
        console.error('Error loading artist distribution:', error);
      }
    }

    // Load Revenue by Payment Status (projects.price + payment_state)
    async function loadRevenueByPaymentStatus() {
      console.log('ðŸ’° Loading revenue by payment status...');

      try {
        // Load ALL projects with pagination
        let allProjects = [];
        let start = 0;
        const batchSize = 1000;

        while (true) {
          const { data, error } = await supabase
            .from('projects')
            .select('id, price, payment_state')
            .not('price', 'is', null)
            .range(start, start + batchSize - 1);

          if (error) throw error;
          if (!data || data.length === 0) break;

          allProjects = allProjects.concat(data);
          console.log(`  â†³ Loaded ${allProjects.length} projects with pricing so far...`);

          if (data.length < batchSize) break;
          start += batchSize;
        }

        console.log(`âœ… Loaded ${allProjects.length} total projects with pricing`);

        // Group by payment_state
        const revenueByStatus = {};
        let totalRevenue = 0;

        allProjects.forEach(project => {
          const status = project.payment_state || 'Unbekannt';
          const price = parseFloat(project.price) || 0;

          if (!revenueByStatus[status]) {
            revenueByStatus[status] = {
              count: 0,
              revenue: 0
            };
          }

          revenueByStatus[status].count++;
          revenueByStatus[status].revenue += price;
          totalRevenue += price;
        });

        console.log('ðŸ’° Revenue by payment status:', revenueByStatus);

        // Render chart
        renderRevenueByPaymentStatus(revenueByStatus, totalRevenue);

      } catch (error) {
        console.error('âŒ Error loading revenue by payment status:', error);
      }
    }

    function renderRevenueByPaymentStatus(revenueByStatus, totalRevenue) {
      const container = document.getElementById('revenueByPaymentStatusChart');

      if (!container) {
        console.log('â„¹ï¸ Revenue chart container not found (optional feature)');
        return;
      }

      // Sort by revenue (descending)
      const sortedStatuses = Object.entries(revenueByStatus)
        .sort((a, b) => b[1].revenue - a[1].revenue);

      container.innerHTML = `
        <div style="margin-bottom: 20px;">
          <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600;">
            Revenue by Payment Status
          </h3>
          <p style="margin: 0; font-size: 14px; color: #86868b;">
            Total: ${totalRevenue.toLocaleString('de-DE', {minimumFractionDigits: 2})} â‚¬
          </p>
        </div>

        ${sortedStatuses.map(([status, data]) => {
          const percentage = ((data.revenue / totalRevenue) * 100).toFixed(1);
          const color = getPaymentStatusColor(status);

          return `
            <div style="margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
                <span style="font-weight: 500;">${status}</span>
                <span style="font-weight: 600; color: ${color};">
                  ${data.revenue.toLocaleString('de-DE', {minimumFractionDigits: 2})} â‚¬
                  <span style="color: #86868b;">(${data.count} projects)</span>
                </span>
              </div>
              <div style="height: 32px; background: rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; display: flex; align-items: center; padding: 0 12px;">
                <div style="height: 20px; background: ${color}; border-radius: 4px; width: ${percentage}%; transition: width 0.3s;"></div>
                <span style="margin-left: 12px; font-size: 14px; font-weight: 600;">${percentage}%</span>
              </div>
            </div>
          `;
        }).join('')}
      `;
    }

    function getPaymentStatusColor(status) {
      const colors = {
        'Offen': '#FFA500',      // Orange
        'Bezahlt': '#34C759',    // Green
        'Teilzahlung': '#007AFF', // Blue
        'Unbekannt': '#8E8E93',  // Gray
        'Deposit': '#FF9500'     // Amber
      };
      return colors[status] || '#8E8E93';
    }

    // Load locations for filter dropdown
    async function loadAnalyticsLocationFilter() {
      try {
        const { data: locations, error } = await supabase
          .from('locations')
          .select('id, name')
          .order('name');

        if (error) throw error;

        const filterSelect = document.getElementById('analyticsLocationFilter');
        if (!filterSelect) return;

        filterSelect.innerHTML = '<option value="">All Locations</option>';
        locations.forEach(loc => {
          const option = document.createElement('option');
          option.value = loc.id;
          option.textContent = loc.name;
          filterSelect.appendChild(option);
        });

        console.log('âœ… Analytics location filter loaded with', locations.length, 'locations');
      } catch (err) {
        console.error('âŒ Failed to load locations for analytics filter:', err);
      }
    }

    // Attach event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Login form
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
      }

      // Close modal when clicking outside (only if logged in)
      document.getElementById('loginBackdrop')?.addEventListener('click', (e) => {
        if (e.target.id === 'loginBackdrop') {
          if (currentUser) {
            closeLoginModal();
          }
        }
      });

      // Analytics Tab Click - Initialize charts when Analytics tab is clicked
      const analyticsTab = document.getElementById('tab-analytics');
      if (analyticsTab) {
        analyticsTab.addEventListener('click', async function() {
          console.log('ðŸ“Š Analytics tab clicked');
          // Small delay to ensure section is visible before rendering charts
          setTimeout(async () => {
            await initAnalytics();
          }, 100);
        });
      }

      // Waitlist Tab Click - Initialize waitlist when tab is clicked
      const waitlistTab = document.getElementById('tab-waitlist');
      if (waitlistTab) {
        waitlistTab.addEventListener('click', async function() {
          console.log('ðŸ“‹ Waitlist tab clicked');

          // Hide all sections
          document.querySelectorAll('section').forEach(s => s.classList.remove('active'));

          // Show waitlist section
          const waitlistSection = document.getElementById('waitlist-section');
          if (waitlistSection) {
            waitlistSection.classList.add('active');
          }

          // Update active tab
          document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
          waitlistTab.classList.add('active');

          // Initialize waitlist if not already done
          if (!window.waitlistInitialized) {
            await initWaitlist();
            window.waitlistInitialized = true;
          } else {
            // Refresh data
            await loadWaitlistSlots(currentWaitlistLocation);
          }
        });
      }

      // Location Filter Change
      const analyticsLocationFilter = document.getElementById('analyticsLocationFilter');
      if (analyticsLocationFilter) {
        analyticsLocationFilter.addEventListener('change', async function() {
          const locationId = this.value || null;
          console.log('ðŸ¢ Analytics location filter changed:', locationId || 'All Locations');

          // Reload requests data for Origin Chart
          requestsData = await loadRequestsData(locationId);
          const filteredRequests = filterByDateRange(requestsData, 'created_at');
          await renderOriginsPieChart(filteredRequests);

          // Reload ALL requests data for Count Display (including canceled)
          allRequestsData = await loadAllRequestsData(locationId);
          const filteredAllRequestsForCount = filterByDateRange(allRequestsData, 'created_at');
          await renderRequestsCount(filteredAllRequestsForCount);

          // Reload appointments data for Timeline Chart
          appointmentsData = await loadAppointmentsData(locationId);
          const filteredAppointments = filterByDateRange(appointmentsData, 'created_at');
          await renderBookingsTimeline(filteredAppointments, 'monthly');
          await renderAppointmentsCount(filteredAppointments);

          // Reload projects data for Revenue Analytics
          projectsData = await loadProjectsData(locationId);
          const filteredProjects = filterByDateRange(projectsData, 'created_at');
          await renderRevenueStats(filteredProjects);
          await renderRevenueTimeline(filteredProjects);

          // Reload NEW analytics components
          await loadRequestStatus(filteredRequests);
          await loadArtistDistribution(filteredAppointments);
          await loadRevenueByPaymentStatus();
        });
      }

      // Date Range Filter Change
      const analyticsDateRangeFilter = document.getElementById('analyticsDateRangeFilter');
      if (analyticsDateRangeFilter) {
        analyticsDateRangeFilter.addEventListener('change', async function() {
          console.log('ðŸ“… Date range filter changed:', this.value);

          // Re-render all charts with filtered data
          const filteredRequests = filterByDateRange(requestsData, 'created_at');
          await renderOriginsPieChart(filteredRequests);

          const filteredAllRequests = filterByDateRange(allRequestsData, 'created_at');
          await renderRequestsCount(filteredAllRequests);

          const filteredAppointments = filterByDateRange(appointmentsData, 'created_at');
          await renderBookingsTimeline(filteredAppointments, 'monthly');
          await renderAppointmentsCount(filteredAppointments);

          const filteredProjects = filterByDateRange(projectsData, 'created_at');
          await renderRevenueStats(filteredProjects);
          await renderRevenueTimeline(filteredProjects);

          // Reload NEW analytics components
          await loadRequestStatus(filteredRequests);
          await loadArtistDistribution(filteredAppointments);
          await loadRevenueByPaymentStatus();
        });
      }

      // Custom Date Range Inputs
      const analyticsStartDate = document.getElementById('analyticsStartDate');
      const analyticsEndDate = document.getElementById('analyticsEndDate');

      if (analyticsStartDate && analyticsEndDate) {
        const applyCustomDateRange = async function() {
          const startVal = analyticsStartDate.value;
          const endVal = analyticsEndDate.value;

          if (startVal && endVal) {
            console.log('ðŸ“… Custom date range applied:', startVal, 'to', endVal);

            // Re-render all charts with filtered data
            const filteredRequests = filterByDateRange(requestsData, 'created_at');
            await renderOriginsPieChart(filteredRequests);

            const filteredAllRequests = filterByDateRange(allRequestsData, 'created_at');
            await renderRequestsCount(filteredAllRequests);

            const filteredAppointments = filterByDateRange(appointmentsData, 'created_at');
            await renderBookingsTimeline(filteredAppointments, 'monthly');
            await renderAppointmentsCount(filteredAppointments);

            const filteredProjects = filterByDateRange(projectsData, 'created_at');
            await renderRevenueStats(filteredProjects);
            await renderRevenueTimeline(filteredProjects);

            // Reload NEW analytics components
            await loadRequestStatus(filteredRequests);
            await loadArtistDistribution(filteredAppointments);
            await loadRevenueByPaymentStatus();
          }
        };

        analyticsStartDate.addEventListener('change', applyCustomDateRange);
        analyticsEndDate.addEventListener('change', applyCustomDateRange);
      }

      // ============================================
      // WAITLIST MANAGEMENT
      // ============================================

      let currentWaitlistLocation = 'all';
      let waitlistSlots = [];

      // ============================================
      // Load Waitlist Slots
      // ============================================
      async function loadWaitlistSlots(locationFilter = 'all') {
        console.log('ðŸ“‹ Loading waitlist slots...');

        try {
          // Build query using the VIEW for automatic slot numbering
          let query = supabase
            .from('active_waitlist_slots')
            .select('*')
            .order('date_from', { ascending: true });

          // Apply location filter if not 'all'
          if (locationFilter && locationFilter !== 'all') {
            query = query.eq('location_id', locationFilter);
          }

          const { data, error } = await query;

          if (error) throw error;

          waitlistSlots = data || [];
          console.log(`âœ… Loaded ${waitlistSlots.length} active waitlist slots`);

          // Render slots
          renderWaitlistSlots(waitlistSlots);

          return waitlistSlots;

        } catch (error) {
          console.error('âŒ Error loading waitlist slots:', error);
          showNotification('Failed to load waitlist slots', 'error');
          return [];
        }
      }

      // ============================================
      // Render Waitlist Slots
      // ============================================
      function renderWaitlistSlots(slots) {
        const container = document.getElementById('waitlistSlotsContainer');
        const emptyState = document.getElementById('waitlistEmptyState');

        if (!container) return;

        // Show empty state if no slots
        if (!slots || slots.length === 0) {
          container.innerHTML = '';
          if (emptyState) emptyState.style.display = 'block';
          return;
        }

        // Hide empty state
        if (emptyState) emptyState.style.display = 'none';

        // Render slots
        container.innerHTML = slots.map((slot, index) => {
          const slotNumber = index + 1; // Simple 1-based numbering
          const fromDate = new Date(slot.date_from);
          const toDate = new Date(slot.date_to);
          const today = new Date();

          // Calculate status
          const isActive = fromDate <= today && toDate >= today;
          const isUpcoming = fromDate > today;
          const daysRemaining = Math.ceil((toDate - today) / (1000 * 60 * 60 * 24));
          const daysUntilStart = Math.ceil((fromDate - today) / (1000 * 60 * 60 * 24));

          // Status badge
          let statusBadge = '';
          if (isActive) {
            statusBadge = `<span class="badge" style="background:#34c759; color:white;">ðŸŽ¨ Active (${daysRemaining} days left)</span>`;
          } else if (isUpcoming) {
            statusBadge = `<span class="badge" style="background:#007aff; color:white;">ðŸ“… Starts in ${daysUntilStart} days</span>`;
          }

          return `
            <div class="waitlist-slot-card" data-slot-id="${slot.id}" style="
              background:white;
              border-radius:16px;
              padding:24px;
              margin-bottom:16px;
              box-shadow:0 2px 8px rgba(0,0,0,0.08);
              transition:all 0.2s;
              cursor:pointer;
            ">
              <!-- Slot Header -->
              <div style="display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:16px;">
                <div style="display:flex; align-items:center; gap:16px;">
                  <!-- Slot Number Badge -->
                  <div style="
                    width:48px;
                    height:48px;
                    border-radius:50%;
                    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    color:white;
                    font-size:20px;
                    font-weight:700;
                    flex-shrink:0;
                  ">
                    ${slotNumber}
                  </div>

                  <!-- Artist Info -->
                  <div>
                    <h3 style="margin:0 0 4px 0; font-size:18px; color:#1d1d1f;">
                      ${slot.artist_name || 'Unknown Artist'}
                    </h3>
                    <p style="margin:0; color:var(--muted); font-size:14px;">
                      ${slot.artist_email || ''}
                    </p>
                  </div>
                </div>

                <!-- Actions -->
                <div style="display:flex; gap:8px;">
                  <button
                    class="edit-slot-button"
                    data-slot-id="${slot.id}"
                    style="
                      padding:8px 12px;
                      border:1px solid #e5e5ea;
                      border-radius:8px;
                      background:white;
                      cursor:pointer;
                      color:#007aff;
                      font-size:14px;
                      transition:all 0.2s;
                    "
                    onmouseover="this.style.background='#f5f5f7'"
                    onmouseout="this.style.background='white'"
                  >
                    Edit
                  </button>
                  <button
                    class="delete-slot-button"
                    data-slot-id="${slot.id}"
                    style="
                      padding:8px 12px;
                      border:1px solid #ff3b30;
                      border-radius:8px;
                      background:white;
                      cursor:pointer;
                      color:#ff3b30;
                      font-size:14px;
                      transition:all 0.2s;
                    "
                    onmouseover="this.style.background='#fff5f5'"
                    onmouseout="this.style.background='white'"
                  >
                    Delete
                  </button>
                  <button
                    class="toggle-share-paid-button"
                    data-slot-id="${slot.id}"
                    data-current-status="${slot.share_paid || false}"
                    style="
                      padding:8px 12px;
                      border:1px solid ${slot.share_paid ? '#34c759' : '#ff3b30'};
                      border-radius:8px;
                      background:white;
                      cursor:pointer;
                      color:${slot.share_paid ? '#34c759' : '#ff3b30'};
                      font-size:14px;
                      font-weight:600;
                      transition:all 0.2s;
                    "
                    onmouseover="this.style.background='${slot.share_paid ? '#f0fdf4' : '#fff5f5'}'"
                    onmouseout="this.style.background='white'"
                  >
                    ${slot.share_paid ? 'âœ… Paid' : 'âŒ Unpaid'}
                  </button>
                </div>
              </div>

              <!-- Date Range -->
              <div style="display:flex; gap:24px; margin-bottom:12px;">
                <div style="flex:1;">
                  <div style="color:var(--muted); font-size:12px; margin-bottom:4px;">Start Date</div>
                  <div style="font-weight:600; color:#1d1d1f;">
                    ${fromDate.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' })}
                  </div>
                </div>

                <div style="flex:1;">
                  <div style="color:var(--muted); font-size:12px; margin-bottom:4px;">End Date</div>
                  <div style="font-weight:600; color:#1d1d1f;">
                    ${toDate.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' })}
                  </div>
                </div>

                ${slot.location_name ? `
                  <div style="flex:1;">
                    <div style="color:var(--muted); font-size:12px; margin-bottom:4px;">Location</div>
                    <div style="font-weight:600; color:#1d1d1f;">
                      ${slot.location_name}
                    </div>
                  </div>
                ` : ''}
              </div>

              <!-- Status Badges -->
              <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                ${statusBadge}
                ${slot.share_paid
                  ? '<span class="badge" style="background:#34c759; color:white;">âœ… Share Paid</span>'
                  : '<span class="badge" style="background:#ff3b30; color:white;">âŒ Share Not Paid</span>'
                }
              </div>

              <!-- Notes (if any) -->
              ${slot.notes ? `
                <div style="
                  margin-top:16px;
                  padding:12px;
                  background:#f5f5f7;
                  border-radius:8px;
                  font-size:14px;
                  color:#666;
                ">
                  <strong>Notes:</strong> ${slot.notes}
                </div>
              ` : ''}
            </div>
          `;
        }).join('');

        // Add event listeners
        attachWaitlistEventListeners();
      }

      // ============================================
      // Add New Slot Modal
      // ============================================
      async function openAddSlotModal() {
        // Load all artists and locations for selection
        const [artistsResult, locationsResult] = await Promise.all([
          supabase
            .from('artists')
            .select('id, name, email, is_guest')
            .order('name', { ascending: true }),
          supabase
            .from('locations')
            .select('id, name')
            .order('name', { ascending: true })
        ]);

        if (artistsResult.error) {
          console.error('Error loading artists:', artistsResult.error);
          showNotification('Failed to load artists', 'error');
          return;
        }

        if (locationsResult.error) {
          console.error('Error loading locations:', locationsResult.error);
        }

        const artists = artistsResult.data || [];
        const locations = locationsResult.data || [];

        console.log('ðŸ“ All locations from database:', locations);
        console.log('ðŸ“ Location names:', locations.map(loc => loc.name));

        // Filter locations to only show the 5 specific ones (case-insensitive)
        const allowedLocationNames = [
          "Mommy I'm Sorry",
          "MuttersÃ¶hne",
          "Pardon Paris",
          "Gon",
          "Seventyone"
        ];
        const allowedLocationNamesLower = allowedLocationNames.map(name => name.toLowerCase());
        const filteredLocations = locations.filter(loc =>
          allowedLocationNamesLower.includes(loc.name.toLowerCase())
        );

        console.log('ðŸ“ Filtered locations:', filteredLocations);
        console.log('ðŸ“ Filtered location names:', filteredLocations.map(loc => loc.name));

        const modal = document.createElement('div');
        modal.id = 'addSlotModal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          backdrop-filter: blur(10px);
          z-index: 99999;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        `;

        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            display: flex;
            flex-direction: column;
          ">
            <h2 style="margin: 0 0 24px 0;">Add Guest Artist Slot</h2>

            <form id="addSlotForm" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
              <!-- Artist Search - FIXED POSITION -->
              <div style="margin-bottom: 24px; position: relative; z-index: 1000;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1d1d1f;">
                  Artist *
                </label>
                <input
                  type="text"
                  id="slotArtistSearch"
                  placeholder="Search for an artist..."
                  autocomplete="off"
                  required
                  style="
                    width: 100%;
                    padding: 12px 16px;
                    border: 1px solid #e5e5ea;
                    border-radius: 12px;
                    font-size: 16px;
                    background: white;
                  "
                />
                <input type="hidden" id="slotArtistId" required />
              </div>

              <!-- SCROLLABLE CONTENT -->
              <div style="flex: 1; overflow-y: auto; margin: 0 -32px; padding: 0 32px; position: relative; z-index: 1;">

              <!-- Date Range -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1d1d1f;">
                    Start Date *
                  </label>
                  <input
                    type="date"
                    id="slotDateFrom"
                    required
                    min="${new Date().toISOString().split('T')[0]}"
                    style="
                      width: 100%;
                      padding: 12px 16px;
                      border: 1px solid #e5e5ea;
                      border-radius: 12px;
                      font-size: 16px;
                    "
                  />
                </div>

                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1d1d1f;">
                    End Date *
                  </label>
                  <input
                    type="date"
                    id="slotDateTo"
                    required
                    min="${new Date().toISOString().split('T')[0]}"
                    style="
                      width: 100%;
                      padding: 12px 16px;
                      border: 1px solid #e5e5ea;
                      border-radius: 12px;
                      font-size: 16px;
                    "
                  />
                </div>
              </div>

              <!-- Location -->
              <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1d1d1f;">
                  Location *
                </label>
                <select
                  id="slotLocationSelect"
                  required
                  style="
                    width: 100%;
                    padding: 12px 16px;
                    border: 1px solid #e5e5ea;
                    border-radius: 12px;
                    font-size: 16px;
                    background: white;
                  "
                >
                  <option value="">Select a location...</option>
                  ${filteredLocations.map(loc => `
                    <option value="${loc.id}">${loc.name}</option>
                  `).join('')}
                </select>
              </div>

              <!-- Notes -->
              <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1d1d1f;">
                  Internal Notes (optional)
                </label>
                <textarea
                  id="slotNotes"
                  rows="3"
                  placeholder="Add any internal notes about this slot..."
                  style="
                    width: 100%;
                    padding: 12px 16px;
                    border: 1px solid #e5e5ea;
                    border-radius: 12px;
                    font-size: 16px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    resize: vertical;
                  "
                ></textarea>
              </div>

              <!-- Actions -->
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button
                  type="button"
                  id="cancelSlotButton"
                  style="
                    padding: 12px 24px;
                    border: 1px solid #e5e5ea;
                    border-radius: 12px;
                    background: white;
                    color: #1d1d1f;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                  "
                >
                  Cancel
                </button>

                <button
                  type="submit"
                  style="
                    padding: 12px 24px;
                    border: none;
                    border-radius: 12px;
                    background: #007aff;
                    color: white;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                  "
                >
                  Add Slot
                </button>
              </div>

              </div>
            </form>
          </div>
        `;

        document.body.appendChild(modal);

        // Setup artist search functionality
        const searchInput = document.getElementById('slotArtistSearch');
        const artistIdInput = document.getElementById('slotArtistId');

        // Create dropdown OUTSIDE modal, mounted to body
        const searchResults = document.createElement('div');
        searchResults.id = 'artistSearchResults';
        searchResults.style.cssText = `
          display: none;
          position: fixed;
          background: white;
          border: 1px solid #e5e5ea;
          border-radius: 12px;
          max-height: 300px;
          overflow-y: auto;
          box-shadow: 0 8px 16px rgba(0,0,0,0.15);
          z-index: 100000;
        `;
        document.body.appendChild(searchResults);

        // Function to position dropdown below input
        function positionDropdown() {
          const rect = searchInput.getBoundingClientRect();
          searchResults.style.top = `${rect.bottom + 4}px`;
          searchResults.style.left = `${rect.left}px`;
          searchResults.style.width = `${rect.width}px`;
        }

        let selectedArtist = null;

        searchInput.addEventListener('input', function() {
          const query = this.value.toLowerCase().trim();

          console.log('ðŸ” Artist search query:', query);

          if (query.length === 0) {
            searchResults.style.display = 'none';
            artistIdInput.value = '';
            selectedArtist = null;
            return;
          }

          // Filter artists
          const filtered = artists.filter(artist =>
            artist.name.toLowerCase().includes(query) ||
            (artist.email && artist.email.toLowerCase().includes(query))
          );

          console.log(`âœ… Found ${filtered.length} matching artists`);

          if (filtered.length === 0) {
            searchResults.innerHTML = `
              <div style="padding: 16px; text-align: center; color: #86868b;">
                No artists found
              </div>
            `;
            positionDropdown();
            searchResults.style.display = 'block';
            artistIdInput.value = '';
            selectedArtist = null;
            return;
          }

          // Render results
          searchResults.innerHTML = filtered.map(artist => `
            <div
              class="artist-search-result"
              data-artist-id="${artist.id}"
              data-artist-name="${artist.name}"
              style="
                padding: 12px 16px;
                cursor: pointer;
                border-bottom: 1px solid #f5f5f7;
                transition: background 0.2s;
                background: white;
              "
              onmouseover="this.style.background='#f5f5f7'"
              onmouseout="this.style.background='white'"
            >
              <div style="font-weight: 600; color: #1d1d1f;">${artist.name}</div>
              <div style="font-size: 14px; color: #86868b;">
                ${artist.email || ''} ${artist.is_guest ? 'Â· Guest Artist' : ''}
              </div>
            </div>
          `).join('');

          // Position and show dropdown
          positionDropdown();
          searchResults.style.display = 'block';

          console.log('ðŸ“‹ Dropdown displayed at position:', {
            top: searchResults.style.top,
            left: searchResults.style.left,
            width: searchResults.style.width,
            zIndex: searchResults.style.zIndex
          });

          // Add click handlers to results
          document.querySelectorAll('.artist-search-result').forEach(item => {
            item.addEventListener('click', function() {
              const artistId = this.dataset.artistId;
              const artistName = this.dataset.artistName;

              searchInput.value = artistName;
              artistIdInput.value = artistId;
              selectedArtist = artists.find(a => a.id === artistId);
              searchResults.style.display = 'none';

              console.log('âœ… Artist selected:', artistName, '(ID:', artistId + ')');
            });
          });
        });

        // Close search results when clicking outside
        document.addEventListener('click', function closeSearchResults(e) {
          if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
          }
        });

        // Event listeners
        document.getElementById('cancelSlotButton').addEventListener('click', () => {
          searchResults.remove();
          modal.remove();
        });

        document.getElementById('addSlotForm').addEventListener('submit', async (e) => {
          e.preventDefault();

          // Validate artist selection
          if (!artistIdInput.value) {
            showNotification('Please select an artist from the search results', 'error');
            return;
          }

          await handleAddSlot();
          searchResults.remove();
          modal.remove();
        });

        // Close on backdrop click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            searchResults.remove();
            modal.remove();
          }
        });
      }

      // ============================================
      // Utility: Show Notification
      // ============================================
      function showNotification(message, type = 'info') {
        // Simple alert for now - could be enhanced with custom UI later
        const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
        alert(`${icon} ${message}`);
      }

      // ============================================
      // Handle Add Slot
      // ============================================
      async function handleAddSlot() {
        const artistId = document.getElementById('slotArtistId').value;
        const dateFrom = document.getElementById('slotDateFrom').value;
        const dateTo = document.getElementById('slotDateTo').value;
        const locationId = document.getElementById('slotLocationSelect').value;
        const notes = document.getElementById('slotNotes').value;

        // Validation
        if (!artistId || !dateFrom || !dateTo || !locationId) {
          showNotification('Please fill in all required fields', 'error');
          return;
        }

        if (new Date(dateTo) < new Date(dateFrom)) {
          showNotification('End date must be after start date', 'error');
          return;
        }

        try {
          const { data, error } = await supabase
            .from('waitlist_slots')
            .insert([{
              artist_id: artistId,
              date_from: dateFrom,
              date_to: dateTo,
              location_id: locationId,
              notes: notes || null
            }])
            .select();

          if (error) throw error;

          console.log('âœ… Slot added successfully:', data);
          showNotification('Slot added successfully', 'success');

          // Reload slots
          await loadWaitlistSlots(currentWaitlistLocation);

        } catch (error) {
          console.error('âŒ Error adding slot:', error);
          showNotification('Failed to add slot: ' + error.message, 'error');
        }
      }

      // ============================================
      // Delete Slot
      // ============================================
      async function deleteWaitlistSlot(slotId) {
        if (!confirm('Are you sure you want to delete this slot?')) {
          return;
        }

        try {
          const { error } = await supabase
            .from('waitlist_slots')
            .delete()
            .eq('id', slotId);

          if (error) throw error;

          console.log('âœ… Slot deleted successfully');
          showNotification('Slot deleted successfully', 'success');

          // Reload slots
          await loadWaitlistSlots(currentWaitlistLocation);

        } catch (error) {
          console.error('âŒ Error deleting slot:', error);
          showNotification('Failed to delete slot', 'error');
        }
      }

      // ============================================
      // Toggle Share Paid
      // ============================================
      async function toggleSharePaid(slotId, currentStatus) {
        const newStatus = !currentStatus;

        try {
          const { error } = await supabase
            .from('waitlist_slots')
            .update({ share_paid: newStatus })
            .eq('id', slotId);

          if (error) throw error;

          showNotification(`Share marked as ${newStatus ? 'paid' : 'unpaid'}`, 'success');
          await loadWaitlistSlots(currentWaitlistLocation);

        } catch (error) {
          console.error('Error updating share paid:', error);
          showNotification('Failed to update share paid status', 'error');
        }
      }

      // ============================================
      // Event Listeners
      // ============================================
      function attachWaitlistEventListeners() {
        // Delete buttons
        document.querySelectorAll('.delete-slot-button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const slotId = btn.dataset.slotId;
            deleteWaitlistSlot(slotId);
          });
        });

        // Edit buttons (TODO: implement edit functionality)
        document.querySelectorAll('.edit-slot-button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            // TODO: Open edit modal
            showNotification('Edit functionality coming soon', 'info');
          });
        });

        // Toggle share paid buttons
        document.querySelectorAll('.toggle-share-paid-button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const slotId = btn.dataset.slotId;
            const currentStatus = btn.dataset.currentStatus === 'true';
            toggleSharePaid(slotId, currentStatus);
          });
        });
      }

      // ============================================
      // Initialize Waitlist Tab
      // ============================================
      async function initWaitlist() {
        console.log('ðŸ“‹ Initializing Waitlist...');

        // Add slot button
        const addButton = document.getElementById('addWaitlistSlotButton');
        if (addButton) {
          addButton.addEventListener('click', openAddSlotModal);
        }

        // Location filter buttons
        const locationButtons = document.querySelectorAll('.waitlist-location-tab');
        locationButtons.forEach(btn => {
          btn.addEventListener('click', async () => {
            const location = btn.dataset.location;
            currentWaitlistLocation = location;

            // Update active state
            locationButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Reload slots
            await loadWaitlistSlots(location);
          });
        });

        // Load initial data
        await loadWaitlistSlots(currentWaitlistLocation);

        console.log('âœ… Waitlist initialized');
      }

      // ========================================
      // PAYMENT WORKFLOW EVENT LISTENERS
      // ========================================

      // Payment price input - Calculate deposit
      const paymentPriceInput = document.getElementById('paymentTotalPrice');
      if (paymentPriceInput) {
        paymentPriceInput.addEventListener('input', function() {
          const totalPrice = parseFloat(this.value);

          if (totalPrice && totalPrice > 0) {
            const depositAmount = totalPrice / 2;

            // Show calculation
            document.getElementById('displayTotalPrice').textContent = `â‚¬${totalPrice.toFixed(2)}`;
            document.getElementById('displayDepositPrice').textContent = `â‚¬${depositAmount.toFixed(2)}`;
            document.getElementById('paymentDepositDisplay').style.display = 'block';

            // Enable button if checkbox also checked
            updateSendButtonState();
          } else {
            document.getElementById('paymentDepositDisplay').style.display = 'none';
            updateSendButtonState();
          }
        });
      }

      // Payment confirmation checkbox
      const paymentCheckbox = document.getElementById('paymentConfirmCheckbox');
      if (paymentCheckbox) {
        paymentCheckbox.addEventListener('change', function() {
          updateSendButtonState();
        });
      }

      // Close modal on backdrop click
      const paymentModal = document.getElementById('paymentWorkflowModal');
      if (paymentModal) {
        paymentModal.addEventListener('click', function(e) {
          if (e.target.id === 'paymentWorkflowModal') {
            closePaymentWorkflowModal();
          }
        });
      }

      // ========================================
      // PAYMENT WORKFLOW SYSTEM
      // ========================================

      // Global variable for current payment request
      let currentPaymentRequest = null;

      /**
       * Open Payment Workflow Modal
       * Loads request data and displays payment configuration interface
       */
      async function openPaymentWorkflowModal(requestId) {
        console.log('ðŸ’³ Opening payment workflow for request:', requestId);

        try {
          // Load request data with all relations
          const { data: request, error } = await supabase
            .from('requests')
            .select(`
              *,
              customer:customers(*),
              artist:artists(*),
              location:locations(*)
            `)
            .eq('id', requestId)
            .single();

          if (error) {
            console.error('âŒ Error loading request:', error);
            throw error;
          }

          if (!request) {
            alert('âŒ Request nicht gefunden');
            return;
          }

          console.log('âœ… Request loaded:', request);

          // Validate: Only pending requests
          if (request.status !== 'pending') {
            alert('âš ï¸ Nur Requests mit Status "Pending" kÃ¶nnen zur Zahlungsabwicklung weitergeleitet werden.\\n\\nAktueller Status: ' + request.status);
            return;
          }

          // Validate: No existing payment link
          if (request.stripe_payment_link) {
            const sentDate = request.payment_link_sent_at
              ? new Date(request.payment_link_sent_at).toLocaleString('de-DE')
              : 'unbekannt';
            alert(`â„¹ï¸ FÃ¼r diesen Request wurde bereits ein Zahlungslink erstellt.\\n\\nVersendet am: ${sentDate}\\n\\nLink: ${request.stripe_payment_link}`);
            return;
          }

          // Store for later use
          currentPaymentRequest = request;

          // Render all summaries
          renderPaymentCustomerSummary(request);
          renderPaymentTattooSummary(request);
          renderPaymentAppointmentSummary(request);

          // Reset form state
          document.getElementById('paymentTotalPrice').value = request.total_price || '';
          document.getElementById('paymentConfirmCheckbox').checked = false;
          document.getElementById('sendPaymentLinkBtn').disabled = true;
          document.getElementById('sendPaymentLinkBtn').style.opacity = '0.5';
          document.getElementById('sendPaymentLinkBtn').style.cursor = 'not-allowed';
          document.getElementById('paymentDepositDisplay').style.display = 'none';
          document.getElementById('paymentWorkflowLoading').style.display = 'none';

          // Trigger calculation if price already exists
          if (request.total_price) {
            const event = new Event('input', { bubbles: true });
            document.getElementById('paymentTotalPrice').dispatchEvent(event);
          }

          // Show modal with fade-in
          const modal = document.getElementById('paymentWorkflowModal');
          modal.style.display = 'flex';
          modal.style.opacity = '0';
          setTimeout(() => {
            modal.style.transition = 'opacity 0.2s ease';
            modal.style.opacity = '1';
          }, 10);

          console.log('âœ… Payment workflow modal opened');

        } catch (err) {
          console.error('âŒ Error opening payment workflow:', err);
          alert('âŒ Fehler beim Laden der Request-Daten:\\n\\n' + err.message);
        }
      }

      /**
       * Close Payment Workflow Modal
       */
      window.closePaymentWorkflowModal = function() {
        console.log('ðŸšª Closing payment workflow modal');
        const modal = document.getElementById('paymentWorkflowModal');
        modal.style.opacity = '0';
        setTimeout(() => {
          modal.style.display = 'none';
        }, 200);
        currentPaymentRequest = null;
      };

      /**
       * Render Customer Summary in Payment Modal
       */
      function renderPaymentCustomerSummary(request) {
        const customer = request.customer;
        if (!customer) {
          document.getElementById('paymentCustomerSummary').innerHTML =
            '<div style="color:var(--macos-accent-red);">âš ï¸ Kunde nicht gefunden</div>';
          return;
        }

        const html = `
          <div style="display:grid; grid-template-columns:140px 1fr; gap:12px 24px;">
            <div style="color:var(--macos-text-secondary);">Name:</div>
            <div style="font-weight:600;">${customer.first_name || ''} ${customer.last_name || ''}</div>

            <div style="color:var(--macos-text-secondary);">Email:</div>
            <div style="font-weight:500; color:var(--macos-accent-blue);">${customer.email || request.email || 'Keine Email'}</div>

            <div style="color:var(--macos-text-secondary);">Telefon:</div>
            <div>${customer.phone || 'N/A'}</div>

            <div style="color:var(--macos-text-secondary);">Instagram:</div>
            <div>${customer.instagram ? '@' + customer.instagram.replace('@', '') : 'N/A'}</div>
          </div>
        `;
        document.getElementById('paymentCustomerSummary').innerHTML = html;
      }

      /**
       * Render Tattoo Summary in Payment Modal
       */
      function renderPaymentTattooSummary(request) {
        const html = `
          <div style="display:grid; grid-template-columns:140px 1fr; gap:12px 24px;">
            <div style="color:var(--macos-text-secondary);">Placement:</div>
            <div style="font-weight:500;">${request.placement || 'N/A'}</div>

            <div style="color:var(--macos-text-secondary);">Size:</div>
            <div>${request.size || 'N/A'}</div>

            <div style="color:var(--macos-text-secondary);">Style:</div>
            <div>${request.style || 'N/A'}</div>

            <div style="color:var(--macos-text-secondary);">Type:</div>
            <div><span style="background:var(--macos-fill-secondary); padding:4px 8px; border-radius:6px; font-size:11px; text-transform:uppercase; font-weight:600;">${request.booking_type?.replace('_', ' ') || 'N/A'}</span></div>

            ${request.description ? `
              <div style="color:var(--macos-text-secondary); align-self:start;">Beschreibung:</div>
              <div style="line-height:1.6; color:var(--macos-text-secondary);">${request.description}</div>
            ` : ''}
          </div>
        `;
        document.getElementById('paymentTattooSummary').innerHTML = html;
      }

      /**
       * Render Appointment Summary in Payment Modal
       */
      function renderPaymentAppointmentSummary(request) {
        const scheduledDate = request.scheduled_date
          ? new Date(request.scheduled_date).toLocaleDateString('de-DE', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })
          : 'Noch nicht geplant';

        const html = `
          <div style="display:grid; grid-template-columns:140px 1fr; gap:12px 24px;">
            <div style="color:var(--macos-text-secondary);">Artist:</div>
            <div style="font-weight:600; color:var(--macos-accent-purple);">${request.artist?.name || 'Noch nicht zugewiesen'}</div>

            <div style="color:var(--macos-text-secondary);">Location:</div>
            <div>${request.location?.name || 'N/A'}</div>

            <div style="color:var(--macos-text-secondary);">Datum:</div>
            <div style="font-weight:500;">${scheduledDate}</div>

            <div style="color:var(--macos-text-secondary);">Uhrzeit:</div>
            <div>${request.start_time || 'N/A'} - ${request.end_time || 'N/A'}</div>
          </div>
        `;
        document.getElementById('paymentAppointmentSummary').innerHTML = html;
      }

      /**
       * Update Send Button State based on validation
       */
      window.updateSendButtonState = function() {
        const priceInput = document.getElementById('paymentTotalPrice');
        const checkbox = document.getElementById('paymentConfirmCheckbox');
        const sendBtn = document.getElementById('sendPaymentLinkBtn');

        const totalPrice = parseFloat(priceInput.value);
        const isChecked = checkbox.checked;

        if (totalPrice && totalPrice > 0 && isChecked) {
          sendBtn.disabled = false;
          sendBtn.style.cursor = 'pointer';
          sendBtn.style.opacity = '1';
        } else {
          sendBtn.disabled = true;
          sendBtn.style.cursor = 'not-allowed';
          sendBtn.style.opacity = '0.5';
        }
      };

      /**
       * Generate unique project_number
       * Format: P + YYYY + MM + sequence (e.g., P202511057)
       */
      async function generateProjectNumber() {
        try {
          const now = new Date();
          const year = now.getFullYear(); // 2025
          const month = String(now.getMonth() + 1).padStart(2, '0'); // 11
          const prefix = `P${year}${month}`; // P202511

          console.log('ðŸ”¢ Generating project_number with prefix:', prefix);

          // Find highest number for this month
          const { data, error } = await supabase
            .from('projects')
            .select('project_number')
            .like('project_number', `${prefix}%`)
            .order('project_number', { ascending: false })
            .limit(1);

          if (error) {
            console.error('âŒ Error fetching project numbers:', error);
            throw error;
          }

          let nextNumber = 1;
          if (data && data.length > 0) {
            const lastNumber = data[0].project_number; // e.g., "P202511057"
            const lastSequence = parseInt(lastNumber.slice(-3)); // 057 â†’ 57
            nextNumber = lastSequence + 1; // 58
            console.log('ðŸ“Š Last project_number:', lastNumber, 'â†’ Next sequence:', nextNumber);
          } else {
            console.log('ðŸ“Š No existing projects for this month, starting at 001');
          }

          const sequence = String(nextNumber).padStart(3, '0'); // "058"
          const projectNumber = `${prefix}${sequence}`; // "P202511058"

          console.log('âœ… Generated project_number:', projectNumber);
          return projectNumber;

        } catch (error) {
          console.error('âŒ Failed to generate project_number:', error);
          throw error;
        }
      }

      /**
       * Create new Project in projects table
       */
      async function createProject(requestData, projectNumber, totalPrice, stripePaymentLink) {
        try {
          console.log('ðŸ“¦ Creating new project:', projectNumber);

          const projectData = {
            project_number: projectNumber,
            customer_email: requestData.customer?.email || requestData.email,
            title: `Tattoo - ${requestData.placement || 'Custom Design'}`,
            description: requestData.description || null,
            bodypart: requestData.placement || null,
            tattoosize: requestData.size || null,
            style: requestData.style || null,
            model: requestData.colorway || null,
            work_process: null,
            state: 'pending',
            price: totalPrice,
            payment_state: 'awaiting_payment',
            payment_notice: null,
            payment_intent: stripePaymentLink,
            deposit_expired: false,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            deleted_at: null
          };

          const { data, error } = await supabase
            .from('projects')
            .insert(projectData)
            .select()
            .single();

          if (error) {
            console.error('âŒ Error creating project:', error);
            throw error;
          }

          console.log('âœ… Project created successfully:', data);
          return data;

        } catch (error) {
          console.error('âŒ Failed to create project:', error);
          throw error;
        }
      }

      /**
       * Create new Appointment in appointments table
       */
      async function createAppointment(requestData, projectId, projectNumber) {
        try {
          console.log('ðŸ“… Creating new appointment for project:', projectNumber);

          // Parse scheduled date and times
          const scheduledDate = requestData.scheduled_date ? new Date(requestData.scheduled_date) : new Date();
          const startTime = requestData.start_time || '10:00';
          const endTime = requestData.end_time || '12:00';

          // Combine date and time
          const [startHour, startMin] = startTime.split(':');
          const startDateTime = new Date(scheduledDate);
          startDateTime.setHours(parseInt(startHour), parseInt(startMin), 0, 0);

          const [endHour, endMin] = endTime.split(':');
          const endDateTime = new Date(scheduledDate);
          endDateTime.setHours(parseInt(endHour), parseInt(endMin), 0, 0);

          const appointmentData = {
            artist_email: requestData.artist?.email || null,
            customer_email: requestData.customer?.email || requestData.email,
            project_id: projectId,
            project_number: projectNumber,
            creator_email: currentUser?.email || null,
            wannado_id: null,
            state: 'scheduled',
            work_process: null,
            start: startDateTime.toISOString(),
            end: endDateTime.toISOString(),
            notice: requestData.notes || null,
            notification_24h_send: false,
            notification_2h_after_send: false,
            notification_1month_after_send: false,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            deleted_at: null
          };

          const { data, error } = await supabase
            .from('appointments')
            .insert(appointmentData)
            .select()
            .single();

          if (error) {
            console.error('âŒ Error creating appointment:', error);
            throw error;
          }

          console.log('âœ… Appointment created successfully:', data);
          return data;

        } catch (error) {
          console.error('âŒ Failed to create appointment:', error);
          throw error;
        }
      }

      /**
       * Execute Complete Payment Workflow
       * NEW: Creates project + appointment, updates request with project_number
       * Orchestrates: Project Creation â†’ Appointment Creation â†’ Stripe Payment Link â†’ Email â†’ Logging
       */
      window.executePaymentWorkflow = async function() {
        console.log('ðŸš€ ========================================');
        console.log('ðŸš€ STARTING PAYMENT WORKFLOW (3-TABLE ARCHITECTURE)');
        console.log('ðŸš€ ========================================');

        if (!currentPaymentRequest) {
          alert('âŒ Kein Request geladen');
          return;
        }

        const totalPrice = parseFloat(document.getElementById('paymentTotalPrice').value);
        if (!totalPrice || totalPrice <= 0) {
          alert('âŒ Bitte gib einen gÃ¼ltigen Gesamtpreis ein');
          return;
        }

        const depositAmount = totalPrice / 2;

        console.log('ðŸ’° Total Price:', totalPrice, 'EUR');
        console.log('ðŸ’° Deposit Amount (50%):', depositAmount, 'EUR');

        // Show loading overlay
        document.getElementById('paymentWorkflowLoading').style.display = 'flex';
        document.getElementById('sendPaymentLinkBtn').disabled = true;

        let projectNumber = null;
        let newProject = null;
        let newAppointment = null;

        try {
          // ========================================
          // STEP 1: Generate project_number
          // ========================================
          console.log('\\nðŸ”¢ STEP 1: Generating project_number...');
          projectNumber = await generateProjectNumber();
          console.log('âœ… project_number generated:', projectNumber);

          // ========================================
          // STEP 2: Create Stripe Payment Link
          // ========================================
          console.log('\\nðŸ’³ STEP 2: Creating Stripe Payment Link...');
          const paymentLink = await createStripePaymentLink(currentPaymentRequest, totalPrice);

          if (!paymentLink || !paymentLink.url) {
            throw new Error('Stripe Payment Link konnte nicht erstellt werden');
          }

          console.log('âœ… Stripe Payment Link created successfully!');
          console.log('ðŸ”— Link:', paymentLink.url);
          console.log('ðŸ†” Payment Link ID:', paymentLink.id);

          // ========================================
          // STEP 3: Create Project in projects table
          // ========================================
          console.log('\\nðŸ“¦ STEP 3: Creating project in projects table...');
          newProject = await createProject(
            currentPaymentRequest,
            projectNumber,
            totalPrice,
            paymentLink.url
          );
          console.log('âœ… Project created with ID:', newProject.id);

          // ========================================
          // STEP 4: Create Appointment in appointments table
          // ========================================
          console.log('\\nðŸ“… STEP 4: Creating appointment in appointments table...');
          newAppointment = await createAppointment(
            currentPaymentRequest,
            newProject.id,
            projectNumber
          );
          console.log('âœ… Appointment created with ID:', newAppointment.id);

          // ========================================
          // STEP 5: Update Request with project_number
          // ========================================
          console.log('\\nðŸ’¾ STEP 5: Updating request with project_number...');
          const { error: updateError } = await supabase
            .from('requests')
            .update({
              project_number: projectNumber,
              stripe_payment_link: paymentLink.url,
              payment_link_sent_at: new Date().toISOString(),
              booking_team_member_name: currentUser?.username || 'System'
            })
            .eq('id', currentPaymentRequest.id);

          if (updateError) {
            console.error('âŒ Request update error:', updateError);
            throw updateError;
          }

          console.log('âœ… Request updated with project_number:', projectNumber);

          // ========================================
          // STEP 6: Log Payment Link Creation
          // ========================================
          console.log('\\nðŸ“ STEP 6: Logging payment action...');
          await logPaymentAction(
            currentPaymentRequest.id,
            newProject.id,
            'payment_link_created',
            paymentLink.url,
            totalPrice,
            depositAmount,
            'success'
          );
          console.log('âœ… Payment action logged');

          // ========================================
          // STEP 7: Send Confirmation Email
          // ========================================
          console.log('\\nðŸ“§ STEP 7: Sending confirmation email...');
          const customerEmail = currentPaymentRequest.customer?.email || currentPaymentRequest.email;
          console.log('ðŸ“¬ Sending to:', customerEmail);

          const emailResult = await sendPaymentConfirmationEmail(
            currentPaymentRequest,
            paymentLink.url,
            totalPrice,
            depositAmount,
            projectNumber
          );

          if (!emailResult.success) {
            throw new Error('Email konnte nicht versendet werden: ' + emailResult.error);
          }

          console.log('âœ… Email sent successfully!');
          console.log('ðŸ“§ Message ID:', emailResult.messageId);

          // ========================================
          // STEP 8: Update Email Sent Flag
          // ========================================
          console.log('\\nðŸ STEP 8: Updating email confirmation flag...');
          await supabase
            .from('requests')
            .update({ payment_confirmation_email_sent: true })
            .eq('id', currentPaymentRequest.id);

          console.log('âœ… Email confirmation flag updated');

          // ========================================
          // STEP 9: Log Email Sending
          // ========================================
          console.log('\\nðŸ“ STEP 9: Logging email action...');
          await logPaymentAction(
            currentPaymentRequest.id,
            newProject.id,
            'email_sent',
            paymentLink.url,
            totalPrice,
            depositAmount,
            'success',
            customerEmail
          );
          console.log('âœ… Email action logged');

          // ========================================
          // SUCCESS!
          // ========================================
          console.log('\\nðŸŽ‰ ========================================');
          console.log('ðŸŽ‰ PAYMENT WORKFLOW COMPLETED SUCCESSFULLY!');
          console.log('ðŸŽ‰ ========================================');
          console.log('ðŸ“Š Summary:');
          console.log('   - project_number:', projectNumber);
          console.log('   - Project ID:', newProject.id);
          console.log('   - Appointment ID:', newAppointment.id);
          console.log('   - Request ID:', currentPaymentRequest.id);

          alert(
            'âœ… Zahlungsabwicklung erfolgreich abgeschlossen!\\n\\n' +
            `ðŸ†” Project Number: ${projectNumber}\\n` +
            `ðŸ’³ Payment Link erstellt\\n` +
            `ðŸ“§ Email versendet an: ${customerEmail}\\n` +
            `ðŸ’¶ Gesamtpreis: â‚¬${totalPrice.toFixed(2)}\\n` +
            `ðŸ’° Terminkaution: â‚¬${depositAmount.toFixed(2)}\\n\\n` +
            'Der Kunde hat alle notwendigen Informationen erhalten.'
          );

          // Close modal and refresh
          closePaymentWorkflowModal();
          await loadRequests(); // Refresh the requests list

        } catch (error) {
          // ========================================
          // ERROR HANDLING
          // ========================================
          console.error('\\nâŒ ========================================');
          console.error('âŒ PAYMENT WORKFLOW FAILED');
          console.error('âŒ ========================================');
          console.error('Error:', error);
          console.error('Stack:', error.stack);

          // Log error (use project ID if it was created)
          await logPaymentAction(
            currentPaymentRequest.id,
            newProject?.id || null,
            'workflow_failed',
            null,
            totalPrice,
            depositAmount,
            'failed',
            null,
            error.message
          );

          alert(
            'âŒ Fehler bei der Zahlungsabwicklung\\n\\n' +
            'Details: ' + error.message + '\\n\\n' +
            (projectNumber ? `Project Number: ${projectNumber}\\n` : '') +
            'Bitte Ã¼berprÃ¼fe:\\n' +
            'â€¢ API Keys korrekt eingetragen?\\n' +
            'â€¢ Stripe im Test Mode?\\n' +
            'â€¢ Internet-Verbindung aktiv?\\n' +
            'â€¢ Browser Console fÃ¼r Details'
          );

        } finally {
          // Hide loading overlay
          document.getElementById('paymentWorkflowLoading').style.display = 'none';
          updateSendButtonState();
        }
      };

      /**
       * Create Stripe Payment Link via API
       */
      async function createStripePaymentLink(requestData, totalPrice) {
        console.log('ðŸ”µ Calling Stripe API...');

        const customerName = requestData.customer
          ? `${requestData.customer.first_name} ${requestData.customer.last_name}`
          : 'Kunde';

        const productName = `Tattoo Session - ${customerName}`;
        const amountInCents = Math.round(totalPrice * 100); // Convert EUR to cents

        console.log('ðŸ“¦ Product:', productName);
        console.log('ðŸ’µ Amount:', amountInCents, 'cents (', totalPrice, 'EUR)');

        try {
          const response = await fetch('https://api.stripe.com/v1/payment_links', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${STRIPE_SECRET_KEY}`,
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
              'line_items[0][price_data][currency]': 'eur',
              'line_items[0][price_data][product_data][name]': productName,
              'line_items[0][price_data][unit_amount]': amountInCents,
              'line_items[0][quantity]': 1,
              'metadata[customer_id]': requestData.customer_id || '',
              'metadata[request_id]': requestData.id,
              'metadata[artist_id]': requestData.artist_id || '',
              'metadata[location_id]': requestData.location_id || '',
              'allow_promotion_codes': 'true',
              'billing_address_collection': 'auto',
              'phone_number_collection[enabled]': 'true',
              'after_completion[type]': 'hosted_confirmation',
              'after_completion[hosted_confirmation][custom_message]': 'Vielen Dank fÃ¼r deine Zahlung! Wir sehen uns zum Termin. ðŸŽ¨'
            })
          });

          console.log('ðŸ“¡ Stripe API Response Status:', response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error('âŒ Stripe API Error Response:', errorData);
            throw new Error(`Stripe API Error: ${errorData.error?.message || response.statusText}`);
          }

          const data = await response.json();
          console.log('âœ… Stripe API Success Response:', data);

          return data;

        } catch (error) {
          console.error('âŒ Stripe Payment Link Creation Failed:', error);
          throw error;
        }
      }

      /**
       * Send Payment Confirmation Email via Resend
       * Updated to use project_number instead of request_number
       */
      async function sendPaymentConfirmationEmail(requestData, paymentLink, totalPrice, depositAmount, projectNumber) {
        console.log('ðŸ“§ Preparing email...');

        const customer = requestData.customer;
        const customerName = customer?.first_name || 'Kunde';
        const customerEmail = customer?.email || requestData.email;
        const artistName = requestData.artist?.name || 'deinem Artist';
        const locationName = requestData.location?.name || 'unserem Studio';
        const scheduledDate = requestData.scheduled_date
          ? new Date(requestData.scheduled_date).toLocaleDateString('de-DE', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })
          : '[Datum folgt]';
        // Use projectNumber for bank transfer reference
        const referenceNumber = projectNumber || requestData.id.substring(0, 8).toUpperCase();
        const bookingMemberName = currentUser?.username || 'dem Team';

        console.log('ðŸ“ Email Recipients:', customerEmail);
        console.log('ðŸ“ From:', EMAIL_FROM);
        console.log('ðŸ“ Reference Number (project_number):', referenceNumber);

        // Complete Email HTML Template
        const emailHTML = `
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px 30px;
      text-align: center;
    }
    .header h1 {
      color: white;
      margin: 0;
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    .content {
      padding: 40px 30px;
    }
    .section {
      margin-bottom: 30px;
    }
    .section h2 {
      font-size: 20px;
      color: #667eea;
      margin: 0 0 16px 0;
      font-weight: 600;
    }
    .option-box {
      background: #f8f9fa;
      padding: 24px;
      border-radius: 12px;
      margin: 16px 0;
      border-left: 4px solid #667eea;
    }
    .option-box h3 {
      margin: 0 0 12px 0;
      font-size: 18px;
      color: #333;
    }
    .button {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 16px 40px;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 600;
      margin: 12px 0;
      font-size: 16px;
      transition: all 0.2s;
    }
    .button:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }
    .info-grid {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
      margin: 16px 0;
      font-size: 15px;
    }
    .info-grid strong {
      color: #666;
    }
    .warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 20px;
      border-radius: 8px;
      margin: 24px 0;
    }
    .footer {
      background: #f8f9fa;
      padding: 30px;
      text-align: center;
      font-size: 13px;
      color: #666;
      line-height: 1.8;
    }
    .price-highlight {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
    }
    @media only screen and (max-width: 600px) {
      .content { padding: 30px 20px; }
      .option-box { padding: 20px; }
      .info-grid { grid-template-columns: 1fr; gap: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <div class="header">
      <h1>Mommy I'm Sorry</h1>
    </div>

    <!-- Main Content -->
    <div class="content">

      <p style="font-size: 16px; margin: 0 0 24px 0;">Hallo ${customerName},</p>

      <p style="font-size: 16px; line-height: 1.8;">perfekt! Wir freuen uns schon sehr auf das Projekt. ðŸ˜Š</p>

      <p style="font-size: 16px; line-height: 1.8;">Ich habe Dir den Termin am <strong>${scheduledDate}</strong> mit <strong>${artistName}</strong> bereits eingetragen.</p>

      <!-- Payment Options Section -->
      <div class="section">
        <h2>ðŸ’³ ZahlungsmÃ¶glichkeiten</h2>
        <p style="margin-bottom: 20px;">Um Dir die Zahlung so angenehm wie mÃ¶glich zu gestalten, bieten wir Dir zwei Optionen an:</p>

        <!-- Option 1: Bank Transfer -->
        <div class="option-box">
          <h3>Option 1*: Ãœberweisung</h3>
          <p style="margin: 12px 0;">
            ðŸ”¹ 50 % der Gesamtsumme (<span class="price-highlight">â‚¬${depositAmount.toFixed(2)}</span>) vorab per Ãœberweisung bezahlen<br>
            ðŸ”¹ Die verbleibenden 50 % bequem am Termin in bar begleichen
          </p>
        </div>

        <!-- Option 2: Online Payment -->
        <div class="option-box">
          <h3>Option 2: Online-Zahlung</h3>
          <p style="margin: 12px 0 20px 0;">
            ðŸ’³ Die Gesamtsumme (<span class="price-highlight">â‚¬${totalPrice.toFixed(2)}</span>) direkt online begleichen:
          </p>
          <div style="text-align: center;">
            <a href="${paymentLink}" class="button">Jetzt online bezahlen â†’</a>
          </div>
          <p style="font-size: 14px; margin: 16px 0 0 0; color: #666;">
            Hier stehen dir verschiedene ZahlungsmÃ¶glichkeiten zur VerfÃ¼gung (Klarna, Kreditkarte, Apple Pay).
            Du kannst auÃŸerdem eine Ratenzahlung wÃ¤hlen oder die Zahlung auf einen spÃ¤teren Zeitpunkt verschieben.
          </p>
        </div>
      </div>

      <!-- Important Notes -->
      <div class="warning">
        <strong style="font-size: 16px; display: block; margin-bottom: 12px;">âš ï¸ Wichtige Hinweise:</strong>
        <p style="margin: 8px 0;">âŒ Bitte trinke vor deinem Termin keinen Alkohol und nimm keine blutverdÃ¼nnenden Mittel wie Aspirin o. Ã„. ein.</p>
        <p style="margin: 8px 0;">ðŸ“œ Beachte zudem unsere <a href="${BUSINESS_INFO.faq_url}" style="color: #667eea;">allgemeinen GeschÃ¤ftsbedingungen (AGB)</a></p>
      </div>

      <!-- Bank Transfer Details -->
      <div style="background: #f8f9fa; padding: 24px; border-radius: 12px; margin: 24px 0;">
        <p style="font-size: 15px; line-height: 1.8; margin-bottom: 20px;">
          <strong>*FÃ¼r Option 1:</strong> Bitte Ã¼berweise die Terminkaution (<strong>â‚¬${depositAmount.toFixed(2)}</strong>) innerhalb von 2 Tagen und sende einen Screenshot zur BestÃ¤tigung. ðŸ˜Š
        </p>
        <p style="background: rgba(255,193,7,0.2); padding: 12px; border-radius: 8px; margin: 16px 0; font-size: 14px;">
          <strong>WICHTIG:</strong> Als Verwendungszweck bitte nur "<strong>${referenceNumber}</strong>" angeben, damit die Zahlung korrekt zugeordnet wird.
        </p>

        <h3 style="margin: 24px 0 16px 0; font-size: 18px;">Bankverbindung:</h3>
        <div class="info-grid">
          <strong>EmpfÃ¤nger:</strong>
          <div>${BUSINESS_INFO.name}</div>
          <strong>IBAN:</strong>
          <div style="font-family: monospace; letter-spacing: 0.5px;">${BUSINESS_INFO.iban}</div>
          <strong>Betrag:</strong>
          <div style="font-size: 18px; font-weight: 600; color: #667eea;">â‚¬${depositAmount.toFixed(2)}</div>
        </div>
      </div>

      <!-- Studio Address -->
      <div class="section">
        <h2>ðŸ“ Adresse</h2>
        <div class="info-grid">
          <strong>Studio:</strong>
          <div>${locationName}</div>
          <strong>Adresse:</strong>
          <div>${BUSINESS_INFO.address}<br>${BUSINESS_INFO.city}</div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="section">
        <h2>ðŸ“ž Kontakt</h2>
        <div class="info-grid">
          <strong>Telefon/WhatsApp:</strong>
          <div><a href="tel:${BUSINESS_INFO.phone}" style="color: #667eea; text-decoration: none;">${BUSINESS_INFO.phone}</a></div>
          <strong>Email:</strong>
          <div><a href="mailto:${BUSINESS_INFO.email}" style="color: #667eea; text-decoration: none;">${BUSINESS_INFO.email}</a></div>
          <strong>Instagram:</strong>
          <div><a href="https://instagram.com/${BUSINESS_INFO.instagram.replace('@', '')}" style="color: #667eea; text-decoration: none;">${BUSINESS_INFO.instagram}</a></div>
          <strong>FAQ:</strong>
          <div><a href="${BUSINESS_INFO.faq_url}" style="color: #667eea; text-decoration: none;">HÃ¤ufig gestellte Fragen</a></div>
        </div>
      </div>

      <!-- Terms & Conditions -->
      <div style="font-size: 13px; color: #666; line-height: 1.8; margin-top: 40px; padding-top: 24px; border-top: 1px solid #e0e0e0;">
        <strong style="display: block; margin-bottom: 12px; color: #333;">Umgang mit Terminkautionen, Absagen, Verschiebungen und VerspÃ¤tungen:</strong>
        <p style="margin: 8px 0;">Der Gesamtpreis der TÃ¤towierung wird am ersten Termin, vor dem Stechen fÃ¤llig. Die geleistete Terminkaution wird mit dem Gesamtpreis verrechnet.</p>
        <p style="margin: 8px 0;">Zur Terminvereinbarung einer neuen TÃ¤towierung wird mindestens eine Terminkaution in HÃ¶he von 50 % des Gesamtpreises benÃ¶tigt. Alternativ kann vorab die Gesamtsumme bezahlt werden.</p>
        <p style="margin: 8px 0;">Terminkautionen werden nicht rÃ¼ckerstattet.</p>
        <p style="margin: 8px 0;">Kann der Termin nicht eingehalten werden, so ist dieser mindestens 3 Werktage vorher abzusagen. Ansonsten verfÃ¤llt die Terminkaution.</p>
        <p style="margin: 8px 0;">Wird ein Termin nicht wahrgenommen und nicht abgesagt verfÃ¤llt die Terminkaution.</p>
        <p style="margin: 8px 0;">Solltest Du einmal einen Termin verschieben mÃ¼ssen, so bitten wir Dich das spÃ¤testens 3 Werktage vor dem Termin zu tun. In diesem Fall bleibt die Terminkaution erhalten.</p>
        <p style="margin: 8px 0;">Erscheine bitte pÃ¼nktlich zu Deinem Termin. Solltest Du Dich unangekÃ¼ndigt um mehr als 30 min verspÃ¤ten, so kann der Termin unter UmstÃ¤nden nicht eingehalten werden.</p>
      </div>

      <!-- Signature -->
      <p style="margin: 40px 0 0 0; font-size: 16px;">
        Cheers,<br>
        <strong style="font-size: 18px;">${bookingMemberName}</strong>
      </p>

    </div>

    <!-- Footer -->
    <div class="footer">
      <p style="margin: 0 0 12px 0;">
        <strong>${BUSINESS_INFO.name}</strong><br>
        ${BUSINESS_INFO.address}, ${BUSINESS_INFO.city}
      </p>
      <p style="font-size: 12px; margin: 20px 0 0 0; color: #999;">
        Amtsgericht Stuttgart | HRB 746699 - GeschÃ¤ftsfÃ¼hrer: A.Supper<br>
        Diese E-Mail kann vertrauliche und/oder gesetzlich geschÃ¼tzte Informationen enthalten.
      </p>
    </div>

  </div>
</body>
</html>
        `;

        console.log('ðŸ“§ Email HTML generated (', emailHTML.length, 'characters)');

        try {
          console.log('ðŸ“¡ Calling Resend API...');

          const response = await fetch('https://api.resend.com/emails', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${RESEND_API_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              from: EMAIL_FROM,
              to: customerEmail,
              reply_to: EMAIL_REPLY_TO,
              subject: `Deine TerminbestÃ¤tigung bei Mommy I'm Sorry - ${artistName}`,
              html: emailHTML
            })
          });

          console.log('ðŸ“¡ Resend API Response Status:', response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error('âŒ Resend API Error Response:', errorData);
            throw new Error(`Resend API Error: ${errorData.message || response.statusText}`);
          }

          const data = await response.json();
          console.log('âœ… Resend API Success Response:', data);

          return {
            success: true,
            messageId: data.id
          };

        } catch (error) {
          console.error('âŒ Email Sending Failed:', error);
          return {
            success: false,
            error: error.message
          };
        }
      }

      /**
       * Log Payment Action to payment_logs table
       * Updated to include project_id for linking to projects table
       */
      async function logPaymentAction(requestId, projectId, actionType, stripeLink, totalAmount, depositAmount, status, emailSentTo = null, errorMessage = null) {
        try {
          console.log('ðŸ“ Logging action:', actionType, 'with status:', status);
          console.log('ðŸ“ Request ID:', requestId, '| Project ID:', projectId);

          const logData = {
            request_id: requestId,
            action_type: actionType,
            stripe_payment_link: stripeLink,
            email_sent_to: emailSentTo,
            total_amount: totalAmount,
            deposit_amount: depositAmount,
            status: status,
            error_message: errorMessage,
            created_by: currentUser?.id || null
          };

          // Add project_id if provided (column may not exist in older schemas)
          if (projectId) {
            logData.project_id = projectId;
          }

          const { error } = await supabase
            .from('payment_logs')
            .insert(logData);

          if (error) {
            console.error('âš ï¸ Failed to log payment action:', error);
            // Don't throw - logging failure shouldn't break the workflow
          } else {
            console.log('âœ… Payment action logged successfully');
          }
        } catch (err) {
          console.error('âš ï¸ Error logging payment action:', err);
          // Don't throw - logging failure shouldn't break the workflow
        }
      }

      // ==========================================
      // NAVBAR & MOBILE NAVIGATION SETUP
      // ==========================================

      // Mobile Navigation Events
      const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
      mobileNavItems.forEach(item => {
        item.addEventListener('click', function() {
          const viewName = this.dataset.mobileView;

          // Update active state
          mobileNavItems.forEach(navItem => navItem.classList.remove('active'));
          this.classList.add('active');

          // Handle profile view specially
          if (viewName === 'profile') {
            // Open login modal/profile view
            const loginBackdrop = document.getElementById('loginBackdrop');
            if (loginBackdrop && currentUser) {
              // Show profile view
              document.getElementById('loginFormView').style.display = 'none';
              document.getElementById('profileView').style.display = 'block';
              loginBackdrop.classList.add('active');
            } else if (loginBackdrop) {
              // Show login view
              loginBackdrop.classList.add('active');
            }
            return;
          }

          // Switch to the selected view
          const viewId = viewName + '-section';
          const sections = document.querySelectorAll('section');
          sections.forEach(s => s.classList.remove('active'));

          const targetSection = document.getElementById(viewId);
          if (targetSection) {
            targetSection.classList.add('active');
          }

          // Update desktop nav if exists
          const navLinks = document.querySelectorAll('.nav-link');
          navLinks.forEach(link => link.classList.remove('active'));
          const matchingNavLink = document.querySelector(`.nav-link[data-view="${viewName}"]`);
          if (matchingNavLink) {
            matchingNavLink.classList.add('active');
          }
        });
      });

      // Initialize navbar hover and mobile navigation
      setupNavbarHover();
      setupMobileNavigation();

      // Header Title - Return to Dashboard
      const headerTitle = document.querySelector('.header-title');
      if (headerTitle) {
        headerTitle.addEventListener('click', function() {
          // Switch to dashboard view
          const sections = document.querySelectorAll('section');
          sections.forEach(s => s.classList.remove('active'));
          const dashboardSection = document.getElementById('dashboard-section');
          if (dashboardSection) {
            dashboardSection.classList.add('active');
          }

          // Update nav links
          const navLinks = document.querySelectorAll('.nav-link');
          navLinks.forEach(link => link.classList.remove('active'));
          const dashboardLink = document.querySelector('.nav-link[data-view="dashboard"]');
          if (dashboardLink) {
            dashboardLink.classList.add('active');
          }

          // Update mobile nav
          const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
          mobileNavItems.forEach(item => item.classList.remove('active'));
          const mobileDashboardItem = document.querySelector('.mobile-nav-item[data-view="dashboard"]');
          if (mobileDashboardItem) {
            mobileDashboardItem.classList.add('active');
          }
        });
      }

      // ==========================================
      // DROPDOWN MANAGEMENT
      // ==========================================

      const profileDropdown = document.getElementById('profileDropdown');
      const notificationsDropdown = document.getElementById('notificationsDropdown');
      const feedbackDropdown = document.getElementById('feedbackDropdown');

      // Profile Button Toggle
      const profileButton = document.getElementById('profileButton');
      if (profileButton) {
        profileButton.addEventListener('click', function(e) {
          e.stopPropagation();
          if (profileDropdown) profileDropdown.classList.toggle('active');
          if (notificationsDropdown) notificationsDropdown.classList.remove('active');
          if (feedbackDropdown) feedbackDropdown.classList.remove('active');
        });
      }

      // Notification Button Toggle
      const notificationButton = document.getElementById('notificationButton');
      if (notificationButton) {
        notificationButton.addEventListener('click', function(e) {
          e.stopPropagation();
          if (notificationsDropdown) notificationsDropdown.classList.toggle('active');
          if (profileDropdown) profileDropdown.classList.remove('active');
          if (feedbackDropdown) feedbackDropdown.classList.remove('active');
        });
      }

      // Feedback Button Toggle
      const feedbackButton = document.getElementById('feedbackButton');
      if (feedbackButton) {
        feedbackButton.addEventListener('click', function(e) {
          e.stopPropagation();
          if (feedbackDropdown) feedbackDropdown.classList.toggle('active');
          if (profileDropdown) profileDropdown.classList.remove('active');
          if (notificationsDropdown) notificationsDropdown.classList.remove('active');
        });
      }

      // Notification Tabs
      const inboxTab = document.getElementById('inboxTab');
      const updatesTab = document.getElementById('updatesTab');
      if (inboxTab && updatesTab) {
        inboxTab.addEventListener('click', function() {
          inboxTab.classList.add('active');
          updatesTab.classList.remove('active');
        });
        updatesTab.addEventListener('click', function() {
          updatesTab.classList.add('active');
          inboxTab.classList.remove('active');
        });
      }

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        if (profileDropdown && !profileDropdown.contains(e.target) && (!profileButton || !profileButton.contains(e.target))) {
          profileDropdown.classList.remove('active');
        }
        if (notificationsDropdown && !notificationsDropdown.contains(e.target) && (!notificationButton || !notificationButton.contains(e.target))) {
          notificationsDropdown.classList.remove('active');
        }
        if (feedbackDropdown && !feedbackDropdown.contains(e.target) && (!feedbackButton || !feedbackButton.contains(e.target))) {
          feedbackDropdown.classList.remove('active');
        }
      });

      // Dashboard Link in Profile Dropdown
      const dashboardLinkDropdown = document.getElementById('dashboardLinkDropdown');
      if (dashboardLinkDropdown) {
        dashboardLinkDropdown.addEventListener('click', function(e) {
          e.preventDefault();
          // Switch to dashboard view
          const sections = document.querySelectorAll('section');
          sections.forEach(s => s.classList.remove('active'));
          const dashboardSection = document.getElementById('dashboard-section');
          if (dashboardSection) {
            dashboardSection.classList.add('active');
          }

          // Update nav links
          const navLinks = document.querySelectorAll('.nav-link');
          navLinks.forEach(link => link.classList.remove('active'));
          const dashboardLink = document.querySelector('.nav-link[data-view="dashboard"]');
          if (dashboardLink) {
            dashboardLink.classList.add('active');
          }

          if (profileDropdown) profileDropdown.classList.remove('active');
        });
      }

      // Account Settings Link
      const accountSettingsLink = document.getElementById('accountSettingsLink');
      if (accountSettingsLink) {
        accountSettingsLink.addEventListener('click', function(e) {
          e.preventDefault();
          switchView('accountSettings');
          if (profileDropdown) profileDropdown.classList.remove('active');
        });
      }

      // Theme Buttons
      const lightThemeBtn = document.getElementById('lightThemeBtn');
      const darkThemeBtn = document.getElementById('darkThemeBtn');

      function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);

        if (theme === 'dark') {
          if (darkThemeBtn) darkThemeBtn.classList.add('active');
          if (lightThemeBtn) lightThemeBtn.classList.remove('active');
        } else {
          if (lightThemeBtn) lightThemeBtn.classList.add('active');
          if (darkThemeBtn) darkThemeBtn.classList.remove('active');
        }
      }

      if (lightThemeBtn) {
        lightThemeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          setTheme('light');
        });
      }
      if (darkThemeBtn) {
        darkThemeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          setTheme('dark');
        });
      }

      // Load saved theme
      function loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);
      }
      loadTheme();

      // Logout Button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async function() {
          await logout();
          if (profileDropdown) profileDropdown.classList.remove('active');
        });
      }

      // Command Menu Link (placeholder)
      const commandMenuLink = document.getElementById('commandMenuLink');
      if (commandMenuLink) {
        commandMenuLink.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Command Menu clicked - not implemented yet');
          // TODO: Implement command menu modal
        });
      }

      // Home Page Link
      const homePageLink = document.getElementById('homePageLink');
      if (homePageLink) {
        homePageLink.addEventListener('click', function(e) {
          e.preventDefault();
          // Open main website in new tab
          window.open('https://mommyimsorry.com', '_blank');
          if (profileDropdown) profileDropdown.classList.remove('active');
        });
      }

      // Feedback Send Button
      const feedbackSendBtn = document.getElementById('feedbackSendBtn');
      const feedbackSelect = document.getElementById('feedbackSelect');
      const feedbackTextarea = document.getElementById('feedbackTextarea');

      if (feedbackSendBtn) {
        feedbackSendBtn.addEventListener('click', function() {
          const topic = feedbackSelect?.value || '';
          const message = feedbackTextarea?.value || '';

          if (!topic) {
            alert('Please select a topic');
            return;
          }

          if (!message.trim()) {
            alert('Please enter your feedback');
            return;
          }

          console.log('Feedback submitted:', { topic, message });
          alert('Thank you for your feedback!');

          // Reset form
          if (feedbackSelect) feedbackSelect.value = '';
          if (feedbackTextarea) feedbackTextarea.value = '';

          // Close dropdown
          if (feedbackDropdown) feedbackDropdown.classList.remove('active');
        });
      }

      // Emoji Buttons
      const emojiButtons = document.querySelectorAll('.emoji-btn');
      emojiButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const emoji = this.getAttribute('data-emoji');
          if (feedbackTextarea) {
            feedbackTextarea.value += emoji;
          }
        });
      });

      // Re-init bei Resize
      window.addEventListener('resize', function() {
        setupNavbarHover();
        setupMobileNavigation();
      });

      // ==========================================
      // ACCOUNT SETTINGS NAVIGATION
      // ==========================================

      const mainNavbar = document.getElementById('mainNavbar');
      const settingsNavbar = document.getElementById('settingsNavbar');
      const mainTitle = document.getElementById('mainTitle');

      // Return to Dashboard from Settings Navbar
      const returnToDashboardBtn = document.getElementById('returnToDashboard');
      if (returnToDashboardBtn) {
        returnToDashboardBtn.addEventListener('click', function(e) {
          e.preventDefault();
          switchView('dashboard');
        });
      }

      // Settings Navbar Tab Switching
      const settingsNavLinks = document.querySelectorAll('#settingsNavbar .nav-link[data-tab]');
      settingsNavLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const tabName = this.dataset.tab;

          // Update navbar active state
          settingsNavLinks.forEach(l => l.classList.remove('active'));
          this.classList.add('active');

          // Update main title
          if (mainTitle) {
            mainTitle.textContent = tabName === 'activity' ? 'Account Activity' : 'Account Settings';
          }

          // Switch tab content
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(tabName + 'Tab').classList.add('active');
        });
      });

      // Sidebar Navigation
      const sidebarItems = document.querySelectorAll('.sidebar-nav .nav-item');

      sidebarItems.forEach(item => {
        item.addEventListener('click', function() {
          const section = this.dataset.section;

          // Update sidebar active state
          sidebarItems.forEach(i => i.classList.remove('active'));
          this.classList.add('active');

          // Map sidebar items to tabs
          if (section === 'activity') {
            // Switch to Activity tab
            if (mainTitle) mainTitle.textContent = 'Account Activity';
            document.querySelectorAll('#settingsNavbar .nav-link').forEach(link => {
              if (link.dataset.tab === 'activity') {
                link.click();
              }
            });
          } else {
            // All other items go to Settings tab
            if (mainTitle) mainTitle.textContent = 'Account Settings';
            document.querySelectorAll('#settingsNavbar .nav-link').forEach(link => {
              if (link.dataset.tab === 'settings') {
                link.click();
              }
            });

            // Scroll to specific section
            setTimeout(() => {
              const sectionMap = {
                'avatar': '.settings-card:nth-child(1)',
                'user-info': '.settings-card:nth-child(2)',
                'notifications': '.settings-card:nth-child(3)',
                'statistics': '.settings-card:nth-child(4)'
              };

              if (sectionMap[section]) {
                const targetSection = document.querySelector(sectionMap[section]);
                if (targetSection) {
                  targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
              }
            }, 100);
          }
        });
      });

      // ==========================================
      // AVATAR UPLOAD
      // ==========================================

      const avatarUpload = document.getElementById('avatarUpload');
      const avatarDisplay = document.getElementById('avatarDisplay');
      const deleteAvatarBtn = document.getElementById('deleteAvatarBtn');
      let currentAvatar = null;

      if (avatarUpload) {
        avatarUpload.addEventListener('change', async function(e) {
          const file = e.target.files[0];
          if (file && file.type.startsWith('image/')) {
            if (!currentUser) {
              alert('Please log in to upload an avatar');
              return;
            }

            try {
              // Show preview immediately
              const reader = new FileReader();
              reader.onload = function(event) {
                avatarDisplay.style.background = 'none';
                avatarDisplay.innerHTML = `<img src="${event.target.result}" alt="Avatar">`;
              };
              reader.readAsDataURL(file);

              // Upload to Supabase
              const fileExt = file.name.split('.').pop();
              const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;

              console.log('ðŸ“¤ Uploading avatar for:', currentUser.username);

              const { data: uploadData, error: uploadError } = await supabase.storage
                .from('avatars')
                .upload(fileName, file, {
                  cacheControl: '3600',
                  upsert: true
                });

              if (uploadError) {
                console.error('âŒ Upload error:', uploadError);
                alert('Upload failed: ' + uploadError.message);
                return;
              }

              // Get public URL
              const { data: { publicUrl } } = supabase.storage
                .from('avatars')
                .getPublicUrl(fileName);

              console.log('âœ… Avatar uploaded:', publicUrl);

              // Update database
              const { error: updateError } = await supabase
                .from('profiles')
                .update({ avatar_url: publicUrl })
                .eq('id', currentUser.id);

              if (updateError) {
                console.error('âŒ Database update error:', updateError);
                alert('Failed to update profile');
                return;
              }

              // Update currentUser
              currentUser.avatar_url = publicUrl;
              localStorage.setItem('avatarUrl', publicUrl);

              // Update all UI elements
              updateUIForUser(currentUser);

              console.log('âœ… Avatar updated successfully');
            } catch (err) {
              console.error('âŒ Upload failed:', err);
              alert('Upload failed: ' + err.message);
            }
          }
        });
      }

      if (deleteAvatarBtn) {
        deleteAvatarBtn.addEventListener('click', async function() {
          if (!confirm('Are you sure you want to delete your avatar?')) {
            return;
          }

          if (!currentUser) {
            alert('Please log in');
            return;
          }

          try {
            // Update database to remove avatar
            const { error: updateError } = await supabase
              .from('profiles')
              .update({ avatar_url: null })
              .eq('id', currentUser.id);

            if (updateError) {
              console.error('âŒ Database update error:', updateError);
              alert('Failed to delete avatar');
              return;
            }

            // Update UI
            currentUser.avatar_url = null;
            localStorage.removeItem('avatarUrl');

            avatarDisplay.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            avatarDisplay.innerHTML = '';

            // Update all UI elements
            updateUIForUser(currentUser);

            console.log('âœ… Avatar deleted successfully');
          } catch (err) {
            console.error('âŒ Delete failed:', err);
            alert('Delete failed: ' + err.message);
          }
        });
      }

      // Avatar is loaded from currentUser.avatar_url in updateUIForUser()
      // No need for separate loadSavedAvatar function

      // ==========================================
      // NOTIFICATIONS SAVE
      // ==========================================

      const phoneInput = document.getElementById('phoneInput');
      const emailInput = document.getElementById('emailInput');
      const saveNotificationsBtn = document.getElementById('saveNotificationsBtn');

      function loadNotificationSettings() {
        const savedPhone = localStorage.getItem('userPhone');
        const savedEmail = localStorage.getItem('userEmail');

        if (savedPhone && phoneInput) phoneInput.value = savedPhone;
        if (savedEmail && emailInput) emailInput.value = savedEmail;
      }

      if (saveNotificationsBtn) {
        saveNotificationsBtn.addEventListener('click', function() {
          const phone = phoneInput ? phoneInput.value.trim() : '';
          const email = emailInput ? emailInput.value.trim() : '';

          if (email && !email.includes('@')) {
            alert('Please enter a valid email address');
            return;
          }

          localStorage.setItem('userPhone', phone);
          localStorage.setItem('userEmail', email);

          const originalText = saveNotificationsBtn.textContent;
          saveNotificationsBtn.textContent = 'Saved âœ“';
          saveNotificationsBtn.style.background = '#10b981';

          setTimeout(() => {
            saveNotificationsBtn.textContent = originalText;
            saveNotificationsBtn.style.background = '';
          }, 2000);
        });
      }

      loadNotificationSettings();

      // ==========================================
      // VIEW SWITCHING WITH NAVBAR
      // ==========================================

      function switchView(viewName) {
        // Hide all sections
        document.querySelectorAll('section[id$="-section"]').forEach(section => {
          section.style.display = 'none';
          section.classList.remove('active');
        });

        // Show selected section
        const sectionElement = document.getElementById(viewName + '-section');
        if (sectionElement) {
          sectionElement.style.display = 'block';
          sectionElement.classList.add('active');
        }

        // Switch navbar based on view (Desktop only)
        if (window.innerWidth > 768) {
          if (viewName === 'accountSettings') {
            if (mainNavbar) mainNavbar.style.display = 'none';
            if (settingsNavbar) settingsNavbar.style.display = 'flex';
          } else {
            if (mainNavbar) mainNavbar.style.display = 'flex';
            if (settingsNavbar) settingsNavbar.style.display = 'none';

            // Update main navbar active state
            document.querySelectorAll('#mainNavbar .nav-link').forEach(link => {
              link.classList.remove('active');
              if (link.dataset.view === viewName) {
                link.classList.add('active');
              }
            });
          }
        }

        // Close dropdowns
        document.querySelectorAll('.profile-dropdown, .notifications-dropdown, .feedback-dropdown').forEach(dropdown => {
          dropdown.classList.remove('active');
        });
      }

      // Initialize auth
      initAuth();
    });
  </script>

  <!-- Image Modal for Reference Images -->
  <div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <span class="image-modal-close">&times;</span>
    <img id="modalImage" src="" alt="Reference Image">
  </div>

  <!-- Mobile Footer Navigation -->
  <div class="mobile-footer-nav">
    <div class="mobile-nav-item active" data-mobile-view="dashboard">
      <svg class="mobile-nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="3" y="3" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.5"/>
        <rect x="13" y="3" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.5"/>
        <rect x="3" y="13" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.5"/>
        <rect x="13" y="13" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.5"/>
      </svg>
      <span class="mobile-nav-label">Dashboard</span>
    </div>

    <div class="mobile-nav-item" data-mobile-view="calendar">
      <svg class="mobile-nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="1.5"/>
        <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span class="mobile-nav-label">Calendar</span>
    </div>

    <div class="mobile-nav-item" data-mobile-view="dienstplan">
      <svg class="mobile-nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="mobile-nav-label">Dienstplan</span>
    </div>

    <div class="mobile-nav-item" data-mobile-view="profile">
      <svg class="mobile-nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="1.5"/>
        <path d="M20 20C20 16.134 16.418 13 12 13C7.582 13 4 16.134 4 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span class="mobile-nav-label">Profile</span>
    </div>
  </div>

</body>
</html><!-- VERSION: v80 - Fixed origin mapping to match actual database values -->
