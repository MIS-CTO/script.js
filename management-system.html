<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Management System v77</title>
  
  <!-- iOS Web App Configuration -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Management System">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ“Š</text></svg>">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* ========================================
       macOS Light Mode Frosted Glass - CSS Variables
       ======================================== */
    :root {
      /* Backgrounds - Light Mode Frosted Glass */
      --macos-bg: #f5f5f7;
      --macos-panel: rgba(255, 255, 255, 0.7);
      --macos-elevated: rgba(255, 255, 255, 0.85);
      --macos-nav-bg: rgba(251, 251, 253, 0.72);

      /* Text Colors - Always Dark in Light Mode */
      --macos-text-primary: #1d1d1f;
      --macos-text-secondary: #86868b;
      --macos-text-tertiary: #a1a1a6;
      --macos-placeholder: #86868b;

      /* Accent Colors */
      --macos-accent-blue: #0071e3;
      --macos-accent-green: #34c759;
      --macos-accent-red: #ff3b30;
      --macos-accent-orange: #ff9500;
      --macos-accent-purple: #5856d6;

      /* System Fills - Light Mode */
      --macos-fill-primary: rgba(120, 120, 128, 0.20);
      --macos-fill-secondary: rgba(120, 120, 128, 0.16);
      --macos-fill-tertiary: rgba(120, 120, 128, 0.12);
      --macos-fill-quaternary: rgba(120, 120, 128, 0.08);

      /* Strokes - Enhanced for Light Mode */
      --macos-stroke-primary: rgba(0, 0, 0, 0.08);
      --macos-stroke-secondary: rgba(0, 0, 0, 0.04);

      /* Shadows - Subtle for Light Backgrounds */
      --macos-shadow-small: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
      --macos-shadow-medium: 0 3px 12px rgba(0,0,0,0.07), 0 1px 4px rgba(0,0,0,0.04);
      --macos-shadow-large: 0 10px 40px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);

      /* Frosted Glass Blur Effects */
      --macos-blur-strong: saturate(180%) blur(20px);
      --macos-blur-medium: saturate(160%) blur(15px);
      --macos-blur-light: saturate(140%) blur(10px);

      /* Border Radius System */
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 10px;
      --radius-xl: 12px;
      --radius-pill: 999px;

      /* Spacing System (8pt grid) */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 24px;
      --space-2xl: 32px;
      --space-3xl: 48px;

      /* Location Colors (preserved) */
      --location-primary: #43A047;
      --location-light: #E8F5E9;
      --location-dark: #2E7D32;
      --location-accent: #66BB6A;

      /* Legacy aliases for compatibility */
      --bg: var(--macos-bg);
      --ink: var(--macos-text-primary);
      --muted: var(--macos-text-secondary);
      --panel: var(--macos-panel);
      --stroke: var(--macos-stroke-primary);
      --brand: var(--macos-text-primary);
      --brand-ink: #ffffff;
      --accent: var(--macos-accent-blue);
      --radius: var(--radius-xl);
      --shadow: var(--macos-shadow-medium);
    }

    /* FORCE LIGHT MODE EVERYWHERE - Disable Dark Mode */
    @media (prefers-color-scheme: dark) {
      :root {
        /* Override dark mode - keep everything light */
        --macos-bg: #f5f5f7 !important;
        --macos-panel: rgba(255, 255, 255, 0.7) !important;
        --macos-elevated: rgba(255, 255, 255, 0.85) !important;
        --macos-nav-bg: rgba(251, 251, 253, 0.72) !important;
        --macos-text-primary: #1d1d1f !important;
        --macos-text-secondary: #86868b !important;
        --macos-text-tertiary: #a1a1a6 !important;
        --macos-stroke-primary: rgba(0, 0, 0, 0.08) !important;
        --macos-stroke-secondary: rgba(0, 0, 0, 0.04) !important;
      }
    }

    /* ========================================
       Force Light Mode on All Elements
       ======================================== */
    * {
      color-scheme: light !important;
    }

    html, body {
      background: var(--macos-bg) !important;
      color: var(--macos-text-primary) !important;
      color-scheme: light !important;
    }

    /* Emergency override for any dark backgrounds */
    [style*="background: rgb(28"],
    [style*="background: #1"],
    [style*="background: #2"],
    [style*="background: #3"] {
      background: var(--macos-panel) !important;
      color: var(--macos-text-primary) !important;
    }
    /* ========================================
       macOS Typography System
       ======================================== */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: var(--macos-bg);
      color: var(--macos-text-primary);
      margin: 0;
      font-size: 13px;
      line-height: 1.47;
      font-weight: 400;
      letter-spacing: -0.008em;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    /* Typography Styles */
    h1, .text-title-1 {
      font-size: 22px;
      line-height: 1.27;
      font-weight: 600;
      letter-spacing: -0.022em;
      color: var(--macos-text-primary);
    }

    h2, .text-title-2 {
      font-size: 17px;
      line-height: 1.29;
      font-weight: 600;
      letter-spacing: -0.018em;
      color: var(--macos-text-primary);
    }

    h3, .text-title-3 {
      font-size: 15px;
      line-height: 1.33;
      font-weight: 600;
      letter-spacing: -0.014em;
      color: var(--macos-text-primary);
    }

    .text-headline {
      font-size: 13px;
      line-height: 1.38;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .text-body {
      font-size: 13px;
      line-height: 1.47;
      font-weight: 400;
      letter-spacing: -0.008em;
    }

    .text-callout {
      font-size: 12px;
      line-height: 1.42;
      font-weight: 400;
      letter-spacing: -0.006em;
    }

    .text-subheadline {
      font-size: 11px;
      line-height: 1.36;
      font-weight: 400;
      letter-spacing: 0.0017em;
    }

    .text-footnote, .text-caption-1 {
      font-size: 10px;
      line-height: 1.40;
      font-weight: 400;
      letter-spacing: 0em;
    }

    .text-caption-2 {
      font-size: 9px;
      line-height: 1.33;
      font-weight: 400;
      letter-spacing: 0.0013em;
    }
    /* ========================================
       Navigation Bar - Frosted Glass
       ======================================== */
    nav {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      gap: 18px;
      align-items: center;
      background: var(--macos-nav-bg) !important;
      backdrop-filter: var(--macos-blur-strong);
      -webkit-backdrop-filter: var(--macos-blur-strong);
      padding: 12px 24px;
      border-bottom: 1px solid var(--macos-stroke-primary);
      height: 52px;
    }

    nav a {
      color: var(--macos-text-primary) !important;
      text-decoration: none;
      font-weight: 500;
      font-size: 13px;
      padding: 6px 8px;
      border-bottom: 2px solid transparent;
      opacity: 0.75;
      cursor: pointer;
      transition: opacity 0.2s ease, border-color 0.2s ease;
      letter-spacing: -0.008em;
    }

    nav a:hover {
      opacity: 1;
    }

    nav a.active {
      border-color: var(--macos-text-primary);
      opacity: 1;
      font-weight: 600;
    }
    /* ========================================
       Sections & Content Areas - Light Mode
       ======================================== */
    section {
      display: none;
      padding: 24px 5vw;
      max-width: 100%;
      margin: 0 auto;
    }

    section.active {
      display: block;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.022em;
      color: var(--macos-text-primary) !important;
    }

    /* ========================================
       Badges - Light with Colored Accents
       ======================================== */
    .badge {
      background: rgba(255, 255, 255, 0.9) !important;
      border: 1px solid var(--macos-stroke-primary);
      border-radius: 12px;
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 500;
      color: var(--macos-text-primary) !important;
      box-shadow: var(--macos-shadow-small);
      display: inline-block;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    /* Badge variants */
    .badge-resident,
    .badge-active {
      background: rgba(52, 199, 89, 0.15) !important;
      color: #1d6b2e !important;
      border-color: rgba(52, 199, 89, 0.3);
    }
    .calendar-controls {
      display:flex; gap:12px; margin-bottom:16px; align-items:center; flex-wrap:wrap;
    }
    /* ========================================
       Buttons - macOS Style
       ======================================== */
    .btn, .btn-primary {
      background: var(--macos-accent-blue);
      color: #ffffff;
      border: none;
      padding: 8px 20px;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.1s ease;
      letter-spacing: -0.008em;
      box-shadow: var(--macos-shadow-small);
      font-family: inherit;
    }

    .btn-primary:hover, .btn:hover {
      background: #0077ed;
      transform: translateY(-0.5px);
      box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
    }

    .btn-primary:active, .btn:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      background: var(--macos-fill-quaternary);
      color: var(--macos-text-primary);
      border: 1px solid var(--macos-stroke-primary);
      padding: 8px 20px;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease;
      letter-spacing: -0.008em;
      font-family: inherit;
    }

    .btn-secondary:hover {
      background: var(--macos-fill-tertiary);
    }

    .btn-nav {
      background: var(--macos-fill-tertiary);
      color: var(--macos-text-primary);
      border: none;
      padding: 7px 16px;
      border-radius: var(--radius-pill);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease;
      letter-spacing: -0.008em;
      font-family: inherit;
    }

    .btn-nav:hover {
      background: var(--macos-fill-secondary);
    }

    .btn-danger {
      background: var(--macos-accent-red);
      color: #ffffff;
      border: none;
      padding: 8px 20px;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease;
      font-family: inherit;
    }

    .btn-danger:hover {
      background: #ff453a;
    }

    /* ========================================
       Form Inputs - Frosted Glass
       ======================================== */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="search"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    select,
    textarea {
      padding: 8px 12px;
      border: 1px solid var(--macos-stroke-primary);
      border-radius: var(--radius-md);
      font-size: 13px;
      font-family: inherit;
      background: var(--macos-elevated) !important;
      color: var(--macos-text-primary) !important;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      letter-spacing: -0.008em;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--macos-accent-blue);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--macos-placeholder) !important;
      opacity: 1 !important;
    }

    /* Search bars - White with dark text */
    input[type="search"] {
      background: var(--macos-elevated) !important;
      border: 1px solid var(--macos-stroke-primary);
      color: var(--macos-text-primary) !important;
      border-radius: var(--radius-pill);
    }
    /* ========================================
       Tables - Frosted Glass
       ======================================== */
    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--macos-stroke-primary);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--macos-elevated);
      backdrop-filter: var(--macos-blur-medium);
      -webkit-backdrop-filter: var(--macos-blur-medium);
      box-shadow: var(--macos-shadow-medium);
    }

    thead {
      background: #f5f5f7 !important;
    }

    th {
      text-align: left;
      padding: 10px 16px;
      border-bottom: 1px solid var(--macos-stroke-primary);
      font-weight: 600;
      font-size: 11px;
      color: #6e6e73 !important;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    td {
      text-align: left;
      padding: 12px 16px;
      border-bottom: 1px solid var(--macos-stroke-secondary);
      font-size: 13px;
      color: var(--macos-text-primary) !important;
      background: rgba(255, 255, 255, 0.6);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover td {
      background: rgba(0, 0, 0, 0.02);
    }
    /* ========================================
       Calendar Container - Frosted Glass
       ======================================== */
    .calendar-container {
      background: var(--macos-panel) !important;
      backdrop-filter: var(--macos-blur-medium);
      -webkit-backdrop-filter: var(--macos-blur-medium);
      border: 1px solid var(--macos-stroke-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--macos-shadow-medium);
      overflow: auto;
      width: 100%;
    }
    .calendar-grid {
      display:grid; grid-template-columns:120px repeat(22, 1fr); min-width:100%;
    }
    .calendar-header { display:contents; }
    .slot-header {
      background:#F5F5F7; color:#1d1d1f; padding:14px; font-weight:600;
      text-align:center; border-bottom:1px solid rgba(0,0,0,0.1);
      border-right:1px solid rgba(0,0,0,0.1); position:sticky; left:0; z-index:10;
      min-height:56px; display:flex; align-items:center; justify-content:center;
      grid-column:1/2; font-size:14px; letter-spacing:-0.01em;
    }
    .hour-header {
      background:#F5F5F7; color:#86868b; padding:12px; font-weight:500;
      text-align:center; border-right:none; border-bottom:1px solid rgba(0,0,0,0.1);
      min-height:56px; display:flex; align-items:center; justify-content:center;
      font-size:13px; letter-spacing:-0.01em;
    }
    .slot-row { display:contents; }
    .slot-label {
      background:rgba(255,255,255,0.98);
      padding:14px;
      font-weight:500;
      border-right:1px solid rgba(0,0,0,0.08);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      left:0;
      z-index:5;
      min-height:100px;
      display:flex;
      align-items:center;
      justify-content:center;
      grid-column:1;
      font-size:13px;
      color:#86868b;
    }
    .slot-label.empty {
      min-height:40px;
      background:rgba(240,240,240,0.98);
      color:#999;
      font-size:12px;
      font-weight:400;
    }
    .slot-label.empty .slot-number {
      font-weight:500;
      color:#666;
    }
    .slot-label.empty .empty-text {
      margin-left:6px;
      font-style:italic;
    }
    .category-header {
      background:#F5F5F7; color:#1d1d1f; padding:12px 14px; font-weight:600;
      border-right:1px solid rgba(0,0,0,0.1); border-bottom:1px solid rgba(0,0,0,0.1);
      position:sticky; left:0; z-index:6; min-height:48px;
      display:flex; align-items:center; justify-content:flex-start; grid-column:1/2;
      font-size:14px; letter-spacing:-0.01em;
    }
    .category-spacer {
      background:#FAFAFA; border-right:none; border-bottom:1px solid rgba(0,0,0,0.06);
      min-height:48px;
    }
    .slot-cell {
      border-bottom:1px solid rgba(0,0,0,0.06);
      border-right:1px solid rgba(0,0,0,0.06);
      min-height:100px;
      padding:6px;
      position:relative;
      background:rgba(255,255,255,0.8);
      transition:background 0.15s ease;
    }
    .slot-cell.empty-slot {
      min-height:50px;
      background:rgba(245,245,245,0.6);
      cursor:default;
    }
    .slot-cell.empty-slot:hover {
      background:rgba(245,245,245,0.6);
    }
    .slot-row.empty-row .slot-label {
      min-height:50px;
      background:rgba(249,249,249,0.5);
      color:var(--muted);
      font-size:12px;
    }
    .slot-row.empty-row .slot-label::after {
      content: " - Empty";
      font-weight:400;
      font-size:11px;
      color:#999;
      margin-left:4px;
    }
    .slot-row.empty-row .slot-cell {
      min-height:50px;
    }
    .slot-cell.half-hour { border-right:1px solid rgba(0,0,0,0.04); }
    .slot-cell:hover { background:rgba(0,113,227,0.02); }
    .event {
      background:rgba(255,255,255,0.95);
      color:#1d1d1f;
      padding:8px 10px;
      border-radius:6px;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.2s ease;
      word-break:break-word;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:flex-start;
      border-left:4px solid var(--location-primary);
      box-shadow:0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
      overflow:hidden;
      line-height:1.3;
    }
    .event:hover {
      box-shadow:0 4px 12px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.06);
      transform:translateY(-1px);
      z-index:10;
    }
    .event.guest {
      border-left-color:#42A5F5;
    }
    .event.resident {
      border-left-color:var(--location-primary);
    }
    .event.events {
      border-left-color:#5856D6;
    }
    
    /* Booking Type Colors - Light backgrounds with colored borders */
    .event[data-type="consultation"] {
      background:rgba(102, 187, 106, 0.15);
      border-left-color:#43A047;
    }
    .event[data-type="new_tattoo"] {
      background:rgba(236, 64, 122, 0.15);
      border-left-color:#C2185B;
    }
    .event[data-type="continuing_tattoo"] {
      background:rgba(66, 165, 245, 0.15);
      border-left-color:#1976D2;
    }
    .event[data-type="touch_up"] {
      background:rgba(255, 235, 59, 0.25);
      border-left-color:#FBC02D;
    }
    .event[data-type="selfbooking"] {
      background:rgba(141, 110, 99, 0.15);
      border-left-color:#5D4037;
    }
    .event[data-type="wannado"] {
      background:rgba(171, 71, 188, 0.15);
      border-left-color:#7B1FA2;
    }
    .event[data-type="internal"] {
      background:rgba(239, 83, 80, 0.15);
      border-left-color:#C62828;
    }
    .event[data-type="move"] {
      background:rgba(38, 198, 218, 0.15);
      border-left-color:#00838F;
    }
    .event[data-type="reserved"] {
      background:rgba(120, 144, 156, 0.15);
      border-left-color:#455A64;
    }
    .event[data-type="no_show"] {
      background:rgba(189, 189, 189, 0.1);
      border-left-color:#757575;
    }
    
    /* ========================================
       Dienstplan Grid - Frosted Glass
       ======================================== */
    .dienstplan-grid {
      background: var(--macos-panel) !important;
      backdrop-filter: var(--macos-blur-medium);
      -webkit-backdrop-filter: var(--macos-blur-medium);
      border: 1px solid var(--macos-stroke-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--macos-shadow-medium);
      overflow: auto;
    }
    
    .category-section {
      border-bottom:1px solid rgba(0,0,0,0.06);
    }
    
    .category-section:last-child {
      border-bottom:none;
    }
    
    .category-header-btn {
      width:100%;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      background:#f5f5f5;
      color:#1d1d1f;
      border:none;
      padding:12px 16px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:background 0.2s ease;
      font-family:inherit;
      text-align:left;
    }
    
    .category-header-btn:hover {
      background:#e8e8e8;
    }
    
    .category-header-btn .arrow {
      margin-right:8px;
      transition:transform 0.3s ease;
      font-size:12px;
      display:inline-block;
      width:16px;
    }
    
    .category-header-btn.active .arrow {
      transform:rotate(90deg);
    }
    
    .category-content {
      display:none;
    }
    
    .category-content.active {
      display:block;
    }
    
    .person-row-container {
      display:contents;
    }
    
    .dienstplan-table {
      width:100%;
      display:grid;
      grid-template-columns:150px repeat(31, 80px);
      border-collapse:collapse;
    }
    
    .dp-header-row {
      display:contents;
    }
    
    .dp-name-header {
      background:rgba(249,249,249,0.98);
      padding:12px;
      font-weight:600;
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      left:0;
      z-index:5;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      font-size:13px;
      color:#666;
      background:rgba(255,255,255,0.98);
    }
    
    .dp-day-header {
      background:var(--location-light);
      padding:8px 4px;
      font-weight:400;
      text-align:center;
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      font-size:11px;
      min-height:50px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
    }
    
    .dp-day-header .weekday {
      font-weight:500;
      color:#666;
      font-size:10px;
    }
    
    .dp-day-header .day-num {
      font-size:13px;
      font-weight:600;
      color:#1d1d1f;
    }
    
    .dp-row {
      display:contents;
    }
    
    .dp-name-cell {
      background:rgba(255,255,255,0.98);
      padding:10px 12px 10px 32px;
      font-weight:400;
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      left:0;
      z-index:4;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      font-size:13px;
      color:#1d1d1f;
    }
    
    .dp-cell {
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      min-height:40px;
      background:rgba(255,255,255,0.8);
      transition:background 0.15s ease;
      cursor:pointer;
    }
    
    .dp-cell:hover {
      background:rgba(0,113,227,0.04);
    }
    
    .dp-cell.working {
      background:var(--location-accent);
    }
    
    .dp-cell.off {
      background:#FFEBEE;
    }
    
    .dp-cell.vacation {
      background:#FFF3E0;
    }
    
    /* Apple-style Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 51px;
      height: 31px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e5e5ea;
      transition: .3s;
      border-radius: 15.5px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 27px;
      width: 27px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 27px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 3px 1px rgba(0,0,0,0.06);
    }
    
    input:checked + .toggle-slider {
      background-color: #34c759;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    
    .current-time-indicator {
      position: absolute;
      top: 100px;
      bottom: 0;
      width: 2px;
      background: #ff3b30;
      z-index: 20;
      pointer-events: none;
    }
    
    .current-time-indicator::before {
      content: '';
      position: absolute;
      left: -3px;
      top: 0;
      width: 8px;
      height: 8px;
      background: #ff3b30;
      border-radius: 50%;
    }
    
    /* ========================================
       Modals & Dialogs - Frosted Glass Overlay
       ======================================== */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-backdrop.active {
      display: flex;
      opacity: 1;
    }

    .modal {
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: var(--macos-blur-strong);
      -webkit-backdrop-filter: var(--macos-blur-strong);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--macos-shadow-large);
      transform: scale(0.95);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-backdrop.active .modal {
      transform: scale(1);
    }

    .modal h3 {
      color: var(--macos-text-primary) !important;
      font-weight: 600;
      font-size: 17px;
      letter-spacing: -0.018em;
      margin: 0 0 var(--space-lg);
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .form-group label {
      font-size: 13px;
      font-weight: 500;
      color: var(--macos-text-secondary);
      letter-spacing: -0.008em;
    }

    .modal-actions {
      display: flex;
      gap: var(--space-md);
      justify-content: flex-end;
      margin-top: var(--space-xl);
    }
    
    .btn {
      padding:10px 20px;
      border-radius:8px;
      border:none;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.2s ease;
      font-family:inherit;
    }
    
    .btn-primary {
      background:var(--accent);
      color:white;
    }
    
    .btn-primary:hover {
      background:#0077ED;
    }
    
    .btn-secondary {
      background:#f5f5f5;
      color:var(--ink);
    }
    
    .btn-secondary:hover {
      background:#e5e5e5;
    }
    
    .btn-danger {
      background:#ff3b30;
      color:white;
    }
    
    .btn-danger:hover {
      background:#ff2d20;
    }
    
    .btn-icon {
      background:transparent;
      border:none;
      cursor:pointer;
      padding:6px;
      border-radius:6px;
      color:var(--muted);
      transition:all 0.2s ease;
      font-size:16px;
    }
    
    .btn-icon:hover {
      background:rgba(0,0,0,0.05);
      color:var(--ink);
    }
    
    /* Artist List Styles */
    .artist-list {
      list-style:none;
      padding:0;
      margin:16px 0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .artist-item {
      background:white;
      border:1px solid rgba(0,0,0,0.06);
      border-radius:10px;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition:all 0.2s ease;
    }
    
    .artist-item:hover {
      border-color:rgba(0,0,0,0.12);
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
    }
    
    .artist-info {
      display:flex;
      align-items:center;
      gap:12px;
      flex:1;
    }
    
    .artist-name {
      font-weight:500;
      font-size:15px;
    }
    
    .artist-badge {
      background:var(--location-light);
      color:var(--location-dark);
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:500;
    }
    
    .artist-badge.guest {
      background:#e3f2fd;
      color:#1565c0;
    }
    
    .artist-location {
      background:#FFF3E0;
      color:#E65100;
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:500;
    }
    
    .artist-rank {
      background:#F3E5F5;
      color:#7B1FA2;
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:500;
    }
    
    .customer-rank {
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:600;
    }
    
    .customer-rank.bronze {
      background:#D7CCC8;
      color:#4E342E;
    }
    
    .customer-rank.silver {
      background:#E0E0E0;
      color:#424242;
    }
    
    .customer-rank.gold {
      background:#FFF9C4;
      color:#F57F17;
    }
    
    .customer-rank.platinum {
      background:#E1F5FE;
      color:#01579B;
    }
    
    /* Sort Controls */
    .sort-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }
    
    .artist-instagram {
      color:var(--muted);
      font-size:13px;
      margin-left:8px;
    }
    
    .artist-actions {
      display:flex;
      gap:4px;
    }
    
    /* Customer Table Styles */
    /* Artist Table Styles */
    #artistsTable tbody tr {
      transition:background 0.15s ease;
    }
    
    #artistsTable tbody tr:hover {
      background:rgba(0,113,227,0.02);
    }
    #customersTable tbody tr {
      transition:background 0.15s ease;
    }
    
    #customersTable tbody tr:hover {
      background:rgba(0,113,227,0.02);
    }
    /* Artists Table Styles */
    #artistsTable tbody tr {
      transition:background 0.15s ease;
    }
    
    #artistsTable tbody tr:hover {
      background:rgba(0,113,227,0.02);
    }
    
    
    /* Responsive */
    @media (max-width: 768px) {
      .artist-item {
        flex-direction:column;
        align-items:flex-start;
        gap:12px;
      }
      
      .artist-actions {
        width:100%;
        justify-content:flex-end;
      }
    }
    
    /* Request Management Styles */
    .request-item {
      padding:16px;
      border-radius:10px;
      margin-bottom:8px;
      cursor:pointer;
      transition:all 0.2s;
      border:1px solid rgba(0,0,0,0.06);
      background:white;
    }
    .request-item:hover {
      background:rgba(0,113,227,0.04);
      border-color:var(--accent);
      transform:translateX(2px);
    }
    .request-item.active {
      background:rgba(0,113,227,0.08);
      border-color:var(--accent);
      box-shadow:0 2px 8px rgba(0,113,227,0.15);
    }
    .request-item.new-status {
      background:#fff3cd;
      border-color:#ffc107;
    }
    .request-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .request-id {
      font-size:11px;
      color:var(--muted);
      font-weight:600;
      font-family:monospace;
    }
    .request-badge {
      padding:4px 10px;
      border-radius:12px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .request-badge.open_request { background:#dc3545; color:white; }
    .request-badge.pending { background:#ffc107; color:#000; }
    .request-badge.scheduled { background:#28a745; color:white; }
    .request-badge.finished { background:#6c757d; color:white; }
    .request-badge.canceled { background:#dc3545; color:white; }

    /* Priority Badges */
    .priority-badge {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 10px;
      border-radius:12px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .priority-badge.urgent {
      background:#FEE2E2;
      color:#991B1B;
    }
    .priority-badge.high {
      background:#FED7AA;
      color:#9A3412;
    }
    .priority-badge.normal {
      background:#D1FAE5;
      color:#065F46;
    }
    .priority-badge.low {
      background:#F3F4F6;
      color:#6B7280;
    }

    /* Reference Images */
    .reference-images {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .reference-image-thumb {
      width:80px;
      height:80px;
      border-radius:8px;
      overflow:hidden;
      cursor:pointer;
      border:2px solid rgba(0,0,0,0.06);
      transition:all 0.2s;
    }
    .reference-image-thumb:hover {
      transform:scale(1.05);
      border-color:var(--accent);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .reference-image-thumb img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    /* Image Upload Area */
    .image-upload-area {
      border:2px dashed rgba(0,0,0,0.15);
      border-radius:12px;
      padding:32px;
      text-align:center;
      background:rgba(0,113,227,0.03);
      transition:all 0.3s;
      cursor:pointer;
      margin-top:12px;
    }
    .image-upload-area:hover {
      border-color:var(--accent);
      background:rgba(0,113,227,0.08);
    }
    .image-upload-area.drag-over {
      border-color:var(--accent);
      background:rgba(0,113,227,0.15);
      transform:scale(1.02);
    }
    .image-upload-icon {
      font-size:48px;
      margin-bottom:12px;
      opacity:0.6;
    }
    .image-upload-text {
      font-size:14px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .image-upload-hint {
      font-size:12px;
      color:var(--muted);
      opacity:0.7;
    }

    /* Editable Reference Images */
    .reference-images-editable {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .reference-image-editable {
      position:relative;
      width:120px;
      height:120px;
      border-radius:12px;
      overflow:hidden;
      border:2px solid rgba(0,0,0,0.1);
      transition:all 0.2s;
    }
    .reference-image-editable:hover {
      border-color:var(--accent);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .reference-image-editable img {
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .reference-image-delete {
      position:absolute;
      top:6px;
      right:6px;
      width:28px;
      height:28px;
      border-radius:50%;
      background:rgba(220,53,69,0.95);
      color:white;
      border:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      font-weight:bold;
      opacity:0;
      transition:all 0.2s;
      backdrop-filter:blur(10px);
    }
    .reference-image-editable:hover .reference-image-delete {
      opacity:1;
    }
    .reference-image-delete:hover {
      background:rgba(220,53,69,1);
      transform:scale(1.1);
    }

    /* No Data Placeholder */
    .no-data-placeholder {
      color:#9ca3af;
      font-size:13px;
      font-style:italic;
    }

    /* Image Modal */
    .image-modal {
      display:none;
      position:fixed;
      z-index:10000;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.9);
      align-items:center;
      justify-content:center;
    }
    .image-modal.active {
      display:flex;
    }
    .image-modal img {
      max-width:90%;
      max-height:90%;
      border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,0.5);
    }
    .image-modal-close {
      position:absolute;
      top:20px;
      right:20px;
      font-size:40px;
      color:white;
      cursor:pointer;
      background:rgba(0,0,0,0.5);
      width:50px;
      height:50px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background 0.2s;
    }
    .image-modal-close:hover {
      background:rgba(0,0,0,0.8);
    }

    /* Artist Preference List */
    .artist-preference-list {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .artist-preference-item {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 10px;
      background:rgba(0,113,227,0.1);
      color:var(--accent);
      border-radius:12px;
      font-size:12px;
      font-weight:600;
    }

    /* Artist Preference Tags */
    .artist-preference-tags {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
    }
    .artist-tag {
      display:inline-block;
      padding:6px 12px;
      background:#f3f4f6;
      border:1px solid #d1d5db;
      border-radius:6px;
      font-size:13px;
      font-weight:600;
      color:#374151;
    }
    .artist-tag-small {
      display:inline-block;
      padding:4px 10px;
      background:#f3f4f6;
      border:1px solid #d1d5db;
      border-radius:6px;
      font-size:11px;
      font-weight:600;
      color:#374151;
    }

    .request-name {
      font-size:15px;
      font-weight:600;
      margin-bottom:4px;
      color:var(--ink);
    }
    .request-date {
      font-size:12px;
      color:var(--muted);
    }
    
    /* Request Detail Styles */
    .detail-section {
      margin-bottom:32px;
    }
    .detail-section h3 {
      font-size:18px;
      font-weight:600;
      margin-bottom:16px;
      color:var(--ink);
      border-bottom:2px solid rgba(0,0,0,0.06);
      padding-bottom:8px;
    }
    .detail-grid {
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:16px;
    }
    .detail-item {
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .detail-label {
      font-size:11px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.8px;
    }
    .detail-value {
      font-size:15px;
      color:var(--ink);
      font-weight:500;
    }
    .action-buttons {
      display:flex;
      gap:12px;
      margin-top:32px;
      padding-top:24px;
      border-top:1px solid rgba(0,0,0,0.06);
      flex-wrap:wrap;
    }
    .btn {
      padding:12px 24px;
      border-radius:10px;
      border:none;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      font-family:inherit;
    }
    .btn-primary {
      background:var(--accent);
      color:white;
    }
    .btn-primary:hover {
      background:#0077ed;
      box-shadow:0 4px 12px rgba(0,113,227,0.3);
      transform:translateY(-1px);
    }
    .btn-success {
      background:#28a745;
      color:white;
    }
    .btn-success:hover {
      background:#218838;
      box-shadow:0 4px 12px rgba(40,167,69,0.3);
      transform:translateY(-1px);
    }
    .btn-danger {
      background:#dc3545;
      color:white;
    }
    .btn-danger:hover {
      background:#c82333;
      box-shadow:0 4px 12px rgba(220,53,69,0.3);
      transform:translateY(-1px);
    }
    .btn-secondary {
      background:#f5f5f7;
      color:var(--ink);
    }
    .btn-secondary:hover {
      background:#e8e8ed;
    }

    /* Login & Profile Styles */
    .login-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 999999;
      align-items: center;
      justify-content: center;
    }
    .login-backdrop.active {
      display: flex;
    }
    .login-modal {
      background: white;
      border-radius: 16px;
      padding: 40px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
    }
    .login-welcome {
      text-align: center;
      margin-bottom: 32px;
    }
    .login-welcome h2 {
      margin: 0 0 8px 0;
      font-size: 28px;
      font-weight: 600;
    }
    .login-welcome p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }
    .login-form .form-group {
      margin-bottom: 20px;
    }
    .login-form label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--ink);
    }
    .login-form input[type="text"],
    .login-form input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .login-form input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }
    .login-remember {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
    }
    .login-remember input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .login-remember label {
      font-size: 14px;
      cursor: pointer;
      margin: 0;
    }
    .login-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .skip-button {
      background: transparent;
      color: var(--muted);
      border: 1px dashed #ddd;
      text-decoration: none;
      font-size: 13px;
    }
    .skip-button:hover {
      background: #f5f5f5;
      color: var(--ink);
      border-color: #ccc;
    }
    .profile-button {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: #f5f5f7;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 24px;
      color: var(--ink);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: auto;
    }
    .profile-button:hover {
      background: #e8e8ed;
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .profile-button svg {
      width: 20px;
      height: 20px;
    }
    .profile-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(0, 0, 0, 0.1);
    }
    .profile-view {
      max-height: 80vh;
      overflow-y: auto;
    }
    .profile-header {
      text-align: center;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid #eee;
    }
    .profile-avatar-large {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 16px;
      border: 4px solid #f5f5f5;
      display: block;
    }
    .profile-info-group {
      margin-bottom: 20px;
    }
    .profile-info-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .profile-info-value {
      padding: 12px 16px;
      background: #f9f9f9;
      border-radius: 8px;
      font-size: 14px;
      color: var(--ink);
    }
    .profile-role-badge {
      display: inline-block;
      padding: 6px 12px;
      background: var(--accent);
      color: white;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .password-toggle {
      position: relative;
    }
    .password-toggle button {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      padding: 4px 8px;
    }
    .dashboard-welcome {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 32px;
      padding: 24px;
      background: linear-gradient(135deg, var(--accent) 0%, #0066cc 100%);
      border-radius: 16px;
      color: white;
    }
    .dashboard-welcome-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }
    .dashboard-welcome-text h1 {
      margin: 0 0 4px 0;
      font-size: 28px;
      font-weight: 600;
    }
    .dashboard-welcome-text p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }

    /* Customer Rank Badges */
    .rank-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 6px;
      vertical-align: middle;
    }

    .rank-badge.rank-platinum {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #1d1d1f;
      box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
    }

    .rank-badge.rank-gold {
      background: #FF8C00;
      color: white;
      box-shadow: 0 2px 4px rgba(255, 140, 0, 0.3);
    }

    .rank-badge.rank-silver {
      background: #C0C0C0;
      color: #1d1d1f;
      box-shadow: 0 2px 4px rgba(192, 192, 192, 0.3);
    }

    .rank-badge.rank-bronze {
      background: #CD7F32;
      color: white;
      box-shadow: 0 2px 4px rgba(205, 127, 50, 0.3);
    }

    /* Artist Rank Badges */
    .rank-badge.rank-R1 {
      background: #FEE2E2;
      color: #991B1B;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .rank-badge.rank-R2 {
      background: #FED7AA;
      color: #9A3412;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .rank-badge.rank-R3 {
      background: #FEF3C7;
      color: #92400E;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .rank-badge.rank-R4 {
      background: #D1FAE5;
      color: #065F46;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .rank-badge.rank-R5 {
      background: #DBEAFE;
      color: #1E40AF;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    /* Artist Type Badges */
    .type-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    .type-badge.guest {
      background: #E0E7FF;
      color: #3730A3;
    }

    .type-badge.resident {
      background: #D1FAE5;
      color: #065F46;
    }

    /* Status Badges */
    .status-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.active {
      background: #D1FAE5;
      color: #065F46;
    }

    .status-badge.inactive {
      background: #FEE2E2;
      color: #991B1B;
    }

    /* Location Badge */
    .location-badge {
      background: var(--location-light);
      color: var(--location-primary);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    /* Blacklist Badge */
    .blacklist-badge {
      background: #FEE2E2;
      color: #991B1B;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 8px;
      font-weight: 600;
    }

    /* Pagination */
    .pagination-controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      margin-top: 24px;
    }

    .btn-pagination {
      padding: 8px 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .btn-pagination:hover {
      background: var(--location-light);
      border-color: var(--location-primary);
    }

    .btn-pagination.active {
      background: var(--location-primary);
      color: white;
      border-color: var(--location-primary);
      font-weight: 600;
    }

    .pagination-dots {
      color: var(--muted);
      padding: 0 8px;
    }

    /* Filter Select Focus Styles */
    .filter-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }

    /* ========================================
       Analytics Charts - Frosted Glass
       ======================================== */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 24px;
    }

    .chart-card {
      background: var(--macos-panel) !important;
      backdrop-filter: var(--macos-blur-medium);
      -webkit-backdrop-filter: var(--macos-blur-medium);
      border-radius: var(--radius-xl);
      padding: 24px;
      box-shadow: var(--macos-shadow-medium);
      border: 1px solid var(--macos-stroke-primary);
    }

    .chart-card h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--macos-text-primary) !important;
    }

    /* Time Range Tabs */
    .time-range-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .time-tab {
      padding: 8px 16px;
      border: 1px solid var(--stroke);
      background: transparent;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ink);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .time-tab.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .time-tab:hover:not(.active) {
      background: rgba(0, 113, 227, 0.06);
    }

    /* Analytics Filters */
    .analytics-filters {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 16px;
    }

    .analytics-filters select {
      min-width: 200px;
    }

    /* Responsive Charts */
    @media (max-width: 1024px) {
      .charts-grid {
        grid-template-columns: 1fr !important;
      }
    }

    @media (max-width: 768px) {
      .time-range-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .time-tab {
        white-space: nowrap;
      }

      .analytics-filters {
        flex-direction: column;
        align-items: stretch;
      }

      .analytics-filters select {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <nav>
    <a id="tab-dashboard" class="active" href="#dashboard">Dashboard</a>
    <span style="width: 24px;"></span>
    <a id="tab-artists" href="#artists">Artists</a>
    <a id="tab-customers" href="#customers">Customers</a>
    <a id="tab-requests" href="#requests">Requests</a>
    <span style="width: 24px;"></span>
    <a id="tab-calendar" href="#calendar">Calendar</a>
    <span style="width: 24px;"></span>
    <a id="tab-dienstplan" href="#dienstplan">Dienstplan</a>
    <a id="tab-agreements" href="#agreements">Agreements</a>
    <a id="tab-analytics" href="#analytics">Analytics</a>

    <!-- Profile Button -->
    <button class="profile-button" id="profileButton">
      <svg id="profileButtonIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      <span id="profileButtonText">Login</span>
    </button>
  </nav>

  <section id="dashboard-section" class="active">
    <!-- Welcome Banner (shown when logged in) -->
    <div id="dashboardWelcome" class="dashboard-welcome" style="display: none;">
      <img id="dashboardAvatar" class="dashboard-welcome-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23ddd'/%3E%3Ctext x='50' y='65' text-anchor='middle' font-size='40' fill='%23666'%3EðŸ‘¤%3C/text%3E%3C/svg%3E" alt="Avatar">
      <div class="dashboard-welcome-text">
        <h1 id="dashboardWelcomeText">Willkommen</h1>
        <p>SchÃ¶n dich wiederzusehen!</p>
      </div>
    </div>

    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
      <h2 style="margin:0;">Dashboard</h2>
      <span id="versionBadge" style="background:rgba(0,113,227,0.1); color:var(--accent); padding:6px 12px; border-radius:8px; font-size:13px; font-weight:600; font-family:monospace;">v77</span>
    </div>
    <div>
      <span class="badge" id="badge-pending">Pending: â€”</span>
      <span class="badge" id="badge-scheduled">Scheduled: â€”</span>
      <span class="badge" id="badge-residents">Residents: â€”</span>
      <span class="badge" id="badge-guests">Guests: â€”</span>
      <span class="badge" id="badge-agreements-completed">Agreements: â€”</span>
      <span class="badge" id="badge-agreements-pending">Missing: â€”</span>
    </div>
  </section>

  <section id="requests-section">
    <h2>Request Management</h2>
    
    <!-- Sub Navigation -->
    <div style="position:relative; background:#e8e8ed; border-radius:28px; padding:6px; margin-bottom:24px; display:inline-flex; gap:0;">
      <div id="requestsIndicator" style="position:absolute; top:6px; left:6px; height:calc(100% - 12px); background:white; border-radius:22px; transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow:0 3px 8px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08); z-index:1; pointer-events:none;"></div>
      <button class="request-tab active" data-status="open_request" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#1d1d1f; font-family:inherit; transition:color 0.2s; white-space:nowrap;">
        New Requests
        <span id="badge-new" style="display:inline-block; background:#dc3545; color:white; font-size:10px; font-weight:700; padding:2px 6px; border-radius:10px; margin-left:6px; min-width:18px; text-align:center;">0</span>
      </button>
      <button class="request-tab" data-status="my-requests" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">My Requests</button>
      <button class="request-tab" data-status="pending" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">In Progress</button>
      <button class="request-tab" data-status="scheduled" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Scheduled</button>
      <button class="request-tab" data-status="finished" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Finished</button>
      <button class="request-tab" data-status="canceled" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Canceled</button>
    </div>

    <!-- Refresh Controls -->
    <div style="display:flex; align-items:center; justify-content:flex-end; gap:12px; margin-bottom:16px;">
      <label style="display:flex; align-items:center; gap:8px; font-size:14px; color:var(--ink); cursor:pointer;">
        <input type="checkbox" id="autoRefreshToggle" style="cursor:pointer;">
        <span>Auto-Refresh (30s)</span>
      </label>
      <button id="refreshRequestsBtn" style="display:flex; align-items:center; gap:8px; padding:10px 20px; background:rgba(0,113,227,0.1); color:var(--accent); border:1px solid rgba(0,113,227,0.2); border-radius:8px; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s; font-family:inherit;">
        <svg id="refreshIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transition:transform 0.5s;">
          <polyline points="23 4 23 10 17 10"></polyline>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        <span id="refreshBtnText">Neue Requests laden</span>
      </button>
    </div>

    <!-- Two Column Layout -->
    <div style="display:grid; grid-template-columns:350px 1fr; gap:24px; height:calc(100vh - 250px);">
      <!-- Request List -->
      <div id="requestsList" style="background:rgba(255,255,255,0.95); border-radius:12px; padding:16px; box-shadow:var(--shadow); overflow-y:auto; border:1px solid rgba(0,0,0,0.06);">
        <!-- Requests will be loaded here -->
      </div>
      
      <!-- Request Detail Panel -->
      <div id="requestDetail" style="background:rgba(255,255,255,0.95); border-radius:12px; padding:32px; box-shadow:var(--shadow); overflow-y:auto; border:1px solid rgba(0,0,0,0.06);">
        <div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--muted); font-size:16px;">
          Select a request to view details
        </div>
      </div>
    </div>
  </section>

  <section id="calendar-section">
    <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
      <h2 style="margin:0; font-size:28px; font-weight:700;">Booking Calendar</h2>
      <div id="currentDateDisplayTop" style="font-weight:700; font-size:28px; color:var(--ink);"></div>
    </div>
    
    <!-- Event Type Legend -->
    <div style="display:flex; gap:16px; margin-bottom:50px; padding:16px 20px; background:rgba(255,255,255,0.95); border-radius:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,0.06);">
      <span style="font-weight:500; font-size:13px; color:var(--muted);">Booking Types:</span>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#66BB6A;"></div>
        <span style="font-size:13px; color:var(--ink);">Consultation</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#EC407A;"></div>
        <span style="font-size:13px; color:var(--ink);">New Tattoo</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#42A5F5;"></div>
        <span style="font-size:13px; color:var(--ink);">Continuing Tattoo</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#FFEB3B;"></div>
        <span style="font-size:13px; color:var(--ink);">Touch Up</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#8D6E63;"></div>
        <span style="font-size:13px; color:var(--ink);">Selfbooking</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#AB47BC;"></div>
        <span style="font-size:13px; color:var(--ink);">WannaDo</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#EF5350;"></div>
        <span style="font-size:13px; color:var(--ink);">Internal</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#26C6DA;"></div>
        <span style="font-size:13px; color:var(--ink);">Move</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#78909C;"></div>
        <span style="font-size:13px; color:var(--ink);">Reserved</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#FFFFFF; border:1px solid #BDBDBD;"></div>
        <span style="font-size:13px; color:var(--ink);">No Show</span>
      </div>
    </div>
    
    <div class="calendar-controls">
      <div style="display:flex; align-items:center; gap:8px; margin-right:40px;">
        <label style="font-weight:600; font-size:14px;">Location:</label>
        <select id="locationDropdown" style="min-width:200px;"></select>
      </div>
      <button id="prevDayBtn" class="btn-nav">â€¹ Prev</button>
      <input type="date" id="datePickerInput">
      <button id="todayBtn" class="btn-nav">Today</button>
      <button id="nextDayBtn" class="btn-nav" style="margin-right:40px;">Next â€º</button>
      <div style="display:flex; gap:24px; align-items:center; margin-left:auto;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
          <span style="font-weight:700;">Events</span>
          <label class="toggle-switch">
            <input type="checkbox" id="checkEvents" checked>
            <span class="toggle-slider"></span>
          </label>
        </label>
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
          <span style="font-weight:700;">Residents</span>
          <label class="toggle-switch">
            <input type="checkbox" id="checkResidents" checked>
            <span class="toggle-slider"></span>
          </label>
        </label>
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
          <span style="font-weight:700;">Guests</span>
          <label class="toggle-switch">
            <input type="checkbox" id="checkGuests" checked>
            <span class="toggle-slider"></span>
          </label>
        </label>
      </div>
    </div>
    
    <!-- Create Buttons Row -->
    <div style="margin-bottom:16px; display:flex; gap:12px;">
      <button id="createEventBtn" class="btn-nav" style="background:#333; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Create Event</span>
      </button>
      <button id="createBookingBtn" class="btn-nav" style="background:#333; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Create Booking</span>
      </button>
    </div>
    
    <div id="locationInfo" style="margin-bottom:12px; padding:10px 16px; background:rgba(255,255,255,0.95); border-radius:10px; font-size:13px; color:var(--muted); box-shadow:0 1px 3px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);"></div>
    <div class="calendar-container" id="calendarContainer"></div>
  </section>

  <section id="dienstplan-section">
    <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
      <h2 style="margin:0; font-size:28px; font-weight:700;">Dienstplan</h2>
      <div id="dienstplanMonth" style="font-weight:700; font-size:28px; color:var(--ink);"></div>
    </div>
    
    <!-- Status Legend -->
    <div style="display:flex; gap:16px; margin-bottom:24px; padding:16px 20px; background:rgba(255,255,255,0.95); border-radius:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,0.06);">
      <span style="font-weight:500; font-size:13px; color:var(--muted);">Status:</span>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#2196F3;"></div>
        <span style="font-size:13px; color:var(--ink);">Home office</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#FF9800;"></div>
        <span style="font-size:13px; color:var(--ink);">Business trip</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#4CAF50;"></div>
        <span style="font-size:13px; color:var(--ink);">Vacation</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#9C27B0;"></div>
        <span style="font-size:13px; color:var(--ink);">Others</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#F44336;"></div>
        <span style="font-size:13px; color:var(--ink);">Sick</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#795548;"></div>
        <span style="font-size:13px; color:var(--ink);">Guestspot</span>
      </div>
    </div>
    
    <div class="calendar-controls" style="margin-bottom:24px;">
      <div style="display:flex; align-items:center; gap:8px; margin-right:40px;">
        <label style="font-weight:600; font-size:14px;">Location:</label>
        <select id="dienstplanLocationDropdown" style="min-width:200px;"></select>
      </div>
      <button id="prevMonthBtn" class="btn-nav">â€¹ Vorheriger Monat</button>
      <button id="currentMonthBtn" class="btn-nav">Aktueller Monat</button>
      <button id="nextMonthBtn" class="btn-nav">NÃ¤chster Monat â€º</button>
    </div>
    
    <div id="dienstplanContainer" style="width:100%; overflow-x:auto; overflow-y:visible;"></div>
  </section>

  <section id="artists-section">
    <h2>Artists</h2>
    
    <!-- Sort Controls -->
    <div class="sort-controls">
      <label style="font-weight:600; font-size:14px;">Sort by:</label>
      <select id="artistSortBy" class="btn-nav" style="padding:8px 16px;">
        <option value="name">Name</option>
        <option value="rank">Rank</option>
        <option value="location">Location</option>
      </select>
      <button id="artistSortOrder" class="btn-nav" data-order="asc">â†‘ Ascending</button>
    </div>
    
    <!-- Search Bar and Add Button Row -->
    <div style="display:flex; justify-content:space-between; align-items:center; gap:20px; margin-bottom:20px; flex-wrap:wrap;">
      <div style="position:relative; flex:1; min-width:300px; max-width:500px;">
        <svg style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:16px; height:16px; pointer-events:none;" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="artistSearchInput" placeholder="Search artists by name or Instagram..." style="width:100%; padding:12px 16px 12px 42px; font-size:15px; border:1px solid rgba(0,0,0,0.1); border-radius:999px;">
      </div>
      
      <button id="addArtistBtn" class="btn-nav" style="background:#1d1d1f; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Add Artist</span>
      </button>
    </div>

    <!-- Filter Row -->
    <div class="filter-section" style="background:rgba(255,255,255,0.95); border:1px solid rgba(0,0,0,0.06); border-radius:12px; padding:20px; margin-bottom:24px; box-shadow:var(--shadow);">
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr auto; gap:12px; align-items:center; margin-bottom:16px;">

        <!-- Location Filter -->
        <select id="artistLocationFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">ðŸ“ Alle Locations</option>
          <option value="NULL">âš ï¸ Ohne Location</option>
          <!-- Locations werden dynamisch geladen -->
        </select>

        <!-- Rank Filter -->
        <select id="artistRankFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">ðŸ† Alle Ranks</option>
          <option value="R1">R1</option>
          <option value="R2">R2</option>
          <option value="R3">R3</option>
          <option value="R4">R4</option>
          <option value="R5">R5</option>
        </select>

        <!-- Type Filter -->
        <select id="artistTypeFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">ðŸ‘¥ Alle Types</option>
          <option value="resident">Resident Artist</option>
          <option value="guest">Guest Artist</option>
        </select>

        <!-- Status Filter -->
        <select id="artistStatusFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">âœ… Alle Status</option>
          <option value="active">Aktiv</option>
          <option value="inactive">Inaktiv</option>
        </select>

        <!-- Clear Filters Button -->
        <button class="btn-secondary" onclick="clearArtistFilters()" style="padding:10px 20px; background:rgba(0,0,0,0.05); border:1px solid rgba(0,0,0,0.1); border-radius:8px; cursor:pointer; white-space:nowrap;">
          ðŸ”„ Filter zurÃ¼cksetzen
        </button>
      </div>

      <!-- Results Count -->
      <div style="font-size:14px; color:var(--muted);">
        <span id="artistsResultCount" style="font-weight:600; color:var(--ink);">0</span> Artists gefunden
      </div>
    </div>

    <table id="artistsTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Instagram</th>
          <th>Type</th>
          <th>Location</th>
          <th>Rank</th>
          <th>Status</th>
          <th style="text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody id="artistsTableBody"></tbody>
    </table>
  </section>

  <section id="customers-section">
    <h2>Customers</h2>
    
    <!-- Sort Controls -->
    <div class="sort-controls">
      <label style="font-weight:600; font-size:14px;">Sort by:</label>
      <select id="customerSortBy" class="btn-nav" style="padding:8px 16px;">
        <option value="name">Name</option>
        <option value="rank">Rank</option>
        <option value="created">Created Date</option>
      </select>
      <button id="customerSortOrder" class="btn-nav" data-order="desc">â†“ Descending</button>
    </div>
    
    <!-- Search Bar and Add Button Row -->
    <div style="display:flex; justify-content:space-between; align-items:center; gap:20px; margin-bottom:20px; flex-wrap:wrap;">
      <div style="position:relative; flex:1; min-width:300px; max-width:500px;">
        <svg style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:16px; height:16px; pointer-events:none;" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input 
          type="text" 
          id="customerSearchInput" 
          placeholder="Search customers by name, email or phone..." 
          style="width:100%; padding:12px 16px 12px 42px; font-size:15px; border:1px solid rgba(0,0,0,0.1); border-radius:999px;">
      </div>
      
      <button id="addCustomerBtn" class="btn-nav" style="background:#1d1d1f; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Add Customer</span>
      </button>
    </div>

    <!-- Filter Row -->
    <div class="filter-section" style="background:rgba(255,255,255,0.95); border:1px solid rgba(0,0,0,0.06); border-radius:12px; padding:20px; margin-bottom:24px; box-shadow:var(--shadow);">
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:12px; align-items:center; margin-bottom:16px;">

        <!-- Rank Filter -->
        <select id="customerRankFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">ðŸ† Alle Ranks</option>
          <option value="Bronze">ðŸ¥‰ Bronze</option>
          <option value="Silver">ðŸ¥ˆ Silver</option>
          <option value="Gold">ðŸ¥‡ Gold</option>
          <option value="Platinum">ðŸ’Ž Platinum</option>
        </select>

        <!-- Blacklist Filter -->
        <select id="customerBlacklistFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">ðŸ‘¥ Alle Customers</option>
          <option value="false">âœ… Nicht Blacklisted</option>
          <option value="true">ðŸš« Blacklisted</option>
        </select>

        <!-- Total Bookings Filter -->
        <select id="customerBookingsFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer;">
          <option value="">ðŸ“Š Alle Bookings</option>
          <option value="0">0 Bookings</option>
          <option value="1-2">1-2 Bookings</option>
          <option value="3-5">3-5 Bookings</option>
          <option value="6-10">6-10 Bookings</option>
          <option value="11+">11+ Bookings</option>
        </select>

        <!-- Clear Filters Button -->
        <button class="btn-secondary" onclick="clearCustomerFilters()" style="padding:10px 20px; background:rgba(0,0,0,0.05); border:1px solid rgba(0,0,0,0.1); border-radius:8px; cursor:pointer; white-space:nowrap;">
          ðŸ”„ Filter zurÃ¼cksetzen
        </button>
      </div>

      <!-- Results Count -->
      <div style="font-size:14px; color:var(--muted);">
        <span id="customersResultCount" style="font-weight:600; color:var(--ink);">0</span> Customers gefunden
      </div>
    </div>

    <table id="customersTable">
      <thead>
        <tr>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Rank</th>
          <th>Created</th>
          <th style="text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody id="customersTableBody"></tbody>
    </table>
  </section>

  <section id="analytics-section">
    <h2>Analytics</h2>

    <!-- Filters -->
    <div class="analytics-filters">
      <select id="analyticsLocationFilter" class="filter-select">
        <option value="">All Locations</option>
        <!-- Will be populated dynamically -->
      </select>
    </div>

    <!-- Chart Grid -->
    <div class="charts-grid">

      <!-- Pie Chart Card -->
      <div class="chart-card">
        <h3>Booking Sources</h3>
        <canvas id="bookingOriginsPie"></canvas>
      </div>

      <!-- Line Chart Card -->
      <div class="chart-card">
        <h3>Bookings Over Time</h3>

        <!-- Time Range Tabs -->
        <div class="time-range-tabs">
          <button class="time-tab active" data-range="weekly">Weekly</button>
          <button class="time-tab" data-range="monthly">Monthly</button>
          <button class="time-tab" data-range="yearly">Yearly</button>
          <button class="time-tab" data-range="all">All-Time</button>
        </div>

        <canvas id="bookingsTimeline"></canvas>
      </div>

    </div>
  </section>

  <section id="agreements-section">
    <h2>Agreements</h2>
    <div style="margin-bottom:24px;">
      <p style="color:var(--muted); font-size:14px;">Manage your agreements and contracts</p>
    </div>

    <!-- Agreements List Section -->
    <div style="margin-top:48px;">
      <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
        <h2 style="margin:0; font-size:22px; font-weight:600;">Today's Agreements</h2>
        <div id="agreementsDateDisplay" style="font-weight:600; font-size:22px; color:var(--ink);"></div>
      </div>
      
      <div class="calendar-controls" style="margin-bottom:24px;">
        <button id="agreementsPrevDayBtn" class="btn-nav">â€¹ Prev</button>
        <input type="date" id="agreementsDatePickerInput">
        <button id="agreementsTodayBtn" class="btn-nav">Today</button>
        <button id="agreementsNextDayBtn" class="btn-nav">Next â€º</button>
      </div>
      
      <table id="agreementsTable">
        <thead>
          <tr>
            <th>Customer Name</th>
            <th>Email</th>
            <th>Artist</th>
            <th>Time</th>
            <th style="text-align:center;">Signed</th>
          </tr>
        </thead>
        <tbody id="agreementsTableBody"></tbody>
      </table>
    </div>
  </section>

  <section id="profile-section">
    <div style="max-width: 800px; margin: 0 auto;">
      <h2 style="margin-bottom: 32px;">Profil</h2>

      <!-- Profile Header -->
      <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 48px; padding: 32px; background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <img id="profilePageAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23ddd'/%3E%3Ctext x='50' y='65' text-anchor='middle' font-size='40' fill='%23666'%3EðŸ‘¤%3C/text%3E%3C/svg%3E" alt="Profilbild" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #f5f5f7; margin-bottom: 20px;">
        <h2 id="profilePageName" style="margin: 0 0 8px 0; font-size: 28px; font-weight: 600;">Username</h2>
        <span id="profilePageRoleBadge" class="profile-role-badge" style="font-size: 13px; padding: 6px 16px; border-radius: 999px; background: #f5f5f7; color: var(--ink); font-weight: 600;">USER</span>
      </div>

      <!-- Profile Information Cards -->
      <div style="display: grid; gap: 24px;">

        <!-- Account Info Card -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;">Account Information</h3>

          <div style="display: grid; gap: 16px;">
            <div>
              <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Benutzername</label>
              <div id="profilePageUsername" style="font-size: 15px; font-weight: 500;">â€”</div>
            </div>

            <div>
              <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Rolle</label>
              <div id="profilePageRoleText" style="font-size: 15px; font-weight: 500;">â€”</div>
            </div>

            <div>
              <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Passwort</label>
              <div style="display: flex; gap: 12px; align-items: center;">
                <span id="profilePagePassword">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                <button type="button" class="btn btn-secondary" onclick="showPasswordChangeFormPage()" style="font-size: 13px; padding: 6px 12px;">Ã„ndern</button>
              </div>
            </div>
          </div>

          <!-- Password Change Form (Hidden by default) -->
          <div id="profilePagePasswordChangeForm" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid #eee;">
            <h4 style="margin: 0 0 16px 0; font-size: 16px;">Passwort Ã¤ndern</h4>
            <div style="display: grid; gap: 12px;">
              <div>
                <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Neues Passwort</label>
                <input type="password" id="profilePageNewPassword" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
              </div>
              <div>
                <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Passwort bestÃ¤tigen</label>
                <input type="password" id="profilePageConfirmPassword" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
              </div>
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button type="button" class="btn btn-secondary" onclick="hidePasswordChangeFormPage()" style="flex: 1;">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="changePasswordPage()" style="flex: 1;">Speichern</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Avatar Card -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;">Profilbild</h3>

          <!-- Current Avatar Preview -->
          <div id="profilePageCurrentAvatarPreview" style="text-align: center; margin-bottom: 24px;">
            <img id="profilePageCurrentAvatarImg" src="" alt="Aktuelles Profilbild" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #f5f5f7;">
          </div>

          <!-- Drag & Drop Zone -->
          <div
            id="profilePageAvatarDropZone"
            style="border: 2px dashed #d1d5db; border-radius: 12px; padding: 40px 20px; text-align: center; background: #f9fafb; cursor: pointer; transition: all 0.3s; margin-bottom: 20px;"
            ondragover="handleProfileDragOver(event)"
            ondragleave="handleProfileDragLeave(event)"
            ondrop="handleProfileDrop(event)"
            onclick="document.getElementById('profilePageAvatarFileInput').click()">
            <div style="font-size: 48px; margin-bottom: 12px;">ðŸ“¸</div>
            <div style="font-size: 16px; font-weight: 500; color: var(--ink); margin-bottom: 8px;">
              Bild hier ablegen oder klicken
            </div>
            <div style="font-size: 13px; color: var(--muted);">
              PNG, JPG oder GIF (max. 5MB)
            </div>
          </div>

          <!-- Hidden File Input -->
          <input
            type="file"
            id="profilePageAvatarFileInput"
            accept="image/*"
            style="display: none;"
            onchange="handleProfileFileSelect(event)">

          <!-- Preview Selected Image -->
          <div id="profilePageAvatarPreviewContainer" style="display: none; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 14px; font-weight: 500; color: var(--ink); margin-bottom: 12px;">Vorschau:</div>
            <img id="profilePageAvatarPreview" src="" alt="Vorschau" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent);">
            <div id="profilePageAvatarFileName" style="font-size: 13px; color: var(--muted); margin-top: 8px;"></div>
          </div>

          <!-- Upload Progress -->
          <div id="profilePageUploadProgress" style="display: none; margin-bottom: 20px;">
            <div style="font-size: 13px; color: var(--muted); margin-bottom: 8px;">Uploading...</div>
            <div style="background: #e5e7eb; border-radius: 999px; height: 8px; overflow: hidden;">
              <div id="profilePageUploadProgressBar" style="background: var(--accent); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
          </div>

          <button type="button" class="btn btn-primary" id="profilePageUploadAvatarBtn" onclick="uploadAvatarFromProfilePage()" disabled style="width: 100%; opacity: 0.5;">Hochladen</button>
        </div>

        <!-- Logout Button -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
          <button type="button" class="btn btn-danger" onclick="logout()" style="width: 100%;">Abmelden</button>
        </div>

      </div>
    </div>
  </section>

  <!-- Add Artist Modal -->
  <div class="modal-backdrop" id="addArtistModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3>Add New Artist</h3>
      <form class="modal-form" id="addArtistForm">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="addArtistName" required placeholder="Artist name">
        </div>
        <div class="form-group">
          <label>Instagram Handle</label>
          <input type="text" id="addArtistInstagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="addArtistType">
            <option value="resident">Resident</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        <div class="form-group">
          <label>Location</label>
          <select id="addArtistLocation" required>
            <option value="">-- Select Location --</option>
          </select>
        </div>        </div>
        <div class="form-group">
          <label>City Location</label>
          <select id="addArtistCityLocation" required>
            <option value="">-- Select Location --</option>
            <option value="Stuttgart">Stuttgart</option>
            <option value="KÃ¶ln">KÃ¶ln</option>
            <option value="MÃ¼nchen">MÃ¼nchen</option>
            <option value="Berlin">Berlin</option>
          </select>
        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="addArtistRank" required>
            <option value="">-- Select Rank --</option>
            <option value="R1">R1</option>
            <option value="R2">R2</option>
            <option value="R3">R3</option>
            <option value="R4">R4</option>
            <option value="R5">R5</option>
          </select>
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="addArtistActive" checked>
            Active
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelAddArtist">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Artist</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Artist Modal -->
  <div class="modal-backdrop" id="editArtistModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3>Edit Artist</h3>
      <form class="modal-form" id="editArtistForm">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="editArtistName" required>
        </div>
        <div class="form-group">
          <label>Instagram Handle</label>
          <input type="text" id="editArtistInstagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="editArtistType">
            <option value="resident">Resident</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        <div class="form-group">
          <label>Location</label>
          <select id="editArtistLocation">
            <option value="">-- Select Location --</option>
            <option value="Stuttgart">Stuttgart</option>
            <option value="KÃ¶ln">KÃ¶ln</option>
            <option value="Berlin">Berlin</option>
            <option value="MÃ¼nchen">MÃ¼nchen</option>
          </select>
        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="editArtistRank">
            <option value="">-- No Rank --</option>
            <option value="R1">R1</option>
            <option value="R2">R2</option>
            <option value="R3">R3</option>
            <option value="R4">R4</option>
            <option value="R5">R5</option>
          </select>
        </div>
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="editArtistActive" style="width:auto; padding:0;">
            Active
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelEditArtist">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Assign Team Member Modal -->
  <div class="modal-backdrop" id="assignModal">
    <div class="modal">
      <h3 style="color:var(--ink); font-weight:500;">Assign to Team Member</h3>
      <form class="modal-form" id="assignForm">
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Team Member</label>
          <select id="assignTeamMember" required>
            <option value="">-- Select Team Member --</option>
            <option value="member1">Name 1</option>
            <option value="member2">Name 2</option>
            <option value="member3">Name 3</option>
          </select>
        </div>
        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelAssign" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Assign</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Schedule Appointment Modal -->
  <div class="modal-backdrop" id="scheduleModal">
    <div class="modal">
      <h3 style="color:var(--ink); font-weight:500;">Schedule Appointment</h3>
      <form class="modal-form" id="scheduleForm">
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Artist</label>
          <select id="scheduleArtist" required>
            <option value="">-- Select Artist --</option>
          </select>
        </div>
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Date</label>
          <input type="date" id="scheduleDate" required>
        </div>
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Start Time</label>
          <select id="scheduleStartTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">End Time</label>
          <select id="scheduleEndTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelSchedule" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Request Modal -->
  <div class="modal-backdrop" id="editRequestModal">
    <div class="modal" style="max-width:700px; max-height:90vh; overflow-y:auto;">
      <h3 style="color:var(--ink); font-weight:500;">Edit Request</h3>
      <form class="modal-form" id="editRequestForm" style="max-height:calc(90vh - 150px); overflow-y:auto;">

        <!-- Customer Information -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Customer Information</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Vorname</label>
            <input type="text" id="editFirstName" required>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Nachname</label>
            <input type="text" id="editLastName" required>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Email</label>
            <input type="email" id="editEmail" required>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Phone</label>
            <input type="tel" id="editPhone" required>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Instagram</label>
            <input type="text" id="editInstagram" placeholder="@username">
          </div>
        </div>

        <!-- Request Details -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Request Details</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Priority</label>
            <select id="editPriority">
              <option value="">-- Select Priority --</option>
              <option value="low">Low ðŸ’¤</option>
              <option value="normal">Normal âœ“</option>
              <option value="high">High âš¡</option>
              <option value="urgent">Urgent ðŸ”¥</option>
            </select>
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Placement</label>
            <input type="text" id="editPlacement">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Size</label>
            <input type="text" id="editSize">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Style</label>
            <input type="text" id="editStyle">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Colorway</label>
            <input type="text" id="editColorway">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Description</label>
            <textarea id="editDescription" rows="4"></textarea>
          </div>
        </div>

        <!-- Artist Assignment -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Artist Assignment</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Search Artist</label>
            <input type="text" id="editArtistSearch" placeholder="Type to search artists...">
            <div id="editArtistSearchResults" style="display:none; max-height:200px; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); border-radius:8px; margin-top:8px; background:white;"></div>
            <input type="hidden" id="editArtistId">
            <div id="editSelectedArtist" style="margin-top:8px; font-size:13px; color:var(--muted);"></div>
          </div>
        </div>

        <!-- Appointment Details -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Appointment Details</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Date</label>
            <input type="date" id="editScheduledDate">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Start Time</label>
            <input type="time" id="editStartTime">
          </div>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">End Time</label>
            <input type="time" id="editEndTime">
          </div>
        </div>

        <!-- Status Management -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Status Management</h4>
          <div class="form-group">
            <label style="font-size:13px; color:var(--muted);">Status</label>
            <select id="editStatus">
              <option value="open_request">New Request</option>
              <option value="pending">Pending</option>
              <option value="scheduled">Scheduled</option>
              <option value="finished">Finished</option>
              <option value="canceled">Canceled</option>
            </select>
          </div>
        </div>

        <!-- Quick Actions -->
        <div style="margin-bottom:24px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.1);">
          <h4 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--ink);">Quick Actions</h4>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn" onclick="resetRequestToOpen()" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">
              ðŸ”„ Reset to Open
            </button>
            <button type="button" class="btn" onclick="deleteRequestPermanently()" style="background:#dc3545; color:white; border:none;">
              ðŸ—‘ï¸ Delete Permanently
            </button>
          </div>
        </div>

        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelEditRequest" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Appointment Modal -->
  <div class="modal-backdrop" id="editAppointmentModal">
    <div class="modal">
      <h3 style="color:var(--ink); font-weight:500;">Edit Appointment</h3>
      <form class="modal-form" id="editAppointmentForm">
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Artist</label>
          <select id="editAppointmentArtist" required>
            <option value="">-- Select Artist --</option>
          </select>
        </div>
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Date</label>
          <input type="date" id="editAppointmentDate" required>
        </div>
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Start Time</label>
          <select id="editAppointmentStartTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">End Time</label>
          <select id="editAppointmentEndTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelEditAppointment" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cancel Appointment Modal -->
  <div class="modal-backdrop" id="cancelModal">
    <div class="modal">
      <h3 style="color:var(--ink); font-weight:500;">Cancel Appointment</h3>
      <p style="margin-bottom:20px; color:var(--muted); font-size:14px;">Are you sure you want to cancel this appointment?</p>
      <form class="modal-form" id="cancelForm">
        <div class="form-group">
          <label style="font-size:13px; color:var(--muted);">Cancellation Reason</label>
          <textarea id="cancelReason" placeholder="Please provide a reason for cancellation..." required style="border-radius:10px;"></textarea>
        </div>
        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelCancelModal" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">No, Keep it</button>
          <button type="submit" class="btn" style="background:#dc3545; color:white; border:none;">Yes, Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal-backdrop" id="addCustomerModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3>Add New Customer</h3>
      <form class="modal-form" id="addCustomerForm">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="addCustomerFirstName" required>
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="addCustomerLastName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="addCustomerEmail" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="addCustomerPhone">
        </div>        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="addCustomerRank">
            <option value="">-- No Rank --</option>
            <option value="Bronze">Bronze</option>
            <option value="Silver">Silver</option>
            <option value="Gold">Gold</option>
            <option value="Platinum">Platinum</option>
          </select>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelAddCustomer">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Customer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Customer Modal -->
  <div class="modal-backdrop" id="editCustomerModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3>Edit Customer</h3>
      <form class="modal-form" id="editCustomerForm">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="editCustomerFirstName" required>
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="editCustomerLastName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="editCustomerEmail" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="editCustomerPhone">
        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="editCustomerRank">
            <option value="">-- No Rank --</option>
            <option value="Bronze">Bronze</option>
            <option value="Silver">Silver</option>
            <option value="Gold">Gold</option>
            <option value="Platinum">Platinum</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelEditCustomer">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Customer Detail Modal -->
  <div class="modal-backdrop" id="customerDetailModal">
    <div class="modal">
      <h3>Customer Details</h3>
      <div id="customerDetailContent" style="display:flex; flex-direction:column; gap:16px;">
        <!-- Customer details will be loaded here -->
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="closeCustomerDetail">Close</button>
      </div>
    </div>
  </div>

  <!-- File Upload Modal -->
  <div class="modal-backdrop" id="fileUploadModal">
    <div class="modal">
      <h3>Agreement Files</h3>
      <div style="margin-bottom:20px;">
        <div id="existingFiles" style="margin-bottom:16px;">
          <!-- Existing files will be shown here -->
        </div>
        <div style="border:2px dashed rgba(0,0,0,0.2); border-radius:12px; padding:32px; text-align:center; background:rgba(0,0,0,0.02);">
          <input type="file" id="fileUploadInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display:none;">
          <div style="font-size:48px; margin-bottom:12px;">ðŸ“Ž</div>
          <button type="button" class="btn btn-primary" onclick="document.getElementById('fileUploadInput').click()">Choose Files</button>
          <p style="margin-top:12px; font-size:13px; color:var(--muted);">PDF, DOC, DOCX, JPG, PNG accepted</p>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="closeFileUpload">Close</button>
      </div>
    </div>
  </div>

  <!-- Create Event Modal -->
  <div class="modal-backdrop" id="createEventModal">
    <div class="modal" style="max-width:600px;">
      <h3>Create New Event</h3>
      <form class="modal-form" id="createEventForm">
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="createEventTitle" placeholder="e.g. Team Meeting, Workshop, etc." required>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <input type="text" id="createEventType" placeholder="e.g. Meeting, Training, Workshop" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="createEventDescription" placeholder="Event details and notes..." style="border-radius:10px; min-height:80px; resize:vertical;"></textarea>
        </div>
        
        <div class="form-group">
          <label>Visible for Groups</label>
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px; background:rgba(0,0,0,0.02); border-radius:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:600; grid-column:1/-1; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:4px;">
              <input type="checkbox" id="groupCheckboxAll" style="width:auto; padding:0;">
              All Groups
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="geschÃ¤ftsfÃ¼hrung" style="width:auto; padding:0;">
              GeschÃ¤ftsfÃ¼hrung
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="management" style="width:auto; padding:0;">
              Management
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="booking_team" style="width:auto; padding:0;">
              Booking Team
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="mediadepartment" style="width:auto; padding:0;">
              Mediadepartment
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="resident_artists" style="width:auto; padding:0;">
              Resident Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="guest_artists" style="width:auto; padding:0;">
              Guest Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="azubis" style="width:auto; padding:0;">
              Azubis
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="andere" style="width:auto; padding:0;">
              Andere
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
            <input type="checkbox" id="createEventAttendanceRequired" style="width:auto; padding:0;">
            <span style="font-weight:500;">Anwesenheitspflicht</span>
          </label>
          <p style="font-size:12px; color:var(--muted); margin:4px 0 0 24px;">Markieren Sie dieses Event als verpflichtend fÃ¼r alle ausgewÃ¤hlten Gruppen</p>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="createEventDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="createEventStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="createEventEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelCreateEvent">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Event</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Event Modal -->
  <div class="modal-backdrop" id="editEventModal">
    <div class="modal" style="max-width:600px;">
      <h3>Edit Event</h3>
      <form class="modal-form" id="editEventForm">
        <input type="hidden" id="editEventId">
        
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="editEventTitle" placeholder="e.g. Team Meeting" required>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <input type="text" id="editEventType" placeholder="e.g. Meeting, Workshop, Training" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="editEventDescription" placeholder="Add details about this event..." style="border-radius:10px; min-height:80px;"></textarea>
        </div>
        
        <div class="form-group">
          <label>Visible for Groups</label>
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px; background:rgba(0,0,0,0.02); border-radius:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:600; grid-column:1/-1; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:4px;">
              <input type="checkbox" id="editGroupCheckboxAll" style="width:auto; padding:0;">
              All Groups
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="geschÃ¤ftsfÃ¼hrung" style="width:auto; padding:0;">
              GeschÃ¤ftsfÃ¼hrung
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="management" style="width:auto; padding:0;">
              Management
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="booking_team" style="width:auto; padding:0;">
              Booking Team
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="mediadepartment" style="width:auto; padding:0;">
              Mediadepartment
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="resident_artists" style="width:auto; padding:0;">
              Resident Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="guest_artists" style="width:auto; padding:0;">
              Guest Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="azubis" style="width:auto; padding:0;">
              Azubis
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="andere" style="width:auto; padding:0;">
              Andere
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
            <input type="checkbox" id="editEventAttendanceRequired" style="width:auto; padding:0;">
            <span style="font-weight:500;">Anwesenheitspflicht</span>
          </label>
          <p style="font-size:12px; color:var(--muted); margin:4px 0 0 24px;">Markieren Sie dieses Event als verpflichtend fÃ¼r alle ausgewÃ¤hlten Gruppen</p>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="editEventDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="editEventStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="editEventEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete Event</button>
          <div style="flex:1;"></div>
          <button type="button" class="btn btn-secondary" id="cancelEditEvent">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Booking Modal -->
  <div class="modal-backdrop" id="editBookingModal">
    <div class="modal" style="max-width:600px;">
      <h3>Edit Booking</h3>
      <form class="modal-form" id="editBookingForm">
        <input type="hidden" id="editBookingId">
        
        <div class="form-group">
          <label>Customer Name</label>
          <input type="text" id="editBookingCustomer" placeholder="Customer Name" required>
        </div>
        
        <div class="form-group">
          <label>Booking Type</label>
          <select id="editBookingType" required>
            <option value="">-- Select Type --</option>
            <option value="consultation">Consultation</option>
            <option value="new_tattoo">New Tattoo</option>
            <option value="continuing_tattoo">Continuing Tattoo</option>
            <option value="touch_up">Touch Up</option>
            <option value="selfbooking">Selfbooking</option>
            <option value="wannado">WannaDo</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Artist</label>
          <input type="text" id="editBookingArtistName" disabled style="background:#f5f5f5;">
          <input type="hidden" id="editBookingArtistId">
          <p style="font-size:12px; color:var(--muted); margin:4px 0 0 0;">Artist cannot be changed after booking creation</p>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="editBookingDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="editBookingStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="editBookingEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteBookingBtn">Delete Booking</button>
          <div style="flex:1;"></div>
          <button type="button" class="btn btn-secondary" id="cancelEditBooking">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Booking Modal -->
  <div class="modal-backdrop" id="editEventModal">
    <div class="modal" style="max-width:600px;">
      <h3>Edit Event</h3>
      <form class="modal-form" id="editEventForm">
        <input type="hidden" id="editEventId">
        
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="editEventTitle" placeholder="e.g. Team Meeting" required>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <input type="text" id="editEventType" placeholder="e.g. Meeting, Workshop, Training" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="editEventDescription" placeholder="Add details about this event..." style="border-radius:10px; min-height:80px;"></textarea>
        </div>
        
        <div class="form-group">
          <label>Visible for Groups</label>
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px; background:rgba(0,0,0,0.02); border-radius:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:600; grid-column:1/-1; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:4px;">
              <input type="checkbox" id="editGroupCheckboxAll" style="width:auto; padding:0;">
              All Groups
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="geschÃ¤ftsfÃ¼hrung" style="width:auto; padding:0;">
              GeschÃ¤ftsfÃ¼hrung
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="management" style="width:auto; padding:0;">
              Management
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="booking_team" style="width:auto; padding:0;">
              Booking Team
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="mediadepartment" style="width:auto; padding:0;">
              Mediadepartment
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="resident_artists" style="width:auto; padding:0;">
              Resident Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="guest_artists" style="width:auto; padding:0;">
              Guest Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="azubis" style="width:auto; padding:0;">
              Azubis
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="andere" style="width:auto; padding:0;">
              Andere
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
            <input type="checkbox" id="editEventAttendanceRequired" style="width:auto; padding:0;">
            <span style="font-weight:500;">Anwesenheitspflicht</span>
          </label>
          <p style="font-size:12px; color:var(--muted); margin:4px 0 0 24px;">Markieren Sie dieses Event als verpflichtend fÃ¼r alle ausgewÃ¤hlten Gruppen</p>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="editEventDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="editEventStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="editEventEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete Event</button>
          <div style="flex:1;"></div>
          <button type="button" class="btn btn-secondary" id="cancelEditEvent">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Booking Modal -->
  <div class="modal-backdrop" id="createBookingModal">
    <div class="modal" style="max-width:600px;">
      <h3>Create New Booking</h3>
      <form class="modal-form" id="createBookingForm">
        <div class="form-group">
          <label>Customer Name</label>
          <input type="text" id="createBookingCustomer" placeholder="e.g. John Doe" required>
        </div>
        
        <div class="form-group">
          <label>Booking Type</label>
          <select id="createBookingType" required>
            <option value="">-- Select Type --</option>
            <option value="consultation">Consultation</option>
            <option value="new_tattoo">New Tattoo</option>
            <option value="continuing_tattoo">Continuing Tattoo</option>
            <option value="touch_up">Touch Up</option>
            <option value="selfbooking">Selfbooking</option>
            <option value="wannado">WannaDo</option>
            <option value="internal">Internal</option>
            <option value="move">Move</option>
            <option value="reserved">Reserved</option>
            <option value="no_show">No Show</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Artist Type</label>
          <select id="createBookingArtistType" required>
            <option value="">-- Select Artist Type --</option>
            <option value="resident">Resident</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Search Artist</label>
          <input type="text" id="createBookingArtistSearch" placeholder="Type to search artist..." disabled>
          <input type="hidden" id="createBookingArtistId">
          <div id="artistSearchResults" style="display:none; max-height:200px; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); border-radius:8px; margin-top:4px; background:white;"></div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="createBookingDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="createBookingStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="createBookingEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelCreateBooking">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Booking</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit/View Event Modal -->
  <div class="modal-backdrop" id="editEventModal">
    <div class="modal" style="max-width:600px;">
      <h3 id="editEventModalTitle">Event Details</h3>
      <form class="modal-form" id="editEventForm">
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="editEventTitle" required>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <input type="text" id="editEventType" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="editEventDescription" rows="3" style="border-radius:10px; resize:vertical;"></textarea>
        </div>
        
        <div class="form-group" id="editEventArtistGroup" style="display:none;">
          <label>Artist</label>
          <input type="text" id="editEventArtistName" readonly style="background:rgba(0,0,0,0.05);">
        </div>
        
        <div class="form-group" id="editEventGroupsContainer">
          <label>Visible for Groups</label>
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px; background:rgba(0,0,0,0.02); border-radius:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:600; grid-column:1/-1; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:4px;">
              <input type="checkbox" id="editGroupCheckboxAll" style="width:auto; padding:0;">
              All Groups
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="geschÃ¤ftsfÃ¼hrung" style="width:auto; padding:0;">
              GeschÃ¤ftsfÃ¼hrung
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="management" style="width:auto; padding:0;">
              Management
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="booking_team" style="width:auto; padding:0;">
              Booking Team
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="mediadepartment" style="width:auto; padding:0;">
              Mediadepartment
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="resident_artists" style="width:auto; padding:0;">
              Resident Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="guest_artists" style="width:auto; padding:0;">
              Guest Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="azubis" style="width:auto; padding:0;">
              Azubis
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="andere" style="width:auto; padding:0;">
              Andere
            </label>
          </div>
        </div>
        
        <div class="form-group" id="editEventAttendanceGroup">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
            <input type="checkbox" id="editEventAttendanceRequired" style="width:auto; padding:0;">
            <span style="font-weight:500;">Anwesenheitspflicht</span>
          </label>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="editEventDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="editEventStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="editEventEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete Event</button>
          <div style="flex:1;"></div>
          <button type="button" class="btn btn-secondary" id="cancelEditEvent">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://auxxyehgzkozdjylhqnx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1eHh5ZWhnemtvemRqeWxocW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDczODgsImV4cCI6MjA3NjEyMzM4OH0.bg8NunF2qkps28Aj0ZqY35eKK--QOu8NduCkFyqp5KA";
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ============================================
    // PERMISSION HELPER FUNCTIONS
    // ============================================

    // Permission check function
    async function userHasPermission(permission) {
      try {
        const { data, error } = await supabase.rpc('user_has_permission', {
          p_permission: permission
        });

        if (error) {
          console.error('Permission check error:', error);
          return false;
        }

        return data === true;
      } catch (err) {
        console.error('Permission check failed:', err);
        return false;
      }
    }

    // Get current user role
    async function getCurrentUserRole() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return 'guest';

        const { data: profile } = await supabase
          .from('profiles')
          .select('role')
          .eq('id', user.id)
          .single();

        return profile?.role || 'user';
      } catch (err) {
        console.error('Error getting user role:', err);
        return 'guest';
      }
    }

    let currentDate = new Date();
    let dienstplanDate = new Date();
    let agreementsDate = new Date();
    let events = [];
    let allArtists = [];
    let allTeamMembers = [];
    
    // Sorting state
    let artistSortConfig = { field: 'name', order: 'asc' };
    let customerSortConfig = { field: 'created_at', order: 'desc' };
    let currentEditingEvent = null;
    let selectedLocationId = null;
    let selectedDienstplanLocationId = null;
    let selectedAgreementsLocationId = null;
    let currentLocationName = '';
    let openCategories = new Set();
    let currentAgreementEventId = null;
    let agreementFiles = [];
    
    // Category visibility state
    let visibleCategories = {
      events: true,
      residents: true,
      guests: true
    };

    // Google-inspirierte Farbschemata pro Location
    const locationColors = {
      'mommy': {
        primary: '#8E24AA',      // Purple
        light: '#F3E5F5',
        dark: '#6A1B9A',
        accent: '#BA68C8'
      },
      'gon': {
        primary: '#1976D2',      // Blue
        light: '#E3F2FD',
        dark: '#0D47A1',
        accent: '#42A5F5'
      },
      'muttersÃ¶hne': {
        primary: '#43A047',      // Green
        light: '#E8F5E9',
        dark: '#2E7D32',
        accent: '#66BB6A'
      },
      'pardon': {
        primary: '#E53935',      // Red
        light: '#FFEBEE',
        dark: '#C62828',
        accent: '#EF5350'
      },
      'default': {
        primary: '#111827',      // Dark Gray
        light: '#F3F4F6',
        dark: '#0F172A',
        accent: '#6B7280'
      }
    };

    function getLocationColors(locationName) {
      const name = (locationName || '').toLowerCase();
      if (name.includes('mommy')) return locationColors.mommy;
      if (name.includes('gon')) return locationColors.gon;
      if (name.includes('muttersÃ¶hne') || name.includes('muttersohne')) return locationColors.muttersÃ¶hne;
      if (name.includes('pardon')) return locationColors.pardon;
      return locationColors.default;
    }

    function getCurrentLocationName() {
      const select = document.querySelector('#dienstplanLocationDropdown option:checked');
      return select ? select.textContent : '';
    }

    // ============================================
    // UI PERMISSIONS INITIALIZATION
    // ============================================

    async function initializePermissions() {
      try {
        // Check if user is logged in
        const { data: { user } } = await supabase.auth.getUser();
        if (!user && !localStorage.getItem('hasSkippedLogin')) {
          // No user and hasn't skipped - hide all create/manage buttons
          console.log('No user logged in - hiding management buttons');
          hideManagementButtons();
          return;
        }

        // Check all permissions in parallel for faster load
        const [
          canCreateBooking,
          canCreateEvent,
          canManageArtists,
          canManageCustomers,
          canManageRequests,
          canManageDienstplan
        ] = await Promise.all([
          userHasPermission('calendar.create_booking'),
          userHasPermission('calendar.create_event'),
          userHasPermission('artists.manage'),
          userHasPermission('customers.manage'),
          userHasPermission('requests.manage'),
          userHasPermission('dienstplan.manage')
        ]);

        console.log('Permissions loaded:', {
          canCreateBooking,
          canCreateEvent,
          canManageArtists,
          canManageCustomers,
          canManageRequests,
          canManageDienstplan
        });

        // Hide/show buttons based on permissions
        if (!canCreateBooking) {
          const createBookingBtns = document.querySelectorAll('[onclick*="createBooking"]');
          createBookingBtns.forEach(btn => btn.style.display = 'none');
        }

        if (!canCreateEvent) {
          const createEventBtns = document.querySelectorAll('[onclick*="createEvent"]');
          createEventBtns.forEach(btn => btn.style.display = 'none');
        }

        if (!canManageArtists) {
          const artistBtns = document.querySelectorAll('#addArtistBtn, [onclick*="addArtist"], [onclick*="editArtist"], [onclick*="deleteArtist"]');
          artistBtns.forEach(btn => btn.style.display = 'none');
        }

        if (!canManageCustomers) {
          const customerBtns = document.querySelectorAll('#addCustomerBtn, [onclick*="addCustomer"], [onclick*="editCustomer"], [onclick*="deleteCustomer"]');
          customerBtns.forEach(btn => btn.style.display = 'none');
        }

        if (!canManageRequests) {
          const requestBtns = document.querySelectorAll('[onclick*="assignRequest"], [onclick*="scheduleAppointment"]');
          requestBtns.forEach(btn => btn.style.display = 'none');
        }

        if (!canManageDienstplan) {
          // Make dienstplan cells read-only
          const dienstplanCells = document.querySelectorAll('.dp-cell');
          dienstplanCells.forEach(cell => {
            cell.style.cursor = 'not-allowed';
            cell.style.pointerEvents = 'none';
          });
        }
      } catch (err) {
        console.error('Error initializing permissions:', err);
      }
    }

    function hideManagementButtons() {
      const selectors = [
        '[onclick*="createBooking"]',
        '[onclick*="createEvent"]',
        '#addArtistBtn',
        '[onclick*="addArtist"]',
        '[onclick*="editArtist"]',
        '[onclick*="deleteArtist"]',
        '#addCustomerBtn',
        '[onclick*="addCustomer"]',
        '[onclick*="editCustomer"]',
        '[onclick*="deleteCustomer"]',
        '[onclick*="assignRequest"]',
        '[onclick*="scheduleAppointment"]'
      ];

      selectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => el.style.display = 'none');
      });

      // Make dienstplan read-only
      const dienstplanCells = document.querySelectorAll('.dp-cell');
      dienstplanCells.forEach(cell => {
        cell.style.cursor = 'not-allowed';
        cell.style.pointerEvents = 'none';
      });
    }



    // Sorting Functions
    function sortArtists(artists, field, order) {
      const sorted = [...artists].sort((a, b) => {
        let aVal, bVal;
        
        if (field === 'name') {
          aVal = (a.name || '').toLowerCase();
          bVal = (b.name || '').toLowerCase();
        } else if (field === 'rank') {
          const rankOrder = { 'R1': 1, 'R2': 2, 'R3': 3, 'R4': 4, 'R5': 5 };
          aVal = rankOrder[a.rank] || 999;
          bVal = rankOrder[b.rank] || 999;
        } else if (field === 'location') {
          aVal = (a.city_location || '').toLowerCase();
          bVal = (b.city_location || '').toLowerCase();
        }
        
        if (aVal < bVal) return order === 'asc' ? -1 : 1;
        if (aVal > bVal) return order === 'asc' ? 1 : -1;
        return 0;
      });
      
      return sorted;
    }
    
    function sortCustomers(customers, field, order) {
      const sorted = [...customers].sort((a, b) => {
        let aVal, bVal;
        
        if (field === 'name') {
          aVal = `${a.first_name || ''} ${a.last_name || ''}`.toLowerCase();
          bVal = `${b.first_name || ''} ${b.last_name || ''}`.toLowerCase();
        } else if (field === 'rank') {
          const rankOrder = { 'Bronze': 1, 'Silver': 2, 'Gold': 3, 'Platinum': 4 };
          aVal = rankOrder[a.rank] || 0;
          bVal = rankOrder[b.rank] || 0;
        } else if (field === 'created') {
          aVal = new Date(a.created_at).getTime();
          bVal = new Date(b.created_at).getTime();
        }
        
        if (aVal < bVal) return order === 'asc' ? -1 : 1;
        if (aVal > bVal) return order === 'asc' ? 1 : -1;
        return 0;
      });
      
      return sorted;
    }

    function applyLocationTheme(colors) {
      const root = document.documentElement;
      root.style.setProperty('--location-primary', colors.primary);
      root.style.setProperty('--location-light', colors.light);
      root.style.setProperty('--location-dark', colors.dark);
      root.style.setProperty('--location-accent', colors.accent);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const tabs = document.querySelectorAll("nav a[id^='tab-']");
      const sections = document.querySelectorAll("section");

      // Load data and permissions in parallel for faster initial load
      await Promise.all([
        loadInitialData(),
        initializePermissions()
      ]);

      // Request tabs initialization function
      function initRequestTabs() {
        const requestTabs = document.querySelectorAll('.request-tab');
        const requestsIndicator = document.getElementById('requestsIndicator');
        
        console.log('Init Request tabs found:', requestTabs.length);
        console.log('Init Indicator element:', requestsIndicator);
        
        if (!requestsIndicator || requestTabs.length === 0) {
          console.error('Missing indicator or tabs');
          return;
        }
        
        function updateRequestsIndicator(tab) {
          if (!requestsIndicator || !tab) return;
          
          const tabRect = tab.getBoundingClientRect();
          const containerRect = tab.parentElement.getBoundingClientRect();
          const left = tabRect.left - containerRect.left;
          const width = tabRect.width;
          
          console.log('Updating indicator - Left:', left, 'Width:', width);
          
          requestsIndicator.style.width = `${width}px`;
          requestsIndicator.style.transform = `translateX(${left}px)`;
        }
        
        // Initialize indicator position
        setTimeout(() => {
          const activeTab = document.querySelector('.request-tab.active');
          if (activeTab) {
            console.log('Initializing indicator for active tab');
            updateRequestsIndicator(activeTab);
          }
        }, 50);
        
        // Add click listeners
        requestTabs.forEach((tab, index) => {
          console.log('Adding click listener to tab', index, tab.textContent);
          
          // Remove old listeners by cloning
          const newTab = tab.cloneNode(true);
          tab.parentNode.replaceChild(newTab, tab);
          
          newTab.addEventListener('click', function(e) {
            console.log('Tab clicked:', this.textContent, 'Status:', this.dataset.status);
            
            // Update current status
            currentRequestStatus = this.dataset.status;
            console.log('Updated currentRequestStatus to:', currentRequestStatus);
            
            document.querySelectorAll('.request-tab').forEach(t => {
              t.classList.remove('active');
              t.style.color = '#86868b';
            });
            this.classList.add('active');
            this.style.color = '#1d1d1f';
            
            updateRequestsIndicator(this);
            
            // Close detail view when switching tabs
            selectedRequestId = null;
            closeRequestDetail();
            
            loadRequests();
          });
        });
      }

      // Refresh Requests Functionality
      let autoRefreshInterval = null;
      let isRefreshing = false;

      async function refreshRequests() {
        if (isRefreshing) return;

        isRefreshing = true;
        const refreshBtn = document.getElementById('refreshRequestsBtn');
        const refreshIcon = document.getElementById('refreshIcon');
        const refreshText = document.getElementById('refreshBtnText');

        // Add loading state
        if (refreshBtn) {
          refreshBtn.disabled = true;
          refreshBtn.style.opacity = '0.7';
          refreshBtn.style.cursor = 'not-allowed';
        }
        if (refreshIcon) {
          refreshIcon.style.transform = 'rotate(360deg)';
        }
        if (refreshText) {
          refreshText.textContent = 'LÃ¤dt...';
        }

        try {
          const beforeCount = allRequests.length;
          await loadRequests();
          const afterCount = allRequests.length;
          const newRequestsCount = afterCount - beforeCount;

          // Show success notification
          if (refreshText) {
            refreshText.textContent = `âœ“ ${allRequests.length} Requests geladen`;
          }

          // Reset button after 2 seconds
          setTimeout(() => {
            if (refreshText) refreshText.textContent = 'Neue Requests laden';
            if (refreshBtn) {
              refreshBtn.disabled = false;
              refreshBtn.style.opacity = '1';
              refreshBtn.style.cursor = 'pointer';
            }
            if (refreshIcon) {
              refreshIcon.style.transform = 'rotate(0deg)';
            }
          }, 2000);

          console.log(`âœ… Refreshed: ${allRequests.length} total requests${newRequestsCount > 0 ? ` (+${newRequestsCount} new)` : ''}`);
        } catch (error) {
          console.error('âŒ Refresh failed:', error);
          if (refreshText) refreshText.textContent = 'âŒ Fehler';

          setTimeout(() => {
            if (refreshText) refreshText.textContent = 'Neue Requests laden';
            if (refreshBtn) {
              refreshBtn.disabled = false;
              refreshBtn.style.opacity = '1';
              refreshBtn.style.cursor = 'pointer';
            }
            if (refreshIcon) {
              refreshIcon.style.transform = 'rotate(0deg)';
            }
          }, 2000);
        } finally {
          isRefreshing = false;
        }
      }

      // Auto-Refresh Functionality
      function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);

        autoRefreshInterval = setInterval(() => {
          // Only refresh if no modal is open and we're on the requests section
          const isModalOpen = document.querySelector('.modal.active') ||
                              document.getElementById('requestDetail').querySelector('h2');
          const isRequestsSection = document.getElementById('requests-section').classList.contains('active');

          if (!isModalOpen && isRequestsSection && !isRefreshing) {
            console.log('ðŸ”„ Auto-refreshing requests...');
            refreshRequests();
          }
        }, 30000); // 30 seconds

        console.log('âœ… Auto-refresh enabled (30s interval)');
      }

      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          console.log('âŒ Auto-refresh disabled');
        }
      }

      // Initialize Refresh Button
      document.getElementById('refreshRequestsBtn')?.addEventListener('click', refreshRequests);

      // Initialize Auto-Refresh Toggle
      document.getElementById('autoRefreshToggle')?.addEventListener('change', (e) => {
        if (e.target.checked) {
          startAutoRefresh();
        } else {
          stopAutoRefresh();
        }
      });

      // Image Modal Functions
      window.openImageModal = function(imageUrl) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        if (modal && modalImg) {
          modalImg.src = imageUrl;
          modal.classList.add('active');
        }
      };

      window.closeImageModal = function() {
        const modal = document.getElementById('imageModal');
        if (modal) {
          modal.classList.remove('active');
        }
      };

      function showSection(tab) {
        tabs.forEach(x => x.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));
        tab.classList.add("active");
        
        const tabName = tab.id.replace("tab-", "");
        const target = document.getElementById(tabName + "-section");
        if (target) {
          target.classList.add("active");
          if (tabName === "dashboard") loadDashboard();
          else if (tabName === "requests") {
            loadRequests();
            initRequestTabs();
          }
          else if (tabName === "calendar") renderCalendar();
          else if (tabName === "dienstplan") renderDienstplan();
          else if (tabName === "agreements") {
            updateAgreementsDateDisplay();
            loadAgreements();
          }
          else if (tabName === "artists") loadArtists();
          else if (tabName === "customers") loadCustomers();
        }
      }

      tabs.forEach(tab => tab.addEventListener("click", (e) => {
        e.preventDefault();
        showSection(tab);
      }));

      async function loadInitialData() {
        try {
          // Load all data in parallel for faster initial load
          const [
            { data: artists },
            { data: teamMembers },
            { data: locations }
          ] = await Promise.all([
            supabase.from('artists').select('*'),
            supabase.from('dienstplan_resources')
              .select('*')
              .order('sort_order', { ascending: true })
              .order('name', { ascending: true }),
            supabase.from('locations').select('*').order('name', { ascending: true })
          ]);

          allArtists = artists || [];
          allTeamMembers = teamMembers || [];
          console.log('Artists loaded:', allArtists.length);
          console.log('Team members loaded:', allTeamMembers.length);
          console.log('Locations loaded:', locations?.length);
          
          if (locations && locations.length > 0) {
            // Finde "mommy i'm sorry" oder nimm die erste Location
            const mommyLocation = locations.find(l => l.name.toLowerCase().includes("mommy"));
            selectedLocationId = mommyLocation ? mommyLocation.id : locations[0].id;
            selectedDienstplanLocationId = selectedLocationId;
            
            // Set initial location name and theme
            const initialLocation = locations.find(l => l.id === selectedLocationId);
            if (initialLocation) {
              currentLocationName = initialLocation.name;
              const colors = getLocationColors(currentLocationName);
              applyLocationTheme(colors);
            }
            
            const locSelect = document.getElementById('locationDropdown');
            locSelect.innerHTML = locations.map(l => 
              `<option value="${l.id}" ${l.id === selectedLocationId ? 'selected' : ''}>${l.name}</option>`
            ).join('');
            
            locSelect.onchange = async (e) => {
              selectedLocationId = e.target.value;
              console.log('Location changed to:', selectedLocationId);
              
              // Get location name and apply theme
              const selectedLocation = locations.find(l => l.id === selectedLocationId);
              if (selectedLocation) {
                currentLocationName = selectedLocation.name;
                const colors = getLocationColors(currentLocationName);
                applyLocationTheme(colors);
              }
              
              await loadEvents();
              renderCalendar();
            };
            
            // Dienstplan Location Dropdown
            const dienstplanLocSelect = document.getElementById('dienstplanLocationDropdown');
            dienstplanLocSelect.innerHTML = locations.map(l => 
              `<option value="${l.id}" ${l.id === selectedDienstplanLocationId ? 'selected' : ''}>${l.name}</option>`
            ).join('');
            
            dienstplanLocSelect.onchange = (e) => {
              selectedDienstplanLocationId = e.target.value;
              console.log('Dienstplan location changed to:', selectedDienstplanLocationId);
              renderDienstplan();
            };

            // Artist Location Filter Dropdown
            const artistLocFilter = document.getElementById('artistLocationFilter');
            if (artistLocFilter) {
              // Keep existing options (Alle Locations, Ohne Location) and add dynamic locations
              const locationOptions = locations.map(l =>
                `<option value="${l.id}">${l.name}</option>`
              ).join('');
              artistLocFilter.innerHTML = `
                <option value="">ðŸ“ Alle Locations</option>
                <option value="NULL">âš ï¸ Ohne Location</option>
                ${locationOptions}
              `;
            }

          }

          // Load events and dashboard in parallel
          await Promise.all([
            loadEvents(),
            loadDashboard()
          ]);
        } catch(err) {
          console.error("Load error:", err);
          alert("Error loading data: " + err.message);
        }
      }

      async function loadDashboard() {
        try {
          // Agreements fÃ¼r die nÃ¤chsten 7 Tage laden (nur echte Appointments, keine Events)
          const today = new Date().toISOString().split('T')[0];
          const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

          // Load all dashboard data in parallel
          const [
            { data: reqs },
            { data: artists },
            { data: upcomingEvents }
          ] = await Promise.all([
            supabase.from('requests').select('*'),
            supabase.from('artists').select('*'),
            supabase
              .from('events')
              .select('id, agreement_file_url, customer_id, type')
              .gte('start_time', `${today}T00:00:00`)
              .lte('start_time', `${nextWeek}T23:59:59`)
              .not('type', 'eq', 'events') // Nur echte Appointments, keine "Events"
          ]);
          
          const totalAgreements = upcomingEvents?.filter(e => e.customer_id).length || 0;
          const completedAgreements = upcomingEvents?.filter(e => e.customer_id && e.agreement_file_url).length || 0;
          const pendingAgreements = totalAgreements - completedAgreements;
          
          document.getElementById('badge-pending').textContent = `Pending: ${reqs?.filter(r=>r.status==='pending').length || 0}`;
          document.getElementById('badge-scheduled').textContent = `Scheduled: ${reqs?.filter(r=>r.status==='scheduled').length || 0}`;
          document.getElementById('badge-residents').textContent = `Residents: ${artists?.filter(a=>!a.is_guest).length || 0}`;
          document.getElementById('badge-guests').textContent = `Guests: ${artists?.filter(a=>a.is_guest).length || 0}`;
          document.getElementById('badge-agreements-completed').textContent = `Agreements: ${completedAgreements}/${totalAgreements}`;
          document.getElementById('badge-agreements-pending').textContent = `Missing: ${pendingAgreements}`;
        } catch(err) {
          console.error("Dashboard error:", err);
        }
      }

      let allRequests = [];
      let currentRequestStatus = 'open_request';
      let selectedRequestId = null;
      // currentUser is declared globally outside this scope

      async function loadRequests() {
        try {
          console.log('ðŸ“‹ Loading requests for status:', currentRequestStatus);

          const { data, error } = await supabase
            .from('requests')
            .select(`
              *,
              customer:customers(id, first_name, last_name, email, phone, rank, instagram),
              artist:artists(id, name, email, instagram),
              location:locations(id, name, city)
            `)
            .order('created_at', { ascending: false });

          if (error) throw error;

          allRequests = data || [];
          console.log('âœ… Loaded', allRequests.length, 'requests');

          // Filter by status
          let filteredRequests = allRequests;
          if (currentRequestStatus === 'my-requests') {
            // Filter by assigned user
            filteredRequests = allRequests.filter(r =>
              r.assigned_to_user_id === currentUser?.id ||
              r.assigned_to === currentUser?.username
            );
          } else if (currentRequestStatus !== 'all') {
            filteredRequests = allRequests.filter(r => r.status === currentRequestStatus);
          }

          console.log('ðŸ“Š Filtered to', filteredRequests.length, 'requests for status:', currentRequestStatus);
          renderRequestsList(filteredRequests);
          updateRequestBadges();
        } catch(err) {
          console.error("âŒ Requests error:", err);
          document.getElementById('requestsList').innerHTML = `
            <div style="text-align:center; padding:40px; color:#E53935;">
              <div style="font-size:48px; margin-bottom:16px;">âš ï¸</div>
              <div style="font-size:16px; font-weight:600; margin-bottom:8px;">Fehler beim Laden</div>
              <div style="font-size:14px; color:var(--muted);">${err.message}</div>
            </div>
          `;
        }
      }
      
      function renderRequestsList(requests) {
        const listEl = document.getElementById('requestsList');
        
        // Check if viewing "My Requests" without being logged in
        if (currentRequestStatus === 'my-requests' && !currentUser) {
          listEl.innerHTML = `
            <div style="text-align:center; padding:60px 20px; color:var(--muted);">
              <div style="font-size:48px; margin-bottom:16px;">ðŸ”’</div>
              <div style="font-size:18px; font-weight:600; margin-bottom:8px; color:var(--ink);">Nicht angemeldet</div>
              <div style="font-size:14px;">Bitte melden Sie sich an, um Ihre zugewiesenen Requests zu sehen.</div>
            </div>
          `;
          return;
        }
        
        if (requests.length === 0) {
          let emptyMessage = 'No requests found';
          if (currentRequestStatus === 'my-requests') {
            emptyMessage = 'Sie haben keine zugewiesenen Requests';
          } else if (currentRequestStatus === 'open_request') {
            emptyMessage = 'Keine neuen Requests';
          } else if (currentRequestStatus === 'pending') {
            emptyMessage = 'Keine Requests in Bearbeitung';
          } else if (currentRequestStatus === 'scheduled') {
            emptyMessage = 'Keine geplanten Termine';
          } else if (currentRequestStatus === 'finished') {
            emptyMessage = 'Keine abgeschlossenen Requests';
          } else if (currentRequestStatus === 'canceled') {
            emptyMessage = 'Keine stornierten Requests';
          }
          
          listEl.innerHTML = `<div style="text-align:center; padding:40px; color:var(--muted);">${emptyMessage}</div>`;
          return;
        }
        
        // Status display names mapping
        const statusNames = {
          'open_request': 'New',
          'pending': 'Pending',
          'scheduled': 'Scheduled',
          'finished': 'Finished',
          'canceled': 'Canceled'
        };
        
        listEl.innerHTML = requests.map(req => {
          // Get customer name directly from requests table (first_name, last_name columns)
          const customerName = `${req.first_name || ''} ${req.last_name || ''}`.trim() || 'Unbekannt';

          // Customer rank badge
          const rankBadge = req.customer?.rank
            ? `<span class="rank-badge rank-${req.customer.rank.toLowerCase()}">${req.customer.rank}</span>`
            : '';

          // Location badge
          const locationBadge = req.location?.name
            ? `<span style="font-size:11px; color:var(--muted);">ðŸ“ ${req.location.name}</span>`
            : '';

          // Request number or ID
          const requestNumber = req.request_number || `#${req.id.substring(0, 8).toUpperCase()}`;

          // Priority badge
          const priorityBadge = req.priority && req.priority !== 'normal'
            ? `<span class="priority-badge ${req.priority}">
                ${req.priority === 'urgent' ? 'ðŸ”¥' : req.priority === 'high' ? 'âš¡' : req.priority === 'low' ? 'ðŸ’¤' : ''}
                ${req.priority.toUpperCase()}
              </span>`
            : '';

          // Instagram badge (from customer relation or request field)
          const instagram = req.customer?.instagram || req.instagram;
          const instagramBadge = instagram
            ? `<span style="font-size:11px; color:var(--muted);">ðŸ“· @${instagram.replace('@', '')}</span>`
            : '';

          // Reference images indicator
          const hasImages = req.reference_images && req.reference_images.length > 0;
          const imagesBadge = hasImages
            ? `<span style="font-size:11px; color:var(--accent);">ðŸ–¼ï¸ ${req.reference_images.length} ${req.reference_images.length === 1 ? 'Bild' : 'Bilder'}</span>`
            : '';

          // Artist preference tags
          const artistPreferenceTags = req.artist_preference && req.artist_preference.trim()
            ? req.artist_preference.split(',')
                .map(name => name.trim())
                .filter(name => name.length > 0)
                .map(name => `<span class="artist-tag-small">${name}</span>`)
                .join('')
            : '';

          return `
            <div class="request-item ${req.status === 'open_request' ? 'new-status' : ''}" data-id="${req.id}">
              <div class="request-header">
                <div class="request-id">${requestNumber}</div>
                <div style="display:flex; gap:6px; align-items:center;">
                  ${priorityBadge}
                  <div class="request-badge ${req.status}">${statusNames[req.status] || req.status}</div>
                </div>
              </div>
              <div class="request-name">
                ${customerName}
                ${rankBadge}
              </div>
              ${req.placement ? `<div style="font-size:12px; color:var(--muted); margin-top:4px;">ðŸ“ ${req.placement}</div>` : ''}
              <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;">
                ${locationBadge}
                ${instagramBadge}
                ${imagesBadge}
              </div>
              ${artistPreferenceTags ? `
                <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:8px;">
                  ${artistPreferenceTags}
                </div>
              ` : ''}
              <div class="request-date">${new Date(req.created_at).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
            </div>
          `;
        }).join('');
        
        // Add click handlers with toggle functionality
        document.querySelectorAll('.request-item').forEach(item => {
          item.addEventListener('click', () => {
            const isAlreadyActive = item.classList.contains('active');
            
            // Remove active class from all items
            document.querySelectorAll('.request-item').forEach(i => i.classList.remove('active'));
            
            if (isAlreadyActive) {
              // If clicking on already active item, close detail view
              selectedRequestId = null;
              closeRequestDetail();
            } else {
              // Otherwise, open the clicked item
              item.classList.add('active');
              selectedRequestId = item.dataset.id;
              showRequestDetail(selectedRequestId);
            }
          });
        });
      }
      
      function closeRequestDetail() {
        const detailEl = document.getElementById('requestDetail');
        detailEl.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--muted); font-size:16px;">
            Select a request to view details
          </div>
        `;
      }
      
      function showRequestDetail(requestId) {
        const request = allRequests.find(r => r.id === requestId);
        if (!request) return;

        console.log('ðŸ“‹ Showing request detail:', request);

        const detailEl = document.getElementById('requestDetail');

        // Status display names
        const statusNames = {
          'open_request': 'New',
          'pending': 'Pending',
          'scheduled': 'Scheduled',
          'finished': 'Finished',
          'canceled': 'Canceled'
        };

        // Get customer data directly from requests table (first_name, last_name, email, customer_phone columns)
        // Use customer relation only for rank and instagram
        const customer = {
          first_name: request.first_name,
          last_name: request.last_name,
          email: request.email,
          phone: request.customer_phone,
          rank: request.customer?.rank || null,
          instagram: request.customer?.instagram || request.instagram || null
        };

        const customerName = `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unbekannt';

        // Rank badge styling
        const rankBadgeStyle = customer.rank ? {
          'Platinum': 'background:#FFD700; color:#1d1d1f;',
          'Gold': 'background:#FF8C00; color:white;',
          'Silver': 'background:#C0C0C0; color:#1d1d1f;',
          'Bronze': 'background:#CD7F32; color:white;'
        }[customer.rank] || '' : '';

        let actions = '';

        // Show Edit button only in "My Requests" tab
        if (currentRequestStatus === 'my-requests') {
          actions = `<button class="btn" onclick="editRequest('${request.id}')" style="background:var(--ink); color:white; border:none;">Edit Request</button>`;
        } else {
          // Show status-based actions for other tabs
          if (request.status === 'open_request') {
            actions = `<button class="btn" onclick="assignRequest()" style="background:var(--ink); color:white; border:none;">Assign to Team Member</button>`;
          } else if (request.status === 'pending') {
            actions = `<button class="btn" onclick="scheduleAppointment()" style="background:var(--ink); color:white; border:none;">Schedule Appointment</button>`;
          } else if (request.status === 'scheduled') {
            actions = `
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn" onclick="editAppointment()" style="background:var(--ink); color:white; border:none; flex:1; min-width:140px;">Edit Appointment</button>
                <button class="btn" onclick="resetAppointment()" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1); flex:1; min-width:140px;">Reset</button>
                <button class="btn" onclick="cancelAppointmentRequest()" style="background:#ff9500; color:white; border:none; flex:1; min-width:140px;">Cancel</button>
                <button class="btn" onclick="deleteRequest()" style="background:#dc3545; color:white; border:none; flex:1; min-width:140px;">Delete</button>
              </div>
            `;
          }
        }

        detailEl.innerHTML = `
          <div style="margin-bottom:24px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
              <h2 style="margin:0; font-size:24px; font-weight:600;">
                ${request.request_number || `#${request.id.substring(0, 8).toUpperCase()}`}
              </h2>
              <span class="request-badge ${request.status}" style="font-size:13px; padding:6px 16px;">
                ${statusNames[request.status] || request.status}
              </span>
            </div>
            ${request.location ? `
              <div style="color:var(--muted); font-size:14px;">
                ðŸ“ ${request.location.name}${request.location.city ? ` (${request.location.city})` : ''}
              </div>
            ` : ''}
          </div>

          <div class="detail-section">
            <h3>Customer Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Vorname</div>
                <div class="detail-value">${customer.first_name || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Nachname</div>
                <div class="detail-value">
                  ${customer.last_name || '<span class="no-data-placeholder">No entry data</span>'}
                  ${customer.rank ? `
                    <span style="display:inline-block; margin-left:8px; padding:4px 10px; border-radius:999px; font-size:11px; font-weight:600; ${rankBadgeStyle}">
                      ${customer.rank}
                    </span>
                  ` : ''}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Email</div>
                <div class="detail-value">
                  ${customer.email ? `<a href="mailto:${customer.email}" style="color:var(--accent);">${customer.email}</a>` : '<span class="no-data-placeholder">No entry data</span>'}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Phone</div>
                <div class="detail-value">
                  ${customer.phone ? `<a href="tel:${customer.phone}" style="color:var(--accent);">${customer.phone}</a>` : '<span class="no-data-placeholder">No entry data</span>'}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Instagram</div>
                <div class="detail-value">
                  ${customer.instagram ? `<a href="https://instagram.com/${customer.instagram}" target="_blank" style="color:var(--accent);">@${customer.instagram}</a>` : '<span class="no-data-placeholder">No entry data</span>'}
                </div>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <h3>Request Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Priority</div>
                <div class="detail-value">
                  ${request.priority ? `
                    <span class="priority-badge ${request.priority}">
                      ${request.priority === 'urgent' ? 'ðŸ”¥' : request.priority === 'high' ? 'âš¡' : request.priority === 'normal' ? 'âœ“' : 'ðŸ’¤'}
                      ${request.priority.toUpperCase()}
                    </span>
                  ` : '<span class="no-data-placeholder">No entry data</span>'}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Placement</div>
                <div class="detail-value">${request.placement || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Size</div>
                <div class="detail-value">${request.size || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Style</div>
                <div class="detail-value">${request.style || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Colorway</div>
                <div class="detail-value">${request.colorway || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Booking Type</div>
                <div class="detail-value">${request.booking_type || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Origin</div>
                <div class="detail-value">${request.origin || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
            </div>

            <div class="detail-item" style="margin-top:16px;">
              <div class="detail-label">Artist PrÃ¤ferenz</div>
              <div class="detail-value">
                ${request.artist_preference && request.artist_preference.trim() ? `
                  <div class="artist-preference-tags">
                    ${request.artist_preference.split(',')
                      .map(name => name.trim())
                      .filter(name => name.length > 0)
                      .map(name => `<span class="artist-tag">${name}</span>`)
                      .join('')}
                  </div>
                ` : '<span class="no-data-placeholder">No entry data</span>'}
              </div>
            </div>

            <div class="detail-item" style="margin-top:16px;">
              <div class="detail-label">Description</div>
              <div class="detail-value" style="white-space:pre-wrap;">${request.description || '<span class="no-data-placeholder">No entry data</span>'}</div>
            </div>

            <div class="detail-item" style="margin-top:16px;">
              <div class="detail-label">Reference Images${request.reference_images && request.reference_images.length > 0 ? ` (${request.reference_images.length})` : ''}</div>
              <div class="detail-value">
                ${request.reference_images && request.reference_images.length > 0 ? `
                  <div class="reference-images">
                    ${request.reference_images.map((img, idx) => `
                      <div class="reference-image-thumb" onclick="openImageModal('${img}')">
                        <img src="${img}" alt="Reference ${idx + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                      </div>
                    `).join('')}
                  </div>
                ` : '<span class="no-data-placeholder">No entry data</span>'}
              </div>
            </div>
          </div>

          ${request.artist || request.assigned_to ? `
            <div class="detail-section">
              <h3>Assignment</h3>
              <div class="detail-grid">
                ${request.artist ? `
                  <div class="detail-item">
                    <div class="detail-label">Artist</div>
                    <div class="detail-value">
                      ${request.artist.name}
                      ${request.artist.email ? `<br/><small style="color:var(--muted);">${request.artist.email}</small>` : ''}
                      ${request.artist.instagram ? `<br/><a href="https://instagram.com/${request.artist.instagram}" target="_blank" style="color:var(--accent); font-size:13px;">@${request.artist.instagram}</a>` : ''}
                    </div>
                  </div>
                ` : request.assigned_to ? `
                  <div class="detail-item">
                    <div class="detail-label">Assigned To</div>
                    <div class="detail-value">${request.assigned_to}</div>
                  </div>
                ` : ''}
              </div>
            </div>
          ` : ''}

          ${request.scheduled_date || request.payment_status ? `
            <div class="detail-section">
              <h3>Appointment & Payment</h3>
              <div class="detail-grid">
                ${request.scheduled_date ? `
                  <div class="detail-item">
                    <div class="detail-label">Scheduled Date</div>
                    <div class="detail-value">${new Date(request.scheduled_date).toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                  </div>
                ` : ''}
                ${request.start_time ? `
                  <div class="detail-item">
                    <div class="detail-label">Start Time</div>
                    <div class="detail-value">${request.start_time}</div>
                  </div>
                ` : ''}
                ${request.end_time ? `
                  <div class="detail-item">
                    <div class="detail-label">End Time</div>
                    <div class="detail-value">${request.end_time}</div>
                  </div>
                ` : ''}
                ${request.payment_status ? `
                  <div class="detail-item">
                    <div class="detail-label">Payment Status</div>
                    <div class="detail-value">
                      <span style="padding:4px 12px; border-radius:999px; font-size:12px; font-weight:500; ${
                        request.payment_status === 'fully_paid' ? 'background:#D1FAE5; color:#065F46;' :
                        request.payment_status === 'deposit_paid' ? 'background:#DBEAFE; color:#1E40AF;' :
                        request.payment_status === 'refunded' ? 'background:#FEE2E2; color:#991B1B;' :
                        'background:#FEF3C7; color:#92400E;'
                      }">
                        ${request.payment_status}
                      </span>
                    </div>
                  </div>
                ` : ''}
                ${request.total_amount ? `
                  <div class="detail-item">
                    <div class="detail-label">Total Amount</div>
                    <div class="detail-value">${request.total_amount}â‚¬</div>
                  </div>
                ` : ''}
              </div>
            </div>
          ` : ''}

          ${request.cancel_reason ? `
            <div class="detail-section">
              <h3>Cancellation</h3>
              <div class="detail-item">
                <div class="detail-label">Reason</div>
                <div class="detail-value">${request.cancel_reason}</div>
              </div>
            </div>
          ` : ''}

          ${request.notes ? `
            <div class="detail-section">
              <h3>Notes</h3>
              <div class="detail-value" style="white-space:pre-wrap;">${request.notes}</div>
            </div>
          ` : ''}

          <div class="detail-section">
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Created At</div>
                <div class="detail-value">${new Date(request.created_at).toLocaleString('de-DE')}</div>
              </div>
              ${request.updated_at && request.updated_at !== request.created_at ? `
                <div class="detail-item">
                  <div class="detail-label">Updated At</div>
                  <div class="detail-value">${new Date(request.updated_at).toLocaleString('de-DE')}</div>
                </div>
              ` : ''}
            </div>
          </div>

          ${actions ? `<div class="action-buttons">${actions}</div>` : ''}
        `;
      }
      
      function updateRequestBadges() {
        const newCount = allRequests.filter(r => r.status === 'open_request').length;
        const badgeEl = document.getElementById('badge-new');
        if (badgeEl) {
          badgeEl.textContent = newCount;
          badgeEl.style.display = newCount > 0 ? 'inline-block' : 'none';
        }
      }
      
      // Request Tab Switching is handled in initRequestTabs()
      
      // Assign Request
      window.assignRequest = async function() {
        // Load all users with 'Booking Team' role from profiles
        const { data: bookingTeam } = await supabase
          .from('profiles')
          .select('id, username')
          .eq('role', 'Booking Team');

        const teamMemberSelect = document.getElementById('assignTeamMember');
        teamMemberSelect.innerHTML = '<option value="">-- Select Team Member --</option>' +
          (bookingTeam || []).map(m => `<option value="${m.id}">${m.username}</option>`).join('');

        document.getElementById('assignModal').classList.add('active');
      };
      
      document.getElementById('cancelAssign')?.addEventListener('click', () => {
        document.getElementById('assignModal').classList.remove('active');
      });
      
      document.getElementById('assignForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const userId = document.getElementById('assignTeamMember').value;

        // Get username for display
        const { data: user } = await supabase
          .from('profiles')
          .select('username')
          .eq('id', userId)
          .single();

        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'pending',
              assigned_to_user_id: userId,
              assigned_to: user?.username || 'Unknown' // For display purposes
            })
            .eq('id', selectedRequestId);

          if (error) throw error;

          document.getElementById('assignModal').classList.remove('active');
          document.getElementById('assignForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('Request assigned successfully!');
        } catch (err) {
          alert('Error assigning request: ' + err.message);
        }
      });
      
      // Schedule Appointment
      window.scheduleAppointment = async function() {
        // Load artists
        const { data: artists } = await supabase.from('artists').select('*');
        const artistSelect = document.getElementById('scheduleArtist');
        artistSelect.innerHTML = '<option value="">-- Select Artist --</option>' +
          (artists || []).map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        
        document.getElementById('scheduleModal').classList.add('active');
      };
      
      document.getElementById('cancelSchedule')?.addEventListener('click', () => {
        document.getElementById('scheduleModal').classList.remove('active');
      });
      
      document.getElementById('scheduleForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const artistId = document.getElementById('scheduleArtist').value;
        const date = document.getElementById('scheduleDate').value;
        const startTime = document.getElementById('scheduleStartTime').value;
        const endTime = document.getElementById('scheduleEndTime').value;
        
        try {
          // Get artist name
          const { data: artist } = await supabase
            .from('artists')
            .select('name')
            .eq('id', artistId)
            .single();
          
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'scheduled',
              artist_id: artistId,
              artist_name: artist?.name,
              scheduled_date: date,
              start_time: startTime,
              end_time: endTime
            })
            .eq('id', selectedRequestId);
          
          if (error) throw error;
          
          document.getElementById('scheduleModal').classList.remove('active');
          document.getElementById('scheduleForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('Appointment scheduled successfully!');
        } catch (err) {
          alert('Error scheduling appointment: ' + err.message);
        }
      });
      
      // Cancel Appointment
      window.cancelAppointment = function() {
        document.getElementById('cancelModal').classList.add('active');
      };
      
      document.getElementById('cancelCancelModal')?.addEventListener('click', () => {
        document.getElementById('cancelModal').classList.remove('active');
      });
      
      document.getElementById('cancelForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const reason = document.getElementById('cancelReason').value;
        
        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'canceled',
              cancel_reason: reason
            })
            .eq('id', selectedRequestId);
          
          if (error) throw error;
          
          document.getElementById('cancelModal').classList.remove('active');
          document.getElementById('cancelForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('Appointment canceled');
        } catch (err) {
          alert('Error canceling appointment: ' + err.message);
        }
      });

      // Edit Request Functions
      let editingRequestId = null;

      window.editRequest = async function(requestId) {
        editingRequestId = requestId;
        selectedRequestId = requestId;

        // Find the request
        const request = allRequests.find(r => r.id === requestId);
        if (!request) {
          alert('Request not found');
          return;
        }

        console.log('âœï¸ Editing request in full frame:', request);

        const detailEl = document.getElementById('requestDetail');

        // Status display names
        const statusNames = {
          'open_request': 'New',
          'pending': 'Pending',
          'scheduled': 'Scheduled',
          'finished': 'Finished',
          'canceled': 'Canceled'
        };

        // Get customer data
        const customer = {
          first_name: request.first_name,
          last_name: request.last_name,
          email: request.email,
          phone: request.customer_phone,
          rank: request.customer?.rank || null,
          instagram: request.customer?.instagram || request.instagram || null
        };

        // Rank badge styling
        const rankBadgeStyle = customer.rank ? {
          'Platinum': 'background:#FFD700; color:#1d1d1f;',
          'Gold': 'background:#FF8C00; color:white;',
          'Silver': 'background:#C0C0C0; color:#1d1d1f;',
          'Bronze': 'background:#CD7F32; color:white;'
        }[customer.rank] || '' : '';

        detailEl.innerHTML = `
          <form id="fullFrameEditForm" style="height:100%; display:flex; flex-direction:column;">
            <div style="flex:1; overflow-y:auto;">
              <div style="margin-bottom:24px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                  <h2 style="margin:0; font-size:24px; font-weight:600;">
                    Edit Request: ${request.request_number || `#${request.id.substring(0, 8).toUpperCase()}`}
                  </h2>
                  <span class="request-badge ${request.status}" style="font-size:13px; padding:6px 16px;">
                    ${statusNames[request.status] || request.status}
                  </span>
                </div>
                ${request.location ? `
                  <div style="color:var(--muted); font-size:14px;">
                    ðŸ“ ${request.location.name}${request.location.city ? ` (${request.location.city})` : ''}
                  </div>
                ` : ''}
              </div>

              <!-- Customer Information -->
              <div class="detail-section">
                <h3>Customer Information</h3>
                <div class="detail-grid">
                  <div class="detail-item">
                    <div class="detail-label">Vorname</div>
                    <input type="text" id="fullEditFirstName" value="${request.first_name || ''}" required
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Nachname
                      ${customer.rank ? `
                        <span style="display:inline-block; margin-left:8px; padding:4px 10px; border-radius:999px; font-size:11px; font-weight:600; ${rankBadgeStyle}">
                          ${customer.rank}
                        </span>
                      ` : ''}
                    </div>
                    <input type="text" id="fullEditLastName" value="${request.last_name || ''}" required
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <input type="email" id="fullEditEmail" value="${request.email || ''}" required
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Phone</div>
                    <input type="tel" id="fullEditPhone" value="${request.customer_phone || ''}" required
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Instagram</div>
                    <input type="text" id="fullEditInstagram" value="${request.instagram || ''}" placeholder="@username"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                </div>
              </div>

              <!-- Request Details -->
              <div class="detail-section">
                <h3>Request Details</h3>
                <div class="detail-grid">
                  <div class="detail-item">
                    <div class="detail-label">Priority</div>
                    <select id="fullEditPriority" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                      <option value="">-- Select Priority --</option>
                      <option value="low" ${request.priority === 'low' ? 'selected' : ''}>Low ðŸ’¤</option>
                      <option value="normal" ${request.priority === 'normal' ? 'selected' : ''}>Normal âœ“</option>
                      <option value="high" ${request.priority === 'high' ? 'selected' : ''}>High âš¡</option>
                      <option value="urgent" ${request.priority === 'urgent' ? 'selected' : ''}>Urgent ðŸ”¥</option>
                    </select>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Placement</div>
                    <input type="text" id="fullEditPlacement" value="${request.placement || ''}" placeholder="No entry data"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Size</div>
                    <input type="text" id="fullEditSize" value="${request.size || ''}" placeholder="No entry data"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Style</div>
                    <input type="text" id="fullEditStyle" value="${request.style || ''}" placeholder="No entry data"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Colorway</div>
                    <input type="text" id="fullEditColorway" value="${request.colorway || ''}" placeholder="No entry data"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item" style="grid-column:1/-1;">
                    <div class="detail-label">Description</div>
                    <textarea id="fullEditDescription" rows="4" placeholder="No entry data"
                              style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; resize:vertical;">${request.description || ''}</textarea>
                  </div>
                </div>
              </div>

              <!-- Reference Images -->
              <div class="detail-section">
                <h3>Reference Images</h3>
                <div id="existingReferenceImages" class="reference-images-editable">
                  ${request.reference_images && request.reference_images.length > 0
                    ? request.reference_images.map((img, idx) => `
                      <div class="reference-image-editable" data-image-url="${img}">
                        <img src="${img}" alt="Reference ${idx + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                        <button type="button" class="reference-image-delete" onclick="deleteReferenceImage('${img}')" title="Delete image">Ã—</button>
                      </div>
                    `).join('')
                    : '<div class="no-data-placeholder">No reference images</div>'
                  }
                </div>

                <input type="file" id="imageUploadInput" accept="image/jpeg,image/jpg,image/png,image/webp" multiple style="display:none;">

                <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageUploadInput').click()">
                  <div class="image-upload-icon">ðŸ“¸</div>
                  <div class="image-upload-text"><strong>Click to upload</strong> or drag and drop</div>
                  <div class="image-upload-hint">JPG, PNG, WebP (Max 5MB per file)</div>
                </div>

                <div id="uploadProgress" style="display:none; margin-top:12px;">
                  <div style="background:rgba(0,0,0,0.05); border-radius:8px; height:8px; overflow:hidden;">
                    <div id="uploadProgressBar" style="background:var(--accent); height:100%; width:0%; transition:width 0.3s;"></div>
                  </div>
                  <div id="uploadProgressText" style="font-size:12px; color:var(--muted); margin-top:6px; text-align:center;"></div>
                </div>
              </div>

              <!-- Artist Assignment -->
              <div class="detail-section">
                <h3>Artist Assignment</h3>
                <div class="detail-item">
                  <div class="detail-label">Search Artist</div>
                  <input type="text" id="fullEditArtistSearch" placeholder="Type to search artists..."
                         style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  <div id="fullEditArtistSearchResults" style="display:none; max-height:200px; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); border-radius:8px; margin-top:8px; background:white;"></div>
                  <input type="hidden" id="fullEditArtistId" value="${request.artist_id || ''}">
                  <div id="fullEditSelectedArtist" style="margin-top:8px; font-size:13px; color:var(--muted);">
                    ${request.artist ? `Selected: ${request.artist.name}` : ''}
                  </div>
                </div>
              </div>

              <!-- Appointment Details -->
              <div class="detail-section">
                <h3>Appointment Details</h3>
                <div class="detail-grid">
                  <div class="detail-item">
                    <div class="detail-label">Date</div>
                    <input type="date" id="fullEditScheduledDate" value="${request.scheduled_date || ''}"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Start Time</div>
                    <input type="time" id="fullEditStartTime" value="${request.start_time || ''}"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">End Time</div>
                    <input type="time" id="fullEditEndTime" value="${request.end_time || ''}"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                </div>
              </div>

              <!-- Status Management -->
              <div class="detail-section">
                <h3>Status Management</h3>
                <div class="detail-item">
                  <div class="detail-label">Status</div>
                  <select id="fullEditStatus" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                    <option value="open_request" ${request.status === 'open_request' ? 'selected' : ''}>New Request</option>
                    <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="scheduled" ${request.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                    <option value="finished" ${request.status === 'finished' ? 'selected' : ''}>Finished</option>
                    <option value="canceled" ${request.status === 'canceled' ? 'selected' : ''}>Canceled</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Action Buttons (Fixed Footer) -->
            <div style="margin-top:24px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.1); background:rgba(255,255,255,0.95);">
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
                <button type="submit" class="btn" style="background:var(--ink); color:white; border:none; flex:1; min-width:140px;">
                  ðŸ’¾ Save Changes
                </button>
                <button type="button" class="btn" onclick="scheduleFromEdit()" style="background:#007AFF; color:white; border:none; flex:1; min-width:140px;">
                  ðŸ“… Schedule
                </button>
                <button type="button" class="btn" onclick="cancelFullFrameEdit()" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1); flex:1; min-width:140px;">
                  âœ• Cancel
                </button>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button type="button" class="btn" onclick="resetRequestToOpenFullFrame()" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1); flex:1; min-width:140px;">
                  ðŸ”„ Reset to Open
                </button>
                <button type="button" class="btn" onclick="deleteRequestPermanentlyFullFrame()" style="background:#dc3545; color:white; border:none; flex:1; min-width:140px;">
                  ðŸ—‘ï¸ Delete
                </button>
              </div>
            </div>
          </form>
        `;

        // Setup artist search for full frame edit
        const fullEditArtistSearch = document.getElementById('fullEditArtistSearch');
        const fullEditArtistSearchResults = document.getElementById('fullEditArtistSearchResults');

        if (fullEditArtistSearch) {
          fullEditArtistSearch.addEventListener('input', async (e) => {
            const query = e.target.value.trim().toLowerCase();

            if (query.length < 2) {
              fullEditArtistSearchResults.style.display = 'none';
              return;
            }

            const filteredArtists = allArtists.filter(artist =>
              artist.name.toLowerCase().includes(query)
            );

            if (filteredArtists.length === 0) {
              fullEditArtistSearchResults.innerHTML = '<div style="padding:12px; color:var(--muted); font-size:13px;">No artists found</div>';
              fullEditArtistSearchResults.style.display = 'block';
              return;
            }

            fullEditArtistSearchResults.innerHTML = filteredArtists.map(artist => `
              <div
                onclick="selectFullEditArtist('${artist.id}', '${artist.name.replace(/'/g, "\\'")}')"
                style="padding:12px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.05); transition:background 0.2s;"
                onmouseover="this.style.background='rgba(0,0,0,0.03)'"
                onmouseout="this.style.background='white'">
                <div style="font-weight:500; font-size:14px;">${artist.name}</div>
                ${artist.specialty ? `<div style="font-size:12px; color:var(--muted); margin-top:2px;">${artist.specialty}</div>` : ''}
              </div>
            `).join('');

            fullEditArtistSearchResults.style.display = 'block';
          });
        }

        // Setup form submission
        document.getElementById('fullFrameEditForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await saveFullFrameEdit();
        });

        // Setup image upload handlers
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imageUploadInput = document.getElementById('imageUploadInput');

        // Drag and drop handlers
        imageUploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          imageUploadArea.classList.add('drag-over');
        });

        imageUploadArea.addEventListener('dragleave', (e) => {
          e.preventDefault();
          imageUploadArea.classList.remove('drag-over');
        });

        imageUploadArea.addEventListener('drop', async (e) => {
          e.preventDefault();
          imageUploadArea.classList.remove('drag-over');
          const files = Array.from(e.dataTransfer.files).filter(file =>
            file.type.match(/^image\/(jpeg|jpg|png|webp)$/i)
          );
          if (files.length > 0) {
            await uploadReferenceImages(files);
          }
        });

        // File input handler
        imageUploadInput.addEventListener('change', async (e) => {
          const files = Array.from(e.target.files);
          if (files.length > 0) {
            await uploadReferenceImages(files);
          }
          imageUploadInput.value = ''; // Reset input
        });
      };

      // Helper functions for full frame edit
      window.selectFullEditArtist = function(artistId, artistName) {
        document.getElementById('fullEditArtistId').value = artistId;
        document.getElementById('fullEditArtistSearch').value = artistName;
        document.getElementById('fullEditSelectedArtist').textContent = `Selected: ${artistName}`;
        document.getElementById('fullEditArtistSearchResults').style.display = 'none';
      };

      // Upload reference images
      window.uploadReferenceImages = async function(files) {
        if (!editingRequestId) return;

        const maxSize = 5 * 1024 * 1024; // 5MB
        const validFiles = files.filter(file => {
          if (file.size > maxSize) {
            alert(`File ${file.name} is too large. Maximum size is 5MB.`);
            return false;
          }
          return true;
        });

        if (validFiles.length === 0) return;

        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadProgressText = document.getElementById('uploadProgressText');

        try {
          uploadProgress.style.display = 'block';
          uploadProgressText.textContent = 'Uploading...';

          const request = allRequests.find(r => r.id === editingRequestId);
          const currentImages = request?.reference_images || [];
          const newImageUrls = [];

          for (let i = 0; i < validFiles.length; i++) {
            const file = validFiles[i];
            const progress = ((i + 1) / validFiles.length) * 100;
            uploadProgressBar.style.width = `${progress * 0.8}%`; // Reserve 20% for DB update
            uploadProgressText.textContent = `Uploading ${i + 1} of ${validFiles.length}...`;

            const fileExt = file.name.split('.').pop();
            const fileName = `${editingRequestId}_${Date.now()}_${i}.${fileExt}`;

            // Upload to Supabase Storage
            const { data: uploadData, error: uploadError } = await supabase.storage
              .from('request-images')
              .upload(fileName, file, {
                cacheControl: '3600',
                upsert: false
              });

            if (uploadError) throw uploadError;

            // Get public URL
            const { data: { publicUrl } } = supabase.storage
              .from('request-images')
              .getPublicUrl(fileName);

            newImageUrls.push(publicUrl);
          }

          // Update database with new images
          uploadProgressBar.style.width = '90%';
          uploadProgressText.textContent = 'Saving...';

          const updatedImages = [...currentImages, ...newImageUrls];

          const { error: updateError } = await supabase
            .from('requests')
            .update({ reference_images: updatedImages })
            .eq('id', editingRequestId);

          if (updateError) throw updateError;

          uploadProgressBar.style.width = '100%';
          uploadProgressText.textContent = 'Upload complete!';

          // Reload the request
          await loadRequests();
          const updatedRequest = allRequests.find(r => r.id === editingRequestId);

          // Update the image display
          const existingReferenceImages = document.getElementById('existingReferenceImages');
          if (updatedRequest.reference_images && updatedRequest.reference_images.length > 0) {
            existingReferenceImages.innerHTML = updatedRequest.reference_images.map((img, idx) => `
              <div class="reference-image-editable" data-image-url="${img}">
                <img src="${img}" alt="Reference ${idx + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                <button type="button" class="reference-image-delete" onclick="deleteReferenceImage('${img}')" title="Delete image">Ã—</button>
              </div>
            `).join('');
          }

          setTimeout(() => {
            uploadProgress.style.display = 'none';
            uploadProgressBar.style.width = '0%';
          }, 2000);

        } catch (err) {
          console.error('Error uploading images:', err);
          alert('âŒ Error uploading images: ' + err.message);
          uploadProgress.style.display = 'none';
          uploadProgressBar.style.width = '0%';
        }
      };

      // Delete reference image
      window.deleteReferenceImage = async function(imageUrl) {
        if (!editingRequestId) return;

        const confirmed = confirm('Are you sure you want to delete this image?');
        if (!confirmed) return;

        try {
          const request = allRequests.find(r => r.id === editingRequestId);
          const currentImages = request?.reference_images || [];
          const updatedImages = currentImages.filter(img => img !== imageUrl);

          // Update database
          const { error: updateError } = await supabase
            .from('requests')
            .update({ reference_images: updatedImages })
            .eq('id', editingRequestId);

          if (updateError) throw updateError;

          // Extract filename from URL and delete from storage
          const urlParts = imageUrl.split('/');
          const fileName = urlParts[urlParts.length - 1];

          const { error: deleteError } = await supabase.storage
            .from('request-images')
            .remove([fileName]);

          if (deleteError) {
            console.warn('Warning: Could not delete file from storage:', deleteError);
          }

          // Reload the request
          await loadRequests();
          const updatedRequest = allRequests.find(r => r.id === editingRequestId);

          // Update the image display
          const existingReferenceImages = document.getElementById('existingReferenceImages');
          if (updatedRequest.reference_images && updatedRequest.reference_images.length > 0) {
            existingReferenceImages.innerHTML = updatedRequest.reference_images.map((img, idx) => `
              <div class="reference-image-editable" data-image-url="${img}">
                <img src="${img}" alt="Reference ${idx + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                <button type="button" class="reference-image-delete" onclick="deleteReferenceImage('${img}')" title="Delete image">Ã—</button>
              </div>
            `).join('');
          } else {
            existingReferenceImages.innerHTML = '<div class="no-data-placeholder">No reference images</div>';
          }

        } catch (err) {
          console.error('Error deleting image:', err);
          alert('âŒ Error deleting image: ' + err.message);
        }
      };

      window.saveFullFrameEdit = async function() {
        if (!editingRequestId) return;

        try {
          const updateData = {
            first_name: document.getElementById('fullEditFirstName').value,
            last_name: document.getElementById('fullEditLastName').value,
            email: document.getElementById('fullEditEmail').value,
            customer_phone: document.getElementById('fullEditPhone').value,
            instagram: document.getElementById('fullEditInstagram').value,
            priority: document.getElementById('fullEditPriority').value,
            placement: document.getElementById('fullEditPlacement').value,
            size: document.getElementById('fullEditSize').value,
            style: document.getElementById('fullEditStyle').value,
            colorway: document.getElementById('fullEditColorway').value,
            description: document.getElementById('fullEditDescription').value,
            scheduled_date: document.getElementById('fullEditScheduledDate').value || null,
            start_time: document.getElementById('fullEditStartTime').value || null,
            end_time: document.getElementById('fullEditEndTime').value || null,
            status: document.getElementById('fullEditStatus').value,
            artist_id: document.getElementById('fullEditArtistId').value || null
          };

          const { error } = await supabase
            .from('requests')
            .update(updateData)
            .eq('id', editingRequestId);

          if (error) throw error;

          await loadRequests();
          showRequestDetail(editingRequestId);

          alert('âœ… Request updated successfully!');
          editingRequestId = null;
        } catch (err) {
          console.error('Error updating request:', err);
          alert('âŒ Error updating request: ' + err.message);
        }
      };

      window.cancelFullFrameEdit = function() {
        if (editingRequestId) {
          showRequestDetail(editingRequestId);
          editingRequestId = null;
        } else {
          closeRequestDetail();
        }
      };

      window.scheduleFromEdit = async function() {
        if (!editingRequestId) return;

        // First save current changes
        const confirmed = confirm('Do you want to save your changes before scheduling?');
        if (confirmed) {
          await saveFullFrameEdit();
        }

        // Open schedule modal
        selectedRequestId = editingRequestId;
        await scheduleAppointment();
      };

      window.resetRequestToOpenFullFrame = async function() {
        if (!editingRequestId) return;

        const confirmed = confirm('Are you sure you want to reset this request to "Open Request" status?\n\nThis will remove any assignment and scheduling information.');
        if (!confirmed) return;

        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'open_request',
              assigned_to: null,
              assigned_to_user_id: null,
              artist_id: null,
              scheduled_date: null,
              start_time: null,
              end_time: null
            })
            .eq('id', editingRequestId);

          if (error) throw error;

          await loadRequests();
          showRequestDetail(editingRequestId);

          alert('âœ… Request has been reset to Open Request status');
          editingRequestId = null;
        } catch (err) {
          console.error('Error resetting request:', err);
          alert('âŒ Error resetting request: ' + err.message);
        }
      };

      window.deleteRequestPermanentlyFullFrame = async function() {
        if (!editingRequestId) return;

        const confirmed1 = confirm('âš ï¸ WARNING: Are you sure you want to DELETE this request permanently?\n\nThis action CANNOT be undone and will remove the request from ALL databases!');
        if (!confirmed1) return;

        const confirmed2 = confirm('âš ï¸ FINAL WARNING: This will permanently delete the request and ALL associated data.\n\nType "DELETE" in the next dialog to confirm.');
        if (!confirmed2) return;

        const deleteConfirmation = prompt('Type "DELETE" to confirm permanent deletion:');
        if (deleteConfirmation !== 'DELETE') {
          alert('Deletion cancelled - confirmation text did not match.');
          return;
        }

        try {
          const { error } = await supabase
            .from('requests')
            .delete()
            .eq('id', editingRequestId);

          if (error) throw error;

          await loadRequests();
          closeRequestDetail();

          alert('âœ… Request has been permanently deleted');
          editingRequestId = null;
        } catch (err) {
          console.error('Error deleting request:', err);
          alert('âŒ Error deleting request: ' + err.message);
        }
      };

      // Artist search functionality for edit form
      const editArtistSearch = document.getElementById('editArtistSearch');
      const editArtistSearchResults = document.getElementById('editArtistSearchResults');

      if (editArtistSearch) {
        editArtistSearch.addEventListener('input', async (e) => {
          const query = e.target.value.trim().toLowerCase();

          if (query.length < 2) {
            editArtistSearchResults.style.display = 'none';
            return;
          }

          // Filter artists
          const filteredArtists = allArtists.filter(artist =>
            artist.name.toLowerCase().includes(query)
          );

          if (filteredArtists.length === 0) {
            editArtistSearchResults.innerHTML = '<div style="padding:12px; color:var(--muted); font-size:13px;">No artists found</div>';
            editArtistSearchResults.style.display = 'block';
            return;
          }

          editArtistSearchResults.innerHTML = filteredArtists.map(artist => `
            <div
              onclick="selectEditArtist('${artist.id}', '${artist.name.replace(/'/g, "\\'")}')"
              style="padding:12px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.05); transition:background 0.2s;"
              onmouseover="this.style.background='rgba(0,0,0,0.03)'"
              onmouseout="this.style.background='white'">
              <div style="font-weight:500; font-size:14px;">${artist.name}</div>
              ${artist.specialty ? `<div style="font-size:12px; color:var(--muted); margin-top:2px;">${artist.specialty}</div>` : ''}
            </div>
          `).join('');

          editArtistSearchResults.style.display = 'block';
        });
      }

      // Select artist from search results
      window.selectEditArtist = function(artistId, artistName) {
        document.getElementById('editArtistId').value = artistId;
        document.getElementById('editArtistSearch').value = artistName;
        document.getElementById('editSelectedArtist').textContent = `Selected: ${artistName}`;
        document.getElementById('editArtistSearchResults').style.display = 'none';
      };

      document.getElementById('cancelEditRequest')?.addEventListener('click', () => {
        document.getElementById('editRequestModal').classList.remove('active');
        editingRequestId = null;
      });

      // Submit handler for edit request form
      document.getElementById('editRequestForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!editingRequestId) return;

        try {
          const updateData = {
            first_name: document.getElementById('editFirstName').value,
            last_name: document.getElementById('editLastName').value,
            email: document.getElementById('editEmail').value,
            customer_phone: document.getElementById('editPhone').value,
            instagram: document.getElementById('editInstagram').value,
            priority: document.getElementById('editPriority').value,
            placement: document.getElementById('editPlacement').value,
            size: document.getElementById('editSize').value,
            style: document.getElementById('editStyle').value,
            colorway: document.getElementById('editColorway').value,
            description: document.getElementById('editDescription').value,
            scheduled_date: document.getElementById('editScheduledDate').value || null,
            start_time: document.getElementById('editStartTime').value || null,
            end_time: document.getElementById('editEndTime').value || null,
            status: document.getElementById('editStatus').value,
            artist_id: document.getElementById('editArtistId').value || null
          };

          const { error } = await supabase
            .from('requests')
            .update(updateData)
            .eq('id', editingRequestId);

          if (error) throw error;

          document.getElementById('editRequestModal').classList.remove('active');
          await loadRequests();

          // Reload detail view if still showing this request
          if (selectedRequestId === editingRequestId) {
            showRequestDetail(selectedRequestId);
          }

          alert('âœ… Request updated successfully!');
          editingRequestId = null;
        } catch (err) {
          console.error('Error updating request:', err);
          alert('âŒ Error updating request: ' + err.message);
        }
      });

      window.resetRequestToOpen = async function() {
        if (!editingRequestId) return;

        // Confirmation dialog
        const confirmed = confirm('Are you sure you want to reset this request to "Open Request" status?\n\nThis will remove any assignment and scheduling information.');

        if (!confirmed) return;

        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'open_request',
              assigned_to: null,
              assigned_to_user_id: null,
              artist_id: null,
              scheduled_date: null,
              start_time: null,
              end_time: null
            })
            .eq('id', editingRequestId);

          if (error) throw error;

          document.getElementById('editRequestModal').classList.remove('active');
          await loadRequests();

          // Close detail view or reload it
          selectedRequestId = null;
          closeRequestDetail();

          alert('âœ… Request has been reset to Open Request status');
          editingRequestId = null;
        } catch (err) {
          console.error('Error resetting request:', err);
          alert('âŒ Error resetting request: ' + err.message);
        }
      };

      window.deleteRequestPermanently = async function() {
        if (!editingRequestId) return;

        // First confirmation
        const confirmed1 = confirm('âš ï¸ WARNING: Are you sure you want to DELETE this request permanently?\n\nThis action CANNOT be undone and will remove the request from ALL databases!');

        if (!confirmed1) return;

        // Second confirmation
        const confirmed2 = confirm('âš ï¸ FINAL WARNING: This will permanently delete the request and ALL associated data.\n\nType "DELETE" in the next dialog to confirm.');

        if (!confirmed2) return;

        // Third confirmation with text input
        const deleteConfirmation = prompt('Type "DELETE" to confirm permanent deletion:');

        if (deleteConfirmation !== 'DELETE') {
          alert('âŒ Deletion cancelled. You must type "DELETE" exactly to confirm.');
          return;
        }

        try {
          // Delete from requests table
          const { error } = await supabase
            .from('requests')
            .delete()
            .eq('id', editingRequestId);

          if (error) throw error;

          document.getElementById('editRequestModal').classList.remove('active');
          await loadRequests();

          // Close detail view
          selectedRequestId = null;
          closeRequestDetail();

          alert('âœ… Request has been permanently deleted from all databases');
          editingRequestId = null;
        } catch (err) {
          console.error('Error deleting request:', err);
          alert('âŒ Error deleting request: ' + err.message);
        }
      };

      // Edit Appointment for Scheduled Requests
      window.editAppointment = async function() {
        const request = allRequests.find(r => r.id === selectedRequestId);
        if (!request) return;

        // Load artists
        const { data: artists } = await supabase.from('artists').select('*');
        const artistSelect = document.getElementById('editAppointmentArtist');
        artistSelect.innerHTML = '<option value="">-- Select Artist --</option>' +
          (artists || []).map(a => `<option value="${a.id}">${a.name}</option>`).join('');

        // Pre-fill form with current values
        document.getElementById('editAppointmentArtist').value = request.artist_id || '';
        document.getElementById('editAppointmentDate').value = request.scheduled_date || '';
        document.getElementById('editAppointmentStartTime').value = request.start_time || '';
        document.getElementById('editAppointmentEndTime').value = request.end_time || '';

        document.getElementById('editAppointmentModal').classList.add('active');
      };

      document.getElementById('cancelEditAppointment')?.addEventListener('click', () => {
        document.getElementById('editAppointmentModal').classList.remove('active');
      });

      document.getElementById('editAppointmentForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const artistId = document.getElementById('editAppointmentArtist').value;
        const date = document.getElementById('editAppointmentDate').value;
        const startTime = document.getElementById('editAppointmentStartTime').value;
        const endTime = document.getElementById('editAppointmentEndTime').value;

        try {
          // Get artist name
          const { data: artist } = await supabase
            .from('artists')
            .select('name')
            .eq('id', artistId)
            .single();

          const { error } = await supabase
            .from('requests')
            .update({
              artist_id: artistId,
              scheduled_date: date,
              start_time: startTime,
              end_time: endTime
            })
            .eq('id', selectedRequestId);

          if (error) throw error;

          document.getElementById('editAppointmentModal').classList.remove('active');
          document.getElementById('editAppointmentForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('âœ… Appointment updated successfully!');
        } catch (err) {
          console.error('Error updating appointment:', err);
          alert('âŒ Error updating appointment: ' + err.message);
        }
      });

      // Reset Appointment (clear appointment details but keep status scheduled)
      window.resetAppointment = async function() {
        if (!confirm('Are you sure you want to reset this appointment?\n\nThis will clear the artist, date, and time details but keep the request in "Scheduled" status.')) {
          return;
        }

        try {
          const { error } = await supabase
            .from('requests')
            .update({
              artist_id: null,
              scheduled_date: null,
              start_time: null,
              end_time: null
            })
            .eq('id', selectedRequestId);

          if (error) throw error;

          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('âœ… Appointment details reset successfully!');
        } catch (err) {
          console.error('Error resetting appointment:', err);
          alert('âŒ Error resetting appointment: ' + err.message);
        }
      };

      // Cancel Appointment Request (set status to canceled)
      window.cancelAppointmentRequest = function() {
        document.getElementById('cancelModal').classList.add('active');
      };

      // Delete Request (direct delete with confirmation)
      window.deleteRequest = async function() {
        if (!confirm('âš ï¸ WARNING: Are you sure you want to DELETE this request permanently?\n\nThis action CANNOT be undone!')) {
          return;
        }

        try {
          const { error } = await supabase
            .from('requests')
            .delete()
            .eq('id', selectedRequestId);

          if (error) throw error;

          selectedRequestId = null;
          await loadRequests();
          closeRequestDetail();
          alert('âœ… Request deleted successfully!');
        } catch (err) {
          console.error('Error deleting request:', err);
          alert('âŒ Error deleting request: ' + err.message);
        }
      };

      // Auto-move scheduled to finished (check every minute)
      setInterval(async () => {
        const now = new Date();
        const scheduledRequests = allRequests.filter(r => r.status === 'scheduled' && r.scheduled_date && r.end_time);
        
        for (const req of scheduledRequests) {
          const endDateTime = new Date(`${req.scheduled_date}T${req.end_time}`);
          if (now > endDateTime) {
            await supabase
              .from('requests')
              .update({ status: 'finished' })
              .eq('id', req.id);
          }
        }
        
        if (scheduledRequests.length > 0) {
          await loadRequests();
        }
      }, 60000); // Check every minute

      let currentEditArtistId = null;
      let currentEditCustomerId = null;

      
      // Open Add Artist Modal
      document.getElementById('addArtistBtn')?.addEventListener('click', () => {
        // Reset form
        document.getElementById('addArtistForm')?.reset();
        
        // Open modal (location dropdown is static HTML, no need to populate)
        document.getElementById('addArtistModal').classList.add('active');
      });
      
      // Close Add Artist Modal
      document.getElementById('cancelAddArtist')?.addEventListener('click', () => {
        document.getElementById('addArtistModal').classList.remove('active');
      });
      
      // ============================================
      // ARTISTS FILTER FUNCTIONALITY
      // ============================================

      let artistsCache = [];
      let artistsFiltered = [];
      let currentArtistsPage = 1;
      const artistsPageSize = 50;

      async function loadArtists(page = 1) {
        console.log('ðŸ‘¤ Loading artists (page ' + page + ')...');

        try {
          // Load from cache or database
          if (artistsCache.length === 0) {
            const { data, error } = await supabase
              .from('artists')
              .select(`
                *,
                location:locations(id, name, city)
              `)
              .order('name');

            if (error) throw error;

            artistsCache = data || [];
            console.log('âœ… Loaded', artistsCache.length, 'artists into cache');
          }

          // Apply filters
          applyArtistFilters();

          // Apply sorting
          const sorted = sortArtists(artistsFiltered, artistSortConfig.field, artistSortConfig.order);

          // Pagination
          const startIndex = (page - 1) * artistsPageSize;
          const endIndex = startIndex + artistsPageSize;
          const paginatedArtists = sorted.slice(startIndex, endIndex);

          // Render table
          renderArtistsTable(paginatedArtists);

          // Update results count
          document.getElementById('artistsResultCount').textContent = artistsFiltered.length;

          // Render pagination
          renderArtistsPagination(page);

          currentArtistsPage = page;

        } catch (error) {
          console.error('âŒ Failed to load artists:', error);
          const tbody = document.getElementById('artistsTableBody');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#E53935;">Fehler beim Laden der Artists: ' + error.message + '</td></tr>';
          }
        }
      }

      // Apply Artist Filters
      function applyArtistFilters() {
        const searchTerm = document.getElementById('artistSearchInput')?.value.toLowerCase().trim() || '';
        const locationFilter = document.getElementById('artistLocationFilter')?.value || '';
        const rankFilter = document.getElementById('artistRankFilter')?.value || '';
        const typeFilter = document.getElementById('artistTypeFilter')?.value || '';
        const statusFilter = document.getElementById('artistStatusFilter')?.value || '';

        artistsFiltered = artistsCache.filter(artist => {
          // Search filter (Name, Email, Instagram)
          if (searchTerm) {
            const matchesSearch =
              (artist.name && artist.name.toLowerCase().includes(searchTerm)) ||
              (artist.email && artist.email.toLowerCase().includes(searchTerm)) ||
              (artist.instagram && artist.instagram.toLowerCase().includes(searchTerm));

            if (!matchesSearch) return false;
          }

          // Location filter
          if (locationFilter) {
            if (locationFilter === 'NULL') {
              if (artist.location_id !== null) return false;
            } else {
              if (artist.location_id !== locationFilter) return false;
            }
          }

          // Rank filter
          if (rankFilter) {
            if (artist.rank !== rankFilter) return false;
          }

          // Type filter (Guest/Resident)
          if (typeFilter) {
            const isGuest = artist.is_guest === true;
            if (typeFilter === 'guest' && !isGuest) return false;
            if (typeFilter === 'resident' && isGuest) return false;
          }

          // Status filter (Active/Inactive)
          if (statusFilter) {
            const isActive = artist.active === true;
            if (statusFilter === 'active' && !isActive) return false;
            if (statusFilter === 'inactive' && isActive) return false;
          }

          return true;
        });

        console.log('ðŸ” Filtered:', artistsFiltered.length, 'of', artistsCache.length, 'artists');
      }

      // Filter Artists (debounced for search input)
      let filterArtistsTimeout;
      function filterArtists() {
        clearTimeout(filterArtistsTimeout);
        filterArtistsTimeout = setTimeout(() => {
          loadArtists(1); // Reset to page 1 when filtering
        }, 300);
      }

      // Clear Artist Filters
      function clearArtistFilters() {
        document.getElementById('artistSearchInput').value = '';
        document.getElementById('artistLocationFilter').value = '';
        document.getElementById('artistRankFilter').value = '';
        document.getElementById('artistTypeFilter').value = '';
        document.getElementById('artistStatusFilter').value = '';

        loadArtists(1);
      }

      // Render Artists Table
      function renderArtistsTable(artists) {
        const tbody = document.getElementById('artistsTableBody');
        if (!tbody) return;

        if (artists.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--muted);">Keine Artists gefunden. Versuche andere Filter-Einstellungen.</td></tr>';
          return;
        }

        tbody.innerHTML = artists.map(artist => `
          <tr>
            <td>${artist.name || '-'}</td>
            <td>${artist.instagram ? `<span style="color:var(--muted); font-size:13px;">@${artist.instagram}</span>` : '-'}</td>
            <td><span class="type-badge ${artist.is_guest ? 'guest' : 'resident'}">${artist.is_guest ? 'ðŸ‘¥ Guest' : 'ðŸ  Resident'}</span></td>
            <td>${artist.location ? `<span class="location-badge">${artist.location.name}</span>` : '<span style="color:#E53935;">âš ï¸ Keine</span>'}</td>
            <td><span class="rank-badge rank-${artist.rank || 'R1'}">${artist.rank || 'R1'}</span></td>
            <td><span class="status-badge ${artist.active ? 'active' : 'inactive'}">${artist.active ? 'âœ… Aktiv' : 'âŒ Inaktiv'}</span></td>
            <td style="text-align:right;">
              <button class="btn btn-secondary" onclick="editArtist('${artist.id}')" style="padding:6px 12px; font-size:13px; margin-right:4px;">Edit</button>
              <button class="btn btn-danger" onclick="deleteArtist('${artist.id}')" style="padding:6px 12px; font-size:13px;">Delete</button>
            </td>
          </tr>
        `).join('');
      }

      // Render Artists Pagination
      function renderArtistsPagination(currentPage) {
        const totalPages = Math.ceil(artistsFiltered.length / artistsPageSize);
        const container = document.getElementById('artistsTableBody')?.parentElement?.parentElement;

        if (!container) return;

        // Remove old pagination if exists
        let paginationEl = container.querySelector('.pagination-controls');
        if (paginationEl) paginationEl.remove();

        if (totalPages <= 1) return;

        let html = '<div class="pagination-controls">';

        // Previous
        if (currentPage > 1) {
          html += `<button class="btn-pagination" onclick="loadArtists(${currentPage - 1})">â—€ ZurÃ¼ck</button>`;
        }

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<button class="btn-pagination ${i === currentPage ? 'active' : ''}" onclick="loadArtists(${i})">${i}</button>`;
          } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<span class="pagination-dots">...</span>';
          }
        }

        // Next
        if (currentPage < totalPages) {
          html += `<button class="btn-pagination" onclick="loadArtists(${currentPage + 1})">Weiter â–¶</button>`;
        }

        html += '</div>';
        container.insertAdjacentHTML('beforeend', html);
      }

      let allCustomers = [];
      
      // Customers Cache & Pagination
      let customersCache = [];
      let customersFiltered = [];
      let currentCustomersPage = 1;
      const customersPageSize = 50;

      async function loadCustomers(page = 1) {
        console.log('ðŸ‘¥ Loading customers (page ' + page + ')...');

        try {
          // Load from cache or database
          if (customersCache.length === 0) {
            const { data, error } = await supabase
              .from('customers')
              .select('*')
              .order('created_at', { ascending: false });

            if (error) throw error;

            customersCache = data || [];
            allCustomers = customersCache; // Keep for compatibility
            console.log('âœ… Loaded', customersCache.length, 'customers into cache');
          }

          // Apply filters
          applyCustomerFilters();

          // Apply sorting
          const sorted = sortCustomers(customersFiltered, customerSortConfig.field, customerSortConfig.order);

          // Pagination
          const startIndex = (page - 1) * customersPageSize;
          const endIndex = startIndex + customersPageSize;
          const paginatedCustomers = sorted.slice(startIndex, endIndex);

          // Render table
          renderCustomersTable(paginatedCustomers);

          // Update results count
          document.getElementById('customersResultCount').textContent = customersFiltered.length;

          // Render pagination
          renderCustomersPagination(page);

          currentCustomersPage = page;

        } catch (error) {
          console.error('âŒ Failed to load customers:', error);
          const tbody = document.getElementById('customersTableBody');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#E53935;">Fehler beim Laden der Customers: ' + error.message + '</td></tr>';
          }
        }
      }

      // Apply Customer Filters
      function applyCustomerFilters() {
        const searchTerm = document.getElementById('customerSearchInput')?.value.toLowerCase().trim() || '';
        const rankFilter = document.getElementById('customerRankFilter')?.value || '';
        const blacklistFilter = document.getElementById('customerBlacklistFilter')?.value || '';
        const bookingsFilter = document.getElementById('customerBookingsFilter')?.value || '';

        customersFiltered = customersCache.filter(customer => {
          // Search filter (Name, Email, Phone, Instagram)
          if (searchTerm) {
            const matchesSearch =
              (customer.first_name && customer.first_name.toLowerCase().includes(searchTerm)) ||
              (customer.last_name && customer.last_name.toLowerCase().includes(searchTerm)) ||
              (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
              (customer.phone && customer.phone.toLowerCase().includes(searchTerm)) ||
              (customer.instagram && customer.instagram.toLowerCase().includes(searchTerm));

            if (!matchesSearch) return false;
          }

          // Rank filter
          if (rankFilter) {
            if (customer.rank !== rankFilter) return false;
          }

          // Blacklist filter
          if (blacklistFilter) {
            const isBlacklisted = customer.blacklisted === true;
            if (blacklistFilter === 'true' && !isBlacklisted) return false;
            if (blacklistFilter === 'false' && isBlacklisted) return false;
          }

          // Bookings range filter
          if (bookingsFilter) {
            const bookingsCount = customer.total_bookings || 0;
            if (bookingsFilter === '0' && bookingsCount !== 0) return false;
            if (bookingsFilter === '1-2' && (bookingsCount < 1 || bookingsCount > 2)) return false;
            if (bookingsFilter === '3-5' && (bookingsCount < 3 || bookingsCount > 5)) return false;
            if (bookingsFilter === '6-10' && (bookingsCount < 6 || bookingsCount > 10)) return false;
            if (bookingsFilter === '11+' && bookingsCount < 11) return false;
          }

          return true;
        });

        console.log('ðŸ” Filtered:', customersFiltered.length, 'of', customersCache.length, 'customers');
      }

      // Filter Customers with Debouncing
      let filterCustomersTimeout;
      function filterCustomers() {
        clearTimeout(filterCustomersTimeout);
        filterCustomersTimeout = setTimeout(() => {
          loadCustomers(1); // Reset to page 1 when filtering
        }, 300);
      }

      // Clear Customer Filters
      function clearCustomerFilters() {
        document.getElementById('customerSearchInput').value = '';
        document.getElementById('customerRankFilter').value = '';
        document.getElementById('customerBlacklistFilter').value = '';
        document.getElementById('customerBookingsFilter').value = '';
        loadCustomers(1);
      }

      // Render Customers Table
      function renderCustomersTable(customers) {
        const tbody = document.getElementById('customersTableBody');

        if (!tbody) {
          console.error('âŒ customersTableBody not found');
          return;
        }

        if (customers.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--muted);">Keine Customers gefunden</td></tr>';
          return;
        }

        tbody.innerHTML = customers.map(customer => {
          // Rank badge
          const rankBadge = customer.rank
            ? `<span class="rank-badge rank-${customer.rank.toLowerCase()}">${customer.rank}</span>`
            : '-';

          // Blacklist badge
          const blacklistBadge = customer.blacklisted
            ? '<span style="background:#FEE2E2; color:#991B1B; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:600;">ðŸš« Blacklisted</span>'
            : '';

          return `
            <tr>
              <td>${customer.first_name || '-'}</td>
              <td>${customer.last_name || '-'}</td>
              <td>${customer.email || '-'}</td>
              <td>${customer.phone || '-'}</td>
              <td>${rankBadge} ${blacklistBadge}</td>
              <td style="font-size:13px; color:var(--muted);">${new Date(customer.created_at).toLocaleDateString()}</td>
              <td style="text-align:right;">
                <button class="btn btn-secondary" onclick="editCustomer('${customer.id}')" style="padding:6px 12px; font-size:13px; margin-right:4px;">Edit</button>
                <button class="btn btn-danger" onclick="deleteCustomer('${customer.id}')" style="padding:6px 12px; font-size:13px;">Delete</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Render Customers Pagination
      function renderCustomersPagination(currentPage) {
        const totalPages = Math.ceil(customersFiltered.length / customersPageSize);
        const container = document.getElementById('customersTableBody')?.parentElement?.parentElement;

        if (!container) return;

        // Remove old pagination if exists
        let paginationEl = container.querySelector('.pagination-controls');
        if (paginationEl) paginationEl.remove();

        if (totalPages <= 1) return;

        let html = '<div class="pagination-controls">';

        // Previous
        if (currentPage > 1) {
          html += `<button class="btn-pagination" onclick="loadCustomers(${currentPage - 1})">â—€ ZurÃ¼ck</button>`;
        }

        // Page numbers with ellipsis
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<button class="btn-pagination ${i === currentPage ? 'active' : ''}" onclick="loadCustomers(${i})">${i}</button>`;
          } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<span class="pagination-dots">...</span>';
          }
        }

        // Next
        if (currentPage < totalPages) {
          html += `<button class="btn-pagination" onclick="loadCustomers(${currentPage + 1})">Weiter â–¶</button>`;
        }

        html += '</div>';
        container.insertAdjacentHTML('beforeend', html);
      }      
      // Customer Sort Controls
      document.getElementById('customerSortBy')?.addEventListener('change', (e) => {
        customerSortConfig.field = e.target.value;
        loadCustomers();
      });
      
      document.getElementById('customerSortOrder')?.addEventListener('click', function() {
        customerSortConfig.order = customerSortConfig.order === 'asc' ? 'desc' : 'asc';
        this.dataset.order = customerSortConfig.order;
        this.innerHTML = customerSortConfig.order === 'asc' ? 'â†‘ Ascending' : 'â†“ Descending';
        loadCustomers();
      });

      // Agreements Functions
      async function loadAgreements() {
        try {
          const dateStr = agreementsDate.toISOString().split('T')[0];

          // Load agreements from agreements table for the selected date
          const { data: agreementData, error } = await supabase
            .from('agreements')
            .select('*')
            .gte('signed_at', `${dateStr}T00:00:00`)
            .lte('signed_at', `${dateStr}T23:59:59`)
            .order('signed_at', { ascending: false });  // Newest first

          if (error) {
            // Check if table doesn't exist (404)
            if (error.code === 'PGRST116' || error.message.includes('relation') || error.message.includes('does not exist')) {
              console.log('Agreements table not yet created - showing empty state');
              renderAgreements([]);
              return;
            }
            throw error;
          }

          console.log(`Agreements loaded for ${dateStr}:`, agreementData?.length);

          // Get artist details
          const agreements = (agreementData || []).map((agreement) => {
            let artistName = '-';
            if (agreement.artist_id) {
              const artist = allArtists.find(a => a.id === agreement.artist_id);
              if (artist) {
                artistName = artist.name;
              }
            }

            const signedTime = new Date(agreement.signed_at);
            const timeStr = signedTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

            return {
              id: agreement.id,
              customerName: agreement.full_name || 'Unknown',
              customerEmail: agreement.email || '-',
              artistName,
              time: timeStr,
              language: agreement.language,
              signatureData: agreement.signature_data
            };
          });

          renderAgreements(agreements);
        } catch (err) {
          console.log("Agreements table not available:", err.message);
          renderAgreements([]);
        }
      }
      
      function renderAgreements(agreements) {
        const tbody = document.getElementById('agreementsTableBody');
        
        if (!agreements || agreements.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px; color:var(--muted);">No agreements for this date</td></tr>';
          return;
        }
        
        tbody.innerHTML = agreements.map(agreement => `
          <tr style="transition:background 0.15s ease;">
            <td>
              <span style="font-weight:500;">${agreement.customerName}</span>
            </td>
            <td>${agreement.customerEmail}</td>
            <td>${agreement.artistName}</td>
            <td style="font-weight:500;">${agreement.time}</td>
            <td style="text-align:center;">
              ${agreement.signatureData 
                ? '<span style="color:#34c759; font-size:20px; font-weight:600;">âœ“</span>' 
                : '<span style="color:#ff3b30; font-size:20px; font-weight:600;">âœ•</span>'}
            </td>
          </tr>
        `).join('');
      }
      
      function updateAgreementsDateDisplay() {
        const dateDisplayEl = document.getElementById('agreementsDateDisplay');
        const datePickerEl = document.getElementById('agreementsDatePickerInput');
        
        if (datePickerEl) {
          datePickerEl.value = agreementsDate.toISOString().split('T')[0];
        }
        
        if (dateDisplayEl) {
          const day = agreementsDate.getDate();
          const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 
                              'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
          const month = monthNames[agreementsDate.getMonth()];
          const year = agreementsDate.getFullYear();
          const weekdayShort = agreementsDate.toLocaleDateString('de-DE', { weekday: 'short' });
          dateDisplayEl.textContent = `${weekdayShort} ${day}. ${month} ${year}`;
        }
      }
      
      // Agreements Date Navigation
      document.getElementById('agreementsPrevDayBtn')?.addEventListener('click', () => {
        agreementsDate.setDate(agreementsDate.getDate() - 1);
        updateAgreementsDateDisplay();
        loadAgreements();
      });
      
      document.getElementById('agreementsNextDayBtn')?.addEventListener('click', () => {
        agreementsDate.setDate(agreementsDate.getDate() + 1);
        updateAgreementsDateDisplay();
        loadAgreements();
      });
      
      document.getElementById('agreementsTodayBtn')?.addEventListener('click', () => {
        agreementsDate = new Date();
        updateAgreementsDateDisplay();
        loadAgreements();
      });
      
      document.getElementById('agreementsDatePickerInput')?.addEventListener('change', (e) => {
        agreementsDate = new Date(e.target.value + 'T12:00:00');
        updateAgreementsDateDisplay();
        loadAgreements();
      });
      
      // Customer Detail Modal
      window.showCustomerDetail = async function(customerId) {
        if (!customerId) return;
        
        try {
          const { data: customer, error } = await supabase
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();
          
          if (error) throw error;
          if (!customer) return;
          
          const content = document.getElementById('customerDetailContent');
          content.innerHTML = `
            <div class="detail-item">
              <div class="detail-label">Name</div>
              <div class="detail-value">${customer.first_name || ''} ${customer.last_name || ''}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Email</div>
              <div class="detail-value">${customer.email || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Phone</div>
              <div class="detail-value">${customer.phone || '-'}</div>
            </div>
            ${customer.rank ? `
              <div class="detail-item">
                <div class="detail-label">Rank</div>
                <div class="detail-value"><span class="customer-rank ${customer.rank.toLowerCase()}">${customer.rank}</span></div>
              </div>
            ` : ''}
            <div class="detail-item">
              <div class="detail-label">Customer Since</div>
              <div class="detail-value">${new Date(customer.created_at).toLocaleDateString('de-DE')}</div>
            </div>
          `;
          
          document.getElementById('customerDetailModal').classList.add('active');
        } catch (err) {
          console.error('Error loading customer:', err);
          alert('Error loading customer details');
        }
      };
      
      document.getElementById('closeCustomerDetail')?.addEventListener('click', () => {
        document.getElementById('customerDetailModal').classList.remove('active');
      });
      
      // File Upload Modal
      window.openFileUpload = async function(eventId) {
        currentAgreementEventId = eventId;
        
        try {
          const { data: event, error } = await supabase
            .from('events')
            .select('title, agreement_file_url, agreement_file_name')
            .eq('id', eventId)
            .single();
          
          if (error) throw error;
          
          // Show existing files if any
          const existingSection = document.getElementById('existingFiles');
          if (event.agreement_file_url) {
            existingSection.innerHTML = `
              <div style="background:var(--location-light); padding:12px; border-radius:8px; margin-bottom:12px;">
                <div style="font-size:13px; font-weight:600; color:var(--location-dark); margin-bottom:4px;">Current File:</div>
                <div style="font-size:14px; color:var(--ink);">${event.agreement_file_name || 'agreement.pdf'}</div>
              </div>
            `;
          } else {
            existingSection.innerHTML = '<div style="color:var(--muted); font-size:13px; margin-bottom:12px;">No files uploaded yet</div>';
          }
          
          document.getElementById('fileUploadModal').classList.add('active');
        } catch (err) {
          console.error('Error loading file info:', err);
        }
      };

      document.getElementById('cancelFileUpload')?.addEventListener('click', () => {
        document.getElementById('fileUploadModal').classList.remove('active');
        document.getElementById('fileUploadInput').value = '';
      });
      
      document.getElementById('fileUploadInput')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          // In a real implementation, upload to Supabase Storage
          // For now, we'll just store the filename
          const { error } = await supabase
            .from('events')
            .update({
              agreement_file_name: file.name,
              agreement_file_url: `uploads/${file.name}` // Placeholder
            })
            .eq('id', currentAgreementEventId);
          
          if (error) throw error;
          
          alert('File uploaded successfully!');
          document.getElementById('fileUploadModal').classList.remove('active');
          document.getElementById('fileUploadInput').value = '';
          loadAgreements();
        } catch (err) {
          console.error('Error uploading file:', err);
          alert('Error uploading file: ' + err.message);
        }
      });


      async function loadEvents() {
        try {
          if (!selectedLocationId) {
            console.log('No location selected');
            events = [];
            return;
          }
          
          const { data, error } = await supabase
            .from('events')
            .select('*')
            .eq('location_id', selectedLocationId);
          
          if (error) throw error;
          
          console.log(`Events loaded for location ${selectedLocationId}:`, data?.length);
          
          events = (data || []).map(e => {
            const artist = allArtists.find(a => a.id === e.artist_id);
            
            // Parse time without timezone conversion
            const parseLocalTime = (timeStr) => {
              const [datePart, timePart] = timeStr.split('T');
              const [hours, minutes] = timePart.split(':').map(Number);
              return hours + minutes / 60;
            };
            
            const startHour = parseLocalTime(e.start_time);
            const endHour = parseLocalTime(e.end_time);
            
            // Determine category:
            // - If no artist_id, it's an 'events' category event
            // - If artist exists and is guest, it's 'guest'
            // - If artist exists and is not guest, it's 'resident'
            let category = 'events';
            if (e.artist_id && artist) {
              category = artist.is_guest ? 'guest' : 'resident';
            }
            
            return {
              id: e.id,
              date: e.start_time.split('T')[0],
              category: category,
              slot: e.slot || 1, // Use slot from database, default to 1 if not set
              title: e.title || artist?.name || 'Event',
              type: e.type || null,
              artistName: artist?.name || null,
              customerName: e.title || null,
              attendanceRequired: e.attendance_required || false,
              startHour: startHour,
              endHour: endHour,
              startTimeRaw: e.start_time,
              endTimeRaw: e.end_time
            };
          });
          
          // Update Location Info
          const { data: locationData } = await supabase
            .from('locations')
            .select('name')
            .eq('id', selectedLocationId)
            .single();
          
          const infoDiv = document.getElementById('locationInfo');
          if (infoDiv) {
            infoDiv.textContent = `ðŸ“ Showing ${events.length} appointment${events.length !== 1 ? 's' : ''} for ${locationData?.name || 'this location'}`;
          }
          
          console.log('Processed events:', events);
        } catch(err) {
          console.error("Events error:", err);
          events = [];
        }
      }

      // Make loadEvents globally available
      window.loadEvents = loadEvents;

      // Find available slot for a given date, category, start and end hour
      function findAvailableSlot(date, category, startHour, endHour) {
        // Get all events for this date and category
        const dateEvents = events.filter(e => 
          e.date === date && 
          e.category === category
        );
        
        // Check each slot from 1-10
        for (let slot = 1; slot <= 10; slot++) {
          // Check if this slot has any overlapping events
          const hasConflict = dateEvents.some(e => 
            e.slot === slot &&
            !(endHour <= e.startHour || startHour >= e.endHour)
          );
          
          if (!hasConflict) {
            return slot; // Found a free slot
          }
        }
        
        return null; // All slots are occupied
      }


      // Helper function to get readable event type labels
      function getEventTypeLabel(type) {
        const typeLabels = {
          'consultation': 'Consultation',
          'new_tattoo': 'New Tattoo',
          'continuing_tattoo': 'Continuing',
          'touch_up': 'Touch Up',
          'selfbooking': 'Selfbooking',
          'wannado': 'WannaDo',
          'internal': 'Internal',
          'move': 'Move',
          'reserved': 'Reserved',
          'no_show': 'No Show'
        };
        return typeLabels[type] || type;
      }
      
      function renderCalendar() {
        const dateStr = currentDate.toISOString().split('T')[0];
        document.getElementById('datePickerInput').value = dateStr;
        
        // Update date display (z.B. "Mo. 20. Oktober 2025")
        const dateDisplayTop = document.getElementById('currentDateDisplayTop');
        if (dateDisplayTop) {
          const day = currentDate.getDate();
          const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 
                              'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
          const month = monthNames[currentDate.getMonth()];
          const year = currentDate.getFullYear();
          const weekdayShort = currentDate.toLocaleDateString('de-DE', { weekday: 'short' });
          const formattedDate = `${weekdayShort} ${day}. ${month} ${year}`;
          dateDisplayTop.textContent = formattedDate;
        }
        
        // Check if today
        const today = new Date();
        const isToday = dateStr === today.toISOString().split('T')[0];
        
        const container = document.getElementById('calendarContainer');
        if (!container) return;

        let html = '<div class="calendar-grid" style="position:relative;">';
        
        html += '<div class="calendar-header"><div class="slot-header">Slots</div>';
        for (let h = 10; h <= 20; h++) html += `<div class="hour-header" style="grid-column:span 2;">${h}:00</div>`;
        html += '</div>';

        // Define categories to render
        const categoriesToRender = [
          { key: 'events', label: 'Events', visible: visibleCategories.events },
          { key: 'resident', label: 'Residents', visible: visibleCategories.residents },
          { key: 'guest', label: 'Guests', visible: visibleCategories.guests }
        ];

        categoriesToRender.forEach(({ key, label, visible }) => {
          const cat = key === 'events' ? 'events' : key;
          
          // Always show category header
          html += '<div class="calendar-header"><div class="category-header">' + label + '</div>';
          for (let h = 10; h <= 20; h++) html += '<div class="category-spacer" style="grid-column:span 2;"></div>';
          html += '</div>';

          // Only show slots if visible
          if (visible) {
            // Calculate max slot for this category and date
            const categoryEvents = events.filter(e => 
              e.date === dateStr && e.category === cat
            );
            
            // Find highest slot number used
            const maxUsedSlot = categoryEvents.length > 0 
              ? Math.max(...categoryEvents.map(e => e.slot || 1))
              : 0;
            
            // Show minimum 5 slots, or more if needed
            const maxSlot = Math.max(5, maxUsedSlot);
            
            for (let slot = 1; slot <= maxSlot; slot++) {
              // Check if this slot has any events
              const slotHasEvents = events.some(e => 
                e.date === dateStr && e.slot === slot && e.category === cat
              );
              
              const rowClass = slotHasEvents ? '' : 'empty-row';
              
              html += `<div class="slot-row ${rowClass}"><div class="slot-label">Slot ${slot}</div>`;
              
              // Collect all events for this slot
              const slotEvents = events.filter(e => 
                e.date === dateStr && e.slot === slot && e.category === cat
              );
              
              // Create cells and track which are occupied
              const cells = [];
              for (let h = 10; h <= 20; h++) {
                [0, 0.5].forEach(offset => {
                  const currentTime = h + offset;
                  cells.push({
                    time: currentTime,
                    occupied: false,
                    event: null
                  });
                });
              }
              
              // Mark cells as occupied by events and create event blocks
              slotEvents.forEach(evt => {
                const startIndex = Math.max(0, Math.floor((evt.startHour - 10) * 2));
                const endIndex = Math.min(cells.length, Math.floor((evt.endHour - 10) * 2));
                const span = endIndex - startIndex;
                
                if (span > 0 && startIndex < cells.length) {
                  cells[startIndex].event = evt;
                  cells[startIndex].span = span;
                  
                  // Mark all cells in the span as occupied
                  for (let i = startIndex; i < endIndex && i < cells.length; i++) {
                    cells[i].occupied = true;
                  }
                }
              });
              
              // Render cells
              cells.forEach((cell, index) => {
                if (cell.event) {
                  // This is the start of an event - create a spanning div
                  const isHalfHour = (index % 2) === 1;
                  const typeAttr = cell.event.type ? `data-type="${cell.event.type}"` : '';
                  
                  // Format start time
                  const startHour = Math.floor(cell.event.startHour);
                  const startMin = Math.round((cell.event.startHour % 1) * 60);
                  const timeStr = `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}`;
                  
                  // Type label mapping
                  const typeLabels = {
                    'consultation': 'Consultation',
                    'new_tattoo': 'New Tattoo',
                    'continuing_tattoo': 'Continuing',
                    'touch_up': 'Touch Up',
                    'selfbooking': 'Selfbooking',
                    'wannado': 'WannaDo',
                    'internal': 'Internal',
                    'move': 'Move',
                    'reserved': 'Reserved',
                    'no_show': 'No Show'
                  };
                  
                  const typeLabel = cell.event.type ? typeLabels[cell.event.type] || cell.event.type : '';
                  
                  // Build content based on category
                  let content = '';
                  if (cat === 'events') {
                    // For events: time, title, and type
                    content = `
                      <div style="font-weight:600; font-size:13px; margin-bottom:2px;">${timeStr}</div>
                      <div style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:2px;">${cell.event.title}</div>
                      ${typeLabel ? `<div style="font-size:10px; color:rgba(0,0,0,0.5); font-weight:500; text-transform:uppercase; letter-spacing:0.3px;">${typeLabel}</div>` : ''}
                    `;
                  } else {
                    // For bookings: time, customer, artist, type
                    content = `
                      <div style="font-weight:600; font-size:13px; margin-bottom:3px;">${timeStr}</div>
                      ${cell.event.customerName ? `<div style="font-size:12px; font-weight:500; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:2px;">${cell.event.customerName}</div>` : ''}
                      ${cell.event.artistName ? `<div style="font-size:11px; color:rgba(0,0,0,0.65); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:2px;">${cell.event.artistName}</div>` : ''}
                      ${typeLabel ? `<div style="font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; opacity:0.8;">${typeLabel}</div>` : ''}
                    `;
                  }
                  
                  // Add attendance required indicator for events
                  const attendanceIndicator = (cat === 'events' && cell.event.attendanceRequired) ? 
                    `<div style="position:absolute; top:8px; right:8px; width:8px; height:8px; background:#ff3b30; border-radius:50%; box-shadow:0 1px 3px rgba(255,59,48,0.4);"></div>` : '';
                  
                  html += `<div class="slot-cell ${isHalfHour ? 'half-hour' : ''}" style="grid-column: span ${cell.span}; position: relative;">
                    <div class="event ${cat}" ${typeAttr} data-event-id="${cell.event.id}" onclick="openEditEventModal('${cell.event.id}')" style="position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px; display:flex; flex-direction:column; justify-content:flex-start; align-items:flex-start; overflow:hidden;">
                      ${content}
                      ${attendanceIndicator}
                    </div>
                  </div>`;
                } else if (!cell.occupied) {
                  // This cell is not part of any event - render empty cell
                  const isHalfHour = (index % 2) === 1;
                  html += `<div class="slot-cell ${isHalfHour ? 'half-hour' : ''}"></div>`;
                }
                // If occupied but not the event start, we skip it (it's covered by the span)
              });
              
              html += '</div>';
            }
          }
        });

        html += '</div>';
        container.innerHTML = html;
        
        // Add current time indicator if today
        if (isToday) {
          addCurrentTimeIndicator();
          // Update every minute
          setInterval(updateCurrentTimeIndicator, 60000);
        }
      }

      // Make renderCalendar globally available
      window.renderCalendar = renderCalendar;

      function addCurrentTimeIndicator() {
        const now = new Date();
        const currentHour = now.getHours() + now.getMinutes() / 60;
        
        // Only show if current time is within calendar range (10-20)
        if (currentHour < 10 || currentHour > 20) return;
        
        updateCurrentTimeIndicator();
      }
      
      function updateCurrentTimeIndicator() {
        // Remove old indicator
        const oldIndicator = document.querySelector('.current-time-indicator');
        if (oldIndicator) oldIndicator.remove();
        
        const now = new Date();
        const currentHour = now.getHours() + now.getMinutes() / 60;
        
        // Only show if current time is within calendar range
        if (currentHour < 10 || currentHour > 20) return;
        
        const calendarGrid = document.querySelector('.calendar-grid');
        if (!calendarGrid) return;
        
        // Calculate position (10:00 = 0%, 20:00 = 100%)
        const startHour = 10;
        const endHour = 20;
        const totalHours = endHour - startHour;
        const hoursFromStart = currentHour - startHour;
        const percentage = (hoursFromStart / totalHours) * 100;
        
        // Calculate pixel position
        // Grid has 1 slot column (120px) + 22 time columns
        const slotColumnWidth = 120;
        const gridWidth = calendarGrid.offsetWidth;
        const timeColumnsWidth = gridWidth - slotColumnWidth;
        const pixelPosition = slotColumnWidth + (timeColumnsWidth * percentage / 100);
        
        const indicator = document.createElement('div');
        indicator.className = 'current-time-indicator';
        indicator.style.left = `${pixelPosition}px`;
        indicator.style.top = '0';
        indicator.style.bottom = '0';
        
        calendarGrid.appendChild(indicator);
      }

      document.getElementById('prevDayBtn').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() - 1);
        renderCalendar();
      });

      document.getElementById('nextDayBtn').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() + 1);
        renderCalendar();
      });

      document.getElementById('todayBtn').addEventListener('click', () => {
        currentDate = new Date();
        renderCalendar();
      });

      document.getElementById('datePickerInput').addEventListener('change', (e) => {
        currentDate = new Date(e.target.value);
        renderCalendar();
      });
      
      // Add Artist Button - Opens Add Artist Modal
      document.getElementById('addArtistBtn')?.addEventListener('click', async () => {
        // Populate location dropdown
        const { data: locations } = await supabase.from('locations').select('*').order('name', { ascending: true });
        const locSelect = document.getElementById('addArtistLocation');
        if (locSelect && locations) {
          locSelect.innerHTML = '<option value="">-- Select Location --</option>' + 
            locations.map(l => `<option value="${l.id}" ${l.id === selectedLocationId ? 'selected' : ''}>${l.name}</option>`).join('');
        }
        
        // Open modal
        document.getElementById('addArtistModal').classList.add('active');
      });
      
      // Cancel Add Artist
      document.getElementById('cancelAddArtist')?.addEventListener('click', () => {
        document.getElementById('addArtistModal').classList.remove('active');
        document.getElementById('addArtistForm').reset();
      });
      
      // Submit Add Artist Form
      document.getElementById('addArtistForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('addArtistName').value.trim();
        const instagram = document.getElementById('addArtistInstagram').value.trim();
        const type = document.getElementById('addArtistType').value;
        const locationId = document.getElementById('addArtistLocation').value;
        const active = document.getElementById('addArtistActive').checked;
        
        if (!name || !locationId) return alert('Please enter name and select location');
        
        try {
          const { error } = await supabase.from('artists').insert({
            name,
            instagram: instagram || null,
            is_guest: type === 'guest',
            active,
            location_id: locationId
          });
          
          if (error) throw error;
          
          document.getElementById('addArtistModal').classList.remove('active');
          document.getElementById('addArtistForm').reset();
          await loadInitialData();
          await loadArtists();      
      // Artist Sort Controls
      document.getElementById('artistSortBy')?.addEventListener('change', (e) => {
        artistSortConfig.field = e.target.value;
        loadArtists();
      });
      
      document.getElementById('artistSortOrder')?.addEventListener('click', function() {
        artistSortConfig.order = artistSortConfig.order === 'asc' ? 'desc' : 'asc';
        this.dataset.order = artistSortConfig.order;
        this.innerHTML = artistSortConfig.order === 'asc' ? 'â†‘ Ascending' : 'â†“ Descending';
        loadArtists();
      });
          alert('Artist added successfully!');
        } catch(err) {
          alert('Error: ' + err.message);
        }
      });
      
      // Add Customer Button - Opens Add Customer Modal
      document.getElementById('addCustomerBtn')?.addEventListener('click', () => {
        document.getElementById('addCustomerModal').classList.add('active');
      });
      
      // Cancel Add Customer
      document.getElementById('cancelAddCustomer')?.addEventListener('click', () => {
        document.getElementById('addCustomerModal').classList.remove('active');
        document.getElementById('addCustomerForm').reset();
      });
      
      // Submit Add Customer Form
      document.getElementById('addCustomerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const firstName = document.getElementById('addCustomerFirstName').value.trim();
        const lastName = document.getElementById('addCustomerLastName').value.trim();
        const email = document.getElementById('addCustomerEmail').value.trim();
        const phone = document.getElementById('addCustomerPhone').value.trim();
        
        if (!firstName || !lastName || !email) {
          return alert('Please fill in first name, last name, and email');
        }
        
        try {
          const { error } = await supabase.from('customers').insert({
            first_name: firstName,
            last_name: lastName,
            email,
            phone: phone || null,
            rank: rank || null
          });
          
          if (error) throw error;
          
          document.getElementById('addCustomerModal').classList.remove('active');
          document.getElementById('addCustomerForm').reset();
          await loadCustomers();
          alert('Customer added successfully!');
        } catch(err) {
          alert('Error: ' + err.message);
        }
      });
      
      // Artist Filter Event Listeners
      document.getElementById('artistSearchInput')?.addEventListener('input', filterArtists);
      document.getElementById('artistLocationFilter')?.addEventListener('change', filterArtists);
      document.getElementById('artistRankFilter')?.addEventListener('change', filterArtists);
      document.getElementById('artistTypeFilter')?.addEventListener('change', filterArtists);
      document.getElementById('artistStatusFilter')?.addEventListener('change', filterArtists);

      // Customer Filter Event Listeners
      document.getElementById('customerSearchInput')?.addEventListener('input', filterCustomers);
      document.getElementById('customerRankFilter')?.addEventListener('change', filterCustomers);
      document.getElementById('customerBlacklistFilter')?.addEventListener('change', filterCustomers);
      document.getElementById('customerBookingsFilter')?.addEventListener('change', filterCustomers);
      
      // Edit Artist Functions
      window.editArtist = async function(artistId) {
        const artist = allArtists.find(a => a.id === artistId);
        if (!artist) return;
        
        currentEditArtistId = artistId;
        
        document.getElementById('editArtistName').value = artist.name;
        document.getElementById('editArtistInstagram').value = artist.instagram || '';
        document.getElementById('editArtistType').value = artist.is_guest ? 'guest' : 'resident';
        
        // Set location dropdown (static values, so just select current)
        document.getElementById('editArtistLocation').value = artist.city_location || '';
        document.getElementById('editArtistRank').value = artist.rank || '';
        document.getElementById('editArtistActive').checked = artist.active;
        
        document.getElementById('editArtistModal').classList.add('active');
      };
      
      document.getElementById('cancelEditArtist')?.addEventListener('click', () => {
        document.getElementById('editArtistModal').classList.remove('active');
        currentEditArtistId = null;
      });
      
      document.getElementById('editArtistForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('editArtistName').value.trim();
        const instagram = document.getElementById('editArtistInstagram').value.trim();
        const type = document.getElementById('editArtistType').value;
        const active = document.getElementById('editArtistActive').checked;
        
        if (!name) return alert('Name is required');
        
        try {
          const location = document.getElementById('editArtistLocation').value;
          const rank = document.getElementById('editArtistRank').value;
          
          const { error } = await supabase
            .from('artists')
            .update({
              name,
              instagram: instagram || null,
              is_guest: type === 'guest',
              city_location: location || null,
              rank: rank || null,
              active
            })
            .eq('id', currentEditArtistId);
          
          if (error) throw error;
          
          document.getElementById('editArtistModal').classList.remove('active');
          currentEditArtistId = null;
          
          // Reload all data to ensure fresh info
          await loadInitialData();
          await loadArtists();
          renderCalendar();
          alert('Artist updated successfully!');
        } catch (err) {
          alert('Error updating artist: ' + err.message);
        }
      });
      
      // Delete Artist Function
      window.deleteArtist = async function(artistId) {
        const artist = allArtists.find(a => a.id === artistId);
        if (!artist) return;
        
        if (!confirm(`Are you sure you want to delete "${artist.name}"? This action cannot be undone.`)) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('artists')
            .delete()
            .eq('id', artistId);
          
          if (error) throw error;
          
          await loadArtists();
          renderCalendar();
          alert('Artist deleted successfully!');
        } catch (err) {
          alert('Error deleting artist: ' + err.message);
        }
      };
      
      // Edit Customer Functions
      window.editCustomer = async function(customerId) {
        try {
          const { data, error } = await supabase
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();
          
          if (error) throw error;
          if (!data) return;
          
          currentEditCustomerId = customerId;
          
          console.log('Loading customer for edit:', data);
          console.log('Customer rank:', data.rank);
          
          document.getElementById('editCustomerFirstName').value = data.first_name || '';
          document.getElementById('editCustomerLastName').value = data.last_name || '';
          document.getElementById('editCustomerEmail').value = data.email || '';
          document.getElementById('editCustomerPhone').value = data.phone || '';
          document.getElementById('editCustomerRank').value = data.rank || '';
          
          console.log('Rank field set to:', document.getElementById('editCustomerRank').value);
          
          document.getElementById('editCustomerModal').classList.add('active');
        } catch (err) {
          alert('Error loading customer: ' + err.message);
        }
      };
      
      document.getElementById('cancelEditCustomer')?.addEventListener('click', () => {
        document.getElementById('editCustomerModal').classList.remove('active');
        currentEditCustomerId = null;
      });
      
      document.getElementById('editCustomerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const firstName = document.getElementById('editCustomerFirstName').value.trim();
        const lastName = document.getElementById('editCustomerLastName').value.trim();
        const email = document.getElementById('editCustomerEmail').value.trim();
        const phone = document.getElementById('editCustomerPhone').value.trim();
        const rank = document.getElementById('editCustomerRank').value;
        
        if (!firstName || !lastName || !email) {
          return alert('First name, last name, and email are required');
        }
        
        try {
          console.log('Updating customer with rank:', rank);
          console.log('Customer ID to update:', currentEditCustomerId);
          
          const updateData = {
            first_name: firstName,
            last_name: lastName,
            email,
            phone: phone || null,
            rank: rank || null
          };
          
          console.log('Update data:', updateData);
          
          const { data, error } = await supabase
            .from('customers')
            .update(updateData)
            .eq('id', currentEditCustomerId)
            .select();
          
          console.log('Update result:', data, 'Error:', error);
          
          if (error) throw error;
          
          if (!data || data.length === 0) {
            console.error('WARNING: Update returned no data. Customer ID might be wrong:', currentEditCustomerId);
            alert('Warning: Customer was updated but could not verify the result. Please refresh the page.');
          }
          
          console.log('Customer updated successfully, reloading list...');
          
          document.getElementById('editCustomerModal').classList.remove('active');
          currentEditCustomerId = null;
          
          // Reload customers to show updated rank
          await loadCustomers();
          
          alert('Customer updated successfully!');
        } catch (err) {
          alert('Error updating customer: ' + err.message);
        }
      });
      
      // Delete Customer Function
      window.deleteCustomer = async function(customerId) {
        try {
          const { data, error } = await supabase
            .from('customers')
            .select('first_name, last_name')
            .eq('id', customerId)
            .single();
          
          if (error) throw error;
          if (!data) return;
          
          if (!confirm(`Are you sure you want to delete "${data.first_name} ${data.last_name}"? This action cannot be undone.`)) {
            return;
          }
          
          const { error: deleteError } = await supabase
            .from('customers')
            .delete()
            .eq('id', customerId);
          
          if (deleteError) throw deleteError;
          
          await loadCustomers();
          alert('Customer deleted successfully!');
        } catch (err) {
          alert('Error deleting customer: ' + err.message);
        }
      };
      
      // Close modals on backdrop click
      document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.addEventListener('click', (e) => {
          if (e.target === backdrop) {
            backdrop.classList.remove('active');
          }
        });
      });
      
      // Create Event Functions
      document.getElementById('createEventBtn')?.addEventListener('click', () => {
        // Set current date as default
        const dateInput = document.getElementById('createEventDate');
        if (dateInput) {
          dateInput.value = currentDate.toISOString().split('T')[0];
        }
        
        // Open modal
        document.getElementById('createEventModal').classList.add('active');
      });
      
      // "All Groups" checkbox handler
      document.getElementById('groupCheckboxAll')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const groupCheckboxes = document.querySelectorAll('.group-checkbox');
        groupCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });
      
      // Individual group checkbox handler - uncheck "All" if any individual is unchecked
      document.querySelectorAll('.group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const allCheckbox = document.getElementById('groupCheckboxAll');
          if (allCheckbox) {
            allCheckbox.checked = allChecked;
          }
        });
      });
      
      document.getElementById('cancelCreateEvent')?.addEventListener('click', () => {
        document.getElementById('createEventModal').classList.remove('active');
        document.getElementById('createEventForm').reset();
      });
      
      document.getElementById('createEventForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('createEventTitle').value.trim();
        const type = document.getElementById('createEventType').value.trim();
        const description = document.getElementById('createEventDescription').value.trim();
        const date = document.getElementById('createEventDate').value;
        const startHour = parseFloat(document.getElementById('createEventStartTime').value);
        const endHour = parseFloat(document.getElementById('createEventEndTime').value);
        const attendanceRequired = document.getElementById('createEventAttendanceRequired').checked;
        
        // Collect selected groups
        const selectedGroups = [];
        const groupCheckboxes = document.querySelectorAll('.group-checkbox:checked');
        groupCheckboxes.forEach(checkbox => {
          selectedGroups.push(checkbox.value);
        });
        
        // Validation
        if (!title || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Events category is always 'events'
        const category = 'events';
        
        // Find available slot
        const slot = findAvailableSlot(date, category, startHour, endHour);
        
        if (slot === null) {
          return alert('All slots are occupied for this time range. Please choose a different time or date.');
        }
        
        try {
          // Create event in Supabase
          const { data, error } = await supabase.from('events').insert({
            title,
            type,
            description: description || null,
            visible_groups: selectedGroups.length > 0 ? selectedGroups : null,
            attendance_required: attendanceRequired,
            slot: slot,
            artist_id: null,
            location_id: selectedLocationId,
            start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
            end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
          });
          
          if (error) throw error;
          
          // Add to local events array
          events.push({
            id: data?.[0]?.id || Date.now(),
            title,
            type,
            description,
            visible_groups: selectedGroups,
            attendance_required: attendanceRequired,
            date,
            slot,
            startHour,
            endHour,
            category,
            artist_id: null
          });
          
          // Close modal and reset form
          document.getElementById('createEventModal').classList.remove('active');
          document.getElementById('createEventForm').reset();
          
          // Uncheck all group checkboxes
          groupCheckboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) checkbox.checked = false;
          });
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event created successfully!');
        } catch (err) {
          console.error('Error creating event:', err);
          alert('Error creating event: ' + err.message);
        }
      });
      
      // Create Booking Button - Opens Create Booking Modal
      document.getElementById('createBookingBtn')?.addEventListener('click', () => {
        // Set current date as default
        const dateInput = document.getElementById('createBookingDate');
        if (dateInput) {
          dateInput.value = currentDate.toISOString().split('T')[0];
        }
        
        // Reset artist search
        document.getElementById('createBookingArtistSearch').value = '';
        document.getElementById('createBookingArtistSearch').disabled = true;
        document.getElementById('createBookingArtistId').value = '';
        document.getElementById('artistSearchResults').style.display = 'none';
        
        // Open modal
        document.getElementById('createBookingModal').classList.add('active');
      });
      
      // Artist Type change handler
      document.getElementById('createBookingArtistType')?.addEventListener('change', (e) => {
        const artistType = e.target.value;
        const searchInput = document.getElementById('createBookingArtistSearch');
        
        if (artistType) {
          searchInput.disabled = false;
          searchInput.value = '';
          document.getElementById('createBookingArtistId').value = '';
          document.getElementById('artistSearchResults').style.display = 'none';
        } else {
          searchInput.disabled = true;
          searchInput.value = '';
          document.getElementById('createBookingArtistId').value = '';
          document.getElementById('artistSearchResults').style.display = 'none';
        }
      });
      
      // Artist search functionality
      document.getElementById('createBookingArtistSearch')?.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        const artistType = document.getElementById('createBookingArtistType').value;
        const resultsDiv = document.getElementById('artistSearchResults');
        
        if (!searchTerm || !artistType) {
          resultsDiv.style.display = 'none';
          return;
        }
        
        // Filter artists by type and search term
        const isGuest = artistType === 'guest';
        const filteredArtists = allArtists.filter(artist => 
          artist.is_guest === isGuest && 
          artist.active &&
          artist.name.toLowerCase().includes(searchTerm)
        );
        
        if (filteredArtists.length === 0) {
          resultsDiv.innerHTML = '<div style="padding:12px; color:var(--muted); font-size:13px;">No artists found</div>';
          resultsDiv.style.display = 'block';
          return;
        }
        
        resultsDiv.innerHTML = filteredArtists.map(artist => `
          <div class="artist-search-result" data-id="${artist.id}" data-name="${artist.name}" style="padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.06); font-size:14px; transition:background 0.15s;">
            ${artist.name}${artist.instagram ? ` <span style="color:var(--muted); font-size:12px;">@${artist.instagram}</span>` : ''}
          </div>
        `).join('');
        
        resultsDiv.style.display = 'block';
        
        // Add click handlers
        document.querySelectorAll('.artist-search-result').forEach(item => {
          item.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(0,113,227,0.06)';
          });
          item.addEventListener('mouseleave', function() {
            this.style.background = '';
          });
          item.addEventListener('click', function() {
            const artistId = this.dataset.id;
            const artistName = this.dataset.name;
            document.getElementById('createBookingArtistSearch').value = artistName;
            document.getElementById('createBookingArtistId').value = artistId;
            resultsDiv.style.display = 'none';
          });
        });
      });
      
      
      // Create Booking Modal Handlers
      document.getElementById('cancelCreateBooking')?.addEventListener('click', () => {
        document.getElementById('createBookingModal').classList.remove('active');
        document.getElementById('createBookingForm').reset();
      });
      
      document.getElementById('createBookingForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const customerName = document.getElementById('createBookingCustomer').value.trim();
        const type = document.getElementById('createBookingType').value;
        const artistId = document.getElementById('createBookingArtistId').value;
        const date = document.getElementById('createBookingDate').value;
        const startHour = parseFloat(document.getElementById('createBookingStartTime').value);
        const endHour = parseFloat(document.getElementById('createBookingEndTime').value);
        
        // Validation
        if (!customerName || !type || !artistId || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Determine category based on artist
        const artist = allArtists.find(a => a.id === artistId);
        const category = artist?.is_guest ? 'guest' : 'resident';
        
        // Find available slot
        const slot = findAvailableSlot(date, category, startHour, endHour);
        
        if (slot === null) {
          return alert('All slots are occupied for this time range. Please choose a different time or date.');
        }
        
        try {
          // Create booking in Supabase events table
          const { data, error } = await supabase.from('events').insert({
            title: customerName,
            type,
            slot: slot,
            artist_id: artistId,
            location_id: selectedLocationId,
            start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
            end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
          });
          
          if (error) throw error;
          
          // Add to local events array
          events.push({
            id: data?.[0]?.id || Date.now(),
            title: customerName,
            type,
            date,
            slot,
            startHour,
            endHour,
            category,
            artist_id: artistId
          });
          
          // Close modal and reset form
          document.getElementById('createBookingModal').classList.remove('active');
          document.getElementById('createBookingForm').reset();
          document.getElementById('createBookingArtistSearch').disabled = true;
          document.getElementById('createBookingArtistId').value = '';
          document.getElementById('artistSearchResults').style.display = 'none';
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Booking created successfully!');
        } catch (err) {
          console.error('Error creating booking:', err);
          alert('Error creating booking: ' + err.message);
        }
      });


      // Edit Event Modal Functions
      window.openEditEventModal = async function(eventId) {
        const event = events.find(e => e.id === eventId);
        if (!event) return;
        
        currentEditingEvent = event;
        
        // Load full event data from Supabase
        const { data, error } = await supabase
          .from('events')
          .select('*')
          .eq('id', eventId)
          .single();
        
        if (error) {
          console.error('Error loading event:', error);
          alert('Error loading event details');
          return;
        }
        
        // Fill form with event data
        document.getElementById('editEventTitle').value = data.title || '';
        document.getElementById('editEventType').value = data.type || '';
        document.getElementById('editEventDescription').value = data.description || '';
        document.getElementById('editEventDate').value = event.date;
        
        // Set time dropdowns with formatted values
        const startTimeValue = event.startHour.toString();
        const endTimeValue = event.endHour.toString();
        
        console.log('Setting start time to:', startTimeValue, 'Available options:', 
          Array.from(document.getElementById('editEventStartTime').options).map(o => o.value));
        console.log('Setting end time to:', endTimeValue, 'Available options:', 
          Array.from(document.getElementById('editEventEndTime').options).map(o => o.value));
        
        document.getElementById('editEventStartTime').value = startTimeValue;
        document.getElementById('editEventEndTime').value = endTimeValue;
        
        // Fallback: if value not set, try to find closest match
        if (!document.getElementById('editEventStartTime').value) {
          console.warn('Start time not set, trying fallback');
          const startSelect = document.getElementById('editEventStartTime');
          for (let option of startSelect.options) {
            if (parseFloat(option.value) === event.startHour) {
              startSelect.value = option.value;
              break;
            }
          }
        }
        
        if (!document.getElementById('editEventEndTime').value) {
          console.warn('End time not set, trying fallback');
          const endSelect = document.getElementById('editEventEndTime');
          for (let option of endSelect.options) {
            if (parseFloat(option.value) === event.endHour) {
              endSelect.value = option.value;
              break;
            }
          }
        }
        
        // Handle artist display (for bookings)
        if (data.artist_id) {
          const artist = allArtists.find(a => a.id === data.artist_id);
          document.getElementById('editEventArtistName').value = artist?.name || 'Unknown Artist';
          document.getElementById('editEventArtistGroup').style.display = 'block';
          document.getElementById('editEventGroupsContainer').style.display = 'none';
          document.getElementById('editEventAttendanceGroup').style.display = 'none';
          document.getElementById('editEventModalTitle').textContent = 'Booking Details';
        } else {
          document.getElementById('editEventArtistGroup').style.display = 'none';
          document.getElementById('editEventGroupsContainer').style.display = 'block';
          document.getElementById('editEventAttendanceGroup').style.display = 'block';
          document.getElementById('editEventModalTitle').textContent = 'Event Details';
          
          // Set visible groups checkboxes
          const visibleGroups = data.visible_groups || [];
          document.querySelectorAll('.edit-group-checkbox').forEach(checkbox => {
            checkbox.checked = visibleGroups.includes(checkbox.value);
          });
          
          // Set "All Groups" checkbox
          const allChecked = document.querySelectorAll('.edit-group-checkbox').length === visibleGroups.length;
          document.getElementById('editGroupCheckboxAll').checked = allChecked;
          
          // Set attendance required
          document.getElementById('editEventAttendanceRequired').checked = data.attendance_required || false;
        }
        
        // Open modal
        document.getElementById('editEventModal').classList.add('active');
      };
      
      // "All Groups" checkbox handler for edit modal
      document.getElementById('editGroupCheckboxAll')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox');
        groupCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });
      
      // Individual group checkbox handler for edit modal
      document.querySelectorAll('.edit-group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.edit-group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const allCheckbox = document.getElementById('editGroupCheckboxAll');
          if (allCheckbox) {
            allCheckbox.checked = allChecked;
          }
        });
      });
      
      // Cancel edit event
      document.getElementById('cancelEditEvent')?.addEventListener('click', () => {
        document.getElementById('editEventModal').classList.remove('active');
        currentEditingEvent = null;
      });
      
      // Delete event
      document.getElementById('deleteEventBtn')?.addEventListener('click', async () => {
        if (!currentEditingEvent) return;
        
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .delete()
            .eq('id', currentEditingEvent.id);
          
          if (error) throw error;
          
          // Remove from local array
          events = events.filter(e => e.id !== currentEditingEvent.id);
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          currentEditingEvent = null;
          
          // Refresh calendar
          renderCalendar();
          
          alert('Event deleted successfully!');
        } catch (err) {
          console.error('Error deleting event:', err);
          alert('Error deleting event: ' + err.message);
        }
      });
      
      // Save edited event
      document.getElementById('editEventForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentEditingEvent) return;
        
        const title = document.getElementById('editEventTitle').value.trim();
        const type = document.getElementById('editEventType').value.trim();
        const description = document.getElementById('editEventDescription').value.trim();
        const date = document.getElementById('editEventDate').value;
        const startHour = parseFloat(document.getElementById('editEventStartTime').value);
        const endHour = parseFloat(document.getElementById('editEventEndTime').value);
        
        // Validation
        if (!title || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Prepare update data
        const updateData = {
          title,
          type,
          description: description || null,
          start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
          end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
        };
        
        // Add event-specific fields (not for bookings)
        if (currentEditingEvent.category === 'events') {
          const selectedGroups = [];
          const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox:checked');
          groupCheckboxes.forEach(checkbox => {
            selectedGroups.push(checkbox.value);
          });
          
          updateData.visible_groups = selectedGroups.length > 0 ? selectedGroups : null;
          updateData.attendance_required = document.getElementById('editEventAttendanceRequired').checked;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .update(updateData)
            .eq('id', currentEditingEvent.id);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          currentEditingEvent = null;
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event updated successfully!');
        } catch (err) {
          console.error('Error updating event:', err);
          alert('Error updating event: ' + err.message);
        }
      });
      
      // Edit Event Modal Functions
      window.openEditEventModal = async function(eventId) {
        const event = events.find(e => e.id === eventId);
        if (!event) {
          console.error('Event not found:', eventId);
          return;
        }
        
        // Load full event data from Supabase to get all fields
        const { data: fullEvent, error } = await supabase
          .from('events')
          .select('*')
          .eq('id', eventId)
          .single();
        
        if (error) {
          console.error('Error loading event:', error);
          alert('Error loading event details');
          return;
        }
        
        // Check if this is a booking (has artist_id) or an event
        if (fullEvent.artist_id) {
          // This is a booking - open booking modal
          openEditBookingModal(eventId, fullEvent, event);
        } else {
          // This is an event - open event modal
          openEditEventModalInternal(eventId, fullEvent, event);
        }
      };
      
      // Internal function to open event modal
      function openEditEventModalInternal(eventId, fullEvent, event) {
        // Populate form fields
        document.getElementById('editEventId').value = eventId;
        document.getElementById('editEventTitle').value = fullEvent.title || '';
        document.getElementById('editEventType').value = fullEvent.type || '';
        document.getElementById('editEventDescription').value = fullEvent.description || '';
        document.getElementById('editEventDate').value = event.date;
        document.getElementById('editEventStartTime').value = event.startHour.toString();
        document.getElementById('editEventEndTime').value = event.endHour.toString();
        document.getElementById('editEventAttendanceRequired').checked = fullEvent.attendance_required || false;
        
        // Clear all group checkboxes first
        document.querySelectorAll('.edit-group-checkbox').forEach(cb => cb.checked = false);
        
        // Set selected groups
        if (fullEvent.visible_groups && Array.isArray(fullEvent.visible_groups)) {
          fullEvent.visible_groups.forEach(group => {
            const checkbox = document.querySelector(`.edit-group-checkbox[value="${group}"]`);
            if (checkbox) checkbox.checked = true;
          });
          
          // Check if all groups are selected
          const allCheckboxes = document.querySelectorAll('.edit-group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          document.getElementById('editGroupCheckboxAll').checked = allChecked;
        }
        
        // Open modal
        document.getElementById('editEventModal').classList.add('active');
      }
      
      // Function to open booking modal
      function openEditBookingModal(bookingId, fullBooking, booking) {
        // Find artist
        const artist = allArtists.find(a => a.id === fullBooking.artist_id);
        
        // Populate form fields
        document.getElementById('editBookingId').value = bookingId;
        document.getElementById('editBookingCustomer').value = fullBooking.title || '';
        document.getElementById('editBookingType').value = fullBooking.type || '';
        document.getElementById('editBookingArtistName').value = artist?.name || 'Unknown Artist';
        document.getElementById('editBookingArtistId').value = fullBooking.artist_id;
        document.getElementById('editBookingDate').value = booking.date;
        document.getElementById('editBookingStartTime').value = booking.startHour.toString();
        document.getElementById('editBookingEndTime').value = booking.endHour.toString();
        
        // Open modal
        document.getElementById('editBookingModal').classList.add('active');
      }
      
      // Edit "All Groups" checkbox handler
      document.getElementById('editGroupCheckboxAll')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox');
        groupCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });
      
      // Individual edit group checkbox handler
      document.querySelectorAll('.edit-group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.edit-group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const allCheckbox = document.getElementById('editGroupCheckboxAll');
          if (allCheckbox) {
            allCheckbox.checked = allChecked;
          }
        });
      });
      
      // Cancel edit event
      document.getElementById('cancelEditEvent')?.addEventListener('click', () => {
        document.getElementById('editEventModal').classList.remove('active');
      });
      
      // Submit edit event form
      document.getElementById('editEventForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const eventId = document.getElementById('editEventId').value;
        const title = document.getElementById('editEventTitle').value.trim();
        const type = document.getElementById('editEventType').value.trim();
        const description = document.getElementById('editEventDescription').value.trim();
        const date = document.getElementById('editEventDate').value;
        const startHour = parseFloat(document.getElementById('editEventStartTime').value);
        const endHour = parseFloat(document.getElementById('editEventEndTime').value);
        const attendanceRequired = document.getElementById('editEventAttendanceRequired').checked;
        
        // Collect selected groups
        const selectedGroups = [];
        const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox:checked');
        groupCheckboxes.forEach(checkbox => {
          selectedGroups.push(checkbox.value);
        });
        
        // Validation
        if (!title || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Get current event to check if date/time changed
        const currentEvent = events.find(e => e.id === eventId);
        let newSlot = currentEvent?.slot || 1;
        
        // If date or time changed, find a new available slot
        if (currentEvent && (currentEvent.date !== date || currentEvent.startHour !== startHour || currentEvent.endHour !== endHour)) {
          // Temporarily remove current event from events array for slot calculation
          const tempEvents = events.filter(e => e.id !== eventId);
          const oldEvents = events;
          events = tempEvents;
          
          const availableSlot = findAvailableSlot(date, 'events', startHour, endHour);
          
          // Restore events array
          events = oldEvents;
          
          if (availableSlot === null) {
            return alert('All slots are occupied for this new time range. Please choose a different time or date.');
          }
          newSlot = availableSlot;
        }
        
        try {
          // Update event in Supabase
          const { error } = await supabase
            .from('events')
            .update({
              title,
              type,
              description: description || null,
              visible_groups: selectedGroups.length > 0 ? selectedGroups : null,
              attendance_required: attendanceRequired,
              slot: newSlot,
              start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
              end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
            })
            .eq('id', eventId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event updated successfully!');
        } catch (err) {
          console.error('Error updating event:', err);
          alert('Error updating event: ' + err.message);
        }
      });
      
      // Delete event
      document.getElementById('deleteEventBtn')?.addEventListener('click', async () => {
        const eventId = document.getElementById('editEventId').value;
        
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .delete()
            .eq('id', eventId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event deleted successfully!');
        } catch (err) {
          console.error('Error deleting event:', err);
          alert('Error deleting event: ' + err.message);
        }
      });
      
      // Edit Booking Modal Functions
      document.getElementById('cancelEditBooking')?.addEventListener('click', () => {
        document.getElementById('editBookingModal').classList.remove('active');
      });
      
      // Submit edit booking form
      document.getElementById('editBookingForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const bookingId = document.getElementById('editBookingId').value;
        const customerName = document.getElementById('editBookingCustomer').value.trim();
        const type = document.getElementById('editBookingType').value;
        const artistId = document.getElementById('editBookingArtistId').value;
        const date = document.getElementById('editBookingDate').value;
        const startHour = parseFloat(document.getElementById('editBookingStartTime').value);
        const endHour = parseFloat(document.getElementById('editBookingEndTime').value);
        
        // Validation
        if (!customerName || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Get current booking to check if date/time changed
        const currentBooking = events.find(e => e.id === bookingId);
        let newSlot = currentBooking?.slot || 1;
        
        // If date or time changed, find a new available slot
        if (currentBooking && (currentBooking.date !== date || currentBooking.startHour !== startHour || currentBooking.endHour !== endHour)) {
          // Determine category
          const artist = allArtists.find(a => a.id === artistId);
          const category = artist?.is_guest ? 'guest' : 'resident';
          
          // Temporarily remove current booking from events array for slot calculation
          const tempEvents = events.filter(e => e.id !== bookingId);
          const oldEvents = events;
          events = tempEvents;
          
          const availableSlot = findAvailableSlot(date, category, startHour, endHour);
          
          // Restore events array
          events = oldEvents;
          
          if (availableSlot === null) {
            return alert('All slots are occupied for this new time range. Please choose a different time or date.');
          }
          newSlot = availableSlot;
        }
        
        try {
          // Update booking in Supabase
          const { error } = await supabase
            .from('events')
            .update({
              title: customerName,
              type,
              slot: newSlot,
              start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
              end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
            })
            .eq('id', bookingId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editBookingModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Booking updated successfully!');
        } catch (err) {
          console.error('Error updating booking:', err);
          alert('Error updating booking: ' + err.message);
        }
      });
      
      // Delete booking
      document.getElementById('deleteBookingBtn')?.addEventListener('click', async () => {
        const bookingId = document.getElementById('editBookingId').value;
        
        if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .delete()
            .eq('id', bookingId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editBookingModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Booking deleted successfully!');
        } catch (err) {
          console.error('Error deleting booking:', err);
          alert('Error deleting booking: ' + err.message);
        }
      });
      
      // Category checkboxes
      document.getElementById('checkEvents').addEventListener('change', (e) => {
        visibleCategories.events = e.target.checked;
        renderCalendar();
      });
      
      document.getElementById('checkResidents').addEventListener('change', (e) => {
        visibleCategories.residents = e.target.checked;
        renderCalendar();
      });
      
      document.getElementById('checkGuests').addEventListener('change', (e) => {
        visibleCategories.guests = e.target.checked;
        renderCalendar();
      });
      
      document.getElementById('prevMonthBtn')?.addEventListener('click', () => {
        dienstplanDate.setMonth(dienstplanDate.getMonth() - 1);
        renderDienstplan();
      });
      
      document.getElementById('nextMonthBtn')?.addEventListener('click', () => {
        dienstplanDate.setMonth(dienstplanDate.getMonth() + 1);
        renderDienstplan();
      });
      
      document.getElementById('currentMonthBtn')?.addEventListener('click', () => {
        dienstplanDate = new Date();
        renderDienstplan();
      });
    });

    function renderDienstplan() {
      const monthDisplay = document.getElementById('dienstplanMonth');
      const container = document.getElementById('dienstplanContainer');
      if (!monthDisplay || !container) return;
      
      const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 
                          'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
      const month = monthNames[dienstplanDate.getMonth()];
      const year = dienstplanDate.getFullYear();
      monthDisplay.textContent = `${month} ${year}`;
      
      // Get location colors
      const locationData = document.querySelector('#dienstplanLocationDropdown option:checked')?.textContent || '';
      const colors = getLocationColors(locationData);
      
      const daysInMonth = new Date(dienstplanDate.getFullYear(), dienstplanDate.getMonth() + 1, 0).getDate();

      // Filter by selected location if applicable
      let filteredMembers = allTeamMembers;
      if (selectedDienstplanLocationId) {
        filteredMembers = allTeamMembers.filter(m =>
          // Show all non-artist roles
          m.category !== 'Resident Artists' ||
          // OR show artists only if they match the location
          (m.category === 'Resident Artists' && m.city_location === getCurrentLocationName())
        );
      }

      // Group team members by category
      const categories = [];
      const categoryNames = ['GeschÃ¤ftsfÃ¼hrung', 'Management', 'Booking Team', 'Mediadepartment', 'Resident Artists', 'Guest Artists', 'Azubis', 'Andere'];
      
      categoryNames.forEach(categoryName => {
        const members = filteredMembers.filter(m => m.category === categoryName && m.active);
        if (members.length > 0 || categoryName === 'Resident Artists' || categoryName === 'Guest Artists') {
          // For Artist categories, use artists instead
          if (categoryName === 'Resident Artists') {
            let residentArtists = allArtists.filter(a => !a.is_guest && a.active);
            // Filter by location if selected
            if (selectedDienstplanLocationId) {
              residentArtists = residentArtists.filter(a => a.city_location === getCurrentLocationName());
            }
            if (residentArtists.length > 0) {
              categories.push({
                name: categoryName,
                people: residentArtists.map(a => a.name)
              });
            }
          } else if (categoryName === 'Guest Artists') {
            const guestArtists = allArtists.filter(a => a.is_guest && a.active);
            if (guestArtists.length > 0) {
              categories.push({
                name: categoryName,
                people: guestArtists.map(a => a.name)
              });
            }
          } else {
            categories.push({
              name: categoryName,
              people: members.map(m => m.name)
            });
          }
        }
      });
      
      let html = '<table style="width:auto; min-width:100%; border-collapse:collapse; background:white; table-layout:fixed;">';
      
      // Header row with days
      html += '<thead><tr>';
      html += '<th style="position:sticky; left:0; z-index:20; background:rgba(249,249,249,0.98); padding:12px; text-align:left; border-right:1px solid rgba(0,0,0,0.06); border-bottom:1px solid rgba(0,0,0,0.06); font-size:13px; color:#666; width:150px; min-width:150px; max-width:150px;">Resources</th>';
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(dienstplanDate.getFullYear(), dienstplanDate.getMonth(), day);
        const weekday = date.toLocaleDateString('de-DE', { weekday: 'short' }).toUpperCase();
        
        // Check if this is today
        const today = new Date();
        const isToday = date.getDate() === today.getDate() && 
                        date.getMonth() === today.getMonth() && 
                        date.getFullYear() === today.getFullYear();
        
        const todayStyle = isToday ? 'background:#ff3b30; color:white;' : `background:${colors.light};`;
        
        html += `<th style="${todayStyle} padding:8px 4px; text-align:center; border-right:1px solid rgba(0,0,0,0.06); border-bottom:1px solid rgba(0,0,0,0.06); font-size:11px; width:80px; min-width:80px; max-width:80px;">
                   <div style="font-size:13px; font-weight:600; ${isToday ? 'color:white;' : 'color:#1d1d1f;'}">${day}</div>
                   <div style="font-size:10px; font-weight:500; ${isToday ? 'color:rgba(255,255,255,0.9);' : 'color:#666;'} margin-top:2px;">${weekday}</div>
                 </th>`;
      }
      html += '</tr></thead>';
      
      html += '<tbody>';
      
      categories.forEach((cat, catIndex) => {
        // Category header row
        html += `<tr class="category-row">
                   <td colspan="${daysInMonth + 1}" style="padding:0; border-bottom:1px solid rgba(0,0,0,0.06);">
                     <button class="category-header-btn" data-category="${catIndex}" style="width:100%; display:flex; align-items:center; justify-content:flex-start; background:#f5f5f5; color:#1d1d1f; border:none; padding:12px 16px; font-size:14px; font-weight:600; cursor:pointer; text-align:left; font-family:inherit;">
                       <span class="arrow" style="margin-right:8px; font-size:12px; display:inline-block; width:16px; transition:transform 0.3s ease;">â–¶</span>
                       <span>${cat.name}</span>
                     </button>
                   </td>
                 </tr>`;
        
        // People rows (hidden by default)
        cat.people.forEach((person, personIndex) => {
          html += `<tr class="person-row" data-category="${catIndex}" style="display:none;">
                     <td style="position:sticky; left:0; z-index:10; background:rgba(255,255,255,0.98); padding:10px 12px 10px 32px; text-align:left; border-right:1px solid rgba(0,0,0,0.06); border-bottom:1px solid rgba(0,0,0,0.06); font-size:13px; color:#1d1d1f; width:150px; min-width:150px; max-width:150px;">${person}</td>`;
          
          for (let day = 1; day <= daysInMonth; day++) {
            html += `<td style="border-right:1px solid rgba(0,0,0,0.06); border-bottom:1px solid rgba(0,0,0,0.06); background:rgba(255,255,255,0.8); cursor:pointer; padding:0; width:80px; min-width:80px; max-width:80px;">
                       <div class="dp-cell" data-cat="${catIndex}" data-person="${personIndex}" data-day="${day}" style="width:100%; height:100%; min-height:40px;"></div>
                     </td>`;
          }
          
          html += '</tr>';
        });
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
      
      // Add event listeners
      document.querySelectorAll('.category-header-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const catIndex = this.dataset.category;
          const arrow = this.querySelector('.arrow');
          const personRows = document.querySelectorAll(`.person-row[data-category="${catIndex}"]`);
          const isOpen = openCategories.has(catIndex);
          
          if (isOpen) {
            personRows.forEach(row => row.style.display = 'none');
            arrow.style.transform = 'rotate(0deg)';
            openCategories.delete(catIndex);
          } else {
            personRows.forEach(row => row.style.display = 'table-row');
            arrow.style.transform = 'rotate(90deg)';
            openCategories.add(catIndex);
          }
        });
      });
      
      // Restore previously open categories
      openCategories.forEach(catIndex => {
        const btn = document.querySelector(`.category-header-btn[data-category="${catIndex}"]`);
        const arrow = btn?.querySelector('.arrow');
        const personRows = document.querySelectorAll(`.person-row[data-category="${catIndex}"]`);
        
        if (btn && arrow) {
          personRows.forEach(row => row.style.display = 'table-row');
          arrow.style.transform = 'rotate(90deg)';
        }
      });
      
      // Cell click handlers with location colors
      document.querySelectorAll('.dp-cell').forEach(cell => {
        cell.addEventListener('click', function() {
          if (!this.classList.contains('working') && !this.classList.contains('off') && !this.classList.contains('vacation')) {
            this.classList.add('working');
            this.style.background = colors.accent;
          } else if (this.classList.contains('working')) {
            this.classList.remove('working');
            this.classList.add('off');
            this.style.background = '#FFEBEE';
          } else if (this.classList.contains('off')) {
            this.classList.remove('off');
            this.classList.add('vacation');
            this.style.background = '#FFF3E0';
          } else {
            this.classList.remove('vacation');
            this.style.background = '';
          }
        });
      });
    }
  </script>

  <!-- Login Modal -->
  <div class="login-backdrop" id="loginBackdrop">
    <div class="login-modal" id="loginModalContent">
      <!-- Login Form View -->
      <div id="loginFormView">
        <div class="login-welcome">
          <h2>Willkommen zurÃ¼ck!</h2>
          <p>Bitte melde dich an, um fortzufahren</p>
        </div>
        <form class="login-form" id="loginForm">
          <div class="form-group">
            <label for="loginUsername">Benutzername</label>
            <input type="text" id="loginUsername" autocomplete="username" required>
          </div>
          <div class="form-group">
            <label for="loginPassword">Passwort</label>
            <input type="password" id="loginPassword" autocomplete="current-password" required>
          </div>
          <div class="login-remember">
            <input type="checkbox" id="rememberMe">
            <label for="rememberMe">Angemeldet bleiben</label>
          </div>
          <div class="login-actions">
            <button type="submit" class="btn btn-primary" style="width: 100%;">Anmelden</button>
            <button type="button" class="btn skip-button" onclick="skipLogin()">Testing: Anmeldung Ã¼berspringen</button>
          </div>
        </form>
      </div>

      <!-- Profile View -->
      <div id="profileView" class="profile-view" style="display: none;">
        <div class="profile-header">
          <img id="profileAvatarLarge" class="profile-avatar-large" src="" alt="Profilbild">
          <h2 id="profileName" style="margin: 0; font-size: 22px;">Username</h2>
        </div>

        <div class="profile-info-group">
          <label>Benutzername</label>
          <div class="profile-info-value" id="profileUsernameValue">â€”</div>
        </div>

        <div class="profile-info-group">
          <label>Passwort</label>
          <div class="password-toggle">
            <div class="profile-info-value" id="profilePasswordValue">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</div>
            <button type="button" onclick="togglePassword()">Anzeigen</button>
          </div>
          <button type="button" class="btn btn-secondary" onclick="showPasswordChangeForm()" style="width: 100%; margin-top: 8px;">Passwort Ã¤ndern</button>
        </div>

        <div id="passwordChangeForm" class="profile-info-group" style="display: none;">
          <label>Neues Passwort</label>
          <input type="password" id="newPassword" placeholder="Neues Passwort" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <input type="password" id="confirmPassword" placeholder="Passwort bestÃ¤tigen" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <div style="display: flex; gap: 8px;">
            <button type="button" class="btn btn-primary" onclick="changePassword()" style="flex: 1;">Speichern</button>
            <button type="button" class="btn btn-secondary" onclick="hidePasswordChangeForm()" style="flex: 1;">Abbrechen</button>
          </div>
        </div>

        <div class="profile-info-group">
          <label>Rolle</label>
          <div>
            <span class="profile-role-badge" id="profileRoleValue">USER</span>
          </div>
        </div>

        <div class="profile-info-group">
          <label>Profilbild</label>
          <button type="button" class="btn btn-primary" onclick="openAvatarUploadModal()" style="width: 100%;">Profilbild editieren</button>
        </div>

        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #eee; display: flex; gap: 12px;">
          <button type="button" class="btn btn-secondary" onclick="closeLoginModal()" style="flex: 1;">SchlieÃŸen</button>
          <button type="button" class="btn btn-danger" onclick="logout()" style="flex: 1;">Abmelden</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Avatar Upload Modal -->
  <div class="modal-backdrop" id="avatarUploadModal">
    <div class="modal" style="max-width: 500px;">
      <h3 style="color:var(--ink); font-weight:500; margin-bottom:20px;">Profilbild editieren</h3>

      <!-- Current Avatar Preview -->
      <div id="currentAvatarPreview" style="text-align:center; margin-bottom:24px;">
        <img id="currentAvatarImg" src="" alt="Aktuelles Profilbild" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:3px solid #f5f5f7;">
      </div>

      <!-- Drag & Drop Zone -->
      <div
        id="avatarDropZone"
        style="border:2px dashed #d1d5db; border-radius:12px; padding:40px 20px; text-align:center; background:#f9fafb; cursor:pointer; transition:all 0.3s; margin-bottom:20px;"
        ondragover="handleDragOver(event)"
        ondragleave="handleDragLeave(event)"
        ondrop="handleDrop(event)"
        onclick="document.getElementById('avatarFileInput').click()">
        <div style="font-size:48px; margin-bottom:12px;">ðŸ“¸</div>
        <div style="font-size:16px; font-weight:500; color:var(--ink); margin-bottom:8px;">
          Bild hier ablegen oder klicken
        </div>
        <div style="font-size:13px; color:var(--muted);">
          PNG, JPG oder GIF (max. 5MB)
        </div>
      </div>

      <!-- Hidden File Input -->
      <input
        type="file"
        id="avatarFileInput"
        accept="image/*"
        style="display:none;"
        onchange="handleFileSelect(event)">

      <!-- Preview Selected Image -->
      <div id="avatarPreviewContainer" style="display:none; margin-bottom:20px; text-align:center;">
        <div style="font-size:14px; font-weight:500; color:var(--ink); margin-bottom:12px;">Vorschau:</div>
        <img id="avatarPreview" src="" alt="Vorschau" style="width:150px; height:150px; border-radius:50%; object-fit:cover; border:3px solid var(--accent);">
        <div id="avatarFileName" style="font-size:13px; color:var(--muted); margin-top:8px;"></div>
      </div>

      <!-- Upload Progress -->
      <div id="uploadProgress" style="display:none; margin-bottom:20px;">
        <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">Uploading...</div>
        <div style="background:#e5e7eb; border-radius:999px; height:8px; overflow:hidden;">
          <div id="uploadProgressBar" style="background:var(--accent); height:100%; width:0%; transition:width 0.3s;"></div>
        </div>
      </div>

      <div class="modal-actions" style="gap:8px;">
        <button type="button" class="btn btn-secondary" onclick="closeAvatarUploadModal()" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1); flex:1;">Abbrechen</button>
        <button type="button" class="btn" id="uploadAvatarBtn" onclick="uploadAvatarFromModal()" disabled style="background:var(--ink); color:white; border:none; flex:1; opacity:0.5;">Hochladen</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // AUTH & PROFILE SYSTEM
    // ============================================

    let currentUser = null;

    // Check for saved session on page load
    async function initAuth() {
      try {
        console.log('ðŸ”„ Initializing authentication...');
        const rememberMe = localStorage.getItem('rememberMe') === 'true';
        const savedUsername = localStorage.getItem('username');

        if (rememberMe && savedUsername) {
          console.log('ðŸ”‘ Found saved session for:', savedUsername);

          // Verify user still exists and get fresh data (case-insensitive)
          const { data: profiles, error } = await supabase
            .from('profiles')
            .select('id, username, email, role, password_hash, avatar_url')
            .ilike('username', savedUsername);

          if (error) {
            console.error('âŒ Database error during session restore:', error);
            localStorage.removeItem('rememberMe');
            localStorage.removeItem('username');
            localStorage.removeItem('userRole');
            localStorage.removeItem('avatarUrl');
          } else if (profiles && profiles.length > 0) {
            const profile = profiles[0];
            console.log('âœ… Session restored successfully for:', profile.username);
            currentUser = profile;
            localStorage.setItem('userRole', profile.role || 'user');

            // Update localStorage with fresh avatar URL from database
            if (profile.avatar_url) {
              localStorage.setItem('avatarUrl', profile.avatar_url);
            } else {
              localStorage.removeItem('avatarUrl');
            }

            // Update UI with complete profile data
            updateUIForUser(profile);
            await initializePermissions();
            return;
          } else {
            console.log('âš ï¸ Saved user not found - clearing session');
            localStorage.removeItem('rememberMe');
            localStorage.removeItem('username');
            localStorage.removeItem('userRole');
            localStorage.removeItem('avatarUrl');
          }
        }

        // Show login modal on first visit
        if (!localStorage.getItem('hasSkippedLogin')) {
          console.log('ðŸ“‹ No session found - showing login modal');
          setTimeout(() => {
            document.getElementById('loginBackdrop').classList.add('active');
          }, 500);
        }
      } catch (err) {
        console.error('ðŸ’¥ Init auth failed:', err);
      }
    }

    // Test Database Connection (for debugging)
    async function testDatabaseConnection() {
      console.log('ðŸ§ª Testing database connection to profiles table...');

      try {
        // Test 1: Select all profiles
        const { data: allProfiles, error: error1 } = await supabase
          .from('profiles')
          .select('*');

        console.log('âœ… Test 1 - All profiles:', allProfiles);
        console.log('âŒ Error 1:', error1);

        // Test 2: Select specific username
        const { data: fayProfile, error: error2 } = await supabase
          .from('profiles')
          .select('*')
          .eq('username', 'Fay');

        console.log('âœ… Test 2 - Fay (exact match):', fayProfile);
        console.log('âŒ Error 2:', error2);

        // Test 3: Select with ilike
        const { data: fayProfileIlike, error: error3 } = await supabase
          .from('profiles')
          .select('*')
          .ilike('username', 'Fay');

        console.log('âœ… Test 3 - Fay (ilike):', fayProfileIlike);
        console.log('âŒ Error 3:', error3);

        // Display results
        let message = 'ðŸ“Š Database Test Results:\n\n';
        message += `Total profiles: ${allProfiles?.length || 0}\n`;
        message += `Fay found (exact): ${fayProfile?.length || 0}\n`;
        message += `Fay found (ilike): ${fayProfileIlike?.length || 0}\n\n`;

        if (allProfiles && allProfiles.length > 0) {
          message += 'Available usernames:\n';
          message += allProfiles.map(p => `- ${p.username}`).join('\n');
        }

        if (error1 || error2 || error3) {
          message += '\n\nâš ï¸ ERRORS DETECTED:\n';
          if (error1) message += `Error 1: ${error1.message}\n`;
          if (error2) message += `Error 2: ${error2.message}\n`;
          if (error3) message += `Error 3: ${error3.message}\n`;
        }

        alert(message);
        console.log('ðŸ“‹ Full test results:', { allProfiles, fayProfile, fayProfileIlike });

      } catch (err) {
        console.error('ðŸ’¥ Database test failed:', err);
        alert('Database test failed: ' + err.message);
      }
    }

    // Login function
    async function handleLogin(e) {
      e.preventDefault();

      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const rememberMe = document.getElementById('rememberMe').checked;

      if (!username || !password) {
        alert('Bitte fÃ¼lle alle Felder aus');
        return;
      }

      // Visual feedback
      const submitButton = e.target.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.textContent = 'Anmelden...';
      submitButton.disabled = true;

      try {
        console.log('ðŸ” Login attempt for:', username);

        // Query user by username (case-insensitive)
        const { data: profiles, error } = await supabase
          .from('profiles')
          .select('id, username, email, role, password_hash, avatar_url')
          .ilike('username', username);

        console.log('ðŸ“Š Query result:', { profiles, error, count: profiles?.length });

        if (error) {
          console.error('âŒ Database error:', error);
          alert('Datenbankfehler: ' + error.message);
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        if (!profiles || profiles.length === 0) {
          console.log('âš ï¸ User not found:', username);
          // Try to see all profiles for debugging (remove in production)
          const { data: allProfiles } = await supabase.from('profiles').select('username');
          console.log('ðŸ“‹ Available usernames:', allProfiles?.map(p => p.username));
          alert('Benutzername nicht gefunden');
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        const profile = profiles[0];
        console.log('ðŸ‘¤ Found user:', profile.username, '| Role:', profile.role);

        // Check if password_hash exists
        if (!profile.password_hash) {
          console.error('âŒ No password set for user:', username);
          alert('Kein Passwort fÃ¼r diesen Benutzer gesetzt. Bitte kontaktiere einen Administrator.');
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        // Check password using bcrypt for hashed passwords
        let passwordMatch = false;

        // Check if password_hash looks like a bcrypt hash (starts with $2a$, $2b$, $2y$)
        if (profile.password_hash.startsWith('$2')) {
          // Use bcrypt to compare
          console.log('ðŸ” Comparing password using bcrypt...');
          passwordMatch = await bcrypt.compare(password, profile.password_hash);
        } else {
          // Direct comparison for plain-text passwords (development/testing only)
          console.log('âš ï¸ Using direct password comparison (not recommended for production)');
          passwordMatch = profile.password_hash === password;
        }

        if (!passwordMatch) {
          console.log('âŒ Wrong password for:', username);
          alert('Falsches Passwort');
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        // Login successful
        console.log('âœ… Login successful for:', profile.username);
        currentUser = profile;

        if (rememberMe) {
          localStorage.setItem('rememberMe', 'true');
          localStorage.setItem('username', profile.username);
          localStorage.setItem('userRole', profile.role || 'user');
          if (profile.avatar_url) {
            localStorage.setItem('avatarUrl', profile.avatar_url);
            console.log('ðŸ’¾ Session saved to localStorage (including avatar)');
          } else {
            console.log('ðŸ’¾ Session saved to localStorage');
          }
        }

        // Update UI
        updateUIForUser(profile);
        closeLoginModal();

        alert(`Willkommen zurÃ¼ck, ${profile.username}!`);

        // Reload data
        await initializePermissions();
        await loadEvents();
        renderCalendar();

        // Reset button state
        submitButton.textContent = originalText;
        submitButton.disabled = false;

      } catch (err) {
        console.error('ðŸ’¥ Login failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      }
    }

    // Update UI for logged-in user
    function updateUIForUser(profile) {
      console.log('ðŸŽ¨ Updating UI for user:', profile.username);
      console.log('ðŸ–¼ï¸ Avatar URL:', profile.avatar_url || 'No avatar URL found');

      const profileButton = document.getElementById('profileButton');
      const profileButtonText = document.getElementById('profileButtonText');
      const profileButtonIcon = document.getElementById('profileButtonIcon');

      profileButtonText.textContent = profile.username;

      // Update profile button avatar
      if (profile.avatar_url) {
        let avatarImg = profileButton.querySelector('.profile-avatar');
        if (!avatarImg) {
          avatarImg = document.createElement('img');
          avatarImg.className = 'profile-avatar';
          avatarImg.onerror = function() {
            console.error('âŒ Failed to load profile button avatar:', profile.avatar_url);
          };
          profileButton.insertBefore(avatarImg, profileButtonText);
        }
        avatarImg.src = profile.avatar_url;

        // Hide default SVG icon when avatar is present
        if (profileButtonIcon) {
          profileButtonIcon.style.display = 'none';
        }

        console.log('âœ… Profile button avatar updated:', profile.avatar_url);
      } else {
        // Remove avatar if not present and show default icon
        const existingAvatar = profileButton.querySelector('.profile-avatar');
        if (existingAvatar) {
          existingAvatar.remove();
        }

        // Show default SVG icon
        if (profileButtonIcon) {
          profileButtonIcon.style.display = 'block';
        }
      }

      // Show welcome message
      const dashboardWelcome = document.getElementById('dashboardWelcome');
      const dashboardWelcomeText = document.getElementById('dashboardWelcomeText');
      const dashboardAvatar = document.getElementById('dashboardAvatar');

      if (dashboardWelcome) {
        dashboardWelcome.style.display = 'flex';
        dashboardWelcomeText.textContent = `Willkommen ${profile.username}`;

        if (profile.avatar_url && dashboardAvatar) {
          dashboardAvatar.src = profile.avatar_url;
          dashboardAvatar.onerror = function() {
            console.error('âŒ Failed to load dashboard avatar:', profile.avatar_url);
          };
          console.log('âœ… Dashboard avatar updated:', profile.avatar_url);
        }
      }

      // Update profile modal fields
      const profileUsername = document.getElementById('profileUsername');
      const profileEmail = document.getElementById('profileEmail');
      const profileRole = document.getElementById('profileRole');
      const profileAvatarPreview = document.getElementById('profileAvatarPreview');

      if (profileUsername) profileUsername.value = profile.username || '';
      if (profileEmail) profileEmail.value = profile.email || '';
      if (profileRole) profileRole.value = profile.role || 'user';
      if (profileAvatarPreview && profile.avatar_url) {
        profileAvatarPreview.src = profile.avatar_url;
      }
    }

    // Close login modal
    function closeLoginModal() {
      document.getElementById('loginBackdrop').classList.remove('active');

      // Reset to login view and hide password change form
      setTimeout(() => {
        document.getElementById('loginFormView').style.display = 'block';
        document.getElementById('profileView').style.display = 'none';
        hidePasswordChangeForm();
      }, 300); // Wait for backdrop animation to finish
    }

    // Skip login
    function skipLogin() {
      localStorage.setItem('hasSkippedLogin', 'true');
      closeLoginModal();
    }

    // Logout
    async function logout() {
      if (confirm('MÃ¶chtest du dich wirklich abmelden?')) {
        console.log('ðŸšª Logging out user:', currentUser?.username);

        currentUser = null;
        localStorage.removeItem('rememberMe');
        localStorage.removeItem('username');
        localStorage.removeItem('userRole');
        localStorage.removeItem('avatarUrl');
        localStorage.removeItem('hasSkippedLogin');

        console.log('ðŸ—‘ï¸ Session data cleared (including avatar)');

        // Reset UI
        document.getElementById('profileButtonText').textContent = 'Login';
        const existingAvatar = document.getElementById('profileButton').querySelector('.profile-avatar');
        if (existingAvatar) {
          existingAvatar.remove();
        }

        // Show default SVG icon again
        const profileButtonIcon = document.getElementById('profileButtonIcon');
        if (profileButtonIcon) {
          profileButtonIcon.style.display = 'block';
        }

        const dashboardWelcome = document.getElementById('dashboardWelcome');
        if (dashboardWelcome) {
          dashboardWelcome.style.display = 'none';
        }

        alert('Du wurdest abgemeldet');

        // Show login modal again
        setTimeout(() => {
          document.getElementById('loginBackdrop').classList.add('active');
        }, 100);

        console.log('âœ… Logout complete');
      }
    }

    // Profile button click handler
    function toggleProfileMenu() {
      if (currentUser) {
        // Navigate to profile section (full-page view)
        const tabs = document.querySelectorAll("nav a[id^='tab-']");
        const sections = document.querySelectorAll("section");

        // Deactivate all tabs and sections
        tabs.forEach(t => t.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));

        // Activate profile section
        const profileSection = document.getElementById('profile-section');
        if (profileSection) {
          profileSection.classList.add('active');
          loadProfilePage();
        }
      } else {
        // Show login modal
        document.getElementById('loginBackdrop').classList.add('active');
        document.getElementById('loginFormView').style.display = 'block';
        document.getElementById('profileView').style.display = 'none';
      }
    }

    // Show profile view with user data
    function showProfileView() {
      console.log('ðŸ“‹ Opening profile view for:', currentUser.username);
      console.log('ðŸ–¼ï¸ Profile avatar URL:', currentUser.avatar_url || 'No avatar URL');

      // Switch to profile view
      document.getElementById('loginFormView').style.display = 'none';
      document.getElementById('profileView').style.display = 'block';
      document.getElementById('loginBackdrop').classList.add('active');

      // Update profile view with current user data
      document.getElementById('profileName').textContent = currentUser.username;
      document.getElementById('profileUsernameValue').textContent = currentUser.username;
      document.getElementById('profileRoleValue').textContent = (currentUser.role || 'user').toUpperCase();

      // Update avatar if exists
      const avatarLarge = document.getElementById('profileAvatarLarge');
      if (currentUser.avatar_url) {
        avatarLarge.src = currentUser.avatar_url;
        avatarLarge.style.display = 'block';
        avatarLarge.onerror = function() {
          console.error('âŒ Failed to load large profile avatar:', currentUser.avatar_url);
          avatarLarge.style.display = 'none';
        };
        console.log('âœ… Large profile avatar set:', currentUser.avatar_url);
      } else {
        avatarLarge.style.display = 'none';
      }

      // Reset password display and hide change form
      document.getElementById('profilePasswordValue').textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
      hidePasswordChangeForm();
    }

    // Toggle password visibility
    function togglePassword() {
      const passwordValue = document.getElementById('profilePasswordValue');
      const toggleBtn = event.target;

      if (passwordValue.textContent === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
        // Show password
        passwordValue.textContent = currentUser.password_hash || 'Nicht gesetzt';
        toggleBtn.textContent = 'Verbergen';
      } else {
        // Hide password
        passwordValue.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        toggleBtn.textContent = 'Anzeigen';
      }
    }

    // Upload avatar
    async function uploadAvatar() {
      const fileInput = document.getElementById('avatarUpload');
      const file = fileInput.files[0];

      if (!file) {
        alert('Bitte wÃ¤hle ein Bild aus');
        return;
      }

      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Die Datei ist zu groÃŸ. Maximal 5MB erlaubt.');
        return;
      }

      // Check file type
      if (!file.type.startsWith('image/')) {
        alert('Bitte wÃ¤hle eine Bilddatei aus');
        return;
      }

      try {
        console.log('ðŸ“¤ Uploading avatar for:', currentUser.username);

        // Generate unique filename (without subdirectory to avoid RLS issues)
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;

        // Upload to Supabase Storage (root of bucket to avoid RLS policy issues)
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: true
          });

        if (uploadError) {
          console.error('âŒ Upload error:', uploadError);
          alert('Fehler beim Hochladen: ' + uploadError.message);
          return;
        }

        // Get public URL
        const { data: { publicUrl } } = supabase.storage
          .from('avatars')
          .getPublicUrl(fileName);

        console.log('âœ… Avatar uploaded:', publicUrl);

        // Update profile in database
        const { error: updateError } = await supabase
          .from('profiles')
          .update({ avatar_url: publicUrl })
          .eq('id', currentUser.id);

        if (updateError) {
          console.error('âŒ Database update error:', updateError);
          alert('Fehler beim Speichern: ' + updateError.message);
          return;
        }

        // Update current user object
        currentUser.avatar_url = publicUrl;

        // Update UI
        updateUIForUser(currentUser);
        document.getElementById('profileAvatarLarge').src = publicUrl;
        document.getElementById('profileAvatarLarge').style.display = 'block';

        alert('âœ… Profilbild erfolgreich hochgeladen!');
        console.log('âœ… Profile updated successfully');

      } catch (err) {
        console.error('ðŸ’¥ Avatar upload failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
      }
    }

    // ============================================
    // AVATAR UPLOAD MODAL FUNCTIONS
    // ============================================

    let selectedAvatarFile = null;

    // Open Avatar Upload Modal
    function openAvatarUploadModal() {
      // Show current avatar if exists
      const currentAvatarImg = document.getElementById('currentAvatarImg');
      const currentAvatarPreview = document.getElementById('currentAvatarPreview');

      if (currentUser && currentUser.avatar_url) {
        currentAvatarImg.src = currentUser.avatar_url;
        currentAvatarPreview.style.display = 'block';
      } else {
        currentAvatarPreview.style.display = 'none';
      }

      // Reset form
      selectedAvatarFile = null;
      document.getElementById('avatarFileInput').value = '';
      document.getElementById('avatarPreviewContainer').style.display = 'none';
      document.getElementById('uploadProgress').style.display = 'none';
      document.getElementById('uploadAvatarBtn').disabled = true;
      document.getElementById('uploadAvatarBtn').style.opacity = '0.5';

      // Show modal
      document.getElementById('avatarUploadModal').classList.add('active');
    }

    // Close Avatar Upload Modal
    function closeAvatarUploadModal() {
      document.getElementById('avatarUploadModal').classList.remove('active');
      selectedAvatarFile = null;
    }

    // Handle drag over
    function handleDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      const dropZone = document.getElementById('avatarDropZone');
      dropZone.style.borderColor = 'var(--accent)';
      dropZone.style.background = '#e0f2fe';
    }

    // Handle drag leave
    function handleDragLeave(event) {
      event.preventDefault();
      event.stopPropagation();
      const dropZone = document.getElementById('avatarDropZone');
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '#f9fafb';
    }

    // Handle drop
    function handleDrop(event) {
      event.preventDefault();
      event.stopPropagation();

      const dropZone = document.getElementById('avatarDropZone');
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '#f9fafb';

      const files = event.dataTransfer.files;
      if (files.length > 0) {
        processAvatarFile(files[0]);
      }
    }

    // Handle file select
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        processAvatarFile(file);
      }
    }

    // Process selected file
    function processAvatarFile(file) {
      // Check file type
      if (!file.type.startsWith('image/')) {
        alert('Bitte wÃ¤hle eine Bilddatei aus (PNG, JPG, GIF)');
        return;
      }

      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Die Datei ist zu groÃŸ. Maximal 5MB erlaubt.');
        return;
      }

      selectedAvatarFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('avatarPreview').src = e.target.result;
        document.getElementById('avatarFileName').textContent = file.name;
        document.getElementById('avatarPreviewContainer').style.display = 'block';

        // Enable upload button
        document.getElementById('uploadAvatarBtn').disabled = false;
        document.getElementById('uploadAvatarBtn').style.opacity = '1';
      };
      reader.readAsDataURL(file);
    }

    // Upload avatar from modal
    async function uploadAvatarFromModal() {
      if (!selectedAvatarFile) {
        alert('Bitte wÃ¤hle ein Bild aus');
        return;
      }

      const uploadBtn = document.getElementById('uploadAvatarBtn');
      const progressDiv = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('uploadProgressBar');

      try {
        // Disable button and show progress
        uploadBtn.disabled = true;
        uploadBtn.style.opacity = '0.5';
        progressDiv.style.display = 'block';
        progressBar.style.width = '30%';

        console.log('ðŸ“¤ Uploading avatar for:', currentUser.username);

        // Generate unique filename (without subdirectory to avoid RLS issues)
        const fileExt = selectedAvatarFile.name.split('.').pop();
        const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;

        progressBar.style.width = '50%';

        // Upload to Supabase Storage (root of bucket to avoid RLS policy issues)
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(fileName, selectedAvatarFile, {
            cacheControl: '3600',
            upsert: true
          });

        if (uploadError) {
          console.error('âŒ Upload error:', uploadError);
          alert('Fehler beim Hochladen: ' + uploadError.message);
          progressDiv.style.display = 'none';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          return;
        }

        progressBar.style.width = '70%';

        // Get public URL
        const { data: { publicUrl } } = supabase.storage
          .from('avatars')
          .getPublicUrl(fileName);

        console.log('âœ… Avatar uploaded:', publicUrl);

        progressBar.style.width = '90%';

        // Update profile in database
        const { error: updateError } = await supabase
          .from('profiles')
          .update({ avatar_url: publicUrl })
          .eq('id', currentUser.id);

        if (updateError) {
          console.error('âŒ Database update error:', updateError);
          alert('Fehler beim Speichern: ' + updateError.message);
          progressDiv.style.display = 'none';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          return;
        }

        progressBar.style.width = '100%';

        // Update current user object
        currentUser.avatar_url = publicUrl;

        // Save avatar URL to localStorage for persistence
        localStorage.setItem('avatarUrl', publicUrl);
        console.log('ðŸ’¾ Avatar URL saved to localStorage');

        // Update UI
        updateUIForUser(currentUser);
        document.getElementById('profileAvatarLarge').src = publicUrl;
        document.getElementById('profileAvatarLarge').style.display = 'block';

        // Close modal after short delay
        setTimeout(() => {
          closeAvatarUploadModal();
          alert('âœ… Profilbild erfolgreich hochgeladen!');
        }, 500);

        console.log('âœ… Profile updated successfully');

      } catch (err) {
        console.error('ðŸ’¥ Avatar upload failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
        progressDiv.style.display = 'none';
        uploadBtn.disabled = false;
        uploadBtn.style.opacity = '1';
      }
    }

    // ============================================
    // PROFILE PAGE FUNCTIONS
    // ============================================

    let selectedProfileAvatarFile = null;

    // Load profile page
    function loadProfilePage() {
      if (!currentUser) {
        alert('Bitte melden Sie sich zuerst an');
        return;
      }

      // Update profile information
      document.getElementById('profilePageName').textContent = currentUser.username;
      document.getElementById('profilePageUsername').textContent = currentUser.username;
      document.getElementById('profilePageRoleText').textContent = (currentUser.role || 'user').toUpperCase();
      document.getElementById('profilePageRoleBadge').textContent = (currentUser.role || 'user').toUpperCase();

      // Update avatar
      const profilePageAvatar = document.getElementById('profilePageAvatar');
      const profilePageCurrentAvatarImg = document.getElementById('profilePageCurrentAvatarImg');

      if (currentUser.avatar_url) {
        profilePageAvatar.src = currentUser.avatar_url;
        profilePageCurrentAvatarImg.src = currentUser.avatar_url;
        document.getElementById('profilePageCurrentAvatarPreview').style.display = 'block';
      } else {
        document.getElementById('profilePageCurrentAvatarPreview').style.display = 'none';
      }

      // Reset upload form
      selectedProfileAvatarFile = null;
      document.getElementById('profilePageAvatarFileInput').value = '';
      document.getElementById('profilePageAvatarPreviewContainer').style.display = 'none';
      document.getElementById('profilePageUploadProgress').style.display = 'none';
      document.getElementById('profilePageUploadAvatarBtn').disabled = true;
      document.getElementById('profilePageUploadAvatarBtn').style.opacity = '0.5';
    }

    // Handle drag over for profile page
    function handleProfileDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      const dropZone = document.getElementById('profilePageAvatarDropZone');
      dropZone.style.borderColor = 'var(--accent)';
      dropZone.style.background = '#e0f2fe';
    }

    // Handle drag leave for profile page
    function handleProfileDragLeave(event) {
      event.preventDefault();
      event.stopPropagation();
      const dropZone = document.getElementById('profilePageAvatarDropZone');
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '#f9fafb';
    }

    // Handle drop for profile page
    function handleProfileDrop(event) {
      event.preventDefault();
      event.stopPropagation();

      const dropZone = document.getElementById('profilePageAvatarDropZone');
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '#f9fafb';

      const files = event.dataTransfer.files;
      if (files.length > 0) {
        processProfileAvatarFile(files[0]);
      }
    }

    // Handle file select for profile page
    function handleProfileFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        processProfileAvatarFile(file);
      }
    }

    // Process selected file for profile page
    function processProfileAvatarFile(file) {
      // Check file type
      if (!file.type.startsWith('image/')) {
        alert('Bitte wÃ¤hle eine Bilddatei aus (PNG, JPG, GIF)');
        return;
      }

      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Die Datei ist zu groÃŸ. Maximal 5MB erlaubt.');
        return;
      }

      selectedProfileAvatarFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('profilePageAvatarPreview').src = e.target.result;
        document.getElementById('profilePageAvatarFileName').textContent = file.name;
        document.getElementById('profilePageAvatarPreviewContainer').style.display = 'block';

        // Enable upload button
        document.getElementById('profilePageUploadAvatarBtn').disabled = false;
        document.getElementById('profilePageUploadAvatarBtn').style.opacity = '1';
      };
      reader.readAsDataURL(file);
    }

    // Upload avatar from profile page
    async function uploadAvatarFromProfilePage() {
      if (!selectedProfileAvatarFile) {
        alert('Bitte wÃ¤hle ein Bild aus');
        return;
      }

      const uploadBtn = document.getElementById('profilePageUploadAvatarBtn');
      const progressDiv = document.getElementById('profilePageUploadProgress');
      const progressBar = document.getElementById('profilePageUploadProgressBar');

      try {
        // Disable button and show progress
        uploadBtn.disabled = true;
        uploadBtn.style.opacity = '0.5';
        progressDiv.style.display = 'block';
        progressBar.style.width = '30%';

        console.log('ðŸ“¤ Uploading avatar for:', currentUser.username);

        // Generate unique filename (without subdirectory to avoid RLS issues)
        const fileExt = selectedProfileAvatarFile.name.split('.').pop();
        const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;

        progressBar.style.width = '50%';

        // Upload to Supabase Storage (root of bucket to avoid RLS policy issues)
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(fileName, selectedProfileAvatarFile, {
            cacheControl: '3600',
            upsert: true
          });

        if (uploadError) {
          console.error('âŒ Upload error:', uploadError);
          alert('Fehler beim Hochladen: ' + uploadError.message);
          progressDiv.style.display = 'none';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          return;
        }

        progressBar.style.width = '70%';

        // Get public URL
        const { data: { publicUrl } } = supabase.storage
          .from('avatars')
          .getPublicUrl(fileName);

        console.log('âœ… Avatar uploaded:', publicUrl);

        progressBar.style.width = '90%';

        // Update profile in database
        const { error: updateError } = await supabase
          .from('profiles')
          .update({ avatar_url: publicUrl })
          .eq('id', currentUser.id);

        if (updateError) {
          console.error('âŒ Database update error:', updateError);
          alert('Fehler beim Speichern: ' + updateError.message);
          progressDiv.style.display = 'none';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          return;
        }

        progressBar.style.width = '100%';

        // Update current user object
        currentUser.avatar_url = publicUrl;

        // Save avatar URL to localStorage for persistence
        localStorage.setItem('avatarUrl', publicUrl);
        console.log('ðŸ’¾ Avatar URL saved to localStorage');

        // Update UI
        updateUIForUser(currentUser);
        document.getElementById('profilePageAvatar').src = publicUrl;
        document.getElementById('profilePageCurrentAvatarImg').src = publicUrl;
        document.getElementById('profilePageCurrentAvatarPreview').style.display = 'block';

        // Reset form
        setTimeout(() => {
          selectedProfileAvatarFile = null;
          document.getElementById('profilePageAvatarFileInput').value = '';
          document.getElementById('profilePageAvatarPreviewContainer').style.display = 'none';
          progressDiv.style.display = 'none';
          uploadBtn.disabled = true;
          uploadBtn.style.opacity = '0.5';
          alert('âœ… Profilbild erfolgreich hochgeladen!');
        }, 500);

        console.log('âœ… Profile updated successfully');

      } catch (err) {
        console.error('ðŸ’¥ Avatar upload failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
        progressDiv.style.display = 'none';
        uploadBtn.disabled = false;
        uploadBtn.style.opacity = '1';
      }
    }

    // Show password change form for profile page
    function showPasswordChangeFormPage() {
      document.getElementById('profilePagePasswordChangeForm').style.display = 'block';
    }

    // Hide password change form for profile page
    function hidePasswordChangeFormPage() {
      document.getElementById('profilePagePasswordChangeForm').style.display = 'none';
      document.getElementById('profilePageNewPassword').value = '';
      document.getElementById('profilePageConfirmPassword').value = '';
    }

    // Change password from profile page
    async function changePasswordPage() {
      const newPassword = document.getElementById('profilePageNewPassword').value;
      const confirmPassword = document.getElementById('profilePageConfirmPassword').value;

      // Validation
      if (!newPassword || !confirmPassword) {
        alert('Bitte fÃ¼lle beide Felder aus');
        return;
      }

      if (newPassword.length < 6) {
        alert('Das Passwort muss mindestens 6 Zeichen lang sein');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('Die PasswÃ¶rter stimmen nicht Ã¼berein');
        return;
      }

      try {
        console.log('ðŸ”‘ Changing password for:', currentUser.username);

        // Hash password using bcrypt
        const hashedPassword = await bcrypt.hash(newPassword, 10);

        // Update password in database
        const { error } = await supabase
          .from('profiles')
          .update({ password_hash: hashedPassword })
          .eq('id', currentUser.id);

        if (error) {
          console.error('âŒ Password update error:', error);
          alert('Fehler beim Ã„ndern des Passworts: ' + error.message);
          return;
        }

        console.log('âœ… Password changed successfully');
        alert('âœ… Passwort erfolgreich geÃ¤ndert!');
        hidePasswordChangeFormPage();

      } catch (err) {
        console.error('ðŸ’¥ Password change failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
      }
    }

    // Show password change form
    function showPasswordChangeForm() {
      document.getElementById('passwordChangeForm').style.display = 'block';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    // Hide password change form
    function hidePasswordChangeForm() {
      document.getElementById('passwordChangeForm').style.display = 'none';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    // Change password
    async function changePassword() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validation
      if (!newPassword || !confirmPassword) {
        alert('Bitte fÃ¼lle beide Felder aus');
        return;
      }

      if (newPassword.length < 6) {
        alert('Das Passwort muss mindestens 6 Zeichen lang sein');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('Die PasswÃ¶rter stimmen nicht Ã¼berein');
        return;
      }

      try {
        console.log('ðŸ”‘ Changing password for:', currentUser.username);

        // Update password in database
        const { error } = await supabase
          .from('profiles')
          .update({ password_hash: newPassword })
          .eq('id', currentUser.id);

        if (error) {
          console.error('âŒ Password update error:', error);
          alert('Fehler beim Ã„ndern des Passworts: ' + error.message);
          return;
        }

        // Update current user object
        currentUser.password_hash = newPassword;

        // Hide form and show success message
        hidePasswordChangeForm();
        alert('âœ… Passwort erfolgreich geÃ¤ndert!');
        console.log('âœ… Password changed successfully');

      } catch (err) {
        console.error('ðŸ’¥ Password change failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
      }
    }

    // ============================================
    // DEBUG HELPER FUNCTIONS
    // ============================================

    // Test database connection
    async function testDatabaseConnection() {
      console.log('ðŸ”Œ Testing database connection...');
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('count')
          .limit(1);

        if (error) {
          console.error('âŒ Database connection failed:', error);
          return false;
        }

        console.log('âœ… Database connection successful');
        return true;
      } catch (err) {
        console.error('ðŸ’¥ Database connection test failed:', err);
        return false;
      }
    }

    // List all users in profiles table
    async function debugListUsers() {
      console.log('ðŸ“‹ Fetching all users from profiles table...');
      try {
        const { data: profiles, error } = await supabase
          .from('profiles')
          .select('id, username, role, email, created_at')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('âŒ Error fetching users:', error);
          return;
        }

        console.log('âœ… Found', profiles.length, 'users:');
        console.table(profiles);
        return profiles;
      } catch (err) {
        console.error('ðŸ’¥ Failed to list users:', err);
      }
    }

    // Test login with username/password
    async function debugTestLogin(username, password) {
      console.log('ðŸ§ª Testing login for:', username);
      try {
        // Query user by username (case-insensitive)
        const { data: profiles, error } = await supabase
          .from('profiles')
          .select('*')
          .ilike('username', username);

        if (error) {
          console.error('âŒ Database error:', error);
          return false;
        }

        if (!profiles || profiles.length === 0) {
          console.log('âš ï¸ User not found:', username);
          return false;
        }

        const profile = profiles[0];
        console.log('ðŸ‘¤ Found user:', profile.username);
        console.log('ðŸ”‘ Has password_hash:', !!profile.password_hash);
        console.log('ðŸŽ­ Role:', profile.role);

        if (!profile.password_hash) {
          console.error('âŒ No password set for user');
          return false;
        }

        const passwordMatch = profile.password_hash === password;
        if (passwordMatch) {
          console.log('âœ… Password matches!');
        } else {
          console.log('âŒ Password does not match');
        }

        return passwordMatch;
      } catch (err) {
        console.error('ðŸ’¥ Debug login test failed:', err);
        return false;
      }
    }

    // Make debug functions available globally
    window.testDatabaseConnection = testDatabaseConnection;
    window.debugListUsers = debugListUsers;
    window.debugTestLogin = debugTestLogin;

    // ========================================
    // ANALYTICS SECTION
    // ========================================

    let originsPieChart = null;
    let timelineChart = null;
    let currentTimeRange = 'weekly';
    let analyticsData = [];

    // Load analytics data from Supabase
    async function loadAnalyticsData(locationFilter = null) {
      try {
        console.log('ðŸ“Š Loading analytics data...');
        let query = supabase
          .from('requests')
          .select('origin, status, created_at, location_id')
          .neq('status', 'canceled'); // Exclude canceled requests

        if (locationFilter) {
          query = query.eq('location_id', locationFilter);
          console.log('ðŸ¢ Filtering by location:', locationFilter);
        }

        const { data, error } = await query;
        if (error) throw error;

        console.log(`âœ… Loaded ${data.length} requests for analytics`);
        return data;
      } catch (err) {
        console.error('âŒ Analytics data load failed:', err);
        alert('Failed to load analytics data: ' + err.message);
        return [];
      }
    }

    // Render Pie Chart for Booking Origins
    async function renderOriginsPieChart(data) {
      console.log('ðŸ“Š Rendering origins pie chart with', data.length, 'requests');

      // Count origins
      const originCounts = {
        'booking_form': 0,
        'whatsapp': 0,
        'instagram': 0,
        'email': 0,
        'walk_in': 0,
        'self_booking': 0
      };

      data.forEach(req => {
        if (req.origin && originCounts.hasOwnProperty(req.origin)) {
          originCounts[req.origin]++;
        }
      });

      console.log('ðŸ“ˆ Origin counts:', originCounts);

      // Labels and colors
      const labels = [
        'Booking Form',
        'WhatsApp',
        'Instagram',
        'E-Mail',
        'Walk-In',
        'Self-Booking'
      ];

      const colors = [
        '#0071e3', // Accent (Booking Form)
        '#25D366', // WhatsApp Green
        '#E1306C', // Instagram Pink
        '#EA4335', // Email Red
        '#7B1FA2', // Walk-In Purple
        '#00897B'  // Self-Booking Teal
      ];

      const chartData = {
        labels: labels,
        datasets: [{
          data: Object.values(originCounts),
          backgroundColor: colors,
          borderWidth: 2,
          borderColor: '#fff'
        }]
      };

      // Destroy existing chart
      if (originsPieChart) {
        originsPieChart.destroy();
      }

      const ctx = document.getElementById('bookingOriginsPie');
      if (!ctx) {
        console.error('âŒ Canvas element not found: bookingOriginsPie');
        return;
      }

      originsPieChart = new Chart(ctx.getContext('2d'), {
        type: 'pie',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 12,
                font: {
                  size: 12,
                  family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      console.log('âœ… Pie chart rendered successfully');
    }

    // Group data by time range
    function groupDataByTimeRange(data, range) {
      const now = new Date();
      const groups = {};

      data.forEach(req => {
        const date = new Date(req.created_at);
        let key;

        switch(range) {
          case 'weekly':
            // Last 7 days
            if (date >= new Date(now - 7 * 24 * 60 * 60 * 1000)) {
              key = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            }
            break;

          case 'monthly':
            // Last month
            if (date >= new Date(now - 30 * 24 * 60 * 60 * 1000)) {
              key = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            }
            break;

          case 'yearly':
            // Last year, grouped by month
            if (date >= new Date(now - 365 * 24 * 60 * 60 * 1000)) {
              key = date.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
            }
            break;

          case 'all':
            // All time, grouped by month
            key = date.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
            break;
        }

        if (key) {
          groups[key] = (groups[key] || 0) + 1;
        }
      });

      // Sort keys chronologically
      const sortedKeys = Object.keys(groups).sort((a, b) => {
        const parseDate = (str) => {
          if (str.includes('.')) {
            // Format: "09.11"
            const [day, month] = str.split('.');
            return new Date(now.getFullYear(), parseInt(month) - 1, parseInt(day));
          } else {
            // Format: "Nov 2025"
            return new Date(str);
          }
        };
        return parseDate(a) - parseDate(b);
      });

      return {
        labels: sortedKeys,
        values: sortedKeys.map(k => groups[k])
      };
    }

    // Render Line Chart for Bookings Timeline
    async function renderBookingsTimeline(data, timeRange = 'weekly') {
      console.log('ðŸ“Š Rendering timeline chart for range:', timeRange);

      currentTimeRange = timeRange;

      // Group data by time range
      const groupedData = groupDataByTimeRange(data, timeRange);

      console.log('ðŸ“ˆ Timeline data points:', groupedData.labels.length);

      const chartData = {
        labels: groupedData.labels,
        datasets: [{
          label: 'Bookings',
          data: groupedData.values,
          borderColor: '#0071e3',
          backgroundColor: 'rgba(0,113,227,0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6,
          pointBackgroundColor: '#0071e3',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        }]
      };

      // Destroy existing chart
      if (timelineChart) {
        timelineChart.destroy();
      }

      const ctx = document.getElementById('bookingsTimeline');
      if (!ctx) {
        console.error('âŒ Canvas element not found: bookingsTimeline');
        return;
      }

      timelineChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(29,29,31,0.95)',
              padding: 12,
              cornerRadius: 8,
              titleFont: {
                size: 13,
                weight: '600'
              },
              bodyFont: {
                size: 12
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                font: {
                  size: 11
                }
              },
              grid: {
                color: 'rgba(0,0,0,0.06)'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11
                },
                maxRotation: 45,
                minRotation: 0
              },
              grid: {
                display: false
              }
            }
          }
        }
      });

      console.log('âœ… Timeline chart rendered successfully');
    }

    // Initialize analytics with data
    async function initAnalytics() {
      console.log('ðŸŽ¯ Initializing analytics...');

      // Load location filter dropdown
      await loadAnalyticsLocationFilter();

      // Load and render initial charts
      const locationFilter = document.getElementById('analyticsLocationFilter')?.value || null;
      analyticsData = await loadAnalyticsData(locationFilter);
      await renderOriginsPieChart(analyticsData);
      await renderBookingsTimeline(analyticsData, currentTimeRange);

      console.log('âœ… Analytics initialized');
    }

    // Load locations for filter dropdown
    async function loadAnalyticsLocationFilter() {
      try {
        const { data: locations, error } = await supabase
          .from('locations')
          .select('id, name')
          .order('name');

        if (error) throw error;

        const filterSelect = document.getElementById('analyticsLocationFilter');
        if (!filterSelect) return;

        filterSelect.innerHTML = '<option value="">All Locations</option>';
        locations.forEach(loc => {
          const option = document.createElement('option');
          option.value = loc.id;
          option.textContent = loc.name;
          filterSelect.appendChild(option);
        });

        console.log('âœ… Analytics location filter loaded with', locations.length, 'locations');
      } catch (err) {
        console.error('âŒ Failed to load locations for analytics filter:', err);
      }
    }

    // Attach event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Login form
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
      }

      // Close modal when clicking outside
      document.getElementById('loginBackdrop')?.addEventListener('click', (e) => {
        if (e.target.id === 'loginBackdrop') {
          if (currentUser || localStorage.getItem('hasSkippedLogin')) {
            closeLoginModal();
          }
        }
      });

      // Profile button
      const profileButton = document.getElementById('profileButton');
      if (profileButton) {
        profileButton.addEventListener('click', toggleProfileMenu);
      }

      // Analytics Tab Click - Initialize charts when Analytics tab is clicked
      const analyticsTab = document.getElementById('tab-analytics');
      if (analyticsTab) {
        analyticsTab.addEventListener('click', async function() {
          console.log('ðŸ“Š Analytics tab clicked');
          // Small delay to ensure section is visible before rendering charts
          setTimeout(async () => {
            await initAnalytics();
          }, 100);
        });
      }

      // Time Range Tab Switching
      const timeTabs = document.querySelectorAll('.time-tab');
      timeTabs.forEach(tab => {
        tab.addEventListener('click', async function() {
          console.log('ðŸ•’ Time range changed to:', this.dataset.range);

          // Update active state
          timeTabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');

          // Get selected range
          const range = this.dataset.range;

          // Reload chart with current data
          await renderBookingsTimeline(analyticsData, range);
        });
      });

      // Location Filter Change
      const analyticsLocationFilter = document.getElementById('analyticsLocationFilter');
      if (analyticsLocationFilter) {
        analyticsLocationFilter.addEventListener('change', async function() {
          const locationId = this.value || null;
          console.log('ðŸ¢ Analytics location filter changed:', locationId || 'All Locations');

          // Reload data with new filter
          analyticsData = await loadAnalyticsData(locationId);

          // Re-render both charts
          await renderOriginsPieChart(analyticsData);
          await renderBookingsTimeline(analyticsData, currentTimeRange);
        });
      }

      // Initialize auth
      initAuth();
    });
  </script>

  <!-- Image Modal for Reference Images -->
  <div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <span class="image-modal-close">&times;</span>
    <img id="modalImage" src="" alt="Reference Image">
  </div>

</body>
</html><!-- VERSION: v77 -->
