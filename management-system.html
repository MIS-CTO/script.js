<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Management System v87</title>
  
  <!-- iOS Web App Configuration -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Management System">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ“Š</text></svg>">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Geist Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ========================================
       macOS Light Mode Frosted Glass - CSS Variables
       ======================================== */
    :root {
      /* Backgrounds - Light Mode Frosted Glass */
      --macos-bg: #f5f5f7;
      --macos-panel: rgba(255, 255, 255, 0.7);
      --macos-elevated: rgba(255, 255, 255, 0.85);
      --macos-nav-bg: #ffffff;

      /* Text Colors - Always Dark in Light Mode */
      --macos-text-primary: #1d1d1f;
      --macos-text-secondary: #86868b;
      --macos-text-tertiary: #a1a1a6;
      --macos-placeholder: #86868b;

      /* Accent Colors */
      --macos-accent-blue: #0071e3;
      --macos-accent-green: #34c759;
      --macos-accent-red: #ff3b30;
      --macos-accent-orange: #ff9500;
      --macos-accent-purple: #5856d6;

      /* System Fills - Light Mode */
      --macos-fill-primary: rgba(120, 120, 128, 0.20);
      --macos-fill-secondary: rgba(120, 120, 128, 0.16);
      --macos-fill-tertiary: rgba(120, 120, 128, 0.12);
      --macos-fill-quaternary: rgba(120, 120, 128, 0.08);

      /* Strokes - Enhanced for Light Mode */
      --macos-stroke-primary: rgba(0, 0, 0, 0.08);
      --macos-stroke-secondary: rgba(0, 0, 0, 0.04);

      /* Shadows - Subtle for Light Backgrounds */
      --macos-shadow-small: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
      --macos-shadow-medium: 0 3px 12px rgba(0,0,0,0.07), 0 1px 4px rgba(0,0,0,0.04);
      --macos-shadow-large: 0 10px 40px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);

      /* Frosted Glass Blur Effects */
      --macos-blur-strong: saturate(180%) blur(20px);
      --macos-blur-medium: saturate(160%) blur(15px);
      --macos-blur-light: saturate(140%) blur(10px);

      /* Border Radius System */
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 10px;
      --radius-xl: 12px;
      --radius-pill: 999px;

      /* Spacing System (8pt grid) */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 24px;
      --space-2xl: 32px;
      --space-3xl: 48px;

      /* Location Colors (preserved) */
      --location-primary: #43A047;
      --location-light: #E8F5E9;
      --location-dark: #2E7D32;
      --location-accent: #66BB6A;

      /* Legacy aliases for compatibility */
      --bg: var(--macos-bg);
      --ink: var(--macos-text-primary);
      --muted: var(--macos-text-secondary);
      --panel: var(--macos-panel);
      --stroke: var(--macos-stroke-primary);
      --brand: var(--macos-text-primary);
      --brand-ink: #ffffff;
      --accent: var(--macos-accent-blue);
      --radius: var(--radius-xl);
      --shadow: var(--macos-shadow-medium);

      /* Account Settings Page Variables */
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f7;
      --bg-tertiary: #fafafa;
      --text-primary: #1d1d1f;
      --text-secondary: #86868b;
      --text-tertiary: #a1a1a6;
      --border-color: rgba(0, 0, 0, 0.1);
      --border-color-strong: rgba(0, 0, 0, 0.2);
      --hover-bg: rgba(0, 0, 0, 0.05);
      --hover-bg-light: rgba(0, 0, 0, 0.03);
      --input-bg: #ffffff;
      --input-border: rgba(0, 0, 0, 0.1);
      --input-focus-border: rgba(0, 113, 227, 0.5);
      --button-primary-bg: #1d1d1f;
      --button-primary-hover: #333333;
      --button-primary-text: #ffffff;
      --button-secondary-bg: #ffffff;
      --button-secondary-hover: #f5f5f7;
      --button-secondary-text: #1d1d1f;
    }

    /* ========================================
       Desktop: Hide ALL mobile-only elements
       ======================================== */
    @media (min-width: 769px) {
      .mobile-dp-month-view,
      .mobile-cal-month-view,
      #mobileDpMonthView,
      #mobileCalMonthView,
      .mobile-dp-month-header,
      .mobile-cal-month-header,
      .mobile-dp-month-back,
      .mobile-event-detail-overlay,
      #mobileEventDetailOverlay,
      .mobile-dashboard-profile,
      #mobileDashboardProfile,
      .mobile-appearance-section,
      .mobile-profile-swipe-container,
      .mobile-inbox-btn,
      .mobile-inbox-panel {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
        position: absolute !important;
        left: -9999px !important;
      }

      /* Show desktop notification button on desktop */
      .desktop-only-notification {
        display: flex !important;
      }
    }

    /* ========================================
       Dark Mode Support
       ======================================== */
    [data-theme="dark"] {
      /* Backgrounds - Dark Mode */
      --macos-bg: #1c1c1e;
      --macos-panel: rgba(28, 28, 30, 0.85);
      --macos-elevated: rgba(44, 44, 46, 0.85);
      --macos-nav-bg: #2c2c2e;

      /* Text Colors - Dark Mode */
      --macos-text-primary: #f5f5f7;
      --macos-text-secondary: #98989d;
      --macos-text-tertiary: #636366;
      --macos-placeholder: #636366;

      /* System Fills - Dark Mode */
      --macos-fill-quaternary: rgba(118, 118, 128, 0.18);
      --macos-fill-tertiary: rgba(118, 118, 128, 0.24);

      /* Strokes - Dark Mode */
      --macos-stroke-primary: rgba(255, 255, 255, 0.08);
      --macos-stroke-secondary: rgba(255, 255, 255, 0.04);
      --border-color: rgba(255, 255, 255, 0.1);

      /* Accent Colors - Dark Mode */
      --macos-accent-blue: #0a84ff;
      --macos-accent-red: #ff453a;
      --macos-accent-green: #32d74b;
    }
    /* ========================================
       macOS Typography System
       ======================================== */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Geist", -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: var(--macos-bg);
      color: var(--macos-text-primary);
      margin: 0;
      font-size: 13px;
      line-height: 1.47;
      font-weight: 400;
      letter-spacing: -0.008em;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    /* Typography Styles */
    h1, .text-title-1 {
      font-size: 22px;
      line-height: 1.27;
      font-weight: 600;
      letter-spacing: -0.022em;
      color: var(--macos-text-primary);
    }

    h2, .text-title-2 {
      font-size: 17px;
      line-height: 1.29;
      font-weight: 600;
      letter-spacing: -0.018em;
      color: var(--macos-text-primary);
    }

    h3, .text-title-3 {
      font-size: 15px;
      line-height: 1.33;
      font-weight: 600;
      letter-spacing: -0.014em;
      color: var(--macos-text-primary);
    }

    .text-headline {
      font-size: 13px;
      line-height: 1.38;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .text-body {
      font-size: 13px;
      line-height: 1.47;
      font-weight: 400;
      letter-spacing: -0.008em;
    }

    .text-callout {
      font-size: 12px;
      line-height: 1.42;
      font-weight: 400;
      letter-spacing: -0.006em;
    }

    .text-subheadline {
      font-size: 11px;
      line-height: 1.36;
      font-weight: 400;
      letter-spacing: 0.0017em;
    }

    .text-footnote, .text-caption-1 {
      font-size: 10px;
      line-height: 1.40;
      font-weight: 400;
      letter-spacing: 0em;
    }

    .text-caption-2 {
      font-size: 9px;
      line-height: 1.33;
      font-weight: 400;
      letter-spacing: 0.0013em;
    }
    /* ========================================
       Navigation Bar - Frosted Glass
       ======================================== */
    nav {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      gap: 18px;
      align-items: center;
      background: var(--macos-nav-bg) !important;
      backdrop-filter: var(--macos-blur-strong);
      -webkit-backdrop-filter: var(--macos-blur-strong);
      padding: 12px 24px;
      border-bottom: 1px solid var(--macos-stroke-primary);
      height: 52px;
    }

    nav a {
      color: var(--macos-text-primary) !important;
      text-decoration: none;
      font-weight: 500;
      font-size: 13px;
      padding: 6px 8px;
      border-bottom: 2px solid transparent;
      opacity: 0.75;
      cursor: pointer;
      transition: opacity 0.2s ease, border-color 0.2s ease;
      letter-spacing: -0.008em;
    }

    nav a:hover {
      opacity: 1;
    }

    nav a.active {
      border-color: var(--macos-text-primary);
      opacity: 1;
      font-weight: 600;
    }
    /* ========================================
       Sections & Content Areas - Light Mode
       ======================================== */
    section {
      display: none;
      padding: 24px 5vw;
      max-width: 100%;
      margin: 0 auto;
      margin-top: 110px; /* 64px Header + 46px Navbar */
      min-height: calc(100vh - 110px);
    }

    section.active {
      display: block;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.022em;
      color: var(--macos-text-primary) !important;
    }

    /* ========================================
       Badges - Light with Colored Accents
       ======================================== */
    .badge {
      background: rgba(255, 255, 255, 0.9) !important;
      border: 1px solid var(--macos-stroke-primary);
      border-radius: 12px;
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 500;
      color: var(--macos-text-primary) !important;
      box-shadow: var(--macos-shadow-small);
      display: inline-block;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    /* Badge variants */
    .badge-resident,
    .badge-active {
      background: rgba(52, 199, 89, 0.15) !important;
      color: #1d6b2e !important;
      border-color: rgba(52, 199, 89, 0.3);
    }
    .calendar-controls {
      display:flex; gap:12px; margin-bottom:16px; align-items:center; flex-wrap:wrap;
    }
    /* ========================================
       Buttons - macOS Style
       ======================================== */
    .btn, .btn-primary {
      background: #1d1d1f;
      color: #ffffff;
      border: none;
      padding: 8px 20px;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.1s ease;
      letter-spacing: -0.008em;
      box-shadow: var(--macos-shadow-small);
      font-family: inherit;
    }

    .btn-primary:hover, .btn:hover {
      background: #333333;
      transform: translateY(-0.5px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-primary:active, .btn:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      background: var(--macos-fill-quaternary);
      color: var(--macos-text-primary);
      border: 1px solid var(--macos-stroke-primary);
      padding: 8px 20px;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease;
      letter-spacing: -0.008em;
      font-family: inherit;
    }

    .btn-secondary:hover {
      background: var(--macos-fill-tertiary);
    }

    .btn-nav {
      background: white;
      color: var(--macos-text-primary);
      border: 1px solid rgba(0, 0, 0, 0.1);
      padding: 7px 16px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease;
      letter-spacing: -0.008em;
      font-family: inherit;
    }

    .btn-nav:hover {
      background: #f5f5f7;
    }

    .btn-danger,
    .delete-btn,
    button.delete,
    [class*="delete-btn"] {
      background: #ff3b30 !important;
      color: #ffffff !important;
      border: none !important;
      padding: 8px 20px;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease;
      font-family: inherit;
    }

    .btn-danger:hover,
    .delete-btn:hover,
    button.delete:hover {
      background: #e6352b !important;
    }

    /* ========================================
       List Toggle Component (Dual Waitlist System)
       ======================================== */
    .list-toggle-option {
      position: relative;
      padding: 8px 20px;
      border: none;
      background: transparent;
      color: #86868b;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .list-toggle-option:hover {
      color: #1d1d1f;
    }

    .list-toggle-option.active {
      background: white;
      color: #1d1d1f;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }

    /* ========================================
       Form Inputs - Frosted Glass
       ======================================== */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="search"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    select,
    textarea {
      padding: 8px 12px;
      border: 1px solid var(--macos-stroke-primary);
      border-radius: var(--radius-md);
      font-size: 13px;
      font-family: inherit;
      background: var(--macos-elevated) !important;
      color: var(--macos-text-primary) !important;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      letter-spacing: -0.008em;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--macos-accent-blue);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--macos-placeholder) !important;
      opacity: 1 !important;
    }

    /* Search bars - White with dark text */
    input[type="search"] {
      background: var(--macos-elevated) !important;
      border: 1px solid var(--macos-stroke-primary);
      color: var(--macos-text-primary) !important;
      border-radius: var(--radius-pill);
    }
    /* ========================================
       Tables - Frosted Glass
       ======================================== */
    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--macos-stroke-primary);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--macos-elevated);
      backdrop-filter: var(--macos-blur-medium);
      -webkit-backdrop-filter: var(--macos-blur-medium);
      box-shadow: var(--macos-shadow-medium);
    }

    thead {
      background: #f5f5f7 !important;
    }

    th {
      text-align: left;
      padding: 10px 16px;
      border-bottom: 1px solid var(--macos-stroke-primary);
      font-weight: 600;
      font-size: 11px;
      color: #6e6e73 !important;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    td {
      text-align: left;
      padding: 12px 16px;
      border-bottom: 1px solid var(--macos-stroke-secondary);
      font-size: 13px;
      color: var(--macos-text-primary) !important;
      background: rgba(255, 255, 255, 0.6);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover td {
      background: rgba(0, 0, 0, 0.02);
    }
    /* ========================================
       Calendar Container - Frosted Glass
       ======================================== */
    .calendar-container {
      background: var(--macos-panel) !important;
      backdrop-filter: var(--macos-blur-medium);
      -webkit-backdrop-filter: var(--macos-blur-medium);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      overflow: auto;
      width: 100%;
    }
    .calendar-grid {
      display:grid; grid-template-columns:120px repeat(26, 1fr); min-width:100%;
    }
    .calendar-header { display:contents; }
    .slot-header {
      background:#F5F5F7; color:#1d1d1f; padding:14px; font-weight:600;
      text-align:center; border-bottom:1px solid rgba(0,0,0,0.1);
      border-right:1px solid rgba(0,0,0,0.1); position:sticky; left:0; z-index:10;
      min-height:56px; display:flex; align-items:center; justify-content:center;
      grid-column:1/2; font-size:14px; letter-spacing:-0.01em;
    }
    .hour-header {
      background:#F5F5F7; color:#86868b; padding:12px; font-weight:500;
      text-align:center; border-right:none; border-bottom:1px solid rgba(0,0,0,0.1);
      min-height:56px; display:flex; align-items:center; justify-content:center;
      font-size:13px; letter-spacing:-0.01em;
    }
    .slot-row { display:contents; }
    .slot-label {
      background:rgba(255,255,255,0.98);
      padding:14px;
      font-weight:500;
      border-right:1px solid rgba(0,0,0,0.08);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      left:0;
      z-index:5;
      min-height:100px;
      display:flex;
      align-items:center;
      justify-content:center;
      grid-column:1;
      font-size:13px;
      color:#86868b;
    }
    .slot-label.empty {
      min-height:40px;
      background:rgba(240,240,240,0.98);
      color:#999;
      font-size:12px;
      font-weight:400;
    }
    .slot-label.empty .slot-number {
      font-weight:500;
      color:#666;
    }
    .slot-label.empty .empty-text {
      margin-left:6px;
      font-style:italic;
    }
    .category-header {
      background:#F5F5F7; color:#1d1d1f; padding:12px 14px; font-weight:600;
      border-right:1px solid rgba(0,0,0,0.1); border-bottom:1px solid rgba(0,0,0,0.1);
      position:sticky; left:0; z-index:6; min-height:48px;
      display:flex; align-items:center; justify-content:flex-start; grid-column:1/2;
      font-size:14px; letter-spacing:-0.01em;
    }
    .category-spacer {
      background:#FAFAFA; border-right:none; border-bottom:1px solid rgba(0,0,0,0.06);
      min-height:48px;
    }
    .slot-cell {
      border-bottom:1px solid rgba(0,0,0,0.06);
      border-right:1px solid rgba(0,0,0,0.06);
      min-height:100px;
      padding:6px;
      position:relative;
      background:rgba(255,255,255,0.8);
      transition:background 0.15s ease;
    }
    .slot-cell.empty-slot {
      min-height:50px;
      background:rgba(245,245,245,0.6);
      cursor:default;
    }
    .slot-cell.empty-slot:hover {
      background:rgba(245,245,245,0.6);
    }
    .slot-row.empty-row .slot-label {
      min-height:50px;
      background:rgba(249,249,249,0.5);
      color:var(--muted);
      font-size:12px;
    }
    .slot-row.empty-row .slot-label::after {
      content: " - Empty";
      font-weight:400;
      font-size:11px;
      color:#999;
      margin-left:4px;
    }
    .slot-row.empty-row .slot-cell {
      min-height:50px;
    }
    .slot-cell.half-hour { border-right:1px solid rgba(0,0,0,0.04); }
    .slot-cell:hover { background:rgba(0,113,227,0.02); }
    .event {
      background: #fff;
      color: #1d1d1f;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      word-break: break-word;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
      overflow: hidden;
      line-height: 1.4;
    }
    .event:hover {
      box-shadow:0 4px 12px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.06);
      transform:translateY(-1px);
      z-index:10;
    }
    .event.guest {
      border-color: #42A5F5;
    }
    .event.resident {
      border-color: var(--location-primary);
    }
    .event.events {
      border-color: #5856D6;
    }

    /* Guest Spot Calendar Events */
    .event.guest_spot {
      background: rgba(88, 86, 214, 0.1) !important;
      color: #4B49B6 !important;
    }

    .event.guest_spot:hover {
      background: rgba(88, 86, 214, 0.2) !important;
    }

    [data-theme="dark"] .event.guest_spot {
      background: rgba(88, 86, 214, 0.2) !important;
      color: #8884D8 !important;
    }

    /* Stornierte Guest Spots im Kalender */
    .event.guest_spot.canceled {
      background: rgba(107, 114, 128, 0.15) !important;
      color: #6b7280 !important;
      opacity: 0.7;
      text-decoration: line-through;
    }

    .event.guest_spot.canceled:hover {
      background: rgba(107, 114, 128, 0.25) !important;
    }

    [data-theme="dark"] .event.guest_spot.canceled {
      background: rgba(107, 114, 128, 0.25) !important;
      color: #9ca3af !important;
    }

    /* Guest Spot APPOINTMENTS (Termine) - TÃ¼rkis/Blau statt Lila */
    .event.guest_spot.guest_spot_appointment {
      background: rgba(0, 131, 143, 0.15) !important;
      color: #00838F !important;
    }

    .event.guest_spot.guest_spot_appointment:hover {
      background: rgba(0, 131, 143, 0.25) !important;
    }

    [data-theme="dark"] .event.guest_spot.guest_spot_appointment {
      background: rgba(0, 188, 212, 0.2) !important;
      color: #00BCD4 !important;
    }

    /* Canceled Guest Spot Cards in Waitlist */
    .waitlist-slot-card.canceled,
    .guest-spot-card.canceled {
      opacity: 0.7;
      background: #f9fafb !important;
    }

    .waitlist-slot-card.canceled h3,
    .guest-spot-card.canceled h3,
    .waitlist-slot-card.canceled h4,
    .guest-spot-card.canceled h4 {
      text-decoration: line-through;
      color: #6b7280;
    }

    [data-theme="dark"] .waitlist-slot-card.canceled,
    [data-theme="dark"] .guest-spot-card.canceled {
      background: rgba(107, 114, 128, 0.15) !important;
    }

    /* Dienstplan - Canceled Entries */
    .dienstplan-slot.canceled,
    .slot-entry.canceled,
    .dienstplan-entry[data-status="canceled"],
    .availability-slot[data-status="canceled"] {
      background: #9ca3af !important;
      opacity: 0.6;
    }

    .dienstplan-slot.canceled .slot-time,
    .slot-entry.canceled .slot-time,
    .dienstplan-slot.canceled .artist-name,
    .slot-entry.canceled .artist-name {
      text-decoration: line-through;
    }

    [data-theme="dark"] .dienstplan-slot.canceled,
    [data-theme="dark"] .slot-entry.canceled {
      background: rgba(107, 114, 128, 0.4) !important;
    }

    /* Custom Date Picker fÃ¼r Guest Spot */
    .guest-spot-date-picker-container {
      position: relative;
    }

    .guest-spot-date-picker-trigger {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      background: white;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .guest-spot-date-picker-trigger:hover {
      border-color: rgba(0,0,0,0.2);
    }

    .guest-spot-calendar-popup {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      z-index: 10002;
      margin-top: 4px;
      padding: 16px;
      display: none;
    }

    .guest-spot-calendar-popup.active {
      display: block;
    }

    .guest-spot-calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .guest-spot-calendar-nav {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: rgba(0,0,0,0.05);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .guest-spot-calendar-nav:hover {
      background: rgba(0,0,0,0.1);
    }

    .guest-spot-calendar-nav:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .guest-spot-calendar-title {
      font-weight: 600;
      font-size: 15px;
    }

    .guest-spot-calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: #86868b;
      margin-bottom: 8px;
    }

    .guest-spot-calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .guest-spot-calendar-day {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 50%;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }

    .guest-spot-calendar-day:hover:not(:disabled) {
      background: rgba(0,0,0,0.05);
    }

    .guest-spot-calendar-day.selected {
      background: #1d1d1f;
      color: white;
    }

    .guest-spot-calendar-day.today {
      font-weight: 700;
      color: #007aff;
    }

    .guest-spot-calendar-day:disabled {
      color: #ccc;
      cursor: not-allowed;
    }

    .guest-spot-calendar-day.other-month {
      color: #ccc;
    }

    [data-theme="dark"] .guest-spot-calendar-popup {
      background: #2c2c2e;
      border-color: rgba(255,255,255,0.1);
    }

    [data-theme="dark"] .guest-spot-date-picker-trigger {
      background: #2c2c2e;
      border-color: rgba(255,255,255,0.1);
      color: #fff;
    }

    [data-theme="dark"] .guest-spot-calendar-day:hover:not(:disabled) {
      background: rgba(255,255,255,0.1);
    }

    /* Booking Type Colors - 1px colored border, light background */
    /* === DEUTSCHE work_process WERTE === */
    .event[data-type="neustechen"] {
      background: rgba(233, 30, 99, 0.1);
      border: 1px solid #E91E63;
      color: #AD1457;
    }
    .event[data-type="weiterstechen"] {
      background: rgba(33, 150, 243, 0.1);
      border: 1px solid #2196F3;
      color: #1565C0;
    }
    .event[data-type="nachstechen"] {
      background: rgba(255, 193, 7, 0.15);
      border: 1px solid #FFC107;
      color: #F57F17;
    }
    .event[data-type="beratung"] {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid #4CAF50;
      color: #2E7D32;
    }

    /* === ENGLISCHE booking_type WERTE === */
    .event[data-type="consultation"] {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid #4CAF50;
      color: #2E7D32;
    }
    .event[data-type="new_tattoo"] {
      background: rgba(233, 30, 99, 0.1);
      border: 1px solid #E91E63;
      color: #AD1457;
    }
    .event[data-type="continuing_tattoo"] {
      background: rgba(33, 150, 243, 0.1);
      border: 1px solid #2196F3;
      color: #1565C0;
    }
    .event[data-type="touch_up"] {
      background: rgba(255, 193, 7, 0.15);
      border: 1px solid #FFC107;
      color: #F57F17;
    }
    .event[data-type="selfbooking"] {
      background: rgba(121, 85, 72, 0.1);
      border: 1px solid #795548;
      color: #5D4037;
    }
    .event[data-type="wannado"] {
      background: rgba(156, 39, 176, 0.1);
      border: 1px solid #9C27B0;
      color: #7B1FA2;
    }
    .event[data-type="internal"] {
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid #F44336;
      color: #C62828;
    }
    .event[data-type="move"],
    .event[data-type="rescheduled"] {
      background: rgba(0, 188, 212, 0.1);
      border: 1px solid #00BCD4;
      color: #00838F;
    }
    .event[data-type="reserved"] {
      background: rgba(158, 158, 158, 0.1);
      border: 1px solid #9E9E9E;
      color: #616161;
    }
    .event[data-type="no_show"] {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #BDBDBD;
      color: #757575;
      opacity: 0.7;
    }

    /* === STATUS-BASIERTE STYLES === */
    .event[data-type="finished"] {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid #4CAF50;
      color: #2E7D32;
    }
    .event[data-type="scheduled"] {
      background: rgba(33, 150, 243, 0.1);
      border: 1px solid #2196F3;
      color: #1565C0;
    }
    .event[data-type="canceled"] {
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid #F44336;
      color: #C62828;
      opacity: 0.7;
    }
    .event[data-type="unknown"] {
      background: rgba(158, 158, 158, 0.1);
      border: 1px solid #9E9E9E;
      color: #616161;
    }

    /* === EVENTS KATEGORIE - Orange fÃ¼r normal, Rot fÃ¼r Anwesenheitspflicht === */
    .event[data-type="event"],
    .event.events:not([data-attendance="required"]) {
      background: rgba(255, 152, 0, 0.1);
      border: 1px solid #FF9800;
      color: #E65100;
    }
    .event[data-attendance="required"],
    .event.events[data-attendance="required"] {
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid #F44336;
      color: #C62828;
    }

    /* ========================================
       Dienstplan Grid - Frosted Glass
       ======================================== */
    .dienstplan-grid {
      background: var(--macos-panel) !important;
      backdrop-filter: var(--macos-blur-medium);
      -webkit-backdrop-filter: var(--macos-blur-medium);
      border: 1px solid var(--macos-stroke-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--macos-shadow-medium);
      overflow: auto;
    }
    
    .category-section {
      border-bottom:1px solid rgba(0,0,0,0.06);
    }
    
    .category-section:last-child {
      border-bottom:none;
    }
    
    .category-header-btn {
      width:100%;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      background:#f5f5f5;
      color:#1d1d1f;
      border:none;
      padding:12px 16px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:background 0.2s ease;
      font-family:inherit;
      text-align:left;
    }
    
    .category-header-btn:hover {
      background:#e8e8e8;
    }
    
    .category-header-btn .arrow {
      margin-right:8px;
      transition:transform 0.3s ease;
      font-size:12px;
      display:inline-block;
      width:16px;
    }
    
    .category-header-btn.active .arrow {
      transform:rotate(90deg);
    }
    
    .category-content {
      display:none;
    }
    
    .category-content.active {
      display:block;
    }
    
    .person-row-container {
      display:contents;
    }
    
    .dienstplan-table {
      width:100%;
      display:grid;
      grid-template-columns:150px repeat(31, 80px);
      border-collapse:collapse;
    }
    
    .dp-header-row {
      display:contents;
    }
    
    .dp-name-header {
      background:rgba(249,249,249,0.98);
      padding:12px;
      font-weight:600;
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      left:0;
      z-index:5;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      font-size:13px;
      color:#666;
      background:rgba(255,255,255,0.98);
    }
    
    .dp-day-header {
      background:var(--location-light);
      padding:8px 4px;
      font-weight:400;
      text-align:center;
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      font-size:11px;
      min-height:50px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
    }
    
    .dp-day-header .weekday {
      font-weight:500;
      color:#666;
      font-size:10px;
    }
    
    .dp-day-header .day-num {
      font-size:13px;
      font-weight:600;
      color:#1d1d1f;
    }
    
    .dp-row {
      display:contents;
    }
    
    .dp-name-cell {
      background:rgba(255,255,255,0.98);
      padding:10px 12px 10px 32px;
      font-weight:400;
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      left:0;
      z-index:4;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      font-size:13px;
      color:#1d1d1f;
    }
    
    .dp-cell {
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      min-height:40px;
      background:rgba(255,255,255,0.8);
      transition:background 0.15s ease;
      cursor:pointer;
    }
    
    .dp-cell:hover {
      background:rgba(0,113,227,0.04);
    }
    
    .dp-cell.working {
      background:var(--location-accent);
    }
    
    .dp-cell.off {
      background:#FFEBEE;
    }
    
    .dp-cell.vacation {
      background:#FFF3E0;
    }
    
    /* Apple-style Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 34px;
      height: 20px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e5e5ea;
      transition: .3s;
      border-radius: 10px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15), 0 1px 1px rgba(0,0,0,0.06);
    }
    
    input:checked + .toggle-slider {
      background-color: #34c759;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(14px);
    }
    
    .current-time-indicator {
      position: absolute;
      top: 100px;
      bottom: 0;
      width: 2px;
      background: #ff3b30;
      z-index: 20;
      pointer-events: none;
    }
    
    .current-time-indicator::before {
      content: '';
      position: absolute;
      left: -3px;
      top: 0;
      width: 8px;
      height: 8px;
      background: #ff3b30;
      border-radius: 50%;
    }

    /* ========================================
       Artist Info Events - Compact & Full Color
       ======================================== */
    .artist-info-event {
      opacity: 1 !important;
      font-size: 12px !important;
      padding: 4px 8px !important;
      min-height: 30px !important;
      max-height: 30px !important;
      height: 30px !important;
      border-left: none !important;
      font-weight: 600 !important;
      border-radius: 6px !important;
      overflow: hidden !important;
      cursor: pointer !important;
      transition: transform 0.1s ease, box-shadow 0.1s ease !important;
    }

    .artist-info-event:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .artist-info-event::before {
      content: 'ðŸ“Œ';
      margin-right: 4px;
      font-size: 10px;
    }

    /* Regular calendar items (not artist infos) */
    .cal-item:not(.artist-info-event) {
      min-height: 60px;
      padding: 8px;
      border-left-width: 4px;
    }

    /* ========================================
       Calendar Dark Mode Styles
       ======================================== */
    [data-theme="dark"] .calendar-container {
      background: var(--macos-panel) !important;
      border: 1px solid var(--border-color);
    }

    [data-theme="dark"] .slot-header {
      background: #2c2c2e;
      color: #f5f5f7;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .hour-header {
      background: #2c2c2e;
      color: #98989d;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .category-header {
      background: #2c2c2e;
      color: #f5f5f7;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .category-spacer {
      background: #1c1c1e;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    [data-theme="dark"] .slot-label {
      background: rgba(44, 44, 46, 0.98);
      border-right: 1px solid rgba(255, 255, 255, 0.08);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      color: #98989d;
    }

    [data-theme="dark"] .slot-label.empty {
      background: rgba(28, 28, 30, 0.98);
      color: #636366;
    }

    [data-theme="dark"] .slot-label.empty .slot-number {
      color: #98989d;
    }

    [data-theme="dark"] .slot-cell {
      background: rgba(44, 44, 46, 0.8);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      border-right: 1px solid rgba(255, 255, 255, 0.06);
    }

    [data-theme="dark"] .slot-cell.empty-slot {
      background: rgba(28, 28, 30, 0.6);
    }

    [data-theme="dark"] .slot-cell.empty-slot:hover {
      background: rgba(28, 28, 30, 0.6);
    }

    [data-theme="dark"] .slot-row.empty-row .slot-label {
      background: rgba(28, 28, 30, 0.5);
    }

    [data-theme="dark"] .cal-item {
      background: rgba(58, 58, 60, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #f5f5f7;
    }

    [data-theme="dark"] .cal-item:hover {
      background: rgba(58, 58, 60, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] .cal-title {
      color: #f5f5f7;
    }

    [data-theme="dark"] .cal-client {
      color: #98989d;
    }

    [data-theme="dark"] .cal-artist {
      color: #98989d;
    }

    [data-theme="dark"] .artist-info-event {
      background: rgba(10, 132, 255, 0.15);
      border-left-color: #0a84ff;
      color: #5eb3ff;
    }

    [data-theme="dark"] .artist-info-event .cal-title {
      color: #5eb3ff;
    }

    [data-theme="dark"] .slot-cell:hover {
      background: rgba(58, 58, 60, 0.9);
    }

    /* Calendar Tabs Dark Mode */
    [data-theme="dark"] .calendar-tabs {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    }

    [data-theme="dark"] #calendarTabAppointments,
    [data-theme="dark"] #calendarTabWorkTracking {
      color: #f5f5f7 !important;
    }

    [data-theme="dark"] #calendarTabAppointments:hover,
    [data-theme="dark"] #calendarTabWorkTracking:hover {
      color: #0a84ff !important;
    }

    /* Calendar Controls Dark Mode */
    [data-theme="dark"] #createEventBtn,
    [data-theme="dark"] #createBookingBtn {
      background: #0a84ff !important;
      color: #ffffff !important;
    }

    [data-theme="dark"] #createEventBtn:hover,
    [data-theme="dark"] #createBookingBtn:hover {
      background: #0077ed !important;
    }

    [data-theme="dark"] .btn-nav {
      background: rgba(58, 58, 60, 0.9) !important;
      color: #f5f5f7 !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
    }

    [data-theme="dark"] .btn-nav:hover {
      background: rgba(68, 68, 70, 0.9) !important;
    }

    [data-theme="dark"] #locationDropdown,
    [data-theme="dark"] #datePickerInput {
      background: rgba(58, 58, 60, 0.9) !important;
      color: #f5f5f7 !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
    }

    /* Guest Spot Modal Animation fÃ¼r Panel */
    .guest-spot-modal-shifted {
      transform: translateX(-295px) !important;
      border-top-right-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
    }

    .guest-spot-modal-content {
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                  border-radius 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========================================
       Modals & Dialogs - Frosted Glass Overlay
       ======================================== */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-backdrop.active {
      display: flex;
      opacity: 1;
    }

    /* Higher z-index for modals opened from other modals */
    .modal-backdrop.elevated {
      z-index: 10001 !important;
    }

    .modal-backdrop.elevated .modal {
      animation: slideInFromLeft 0.3s ease-out;
    }

    @keyframes slideInFromLeft {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .modal {
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: var(--macos-blur-strong);
      -webkit-backdrop-filter: var(--macos-blur-strong);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--macos-shadow-large);
      transform: scale(0.95);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-backdrop.active .modal {
      transform: scale(1);
    }

    .modal h3 {
      color: var(--macos-text-primary) !important;
      font-weight: 600;
      font-size: 17px;
      letter-spacing: -0.018em;
      margin: 0 0 var(--space-lg);
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .form-group label {
      font-size: 13px;
      font-weight: 500;
      color: var(--macos-text-secondary);
      letter-spacing: -0.008em;
    }

    .modal-actions {
      display: flex;
      gap: var(--space-md);
      justify-content: flex-end;
      margin-top: var(--space-xl);
    }
    
    .btn {
      padding:10px 20px;
      border-radius:8px;
      border:none;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.2s ease;
      font-family:inherit;
    }
    
    .btn-primary {
      background:var(--accent);
      color:white;
    }
    
    .btn-primary:hover {
      background:#0077ED;
    }
    
    .btn-secondary {
      background:#f5f5f5;
      color:var(--ink);
    }
    
    .btn-secondary:hover {
      background:#e5e5e5;
    }
    
    .btn-danger {
      background:#ff3b30;
      color:white;
    }
    
    .btn-danger:hover {
      background:#ff2d20;
    }
    
    .btn-icon {
      background:transparent;
      border:none;
      cursor:pointer;
      padding:6px;
      border-radius:6px;
      color:var(--muted);
      transition:all 0.2s ease;
      font-size:16px;
    }
    
    .btn-icon:hover {
      background:rgba(0,0,0,0.05);
      color:var(--ink);
    }
    
    /* Artist List Styles */
    .artist-list {
      list-style:none;
      padding:0;
      margin:16px 0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .artist-item {
      background:white;
      border:1px solid rgba(0,0,0,0.06);
      border-radius:10px;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition:all 0.2s ease;
    }
    
    .artist-item:hover {
      border-color:rgba(0,0,0,0.12);
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
    }
    
    .artist-info {
      display:flex;
      align-items:center;
      gap:12px;
      flex:1;
    }
    
    .artist-name {
      font-weight:500;
      font-size:15px;
    }
    
    .artist-badge {
      background:var(--location-light);
      color:var(--location-dark);
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:500;
    }
    
    .artist-badge.guest {
      background:#e3f2fd;
      color:#1565c0;
    }
    
    .artist-location {
      background:#FFF3E0;
      color:#E65100;
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:500;
    }
    
    .artist-rank {
      background:#F3E5F5;
      color:#7B1FA2;
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:500;
    }
    
    .customer-rank {
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:600;
    }
    
    .customer-rank.bronze {
      background:#D7CCC8;
      color:#4E342E;
    }
    
    .customer-rank.silver {
      background:#E0E0E0;
      color:#424242;
    }
    
    .customer-rank.gold {
      background:#FFF9C4;
      color:#F57F17;
    }
    
    .customer-rank.platinum {
      background:#E1F5FE;
      color:#01579B;
    }
    
    /* Sort Controls */
    .sort-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }
    
    .artist-instagram {
      color:var(--muted);
      font-size:13px;
      margin-left:8px;
    }
    
    .artist-actions {
      display:flex;
      gap:4px;
    }
    
    /* Customer Table Styles */
    /* Artist Table Styles */
    #artistsTable tbody tr {
      transition:background 0.15s ease;
    }

    #artistsTable tbody tr:hover {
      background:rgba(0,113,227,0.02);
    }

    [data-theme="dark"] #artistsTable tbody tr {
      background: rgba(44, 44, 46, 0.5); /* Dark gray in dark mode */
    }

    [data-theme="dark"] #artistsTable tbody tr:hover {
      background: rgba(58, 58, 60, 0.8); /* Darker gray on hover in dark mode */
    }

    #customersTable tbody tr {
      transition:background 0.15s ease;
    }

    #customersTable tbody tr:hover {
      background:rgba(0,113,227,0.02);
    }

    [data-theme="dark"] #customersTable tbody tr {
      background: rgba(44, 44, 46, 0.5); /* Dark gray in dark mode */
    }

    [data-theme="dark"] #customersTable tbody tr:hover {
      background: rgba(58, 58, 60, 0.8); /* Darker gray on hover in dark mode */
    }
    
    
    /* Responsive */
    @media (max-width: 768px) {
      .artist-item {
        flex-direction:column;
        align-items:flex-start;
        gap:12px;
      }
      
      .artist-actions {
        width:100%;
        justify-content:flex-end;
      }
    }
    
    /* Request Management Styles */
    .request-item {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background-color 0.15s ease;
      border: none;
      background: #fff;
    }
    [data-theme="dark"] .request-item {
      background: #1c1c1e;
    }
    .request-item:hover {
      background: #f5f5f7;
    }
    [data-theme="dark"] .request-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    .request-item.active,
    .request-item.selected {
      background: #e8e8ed;
    }
    [data-theme="dark"] .request-item.active,
    [data-theme="dark"] .request-item.selected {
      background: rgba(255, 255, 255, 0.1);
    }
    .request-item.new-status {
      background: #fff3cd;
    }
    [data-theme="dark"] .request-item.new-status {
      background: rgba(255, 193, 7, 0.2);
    }
    .request-item.old-status {
      background: #e8e8ed;
    }
    [data-theme="dark"] .request-item.old-status {
      background: #2c2c2e;
    }

    /* Request Card Styles */
    .request-card {
      background: #fff;
      border: none;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    .request-card:hover {
      background: #f5f5f7;
    }
    .request-card.active,
    .request-card.selected {
      background: #e8e8ed;
    }
    [data-theme="dark"] .request-card {
      background: #1c1c1e;
    }
    [data-theme="dark"] .request-card:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    [data-theme="dark"] .request-card.active,
    [data-theme="dark"] .request-card.selected {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Request Card Header - ID links, Badges rechts */
    .request-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .request-card-id {
      font-weight: 400;
      color: #86868b;
      font-size: 12px;
    }
    [data-theme="dark"] .request-card-id {
      color: #98989d;
    }

    /* Badge Container - Rang und Status nebeneinander */
    .request-card-badges {
      display: flex;
      gap: 0;
    }

    /* Rang Badge - linke Ecken gerundet */
    .request-card-rank {
      font-weight: 600;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 4px 8px;
      border-radius: 6px 0 0 6px;
      color: white;
    }

    /* Status Badge - rechte Ecken gerundet */
    .request-card-status {
      font-weight: 600;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 4px 8px;
      border-radius: 0 6px 6px 0;
      color: white;
    }

    /* Rang Farben mit Gradients */
    .request-card-rank.neukunde,
    .request-card-rank.Neukunde,
    .request-card-rank.new-customer {
      background: #1e3a5f;
    }
    .request-card-rank.bronze,
    .request-card-rank.Bronze {
      background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
    }
    .request-card-rank.silver,
    .request-card-rank.Silver,
    .request-card-rank.silber,
    .request-card-rank.Silber {
      background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%);
    }
    .request-card-rank.gold,
    .request-card-rank.Gold {
      background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
    }
    .request-card-rank.platinum,
    .request-card-rank.Platinum {
      background: linear-gradient(135deg, #9C27B0 0%, #6A1B9A 100%);
    }

    /* Status Farben */
    .request-card-status.new,
    .request-card-status.open_request {
      background: #1B5E20;
    }
    .request-card-status.pending {
      background: #E65100;
    }
    .request-card-status.scheduled {
      background: #0277BD;
    }
    .request-card-status.finished {
      background: #616161;
    }
    .request-card-status.canceled {
      background: #C62828;
    }

    /* Request Tab Hover Styles */
    .request-tab:hover:not(.active) {
      color: #1d1d1f !important;
      background: rgba(0, 0, 0, 0.04);
    }
    [data-theme="dark"] .request-tab:hover:not(.active) {
      color: #f5f5f7 !important;
      background: rgba(255, 255, 255, 0.08);
    }

    /* Request Cards - Hover/Selected fÃ¼r ALLE Sub-Tabs inkl. New Requests */
    .request-card,
    .request-item,
    .request-list-item,
    #newRequestsList .request-card,
    #openRequestsList .request-card,
    #pendingRequestsList .request-card,
    #scheduledRequestsList .request-card,
    #finishedRequestsList .request-card,
    #canceledRequestsList .request-card,
    [data-tab="new"] .request-card,
    [data-tab="open_request"] .request-card,
    .requests-list .request-card {
      background: #fff !important;
      border: none !important;
      box-shadow: none !important;
    }

    .request-card:hover,
    .request-item:hover,
    .request-list-item:hover,
    #newRequestsList .request-card:hover,
    #openRequestsList .request-card:hover,
    #pendingRequestsList .request-card:hover,
    #scheduledRequestsList .request-card:hover,
    #finishedRequestsList .request-card:hover,
    #canceledRequestsList .request-card:hover,
    [data-tab="new"] .request-card:hover,
    [data-tab="open_request"] .request-card:hover,
    .requests-list .request-card:hover {
      background: #f5f5f7 !important;
    }

    .request-card.active,
    .request-card.selected,
    .request-item.active,
    .request-item.selected,
    #newRequestsList .request-card.active,
    #newRequestsList .request-card.selected,
    #openRequestsList .request-card.active,
    #openRequestsList .request-card.selected,
    [data-tab="new"] .request-card.active,
    [data-tab="open_request"] .request-card.active,
    .requests-list .request-card.active,
    .requests-list .request-card.selected {
      background: #e8e8ed !important;
    }

    /* Dark Mode */
    [data-theme="dark"] .request-card,
    [data-theme="dark"] #newRequestsList .request-card,
    [data-theme="dark"] .requests-list .request-card {
      background: #1c1c1e !important;
    }

    [data-theme="dark"] .request-card:hover,
    [data-theme="dark"] #newRequestsList .request-card:hover,
    [data-theme="dark"] .requests-list .request-card:hover {
      background: rgba(255, 255, 255, 0.05) !important;
    }

    [data-theme="dark"] .request-card.active,
    [data-theme="dark"] .request-card.selected,
    [data-theme="dark"] #newRequestsList .request-card.active,
    [data-theme="dark"] #newRequestsList .request-card.selected {
      background: rgba(255, 255, 255, 0.1) !important;
    }

    /* Request Card Body */
    .request-card-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary, #1d1d1f);
      margin-bottom: 4px;
    }
    .request-card-location {
      font-size: 14px;
      color: #86868b;
      margin-bottom: 4px;
    }
    .request-card-date {
      font-size: 13px;
      color: #aeaeb2;
    }

    .request-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .request-id {
      font-size:11px;
      color:var(--muted);
      font-weight:600;
      font-family:monospace;
    }
    .request-badge {
      padding:4px 10px;
      border-radius:12px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .request-badge.open_request { background:#dc3545; color:white; }
    .request-badge.pending { background:#ffc107; color:#000; }
    .request-badge.scheduled { background:#28a745; color:white; }
    .request-badge.finished { background:#6c757d; color:white; }
    .request-badge.canceled { background:#dc3545; color:white; }

    /* Priority Badges */
    .priority-badge {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 10px;
      border-radius:12px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .priority-badge.urgent {
      background:#FEE2E2;
      color:#991B1B;
    }
    .priority-badge.high {
      background:#FED7AA;
      color:#9A3412;
    }
    .priority-badge.normal {
      background:#D1FAE5;
      color:#065F46;
    }
    .priority-badge.low {
      background:#F3F4F6;
      color:#6B7280;
    }

    /* Reference Images */
    .reference-images {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .reference-image-thumb {
      width:80px;
      height:80px;
      border-radius:8px;
      overflow:hidden;
      cursor:pointer;
      border:2px solid rgba(0,0,0,0.06);
      transition:all 0.2s;
    }
    .reference-image-thumb:hover {
      transform:scale(1.05);
      border-color:var(--accent);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .reference-image-thumb img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    /* Image Upload Area */
    .image-upload-area {
      border:2px dashed rgba(0,0,0,0.15);
      border-radius:12px;
      padding:32px;
      text-align:center;
      background:rgba(0,113,227,0.03);
      transition:all 0.3s;
      cursor:pointer;
      margin-top:12px;
    }
    .image-upload-area:hover {
      border-color:var(--accent);
      background:rgba(0,113,227,0.08);
    }
    .image-upload-area.drag-over {
      border-color:var(--accent);
      background:rgba(0,113,227,0.15);
      transform:scale(1.02);
    }
    .image-upload-icon {
      font-size:48px;
      margin-bottom:12px;
      opacity:0.6;
    }
    .image-upload-text {
      font-size:14px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .image-upload-hint {
      font-size:12px;
      color:var(--muted);
      opacity:0.7;
    }

    /* Editable Reference Images */
    .reference-images-editable {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .reference-image-editable {
      position:relative;
      width:120px;
      height:120px;
      border-radius:12px;
      overflow:hidden;
      border:2px solid rgba(0,0,0,0.1);
      transition:all 0.2s;
    }
    .reference-image-editable:hover {
      border-color:var(--accent);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .reference-image-editable img {
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .reference-image-delete {
      position:absolute;
      top:6px;
      right:6px;
      width:28px;
      height:28px;
      border-radius:50%;
      background:rgba(220,53,69,0.95);
      color:white;
      border:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      font-weight:bold;
      opacity:0;
      transition:all 0.2s;
      backdrop-filter:blur(10px);
    }
    .reference-image-editable:hover .reference-image-delete {
      opacity:1;
    }
    .reference-image-delete:hover {
      background:rgba(220,53,69,1);
      transform:scale(1.1);
    }

    /* No Data Placeholder */
    .no-data-placeholder {
      color:#9ca3af;
      font-size:13px;
      font-style:italic;
    }

    /* ========================================
       Project Grouping Styles
       ======================================== */

    /* Project Group Container */
    .project-group {
      margin-bottom: 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      overflow: hidden;
      background: white;
      transition: all 0.2s ease;
    }

    .project-group:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* Project Header */
    .project-header {
      padding: 16px;
      background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    .project-header:hover {
      background: linear-gradient(135deg, #eef1f5 0%, #f9fafb 100%);
    }

    .project-info {
      flex: 1;
    }

    .project-info h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: #1d1d1f;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .customer-name {
      font-size: 14px;
      color: var(--macos-text-primary);
      font-weight: 500;
      margin-right: 12px;
    }

    .project-stats {
      display: inline-flex;
      gap: 12px;
      font-size: 13px;
      color: #86868b;
      flex-wrap: wrap;
    }

    .project-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      margin-left: 12px;
    }

    .project-status.completed {
      background: #d1f4e0;
      color: #0d6832;
    }

    .project-status.in-progress {
      background: #fef3c7;
      color: #92400e;
    }

    .project-status.requested {
      background: #dbeafe;
      color: #1e40af;
    }

    /* Project Details */
    .project-details {
      padding: 16px;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      background: #fafafa;
      display: none;
    }

    .project-details.expanded {
      display: block;
    }

    .requests-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .requests-section h5 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--macos-text-primary);
    }

    /* Expand Button */
    .expand-btn {
      background: none;
      border: none;
      font-size: 18px;
      color: #86868b;
      cursor: pointer;
      transition: transform 0.2s;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .expand-btn:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .expand-btn.expanded {
      transform: rotate(180deg);
    }

    /* Project Group Header (for tables) */
    .project-group-header {
      background: rgba(0, 113, 227, 0.05);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .project-group-header:hover {
      background: rgba(0, 113, 227, 0.1);
    }

    .project-group-header td {
      padding: 12px 16px !important;
    }

    .project-group-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .project-badge {
      display: inline-block;
      padding: 4px 8px;
      background: #0071e3;
      color: white;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 12px;
    }

    .group-count {
      color: #86868b;
      font-size: 13px;
    }

    .expand-icon {
      margin-left: auto;
      font-size: 14px;
      color: #86868b;
      transition: transform 0.2s;
    }

    .expand-icon.expanded {
      transform: rotate(90deg);
    }

    .project-detail-row {
      background: white;
      display: none;
    }

    .project-detail-row.visible {
      display: table-row;
    }

    /* View Mode Toggle */
    .view-mode-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 10px;
      width: fit-content;
    }

    .toggle-btn {
      padding: 8px 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      font-weight: 500;
      color: var(--macos-text-primary);
    }

    .toggle-btn:hover {
      background: #f5f5f7;
      border-color: rgba(0, 0, 0, 0.15);
    }

    .toggle-btn.active {
      background: #1d1d1f;
      color: white;
      border-color: #1d1d1f;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    /* Customer Project Timeline Styles */
    .customer-project-card {
      position: relative;
      padding: 16px;
      padding-left: 24px;
      background: white;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .customer-project-card:hover {
      border-color: rgba(0, 113, 227, 0.3);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .project-status-indicator {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .customer-project-card.completed .project-status-indicator {
      background: #34c759;
    }

    .customer-project-card.in_progress .project-status-indicator {
      background: #ff9500;
    }

    .customer-project-card.requested .project-status-indicator {
      background: #007aff;
    }

    .project-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .project-number-small {
      font-size: 12px;
      font-weight: 600;
      color: #0071e3;
      font-family: 'Geist', -apple-system, sans-serif;
    }

    .project-status-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 10px;
      font-weight: 600;
    }

    .status-completed {
      background: #d1f4e0;
      color: #0d6832;
    }

    .status-in_progress {
      background: #fff3cd;
      color: #856404;
    }

    .status-requested {
      background: #e3f2fd;
      color: #1565c0;
    }

    .project-artist {
      font-size: 14px;
      font-weight: 500;
      color: #1d1d1f;
      margin-bottom: 6px;
    }

    .project-stats {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #86868b;
      margin-bottom: 6px;
    }

    .project-timeline-dates {
      font-size: 12px;
      color: #86868b;
    }

    /* Appointment Item Styles */
    .appointment-item {
      padding: 12px;
      background: white;
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .appointment-item:last-child {
      margin-bottom: 0;
    }

    .appointment-date {
      font-size: 14px;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 6px;
      font-family: 'Geist', -apple-system, sans-serif;
    }

    .appointment-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .booking-type {
      font-size: 13px;
      color: #86868b;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-scheduled, .status-badge.status-scheduled {
      background: #d1f4e0;
      color: #0d6832;
    }

    .status-finished, .status-badge.status-finished, .status-badge.status-completed {
      background: #e3f2fd;
      color: #1565c0;
    }

    .status-canceled, .status-badge.status-canceled, .status-badge.status-cancelled {
      background: #ffebee;
      color: #c62828;
    }

    .status-archived, .status-badge.status-archived {
      background: rgba(142, 142, 147, 0.1);
      color: #8E8E93;
    }

    /* ============================================
       STATE BADGES (DEUTSCH) - Appointment State Management
       ============================================ */
    .state-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 600;
      margin-right: 8px;
    }

    .state-badge.confirmed {
      background: #d1f4e0;
      color: #0d6832;
    }

    .state-badge.unknown {
      background: #e0e0e0;
      color: #666;
    }

    .state-badge.no-show {
      background: #ffebee;
      color: #c62828;
    }

    .state-badge.rescheduled {
      background: #fff3cd;
      color: #856404;
    }

    .state-badge.reserved {
      background: #e3f2fd;
      color: #1565c0;
    }

    /* ============================================
       STATUS BADGES (ENGLISH) - Auto-calculated Status
       ============================================ */
    .status-badge.scheduled {
      background: #e3f2fd;
      color: #1565c0;
    }

    .status-badge.finished {
      background: #d1f4e0;
      color: #0d6832;
    }

    .status-badge.canceled {
      background: #ffebee;
      color: #c62828;
    }

    .status-badge.no-show {
      background: #fce4ec;
      color: #c2185b;
    }

    .status-badge.reserved {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .status-badge.unknown {
      background: #e0e0e0;
      color: #666;
    }

    .status-badge.rescheduled {
      background: #fff3cd;
      color: #856404;
    }

    .status-badge.archived {
      background: rgba(142, 142, 147, 0.1);
      color: #8E8E93;
    }

    /* ============================================
       PAYMENT BADGES
       ============================================ */
    .payment-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .payment-badge.unpaid {
      background: #fff3cd;
      color: #856404;
    }

    .payment-badge.deposit {
      background: #d1ecf1;
      color: #0c5460;
    }

    .payment-badge.paid {
      background: #d4edda;
      color: #155724;
    }

    .payment-badge.refunded {
      background: #f8d7da;
      color: #721c24;
    }

    /* ============================================
       EDIT STATE MODAL - Interactive State Options
       ============================================ */
    .state-options .state-option {
      display: block;
      cursor: pointer;
    }

    .state-options .state-option input[type="radio"] {
      display: none;
    }

    .state-options .option-content {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #fafafa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .state-options .state-option:hover .option-content {
      background: #f0f0f0;
      border-color: #0071e3;
    }

    .state-options .state-option.selected .option-content,
    .state-options .state-option input:checked + .option-content {
      background: #e3f2fd;
      border-color: #0071e3;
      box-shadow: 0 2px 8px rgba(0, 113, 227, 0.2);
    }

    .appointment-notes {
      margin-top: 8px;
      font-size: 13px;
      color: #6e6e73;
      font-style: italic;
    }

    /* Image Modal */
    .image-modal {
      display:none;
      position:fixed;
      z-index:10000;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.9);
      align-items:center;
      justify-content:center;
    }
    .image-modal.active {
      display:flex;
    }
    .image-modal img {
      max-width:90%;
      max-height:90%;
      border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,0.5);
    }
    .image-modal-close {
      position:absolute;
      top:20px;
      right:20px;
      font-size:40px;
      color:white;
      cursor:pointer;
      background:rgba(0,0,0,0.5);
      width:50px;
      height:50px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background 0.2s;
    }
    .image-modal-close:hover {
      background:rgba(0,0,0,0.8);
    }

    /* Artist Preference List */
    .artist-preference-list {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .artist-preference-item {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 10px;
      background:rgba(0,113,227,0.1);
      color:var(--accent);
      border-radius:12px;
      font-size:12px;
      font-weight:600;
    }

    /* Artist Preference Tags */
    .artist-preference-tags {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
    }
    .artist-tag {
      display:inline-block;
      padding:6px 12px;
      background:#f3f4f6;
      border:1px solid #d1d5db;
      border-radius:6px;
      font-size:13px;
      font-weight:600;
      color:#374151;
    }
    .artist-tag-small {
      display:inline-block;
      padding:4px 10px;
      background:#f3f4f6;
      border:1px solid #d1d5db;
      border-radius:6px;
      font-size:11px;
      font-weight:600;
      color:#374151;
    }

    .request-name {
      font-size:15px;
      font-weight:600;
      margin-bottom:4px;
      color:var(--ink);
    }
    .request-date {
      font-size:12px;
      color:var(--muted);
    }
    
    /* Request Detail Styles */
    .detail-section {
      margin-bottom:32px;
    }
    .detail-section h3 {
      font-size:1rem;
      font-weight:600;
      margin:0 0 12px 0;
      color:#1d1d1f;
      border-bottom:2px solid rgba(0,0,0,0.06);
      padding-bottom:8px;
    }
    .detail-grid {
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:16px;
    }
    .detail-item {
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .detail-label {
      font-size:11px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.8px;
    }
    .detail-value {
      font-size:15px;
      color:var(--ink);
      font-weight:500;
    }
    .action-buttons {
      display:flex;
      gap:12px;
      margin-top:32px;
      padding-top:24px;
      border-top:1px solid rgba(0,0,0,0.06);
      flex-wrap:wrap;
    }
    .btn {
      padding:12px 24px;
      border-radius:10px;
      border:none;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      font-family:inherit;
    }
    .btn-primary {
      background:var(--accent);
      color:white;
    }
    .btn-primary:hover {
      background:#0077ed;
      box-shadow:0 4px 12px rgba(0,113,227,0.3);
      transform:translateY(-1px);
    }
    .btn-success {
      background:#28a745;
      color:white;
    }
    .btn-success:hover {
      background:#218838;
      box-shadow:0 4px 12px rgba(40,167,69,0.3);
      transform:translateY(-1px);
    }
    .btn-danger {
      background:#dc3545;
      color:white;
    }
    .btn-danger:hover {
      background:#c82333;
      box-shadow:0 4px 12px rgba(220,53,69,0.3);
      transform:translateY(-1px);
    }
    .btn-secondary {
      background:#f5f5f7;
      color:var(--ink);
    }
    .btn-secondary:hover {
      background:#e8e8ed;
    }

    /* Login & Profile Styles - Fullscreen */
    .login-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #ffffff !important; /* Always white, no dark mode */
      z-index: 999999;
      align-items: center;
      justify-content: center;
    }
    .login-backdrop.active {
      display: flex;
    }
    .login-modal {
      background: transparent;
      border-radius: 0;
      padding: 40px;
      width: 100%;
      max-width: 420px;
      position: relative;
    }
    .login-welcome {
      text-align: center;
      margin-bottom: 32px;
    }
    .login-welcome h2 {
      margin: 0 0 8px 0;
      font-size: 28px;
      font-weight: 600;
    }
    .login-welcome p {
      margin: 0;
      color: #86868b !important; /* Always use light mode color */
      font-size: 14px;
    }

    /* Force all login elements to use light mode colors */
    .login-backdrop * {
      color: #1d1d1f !important;
    }

    .login-backdrop .login-welcome h2,
    .login-backdrop label {
      color: #1d1d1f !important;
    }

    .login-backdrop input {
      background: #ffffff !important;
      color: #1d1d1f !important;
      border-color: #ddd !important;
    }
    .login-form .form-group {
      margin-bottom: 20px;
    }
    .login-form label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--ink);
    }
    .login-form input[type="text"],
    .login-form input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .login-form input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }
    .login-remember {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
    }
    .login-remember input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .login-remember label {
      font-size: 14px;
      cursor: pointer;
      margin: 0;
    }
    .login-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .skip-button {
      background: transparent;
      color: var(--muted);
      border: 1px dashed #ddd;
      text-decoration: none;
      font-size: 13px;
    }
    .skip-button:hover {
      background: #f5f5f5;
      color: var(--ink);
      border-color: #ccc;
    }
    .profile-button {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: #f5f5f7;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 24px;
      color: var(--ink);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: auto;
    }
    .profile-button:hover {
      background: #e8e8ed;
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .profile-button svg {
      width: 20px;
      height: 20px;
    }
    .profile-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(0, 0, 0, 0.1);
    }
    .profile-view {
      max-height: 80vh;
      overflow-y: auto;
    }
    .profile-header {
      text-align: center;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid #eee;
    }
    .profile-avatar-large {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 16px;
      border: 4px solid #f5f5f5;
      display: block;
    }
    .profile-info-group {
      margin-bottom: 20px;
    }
    .profile-info-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .profile-info-value {
      padding: 12px 16px;
      background: #f9f9f9;
      border-radius: 8px;
      font-size: 14px;
      color: var(--ink);
    }
    .profile-role-badge {
      display: inline-block;
      padding: 6px 12px;
      background: var(--accent);
      color: white;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .password-toggle {
      position: relative;
    }
    .password-toggle button {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      padding: 4px 8px;
    }
    .dashboard-welcome {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 32px;
      padding: 0;
      background: transparent;
      border-radius: 0;
      color: var(--text-primary);
    }
    .dashboard-welcome-avatar {
      display: none;
    }
    .dashboard-welcome-text h1 {
      margin: 0 0 4px 0;
      font-size: 28px;
      font-weight: 600;
    }
    .dashboard-welcome-text p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* ========================================
       Tab Header Styles (einheitlich)
       ======================================== */

    .tab-header {
      margin-bottom: 24px;
    }

    .tab-header-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .tab-header-subtitle {
      font-size: 14px;
      font-weight: 400;
      color: #86868b;
      margin: 0;
    }

    [data-theme="dark"] .tab-header-subtitle {
      color: #98989d;
    }

    /* ========================================
       DASHBOARD LAYOUT
       ======================================== */

    .dashboard-view {
      padding: 40px 24px;
    }

    .dashboard-grid {
      display: flex;
      flex-direction: column;
      gap: 24px;
      max-width: 1400px;
    }

    .dashboard-main {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* ========================================
       NEW DASHBOARD LAYOUT - 30/70 Split
       Left: Pinned Events + Schwarzes Brett (stacked)
       Right: Projects + Tasks (side by side)
       ======================================== */

    /* ========================================
       Dashboard 3-Column Layout (Left | Center | Right)
       ======================================== */

    /* Dashboard Container - Flex Row */
    .dashboard-container {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      min-height: 70vh;
    }

    /* ========================================
       Dashboard Left Column (Pinned Events + Schwarzes Brett)
       ======================================== */

    .dashboard-left-column {
      width: 30%;
      display: flex;
      flex-direction: column;
      gap: 24px;
      min-width: 280px;
      height: 70vh;
      max-height: 70vh;
    }

    .dashboard-left-column .pinned-events-wrapper {
      flex: 0 0 auto;
      max-height: 40%;
      overflow: hidden;
    }

    .dashboard-left-column .pinned-events-wrapper .dashboard-card {
      max-height: 100%;
      overflow-y: auto;
    }

    .dashboard-left-column .schwarzes-brett-wrapper {
      flex: 1;
      min-height: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .dashboard-left-column .schwarzes-brett-wrapper .dashboard-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #brettMessages {
      flex: 1;
      overflow-y: auto;
      padding: 0 16px;
    }

    #schwarzesBrettContainer .add-btn {
      flex-shrink: 0;
      margin: 12px 16px 16px;
    }

    /* ========================================
       Dashboard Right Columns (Projects + Tasks)
       ======================================== */

    .dashboard-right-columns {
      width: 70%;
      display: flex;
      gap: 24px;
      min-width: 0;
      height: 70vh;
      max-height: 70vh;
    }

    .dashboard-right-columns .todo-projects-wrapper,
    .dashboard-right-columns .todo-tasks-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      max-height: 70vh;
      overflow: hidden;
    }

    .dashboard-right-columns .todo-projects-left,
    .dashboard-right-columns .todo-tasks-right {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
      max-height: calc(70vh - 80px); /* Abzug fÃ¼r Title und Button */
      background: #fff;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.06);
    }

    /* Hidden Scrollbars fÃ¼r Projects und Tasks */
    .todo-projects-left,
    .todo-tasks-right,
    .todo-projects-list,
    .todo-tasks-list {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
    }

    .todo-projects-left::-webkit-scrollbar,
    .todo-tasks-right::-webkit-scrollbar,
    .todo-projects-list::-webkit-scrollbar,
    .todo-tasks-list::-webkit-scrollbar {
      display: none; /* Chrome/Safari */
    }

    /* Hidden Scrollbars fÃ¼r Pinned Events und Schwarzes Brett */
    .pinned-events-card,
    .schwarzes-brett-card,
    #brettMessages,
    #pinnedEventsContainer {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
    }

    .pinned-events-card::-webkit-scrollbar,
    .schwarzes-brett-card::-webkit-scrollbar,
    #brettMessages::-webkit-scrollbar,
    #pinnedEventsContainer::-webkit-scrollbar {
      display: none; /* Chrome/Safari */
    }

    .container-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .container-section-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0;
      padding: 10px;
    }

    [data-theme="dark"] .container-section-title {
      color: var(--macos-text-primary);
    }

    .dashboard-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    [data-theme="dark"] .dashboard-card {
      background: rgba(44, 44, 46, 0.5);
      border-color: rgba(255, 255, 255, 0.1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /* ========================================
       PINNED EVENTS
       ======================================== */

    .pinned-events-card {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      max-height: 500px;
    }

    .event-item {
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background-color 0.2s ease;
      border-radius: 4px;
      margin: 0 -4px;
      padding-left: 4px;
      padding-right: 4px;
    }

    .event-item:hover {
      background: var(--hover-bg-light);
    }

    [data-theme="dark"] .event-item {
      border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .event-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .event-item:last-child {
      border-bottom: none;
    }

    .event-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .event-meta {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .event-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      background: var(--hover-bg-light);
      color: var(--text-secondary);
    }

    .event-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    [data-theme="dark"] .event-empty {
      color: var(--macos-text-secondary);
    }

    /* ========================================
       SCHWARZES BRETT
       ======================================== */

    .schwarzes-brett-card {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      position: relative;
      max-height: 500px;
    }

    .brett-item {
      padding: 12px 0;
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      border-radius: 0;
      margin-bottom: 0;
      transition: background 0.15s ease;
    }

    .brett-item:last-child {
      border-bottom: none;
    }

    .brett-item:hover {
      background: rgba(0,0,0,0.02);
    }

    [data-theme="dark"] .brett-item {
      border-bottom-color: rgba(255,255,255,0.06);
    }

    [data-theme="dark"] .brett-item:hover {
      background: rgba(255,255,255,0.02);
    }

    .brett-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .brett-author {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .brett-time {
      font-size: 12px;
      color: var(--text-tertiary);
    }

    .brett-content {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .brett-footer {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brett-tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 6px;
      background: var(--hover-bg-light);
      color: var(--text-secondary);
    }

    [data-theme="dark"] .brett-tag {
      background: rgba(255, 255, 255, 0.1);
      color: var(--macos-text-secondary);
    }

    .brett-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Twitter-Style Schwarzes Brett Posts */
    .brett-item.twitter-style {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: var(--bg-secondary, #fff);
      border: 1px solid var(--border-color, rgba(0,0,0,0.08));
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }

    .brett-item.twitter-style:hover {
      background: var(--hover-bg-light, #f5f5f7);
    }

    [data-theme="dark"] .brett-item.twitter-style {
      background: rgba(58, 58, 60, 0.5);
      border-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .brett-item.twitter-style:hover {
      background: rgba(72, 72, 74, 0.6);
    }

    .brett-avatar {
      flex-shrink: 0;
      width: 48px;
      height: 48px;
    }

    .brett-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .brett-content-wrap {
      flex: 1;
      min-width: 0;
    }

    .brett-item.twitter-style .brett-header {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
      justify-content: flex-start;
    }

    .brett-item.twitter-style .brett-author {
      font-weight: 700;
      font-size: 15px;
      color: var(--macos-text-primary, #1d1d1f);
    }

    .brett-item.twitter-style .brett-time {
      font-size: 14px;
      color: var(--macos-text-tertiary, #86868b);
    }

    .brett-text {
      font-size: 15px;
      line-height: 1.4;
      color: var(--macos-text-primary, #1d1d1f);
      margin-bottom: 8px;
      white-space: pre-wrap;
    }

    [data-theme="dark"] .brett-text {
      color: var(--macos-text-secondary, #ccc);
    }

    /* ========================================
       ADD BUTTON
       ======================================== */

    .add-btn {
      width: 100%;
      height: 37px;
      margin-top: 12px;
      border: none;
      background: #1d1d1f;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .add-btn:hover {
      background: #2d2d2f;
      color: white;
    }

    [data-theme="dark"] .add-btn {
      background: #3a3a3c;
    }

    [data-theme="dark"] .add-btn:hover {
      background: #4a4a4c;
    }

    /* ========================================
       NEW MESSAGE POPUP
       ======================================== */

    .new-message-popup {
      display: none;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .new-message-popup.active {
      display: block;
    }

    .popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .popup-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0;
    }

    .popup-close {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.15s ease;
    }

    .popup-close:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
    }

    .popup-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg);
      font-size: 14px;
      color: var(--text-primary);
      resize: vertical;
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin-bottom: 12px;
    }

    .popup-textarea::placeholder {
      color: var(--text-secondary);
    }

    .popup-textarea:focus {
      outline: none;
      border-color: var(--input-focus-border);
    }

    /* ========================================
       TO-DO PROJECTS STYLES
       ======================================== */

    .todo-projects-card {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      max-height: 500px;
    }

    /* Project Card */
    .project-card {
      padding: 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-primary);
      margin-bottom: 12px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .project-card:hover {
      border-color: var(--border-color-strong);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    [data-theme="dark"] .project-card {
      background: rgba(58, 58, 60, 0.5);
      border-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .project-card:hover {
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    .project-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .project-card-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .project-card-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .team-badge {
      font-size: 16px;
      opacity: 0.7;
    }

    .project-menu-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      font-size: 18px;
      font-weight: bold;
    }

    .project-menu-btn:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
    }

    /* Progress Bar */
    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: rgba(0, 0, 0, 0.08);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    [data-theme="dark"] .progress-bar-container {
      background: rgba(255, 255, 255, 0.1);
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-bar-fill.progress-high {
      background: #22c55e;
    }

    .progress-bar-fill.progress-medium {
      background: #eab308;
    }

    .progress-bar-fill.progress-low {
      background: #6b7280;
    }

    .progress-text {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Member Tag */
    .member-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(0, 122, 255, 0.1);
      border: 1px solid rgba(0, 122, 255, 0.2);
      border-radius: 16px;
      font-size: 13px;
      color: var(--accent);
      font-weight: 500;
    }

    .member-tag .remove-member {
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s;
      font-size: 14px;
    }

    .member-tag .remove-member:hover {
      opacity: 1;
    }

    /* User Search Result Item */
    .user-search-item {
      padding: 10px 12px;
      cursor: pointer;
      transition: background-color 0.15s;
      font-size: 14px;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
    }

    .user-search-item:last-child {
      border-bottom: none;
    }

    .user-search-item:hover {
      background: var(--hover-bg-light);
    }

    .user-search-item .user-email {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* Project Detail Modal */
    .project-detail-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .project-detail-modal.active {
      display: flex;
    }

    .project-detail-content {
      background: var(--bg-primary);
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] .project-detail-content {
      background: rgba(44, 44, 46, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .project-detail-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .project-detail-back {
      background: transparent;
      border: none;
      color: var(--accent);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 6px;
      transition: background 0.15s;
    }

    .project-detail-back:hover {
      background: var(--hover-bg-light);
    }

    .project-detail-body {
      padding: 24px;
    }

    .project-detail-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .project-detail-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .project-detail-description {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    /* Tasks Section */
    .tasks-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .tasks-section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .add-task-btn {
      padding: 6px 14px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .add-task-btn:hover {
      background: var(--hover-bg-light);
      border-color: var(--border-color-strong);
    }

    /* Task Item */
    .task-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .task-item:last-child {
      border-bottom: none;
    }

    .task-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .task-title {
      flex: 1;
      font-size: 14px;
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .task-item.completed .task-title {
      text-decoration: line-through;
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .task-delete-btn {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      opacity: 0;
      flex-shrink: 0;
    }

    .task-item:hover .task-delete-btn {
      opacity: 1;
    }

    .task-delete-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    /* Add Task Input */
    .add-task-input-container {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .add-task-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--input-bg);
      font-size: 14px;
      color: var(--text-primary);
      font-family: inherit;
    }

    .add-task-input:focus {
      outline: none;
      border-color: var(--input-focus-border);
    }

    .add-task-submit {
      padding: 10px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .add-task-submit:hover {
      opacity: 0.9;
    }

    /* Members Section */
    .members-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border-color);
    }

    .members-section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
    }

    .member-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .member-item:last-child {
      border-bottom: none;
    }

    .member-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--text-primary);
    }

    .member-status {
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 500;
    }

    .member-status.status-owner {
      background: rgba(0, 122, 255, 0.1);
      color: var(--accent);
    }

    .member-status.status-accepted {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
    }

    .member-status.status-pending {
      background: rgba(234, 179, 8, 0.1);
      color: #eab308;
    }

    /* Invitation Card */
    .invitation-card {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.15s;
    }

    .invitation-card:hover {
      background: var(--hover-bg-light);
    }

    .invitation-card:last-child {
      border-bottom: none;
    }

    .invitation-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .invitation-from {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .invitation-actions {
      display: flex;
      gap: 8px;
    }

    .invitation-btn {
      flex: 1;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
      font-family: inherit;
    }

    .invitation-btn-decline {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    .invitation-btn-decline:hover {
      background: var(--hover-bg-light);
      border-color: var(--border-color-strong);
    }

    .invitation-btn-accept {
      background: var(--accent);
      color: white;
    }

    .invitation-btn-accept:hover {
      opacity: 0.9;
    }

    /* ========================================
       NEW TO-DO PROJECTS STYLES (Two Column Layout)
       ======================================== */

    /* Main Container - Two Column Layout */
    .todo-projects-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      min-height: 400px;
    }

    /* Left Container - Recent Projects (uses dashboard-card style) */
    .todo-projects-left {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
      max-height: 500px;
    }

    [data-theme="dark"] .todo-projects-left {
      background: rgba(44, 44, 46, 0.5);
      border-color: rgba(255, 255, 255, 0.1);
    }

    /* Projects List */
    .todo-projects-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 16px;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Project Card - NEW */
    .todo-project-card {
      background: transparent;
      border: none;
      border-radius: 12px;
      padding: 16px 20px;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .todo-project-card:hover {
      background: #f5f5f7; /* Hellgrau bei Hover */
    }

    /* Selected Project - Mittelgrau Background */
    .todo-project-card.selected {
      background: #e8e8ed; /* Mittelgrau bei Selected/Aufgerufen */
    }

    .todo-project-card.selected .todo-project-title,
    .todo-project-card.selected .todo-project-percent,
    .todo-project-card.selected .todo-project-collaborators {
      color: #1d1d1f;
    }

    .todo-project-card.selected .todo-project-collaborators {
      opacity: 0.8;
    }

    /* Edit Button - IMMER Outline Style */
    .todo-project-card.selected .todo-edit-btn,
    .todo-project-card:hover .todo-edit-btn {
      background: transparent !important;
      border: 1px solid #86868b !important;
      color: #1d1d1f !important;
    }

    [data-theme="dark"] .todo-project-card.selected .todo-edit-btn,
    [data-theme="dark"] .todo-project-card:hover .todo-edit-btn {
      border-color: #636366 !important;
      color: #f5f5f7 !important;
    }

    .todo-project-card.selected .todo-progress-container {
      background: rgba(0, 0, 0, 0.1);
    }

    /* Dark Mode Anpassungen fÃ¼r Projects */
    [data-theme="dark"] .todo-project-card:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    [data-theme="dark"] .todo-project-card.selected {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Project Header Row */
    .todo-project-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .todo-project-title {
      font-size: 16px;
      font-weight: 600;
      color: #1d1d1f;
      margin: 0;
      flex: 1;
    }

    .todo-project-meta {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Due Date Badge */
    .todo-due-badge {
      font-size: 13px;
      font-weight: 500;
    }

    .todo-due-badge.due-soon {
      color: #f59e0b;
    }

    .todo-due-badge.overdue {
      color: #ef4444;
    }

    .todo-due-badge.on-track {
      color: #22c55e;
    }

    .todo-project-percent {
      font-size: 14px;
      font-weight: 600;
      color: #1d1d1f !important;
    }

    /* Project Percentage - IMMER dunkle Farbe */
    .todo-project-card.selected .todo-project-percent,
    .todo-project-card:hover .todo-project-percent {
      color: #1d1d1f !important;
    }

    [data-theme="dark"] .todo-project-percent,
    [data-theme="dark"] .todo-project-card.selected .todo-project-percent,
    [data-theme="dark"] .todo-project-card:hover .todo-project-percent {
      color: #f5f5f7 !important;
    }

    /* Progress Bar - NEW */
    .todo-progress-container {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .todo-progress-bar {
      height: 100%;
      border-radius: 5px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%);
    }

    /* Project Footer */
    .todo-project-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .todo-project-collaborators {
      font-size: 13px;
      color: #6b7280;
    }

    .todo-edit-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      transition: all 0.15s ease;
      font-family: inherit;
    }

    .todo-edit-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }

    /* Right Container - Task List (uses dashboard-card style) */
    .todo-tasks-right {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
      max-height: 500px;
    }

    [data-theme="dark"] .todo-tasks-right {
      background: rgba(44, 44, 46, 0.5);
      border-color: rgba(255, 255, 255, 0.1);
    }

    /* Tasks List */
    .todo-tasks-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 16px;
      min-height: 0;
    }

    /* Task Item - NEW */
    .todo-task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 8px;
      gap: 12px;
      transition: background-color 0.15s ease;
      border-radius: 8px;
      margin: 0 -8px;
    }

    .todo-task-item:hover {
      background: #f5f5f7;
    }

    [data-theme="dark"] .todo-task-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .todo-task-title {
      font-size: 15px;
      color: #1d1d1f;
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .todo-task-item.completed .todo-task-title {
      text-decoration: line-through;
      color: #9ca3af;
    }

    .todo-task-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .todo-task-assignee {
      font-size: 14px;
      color: #6b7280;
    }

    .todo-task-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      transition: all 0.2s ease;
      position: relative;
    }

    .todo-task-checkbox:checked {
      background: #22c55e;
      border-color: #22c55e;
    }

    .todo-task-checkbox:checked::after {
      content: 'âœ“';
      position: absolute;
      color: white;
      font-size: 12px;
      font-weight: bold;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .todo-task-checkbox:hover {
      border-color: #9ca3af;
    }

    /* ========================================
       Task Item - 3-Punkte MenÃ¼ (wie Schwarzes Brett)
       ======================================== */

    .task-menu-container {
      position: relative;
    }

    .task-menu-trigger {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      color: #86868b;
      font-size: 16px;
      line-height: 1;
      transition: background-color 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .task-menu-trigger:hover {
      background: #f5f5f7;
      color: #1d1d1f;
    }

    [data-theme="dark"] .task-menu-trigger:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #f5f5f7;
    }

    .task-menu-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 140px;
      z-index: 1000;
      display: none;
      overflow: hidden;
    }

    .task-menu-dropdown.active {
      display: block;
    }

    [data-theme="dark"] .task-menu-dropdown {
      background: #2c2c2e;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .task-menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      font-size: 13px;
      color: #1d1d1f;
      cursor: pointer;
      transition: background-color 0.15s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .task-menu-item:hover {
      background: #f5f5f7;
    }

    [data-theme="dark"] .task-menu-item {
      color: #f5f5f7;
    }

    [data-theme="dark"] .task-menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .task-menu-item.delete {
      color: #ff3b30;
    }

    .task-menu-item.delete:hover {
      background: #fff5f5;
    }

    [data-theme="dark"] .task-menu-item.delete:hover {
      background: rgba(255, 59, 48, 0.15);
    }

    .task-menu-item svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    /* ========================================
       Task Popups (View, Edit, Add)
       ======================================== */

    .task-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }

    .task-popup {
      background: #fff;
      border-radius: 16px;
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
    }

    [data-theme="dark"] .task-popup {
      background: #1c1c1e;
    }

    .task-popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1;
    }

    [data-theme="dark"] .task-popup-header {
      background: #1c1c1e;
      border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    .task-popup-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .task-popup-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #86868b;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.15s ease;
    }

    .task-popup-close:hover {
      background: #f5f5f7;
      color: #1d1d1f;
    }

    [data-theme="dark"] .task-popup-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #f5f5f7;
    }

    .task-popup-body {
      padding: 24px;
    }

    .task-popup-section {
      margin-bottom: 24px;
    }

    .task-popup-section:last-child {
      margin-bottom: 0;
    }

    .task-popup-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #86868b;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .task-popup-text {
      font-size: 15px;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .task-popup-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d1d6;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      background: #fff;
      color: var(--text-primary);
      transition: border-color 0.15s ease;
      box-sizing: border-box;
    }

    .task-popup-input:focus {
      outline: none;
      border-color: #007AFF;
    }

    [data-theme="dark"] .task-popup-input {
      background: #2c2c2e;
      border-color: #48484a;
    }

    .task-popup-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px 14px;
      border: 1px solid #d1d1d6;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      background: #fff;
      color: var(--text-primary);
      resize: vertical;
      transition: border-color 0.15s ease;
      box-sizing: border-box;
    }

    .task-popup-textarea:focus {
      outline: none;
      border-color: #007AFF;
    }

    [data-theme="dark"] .task-popup-textarea {
      background: #2c2c2e;
      border-color: #48484a;
    }

    /* Attachment Styles */
    .task-attachments-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .task-attachment-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f5f5f7;
      border-radius: 10px;
      transition: background-color 0.15s ease;
    }

    [data-theme="dark"] .task-attachment-item {
      background: #2c2c2e;
    }

    .task-attachment-preview {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      object-fit: cover;
      background: #e5e5ea;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .task-attachment-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }

    .task-attachment-preview.pdf {
      background: #ff3b30;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }

    .task-attachment-info {
      flex: 1;
      min-width: 0;
    }

    .task-attachment-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .task-attachment-size {
      font-size: 12px;
      color: #86868b;
      margin-top: 2px;
    }

    .task-attachment-actions {
      display: flex;
      gap: 8px;
    }

    .task-attachment-btn {
      background: none;
      border: none;
      padding: 6px;
      border-radius: 6px;
      cursor: pointer;
      color: #86868b;
      transition: all 0.15s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .task-attachment-btn:hover {
      background: #e5e5ea;
      color: #1d1d1f;
    }

    .task-attachment-btn.delete:hover {
      background: #fff5f5;
      color: #ff3b30;
    }

    [data-theme="dark"] .task-attachment-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #f5f5f7;
    }

    /* File Upload Area */
    .task-file-upload {
      border: 2px dashed #d1d1d6;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
      margin-top: 12px;
    }

    .task-file-upload:hover {
      border-color: #007AFF;
      background: rgba(0, 122, 255, 0.05);
    }

    .task-file-upload.dragover {
      border-color: #007AFF;
      background: rgba(0, 122, 255, 0.1);
    }

    .task-file-upload-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .task-file-upload-text {
      font-size: 14px;
      color: #86868b;
    }

    .task-file-upload-text strong {
      color: #007AFF;
    }

    .task-file-upload-hint {
      font-size: 12px;
      color: #aeaeb2;
      margin-top: 4px;
    }

    .task-file-upload input[type="file"] {
      display: none;
    }

    .task-file-upload.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    /* Popup Actions */
    .task-popup-actions {
      display: flex;
      gap: 12px;
      padding: 20px 24px;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      justify-content: flex-end;
    }

    [data-theme="dark"] .task-popup-actions {
      border-top-color: rgba(255, 255, 255, 0.1);
    }

    .task-popup-btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .task-popup-btn.secondary {
      background: transparent;
      border: 1px solid #d1d1d6;
      color: #1d1d1f;
    }

    .task-popup-btn.secondary:hover {
      border-color: #86868b;
    }

    [data-theme="dark"] .task-popup-btn.secondary {
      border-color: #48484a;
      color: #f5f5f7;
    }

    .task-popup-btn.primary {
      background: #1d1d1f;
      border: none;
      color: #fff;
    }

    .task-popup-btn.primary:hover {
      background: #333;
    }

    [data-theme="dark"] .task-popup-btn.primary {
      background: #0a84ff;
    }

    .task-popup-btn.primary:disabled {
      background: #d1d1d6;
      cursor: not-allowed;
    }

    /* No Attachments State */
    .task-no-attachments {
      text-align: center;
      padding: 20px;
      color: #86868b;
      font-size: 14px;
    }

    /* Empty State */
    .todo-empty-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #9ca3af;
      font-size: 15px;
    }

    /* Edit Project Modal */
    .todo-edit-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .todo-edit-modal.active {
      display: flex;
    }

    .todo-edit-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .todo-edit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .todo-edit-title {
      font-size: 18px;
      font-weight: 600;
      color: #1d1d1f;
      margin: 0;
    }

    .todo-edit-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }

    .todo-edit-close:hover {
      color: #1d1d1f;
    }

    .todo-form-group {
      margin-bottom: 16px;
    }

    .todo-form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }

    .todo-form-input,
    .todo-form-textarea,
    .todo-form-select {
      width: 100%;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      color: #1d1d1f;
      background: white;
      box-sizing: border-box;
    }

    .todo-form-input:focus,
    .todo-form-textarea:focus,
    .todo-form-select:focus {
      outline: none;
      border-color: #007AFF;
    }

    .todo-form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Collaborators Section in Modal */
    .todo-collab-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }

    .todo-collab-title {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 12px;
    }

    .todo-collab-search {
      position: relative;
      margin-bottom: 12px;
    }

    .todo-collab-search input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .todo-collab-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      margin-top: 4px;
      max-height: 150px;
      overflow-y: auto;
      display: none;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .todo-collab-results.active {
      display: block;
    }

    .todo-collab-item {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
      border-bottom: 1px solid #f3f4f6;
    }

    .todo-collab-item:last-child {
      border-bottom: none;
    }

    .todo-collab-item:hover {
      background: #f3f4f6;
    }

    .todo-collab-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .todo-collab-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #e0f2fe;
      border-radius: 16px;
      font-size: 13px;
      color: #0369a1;
    }

    .todo-collab-remove {
      cursor: pointer;
      font-size: 14px;
      opacity: 0.7;
    }

    .todo-collab-remove:hover {
      opacity: 1;
    }

    .todo-form-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .todo-btn-cancel {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      cursor: pointer;
      font-family: inherit;
    }

    .todo-btn-cancel:hover {
      background: #f3f4f6;
    }

    .todo-btn-save {
      flex: 1;
      padding: 12px;
      background: #1d1d1f;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: white;
      cursor: pointer;
      font-family: inherit;
    }

    .todo-btn-save:hover {
      background: #333333;
    }

    .todo-btn-delete {
      padding: 12px;
      background: #ff3b30;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #ffffff;
      cursor: pointer;
      font-family: inherit;
    }

    .todo-btn-delete:hover {
      background: #e6352b;
    }

    /* Add Task Modal */
    .todo-task-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .todo-task-modal.active {
      display: flex;
    }

    .todo-task-modal-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    /* Responsive - Tablet (1024px) */
    @media (max-width: 1024px) {
      .dashboard-container {
        flex-direction: column;
        min-height: auto;
      }

      .dashboard-left-column {
        width: 100%;
        flex-direction: row;
        height: auto;
        max-height: none;
      }

      .dashboard-left-column .pinned-events-wrapper,
      .dashboard-left-column .schwarzes-brett-wrapper {
        flex: 1;
        max-height: 300px;
      }

      .dashboard-right-columns {
        width: 100%;
        height: auto;
        max-height: none;
      }

      .dashboard-right-columns .todo-projects-wrapper,
      .dashboard-right-columns .todo-tasks-wrapper {
        max-height: none;
      }

      .dashboard-right-columns .todo-projects-left,
      .dashboard-right-columns .todo-tasks-right {
        max-height: 400px;
      }

      .todo-projects-left,
      .todo-tasks-right {
        min-height: 350px;
      }
    }

    /* Responsive - Mobile (768px) */
    @media (max-width: 768px) {
      .dashboard-container {
        flex-direction: column !important;
      }

      .dashboard-left-column {
        width: 100% !important;
        flex-direction: column !important;
        height: auto !important;
        max-height: none !important;
      }

      .dashboard-right-columns {
        width: 100% !important;
        flex-direction: column !important;
        height: auto !important;
        max-height: none !important;
      }

      .todo-projects-left,
      .todo-tasks-right,
      .pinned-events-card,
      .schwarzes-brett-card {
        min-height: auto;
        max-height: 400px;
      }
    }

    /* Customer Rank Badges (wie Request Cards) */
    .rank-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: #fff;
    }

    /* Neukunde - Navy Blau */
    .rank-badge.rank-neukunde,
    .rank-badge.neukunde {
      background: #1e3a5f;
    }

    /* Bronze - Kupfer Gradient */
    .rank-badge.rank-bronze,
    .rank-badge.bronze {
      background: linear-gradient(135deg, #CD7F32 0%, #B87333 100%);
    }

    /* Silver - Silber Gradient */
    .rank-badge.rank-silver,
    .rank-badge.silver {
      background: linear-gradient(135deg, #A8A9AD 0%, #71706E 100%);
    }

    /* Gold - Gold Gradient */
    .rank-badge.rank-gold,
    .rank-badge.gold {
      background: linear-gradient(135deg, #FFD700 0%, #D4AF37 100%);
    }

    /* Platinum - Lila Gradient */
    .rank-badge.rank-platinum,
    .rank-badge.platinum {
      background: linear-gradient(135deg, #7C6FB5 0%, #5856D6 100%);
    }

    /* Artist Rank Badges */
    .rank-badge.rank-R1 {
      background: #FEE2E2;
      color: #991B1B;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .rank-badge.rank-R2 {
      background: #FED7AA;
      color: #9A3412;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .rank-badge.rank-R3 {
      background: #FEF3C7;
      color: #92400E;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .rank-badge.rank-R4 {
      background: #D1FAE5;
      color: #065F46;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .rank-badge.rank-R5 {
      background: #DBEAFE;
      color: #1E40AF;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       NEU: Artist Rang Badges - Friends, Crew, Fam, VIP
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .rank-badge.rank-friends,
    .rank-badge.rank-Friends,
    .rank-badge.Friends {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }

    .rank-badge.rank-crew,
    .rank-badge.rank-Crew,
    .rank-badge.Crew {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      color: #1565c0;
      border: 1px solid #90caf9;
    }

    .rank-badge.rank-fam,
    .rank-badge.rank-Fam,
    .rank-badge.Fam {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      color: #e65100;
      border: 1px solid #ffcc80;
    }

    .rank-badge.rank-vip,
    .rank-badge.rank-VIP,
    .rank-badge.VIP {
      background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
      color: #c2185b;
      border: 1px solid #f48fb1;
    }

    /* Artist Type Badges */
    .type-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    .type-badge.guest {
      background: #E0E7FF;
      color: #3730A3;
    }

    .type-badge.resident {
      background: #D1FAE5;
      color: #065F46;
    }

    /* Status Badges */
    .status-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.active {
      background: #D1FAE5;
      color: #065F46;
    }

    .status-badge.inactive {
      background: #FEE2E2;
      color: #991B1B;
    }

    /* Location Badge */
    .location-badge {
      background: var(--location-light);
      color: var(--location-primary);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    /* Blacklist Badge */
    .blacklist-badge {
      background: #FEE2E2;
      color: #991B1B;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 8px;
      font-weight: 600;
    }

    /* Pagination */
    .pagination-controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      margin-top: 24px;
    }

    .btn-pagination {
      padding: 8px 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .btn-pagination:hover {
      background: var(--location-light);
      border-color: var(--location-primary);
    }

    .btn-pagination.active {
      background: var(--location-primary);
      color: white;
      border-color: var(--location-primary);
      font-weight: 600;
    }

    .pagination-dots {
      color: var(--muted);
      padding: 0 8px;
    }

    /* Filter Select Focus Styles */
    .filter-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
    }

    /* ========================================
       Analytics Charts - Frosted Glass
       ======================================== */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 24px;
    }

    .chart-card {
      background: var(--macos-panel) !important;
      backdrop-filter: var(--macos-blur-medium);
      -webkit-backdrop-filter: var(--macos-blur-medium);
      border-radius: var(--radius-xl);
      padding: 24px;
      box-shadow: none;
      border: none;
    }

    .chart-card h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--macos-text-primary) !important;
    }

    /* Pie Charts - Smaller Size (max 20vw) */
    .chart-card canvas {
      max-width: 20vw;
      max-height: 20vw;
      margin: 0 auto;
      display: block;
    }

    /* Timeline and Bar Charts - Keep Full Width */
    #bookingsTimeline,
    #revenueTimeline,
    #revenueByStatusChart {
      max-width: 100% !important;
      max-height: 600px !important;
    }

    /* Time Range Tabs */
    .time-range-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .time-tab {
      padding: 8px 16px;
      border: 1px solid var(--stroke);
      background: transparent;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ink);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .time-tab.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .time-tab:hover:not(.active) {
      background: rgba(0, 113, 227, 0.06);
    }

    /* Analytics Filters */
    .analytics-filters {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 16px;
    }

    .analytics-filters select {
      min-width: 200px;
    }

    /* Data Tables for Analytics */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .data-table th {
      text-align: left;
      padding: 8px 12px;
      font-weight: 600;
      color: var(--macos-text-secondary);
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .data-table td {
      padding: 8px 12px;
      color: var(--macos-text-primary);
      border-bottom: 1px solid rgba(0,0,0,0.04);
    }

    .data-table tbody tr:hover {
      background: rgba(0,0,0,0.02);
    }

    .data-table tfoot tr {
      border-top: 2px solid rgba(0,0,0,0.1);
      background: rgba(0,0,0,0.02);
    }

    .data-table tfoot td {
      padding: 12px;
      border-bottom: none;
    }

    /* Responsive Charts */
    @media (max-width: 1024px) {
      .charts-grid {
        grid-template-columns: 1fr !important;
      }
    }

    @media (max-width: 768px) {
      .time-range-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .time-tab {
        white-space: nowrap;
      }

      .analytics-filters {
        flex-direction: column;
        align-items: stretch;
      }

      .analytics-filters select {
        width: 100%;
      }
    }

    /* Hide Guestspot View Toggle on Mobile */
    @media (max-width: 768px) {
      .guestspot-view-toggle-btn {
        display: none !important;
      }
    }

    /* ========================================
       PROJECT DASHBOARD STYLES
       ======================================== */

    /* KPI Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .kpi-card {
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.2s;
    }

    .kpi-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }

    .kpi-card.active {
      background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
      border-color: #ff9500;
    }

    .kpi-card.completed {
      background: linear-gradient(135deg, #d1f4e0 0%, #ffffff 100%);
      border-color: #34c759;
    }

    .kpi-card.revenue {
      background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
      border-color: #0071e3;
    }

    .kpi-icon {
      font-size: 32px;
      line-height: 1;
    }

    .kpi-content {
      flex: 1;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 700;
      color: #1d1d1f;
      font-family: 'Geist', sans-serif;
      line-height: 1.2;
    }

    .kpi-label {
      font-size: 13px;
      color: #86868b;
      margin-top: 4px;
    }

    /* Performance Table */
    .performance-table-wrapper {
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    .performance-table {
      width: 100%;
      border-collapse: collapse;
    }

    .performance-table thead {
      background: #f5f7fa;
    }

    .performance-table th {
      padding: 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: #1d1d1f;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(0, 0, 0, 0.06);
    }

    .performance-table td {
      padding: 16px;
      font-size: 14px;
      color: #1d1d1f;
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
    }

    .performance-table tbody tr:hover {
      background: #fafafa;
    }

    .performance-table .artist-name,
    .performance-table .customer-name {
      font-weight: 600;
    }

    .performance-table .revenue {
      font-weight: 600;
      color: #34c759;
    }

    .badge-success {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: #d1f4e0;
      color: #0d6832;
    }

    .badge-warning {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: #fff3cd;
      color: #856404;
    }

    /* Charts Container */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-top: 32px;
    }

    .chart-card {
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 12px;
      padding: 24px;
      min-height: 350px;
    }

    .chart-card canvas {
      max-height: 300px;
    }

    .stats-summary {
      background: linear-gradient(135deg, #0071e3 0%, #0056b3 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .stats-summary h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .dashboard-section {
      margin-bottom: 48px;
    }

    .dashboard-section h2 {
      margin-bottom: 24px;
      font-size: 24px;
      font-weight: 600;
      color: #1d1d1f;
    }

    /* Loading Progress Bar - Pop-up Style (Bottom Right) */
    .loading-overlay {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.3s ease, transform 0.3s ease;
      transform: translateY(0);
      pointer-events: none; /* Don't block clicks on the page */
    }

    .loading-overlay.hidden {
      opacity: 0;
      transform: translateY(20px);
    }

    .loading-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 20px 24px;
      border-radius: 16px;
      pointer-events: auto; /* Allow clicks on the container itself */
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
      min-width: 320px;
      pointer-events: auto; /* Allow clicks on the modal itself */
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .progress-line {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #0071e3 0%, #00a8ff 100%);
      border-radius: inherit;
      transition: width 0.15s linear;
      box-shadow: 0 0 8px rgba(0, 113, 227, 0.5);
    }

    .progress-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #fff;
    }

    .progress-percent {
      font-weight: 600;
      font-size: 15px;
      font-variant-numeric: tabular-nums;
      color: #fff;
    }

    .progress-text {
      color: rgba(255, 255, 255, 0.8);
      font-size: 13px;
      font-weight: 500;
      margin-top: 4px;
      line-height: 1.4;
    }

    /* Close button for progress bar */
    .progress-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
      opacity: 0;
    }

    .loading-container:hover .progress-close {
      opacity: 1;
    }

    .progress-close:hover {
      background: rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
    }

    /* Responsive Design for Mobile */
    @media (max-width: 768px) {
      .loading-overlay {
        bottom: 16px;
        right: 16px;
        left: 16px;
      }

      .loading-container {
        min-width: unset;
        width: 100%;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOADING SCREEN - Fullscreen with Background Image
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;  /* Kein Scrollen */
      z-index: 99999;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .loading-screen.active {
      opacity: 1;
      visibility: visible;
    }

    .loading-screen.fade-out {
      opacity: 0;
      visibility: hidden;
    }

    /* Background Image Container */
    .loading-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 1;
      background-color: #1a1a1a; /* Fallback */
    }

    /* Background Image - als IMG Tag fÃ¼r bessere ZuverlÃ¤ssigkeit */
    .loading-bg-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }

    /* Logo */
    .loading-logo {
      position: absolute;
      bottom: 120px;
      left: 48px;
      font-family: "Geist", -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 18px;
      font-weight: 500;
      letter-spacing: 2px;
      color: #ffffff;
      z-index: 10;
    }

    /* Progress Container - Unten am Screen */
    .loading-progress-container {
      position: absolute;
      bottom: 60px;
      left: 60px;
      right: 60px;
      z-index: 10;
    }

    /* Status Text */
    .loading-status {
      font-family: "Geist", -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 12px;
    }

    /* Progress Bar Container */
    .loading-progress-bar {
      position: relative;
      width: 100%;
      height: 2px;
      background: transparent;  /* TRANSPARENT statt grau */
      border-radius: 1px;
      overflow: visible;
    }

    /* Progress Fill (weiÃŸe Linie) */
    .loading-progress-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0%;
      background: #ffffff;
      border-radius: 1px;
      transition: width 0.15s ease-out;
    }

    /* Prozent Label - AUF GLEICHER HÃ–HE wie Progress Bar */
    .loading-progress-percent {
      position: absolute;
      top: 50%;                    /* Vertikal zentriert zur Linie */
      transform: translateY(-50%); /* Zentrieren */
      left: 0%;
      margin-left: 12px;           /* Abstand nach der Linie */
      font-family: "Geist", -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: #ffffff;
      transition: left 0.15s ease-out;
      white-space: nowrap;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GLASS OVERLAY - Animiert nach Loading (FULLSCREEN)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .loading-glass-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;  /* Kein Scrollen */
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(0px);
      -webkit-backdrop-filter: blur(0px);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .loading-glass-overlay.active {
      opacity: 1;
      visibility: visible;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOGIN FORM - Transparent, KEINE Box
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .loading-login-form {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 40px;
      width: 100%;
      max-width: 380px;
      transform: translateY(30px);
      opacity: 0;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.2s;
    }

    .loading-glass-overlay.active .loading-login-form {
      transform: translateY(0);
      opacity: 1;
    }

    .loading-login-form h2 {
      font-family: "Geist", -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 28px;
      font-weight: 600;
      color: #ffffff !important;
      margin: 0 0 8px 0;
      text-align: center;
      letter-spacing: -0.5px;
    }

    .loading-login-form p {
      font-family: "Geist", -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      margin: 0 0 32px 0;
      text-align: center;
    }

    .login-field {
      margin-bottom: 20px;
    }

    .login-field label {
      display: block;
      font-family: "Geist", -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: #ffffff;
      margin-bottom: 6px;
    }

    .login-field input {
      width: 100%;
      padding: 14px 16px;
      font-family: "Geist", -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 15px;
      color: #ffffff;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      outline: none;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }

    .login-field input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .login-field input:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .loading-login-form .login-remember {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 24px;
    }

    .loading-login-form .login-remember input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #ffffff;
      cursor: pointer;
    }

    .loading-login-form .login-remember label {
      font-family: "Geist", -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
    }

    .login-submit-btn {
      width: 100%;
      padding: 14px 24px;
      font-family: "Geist", -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 15px;
      font-weight: 600;
      color: #000000;
      background: #ffffff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    /* Submit Button - DISABLED (grau bis Input vorhanden) */
    .login-submit-btn:disabled {
      background: rgba(255, 255, 255, 0.3);
      color: rgba(0, 0, 0, 0.4);
      cursor: not-allowed;
      transform: none;
    }

    /* Submit Button - Enabled hover/active */
    .login-submit-btn:not(:disabled):hover {
      background: rgba(255, 255, 255, 0.9);
      transform: translateY(-1px);
    }

    .login-submit-btn:not(:disabled):active {
      transform: translateY(0);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOADING SCREEN RESPONSIVE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    @media (max-width: 768px) {
      .loading-logo {
        bottom: 100px;
        left: 24px;
        font-size: 14px;
      }

      .loading-progress-container {
        bottom: 32px;
        left: 24px;
        right: 24px;
      }

      .loading-login-form {
        margin: 24px;
        padding: 32px 24px;
      }

      .loading-login-form h2 {
        font-size: 24px;
      }
    }

    /* Keep spin animation for other loaders */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Altes Login Modal deaktivieren - wird durch LoadingScreen ersetzt */
    #loginBackdrop {
      display: none !important;
    }

    /* ========================================
       HEADER SECTION
       ======================================== */

    .header-section {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 0 24px;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      border-bottom: none;
    }

    [data-theme="dark"] .header-section {
      background: #1c1c1e;
      border-bottom: none;
    }

    .header-title {
      color: rgba(0, 0, 0, 0.9);
      font-size: 15px;
      margin: 0;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    [data-theme="dark"] .header-title {
      color: rgba(255, 255, 255, 0.9);
    }

    .header-title:hover {
      color: rgba(0, 0, 0, 0.6);
    }

    [data-theme="dark"] .header-title:hover {
      color: rgba(255, 255, 255, 0.6);
    }

    .nav-icons {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .icon-button {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    [data-theme="dark"] .icon-button {
      background: #1c1c1e;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .icon-button:hover {
      background: #f5f5f7;
      border-color: rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] .icon-button:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .icon-button svg {
      width: 18px;
      height: 18px;
      color: rgba(0, 0, 0, 0.6);
    }

    [data-theme="dark"] .icon-button svg {
      color: rgba(255, 255, 255, 0.6);
    }

    /* Feedback Button */
    .feedback-button {
      height: 35px;
      padding: 0 12px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      font-size: 14px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.9);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    [data-theme="dark"] .feedback-button {
      background: #1c1c1e;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.9);
    }

    .feedback-button:hover {
      background: rgba(0, 0, 0, 0.04);
      border-color: rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] .feedback-button:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
    }

    /* Profile Dropdown */
    .profile-dropdown {
      position: fixed;
      top: 72px;
      right: 24px;
      width: 256px;
      max-height: 449px;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.02),
                  0px 2px 4px rgba(0, 0, 0, 0.02),
                  0px 8px 16px -4px rgba(0, 0, 0, 0.08),
                  0px 24px 32px -8px rgba(0, 0, 0, 0.12);
      padding: 8px;
      display: none;
      flex-direction: column;
      z-index: 1001;
      overflow-y: auto;
      box-sizing: border-box;
    }

    [data-theme="dark"] .profile-dropdown {
      background: #1c1c1e;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .profile-dropdown.active {
      display: flex;
    }

    .profile-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      margin: -8px -8px 4px -8px;
      width: calc(100% + 16px);
      box-sizing: border-box;
    }

    [data-theme="dark"] .profile-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .profile-username {
      font-size: 14px;
      font-weight: 600;
      color: rgba(0, 0, 0, 0.9);
      margin-bottom: 4px;
      text-align: left;
    }

    [data-theme="dark"] .profile-username {
      color: rgba(255, 255, 255, 0.9);
    }

    .profile-email {
      font-size: 13px;
      color: rgba(0, 0, 0, 0.5);
      text-align: left;
    }

    [data-theme="dark"] .profile-email {
      color: rgba(255, 255, 255, 0.5);
    }

    .dropdown-item {
      padding: 0 12px;
      height: 40px;
      width: 100%;
      font-size: 14px;
      font-weight: 350;
      color: rgba(0, 0, 0, 0.5);
      cursor: pointer;
      border-radius: 6px;
      transition: color 0.15s ease, background-color 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-sizing: border-box;
    }

    [data-theme="dark"] .dropdown-item {
      color: rgba(255, 255, 255, 0.5);
    }

    .dropdown-item:hover {
      background: rgba(0, 0, 0, 0.04);
      color: rgba(0, 0, 0, 0.9);
    }

    [data-theme="dark"] .dropdown-item:hover {
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.9);
    }

    .dropdown-item svg {
      width: 16px;
      height: 16px;
      color: rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .dropdown-item svg {
      color: rgba(255, 255, 255, 0.5);
    }

    .dropdown-separator {
      height: 1px;
      background: rgba(0, 0, 0, 0.1);
      margin: 8px -8px;
      width: calc(100% + 16px);
    }

    [data-theme="dark"] .dropdown-separator {
      background: rgba(255, 255, 255, 0.1);
    }

    .keyboard-shortcut {
      display: flex;
      gap: 4px;
      align-items: center;
      font-size: 12px;
      color: rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .keyboard-shortcut {
      color: rgba(255, 255, 255, 0.5);
    }

    .theme-options {
      display: flex;
      gap: 4px;
    }

    .theme-btn {
      padding: 4px 8px;
      min-width: 28px;
      height: 24px;
      border-radius: 6px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.15s ease, border-color 0.15s ease;
      font-size: 12px;
      color: rgba(0, 0, 0, 0.5);
      font-weight: 400;
    }

    [data-theme="dark"] .theme-btn {
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: #1c1c1e;
      color: rgba(255, 255, 255, 0.5);
    }

    .theme-btn:hover {
      background: rgba(0, 0, 0, 0.04);
      border-color: rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] .theme-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .theme-btn.active {
      background: rgba(0, 0, 0, 0.08);
      border-color: rgba(0, 0, 0, 0.15);
      color: rgba(0, 0, 0, 0.9);
    }

    [data-theme="dark"] .theme-btn.active {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.9);
    }

    .theme-btn svg {
      width: 14px;
      height: 14px;
      color: currentColor;
    }

    .upgrade-btn {
      margin-top: 8px;
      width: 100%;
      height: 32px;
      padding: 0 12px;
      background: rgba(0, 0, 0, 0.9);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    [data-theme="dark"] .upgrade-btn {
      background: rgba(255, 255, 255, 0.9);
      color: #1c1c1e;
    }

    .upgrade-btn:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    [data-theme="dark"] .upgrade-btn:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    .upgrade-btn svg {
      color: currentColor;
    }

    /* Notifications Dropdown */
    .notifications-dropdown {
      position: fixed;
      top: 72px;
      right: 71px;
      width: 400px;
      height: 500px;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.02),
                  0px 2px 4px rgba(0, 0, 0, 0.02),
                  0px 8px 16px -4px rgba(0, 0, 0, 0.08),
                  0px 24px 32px -8px rgba(0, 0, 0, 0.12);
      display: none;
      flex-direction: column;
      z-index: 1001;
    }

    [data-theme="dark"] .notifications-dropdown {
      background: #1c1c1e;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .notifications-dropdown.active {
      display: flex;
    }

    .notifications-tabs {
      display: flex;
      gap: 24px;
      padding: 16px 20px 0 20px;
      border-bottom: 2px solid rgba(0, 0, 0, 0.1);
      position: relative;
    }

    [data-theme="dark"] .notifications-tabs {
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .notification-tab {
      font-size: 14px;
      font-weight: 350;
      color: rgba(0, 0, 0, 0.5);
      cursor: pointer;
      padding-bottom: 16px;
      position: relative;
      transition: color 0.2s ease;
    }

    [data-theme="dark"] .notification-tab {
      color: rgba(255, 255, 255, 0.5);
    }

    .notification-tab:hover {
      color: rgba(0, 0, 0, 0.9);
    }

    [data-theme="dark"] .notification-tab:hover {
      color: rgba(255, 255, 255, 0.9);
    }

    .notification-tab.active {
      color: rgba(0, 0, 0, 0.9);
    }

    [data-theme="dark"] .notification-tab.active {
      color: rgba(255, 255, 255, 0.9);
    }

    .notification-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1;
    }

    [data-theme="dark"] .notification-tab.active::after {
      background: rgba(255, 255, 255, 0.9);
    }

    .notifications-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .empty-icon {
      width: 48px;
      height: 48px;
      color: rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .empty-icon {
      color: rgba(255, 255, 255, 0.5);
    }

    .empty-text {
      font-size: 14px;
      color: rgba(0, 0, 0, 0.5);
      margin: 0;
    }

    [data-theme="dark"] .empty-text {
      color: rgba(255, 255, 255, 0.5);
    }

    /* Feedback Dropdown */
    .feedback-dropdown {
      position: fixed;
      top: 72px;
      right: 118px;
      width: 340px;
      height: 260px;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.02),
                  0px 2px 4px rgba(0, 0, 0, 0.02),
                  0px 8px 16px -4px rgba(0, 0, 0, 0.08),
                  0px 24px 32px -8px rgba(0, 0, 0, 0.12);
      padding: 16px;
      display: none;
      flex-direction: column;
      gap: 12px;
      z-index: 1001;
    }

    [data-theme="dark"] .feedback-dropdown {
      background: #1c1c1e;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .feedback-dropdown.active {
      display: flex;
    }

    .feedback-select {
      width: 100%;
      height: 44px;
      padding: 0 12px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: #ffffff;
      font-size: 14px;
      color: rgba(0, 0, 0, 0.9);
      cursor: pointer;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2386868b' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    [data-theme="dark"] .feedback-select {
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: #1c1c1e;
      color: rgba(255, 255, 255, 0.9);
    }

    .feedback-textarea {
      width: 100%;
      flex: 1;
      padding: 12px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: #ffffff;
      font-size: 14px;
      color: rgba(0, 0, 0, 0.9);
      resize: none;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100px;
    }

    [data-theme="dark"] .feedback-textarea {
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: #1c1c1e;
      color: rgba(255, 255, 255, 0.9);
    }

    .feedback-textarea::placeholder {
      color: rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .feedback-textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .feedback-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .feedback-emojis {
      display: flex;
      gap: 4px;
    }

    .emoji-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
      border-radius: 6px;
      transition: background-color 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .emoji-btn:hover {
      background: rgba(0, 0, 0, 0.04);
    }

    [data-theme="dark"] .emoji-btn:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .feedback-send-btn {
      height: 36px;
      padding: 0 20px;
      background: rgba(0, 0, 0, 0.9);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.15s ease;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    [data-theme="dark"] .feedback-send-btn {
      background: rgba(255, 255, 255, 0.9);
      color: #1c1c1e;
    }

    .feedback-send-btn:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    [data-theme="dark"] .feedback-send-btn:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    /* ========================================
       NAVBAR - CLEAN & SIMPLE
       ======================================== */

    .navbar-container {
      display: flex;
      gap: 0; /* â­ Kein Gap */
      padding: 0 24px; /* Padding fÃ¼r Alignment mit Header */
      background: #ffffff; /* â­ WEIÃŸ */
      opacity: 1; /* â­ Komplett undurchsichtig */
      border-radius: 0; /* â­ KEINE rounded corners */
      backdrop-filter: none; /* â­ KEIN Blur */
      position: fixed; /* â­ Fixed unter Header */
      top: 64px; /* â­ Unter dem Header */
      left: 0;
      right: 0;
      z-index: 999; /* Unter dem Header */
      height: 46px;
      align-items: center;
      border-bottom: 1px solid var(--border-color); /* Subtile Trennlinie */
    }

    [data-theme="dark"] .navbar-container {
      background: #2c2c2e; /* Match header navbar color */
      opacity: 1;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-link {
      padding: 12px 20px; /* â­ Mehr Padding fÃ¼r bessere KlickflÃ¤che */
      border-radius: 0; /* â­ KEINE rounded corners */
      text-decoration: none;
      color: rgba(0, 0, 0, 0.5); /* â­ Heller fÃ¼r inactive */
      font-size: 14px;
      font-weight: 400; /* â­ Normal weight */
      transition: color 0.2s ease;
      cursor: pointer;
      position: relative;
      z-index: 1;
      white-space: nowrap;
      background: transparent; /* â­ KEIN Background */
      border: none; /* â­ KEIN Border */
    }

    [data-theme="dark"] .nav-link {
      color: rgba(255, 255, 255, 0.5);
    }

    .nav-link:hover {
      color: rgba(0, 0, 0, 0.7); /* â­ Nur Text dunkler */
    }

    [data-theme="dark"] .nav-link:hover {
      color: rgba(255, 255, 255, 0.7);
    }

    .nav-link.active {
      color: rgba(0, 0, 0, 0.9); /* â­ Text ganz dunkel */
      font-weight: 500; /* â­ Medium weight */
      background: transparent; /* â­ KEIN Background */
      border: none; /* â­ KEIN Border */
    }

    [data-theme="dark"] .nav-link.active {
      color: rgba(255, 255, 255, 0.9);
      background: transparent;
    }

    /* ========================================
       HOVER BACKGROUND (Grauer Container)
       ======================================== */

    .hover-background {
      position: absolute;
      height: calc(100% - 16px);
      background: rgba(0, 0, 0, 0.06);
      border-radius: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      opacity: 0;
      top: 8px;
      z-index: 0;
    }

    [data-theme="dark"] .hover-background {
      background: rgba(255, 255, 255, 0.08);
    }

    /* ========================================
       ACTIVE INDIKATOR-LINIE (Am Bottom)
       ======================================== */

    .active-indicator {
      position: absolute;
      bottom: -1px;
      height: 2px;
      background: rgba(0, 0, 0, 0.9);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 2;
    }

    [data-theme="dark"] .active-indicator {
      background: rgba(255, 255, 255, 0.9);
    }

    /* ========================================
       MOBILE FOOTER NAVIGATION
       ======================================== */

    .mobile-footer-nav {
      display: none !important;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0, 0, 0, 0.08);
      padding-top: 12px;
      padding-bottom: max(24px, env(safe-area-inset-bottom, 24px));
      padding-left: 16px;
      padding-right: 16px;
      justify-content: space-around;
      align-items: flex-start;
      z-index: 99999;
    }

    /* Mobile nav hidden during loading/login */
    body.loading .mobile-footer-nav,
    body.logged-out .mobile-footer-nav,
    .login-overlay:not([style*="display: none"]) ~ .mobile-footer-nav,
    .loading-overlay:not(.hidden) ~ .mobile-footer-nav {
      display: none !important;
    }

    [data-theme="dark"] .mobile-footer-nav {
      background: rgba(18, 18, 18, 0.98);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
    }

    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 12px;
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .mobile-nav-item:active {
      transform: scale(0.95);
      background: rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] .mobile-nav-item:active {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Active state - kein Hintergrund mehr, nur Icon-Wechsel */
    .mobile-nav-item.active {
      background: transparent;
    }

    [data-theme="dark"] .mobile-nav-item.active {
      background: transparent;
    }

    .mobile-nav-icon {
      width: 26px;
      height: 26px;
      stroke: rgba(0, 0, 0, 0.4);
      color: rgba(0, 0, 0, 0.4);
      transition: all 0.2s ease;
    }

    [data-theme="dark"] .mobile-nav-icon {
      stroke: rgba(255, 255, 255, 0.5);
      color: rgba(255, 255, 255, 0.5);
    }

    .mobile-nav-item.active .mobile-nav-icon {
      stroke: #1d1d1f;
      color: #1d1d1f;
    }

    [data-theme="dark"] .mobile-nav-item.active .mobile-nav-icon {
      stroke: #f5f5f7;
      color: #f5f5f7;
    }

    /* Fill/Outline Icon Toggle */
    .mobile-nav-item .nav-icon-fill { display: none; }
    .mobile-nav-item .nav-icon-outline { display: block; }
    .mobile-nav-item.active .nav-icon-fill { display: block; }
    .mobile-nav-item.active .nav-icon-outline { display: none; }

    /* Mobile Nav Avatar fÃ¼r Dashboard */
    .mobile-nav-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      overflow: hidden;
      background: linear-gradient(135deg, #8e8e93, #636366);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .mobile-nav-avatar-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .mobile-nav-avatar-initials {
      font-size: 13px;
      font-weight: 600;
      color: white;
    }

    /* Aktiver Dashboard: KEIN Ring um Avatar */
    .mobile-nav-item.active .mobile-nav-avatar {
      box-shadow: none;
    }

    [data-theme="dark"] .mobile-nav-item.active .mobile-nav-avatar {
      box-shadow: none;
    }

    [data-theme="dark"] .mobile-nav-item.active .mobile-nav-icon {
      stroke: #f5f5f7;
      color: #f5f5f7;
    }

    .mobile-nav-label {
      font-size: 11px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.5);
      transition: all 0.2s ease;
    }

    [data-theme="dark"] .mobile-nav-label {
      color: rgba(255, 255, 255, 0.5);
    }

    .mobile-nav-item.active .mobile-nav-label {
      color: rgba(0, 0, 0, 0.9);
      font-weight: 600;
    }

    [data-theme="dark"] .mobile-nav-item.active .mobile-nav-label {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
    }

    /* ========================================
       ACCOUNT SETTINGS PAGE
       ======================================== */

    /* Settings View Container */
    .settings-view {
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 110px);
      background: var(--bg-secondary);
    }

    /* Account Settings Top Section */
    .account-settings-header {
      background: var(--bg-secondary);
      padding: 40px 40px 32px 40px;
      border-bottom: 1px solid var(--border-color);
    }

    .account-settings-title {
      font-size: 32px;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0;
    }

    /* Settings Content Wrapper (Sidebar + Content) */
    .settings-content-wrapper {
      display: flex;
      flex: 1;
      background: var(--bg-secondary);
    }

    /* ========================================
       SETTINGS SIDEBAR
       ======================================== */

    .settings-sidebar {
      width: 280px;
      background: transparent;
      padding: 24px 0;
      border-right: 1px solid var(--border-color);
    }

    .search-container {
      padding: 0 24px 24px 24px;
    }

    .search-input {
      width: 100%;
      height: 36px;
      padding: 0 12px 0 36px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg);
      font-size: 13px;
      color: var(--text-primary);
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='11' cy='11' r='8' stroke='%2386868b' stroke-width='2'/%3E%3Cpath d='M21 21L16.65 16.65' stroke='%2386868b' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      background-size: 16px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--input-focus-border);
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    .sidebar-nav {
      list-style: none;
      padding: 0 12px;
      margin: 0;
    }

    .nav-item {
      padding: 8px 12px;
      font-size: 14px;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 6px;
      margin-bottom: 2px;
      transition: background-color 0.15s ease, color 0.15s ease;
    }

    .nav-item:hover {
      background: var(--hover-bg-light);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--hover-bg);
      color: var(--text-primary);
      font-weight: 400;
    }

    /* ========================================
       SETTINGS CONTENT AREA
       ======================================== */

    .settings-content {
      flex: 1;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
    }

    .settings-main-content {
      flex: 1;
      overflow-y: auto;
    }

    /* Tab Content */
    .tab-content {
      display: none;
      padding: 40px;
    }

    .tab-content.active {
      display: block;
    }

    /* ========================================
       SETTINGS CARDS
       ======================================== */

    .settings-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .card-section {
      padding: 24px 0;
    }

    .card-section:first-child {
      padding-top: 0;
    }

    .card-section:not(:last-child) {
      border-bottom: 1px solid var(--border-color);
    }

    .section-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .section-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 16px;
    }

    /* ========================================
       AVATAR SECTION
       ======================================== */

    .avatar-container {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-top: 16px;
    }

    .avatar-display {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      flex-shrink: 0;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .avatar-display:hover {
      transform: scale(1.05);
    }

    .avatar-display img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .avatar-actions {
      display: flex;
      gap: 12px;
    }

    /* ========================================
       BUTTONS
       ======================================== */

    .btn {
      height: 36px;
      padding: 0 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: background-color 0.15s ease, border-color 0.15s ease;
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .btn-primary {
      background: var(--button-primary-bg);
      color: var(--button-primary-text);
    }

    .btn-primary:hover {
      background: var(--button-primary-hover);
    }

    .btn-secondary {
      background: var(--button-secondary-bg);
      color: var(--button-secondary-text);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--button-secondary-hover);
      border-color: var(--border-color-strong);
    }

    .btn-danger {
      background: transparent;
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
    }

    /* ========================================
       USER INFO GRID
       ======================================== */

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 16px;
    }

    .info-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .field-value {
      font-size: 14px;
      color: var(--text-primary);
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    /* ========================================
       INPUT FIELDS
       ======================================== */

    .input-group {
      margin-bottom: 16px;
    }

    .input-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .input-field {
      width: 100%;
      height: 44px;
      padding: 0 12px;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      background: var(--input-bg);
      font-size: 14px;
      color: var(--text-primary);
      font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      transition: border-color 0.15s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--input-focus-border);
    }

    .input-field::placeholder {
      color: var(--text-tertiary);
    }

    .input-helper {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 6px;
    }

    .save-container {
      display: flex;
      justify-content: flex-end;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      margin-top: 16px;
    }

    /* Hidden File Input */
    #avatarUpload {
      display: none;
    }

    /* ========================================
       ACTIVITY TAB
       ======================================== */

    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .activity-item {
      padding: 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      display: flex;
      gap: 12px;
    }

    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--hover-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .activity-icon svg {
      width: 20px;
      height: 20px;
      color: var(--text-secondary);
    }

    .activity-details {
      flex: 1;
    }

    .activity-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .activity-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .activity-time {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    /* ========================================
       MOBILE-ONLY ELEMENTS - Hidden on Desktop
       ======================================== */
    .mobile-profile-panel,
    .mobile-profile-overlay,
    .mobile-profile-trigger,
    .mobile-content-tabs,
    .mobile-tabs-wrapper,
    .mobile-slide-indicator,
    .mobile-slider-indicator,
    .mobile-calendar-view,
    .mobile-dienstplan-view,
    .mobile-cal-modal {
      display: none !important;
    }

    /* ========================================
       MOBILE RESPONSIVE - ACCOUNT SETTINGS
       ======================================== */

    @media (max-width: 768px) {
      .account-settings-header {
        padding: 20px 16px;
      }

      .account-settings-title {
        font-size: 24px;
      }

      .settings-content-wrapper {
        flex-direction: column;
      }

      .settings-sidebar {
        width: 100%;
        padding: 16px 0;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }

      .search-container {
        padding: 0 16px 16px 16px;
      }

      .sidebar-nav {
        padding: 0 16px;
        display: flex;
        overflow-x: auto;
        gap: 8px;
      }

      .nav-item {
        white-space: nowrap;
        margin-bottom: 0;
      }

      .tab-content {
        padding: 20px 16px;
      }

      .info-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .avatar-container {
        flex-direction: column;
        align-items: flex-start;
      }

      .avatar-actions {
        width: 100%;
      }

      .avatar-actions button {
        flex: 1;
      }
    }

    /* ========================================
       Mobile Calendar Elements (Hidden on Desktop)
       ======================================== */
    .mobile-week-header,
    .mobile-calendar-view {
      display: none;
    }

    /* Hide mobile notification panel on desktop */
    .mobile-notification-panel,
    #mobileNotificationPanel {
      display: none;
    }

    /* ========================================
       RESPONSIVE
       ======================================== */

    @media (max-width: 768px) {
      /* Fix overflow issue - prevent horizontal scrolling and iOS overscroll */
      html, body {
        overflow-x: hidden !important;
        max-width: 100vw;
        overscroll-behavior: none; /* Verhindert iOS rubber-banding */
      }

      /* Header adjustments for mobile */
      .header-section {
        padding: 0 16px;
        height: 56px;
      }

      .header-title {
        font-size: 14px;
      }

      /* Feedback Button auf Mobile verstecken */
      .feedback-button {
        display: none;
      }

      /* Hide welcome message on mobile */
      .dashboard-welcome,
      #dashboardWelcome {
        display: none !important;
      }

      .icon-button {
        width: 32px;
        height: 32px;
      }

      .icon-button svg {
        width: 16px;
        height: 16px;
      }

      /* Profile Button nur auf Desktop */
      .icon-button.profile {
        display: none;
      }

      /* Navbar unter kleineren Header */
      .navbar-container {
        display: none !important;
        top: 56px;
        height: 42px;
      }

      /* Section adjustments for mobile */
      section {
        margin-top: 56px; /* Nur Header auf Mobile */
        margin-bottom: 72px; /* Platz fÃ¼r Footer Nav */
        min-height: calc(100vh - 128px);
        overflow-x: hidden;
      }

      /* Mobile footer nav - shown via JS after login */
      .mobile-footer-nav.visible {
        display: flex !important;
      }

      /* Raum fÃ¼r Mobile Footer */
      body.logged-in {
        padding-bottom: 80px;
      }

      /* Schwarzes Brett Mobile Styles */
      .brett-item {
        padding: 12px 0 !important;
      }

      .brett-item img {
        width: 36px !important;
        height: 36px !important;
      }

      .message-menu-btn {
        padding: 4px !important;
      }

      .message-menu-dropdown {
        min-width: 100px !important;
      }

      .message-menu-dropdown button {
        padding: 8px 12px !important;
        font-size: 13px !important;
      }

      /* Dropdowns Anpassung fÃ¼r Mobile */
      .profile-dropdown {
        top: 60px;
        right: 16px;
        width: calc(100vw - 32px);
        max-width: 320px;
      }

      .notifications-dropdown {
        top: 60px;
        right: 16px;
        left: 16px;
        width: auto;
        height: 400px;
      }

      .feedback-dropdown {
        top: 60px;
        right: 16px;
        width: calc(100vw - 32px);
      }

      /* ========================================
         MOBILE TAB SWITCHER - Pinned Events / Schwarzes Brett
         ======================================== */

      .mobile-content-tabs {
        display: flex !important;
        background: var(--card-bg, rgba(255,255,255,0.8));
        border-radius: 12px;
        padding: 4px;
        margin-bottom: 12px;
        gap: 4px;
      }

      .mobile-content-tab {
        flex: 1;
        padding: 10px 16px;
        border: none;
        background: transparent;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        color: var(--macos-text-secondary, #86868b);
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: inherit;
      }

      .mobile-content-tab.active {
        background: var(--accent, #0071e3);
        color: white;
      }

      .mobile-content-tab:not(.active):hover {
        background: rgba(0,0,0,0.05);
      }

      [data-theme="dark"] .mobile-content-tab:not(.active):hover {
        background: rgba(255,255,255,0.1);
      }

      /* Hide section titles on mobile - replaced by tabs */
      .pinned-events-wrapper .container-section-title,
      .schwarzes-brett-wrapper .container-section-title {
        display: none !important;
      }

      /* Mobile Content Container */
      .mobile-content-container {
        position: relative;
        min-height: 200px;
      }

      .mobile-content-pane {
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      .mobile-content-pane.active {
        display: block;
        opacity: 1;
      }

      /* Hide original wrappers on mobile - content shown in tab container */
      .pinned-events-wrapper,
      .schwarzes-brett-wrapper {
        display: none !important;
      }

      /* Hide mobile tabs wrapper too - showing profile instead */
      .mobile-tabs-wrapper {
        display: none !important;
      }

      /* Hide desktop welcome on mobile */
      .dashboard-welcome {
        display: none !important;
      }

      /* ========================================
         MOBILE DASHBOARD PROFILE
         ======================================== */
      .mobile-dashboard-profile {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 32px 16px 24px;
        background: white;
        margin: 0;
        border-radius: 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }

      [data-theme="dark"] .mobile-dashboard-profile {
        background: #1c1c1e;
      }

      .mobile-profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        overflow: hidden;
        background: #e5e5ea;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        /* Kein box-shadow, kein gradient */
      }

      .mobile-profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .mobile-profile-initials {
        font-size: 40px;
        font-weight: 600;
        color: white;
      }

      .mobile-profile-name {
        font-size: 24px;
        font-weight: 600;
        color: var(--macos-text-primary, #1d1d1f);
        margin: 0 0 8px 0;
        text-align: center;
      }

      [data-theme="dark"] .mobile-profile-name {
        color: #f5f5f7;
      }

      .mobile-profile-role {
        display: inline-block;
        padding: 8px 24px;
        background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
        color: white;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        text-transform: capitalize;
      }

      /* ========================================
         MOBILE PROFILE SWIPE CONTAINER
         ======================================== */
      .mobile-profile-swipe-container {
        width: 100%;
        overflow: hidden;
        margin-top: 8px;
      }

      .mobile-profile-swipe-track {
        display: flex;
        transition: transform 0.3s ease;
        width: 200%;
      }

      .mobile-profile-slide {
        width: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 8px 0;
      }

      .mobile-profile-email {
        font-size: 14px;
        color: var(--macos-text-secondary, #86868b);
      }

      [data-theme="dark"] .mobile-profile-email {
        color: #98989d;
      }

      .mobile-profile-indicators {
        display: flex;
        justify-content: center;
        gap: 6px;
        margin-top: 12px;
      }

      .mobile-profile-indicator {
        width: 20px;
        height: 3px;
        background: var(--macos-fill-tertiary, #e5e5ea);
        border-radius: 2px;
        transition: background 0.3s ease;
      }

      .mobile-profile-indicator.active {
        background: var(--macos-text-primary, #1d1d1f);
      }

      [data-theme="dark"] .mobile-profile-indicator {
        background: #3a3a3c;
      }

      [data-theme="dark"] .mobile-profile-indicator.active {
        background: #f5f5f7;
      }

      /* ========================================
         MOBILE ERSCHEINUNGSBILD SECTION
         ======================================== */
      .mobile-appearance-section {
        padding: 0 1vw;
        margin-top: 24px;
      }

      .mobile-section-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--macos-text-secondary, #86868b);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
        padding-left: 1vw;
        padding-right: 1vw;
        margin-left: 0;
        margin-right: 0;
      }

      .mobile-appearance-toggle {
        display: flex;
        background: var(--macos-fill-quaternary, #f5f5f7);
        border-radius: 12px;
        padding: 4px;
        gap: 4px;
      }

      .mobile-theme-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .mobile-theme-btn svg {
        width: 24px;
        height: 24px;
      }

      /* ===== LIGHT MODE (default) ===== */
      /* Sonnen-Button AKTIV = greyed out */
      #mobileLightModeBtn.active {
        background: transparent;
        color: var(--macos-text-tertiary, #c7c7cc);
        cursor: default;
      }

      /* Mond-Button INAKTIV = dunkelgrau mit weiÃŸem Icon */
      #mobileDarkModeBtn:not(.active) {
        background: #3a3a3c;
        color: white;
      }

      /* ===== DARK MODE ===== */
      [data-theme="dark"] .mobile-appearance-toggle {
        background: rgba(255,255,255,0.1);
      }

      /* Sonnen-Button INAKTIV = weiÃŸ mit grauem Icon */
      [data-theme="dark"] #mobileLightModeBtn:not(.active) {
        background: white;
        color: #86868b;
      }

      /* Mond-Button AKTIV = greyed out */
      [data-theme="dark"] #mobileDarkModeBtn.active {
        background: transparent;
        color: rgba(255,255,255,0.3);
        cursor: default;
      }

      /* ========================================
         MOBILE LOGOUT BUTTON (inline in profile)
         ======================================== */
      .mobile-logout-btn-inline {
        margin-top: 24px;
        padding: 10px 32px;
        background: transparent;
        border: none;
        color: #ff3b30;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
      }

      /* ========================================
         MOBILE PROJECTS ACCORDION
         ======================================== */
      .todo-projects-list {
        width: 98vw;
        margin-left: 1vw;
        margin-right: 1vw;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0;
      }

      .todo-project-card {
        width: 100%;
        background: white;
        border-radius: 0 !important;
        padding: 16px;
        margin: 0;
        border: none !important;
        border-bottom: 1px solid rgba(0,0,0,0.08) !important;
        cursor: pointer;
        box-shadow: none !important;
        box-sizing: border-box;
      }

      .todo-project-card:first-child {
        border-top: 1px solid rgba(0,0,0,0.08) !important;
      }

      .todo-project-card.selected {
        background: white !important;
        border-color: transparent !important;
      }

      .todo-project-card.selected .todo-project-title,
      .todo-project-card.selected .todo-project-percent {
        color: var(--macos-text-primary, #1d1d1f) !important;
      }

      /* Accordion Arrow */
      .todo-project-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .mobile-project-arrow {
        width: 20px;
        height: 20px;
        color: var(--macos-text-secondary, #86868b);
        transition: transform 0.3s ease;
        flex-shrink: 0;
        margin-left: 12px;
      }

      .todo-project-card.expanded .mobile-project-arrow {
        transform: rotate(180deg);
      }

      /* Tasks Accordion Content */
      .mobile-project-tasks {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        margin-top: 0;
      }

      .todo-project-card.expanded .mobile-project-tasks {
        max-height: 500px;
        margin-top: 12px;
      }

      .mobile-task-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 0;
        border-top: 1px solid var(--macos-stroke-secondary, rgba(0,0,0,0.04));
      }

      .mobile-task-checkbox {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid var(--macos-text-tertiary, #86868b);
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
      }

      .mobile-task-checkbox.completed {
        background: var(--macos-accent-green, #34c759);
        border-color: var(--macos-accent-green, #34c759);
      }

      .mobile-task-checkbox.completed::after {
        content: 'âœ“';
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .mobile-task-title {
        font-size: 14px;
        color: var(--macos-text-primary, #1d1d1f);
        flex: 1;
      }

      .mobile-task-item.completed .mobile-task-title {
        text-decoration: line-through;
        color: var(--macos-text-tertiary, #86868b);
      }

      /* Hide Edit Button and Tasks Right Panel on Mobile */
      .todo-edit-btn,
      .todo-tasks-right {
        display: none !important;
      }

      .todo-project-footer {
        display: none !important;
      }

      /* Add Task Button in Accordion */
      .mobile-add-task-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 12px;
        margin-top: 8px;
        background: transparent;
        border: 1px dashed var(--macos-stroke-primary, rgba(0,0,0,0.15));
        border-radius: 8px;
        color: var(--macos-text-secondary, #86868b);
        font-size: 14px;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .mobile-add-task-btn:active {
        background: var(--macos-fill-quaternary, rgba(0,0,0,0.03));
      }

      .mobile-add-task-btn svg {
        flex-shrink: 0;
      }

      /* Task Modal auf Mobile - ZENTRIERT */
      .todo-task-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10001;
        display: none;
        align-items: center !important;
        justify-content: center !important;
        padding: 20px;
      }

      .todo-task-modal.active {
        display: flex !important;
      }

      .todo-task-modal-content {
        width: 100% !important;
        max-width: 340px !important;
        background: white;
        border-radius: 16px !important;
        padding: 20px !important;
        margin: 0 !important;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      }

      [data-theme="dark"] .todo-task-modal-content {
        background: #2c2c2e;
      }

      /* Mobile Tab Content Wrapper - hidden, profile replaces it */
      .mobile-tabs-wrapper.legacy {
        display: block !important;
        margin-bottom: 16px;
      }

      /* ========================================
         MOBILE SLIDER STYLES
         ======================================== */

      .mobile-slider-container {
        position: relative;
        overflow: hidden;
      }

      .mobile-slider-item {
        opacity: 0;
        transition: opacity 0.4s ease;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        pointer-events: none;
      }

      .mobile-slider-item.active {
        opacity: 1;
        position: relative;
        pointer-events: auto;
      }

      .mobile-slider-indicator {
        display: block !important;
        text-align: center;
        padding: 12px 0 8px;
        font-size: 12px;
        font-weight: 500;
        color: var(--macos-text-secondary, #86868b);
      }

      .mobile-slider-indicator.paused::after {
        content: ' â¸';
      }

      /* ========================================
         MOBILE PROFILE PANEL (Instagram DM Style)
         ======================================== */

      .mobile-profile-overlay {
        display: block !important;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        z-index: 9998;
      }

      .mobile-profile-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .mobile-profile-panel {
        display: flex !important;
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: 85vw;
        max-width: 320px;
        background: var(--card-bg, #ffffff);
        transform: translateX(100%);
        transition: transform 0.3s ease-out;
        z-index: 9999;
        flex-direction: column;
        box-shadow: -4px 0 20px rgba(0,0,0,0.15);
      }

      .mobile-profile-panel.active {
        transform: translateX(0);
      }

      [data-theme="dark"] .mobile-profile-panel {
        background: var(--card-bg, #1c1c1e);
        box-shadow: -4px 0 20px rgba(0,0,0,0.4);
      }

      /* Mobile Notification Panel */
      .mobile-notification-panel {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--macos-bg, #f5f5f7);
        z-index: 10001;
        flex-direction: column;
      }

      .mobile-notification-panel.active {
        display: flex;
      }

      .mobile-panel-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        padding-top: max(16px, env(safe-area-inset-top));
        border-bottom: 1px solid var(--macos-stroke-primary, rgba(0,0,0,0.1));
        background: var(--macos-nav-bg, #ffffff);
      }

      .mobile-panel-back {
        display: flex;
        align-items: center;
        gap: 4px;
        background: none;
        border: none;
        color: var(--macos-accent-blue, #007AFF);
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        padding: 8px 0;
      }

      .mobile-panel-title {
        font-size: 17px;
        font-weight: 600;
        color: var(--macos-text-primary, #1d1d1f);
      }

      .mobile-panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        padding-bottom: max(16px, env(safe-area-inset-bottom));
      }

      /* ========================================
         MOBILE INBOX BUTTON & PANEL
         ======================================== */

      /* Hide desktop notification on mobile */
      .desktop-only-notification {
        display: none !important;
      }

      .mobile-inbox-btn {
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        cursor: pointer;
        color: var(--macos-text-primary, #1d1d1f);
        padding: 0;
      }

      .mobile-inbox-btn svg {
        width: 24px;
        height: 24px;
      }

      .mobile-inbox-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--macos-bg, #f5f5f7);
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      }

      .mobile-inbox-panel.active {
        transform: translateX(0);
      }

      .mobile-inbox-header {
        display: flex;
        align-items: center;
        padding: 16px;
        padding-top: max(16px, env(safe-area-inset-top));
        background: white;
        border-bottom: 1px solid var(--macos-stroke-primary, rgba(0,0,0,0.08));
      }

      .mobile-inbox-back {
        display: flex;
        align-items: center;
        gap: 4px;
        background: transparent;
        border: none;
        color: var(--macos-accent-blue, #007aff);
        font-size: 16px;
        cursor: pointer;
        padding: 0;
        font-family: inherit;
      }

      .mobile-inbox-title {
        flex: 1;
        text-align: center;
        font-size: 17px;
        font-weight: 600;
        margin: 0;
        margin-right: 60px;
      }

      .mobile-inbox-content {
        padding: 16px;
        overflow-y: auto;
        height: calc(100% - 60px);
      }

      .mobile-inbox-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--macos-text-tertiary, #c7c7cc);
        gap: 16px;
      }

      .mobile-inbox-empty p {
        font-size: 16px;
        margin: 0;
      }

      [data-theme="dark"] .mobile-inbox-panel {
        background: var(--macos-bg, #1c1c1e);
      }

      [data-theme="dark"] .mobile-inbox-header {
        background: var(--macos-elevated, #2c2c2e);
      }

      [data-theme="dark"] .mobile-inbox-btn {
        color: #f5f5f7;
      }

      .mobile-profile-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color, rgba(0,0,0,0.1));
      }

      .mobile-profile-close {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(0,0,0,0.05);
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--macos-text-primary, #1d1d1f);
        transition: background 0.2s ease;
      }

      .mobile-profile-close:hover {
        background: rgba(0,0,0,0.1);
      }

      [data-theme="dark"] .mobile-profile-close {
        background: rgba(255,255,255,0.1);
        color: #ffffff;
      }

      [data-theme="dark"] .mobile-profile-close:hover {
        background: rgba(255,255,255,0.15);
      }

      .mobile-profile-user {
        padding: 20px;
        border-bottom: 1px solid var(--border-color, rgba(0,0,0,0.1));
      }

      .mobile-profile-username {
        font-size: 18px;
        font-weight: 600;
        color: var(--macos-text-primary, #1d1d1f);
        margin-bottom: 4px;
      }

      .mobile-profile-email {
        font-size: 13px;
        color: var(--macos-text-secondary, #86868b);
      }

      .mobile-profile-menu {
        flex: 1;
        overflow-y: auto;
        padding: 12px 0;
      }

      .mobile-profile-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 20px;
        font-size: 15px;
        color: var(--macos-text-primary, #1d1d1f);
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .mobile-profile-item:hover {
        background: rgba(0,0,0,0.03);
      }

      [data-theme="dark"] .mobile-profile-item:hover {
        background: rgba(255,255,255,0.05);
      }

      .mobile-profile-item svg {
        width: 20px;
        height: 20px;
        color: var(--macos-text-secondary, #86868b);
      }

      /* Hide Home Page button on mobile */
      #mobileProfileHomePage {
        display: none !important;
      }

      .mobile-profile-separator {
        height: 1px;
        background: var(--border-color, rgba(0,0,0,0.1));
        margin: 8px 20px;
      }

      .mobile-profile-theme {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 14px 20px;
      }

      .mobile-profile-theme span {
        flex: 1;
        font-size: 15px;
        color: var(--macos-text-primary, #1d1d1f);
      }

      .mobile-theme-options {
        display: flex;
        gap: 6px;
      }

      .mobile-profile-logout {
        margin: 12px 20px 20px;
        padding: 14px;
        background: #ff3b30;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: opacity 0.2s ease;
        font-family: inherit;
      }

      .mobile-profile-logout:hover {
        opacity: 0.9;
      }

      .mobile-profile-logout svg {
        width: 18px;
        height: 18px;
      }

      /* Mobile Profile Trigger Button in Header */
      .mobile-profile-trigger {
        display: flex !important;
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        cursor: pointer;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: background 0.2s ease;
      }

      .mobile-profile-trigger:hover {
        background: rgba(0,0,0,0.05);
      }

      .mobile-profile-trigger svg {
        width: 20px;
        height: 20px;
        color: var(--macos-text-primary, #1d1d1f);
      }

      [data-theme="dark"] .mobile-profile-trigger svg {
        color: #ffffff;
      }

      /* ========================================
         TO-DO LISTS PADDING OPTIMIZATION (Mobile)
         ======================================== */

      .dashboard-left-column,
      .dashboard-right-columns {
        padding: 3vw !important;
      }

      .todo-projects-left,
      .todo-tasks-right,
      .pinned-events-card,
      .schwarzes-brett-card {
        width: 100% !important;
        padding: 0 !important;
      }

      .todo-projects-list,
      .todo-tasks-list {
        width: 100% !important;
      }

      /* Remove horizontal padding from inner containers */
      .container-section {
        padding-left: 0 !important;
        padding-right: 0 !important;
      }

      /* ========================================
         Apple Calendar Mobile Design
         ======================================== */

      /* Calendar controls responsive on mobile */
      .calendar-controls {
        flex-direction: column !important;
        gap: 8px !important;
        padding: 0 16px;
      }

      .calendar-controls > button,
      .calendar-controls > div {
        width: 100%;
      }

      .calendar-controls button {
        justify-content: center;
      }

      .calendar-controls select {
        width: 100% !important;
        min-width: auto !important;
      }

      /* Hide Create Booking button on mobile */
      #createBookingBtn {
        display: none !important;
      }

      /* Date Navigation Container */
      .date-nav-container {
        flex-direction: column !important;
        width: 100% !important;
      }

      .date-nav-container input[type="date"] {
        width: 100%;
        margin-bottom: 4px;
      }

      .day-nav-buttons {
        width: 100%;
        display: flex !important;
        gap: 8px !important;
      }

      .day-nav-buttons button {
        flex: 1;
        min-width: 0;
      }

      /* Toggle switches stay inline */
      .calendar-controls label {
        width: auto !important;
        margin: 0 auto;
      }

      /* Dashboard Container - Stack vertically on mobile */
      .dashboard-container {
        display: flex !important;
        flex-direction: column !important;
        gap: 24px !important;
      }

      .dashboard-left-column,
      .dashboard-right-columns {
        width: 100% !important;
        flex-direction: column !important;
        height: auto !important;
        max-height: none !important;
      }

      /* Hide desktop calendar grid */
      .calendar-container .calendar-grid {
        display: none !important;
      }

      /* Mobile Calendar Wrapper */
      .calendar-container {
        overflow: visible !important;
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
      }

      /* Mobile 7-Day Header */
      .mobile-week-header {
        display: flex !important;
        justify-content: space-between;
        background: var(--macos-panel);
        backdrop-filter: var(--macos-blur-medium);
        -webkit-backdrop-filter: var(--macos-blur-medium);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 8px 4px;
        margin-bottom: 16px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .mobile-day-item {
        flex: 1;
        min-width: 45px;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px 4px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .mobile-day-item.active {
        background: var(--macos-accent-blue);
        color: #ffffff;
      }

      .mobile-day-name {
        font-size: 11px;
        font-weight: 600;
        color: var(--macos-text-secondary);
        margin-bottom: 4px;
        text-transform: uppercase;
      }

      .mobile-day-item.active .mobile-day-name {
        color: rgba(255, 255, 255, 0.8);
      }

      .mobile-day-number {
        font-size: 18px;
        font-weight: 600;
        color: var(--macos-text-primary);
      }

      .mobile-day-item.active .mobile-day-number {
        color: #ffffff;
      }

      .mobile-day-item.today:not(.active) {
        background: var(--macos-fill-quaternary);
      }

      /* Mobile Calendar Day View */
      .mobile-calendar-view {
        display: block !important;
        background: var(--macos-panel);
        backdrop-filter: var(--macos-blur-medium);
        -webkit-backdrop-filter: var(--macos-blur-medium);
        border: none;
        border-radius: 0;
        overflow: hidden;
      }

      .mobile-time-column {
        display: flex;
        flex-direction: column;
      }

      .mobile-hour-row {
        display: flex;
        min-height: 60px;
        border-bottom: 1px solid var(--border-color);
      }

      .mobile-hour-row:last-child {
        border-bottom: none;
      }

      .mobile-hour-label {
        width: 60px;
        padding: 8px;
        font-size: 12px;
        font-weight: 500;
        color: var(--macos-text-secondary);
        border-right: 1px solid var(--border-color);
        text-align: right;
        flex-shrink: 0;
      }

      .mobile-hour-content {
        flex: 1;
        padding: 8px;
        position: relative;
        background: rgba(255, 255, 255, 0.5);
      }

      .mobile-event {
        background: rgba(255, 255, 255, 0.95);
        border-left: 4px solid var(--location-primary);
        border-radius: 6px;
        padding: 8px;
        margin-bottom: 4px;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .mobile-event.guest {
        border-left-color: #42A5F5;
      }

      .mobile-event.resident {
        border-left-color: var(--location-primary);
      }

      .mobile-event.events {
        border-left-color: #5856D6;
      }

      .mobile-event-time {
        font-size: 11px;
        color: var(--macos-text-secondary);
        margin-bottom: 2px;
      }

      .mobile-event-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--macos-text-primary);
      }

      /* Calendar section padding adjustment */
      #calendar-section {
        padding: 0 16px;
      }

      /* Calendar tabs mobile adjustment */
      .calendar-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* ========================================
       Mini Availability Calendar Styles
       ======================================== */
    .availability-calendar-container {
      margin-top: 16px;
      background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(250,250,252,0.98));
      border: 2px solid rgba(0,0,0,0.15);
      border-radius: 16px;
      padding: 16px;
      box-shadow: none;
      max-width: 700px;
    }

    .availability-calendar-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: start;
    }

    .availability-calendar-left {
      min-width: 0;
    }

    .availability-calendar-right {
      min-width: 0;
      padding-left: 20px;
      border-left: 2px solid rgba(0,0,0,0.12);
    }

    .availability-calendar-right.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      color: #86868b;
      font-size: 13px;
      text-align: center;
    }

    .availability-calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    .availability-calendar-title {
      font-size: 14px;
      font-weight: 600;
      color: #1d1d1f;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .availability-calendar-nav {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .availability-calendar-nav button {
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(0,0,0,0.05);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #1d1d1f;
      transition: all 0.2s ease;
    }

    .availability-calendar-nav button:hover {
      background: rgba(0,113,227,0.1);
      color: #0071e3;
    }

    .availability-calendar-nav button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .availability-calendar-month {
      font-size: 13px;
      font-weight: 600;
      color: #1d1d1f;
      min-width: 110px;
      text-align: center;
    }

    .availability-calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 6px;
    }

    .availability-calendar-weekday {
      text-align: center;
      font-size: 10px;
      font-weight: 600;
      color: #86868b;
      text-transform: uppercase;
      padding: 6px 0;
    }

    .availability-calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .availability-calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: default;
      transition: all 0.2s ease;
      position: relative;
      min-height: 32px;
    }

    .availability-calendar-day.empty {
      background: transparent;
    }

    .availability-calendar-day.unavailable {
      color: #c7c7cc;
      background: rgba(0,0,0,0.02);
    }

    .availability-calendar-day.past {
      color: #c7c7cc;
      background: rgba(0,0,0,0.02);
    }

    .availability-calendar-day.available {
      background: rgba(52, 199, 89, 0.12);
      color: #1d1d1f;
      cursor: pointer;
      border: 2px solid rgba(52, 199, 89, 0.5);
    }

    .availability-calendar-day.available:hover {
      background: rgba(52, 199, 89, 0.25);
      transform: scale(1.08);
      box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
    }

    .availability-calendar-day.available::after {
      content: '';
      position: absolute;
      bottom: 4px;
      width: 3px;
      height: 3px;
      background: #34C759;
      border-radius: 50%;
    }

    .availability-calendar-day.selected {
      background: #0071e3 !important;
      color: white !important;
      border-color: #0071e3 !important;
    }

    .availability-calendar-day.selected::after {
      background: white;
    }

    .availability-calendar-day.today {
      font-weight: 700;
      box-shadow: inset 0 0 0 2px #0071e3;
    }

    /* Time Slots Container - Now in right column */
    .time-slots-container {
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .time-slots-header {
      margin-bottom: 10px;
    }

    .time-slots-title {
      font-size: 13px;
      font-weight: 600;
      color: #1d1d1f;
      display: block;
      margin-bottom: 4px;
    }

    .time-slots-date {
      font-size: 12px;
      color: #86868b;
    }

    .time-slots-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      max-height: 180px;
      overflow-y: auto;
    }

    .time-slot {
      padding: 8px 4px;
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      background: rgba(0,0,0,0.03);
      border: 2px solid rgba(0,0,0,0.12);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .time-slot:hover {
      background: rgba(0,113,227,0.1);
      border-color: rgba(0,113,227,0.3);
      color: #0071e3;
    }

    .time-slot.selected {
      background: #0071e3;
      color: white;
      border-color: #0071e3;
    }

    .time-slot.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* End Time Selection */
    .end-time-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(0,0,0,0.08);
    }

    .end-time-label {
      font-size: 13px;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 8px;
    }

    .selected-time-display {
      margin-top: 12px;
      padding: 10px 12px;
      background: rgba(52, 199, 89, 0.1);
      border: 2px solid rgba(52, 199, 89, 0.4);
      border-radius: 8px;
    }

    .selected-time-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .selected-time-date {
      font-size: 13px;
      font-weight: 600;
      color: #1d1d1f;
    }

    .selected-time-range {
      font-size: 12px;
      color: #34C759;
      font-weight: 500;
    }

    .selected-time-clear {
      margin-top: 8px;
      padding: 6px 10px;
      font-size: 11px;
      background: rgba(255,59,48,0.1);
      color: #FF3B30;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      width: 100%;
    }

    .selected-time-clear:hover {
      background: rgba(255,59,48,0.2);
    }

    /* WANNADOS TAB STYLES */
    .wannado-collection-card {
      background: white;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 16px;
      overflow: hidden;
    }
    .wannado-collection-card:hover {
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .wannado-collection-card.dragging {
      opacity: 0.5;
    }
    .collection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      cursor: grab;
    }
    .collection-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .collection-drag-handle {
      color: #ccc;
      font-size: 20px;
      user-select: none;
    }
    .collection-artist-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
    }
    .collection-info h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }
    .collection-info p {
      font-size: 13px;
      color: #86868b;
      margin: 4px 0 0;
    }
    .collection-wannados {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
      padding: 24px;
    }
    .wannado-card {
      background: #fafafa;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }
    .wannado-card:hover {
      border-color: #0071e3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .wannado-card.sold {
      opacity: 0.6;
    }
    .wannado-card .wannado-image {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      background: #eee;
    }
    .wannado-card .wannado-details {
      padding: 12px;
    }
    .wannado-card .wannado-name {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .wannado-card .wannado-meta {
      display: flex;
      justify-content: space-between;
    }
    .wannado-card .wannado-price {
      font-size: 16px;
      font-weight: 700;
      color: #0071e3;
    }
    .wannado-card .wannado-duration {
      font-size: 12px;
      color: #86868b;
    }
    .wannado-sold-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #ff3b30;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
    }
    .artist-select-card {
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
    }
    .artist-select-card:hover {
      border-color: #0071e3;
    }
    .artist-select-card.selected {
      border-color: #0071e3;
      background: rgba(0,113,227,0.08);
    }
    .artist-select-card img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 8px;
    }
    .artist-select-card .name {
      font-size: 12px;
      font-weight: 600;
    }
    .wannado-row {
      background: #f8f9fa;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .wannado-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .wannado-row-number {
      font-size: 12px;
      font-weight: 600;
      color: #86868b;
    }
    .wannado-row-delete {
      background: none;
      border: none;
      color: #ff3b30;
      cursor: pointer;
      font-size: 20px;
    }
    .wannado-image-upload {
      border: 2px dashed rgba(0,0,0,0.15);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      color: #86868b;
    }
    .wannado-image-upload:hover {
      border-color: #0071e3;
    }
    .wannado-image-upload.has-image {
      padding: 8px;
    }
    .wannado-image-upload.has-image img {
      max-width: 100%;
      max-height: 100px;
      border-radius: 6px;
    }

    /* ==========================================
       MOBILE CALENDAR & DIENSTPLAN VIEWS
       Only visible on mobile < 768px
       ========================================== */
    @media (max-width: 768px) {
      /* Prevent iOS overscroll/bounce */
      html, body {
        overscroll-behavior: none;
        -webkit-overflow-scrolling: touch;
      }

      /* Lock the body when mobile views are active */
      body.mobile-view-active {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }

      /* Mobile Calendar View - Apple Style */
      .mobile-calendar-view {
        display: none !important;
        background: var(--macos-bg, #f5f5f7);
        flex-direction: column;
        /* Height auto - scrollt mit der Seite */
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        padding-top: 60px; /* Platz fÃ¼r fixed header */
        padding-bottom: 83px; /* Platz fÃ¼r fixed navbar */
        border-radius: 0 !important;
        border: none !important;
      }

      .mobile-calendar-view.active {
        display: flex !important;
      }

      .mobile-cal-header {
        padding: 16px;
        padding-top: max(16px, env(safe-area-inset-top));
        background: white;
        border: none;
        border-radius: 0;
      }

      /* Datum in der Top-Navbar */
      .mobile-cal-nav-date {
        font-size: 17px;
        font-weight: 600;
        color: var(--macos-text-primary, #1d1d1f);
        display: block;
        text-align: left;
      }

      .mobile-cal-week-dropdown {
        display: none; /* Hidden - week info now shown in header */
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: var(--macos-fill-tertiary, rgba(0,0,0,0.05));
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 600;
        color: var(--macos-text-primary, #1d1d1f);
        cursor: pointer;
        font-family: inherit;
      }

      .mobile-cal-week-nav {
        display: flex;
        gap: 8px;
        padding: 0 16px 12px;
        background: white;
        border: none;
        border-radius: 0;
      }

      /* Pfeil-Buttons - transparenter Hintergrund, grÃ¶ÃŸer */
      .mobile-cal-nav-btn {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        padding: 8px 16px;
        font-size: 24px;
        color: #1d1d1f;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto;
        transition: background 0.2s ease;
      }

      .mobile-cal-nav-btn:hover,
      .mobile-cal-nav-btn:active {
        background: rgba(0,0,0,0.05) !important;
        border-radius: 8px;
      }

      .mobile-cal-nav-btn svg {
        width: 28px !important;
        height: 28px !important;
        stroke-width: 2.5;
      }

      .mobile-cal-weekdays {
        display: flex;
        padding: 0 8px;
        gap: 4px;
      }

      .mobile-cal-day {
        flex: 1;
        text-align: center;
        padding: 8px 4px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .mobile-cal-day-name {
        font-size: 11px;
        color: var(--macos-text-secondary, #86868b);
        text-transform: uppercase;
      }

      .mobile-cal-day-num {
        font-size: 16px;
        font-weight: 600;
        color: var(--macos-text-primary, #1d1d1f);
        margin-top: 4px;
      }

      .mobile-cal-day.active {
        background: var(--macos-accent-red, #ff3b30);
      }

      .mobile-cal-day.active .mobile-cal-day-name,
      .mobile-cal-day.active .mobile-cal-day-num {
        color: white;
      }

      .mobile-cal-day.today .mobile-cal-day-num {
        background: var(--macos-accent-red, #ff3b30);
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 4px auto 0;
      }

      .mobile-cal-filter {
        padding: 8px 16px;
      }

      .mobile-cal-filter select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--macos-stroke-primary, rgba(0,0,0,0.1));
        border-radius: 8px;
        background: var(--macos-fill-quaternary, rgba(0,0,0,0.03));
        font-size: 14px;
        color: var(--macos-text-primary, #1d1d1f);
        font-family: inherit;
      }

      .mobile-cal-timeline {
        flex: 1;
        overflow-y: auto;
        padding: 0 16px 16px;
      }

      .mobile-cal-date-header {
        font-size: 15px;
        font-weight: 600;
        color: var(--macos-text-primary, #1d1d1f);
        padding: 12px 0;
        position: sticky;
        top: 0;
        background: var(--macos-bg, #f5f5f7);
        z-index: 1;
      }

      .mobile-cal-hours {
        position: relative;
      }

      .mobile-cal-hour-row {
        display: flex;
        min-height: 60px;
        border-top: 1px solid var(--macos-stroke-secondary, rgba(0,0,0,0.06));
      }

      .mobile-cal-hour-label {
        width: 50px;
        font-size: 12px;
        color: var(--macos-text-secondary, #86868b);
        padding-top: 4px;
      }

      .mobile-cal-hour-content {
        flex: 1;
        position: relative;
      }

      .mobile-cal-event {
        position: absolute;
        left: 4px;
        right: 4px;
        padding: 8px;
        border-radius: 6px;
        font-size: 12px;
        overflow: hidden;
        cursor: pointer;
        border-left: 3px solid;
      }

      .mobile-cal-event-title {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .mobile-cal-event-time {
        font-size: 11px;
        opacity: 0.8;
        margin-top: 2px;
      }

      /* Event Category Colors */
      .mobile-cal-event.consultation { background: #E3F2FD; border-color: #2196F3; color: #1565C0; }
      .mobile-cal-event.new_tattoo { background: #E8F5E9; border-color: #4CAF50; color: #2E7D32; }
      .mobile-cal-event.continuing_tattoo { background: #FFF3E0; border-color: #FF9800; color: #E65100; }
      .mobile-cal-event.touch_up { background: #F3E5F5; border-color: #9C27B0; color: #6A1B9A; }
      .mobile-cal-event.selfbooking { background: #E0F7FA; border-color: #00BCD4; color: #00838F; }
      .mobile-cal-event.wannado { background: #FCE4EC; border-color: #E91E63; color: #AD1457; }
      .mobile-cal-event.internal { background: #ECEFF1; border-color: #607D8B; color: #37474F; }
      .mobile-cal-event.move { background: #FFF8E1; border-color: #FFC107; color: #FF8F00; }
      .mobile-cal-event.reserved { background: #EFEBE9; border-color: #795548; color: #4E342E; }
      .mobile-cal-event.no_show { background: #FFEBEE; border-color: #F44336; color: #C62828; }

      /* ==========================================
         MULTI-ARTIST CALENDAR GRID LAYOUT
         ========================================== */

      /* Wochenleiste (oben) */
      .mobile-cal-week-strip {
        display: flex;
        justify-content: space-around;
        padding: 8px;
        background: white;
        border: none;
        border-radius: 0;
      }

      .mobile-cal-week-day {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 6px 10px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        background: transparent;
        color: var(--macos-text-primary, #1d1d1f);
      }

      /* HEUTE (aktueller Echtzeit-Tag) - ROT */
      .mobile-cal-week-day.today {
        background: #FF3B30 !important;
        color: white !important;
      }

      /* AUSGEWÃ„HLT aber NICHT heute - DUNKELGRAU */
      .mobile-cal-week-day.selected:not(.today) {
        background: #3a3a3c !important;
        color: white !important;
      }

      /* Legacy: .active wird wie .today.selected behandelt */
      .mobile-cal-week-day.active {
        background: #FF3B30;
        color: white;
      }

      .mobile-cal-week-day-name {
        font-size: 10px;
        font-weight: 500;
        text-transform: uppercase;
        opacity: 0.8;
      }

      .mobile-cal-week-day-num {
        font-size: 16px;
        font-weight: 600;
      }

      .mobile-cal-week-day.today .mobile-cal-week-day-name,
      .mobile-cal-week-day.today .mobile-cal-week-day-num,
      .mobile-cal-week-day.selected .mobile-cal-week-day-name,
      .mobile-cal-week-day.selected .mobile-cal-week-day-num,
      .mobile-cal-week-day.active .mobile-cal-week-day-name,
      .mobile-cal-week-day.active .mobile-cal-week-day-num {
        color: white;
        opacity: 1;
      }

      /* === HEUTE BUTTON === */
      .mobile-cal-today-btn {
        flex: 2;
        padding: 10px 20px;
        background: #e5e5ea;
        color: #1d1d1f;
        border: none;
        border-radius: 10px;
        font-weight: 500;
        font-size: 15px;
        transition: all 0.2s ease;
      }

      /* Dunkelgrau mit weiÃŸer Schrift (wenn NICHT heute ausgewÃ¤hlt) */
      .mobile-cal-today-btn.highlight {
        background: #3a3a3c !important;
        color: white !important;
      }

      /* === KALENDER-ICON (Monatsansicht Button) === */
      .mobile-cal-month-btn {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        padding: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .mobile-cal-month-btn svg {
        width: 24px;
        height: 24px;
        stroke: #1d1d1f;
      }

      /* Grid Wrapper - width 100vw, height auto */
      .mobile-cal-grid-wrapper {
        width: 100vw;
        height: auto !important;
        overflow-y: visible !important;
        overflow-x: hidden !important;
        display: flex;
        flex-direction: row;
        background: var(--macos-bg, #f5f5f7);
      }

      /* Zeitleiste links - aligned mit Terminen */
      .mobile-cal-time-column {
        width: 55px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        background: var(--macos-bg, #f5f5f7);
        border-right: 1px solid rgba(0,0,0,0.1);
        /* KEINE feste HÃ¶he - passt sich an */
      }

      /* Zeit-Header */
      .mobile-cal-time-header {
        height: 44px;
        background: var(--macos-bg, #f5f5f7);
        border-bottom: 1px solid rgba(0,0,0,0.1);
      }

      /* Zeit-Slots - HÃ¶he wird dynamisch via JS gesetzt */
      .mobile-cal-time-slot {
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 4px;
        font-size: 11px;
        color: var(--macos-text-secondary, #86868b);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        /* height wird via JS gesetzt basierend auf Terminen */
        min-height: 60px;
      }

      .mobile-cal-artist-header-spacer {
        height: 44px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
      }

      /* Artist-Scroll - NUR horizontaler Scroll */
      .mobile-cal-artists-scroll {
        flex: 1;
        display: flex;
        overflow-x: auto;
        overflow-y: visible !important;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior-x: contain;
      }

      /* Artist Spalte */
      .mobile-cal-artist-column {
        min-width: 160px;
        flex-shrink: 0;
        border-right: 1px solid rgba(0,0,0,0.1);
        position: relative;
        background: white;
      }

      /* Artist Header */
      .mobile-cal-artist-header {
        height: 44px;
        padding: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: white;
        border-bottom: 1px solid rgba(0,0,0,0.1);
      }

      .mobile-cal-artist-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
        background: #e0e0e0;
        flex-shrink: 0;
      }

      .mobile-cal-artist-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--macos-text-primary, #1d1d1f);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Stunden-Grid - KEINE feste HÃ¶he, wird durch Inhalt bestimmt */
      .mobile-cal-hour-grid {
        position: relative;
        /* height wird durch Hour-Rows bestimmt */
      }

      /* Hour Row - HÃ¶he wird dynamisch via JS gesetzt */
      .mobile-cal-hour-row {
        min-height: 60px;
        /* TatsÃ¤chliche HÃ¶he basiert auf Terminen */
        border-bottom: 1px solid rgba(0,0,0,0.05);
        position: relative;
      }

      .mobile-cal-hour-row-grid {
        min-height: 60px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        position: relative;
      }

      /* Termin-Card */
      .mobile-cal-appointment {
        position: absolute;
        left: 4px;
        right: 4px;
        border-radius: 6px;
        padding: 4px 6px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 1px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: pointer;
        z-index: 2;
      }

      .mobile-cal-apt-time {
        font-size: 9px;
        font-weight: 600;
        opacity: 0.9;
      }

      .mobile-cal-apt-customer {
        font-size: 11px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .mobile-cal-apt-category {
        font-size: 9px;
        display: flex;
        align-items: center;
        gap: 3px;
        opacity: 0.85;
      }

      .mobile-cal-apt-category svg {
        width: 10px;
        height: 10px;
        flex-shrink: 0;
      }

      /* Keine Termine Nachricht */
      .mobile-cal-no-appointments {
        padding: 40px 20px;
        text-align: center;
        color: var(--macos-text-secondary, #86868b);
        font-size: 14px;
      }

      /* Modal */
      .mobile-cal-modal {
        display: none !important;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        align-items: flex-end;
        justify-content: center;
      }

      .mobile-cal-modal.active {
        display: flex !important;
      }

      .mobile-cal-modal-content {
        width: 100%;
        max-height: 70vh;
        background: var(--macos-nav-bg, #ffffff);
        border-radius: 20px 20px 0 0;
        overflow: hidden;
      }

      .mobile-cal-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--macos-stroke-primary, rgba(0,0,0,0.1));
        font-weight: 600;
      }

      .mobile-cal-modal-close {
        background: none;
        border: none;
        font-size: 20px;
        color: var(--macos-text-secondary, #86868b);
        cursor: pointer;
      }

      .mobile-cal-modal-body {
        padding: 20px;
        overflow-y: auto;
      }

      /* Mobile Dienstplan View - gleiche Struktur wie Calendar */
      .mobile-dienstplan-view {
        display: none !important;
        background: var(--macos-bg, #f5f5f7);
        flex-direction: column;
        /* Height auto - scrollt mit der Seite */
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        padding-top: 60px; /* Platz fÃ¼r fixed header */
        padding-bottom: 83px; /* Platz fÃ¼r fixed navbar */
        overflow-y: visible !important;
        overflow-x: hidden !important;
        border-radius: 0 !important;
        border: none !important;
      }

      .mobile-dienstplan-view.active {
        display: flex !important;
      }

      /* Content areas - normaler Flow, kein separater Scroll */
      .mobile-cal-timeline,
      #mobileDpDays {
        flex: none;
        overflow: visible !important;
        height: auto !important;
      }

      #mobileDpDays {
        padding: 12px 16px;
        padding-bottom: 100px; /* Extra Platz fÃ¼r Navbar */
      }

      #mobileCalTimeline {
        padding-bottom: 20px;
      }

      .mobile-dp-header {
        padding: 16px;
        padding-top: max(16px, env(safe-area-inset-top));
      }

      .mobile-dp-week-dropdown {
        display: none; /* Hidden - week info now shown in header */
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: var(--macos-fill-tertiary, rgba(0,0,0,0.05));
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 600;
        color: var(--macos-text-primary, #1d1d1f);
        cursor: pointer;
        font-family: inherit;
      }

      .mobile-dp-week-nav {
        display: flex;
        gap: 8px;
        padding: 0 16px 12px;
      }

      /* Pfeil-Buttons - transparenter Hintergrund, grÃ¶ÃŸer */
      .mobile-dp-nav-btn {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        padding: 8px 16px;
        font-size: 24px;
        color: #1d1d1f;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto;
        transition: background 0.2s ease;
      }

      .mobile-dp-nav-btn:hover,
      .mobile-dp-nav-btn:active {
        background: rgba(0,0,0,0.05) !important;
        border-radius: 8px;
      }

      .mobile-dp-nav-btn svg {
        width: 28px !important;
        height: 28px !important;
        stroke-width: 2.5;
      }

      /* Kalender-Icon Button - etwas kleiner */
      .mobile-dp-nav-btn:first-child svg {
        width: 20px !important;
        height: 20px !important;
        stroke-width: 1.5;
      }

      /* === DIENSTPLAN HEUTE BUTTON === */
      .mobile-dp-today-btn {
        flex: 2;
        padding: 10px 20px;
        background: #e5e5ea;
        color: #1d1d1f;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.2s ease;
      }

      /* Dunkelgrau mit weiÃŸer Schrift (wenn NICHT heute ausgewÃ¤hlt) */
      .mobile-dp-today-btn.highlight {
        background: #3a3a3c !important;
        color: white !important;
      }

      /* === DIENSTPLAN WEEK-DAY STYLING === */
      .mobile-dp-week-day {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 6px 10px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        background: transparent;
        color: var(--macos-text-primary, #1d1d1f);
      }

      /* HEUTE (aktueller Echtzeit-Tag) - ROT */
      .mobile-dp-week-day.today {
        background: #FF3B30 !important;
        color: white !important;
      }

      /* AUSGEWÃ„HLT aber NICHT heute - DUNKELGRAU */
      .mobile-dp-week-day.selected:not(.today) {
        background: #3a3a3c !important;
        color: white !important;
      }

      .mobile-dp-week-day.today *,
      .mobile-dp-week-day.selected * {
        color: white;
        opacity: 1;
      }

      .mobile-dp-days {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 0 16px 16px;
        padding-bottom: 100px; /* Extra Platz fÃ¼r Navbar */
        overflow: visible !important;
        height: auto !important;
      }

      .mobile-dp-day-card {
        background: var(--macos-panel, #ffffff);
        border-radius: 12px;
        margin-bottom: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }

      .mobile-dp-day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        font-weight: 600;
        color: var(--macos-text-primary, #1d1d1f);
      }

      .mobile-dp-day-menu {
        background: none;
        border: none;
        color: var(--macos-text-secondary, #86868b);
        cursor: pointer;
        font-size: 18px;
      }

      .mobile-dp-shift {
        padding: 12px 16px;
        background: #E3F2FD;
        margin: 8px;
        border-radius: 8px;
        border-left: 3px solid #2196F3;
      }

      .mobile-dp-shift-title {
        font-weight: 600;
        color: #1565C0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .mobile-dp-shift-info {
        font-size: 13px;
        color: #1976D2;
        margin-top: 4px;
      }

      .mobile-dp-no-shift {
        padding: 16px;
        background: var(--macos-fill-quaternary, rgba(0,0,0,0.03));
        margin: 8px;
        border-radius: 8px;
        text-align: center;
        color: var(--macos-text-secondary, #86868b);
      }

      /* Mobile Dienstplan Month View */
      .mobile-dp-month-view {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--macos-bg, #f5f5f7);
        z-index: 10000;
        flex-direction: column;
      }

      .mobile-dp-month-view.active {
        display: flex;
      }

      .mobile-dp-month-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        padding-top: max(16px, env(safe-area-inset-top));
        border-bottom: 1px solid rgba(0,0,0,0.1);
        background: white;
      }

      .mobile-dp-month-back {
        display: flex;
        align-items: center;
        gap: 4px;
        background: none;
        border: none;
        color: #007AFF;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        padding: 8px 0;
      }

      .mobile-dp-month-title {
        font-size: 17px;
        font-weight: 600;
        color: #1a1a1a;
      }

      .mobile-dp-months-scroll {
        flex: 1;
        overflow-x: hidden;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        -webkit-overflow-scrolling: touch;
        padding: 0 16px 100px 16px;
      }

      .mobile-dp-month-container {
        width: 100%;
        padding: 0;
        margin-bottom: 24px;
      }

      .mobile-dp-month-name {
        font-size: 24px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 12px;
        padding-top: 16px;
        position: sticky;
        top: 0;
        background: linear-gradient(to bottom, #f5f5f7 80%, transparent);
        z-index: 10;
      }

      .mobile-dp-weekday-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        margin-bottom: 0;
        background: #f5f5f7;
        padding: 6px 0;
        border-radius: 8px 8px 0 0;
      }

      .mobile-dp-weekday-label {
        text-align: center;
        font-size: 10px;
        font-weight: 600;
        color: #8e8e93;
        text-transform: uppercase;
      }

      .mobile-dp-month-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: rgba(0,0,0,0.05);
        border-radius: 0 0 12px 12px;
        overflow: hidden;
      }

      .mobile-dp-day-cell {
        aspect-ratio: auto;
        min-height: 70px;
        max-height: 90px;
        background: white;
        padding: 3px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: none;
        position: relative;
      }

      .mobile-dp-day-cell:active {
        background: #f0f0f5;
      }

      .mobile-dp-day-cell.other-month {
        opacity: 0.3;
        background: transparent;
        pointer-events: none; /* Not clickable */
      }

      .mobile-dp-empty-cell {
        background: transparent !important;
        border: none !important;
        pointer-events: none !important;
        min-height: 60px;
      }

      .mobile-dp-empty-cell * {
        display: none !important;
      }

      .mobile-dp-day-cell.other-month .mobile-dp-day-events {
        display: none; /* Hide events in other months */
      }

      .mobile-dp-day-cell.other-month .mobile-dp-day-number {
        color: #ccc;
      }

      .mobile-dp-day-cell.today {
        background: #f0f7ff;
      }

      .mobile-dp-day-cell.today .mobile-dp-day-number {
        background: #007AFF;
        color: white;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .mobile-dp-day-number {
        font-size: 12px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 1px;
      }

      .mobile-dp-day-cell.weekend .mobile-dp-day-number {
        color: #8e8e93;
      }

      .mobile-dp-day-events {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 1px;
      }

      .mobile-dp-mini-event {
        font-size: 8px;
        font-weight: 500;
        padding: 1px 3px;
        border-radius: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.2;
      }

      .mobile-dp-mini-event.available { background: #d4edda; color: #155724; }
      .mobile-dp-mini-event.vacation { background: #ffe8cc; color: #c45000; }
      .mobile-dp-mini-event.sick { background: #f8d7da; color: #721c24; }
      .mobile-dp-mini-event.training { background: #d1ecf1; color: #0c5460; }
      .mobile-dp-mini-event.homeoffice { background: #e2e3e5; color: #383d41; }
      .mobile-dp-mini-event.guestspot { background: #e2d5f0; color: #4a1a7a; }
      .mobile-dp-mini-event.business { background: #cce5ff; color: #004085; }
      .mobile-dp-mini-event.convention { background: #f5c6cb; color: #721c24; }
      .mobile-dp-mini-event.other { background: #fff3cd; color: #856404; }

      .mobile-dp-more-events {
        font-size: 8px;
        color: #6c757d;
        text-align: center;
        padding: 0;
        line-height: 1;
      }

      /* Mobile Calendar Month View */
      .mobile-cal-month-view {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--macos-bg, #f5f5f7);
        z-index: 10000;
        flex-direction: column;
        /* Animation vorbereiten */
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      .mobile-cal-month-view.active {
        display: flex;
        opacity: 1;
        transform: translateY(0);
      }

      /* FÃ¼r Animation beim SchlieÃŸen */
      .mobile-cal-month-view.closing {
        opacity: 0;
        transform: translateY(-20px);
      }

      /* Mobile Event Detail View - Full Frame Compact */
      .mobile-event-detail {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--macos-bg);
        z-index: 10000;
        flex-direction: column;
        overflow: hidden;
        overscroll-behavior: none;
      }

      .mobile-event-detail.active {
        display: flex;
      }

      .mobile-event-detail-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        padding-top: max(12px, env(safe-area-inset-top));
        border-bottom: 1px solid var(--macos-stroke-primary);
        background: var(--macos-nav-bg);
        min-height: 44px;
      }

      .mobile-event-back {
        display: flex;
        align-items: center;
        gap: 2px;
        background: none;
        border: none;
        color: var(--macos-accent-blue);
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        padding: 6px 0;
      }

      .mobile-event-back svg {
        width: 20px;
        height: 20px;
      }

      .mobile-event-category-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      .mobile-event-detail-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px 16px;
        padding-bottom: max(12px, env(safe-area-inset-bottom));
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: none;
      }

      .mobile-event-section {
        margin-bottom: 16px;
      }

      .mobile-event-section-title {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        font-weight: 600;
        color: var(--macos-text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      .mobile-event-field {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 8px 0;
        border-bottom: 1px solid var(--macos-stroke-secondary);
        gap: 12px;
      }

      .mobile-event-field:last-child {
        border-bottom: none;
      }

      .mobile-event-label {
        font-size: 10px;
        font-weight: 600;
        color: var(--macos-text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        flex-shrink: 0;
      }

      .mobile-event-value {
        font-size: 13px;
        color: var(--macos-text-primary);
        text-align: right;
        word-break: break-word;
      }

      .mobile-event-value.empty {
        color: var(--macos-text-tertiary);
        font-style: italic;
        font-size: 12px;
      }

      /* Category Badge Colors */
      .mobile-event-category-badge.consultation { background: #E3F2FD; color: #1565C0; }
      .mobile-event-category-badge.new_tattoo { background: #E8F5E9; color: #2E7D32; }
      .mobile-event-category-badge.continuing_tattoo { background: #FFF3E0; color: #E65100; }
      .mobile-event-category-badge.touch_up { background: #F3E5F5; color: #6A1B9A; }
      .mobile-event-category-badge.selfbooking { background: #E0F7FA; color: #00838F; }
      .mobile-event-category-badge.wannado { background: #FCE4EC; color: #AD1457; }
      .mobile-event-category-badge.internal { background: #ECEFF1; color: #37474F; }
      .mobile-event-category-badge.move { background: #FFF8E1; color: #FF8F00; }
      .mobile-event-category-badge.reserved { background: #EFEBE9; color: #4E342E; }
      .mobile-event-category-badge.no_show { background: #FFEBEE; color: #C62828; }
    }

    /* ========================================
       Dienstplan Slot Popups
       ======================================== */

    .slot-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }

    .slot-popup {
      background: #fff;
      border-radius: 16px;
      width: 100%;
      max-width: 420px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
    }

    [data-theme="dark"] .slot-popup {
      background: #1c1c1e;
    }

    .slot-popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    [data-theme="dark"] .slot-popup-header {
      border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    .slot-popup-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .slot-popup-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #86868b;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .slot-popup-close:hover {
      background: #f5f5f7;
    }

    .slot-popup-body {
      padding: 24px;
    }

    .slot-popup-field {
      margin-bottom: 20px;
    }

    .slot-popup-field:last-child {
      margin-bottom: 0;
    }

    .slot-popup-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #86868b;
      margin-bottom: 6px;
    }

    .slot-popup-value {
      font-size: 15px;
      color: var(--text-primary);
    }

    .slot-popup-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d1d6;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      background: #fff;
      color: var(--text-primary);
      box-sizing: border-box;
    }

    .slot-popup-input:focus {
      outline: none;
      border-color: #007AFF;
    }

    [data-theme="dark"] .slot-popup-input {
      background: #2c2c2e;
      border-color: #48484a;
    }

    .slot-popup-row {
      display: flex;
      gap: 12px;
    }

    .slot-popup-row > * {
      flex: 1;
    }

    /* Status/Typ Selector */
    .slot-type-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .slot-type-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px 8px;
      border: 1px solid #d1d1d6;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      background: #fff;
    }

    .slot-type-option:hover {
      border-color: #86868b;
    }

    .slot-type-option.selected {
      border-color: #34C759;
      background: rgba(52, 199, 89, 0.1);
    }

    .slot-type-option .type-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 24px;
    }

    .slot-type-option .type-icon svg {
      width: 20px;
      height: 20px;
    }

    .slot-type-option .type-label {
      font-size: 12px;
      color: var(--text-primary);
      text-align: center;
    }

    [data-theme="dark"] .slot-type-option {
      background: #2c2c2e;
      border-color: #48484a;
    }

    /* Popup Actions */
    .slot-popup-actions {
      display: flex;
      gap: 12px;
      padding: 20px 24px;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    [data-theme="dark"] .slot-popup-actions {
      border-top-color: rgba(255, 255, 255, 0.1);
    }

    .slot-popup-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .slot-popup-btn svg {
      width: 16px;
      height: 16px;
    }

    .slot-popup-btn.edit {
      background: #fff;
      border: 1px solid #d1d1d6;
      color: #1d1d1f;
    }

    .slot-popup-btn.edit:hover {
      border-color: #86868b;
      background: #f5f5f7;
    }

    .slot-popup-btn.delete {
      background: #ff3b30;
      border: none;
      color: #fff;
    }

    .slot-popup-btn.delete:hover {
      background: #e6352b;
    }

    .slot-popup-btn.save {
      background: #1d1d1f;
      border: none;
      color: #fff;
    }

    .slot-popup-btn.save:hover {
      background: #333;
    }

    .slot-popup-btn.cancel {
      background: #fff;
      border: 1px solid #d1d1d6;
      color: #1d1d1f;
    }

    /* Slot Group Styling */
    .slot-group {
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      min-height: 32px;
    }

    .slot-group:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    /* ========================================
       Status Options ohne Emoji
       ======================================== */
    .status-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border: 1px solid #e5e5ea;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      margin-bottom: 8px;
    }

    .status-option:hover {
      background: #f5f5f7;
      border-color: #d1d1d6;
    }

    .status-option.selected {
      background: #f0f0f5;
      border-color: #007AFF;
    }

    .status-indicator {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .status-label {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* ========================================
       Appointment Detail Buttons
       ======================================== */

    .appointment-detail-actions {
      display: flex;
      gap: 12px;
      padding: 20px 24px;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    .appointment-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
    }

    .appointment-btn svg {
      flex-shrink: 0;
    }

    /* SchlieÃŸen - Outline Style */
    .appointment-btn.close {
      background: #fff;
      border: 1px solid #d1d1d6;
      color: #1d1d1f;
    }

    .appointment-btn.close:hover {
      background: #f5f5f7;
      border-color: #86868b;
    }

    /* Bearbeiten - Schwarz */
    .appointment-btn.edit {
      background: #1d1d1f;
      color: #fff;
    }

    .appointment-btn.edit:hover {
      background: #333;
    }

    /* Stornieren - Orange */
    .appointment-btn.cancel {
      background: #FF9500;
      color: #fff;
    }

    .appointment-btn.cancel:hover {
      background: #E68600;
    }

    /* LÃ¶schen - Rot */
    .appointment-btn.delete {
      background: #FF3B30;
      color: #fff;
    }

    .appointment-btn.delete:hover {
      background: #E6352B;
    }

    /* Dark Mode */
    [data-theme="dark"] .appointment-btn.close {
      background: #2c2c2e;
      border-color: #48484a;
      color: #f5f5f7;
    }

    [data-theme="dark"] .appointment-btn.close:hover {
      background: #3a3a3c;
    }

    [data-theme="dark"] .appointment-btn.edit {
      background: #f5f5f7;
      color: #1d1d1f;
    }

    /* ========================================
       Appointment Edit Popup
       ======================================== */

    .appointment-edit-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      padding: 20px;
    }

    .appointment-edit-popup {
      background: #fff;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
    }

    [data-theme="dark"] .appointment-edit-popup {
      background: #1c1c1e;
    }

    .appointment-edit-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1;
    }

    [data-theme="dark"] .appointment-edit-header {
      background: #1c1c1e;
      border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    .appointment-edit-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .appointment-edit-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #86868b;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .appointment-edit-close:hover {
      background: #f5f5f7;
    }

    .appointment-edit-body {
      padding: 24px;
    }

    .appointment-edit-section {
      margin-bottom: 20px;
    }

    .appointment-edit-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #86868b;
      margin: 0 0 8px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .appointment-edit-readonly {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-primary);
      padding: 12px 14px;
      background: #f5f5f7;
      border-radius: 10px;
    }

    [data-theme="dark"] .appointment-edit-readonly {
      background: #2c2c2e;
    }

    .appointment-edit-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #86868b;
      margin-bottom: 6px;
    }

    .appointment-edit-input,
    .appointment-edit-textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d1d6;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      background: #fff;
      color: var(--text-primary);
      transition: border-color 0.15s ease;
      box-sizing: border-box;
    }

    .appointment-edit-input:focus,
    .appointment-edit-textarea:focus {
      outline: none;
      border-color: #007AFF;
    }

    [data-theme="dark"] .appointment-edit-input,
    [data-theme="dark"] .appointment-edit-textarea {
      background: #2c2c2e;
      border-color: #48484a;
    }

    .appointment-edit-textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Artist Search Dropdown */
    .artist-search-container {
      position: relative;
      width: 100%;
    }

    .artist-search-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: #fff;
      color: #1d1d1f;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .artist-search-input:focus {
      outline: none;
      border-color: #0071e3;
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.15);
    }

    .artist-search-input::placeholder {
      color: #86868b;
    }

    .artist-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
    }

    .artist-dropdown.visible {
      display: block;
    }

    .artist-dropdown-item {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
      color: #1d1d1f;
      transition: background 0.1s ease;
    }

    .artist-dropdown-item:hover {
      background: #f5f5f7;
    }

    .artist-dropdown-item.selected {
      background: #e8f0fe;
      color: #0071e3;
    }

    .artist-dropdown-empty {
      padding: 10px 12px;
      font-size: 14px;
      color: #86868b;
      font-style: italic;
    }

    [data-theme="dark"] .artist-search-input {
      background: #2c2c2e;
      border-color: #48484a;
      color: #f5f5f7;
    }

    [data-theme="dark"] .artist-search-input:focus {
      border-color: #0a84ff;
      box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);
    }

    [data-theme="dark"] .artist-dropdown {
      background: #2c2c2e;
      border-color: #48484a;
    }

    [data-theme="dark"] .artist-dropdown-item {
      color: #f5f5f7;
    }

    [data-theme="dark"] .artist-dropdown-item:hover {
      background: #3a3a3c;
    }

    [data-theme="dark"] .artist-dropdown-item.selected {
      background: #1c3a5e;
      color: #0a84ff;
    }

    .appointment-edit-row {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .appointment-edit-field {
      flex: 1;
    }

    .appointment-edit-actions {
      display: flex;
      gap: 12px;
      padding: 20px 24px;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    [data-theme="dark"] .appointment-edit-actions {
      border-top-color: rgba(255, 255, 255, 0.1);
    }

    .appointment-edit-btn {
      flex: 1;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
    }

    .appointment-edit-btn.cancel {
      background: #fff;
      border: 1px solid #d1d1d6;
      color: #1d1d1f;
    }

    .appointment-edit-btn.cancel:hover {
      background: #f5f5f7;
    }

    .appointment-edit-btn.save {
      background: #1d1d1f;
      color: #fff;
    }

    .appointment-edit-btn.save:hover {
      background: #333;
    }

    [data-theme="dark"] .appointment-edit-btn.cancel {
      background: #2c2c2e;
      border-color: #48484a;
      color: #f5f5f7;
    }

    [data-theme="dark"] .appointment-edit-btn.save {
      background: #0a84ff;
    }

    /* ============================================
       PHASE 7: GUEST SPOT CALENDAR IMPROVEMENTS
       ============================================ */

    /* Guest Spot Month View - Day Cells with Auto Height */
    #guestspotMonthGrid > div {
      min-height: 80px;
      height: auto;
      max-height: none;
    }

    /* Guest Spot Items in Day Cell */
    .guest-spot-day-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      margin: 2px 0;
      background: #5856D6;
      color: white;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .guest-spot-day-item:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .guest-spot-day-item.paid {
      background: #34C759;
    }

    .guest-spot-day-item.unpaid {
      background: #FF3B30;
    }

    .guest-spot-day-item.canceled {
      background: #8E8E93;
      text-decoration: line-through;
      opacity: 0.7;
    }

    .guest-spot-day-item.past {
      opacity: 0.6;
    }

    .guest-spot-day-item .artist-name {
      font-weight: 500;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .guest-spot-day-item .spot-time {
      font-size: 10px;
      opacity: 0.8;
    }

    /* ============================================
       GUEST SPOT YEAR VIEW - Dienstplan Style
       ============================================ */

    .guestspot-year-view {
      background: var(--macos-panel, #1c1c1e);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border-color, #3a3a3c);
    }

    .guestspot-year-view-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--macos-elevated, #2c2c2e);
      border-bottom: 1px solid var(--border-color, #3a3a3c);
    }

    .guestspot-year-navigation {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .guestspot-year-label {
      font-size: 24px;
      font-weight: 600;
      color: var(--ink, #fff);
      min-width: 80px;
      text-align: center;
    }

    /* Months Header Row */
    .guestspot-year-months-header {
      display: grid;
      grid-template-columns: 180px repeat(12, 1fr);
      background: var(--macos-elevated, #2c2c2e);
      border-bottom: 1px solid var(--border-color, #3a3a3c);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .guestspot-artist-column-header,
    .guestspot-month-header {
      padding: 12px 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted, #8e8e93);
      text-align: center;
      border-right: 1px solid var(--border-color, #3a3a3c);
    }

    .guestspot-artist-column-header {
      text-align: left;
      padding-left: 16px;
      background: var(--macos-elevated, #2c2c2e);
      position: sticky;
      left: 0;
      z-index: 11;
    }

    /* Year Grid Container */
    .guestspot-year-grid-container {
      max-height: calc(100vh - 350px);
      overflow-y: auto;
      overflow-x: auto;
    }

    /* Artist Row */
    .guestspot-year-artist-row {
      display: grid;
      grid-template-columns: 180px repeat(12, 1fr);
      border-bottom: 1px solid var(--border-color, #3a3a3c);
      min-height: 44px;
    }

    .guestspot-year-artist-row:hover {
      background: rgba(255,255,255,0.03);
    }

    /* Artist Name Cell */
    .guestspot-year-artist-name {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: var(--macos-panel, #1c1c1e);
      border-right: 1px solid var(--border-color, #3a3a3c);
      position: sticky;
      left: 0;
      z-index: 5;
    }

    .guestspot-year-artist-name img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }

    .guestspot-year-artist-name .name {
      font-size: 13px;
      font-weight: 500;
      color: var(--ink, #fff);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .guestspot-year-artist-name .instagram {
      font-size: 11px;
      color: var(--muted, #8e8e93);
    }

    /* Month Cell */
    .guestspot-year-month-cell {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      padding: 4px;
      border-right: 1px solid var(--border-color, #3a3a3c);
      min-height: 40px;
      align-content: flex-start;
    }

    /* Spot Indicator in Year View */
    .guestspot-year-spot-indicator {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.15s ease;
      margin: 1px 0;
    }

    .guestspot-year-spot-indicator:hover {
      transform: scaleY(1.8);
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }

    .guestspot-year-spot-indicator.paid {
      background: linear-gradient(90deg, #34C759, #30D158);
    }

    .guestspot-year-spot-indicator.unpaid {
      background: linear-gradient(90deg, #FF3B30, #FF453A);
    }

    .guestspot-year-spot-indicator.canceled {
      background: #6b7280;
      opacity: 0.5;
    }

    /* Multi-day span indicator */
    .guestspot-year-spot-span {
      display: flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      color: white;
      white-space: nowrap;
    }

    .guestspot-year-spot-span.paid {
      background: #34C759;
    }

    .guestspot-year-spot-span.unpaid {
      background: #FF3B30;
    }

    /* Empty State */
    .guestspot-year-view-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted, #8e8e93);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .guestspot-year-months-header,
      .guestspot-year-artist-row {
        grid-template-columns: 140px repeat(12, minmax(50px, 1fr));
      }

      .guestspot-year-artist-name {
        padding: 6px 8px;
      }

      .guestspot-year-artist-name img {
        width: 24px;
        height: 24px;
      }

      .guestspot-year-artist-name .name {
        font-size: 12px;
      }
    }

    /* ============================================
       CANCELED STYLING - VerstÃ¤rkt
       ============================================ */
    .dienstplan-slot.canceled,
    .slot-entry.canceled,
    .slot-entry[data-state="Canceled"],
    .slot-cell.canceled,
    [data-status="canceled"] {
      background: #6b7280 !important;
      background-color: #6b7280 !important;
      opacity: 0.6 !important;
    }

    .slot-entry.canceled .slot-time,
    .slot-entry[data-state="Canceled"] .slot-time,
    .guest-spot-card.canceled .artist-name {
      text-decoration: line-through !important;
      color: #9ca3af !important;
    }

  </style>
</head>
<body>
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- FULLSCREEN LOADING SCREEN WITH BACKGROUND IMAGE -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="loadingScreen" class="loading-screen active">
    <!-- Background Image als IMG Tag (zuverlÃ¤ssiger) -->
    <div class="loading-bg">
      <img src="https://auxxyehgzkozdjylhqnx.supabase.co/storage/v1/object/public/assets/Bildschirmfoto%202025-12-16%20um%2013.46.55.png"
           alt=""
           class="loading-bg-img"
           onload="console.log('âœ… Background image loaded')"
           onerror="console.error('âŒ Background image failed to load')">
    </div>

    <!-- Logo -->
    <div class="loading-logo">Culture over Money Management</div>

    <!-- Progress Bar Container -->
    <div class="loading-progress-container">
      <div class="loading-status" id="loadingStatus">Initialisiere...</div>
      <div class="loading-progress-bar">
        <div class="loading-progress-fill" id="loadingProgressFill"></div>
        <div class="loading-progress-percent" id="loadingProgressPercent">0%</div>
      </div>
    </div>

    <!-- Glass Overlay (initially hidden) -->
    <div class="loading-glass-overlay" id="loadingGlassOverlay">
      <!-- Login Form -->
      <div class="loading-login-form" id="loadingLoginForm">
        <h2>Willkommen zurÃ¼ck!</h2>
        <p>Bitte melde dich an, um fortzufahren</p>

        <form id="loadingLoginFormElement">
          <div class="login-field">
            <label for="loadingUsername">Benutzername</label>
            <input type="text" id="loadingUsername" autocomplete="username" required>
          </div>
          <div class="login-field">
            <label for="loadingPassword">Passwort</label>
            <input type="password" id="loadingPassword" autocomplete="current-password" required>
          </div>
          <div class="login-remember">
            <input type="checkbox" id="loadingRememberMe">
            <label for="loadingRememberMe">Angemeldet bleiben</label>
          </div>
          <button type="submit" class="login-submit-btn" disabled>Anmelden</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Loading Progress Bar Overlay (Pop-up) -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-container">
      <button class="progress-close" onclick="ProgressBar.hide()" title="Close progress bar">âœ•</button>
      <div class="progress-text" id="progressText">Loading data...</div>
      <div class="progress-info">
        <div class="progress-line">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-percent" id="progressPercent">0%</div>
      </div>
    </div>
  </div>

  <!-- Header Section -->
  <div class="header-section">
    <h2 class="header-title">Culture over Money Dashboard</h2>

    <div class="nav-icons">
      <!-- Feedback Button (nur Desktop) -->
      <button class="feedback-button" id="feedbackButton">
        Feedback
      </button>

      <!-- Notification Bell (Desktop) -->
      <button class="icon-button notification desktop-only-notification" id="notificationButton" style="position: relative;">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 22C13.1 22 14 21.1 14 20H10C10 21.1 10.9 22 12 22ZM18 16V11C18 7.93 16.37 5.36 13.5 4.68V4C13.5 3.17 12.83 2.5 12 2.5C11.17 2.5 10.5 3.17 10.5 4V4.68C7.64 5.36 6 7.92 6 11V16L4 18V19H20V18L18 16Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
      </button>

      <!-- Mobile Inbox Button -->
      <button class="mobile-inbox-btn" id="mobileInboxBtn" onclick="openMobileInbox()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
          <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
        </svg>
      </button>

      <!-- Project Invitations Icon - Hidden (invitations now in main inbox) -->
      <button class="icon-button" id="projectInvitationsButton" style="position: relative; display: none;">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
          <path d="M3 8L12 13L21 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span id="invitationsBadge" style="position: absolute; top: 2px; right: 2px; background: #ff3b30; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; font-weight: 700; display: none; align-items: center; justify-content: center;">0</span>
      </button>

      <!-- Profile Icon (Desktop only) -->
      <button class="icon-button profile" id="profileButton">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="1.5"/>
          <path d="M20 20C20 16.134 16.418 13 12 13C7.582 13 4 16.134 4 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Profile Panel Overlay -->
  <div class="mobile-profile-overlay" id="mobileProfileOverlay" onclick="closeMobileProfile()"></div>

  <!-- Mobile Profile Panel -->
  <div class="mobile-profile-panel" id="mobileProfilePanel">
    <div class="mobile-profile-header">
      <span style="font-weight: 600; font-size: 16px;">Profil</span>
      <button class="mobile-profile-close" id="mobileProfileClose" onclick="closeMobileProfile()">âœ•</button>
    </div>

    <div class="mobile-profile-user">
      <div class="mobile-profile-username" id="mobileProfileUsername">User name</div>
      <div class="mobile-profile-email" id="mobileProfileEmail">user@example.com</div>
    </div>

    <button class="mobile-profile-logout" id="mobileProfileLogout" onclick="handleMobileLogout()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9M16 17L21 12M21 12L16 7M21 12H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>Abmelden</span>
    </button>
  </div>

  <!-- Mobile Inbox Panel -->
  <div class="mobile-inbox-panel" id="mobileInboxPanel">
    <div class="mobile-inbox-header">
      <button class="mobile-inbox-back" onclick="closeMobileInbox()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        ZurÃ¼ck
      </button>
      <h2 class="mobile-inbox-title">Inbox</h2>
    </div>
    <div class="mobile-inbox-content" id="mobileInboxContent">
      <div class="mobile-inbox-empty">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
          <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
          <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
        </svg>
        <p>Keine neuen Nachrichten</p>
      </div>
    </div>
  </div>

  <!-- Mobile Notification Panel -->
  <div class="mobile-notification-panel" id="mobileNotificationPanel">
    <div class="mobile-panel-header">
      <button class="mobile-panel-back" onclick="closeMobileNotificationPanel()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        ZurÃ¼ck
      </button>
      <span class="mobile-panel-title">Benachrichtigungen</span>
    </div>
    <div class="mobile-panel-content" id="mobileNotificationContent">
      <div style="padding:40px 20px;text-align:center;color:#999;">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom:16px;opacity:0.5;">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
        </svg>
        <div style="font-weight:500;">Keine neuen Benachrichtigungen</div>
      </div>
    </div>
  </div>

  <!-- Project Invitations Dropdown -->
  <div class="profile-dropdown" id="invitationsDropdown" style="display: none; min-width: 320px; max-width: 400px;">
    <div class="profile-header">
      <div class="profile-username">ðŸ”” Projekt-Einladungen</div>
    </div>
    <div id="invitationsContent" style="max-height: 400px; overflow-y: auto;">
      <div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 14px;">
        Keine Einladungen
      </div>
    </div>
  </div>

  <!-- Profile Dropdown -->
  <div class="profile-dropdown" id="profileDropdown">
    <div class="profile-header">
      <div class="profile-username" id="profileDropdownUsername">User name</div>
      <div class="profile-email" id="profileDropdownEmail">user@example.com</div>
    </div>

    <div class="dropdown-item" id="dashboardLinkDropdown">Dashboard</div>
    <div class="dropdown-item" id="accountSettingsLink">Account Settings</div>

    <div class="dropdown-separator"></div>

    <div class="dropdown-item" id="commandMenuLink">
      <span>Command Menu</span>
      <div class="keyboard-shortcut">
        <button class="theme-btn" style="pointer-events: none;">âŒ˜</button>
        <button class="theme-btn" style="pointer-events: none;">K</button>
      </div>
    </div>

    <div class="dropdown-item" id="themeToggleItem">
      <span>Theme</span>
      <div class="theme-options">
        <button class="theme-btn active" id="lightThemeBtn" data-theme="light">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="1.5"/>
            <path d="M12 1V3M12 21V23M23 12H21M3 12H1M20.485 20.485L19.071 19.071M4.929 4.929L3.515 3.515M20.485 3.515L19.071 4.929M4.929 19.071L3.515 20.485" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
        <button class="theme-btn" id="darkThemeBtn" data-theme="dark">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="dropdown-separator"></div>

    <div class="dropdown-item" id="homePageLink">
      <span>Home Page</span>
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>

    <div class="dropdown-separator"></div>

    <button class="upgrade-btn" id="logoutBtn">
      <span>Log Out</span>
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px;">
        <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9M16 17L21 12M21 12L16 7M21 12H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <!-- Notifications Dropdown -->
  <div class="notifications-dropdown" id="notificationsDropdown">
    <div class="notifications-tabs">
      <div class="notification-tab active" id="inboxTab">Inbox</div>
      <div class="notification-tab" id="updatesTab">Updates</div>
    </div>

    <div class="notifications-content">
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="empty-icon">
          <rect x="3" y="6" width="18" height="13" rx="2" stroke="currentColor" stroke-width="1.5"/>
          <path d="M3 9L12 14L21 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <p class="empty-text">No new notifications</p>
      </div>
    </div>
  </div>

  <!-- Feedback Dropdown -->
  <div class="feedback-dropdown" id="feedbackDropdown">
    <select class="feedback-select" id="feedbackSelect">
      <option value="">Select a topic...</option>
      <option value="bug">Bug Report</option>
      <option value="feature">Feature Request</option>
      <option value="other">Other</option>
    </select>

    <textarea class="feedback-textarea" id="feedbackTextarea" placeholder="Your feedback..."></textarea>

    <div class="feedback-actions">
      <div class="feedback-emojis">
        <button class="emoji-btn" data-emoji="ðŸ˜¢">ðŸ˜¢</button>
        <button class="emoji-btn" data-emoji="â˜¹ï¸">â˜¹ï¸</button>
        <button class="emoji-btn" data-emoji="ðŸ™‚">ðŸ™‚</button>
        <button class="emoji-btn" data-emoji="ðŸ˜„">ðŸ˜„</button>
      </div>
      <button class="feedback-send-btn" id="feedbackSendBtn">Send</button>
    </div>
  </div>

  <!-- Navigation Bar - Main (Desktop) -->
  <nav class="navbar-container" id="mainNavbar">
    <div class="hover-background"></div>
    <div class="active-indicator"></div>
    <a class="nav-link active" href="#" data-view="dashboard" id="tab-dashboard">Dashboard</a>
    <a class="nav-link" href="#" data-view="requests" id="tab-requests">Requests</a>
    <a class="nav-link" href="#" data-view="calendar" id="tab-calendar">Calendar</a>
    <a class="nav-link" href="#" data-view="guestspots" id="tab-guestspots">Guest Spots</a>
    <a class="nav-link" href="#" data-view="waitlist" id="tab-waitlist">Waitlist</a>
    <a class="nav-link" href="#" data-view="artists" id="tab-artists">Artists</a>
    <a class="nav-link" href="#" data-view="customers" id="tab-customers">Customers</a>
    <a class="nav-link" href="#" data-view="dienstplan" id="tab-dienstplan">Dienstplan</a>
    <a class="nav-link" href="#" data-view="agreements" id="tab-agreements">Agreements</a>
    <a class="nav-link" href="#" data-view="analytics" id="tab-analytics">Analytics</a>
    <a class="nav-link" href="#" data-view="wannados" id="tab-wannados">Wannados</a>
  </nav>

  <!-- Navigation Bar - Account Settings (Desktop only) -->
  <nav class="navbar-container" id="settingsNavbar" style="display: none;">
    <div class="hover-background"></div>
    <a class="nav-link" href="#" id="returnToDashboard">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px; margin-right: 6px; display: inline-block; vertical-align: middle;">
        <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Return to Dashboard
    </a>
    <a class="nav-link active" href="#" data-tab="activity">Activity</a>
    <a class="nav-link" href="#" data-tab="settings">Settings</a>
  </nav>

  <section id="dashboard-section" class="active">
    <!-- Mobile Dashboard Profile (nur auf Mobile sichtbar) -->
    <div class="mobile-dashboard-profile" id="mobileDashboardProfile">
      <div class="mobile-profile-avatar">
        <img src="" alt="" id="mobileProfileAvatarImg" style="display:none;">
        <span class="mobile-profile-initials" id="mobileProfileInitials">?</span>
      </div>
      <h2 class="mobile-profile-name" id="mobileProfileName">User Name</h2>

      <!-- Swipeable Role/Email Container -->
      <div class="mobile-profile-swipe-container" id="mobileProfileSwipe">
        <div class="mobile-profile-swipe-track" id="mobileProfileSwipeTrack">
          <div class="mobile-profile-slide active" data-slide="role">
            <span class="mobile-profile-role" id="mobileProfileRole">Artist</span>
          </div>
          <div class="mobile-profile-slide" data-slide="email">
            <span class="mobile-profile-email" id="mobileProfileEmail">email@example.com</span>
          </div>
        </div>
        <div class="mobile-profile-indicators">
          <span class="mobile-profile-indicator active" data-index="0"></span>
          <span class="mobile-profile-indicator" data-index="1"></span>
        </div>
      </div>

      <!-- Inline Logout Button -->
      <button class="mobile-logout-btn-inline" onclick="handleMobileLogout()">
        Abmelden
      </button>
    </div>

    <!-- Mobile Erscheinungsbild Section -->
    <div class="mobile-appearance-section">
      <h3 class="mobile-section-title">Erscheinungsbild</h3>
      <div class="mobile-appearance-toggle">
        <button class="mobile-theme-btn active" id="mobileLightModeBtn" onclick="setMobileTheme('light')">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
        </button>
        <button class="mobile-theme-btn" id="mobileDarkModeBtn" onclick="setMobileTheme('dark')">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Welcome Banner (shown when logged in) -->
    <div id="dashboardWelcome" class="dashboard-welcome" style="display: none;">
      <div class="dashboard-welcome-text">
        <h1 id="dashboardWelcomeText">Willkommen</h1>
        <p>Deine Ãœbersicht Ã¼ber alle wichtigen AktivitÃ¤ten</p>
      </div>
      <span id="versionBadge" style="background: transparent; color: #86868b; padding: 6px 0; font-size: 13px; font-weight: 400; font-family: system-ui, -apple-system, sans-serif; margin-left: auto;">Version 3.1068</span>
    </div>

    <!-- Dashboard Grid Layout - New 30/70 Split -->
    <div class="dashboard-container" style="margin-top: 32px;">
      <!-- Left Column (30%) - Pinned Events + Schwarzes Brett -->
      <div class="dashboard-left-column">
        <!-- Mobile Tab Switcher (only visible on mobile) -->
        <div class="mobile-tabs-wrapper" id="mobileTabsWrapper" style="display: none;">
          <div class="mobile-content-tabs">
            <button class="mobile-content-tab active" data-tab="pinned-events">Pinned Events</button>
            <button class="mobile-content-tab" data-tab="schwarzes-brett">Schwarzes Brett</button>
          </div>
          <div class="mobile-content-container">
            <!-- Pinned Events Tab Content -->
            <div class="mobile-content-pane active" id="mobilePinnedEventsPane">
              <div class="mobile-slider-container" id="mobilePinnedEventsSlider">
                <!-- Content will be dynamically populated -->
              </div>
              <div class="mobile-slider-indicator" id="mobilePinnedEventsIndicator">1 / 1</div>
            </div>
            <!-- Schwarzes Brett Tab Content -->
            <div class="mobile-content-pane" id="mobileSchwarzesBrettPane">
              <div class="mobile-slider-container" id="mobileSchwarzesBrettSlider">
                <!-- Content will be dynamically populated -->
              </div>
              <div class="mobile-slider-indicator" id="mobileSchwarzesBrettIndicator">1 / 1</div>
            </div>
          </div>
        </div>

        <!-- Pinned Events Section -->
        <div class="container-section pinned-events-wrapper">
          <h3 class="container-section-title">Pinned Events</h3>
          <div class="dashboard-card pinned-events-card" id="pinnedEventsContainer">
            <div class="event-empty">Lade Events...</div>
          </div>
        </div>

        <!-- Schwarzes Brett Section -->
        <div class="container-section schwarzes-brett-wrapper">
          <h3 class="container-section-title">Schwarzes Brett</h3>
          <div class="dashboard-card schwarzes-brett-card" id="schwarzesBrettContainer" style="display:flex; flex-direction:column; overflow:hidden;">
            <!-- New Message Popup (hidden by default) -->
            <div class="new-message-popup" id="newMessagePopup">
              <div class="popup-header">
                <h4 class="popup-title">Neue Nachricht</h4>
                <button class="popup-close" id="closePopupBtn">âœ•</button>
              </div>
              <textarea class="popup-textarea" id="messageContent" placeholder="Deine Nachricht..."></textarea>
              <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <select id="messageCategory" style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); font-size: 14px; color: var(--text-primary); font-family: inherit;">
                  <option value="Info">Info</option>
                  <option value="Design">Design</option>
                  <option value="System">System</option>
                  <option value="Portfolio">Portfolio</option>
                  <option value="Guest Spot">Guest Spot</option>
                </select>
                <select id="messageLocation" style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); font-size: 14px; color: var(--text-primary); font-family: inherit;">
                  <option value="All Locations">All Locations</option>
                  <option value="Stuttgart">Stuttgart</option>
                  <option value="MÃ¼nchen">MÃ¼nchen</option>
                  <option value="KÃ¶ln">KÃ¶ln</option>
                  <option value="Berlin">Berlin</option>
                  <option value="Paris">Paris</option>
                </select>
              </div>
              <button id="submitMessageBtn" style="width: 100%; padding: 12px; background: #1d1d1f; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; font-family: inherit;">
                VerÃ¶ffentlichen
              </button>
            </div>

            <!-- Messages scroll area -->
            <div id="brettMessages" style="flex:1; overflow-y:auto; padding:16px;">
              <div class="brett-empty">Lade Nachrichten...</div>
            </div>

            <!-- Fixed input at bottom -->
            <div class="brett-input-container" style="flex-shrink:0; padding:12px 16px; border-top:1px solid rgba(0,0,0,0.06); background:#fff;">
              <button id="addMessageBtn" style="width:100%; padding:12px 16px; background:#1d1d1f; color:#fff; border:none; border-radius:8px; font-size:14px; font-weight:500; cursor:pointer;">
                + Neue Nachricht
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Columns (70%) - To-Do Projects + Tasks -->
      <div class="dashboard-right-columns">
        <!-- Recent Projects Section -->
        <div class="container-section todo-projects-wrapper">
          <h3 class="container-section-title">Recent Projects</h3>
          <div class="todo-projects-left">
            <div class="todo-projects-list" id="todoProjectsList">
              <div class="todo-empty-state">Lade Projekte...</div>
            </div>
            <button class="add-btn" id="todoAddProjectBtn">+ Add new</button>
          </div>
        </div>

        <!-- Tasks Section -->
        <div class="container-section todo-tasks-wrapper">
          <h3 class="container-section-title" id="todoTasksTitle">Tasks</h3>
          <div class="todo-tasks-right">
            <div class="todo-tasks-list" id="todoTasksList">
              <div class="todo-empty-state">Select Project to view</div>
            </div>
            <button class="add-btn" id="todoAddTaskBtn" style="display: none;">+ Add Task</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Edit Project Modal -->
  <div class="todo-edit-modal" id="todoEditModal">
    <div class="todo-edit-content">
      <div class="todo-edit-header">
        <h4 class="todo-edit-title" id="todoEditModalTitle">Projekt bearbeiten</h4>
        <button class="todo-edit-close" id="todoEditCloseBtn">&times;</button>
      </div>

      <div class="todo-form-group">
        <label class="todo-form-label">Projekttitel *</label>
        <input type="text" class="todo-form-input" id="todoEditTitle" placeholder="Projekttitel">
      </div>

      <div class="todo-form-group">
        <label class="todo-form-label">Beschreibung</label>
        <textarea class="todo-form-textarea" id="todoEditDescription" placeholder="Beschreibung (optional)"></textarea>
      </div>

      <div class="todo-form-group">
        <label class="todo-form-label">Deadline</label>
        <input type="date" class="todo-form-input" id="todoEditDeadline">
      </div>

      <!-- Collaborators Section -->
      <div class="todo-collab-section">
        <div class="todo-collab-title">Collaborators</div>
        <div class="todo-collab-search">
          <input type="text" id="todoCollabSearch" placeholder="User suchen...">
          <div class="todo-collab-results" id="todoCollabResults"></div>
        </div>
        <div class="todo-collab-list" id="todoCollabList"></div>
      </div>

      <div class="todo-form-actions">
        <button class="todo-btn-delete" id="todoDeleteBtn">LÃ¶schen</button>
        <button class="todo-btn-cancel" id="todoEditCancelBtn">Abbrechen</button>
        <button class="todo-btn-save" id="todoEditSaveBtn">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div class="todo-task-modal" id="todoTaskModal">
    <div class="todo-task-modal-content">
      <div class="todo-edit-header">
        <h4 class="todo-edit-title">Neuer Task</h4>
        <button class="todo-edit-close" id="todoTaskCloseBtn">&times;</button>
      </div>

      <div class="todo-form-group">
        <label class="todo-form-label">Task-Titel *</label>
        <input type="text" class="todo-form-input" id="todoTaskTitle" placeholder="Task-Titel">
      </div>

      <div class="todo-form-group" id="todoTaskAssigneeGroup" style="display: none;">
        <label class="todo-form-label">Zuweisen an</label>
        <select class="todo-form-select" id="todoTaskAssignee">
          <option value="">Niemand</option>
        </select>
      </div>

      <div class="todo-form-actions">
        <button class="todo-btn-cancel" id="todoTaskCancelBtn">Abbrechen</button>
        <button class="todo-btn-save" id="todoTaskSaveBtn">HinzufÃ¼gen</button>
      </div>
    </div>
  </div>

  <section id="requests-section">
    <div class="tab-header">
      <h2 class="tab-header-title">Anfragen</h2>
      <p class="tab-header-subtitle">Verwalte und bearbeite eingehende Tattoo-Anfragen</p>
    </div>

    <!-- Request Status Switcher + Refresh Controls on Same Line -->
    <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px; justify-content:space-between;">
      <!-- Request Status Switcher -->
      <div style="position:relative; background:white; border-radius:28px; padding:6px; display:inline-flex; gap:0; border:1px solid rgba(0,0,0,0.06);">
        <div id="requestsIndicator" style="position:absolute; top:6px; left:6px; height:calc(100% - 12px); background:#f5f5f7; border-radius:22px; transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow:0 1px 3px rgba(0,0,0,0.08); z-index:1; pointer-events:none;"></div>
        <button class="request-tab active" data-status="open_request" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#1d1d1f; font-family:inherit; transition:color 0.2s; white-space:nowrap;">
          New Requests
          <span id="badge-new" style="display:inline-block; background:#8E8E93; color:white; font-size:10px; font-weight:700; padding:2px 6px; border-radius:10px; margin-left:6px; min-width:18px; text-align:center;">0</span>
        </button>
        <button class="request-tab" data-status="my-requests" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">My Requests</button>
        <button class="request-tab" data-status="pending" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">In Progress</button>
        <button class="request-tab" data-status="scheduled" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Scheduled</button>
        <button class="request-tab" data-status="finished" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Finished</button>
        <button class="request-tab" data-status="canceled" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Canceled</button>
        <button class="request-tab" data-status="archived" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Archived</button>
        <button class="request-tab" data-status="deleted" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">
          Deleted
          <span id="badge-deleted" style="display:none; background:#ff3b30; color:white; font-size:10px; font-weight:700; padding:2px 6px; border-radius:10px; margin-left:6px; min-width:18px; text-align:center;">0</span>
        </button>
      </div>
    </div>

    <!-- Create Request Button + Location Dropdown + Search Bar + Refresh Controls -->
    <div style="display:grid; grid-template-columns:350px 1fr; gap:24px; margin-bottom:16px;">
      <!-- Left Controls: Create Request + Location -->
      <div style="display:flex; align-items:center; gap:12px;">
        <!-- Create Request Button (Only visible in New Requests tab) -->
        <button id="createRequestBtn" class="btn-nav" style="background:#1d1d1f; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap; height:37px;">
          <span style="font-size:18px; font-weight:600;">+</span>
          <span>Create Request</span>
        </button>

        <!-- Location Dropdown -->
        <select id="requestLocationDropdown" style="min-width:180px; padding:8px 12px; border:1px solid var(--macos-stroke-primary); border-radius:8px; font-size:13px; font-family:inherit; background:var(--macos-elevated); color:var(--macos-text-primary); cursor:pointer; height:37px;">
          <option value="all">Alle Locations</option>
          <option value="mommy">Mommy I'm Sorry</option>
          <option value="gon">GON</option>
          <option value="muttersohne">MuttersÃ¶hne</option>
          <option value="pardon">Pardon Paris</option>
        </select>
      </div>

      <!-- Right Controls: Search Bar + Auto-Refresh + Refresh Button -->
      <div style="display:flex; align-items:center; gap:12px;">
        <!-- Search Bar (left, responsive) -->
        <div style="position:relative; flex:1;">
          <input
            type="text"
            id="requestSearchInput"
            placeholder="Search requests by keyword..."
            style="width:100%; padding:8px 12px 8px 36px; border:1px solid var(--macos-stroke-primary); border-radius:8px; font-size:13px; font-family:inherit; background:var(--macos-elevated); color:var(--macos-text-primary); height:37px; box-sizing:border-box;">
          <svg style="position:absolute; left:10px; top:50%; transform:translateY(-50%); width:16px; height:16px; pointer-events:none;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>

        <!-- Auto-Refresh Toggle (right) -->
        <label style="display:flex; align-items:center; gap:8px; font-size:14px; color:var(--ink); cursor:pointer; white-space:nowrap;">
          <input type="checkbox" id="autoRefreshToggle" style="cursor:pointer;">
          <span>Auto-Refresh (30s)</span>
        </label>

        <!-- Refresh Button (right) -->
        <button id="refreshRequestsBtn" style="display:flex; align-items:center; gap:8px; padding:10px 20px; background:rgba(0,113,227,0.1); color:var(--accent); border:1px solid rgba(0,113,227,0.2); border-radius:8px; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s; font-family:inherit; white-space:nowrap; height:37px;">
          <svg id="refreshIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transition:transform 0.5s;">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
          <span id="refreshBtnText">Neue Requests laden</span>
        </button>
      </div>
    </div>

    <!-- Two Column Layout -->
    <div style="display:grid; grid-template-columns:350px 1fr; gap:24px; height:calc(100vh - 250px);">
      <!-- Request List -->
      <div id="requestsList" style="background:rgba(255,255,255,0.95); border-radius:12px; padding:16px; overflow-y:auto; border:1px solid var(--border-color);">
        <!-- Requests will be loaded here -->
      </div>

      <!-- Request Detail Panel -->
      <div id="requestDetail" style="background:rgba(255,255,255,0.95); border-radius:12px; padding:32px; overflow-y:auto; border:1px solid var(--border-color);">
        <div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--muted); font-size:16px;">
          Select a request to view details
        </div>
      </div>
    </div>
  </section>

  <section id="calendar-section">
    <div class="tab-header" style="margin-bottom: 16px;">
      <div style="display:flex; align-items:center; gap:16px;">
        <h2 class="tab-header-title" style="margin-bottom: 0;">Kalender</h2>
        <div id="currentDateDisplayTop" style="font-weight:700; font-size:24px; color:var(--ink);"></div>
      </div>
      <p class="tab-header-subtitle">Plane und verwalte Termine und Events</p>
    </div>

    <!-- Calendar Tabs -->
    <div class="calendar-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid rgba(0,0,0,0.1);">
      <button onclick="switchCalendarView('appointments')" id="calendarTabAppointments" style="
        padding: 12px 20px;
        background: none;
        border: none;
        border-bottom: 2px solid #007AFF;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        color: #1d1d1f;
      ">
        Termine
      </button>
      <button onclick="switchCalendarView('worktracking')" id="calendarTabWorkTracking" style="
        padding: 12px 20px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        color: #1d1d1f;
      ">
        Work Tracking
      </button>
    </div>

    <!-- Appointments View -->
    <div id="calendarAppointmentsView">

    <!-- Combined Container: Location Info + Booking Types -->
    <div style="margin-bottom:16px; padding:16px 20px; background:rgba(255,255,255,0.95); border-radius:12px; border:1px solid var(--border-color); display:flex; flex-direction:column; gap:16px;">

      <!-- Location Info -->
      <div id="locationInfo" style="font-size:13px; color:var(--muted);"></div>

      <!-- Booking Types Legend -->
      <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
        <span style="font-weight:500; font-size:13px; color:var(--muted);">Booking Types:</span>
        <div style="display:flex; align-items:center; gap:6px;">
          <div style="width:12px; height:12px; border-radius:3px; background:#66BB6A;"></div>
          <span style="font-size:13px; color:var(--ink);">Consultation</span>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <div style="width:12px; height:12px; border-radius:3px; background:#EC407A;"></div>
          <span style="font-size:13px; color:var(--ink);">New Tattoo</span>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <div style="width:12px; height:12px; border-radius:3px; background:#42A5F5;"></div>
          <span style="font-size:13px; color:var(--ink);">Continuing Tattoo</span>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <div style="width:12px; height:12px; border-radius:3px; background:#FFEB3B;"></div>
          <span style="font-size:13px; color:var(--ink);">Touch Up</span>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <div style="width:12px; height:12px; border-radius:3px; background:#8D6E63;"></div>
          <span style="font-size:13px; color:var(--ink);">Selfbooking</span>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <div style="width:12px; height:12px; border-radius:3px; background:#AB47BC;"></div>
          <span style="font-size:13px; color:var(--ink);">WannaDo</span>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <div style="width:12px; height:12px; border-radius:3px; background:#EF5350;"></div>
          <span style="font-size:13px; color:var(--ink);">Internal</span>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <div style="width:12px; height:12px; border-radius:3px; background:#26C6DA;"></div>
          <span style="font-size:13px; color:var(--ink);">Move</span>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <div style="width:12px; height:12px; border-radius:3px; background:#78909C;"></div>
          <span style="font-size:13px; color:var(--ink);">Reserved</span>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <div style="width:12px; height:12px; border-radius:3px; background:#FFFFFF; border:1px solid #BDBDBD;"></div>
          <span style="font-size:13px; color:var(--ink);">No Show</span>
        </div>
      </div>
    </div>

    <div class="calendar-controls" style="display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap;">
      <button id="createEventBtn" class="btn-nav" style="background:#333; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; height:37px;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Create Event</span>
      </button>
      <button id="createBookingBtn" class="btn-nav" style="background:#333; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; height:37px;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Create Booking</span>
      </button>
      <div style="display:flex; align-items:center; gap:8px; margin-right:40px;">
        <select id="locationDropdown" style="min-width:200px;"></select>
      </div>

      <!-- Date Navigation Container -->
      <div class="date-nav-container" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input type="date" id="datePickerInput">
        <div class="day-nav-buttons" style="display:flex; gap:8px;">
          <button id="prevDayBtn" class="btn-nav">â€¹ Prev</button>
          <button id="todayBtn" class="btn-nav">Today</button>
          <button id="nextDayBtn" class="btn-nav">Next â€º</button>
        </div>
      </div>

      <!-- Switches: Events, Residents, Guests -->
      <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px; margin-left:auto;">
        <span style="font-weight:700;">Events</span>
        <label class="toggle-switch">
          <input type="checkbox" id="checkEvents" checked>
          <span class="toggle-slider"></span>
        </label>
      </label>
      <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
        <span style="font-weight:700;">Residents</span>
        <label class="toggle-switch">
          <input type="checkbox" id="checkResidents" checked>
          <span class="toggle-slider"></span>
        </label>
      </label>
      <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
        <span style="font-weight:700;">Guests</span>
        <label class="toggle-switch">
          <input type="checkbox" id="checkGuests" checked>
          <span class="toggle-slider"></span>
        </label>
      </label>
      <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px; margin-left:16px; padding-left:16px; border-left:1px solid rgba(0,0,0,0.1);">
        <span style="font-weight:500; color:#6b7280;">Stornierte</span>
        <label class="toggle-switch">
          <input type="checkbox" id="showCanceledGuestSpots" onchange="toggleShowCanceledGuestSpots()">
          <span class="toggle-slider"></span>
        </label>
      </label>
    </div>

    <div class="calendar-container" id="calendarContainer"></div>
    </div>
    <!-- End Appointments View -->

    <!-- Work Tracking View -->
    <div id="calendarWorkTrackingView" style="display: none;">
      <div id="calendarWorkTrackingContainer"></div>
    </div>
    <!-- End Work Tracking View -->
  </section>

  <section id="dienstplan-section">
    <div class="tab-header">
      <h2 class="tab-header-title">Dienstplan Â· <span id="dienstplanCurrentMonth">Dezember 2025</span></h2>
      <p class="tab-header-subtitle">Plane Arbeitszeiten und Schichten fÃ¼r das Team</p>
    </div>

    <!-- Filters Bar -->
    <div class="filters-bar" style="
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      padding: 0;
      background: transparent;
      flex-wrap: wrap;
      align-items: flex-end;
    ">
      <!-- Add Slot Button -->
      <button onclick="openAddSlotModal()" style="
        background: #1d1d1f;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        height: 40px;
        transition: all 0.2s;
        white-space: nowrap;
      " onmouseover="this.style.background='#333'" onmouseout="this.style.background='#1d1d1f'">
        <span style="font-size: 18px; line-height: 1;">+</span>
        <span>Add Slot</span>
      </button>

      <!-- Create Guest Spot Button (Dienstplan) -->
      <button id="createGuestSpotBtnDienstplan" onclick="openCreateGuestSpotModal()" style="
        padding:10px 20px;
        border:none;
        border-radius:8px;
        background:#1d1d1f;
        color:#fff;
        font-size:14px;
        font-weight:500;
        cursor:pointer;
        display:inline-flex;
        align-items:center;
        gap:8px;
        transition:all 0.2s;
        height:37px;
      " onmouseover="this.style.background='#333';" onmouseout="this.style.background='#1d1d1f';">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        Create Guest Spot
      </button>

      <!-- Monat-Navigation -->
      <div style="flex: 2; min-width: 320px; display: flex; align-items: center; gap: 8px;">
        <button onclick="navigateDienstplanMonth(-1)" style="
          background: white;
          border: 1px solid rgba(0,0,0,0.1);
          border-radius: 8px;
          padding: 8px 12px;
          font-size: 14px;
          cursor: pointer;
          transition: all 0.2s;
        " onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">â€¹</button>

        <select id="dienstplanMonthSelect" onchange="changeDienstplanMonth()" style="
          padding: 8px 12px;
          border: 1px solid rgba(0,0,0,0.1);
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          background: white;
          cursor: pointer;
        ">
          <option value="0">Januar</option>
          <option value="1">Februar</option>
          <option value="2">MÃ¤rz</option>
          <option value="3">April</option>
          <option value="4">Mai</option>
          <option value="5">Juni</option>
          <option value="6">Juli</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">Oktober</option>
          <option value="10">November</option>
          <option value="11">Dezember</option>
        </select>

        <select id="dienstplanYearSelect" onchange="changeDienstplanMonth()" style="
          padding: 8px 12px;
          border: 1px solid rgba(0,0,0,0.1);
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          background: white;
          cursor: pointer;
        ">
          <!-- Jahre werden dynamisch befÃ¼llt -->
        </select>

        <button onclick="goToDienstplanThisMonth()" style="
          background: white;
          border: 1px solid rgba(0,0,0,0.1);
          border-radius: 8px;
          padding: 8px 12px;
          font-size: 12px;
          cursor: pointer;
          transition: all 0.2s;
          white-space: nowrap;
        " onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">Today</button>

        <button onclick="navigateDienstplanMonth(1)" style="
          background: white;
          border: 1px solid rgba(0,0,0,0.1);
          border-radius: 8px;
          padding: 8px 12px;
          font-size: 14px;
          cursor: pointer;
          transition: all 0.2s;
        " onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">â€º</button>
      </div>

      <!-- Rolle Filter -->
      <div style="flex: 1; min-width: 180px;">
        <label style="font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; display: block; margin-bottom: 6px;">Rolle</label>
        <select id="dienstplanRoleFilter" onchange="applyDienstplanFilters()" style="
          width: 100%;
          padding: 8px 12px;
          border: 1px solid rgba(0,0,0,0.1);
          border-radius: 8px;
          font-size: 14px;
          background: white;
        ">
          <option value="all">Alle Rollen</option>
          <option value="GeschÃ¤ftsfÃ¼hrung">Administrator</option>
          <option value="Management">Booking Manager</option>
          <option value="Resident Artist">Resident</option>
          <option value="Guest Artist">Guest</option>
          <option value="Mediadepartment">Media</option>
          <option value="null">Not defined</option>
        </select>
      </div>

      <!-- Status Filter -->
      <div style="flex: 1; min-width: 180px;">
        <label style="font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; display: block; margin-bottom: 6px;">Status</label>
        <select id="dienstplanStatusFilter" onchange="applyDienstplanFilters()" style="
          width: 100%;
          padding: 8px 12px;
          border: 1px solid rgba(0,0,0,0.1);
          border-radius: 8px;
          font-size: 14px;
          background: white;
        ">
          <option value="all">Alle Status</option>
          <option value="Available">Available</option>
          <option value="Vacation">Vacation</option>
          <option value="Business trip">Business Trip</option>
          <option value="Guestspot">Guestspot</option>
          <option value="Sick">Sick</option>
          <option value="Training">Training</option>
          <option value="Convention">Convention</option>
          <option value="Home office">Home Office</option>
          <option value="Other">Other</option>
        </select>
      </div>
    </div>

    <!-- Table 1: Dienstplan (Monthly Planning) -->
    <div id="dienstplanTableContainer"></div>

    <!-- Table 2: Work Tracking Stats -->
    <div id="workTrackingTableContainer"></div>

    <!-- Add Slot Modal -->
    <div id="addSlotModal" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    " onclick="if(event.target === this) closeAddSlotModal()">
      <div style="
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 480px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      " onclick="event.stopPropagation()">
        <!-- Header -->
        <div style="
          padding: 20px 24px;
          border-bottom: 1px solid rgba(0,0,0,0.1);
          display: flex;
          justify-content: space-between;
          align-items: center;
        ">
          <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Neuen Slot erstellen</h3>
          <button onclick="closeAddSlotModal()" style="
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #86868b;
            padding: 0;
            line-height: 1;
          ">&times;</button>
        </div>

        <!-- Form -->
        <div style="padding: 24px;">
          <!-- Artist Search -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #1d1d1f;">
              Artist / Mitarbeiter *
            </label>
            <div style="position: relative;">
              <input
                type="text"
                id="slotArtistSearch"
                placeholder="Name eingeben..."
                oninput="searchArtistsForSlot(this.value)"
                autocomplete="off"
                style="
                  width: 100%;
                  padding: 12px 16px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 8px;
                  font-size: 14px;
                  box-sizing: border-box;
                "
              >
              <input type="hidden" id="slotArtistId">
              <!-- Dropdown fÃ¼r Suchergebnisse -->
              <div id="slotArtistDropdown" style="
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid rgba(0,0,0,0.1);
                border-radius: 8px;
                margin-top: 4px;
                max-height: 240px;
                overflow-y: auto;
                z-index: 10;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              "></div>
            </div>
          </div>

          <!-- Date Range -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #1d1d1f;">
                Start Datum *
              </label>
              <input
                type="date"
                id="slotStartDate"
                style="
                  width: 100%;
                  padding: 12px 16px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 8px;
                  font-size: 14px;
                  box-sizing: border-box;
                "
              >
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #1d1d1f;">
                End Datum *
              </label>
              <input
                type="date"
                id="slotEndDate"
                style="
                  width: 100%;
                  padding: 12px 16px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 8px;
                  font-size: 14px;
                  box-sizing: border-box;
                "
              >
            </div>
          </div>

          <!-- Time Range -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #1d1d1f;">
                Start Zeit
              </label>
              <input
                type="time"
                id="slotStartTime"
                value="10:00"
                style="
                  width: 100%;
                  padding: 12px 16px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 8px;
                  font-size: 14px;
                  box-sizing: border-box;
                "
              >
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #1d1d1f;">
                End Zeit
              </label>
              <input
                type="time"
                id="slotEndTime"
                value="18:00"
                style="
                  width: 100%;
                  padding: 12px 16px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 8px;
                  font-size: 14px;
                  box-sizing: border-box;
                "
              >
            </div>
          </div>

          <!-- State/Type Selection -->
          <div style="margin-bottom: 24px;">
            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #1d1d1f;">
              Status / Typ *
            </label>
            <div id="slotStateGrid" style="
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 8px;
            ">
              <!-- State buttons werden dynamisch generiert -->
            </div>
          </div>

          <!-- Submit Button -->
          <button onclick="saveNewSlot()" style="
            width: 100%;
            padding: 14px 20px;
            background: #1d1d1f;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
          " onmouseover="this.style.background='#333'" onmouseout="this.style.background='#1d1d1f'">
            Slot erstellen
          </button>
        </div>
      </div>
    </div>
  </section>

  <section id="artists-section">
    <div class="tab-header">
      <h2 class="tab-header-title">KÃ¼nstler</h2>
      <p class="tab-header-subtitle">Verwalte KÃ¼nstlerprofile und VerfÃ¼gbarkeiten</p>
    </div>

    <!-- Add Button, Search Bar, and Filters Row -->
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
      <button id="addArtistBtn" class="btn-nav" style="background:#1d1d1f; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap; height:37px;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Add Artist</span>
      </button>

      <div style="position:relative; flex:1;">
        <svg style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:16px; height:16px; pointer-events:none;" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="artistSearchInput" placeholder="Search artists by name or Instagram..." style="width:100%; padding:12px 16px 12px 42px; font-size:15px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
      </div>

      <!-- Location Filter -->
      <select id="artistLocationFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer; height:37px;">
        <option value="">Alle Locations</option>
        <option value="NULL">Ohne Location</option>
        <!-- Locations werden dynamisch geladen -->
      </select>

      <!-- Rank Filter -->
      <select id="artistRankFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer; height:37px;">
        <option value="">Alle Ranks</option>
        <option value="Friends">Friends (70/30)</option>
        <option value="Crew">Crew (75/25)</option>
        <option value="Fam">Fam (80/20)</option>
        <option value="VIP">VIP (80/20)</option>
      </select>

      <!-- Type Filter -->
      <select id="artistTypeFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer; height:37px;">
        <option value="">Alle Types</option>
        <option value="resident">Resident Artist</option>
        <option value="guest">Guest Artist</option>
      </select>

      <!-- Status Filter -->
      <select id="artistStatusFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer; height:37px;">
        <option value="">Alle Status</option>
        <option value="active">Aktiv</option>
        <option value="inactive">Inaktiv</option>
      </select>

      <!-- Clear Filters Button -->
      <button class="btn-secondary" onclick="clearArtistFilters()" style="padding:10px 20px; background:rgba(0,0,0,0.05); border:1px solid rgba(0,0,0,0.1); border-radius:8px; cursor:pointer; white-space:nowrap; height:37px;">
        Filter zurÃ¼cksetzen
      </button>
    </div>

    <!-- Results Count -->
    <div style="font-size:14px; color:var(--muted); margin-bottom:16px;">
      <span id="artistsResultCount" style="font-weight:600; color:var(--ink);">0</span> Artists gefunden
    </div>

    <table id="artistsTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Instagram</th>
          <th>Phone</th>
          <th>Type</th>
          <th>Location</th>
          <th>Rank</th>
          <th>Status</th>
          <th style="text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody id="artistsTableBody"></tbody>
    </table>
  </section>

  <section id="customers-section">
    <div class="tab-header">
      <h2 class="tab-header-title">Kunden</h2>
      <p class="tab-header-subtitle">Durchsuche und verwalte deine Kundendatenbank</p>
    </div>

    <!-- Add Button, Search Bar, and Filters Row -->
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
      <button id="addCustomerBtn" class="btn-nav" style="background:#1d1d1f; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap; height:37px;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Add Customer</span>
      </button>

      <div style="position:relative; flex:1;">
        <svg style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:16px; height:16px; pointer-events:none;" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input
          type="text"
          id="customerSearchInput"
          placeholder="Search customers by name, email or phone..."
          style="width:100%; padding:12px 16px 12px 42px; font-size:15px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
      </div>

      <!-- Rank Filter -->
      <select id="customerRankFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer; height:37px;">
        <option value="">Alle RÃ¤nge</option>
        <option value="Neukunde">Neukunde</option>
        <option value="Bronze">Bronze</option>
        <option value="Silver">Silver</option>
        <option value="Gold">Gold</option>
        <option value="Platinum">Platinum</option>
      </select>

      <!-- Blacklist Filter -->
      <select id="customerBlacklistFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer; height:37px;">
        <option value="">Alle Customers</option>
        <option value="false">Nicht Blacklisted</option>
        <option value="true">Blacklisted</option>
      </select>

      <!-- Total Bookings Filter -->
      <select id="customerBookingsFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer; height:37px;">
        <option value="">Alle Bookings</option>
        <option value="0">0 Bookings</option>
        <option value="1-2">1-2 Bookings</option>
        <option value="3-5">3-5 Bookings</option>
        <option value="6-10">6-10 Bookings</option>
        <option value="11+">11+ Bookings</option>
      </select>

      <!-- Clear Filters Button -->
      <button class="btn-secondary" onclick="clearCustomerFilters()" style="padding:10px 20px; background:rgba(0,0,0,0.05); border:1px solid rgba(0,0,0,0.1); border-radius:8px; cursor:pointer; white-space:nowrap; height:37px;">
        Filter zurÃ¼cksetzen
      </button>
    </div>

    <!-- Results Count -->
    <div style="font-size:14px; color:var(--muted); margin-bottom:16px;">
      <span id="customersResultCount" style="font-weight:600; color:var(--ink);">0</span> Customers gefunden
    </div>

    <table id="customersTable">
      <thead>
        <tr>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Instagram</th>
          <th>Rank</th>
          <th>Created</th>
          <th style="text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody id="customersTableBody"></tbody>
    </table>
  </section>

  <section id="analytics-section">
    <div class="tab-header">
      <h2 class="tab-header-title">Analytics</h2>
      <p class="tab-header-subtitle">Analysiere GeschÃ¤ftszahlen und Statistiken</p>
    </div>

    <!-- Filters -->
    <div class="analytics-filters">
      <select id="analyticsLocationFilter" class="filter-select">
        <option value="">All Locations</option>
        <!-- Will be populated dynamically -->
      </select>

      <select id="analyticsDateRangeFilter" class="filter-select">
        <option value="all">Alle ZeitrÃ¤ume</option>
        <option value="today">Heute</option>
        <option value="week">Diese Woche</option>
        <option value="month" selected>Dieser Monat</option>
        <option value="quarter">Dieses Quartal</option>
        <option value="year">Dieses Jahr</option>
        <option value="last30">Letzte 30 Tage</option>
        <option value="last90">Letzte 90 Tage</option>
        <option value="last365">Letztes Jahr</option>
      </select>

      <div style="display: flex; gap: 8px; align-items: center;">
        <label style="font-size: 13px; color: var(--muted);">Von:</label>
        <input type="date" id="analyticsStartDate" class="filter-select" style="min-width: 150px;">
        <label style="font-size: 13px; color: var(--muted);">Bis:</label>
        <input type="date" id="analyticsEndDate" class="filter-select" style="min-width: 150px;">
      </div>
    </div>

    <!-- Chart Grid -->
    <div class="charts-grid">

      <!-- Wrapper 1: Booking Sources & Artist Distribution -->
      <div class="chart-card" style="grid-column: 1 / -1;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">

          <!-- Booking Sources -->
          <div>
            <h3>Booking Sources</h3>
            <div style="position: relative; width: 100%; height: 400px;">
              <canvas id="bookingOriginsPie" style="width: 100%; height: 400px;"></canvas>
            </div>
          </div>

          <!-- Appointments nach Resident Artist -->
          <div>
            <h3>Appointments nach Resident Artist</h3>
            <canvas id="artistDistributionChart"></canvas>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 20px;">
              <div style="background: rgba(255,255,255,0.3); padding: 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05);">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Total Appointments</div>
                <div style="font-size: 16px; font-weight: 600;" id="artistTotalRequests">0</div>
              </div>
              <div style="background: rgba(255,255,255,0.3); padding: 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05);">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Umgesetzte Termine</div>
                <div style="font-size: 16px; font-weight: 600;" id="artistCompletedAppointments">0 (0%)</div>
              </div>
              <div style="background: rgba(255,255,255,0.3); padding: 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05);">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Nicht umgesetzt</div>
                <div style="font-size: 16px; font-weight: 600;" id="artistNotCompleted">0 (0%)</div>
              </div>
              <div style="background: rgba(255,255,255,0.3); padding: 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05);">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Beliebig</div>
                <div style="font-size: 16px; font-weight: 600;" id="artistAny">0 (0%)</div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Wrapper 2: Bookings Over Time & Requests/Appointments Overview -->
      <div class="chart-card" style="grid-column: 1 / -1;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">

          <!-- Bookings Over Time -->
          <div>
            <h3>Bookings Over Time</h3>

            <div style="position: relative; width: 100%; height: 400px; margin-top: 16px;">
              <canvas id="bookingsTimeline" style="width: 600px; height: 400px;"></canvas>
            </div>
          </div>

          <!-- Requests & Appointments Overview -->
          <div>
            <h3>Requests & Appointments Overview</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; padding: 20px;">
              <!-- Total Requests -->
              <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; background: rgba(0, 113, 227, 0.05); border-radius: 12px;">
                <div style="font-size: 14px; color: var(--muted); margin-bottom: 8px;">Total Requests</div>
                <div style="font-size: 56px; font-weight: 700; color: var(--accent);" id="requestsCount">0</div>
                <div style="font-size: 14px; color: var(--muted); margin-top: 8px;">Customer Requests</div>
              </div>
              <!-- Total Appointments -->
              <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; background: rgba(52, 199, 89, 0.05); border-radius: 12px;">
                <div style="font-size: 14px; color: var(--muted); margin-bottom: 8px;">Total Appointments</div>
                <div style="font-size: 56px; font-weight: 700; color: var(--success);" id="appointmentsCount">0</div>
                <div style="font-size: 14px; color: var(--muted); margin-top: 8px;">Scheduled Appointments</div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- REQUEST & APPOINTMENT STATUS BREAKDOWN CHARTS -->
      <div class="chart-card" style="grid-column: 1 / -1;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- Request Status Chart -->
          <div id="requestStatusChart"></div>

          <!-- Appointment Status Chart -->
          <div id="appointmentStatusChart"></div>
        </div>
      </div>

      <!-- REVENUE OVERVIEW & TIMELINE (Horizontal Layout) -->
      <div class="chart-card" style="grid-column: 1 / -1;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">

          <!-- Revenue Overview -->
          <div>
            <h3>Umsatz-Ãœbersicht</h3>
            <div style="display: flex; flex-direction: column; gap: 24px; padding: 20px;">
              <!-- Total Revenue -->
              <div style="text-align: center;">
                <div style="font-size: 13px; color: var(--muted); margin-bottom: 8px;">Gesamtumsatz</div>
                <div style="font-size: 48px; font-weight: 700; color: var(--accent);" id="totalRevenue">â‚¬0</div>
              </div>

              <!-- Revenue Stats Grid -->
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                <div style="text-align: center; padding: 16px; background: rgba(0, 113, 227, 0.05); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Bezahlte Projekte</div>
                  <div style="font-size: 24px; font-weight: 600; color: #0071e3;" id="paidProjects">0</div>
                </div>
                <div style="text-align: center; padding: 16px; background: rgba(255, 149, 0, 0.05); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Ausstehend</div>
                  <div style="font-size: 24px; font-weight: 600; color: #ff9500;" id="pendingRevenue">â‚¬0</div>
                </div>
                <div style="text-align: center; padding: 16px; background: rgba(52, 199, 89, 0.05); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Durchschnitt</div>
                  <div style="font-size: 24px; font-weight: 600; color: #34c759;" id="avgProjectPrice">â‚¬0</div>
                </div>
                <div style="text-align: center; padding: 16px; background: rgba(142, 142, 147, 0.05); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">Projekte</div>
                  <div style="font-size: 24px; font-weight: 600; color: #8e8e93;" id="totalProjects">0</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Revenue Timeline -->
          <div>
            <h3>Umsatz im Zeitverlauf</h3>
            <div style="position: relative; height: 400px;">
              <canvas id="revenueTimeline"></canvas>
            </div>
          </div>

        </div>
      </div>

      <!-- Revenue by Payment Status Chart (New Format) -->
      <div class="chart-card">
        <div id="revenueByPaymentStatusChart">
          <!-- Will be populated dynamically by loadRevenueByPaymentStatus() -->
        </div>
      </div>

      <!-- Revenue by Payment Status Card (Full Width) -->
      <div class="chart-card" style="grid-column: 1 / -1; width: 100%;">
        <h3>Umsatz nach Zahlungsstatus</h3>

        <!-- Revenue Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
          <div style="background: rgba(52, 199, 89, 0.05); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(52, 199, 89, 0.2);">
            <div style="font-size: 28px; margin-bottom: 8px;">ðŸ’°</div>
            <div style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 8px;">Komplett Bezahlt</div>
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 4px;" id="paidAmount">0,00 â‚¬</div>
            <div style="font-size: 13px; color: var(--muted);" id="paidCount">0 Projekte</div>
          </div>
          <div style="background: rgba(255, 149, 0, 0.05); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(255, 149, 0, 0.2);">
            <div style="font-size: 28px; margin-bottom: 8px;">â³</div>
            <div style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 8px;">Offen</div>
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 4px;" id="pendingAmount">0,00 â‚¬</div>
            <div style="font-size: 13px; color: var(--muted);" id="pendingCount">0 Projekte</div>
          </div>
          <div style="background: rgba(0, 113, 227, 0.05); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(0, 113, 227, 0.2);">
            <div style="font-size: 28px; margin-bottom: 8px;">ðŸ’³</div>
            <div style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 8px;">Anzahlung Bezahlt</div>
            <div style="font-size: 24px; font-weight: 600; margin-bottom: 4px;" id="partialAmount">0,00 â‚¬</div>
            <div style="font-size: 13px; color: var(--muted);" id="partialCount">0 Projekte</div>
          </div>
        </div>

        <!-- Revenue Bar Chart -->
        <div style="position: relative; height: 500px; margin-bottom: 24px;">
          <canvas id="revenueByStatusChart"></canvas>
        </div>

        <!-- Revenue Details Table -->
        <table class="data-table">
          <thead>
            <tr>
              <th>Payment Status</th>
              <th style="text-align: right;">Anzahl Projekte</th>
              <th style="text-align: right;">Gesamt Umsatz</th>
              <th style="text-align: right;">Durchschnitt</th>
              <th style="text-align: right;">% vom Gesamt</th>
            </tr>
          </thead>
          <tbody id="revenueByStatusTable"></tbody>
          <tfoot>
            <tr style="border-top: 2px solid rgba(0,0,0,0.1); background: rgba(0,0,0,0.02);">
              <td><strong>Gesamt</strong></td>
              <td style="text-align: right;"><strong id="revenueTotalProjects">0</strong></td>
              <td style="text-align: right;"><strong id="revenueTotalAmount">0,00 â‚¬</strong></td>
              <td style="text-align: right;"><strong id="revenueAvgAmount">0,00 â‚¬</strong></td>
              <td style="text-align: right;"><strong>100%</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>

    </div>

    <!-- PROJECT-BASED ANALYTICS -->
    <div class="dashboard-section" style="margin-top: 48px;">
      <h2>ðŸ“ˆ Project Analytics</h2>

      <!-- Project KPI Summary -->
      <div id="analyticsProjectKPIs" class="kpi-grid" style="margin-bottom: 32px;"></div>

      <!-- Project Charts -->
      <div class="charts-grid">
        <div class="chart-card">
          <canvas id="projectsTimelineChart"></canvas>
        </div>
        <div class="chart-card">
          <canvas id="revenueByMonthChart"></canvas>
        </div>
        <div class="chart-card">
          <canvas id="topArtistsChart"></canvas>
        </div>
      </div>
    </div>

    <!-- ARTIST PERFORMANCE REPORT -->
    <div class="dashboard-section" style="margin-top: 32px;">
      <h2>ðŸŽ¨ Artist Performance</h2>
      <div id="artistPerformanceTable"></div>
    </div>

    <!-- MULTI-PROJECT CUSTOMERS (VIP) -->
    <div class="dashboard-section" style="margin-top: 32px;">
      <h2>ðŸ‘¥ VIP Customers (Multi-Project Customers)</h2>
      <div id="multiProjectCustomersTable"></div>
    </div>

  </section>

  <!-- ============================================ -->
  <!-- GUEST SPOTS SECTION -->
  <!-- ============================================ -->
  <section id="guestspots-section">
    <div class="tab-header">
      <h2 class="tab-header-title">Guest Spots</h2>
      <p class="tab-header-subtitle">Verwalte Gastartist-Termine und VerfÃ¼gbarkeiten</p>
    </div>

    <!-- Add Slot Button + Location Dropdown + Toggle + Search Bar in One Row -->
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:24px;">
      <!-- Location Dropdown -->
      <select id="waitlistLocationFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer; height:37px;">
        <option value="all">All Locations</option>
        <!-- Locations will be loaded dynamically -->
      </select>

      <!-- View Toggle Button (List / Month / Year) - Hidden on Mobile -->
      <button id="guestspotViewToggleBtn" onclick="toggleGuestspotView()" class="guestspot-view-toggle-btn" style="
        padding:8px 12px;
        border:1px solid rgba(0,0,0,0.1);
        border-radius:8px;
        background:white;
        cursor:pointer;
        color:#1d1d1f;
        font-size:14px;
        height:37px;
        display:flex;
        align-items:center;
        gap:6px;
        transition:all 0.2s;
      " onmouseover="this.style.background='#f5f5f7';" onmouseout="this.style.background='white';">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <span id="guestspotViewLabel">List</span>
      </button>

      <!-- Create Guest Spot Button (for Upcoming - Artists with dates) -->
      <button id="createGuestSpotBtnWaitlist" onclick="openCreateGuestSpotModal()" style="
        padding:10px 20px;
        border:none;
        border-radius:8px;
        background:#1d1d1f;
        color:#fff;
        font-size:14px;
        font-weight:500;
        cursor:pointer;
        display:flex;
        align-items:center;
        gap:8px;
        transition:all 0.2s;
        height:37px;
        white-space:nowrap;
      " onmouseover="this.style.background='#333';" onmouseout="this.style.background='#1d1d1f';">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        Create Guest Spot
      </button>

      <!-- Add Previous Spot Button (for Previous Guest Spots - initially hidden) -->
      <button id="addPreviousSpotButton" onclick="openAddPreviousSpotModal()" class="btn-nav" style="background:#1d1d1f; color:white; display:none; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap; height:37px;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Add Previous</span>
      </button>

      <div id="waitlistTypeToggle" style="display:inline-flex; background:rgba(142, 142, 147, 0.12); border-radius:10px; padding:3px; gap:2px; flex-wrap:wrap;">
        <button class="list-toggle-option active" data-list-type="upcoming" style="position:relative; padding:8px 14px; border:none; background:white; color:#1d1d1f; font-weight:600; font-size:13px; cursor:pointer; border-radius:8px; transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1); box-shadow:0 2px 4px rgba(0,0,0,0.08); display:flex; align-items:center; gap:6px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Upcoming
        </button>
        <button class="list-toggle-option" data-list-type="active" style="position:relative; padding:8px 14px; border:none; background:transparent; color:#86868b; font-weight:600; font-size:13px; cursor:pointer; border-radius:8px; transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1); display:flex; align-items:center; gap:6px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          Active
        </button>
        <button class="list-toggle-option" data-list-type="previous" style="position:relative; padding:8px 14px; border:none; background:transparent; color:#86868b; font-weight:600; font-size:13px; cursor:pointer; border-radius:8px; transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1); display:flex; align-items:center; gap:6px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
          Previous
        </button>
        <button class="list-toggle-option" data-list-type="canceled" style="position:relative; padding:8px 14px; border:none; background:transparent; color:#86868b; font-weight:600; font-size:13px; cursor:pointer; border-radius:8px; transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1); display:flex; align-items:center; gap:6px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
          Canceled
        </button>
      </div>

      <!-- Search Bar (fills remaining width) -->
      <div style="position:relative; flex:1;">
        <svg style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:16px; height:16px; pointer-events:none;" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="waitlistSearchInput" placeholder="Search guest artists..." style="width:100%; padding:12px 16px 12px 42px; font-size:15px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; height:37px; box-sizing:border-box;">
      </div>
    </div>

    <!-- List Type Description -->
    <p id="listTypeDescription" style="color:var(--muted); font-size:13px; margin:0 0 16px 0;">
      Artists with confirmed booking dates
    </p>

    <!-- Location Filter removed - now using dropdown above -->

    <!-- Active Slots Display -->
    <div id="waitlistSlotsContainer">
      <!-- Slots will be rendered here -->
    </div>

    <!-- Month View Container (initially hidden) -->
    <div id="guestspotMonthViewContainer" style="display:none;">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px;">
        <button onclick="changeGuestspotMonth(-1)" style="padding:8px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; background:white; cursor:pointer; font-size:14px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <h3 id="guestspotMonthTitle" style="margin:0; font-size:20px; font-weight:600;"></h3>
        <button onclick="changeGuestspotMonth(1)" style="padding:8px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; background:white; cursor:pointer; font-size:14px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </button>
      </div>
      <div id="guestspotMonthGrid" style="display:grid; grid-template-columns:repeat(7, 1fr); gap:4px;"></div>
    </div>

    <!-- Year View Container (initially hidden) - PHASE 7: Dienstplan Style -->
    <div id="guestspotYearViewContainer" class="guestspot-year-view" style="display:none;">
      <!-- Year View Header with Navigation -->
      <div class="guestspot-year-view-header">
        <div class="guestspot-year-navigation">
          <button onclick="changeGuestspotYear(-1)" style="padding:8px 16px; border:1px solid var(--border-color, rgba(0,0,0,0.1)); border-radius:8px; background:var(--macos-elevated, white); cursor:pointer; font-size:14px; color:var(--ink);">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
          </button>
          <span id="guestspotYearTitle" class="guestspot-year-label"></span>
          <button onclick="changeGuestspotYear(1)" style="padding:8px 16px; border:1px solid var(--border-color, rgba(0,0,0,0.1)); border-radius:8px; background:var(--macos-elevated, white); cursor:pointer; font-size:14px; color:var(--ink);">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
          </button>
        </div>
        <div style="display:flex; gap:8px; font-size:12px; color:var(--muted);">
          <span style="display:flex; align-items:center; gap:4px;">
            <span style="width:12px; height:12px; background:#34C759; border-radius:2px;"></span> Bezahlt
          </span>
          <span style="display:flex; align-items:center; gap:4px;">
            <span style="width:12px; height:12px; background:#FF3B30; border-radius:2px;"></span> Unbezahlt
          </span>
        </div>
      </div>

      <!-- Months Header Row (Jan-Dec) -->
      <div class="guestspot-year-months-header">
        <div class="guestspot-artist-column-header">Artist</div>
        <div class="guestspot-month-header">Jan</div>
        <div class="guestspot-month-header">Feb</div>
        <div class="guestspot-month-header">MÃ¤r</div>
        <div class="guestspot-month-header">Apr</div>
        <div class="guestspot-month-header">Mai</div>
        <div class="guestspot-month-header">Jun</div>
        <div class="guestspot-month-header">Jul</div>
        <div class="guestspot-month-header">Aug</div>
        <div class="guestspot-month-header">Sep</div>
        <div class="guestspot-month-header">Okt</div>
        <div class="guestspot-month-header">Nov</div>
        <div class="guestspot-month-header">Dez</div>
      </div>

      <!-- Grid with Artists and their Spots per Month -->
      <div class="guestspot-year-grid-container" id="guestspotYearGrid">
        <!-- Will be dynamically populated -->
      </div>
    </div>

    <!-- Empty State -->
    <div id="waitlistEmptyState" style="display:none; text-align:center; padding:80px 20px; color:var(--muted);">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 16px; opacity:0.3;">
        <path d="M9 11l3 3L22 4"></path>
        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
      </svg>
      <h3 style="margin:0 0 8px 0; color:#1d1d1f;">No Guest Artists Scheduled</h3>
      <p style="margin:0 0 24px 0;">Click "Add Slot" to schedule a guest artist</p>
    </div>
  </section>

  <!-- ============================================ -->
  <!-- WAITLIST SECTION (Eigener Head Tab) -->
  <!-- ============================================ -->
  <section id="waitlist-section">
    <div class="tab-header">
      <h2 class="tab-header-title">Waitlist</h2>
      <p class="tab-header-subtitle">Verwalte die Warteliste fÃ¼r die wichtigsten Artists</p>
    </div>

    <!-- Waitlist Controls Row -->
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:24px;">
      <!-- Location Dropdown -->
      <select id="waitlistOnlyLocationFilter" class="filter-select" style="padding:10px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; background:white; cursor:pointer; height:37px;">
        <option value="all">All Locations</option>
        <!-- Locations will be loaded dynamically -->
      </select>

      <!-- Add Waitlist Spot Button -->
      <button id="addWaitlistSlotButtonMain" onclick="openAddWaitlistSlotModal()" class="btn-nav" style="background:#1d1d1f; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap; height:37px; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        <span>Add Waitlist Spot</span>
      </button>

      <!-- Search Bar -->
      <div style="position:relative; flex:1;">
        <svg style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:16px; height:16px; pointer-events:none;" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="waitlistOnlySearchInput" placeholder="Search waitlist artists..." style="width:100%; padding:12px 16px 12px 42px; font-size:15px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; height:37px; box-sizing:border-box;">
      </div>
    </div>

    <!-- Waitlist Description -->
    <p style="color:var(--muted); font-size:13px; margin:0 0 16px 0;">
      KÃ¼nstler auf der Warteliste - noch ohne feste Buchungsdaten
    </p>

    <!-- Waitlist Slots Container -->
    <div id="waitlistOnlySlotsContainer">
      <!-- Waitlist slots will be rendered here -->
    </div>

    <!-- Waitlist Empty State -->
    <div id="waitlistOnlyEmptyState" style="display:none; text-align:center; padding:80px 20px; color:var(--muted);">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 16px; opacity:0.3;">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
      <h3 style="margin:0 0 8px 0; color:#1d1d1f;">Keine Artists auf der Warteliste</h3>
      <p style="margin:0 0 24px 0;">Klicke "Add Waitlist Spot" um einen Artist zur Warteliste hinzuzufÃ¼gen</p>
    </div>
  </section>

  <section id="agreements-section">
    <div class="tab-header">
      <h2 class="tab-header-title">Agreements</h2>
      <p class="tab-header-subtitle">Verwalte VertrÃ¤ge und Vereinbarungen</p>
    </div>

    <!-- Agreements List Section -->
    <div style="margin-top:48px;">
      <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
        <h2 style="margin:0; font-size:22px; font-weight:600;">Today's Agreements</h2>
        <div id="agreementsDateDisplay" style="font-weight:600; font-size:22px; color:var(--ink);"></div>
      </div>
      
      <div class="calendar-controls" style="margin-bottom:24px;">
        <button id="agreementsPrevDayBtn" class="btn-nav">â€¹ Prev</button>
        <input type="date" id="agreementsDatePickerInput">
        <button id="agreementsTodayBtn" class="btn-nav">Today</button>
        <button id="agreementsNextDayBtn" class="btn-nav">Next â€º</button>
      </div>
      
      <table id="agreementsTable">
        <thead>
          <tr>
            <th>Customer Name</th>
            <th>Email</th>
            <th>Artist</th>
            <th>Time</th>
            <th style="text-align:center;">Signed</th>
          </tr>
        </thead>
        <tbody id="agreementsTableBody"></tbody>
      </table>
    </div>
  </section>

  <section id="profile-section">
    <div style="max-width: 800px; margin: 0 auto;">
      <h2 style="margin-bottom: 32px;">Profil</h2>

      <!-- Profile Header -->
      <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 48px; padding: 32px; background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <img id="profilePageAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23ddd'/%3E%3Ctext x='50' y='65' text-anchor='middle' font-size='40' fill='%23666'%3EðŸ‘¤%3C/text%3E%3C/svg%3E" alt="Profilbild" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #f5f5f7; margin-bottom: 20px;">
        <h2 id="profilePageName" style="margin: 0 0 8px 0; font-size: 28px; font-weight: 600;">Username</h2>
        <span id="profilePageRoleBadge" class="profile-role-badge" style="font-size: 13px; padding: 6px 16px; border-radius: 999px; background: #f5f5f7; color: var(--ink); font-weight: 600;">USER</span>
      </div>

      <!-- Profile Information Cards -->
      <div style="display: grid; gap: 24px;">

        <!-- Account Info Card -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;">Account Information</h3>

          <div style="display: grid; gap: 16px;">
            <div>
              <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Benutzername</label>
              <div id="profilePageUsername" style="font-size: 15px; font-weight: 500;">â€”</div>
            </div>

            <div>
              <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Rolle</label>
              <div id="profilePageRoleText" style="font-size: 15px; font-weight: 500;">â€”</div>
            </div>

            <div>
              <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Passwort</label>
              <div style="display: flex; gap: 12px; align-items: center;">
                <span id="profilePagePassword">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                <button type="button" class="btn btn-secondary" onclick="showPasswordChangeFormPage()" style="font-size: 13px; padding: 6px 12px;">Ã„ndern</button>
              </div>
            </div>
          </div>

          <!-- Password Change Form (Hidden by default) -->
          <div id="profilePagePasswordChangeForm" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid #eee;">
            <h4 style="margin: 0 0 16px 0; font-size: 16px;">Passwort Ã¤ndern</h4>
            <div style="display: grid; gap: 12px;">
              <div>
                <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Neues Passwort</label>
                <input type="password" id="profilePageNewPassword" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
              </div>
              <div>
                <label style="font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;">Passwort bestÃ¤tigen</label>
                <input type="password" id="profilePageConfirmPassword" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
              </div>
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button type="button" class="btn btn-secondary" onclick="hidePasswordChangeFormPage()" style="flex: 1;">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="changePasswordPage()" style="flex: 1;">Speichern</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Avatar Card -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
          <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;">Profilbild</h3>

          <!-- Current Avatar Preview -->
          <div id="profilePageCurrentAvatarPreview" style="text-align: center; margin-bottom: 24px;">
            <img id="profilePageCurrentAvatarImg" src="" alt="Aktuelles Profilbild" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #f5f5f7;">
          </div>

          <!-- Drag & Drop Zone -->
          <div
            id="profilePageAvatarDropZone"
            style="border: 2px dashed #d1d5db; border-radius: 12px; padding: 40px 20px; text-align: center; background: #f9fafb; cursor: pointer; transition: all 0.3s; margin-bottom: 20px;"
            ondragover="handleProfileDragOver(event)"
            ondragleave="handleProfileDragLeave(event)"
            ondrop="handleProfileDrop(event)"
            onclick="document.getElementById('profilePageAvatarFileInput').click()">
            <div style="font-size: 48px; margin-bottom: 12px;">ðŸ“¸</div>
            <div style="font-size: 16px; font-weight: 500; color: var(--ink); margin-bottom: 8px;">
              Bild hier ablegen oder klicken
            </div>
            <div style="font-size: 13px; color: var(--muted);">
              PNG, JPG oder GIF (max. 5MB)
            </div>
          </div>

          <!-- Hidden File Input -->
          <input
            type="file"
            id="profilePageAvatarFileInput"
            accept="image/*"
            style="display: none;"
            onchange="handleProfileFileSelect(event)">

          <!-- Preview Selected Image -->
          <div id="profilePageAvatarPreviewContainer" style="display: none; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 14px; font-weight: 500; color: var(--ink); margin-bottom: 12px;">Vorschau:</div>
            <img id="profilePageAvatarPreview" src="" alt="Vorschau" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent);">
            <div id="profilePageAvatarFileName" style="font-size: 13px; color: var(--muted); margin-top: 8px;"></div>
          </div>

          <!-- Upload Progress -->
          <div id="profilePageUploadProgress" style="display: none; margin-bottom: 20px;">
            <div style="font-size: 13px; color: var(--muted); margin-bottom: 8px;">Uploading...</div>
            <div style="background: #e5e7eb; border-radius: 999px; height: 8px; overflow: hidden;">
              <div id="profilePageUploadProgressBar" style="background: var(--accent); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
          </div>

          <button type="button" class="btn btn-primary" id="profilePageUploadAvatarBtn" onclick="uploadAvatarFromProfilePage()" disabled style="width: 100%; opacity: 0.5;">Hochladen</button>
        </div>

        <!-- Logout Button -->
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
          <button type="button" class="btn btn-danger" onclick="logout()" style="width: 100%;">Abmelden</button>
        </div>

      </div>
    </div>
  </section>

  <!-- ==========================================
       WANNADOS SECTION
       ========================================== -->
  <section id="wannados-section" style="display:none;">
    <!-- Header Row -->
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:24px; flex-wrap:wrap; gap:16px;">
      <div class="tab-header" style="margin-bottom: 0;">
        <h2 class="tab-header-title">Wannados</h2>
        <p class="tab-header-subtitle">Verwalte Flash-Designs und spontane Tattoo-Motive</p>
      </div>
      <button onclick="window.openCreateCollectionModal()" style="padding:12px 24px; background:#333; color:white; border:none; border-radius:8px; font-size:14px; font-weight:500; cursor:pointer; font-family:inherit;">
        + Neue Collection
      </button>
    </div>

    <!-- Search & Filter Row -->
    <div style="display:flex; gap:12px; margin-bottom:24px; flex-wrap:wrap;">
      <!-- Searchbar -->
      <div style="flex:1; min-width:200px;">
        <input type="text" id="wannadoSearchInput" placeholder="Collection oder Wannado suchen..."
          oninput="window.filterWannadoCollections()"
          style="width:100%; padding:12px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; font-family:inherit; box-sizing:border-box;">
      </div>

      <!-- Artist Filter -->
      <select id="wannadoArtistFilter" onchange="window.filterWannadoCollections()"
        style="padding:12px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; font-family:inherit; background:white; min-width:150px; cursor:pointer;">
        <option value="all">Alle Artists</option>
      </select>

      <!-- Date Sort -->
      <select id="wannadoDateFilter" onchange="window.filterWannadoCollections()"
        style="padding:12px 16px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; font-family:inherit; background:white; min-width:150px; cursor:pointer;">
        <option value="newest">Neueste zuerst</option>
        <option value="oldest">Ã„lteste zuerst</option>
      </select>
    </div>

    <!-- Collections List -->
    <div id="wannadoCollectionsList" style="display:flex; flex-direction:column; gap:24px;">
      <!-- Collections werden hier geladen -->
    </div>
  </section>

  <!-- Create Collection Modal -->
  <div id="createCollectionModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:16px; max-width:700px; width:90%; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <div style="padding:24px; border-bottom:1px solid rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-size:20px; font-weight:600;">Neue Wannado Collection</h3>
        <button onclick="window.closeCreateCollectionModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#86868b;">&times;</button>
      </div>
      <form id="createCollectionForm" onsubmit="window.saveCollection(event)" style="padding:24px;">
        <div style="margin-bottom:24px;">
          <h4 style="font-size:12px; font-weight:600; color:#86868b; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:16px;">Artist auswÃ¤hlen *</h4>
          <div id="collectionArtistGrid" style="display:grid; grid-template-columns:repeat(5, 1fr); gap:12px;"></div>
          <input type="hidden" id="collectionArtistId" required>
        </div>
        <div style="margin-bottom:24px;">
          <label style="display:block; font-size:14px; font-weight:500; margin-bottom:8px;">Collection Name (optional)</label>
          <input type="text" id="collectionName" placeholder="z.B. Winter Flash, Sommer Motive..." style="width:100%; padding:12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; box-sizing:border-box;">
        </div>
        <div style="margin-bottom:24px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h4 style="font-size:12px; font-weight:600; color:#86868b; text-transform:uppercase; letter-spacing:0.5px; margin:0;">Wannados</h4>
            <button type="button" onclick="window.addWannadoRow()" style="padding:8px 16px; background:rgba(0,113,227,0.1); color:#0071e3; border:none; border-radius:6px; font-size:13px; cursor:pointer;">+ Wannado</button>
          </div>
          <div id="wannadoRowsContainer"></div>
        </div>
        <div style="display:flex; gap:12px; justify-content:flex-end; padding-top:16px; border-top:1px solid rgba(0,0,0,0.1);">
          <button type="button" onclick="window.closeCreateCollectionModal()" style="padding:12px 24px; background:#f5f5f7; color:#1d1d1f; border:none; border-radius:8px; font-size:14px; cursor:pointer;">Abbrechen</button>
          <button type="submit" id="saveCollectionBtn" style="padding:12px 24px; background:#333; color:white; border:none; border-radius:8px; font-size:14px; cursor:pointer; font-family:inherit;">Collection speichern</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Wannado Modal -->
  <div id="editWannadoModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:16px; max-width:500px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <div style="padding:24px; border-bottom:1px solid rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-size:20px; font-weight:600;">Wannado bearbeiten</h3>
        <button onclick="window.closeEditWannadoModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#86868b;">&times;</button>
      </div>
      <form id="editWannadoForm" onsubmit="window.updateWannado(event)" style="padding:24px;">
        <input type="hidden" id="editWannadoId">
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:500; margin-bottom:8px;">Name *</label>
          <input type="text" id="editWannadoName" required style="width:100%; padding:12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; box-sizing:border-box;">
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
          <div>
            <label style="display:block; font-size:14px; font-weight:500; margin-bottom:8px;">Preis (â‚¬) *</label>
            <input type="number" id="editWannadoPrice" min="1" step="0.01" required style="width:100%; padding:12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; box-sizing:border-box;">
          </div>
          <div>
            <label style="display:block; font-size:14px; font-weight:500; margin-bottom:8px;">Dauer (h) *</label>
            <input type="number" id="editWannadoDuration" min="0.5" step="0.5" required style="width:100%; padding:12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; box-sizing:border-box;">
          </div>
        </div>
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:500; margin-bottom:8px;">Bild</label>
          <div id="editWannadoImagePreview" style="width:100%; height:150px; border:2px dashed rgba(0,0,0,0.15); border-radius:8px; display:flex; align-items:center; justify-content:center; background:#f8f9fa; margin-bottom:8px; overflow:hidden;">
            <span style="color:#86868b;">Kein Bild</span>
          </div>
          <input type="file" id="editWannadoImage" accept="image/*" onchange="window.previewEditWannadoImage(event)" style="width:100%;">
        </div>
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:500; margin-bottom:8px;">Status</label>
          <select id="editWannadoStatus" style="width:100%; padding:12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
            <option value="available">VerfÃ¼gbar</option>
            <option value="inactive">Inaktiv</option>
            <option value="sold">Verkauft</option>
          </select>
        </div>
        <div style="display:flex; gap:12px; justify-content:space-between; padding-top:16px; border-top:1px solid rgba(0,0,0,0.1);">
          <button type="button" onclick="window.deleteWannadoFromEdit()" style="padding:12px 24px; background:#ff3b30; color:white; border:none; border-radius:8px; font-size:14px; cursor:pointer;">LÃ¶schen</button>
          <div style="display:flex; gap:12px;">
            <button type="button" onclick="window.closeEditWannadoModal()" style="padding:12px 24px; background:#f5f5f7; color:#1d1d1f; border:none; border-radius:8px; font-size:14px; cursor:pointer;">Abbrechen</button>
            <button type="submit" style="padding:12px 24px; background:#0071e3; color:white; border:none; border-radius:8px; font-size:14px; cursor:pointer;">Speichern</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Account Settings View -->
  <section id="accountSettings-section" style="display: none; padding: 0; margin-top: 110px;">
    <div class="settings-view">
      <!-- Account Settings Top Section -->
      <div class="account-settings-header">
        <h1 class="account-settings-title" id="mainTitle">Account Activity</h1>
      </div>

      <!-- Settings Content Wrapper (Sidebar + Content) -->
      <div class="settings-content-wrapper">
        <!-- Settings Sidebar -->
        <div class="settings-sidebar">
          <div class="search-container">
            <input type="text" class="search-input" placeholder="Search...">
          </div>

          <ul class="sidebar-nav">
            <li class="nav-item active" data-section="activity">Activity</li>
            <li class="nav-item" data-section="avatar">Avatar</li>
            <li class="nav-item" data-section="user-info">User Information</li>
            <li class="nav-item" data-section="notifications">Notifications</li>
            <li class="nav-item" data-section="statistics">Statistics</li>
          </ul>
        </div>

        <!-- Settings Content -->
        <div class="settings-content">
          <!-- Settings Main Content -->
          <div class="settings-main-content">
            <!-- Activity Tab Content -->
            <div class="tab-content active" id="activityTab">
              <div class="activity-list">
                <div class="activity-item">
                  <div class="activity-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="activity-details">
                    <div class="activity-title">Logged in from Stuttgart, Germany</div>
                    <div class="activity-description">You successfully signed in to your account from a new device.</div>
                    <div class="activity-time">2 hours ago</div>
                  </div>
                </div>

                <div class="activity-item">
                  <div class="activity-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 16V12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M12 8H12.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="activity-details">
                    <div class="activity-title">Profile updated</div>
                    <div class="activity-description">You changed your notification preferences.</div>
                    <div class="activity-time">1 day ago</div>
                  </div>
                </div>

                <div class="activity-item">
                  <div class="activity-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="activity-details">
                    <div class="activity-title">Password changed</div>
                    <div class="activity-description">You successfully updated your account password.</div>
                    <div class="activity-time">3 days ago</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Settings Tab Content -->
            <div class="tab-content" id="settingsTab">
              <!-- Avatar Card -->
              <div class="settings-card">
                <div class="card-section">
                  <h3 class="section-title">Avatar</h3>
                  <p class="section-description">
                    This is your avatar.<br>
                    Click on the avatar to upload a custom one from your files.
                  </p>

                  <div class="avatar-container">
                    <div class="avatar-display" id="avatarDisplay" onclick="document.getElementById('avatarUpload').click()">
                      <!-- Gradient background by default -->
                    </div>

                    <div class="avatar-actions">
                      <button class="btn btn-primary" onclick="document.getElementById('avatarUpload').click()">
                        Upload
                      </button>
                      <button class="btn btn-danger" id="deleteAvatarBtn">
                        Delete
                      </button>
                    </div>
                  </div>

                  <input type="file" id="avatarUpload" accept="image/*">

                  <p class="section-description" style="margin-top: 16px; margin-bottom: 0;">
                    An avatar is optional but strongly recommended.
                  </p>
                </div>
              </div>

              <!-- User Information Card -->
              <div class="settings-card">
                <div class="card-section">
                  <h3 class="section-title">User Information</h3>
                  <p class="section-description">
                    Your username and role are managed by your administrator.
                  </p>

                  <div class="info-grid">
                    <div class="info-field">
                      <label class="field-label">Username</label>
                      <div class="field-value" id="usernameDisplay">david.mueller</div>
                    </div>

                    <div class="info-field">
                      <label class="field-label">Role</label>
                      <div class="field-value" id="roleDisplay">Management</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Notifications Card -->
              <div class="settings-card">
                <div class="card-section">
                  <h3 class="section-title">Notifications</h3>
                  <p class="section-description">
                    Manage how you receive notifications about your account.
                  </p>

                  <div class="input-group">
                    <label class="input-label" for="phoneInput">Phone Number</label>
                    <input
                      type="tel"
                      id="phoneInput"
                      class="input-field"
                      placeholder="+49 123 456789"
                      value=""
                    >
                    <p class="input-helper">We'll use this to send you SMS notifications.</p>
                  </div>

                  <div class="input-group">
                    <label class="input-label" for="emailInput">Email Address</label>
                    <input
                      type="email"
                      id="emailInput"
                      class="input-field"
                      placeholder="your.email@example.com"
                      value=""
                    >
                    <p class="input-helper">Primary email for account notifications.</p>
                  </div>

                  <div class="save-container">
                    <button class="btn btn-primary" id="saveNotificationsBtn">
                      Save Changes
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Add Artist Modal -->
  <div class="modal-backdrop" id="addArtistModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3>Add New Artist</h3>
      <form class="modal-form" id="addArtistForm">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="addArtistName" required placeholder="Artist name">
        </div>
        <div class="form-group">
          <label>Instagram Handle</label>
          <input type="text" id="addArtistInstagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="addArtistType">
            <option value="resident">Resident</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        <div class="form-group">
          <label>Location</label>
          <select id="addArtistLocation" required>
            <option value="">-- Select Location --</option>
          </select>
        </div>
        <div class="form-group">
          <label>City Location</label>
          <select id="addArtistCityLocation" required>
            <option value="">-- Select Location --</option>
            <option value="Stuttgart">Stuttgart</option>
            <option value="KÃ¶ln">KÃ¶ln</option>
            <option value="MÃ¼nchen">MÃ¼nchen</option>
            <option value="Berlin">Berlin</option>
          </select>
        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="addArtistRank" required>
            <option value="">-- Select Rank --</option>
            <option value="Friends">Friends (70/30)</option>
            <option value="Crew">Crew (75/25)</option>
            <option value="Fam">Fam (80/20)</option>
            <option value="VIP">VIP (80/20)</option>
          </select>
        </div>
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="addArtistActive" checked>
            Active
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelAddArtist">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Artist</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Artist Modal -->
  <div class="modal-backdrop" id="editArtistModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3>Edit Artist</h3>
      <form class="modal-form" id="editArtistForm">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="editArtistName" required>
        </div>
        <div class="form-group">
          <label>Instagram Handle</label>
          <input type="text" id="editArtistInstagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="editArtistType">
            <option value="resident">Resident</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        <div class="form-group">
          <label>Location</label>
          <select id="editArtistLocation">
            <option value="">-- Select Location --</option>
            <option value="Stuttgart">Stuttgart</option>
            <option value="KÃ¶ln">KÃ¶ln</option>
            <option value="Berlin">Berlin</option>
            <option value="MÃ¼nchen">MÃ¼nchen</option>
          </select>
        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="editArtistRank">
            <option value="">-- No Rank --</option>
            <option value="Friends">Friends (70/30)</option>
            <option value="Crew">Crew (75/25)</option>
            <option value="Fam">Fam (80/20)</option>
            <option value="VIP">VIP (80/20)</option>
          </select>
        </div>
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="editArtistActive" style="width:auto; padding:0;">
            Active
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelEditArtist">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Artist Profile Modal -->
  <div class="modal-backdrop" id="viewArtistProfileModal">
    <div class="modal" style="max-width:700px; max-height:90vh; overflow-y:auto;">
      <h3 style="color:var(--macos-text-primary); font-weight:500; margin-bottom:24px;">Artist Profile</h3>
      <div id="viewArtistProfileContent" style="padding:0;">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div class="modal-actions" style="display:flex; justify-content:space-between; margin-top:24px; gap:8px;">
        <button type="button" class="btn btn-danger" id="deleteArtistFromProfileBtn" style="margin-right:auto;">Delete</button>
        <div style="display:flex; gap:8px;">
          <button type="button" class="btn btn-secondary" onclick="closeViewProfile()">Close</button>
          <button type="button" class="btn btn-primary" id="editArtistFromProfileBtn">Edit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assign Team Member Modal -->
  <div class="modal-backdrop" id="assignModal">
    <div class="modal">
      <h3 style="color:var(--ink); font-weight:500;">Assign to Team Member</h3>
      <form class="modal-form" id="assignForm">
        <div class="form-group">
          <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Team Member</label>
          <select id="assignTeamMember" required>
            <option value="">-- LÃ¤dt Team... --</option>
            <!-- Wird dynamisch durch assignRequest() gefÃ¼llt -->
          </select>
        </div>
        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelAssign" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Assign</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Schedule Appointment Modal -->
  <div class="modal-backdrop" id="scheduleModal">
    <div class="modal">
      <h3 style="color:var(--ink); font-weight:500;">Schedule Appointment</h3>
      <form class="modal-form" id="scheduleForm">
        <div class="form-group">
          <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Artist</label>
          <select id="scheduleArtist" required>
            <option value="">-- Select Artist --</option>
          </select>
        </div>
        <div class="form-group">
          <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Date</label>
          <input type="date" id="scheduleDate" required>
        </div>
        <div class="form-group">
          <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Start Time</label>
          <select id="scheduleStartTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="form-group">
          <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">End Time</label>
          <select id="scheduleEndTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelSchedule" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Request Modal -->
  <div class="modal-backdrop" id="editRequestModal">
    <div class="modal" style="max-width:700px; max-height:90vh; overflow-y:auto;">
      <h3 style="color:var(--ink); font-weight:500;">Edit Request</h3>
      <form class="modal-form" id="editRequestForm" style="max-height:calc(90vh - 150px); overflow-y:auto;">

        <!-- Customer Information -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:1rem; font-weight:600; margin-bottom:12px; color:#1d1d1f;">Customer Information</h4>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Vorname</label>
            <input type="text" id="editFirstName" required>
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Nachname</label>
            <input type="text" id="editLastName" required>
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Email</label>
            <input type="email" id="editEmail" required>
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Phone</label>
            <input type="tel" id="editPhone" required>
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Instagram</label>
            <input type="text" id="editInstagram" placeholder="@username">
          </div>
        </div>

        <!-- Request Details -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:1rem; font-weight:600; margin-bottom:12px; color:#1d1d1f;">Request Details</h4>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Priority</label>
            <select id="editPriority">
              <option value="">-- Select Priority --</option>
              <option value="low">Low ðŸ’¤</option>
              <option value="normal">Normal âœ“</option>
              <option value="high">High âš¡</option>
              <option value="urgent">Urgent ðŸ”¥</option>
            </select>
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Placement</label>
            <input type="text" id="editPlacement">
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Size</label>
            <input type="text" id="editSize">
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Style</label>
            <input type="text" id="editStyle">
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Colorway</label>
            <input type="text" id="editColorway">
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Description</label>
            <textarea id="editDescription" rows="4"></textarea>
          </div>
        </div>

        <!-- Artist Assignment -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:1rem; font-weight:600; margin-bottom:12px; color:#1d1d1f;">Artist Assignment</h4>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Search Artist</label>
            <input type="text" id="editArtistSearch" placeholder="Type to search artists...">
            <div id="editArtistSearchResults" style="display:none; max-height:200px; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); border-radius:8px; margin-top:8px; background:white;"></div>
            <input type="hidden" id="editArtistId">
            <div id="editSelectedArtist" style="margin-top:8px; font-size:13px; color:var(--muted);"></div>
          </div>
        </div>

        <!-- Appointment Details -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:1rem; font-weight:600; margin-bottom:12px; color:#1d1d1f;">Appointment Details</h4>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Date</label>
            <input type="date" id="editScheduledDate">
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Start Time</label>
            <input type="time" id="editStartTime">
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">End Time</label>
            <input type="time" id="editEndTime">
          </div>
        </div>

        <!-- Status Management -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:1rem; font-weight:600; margin-bottom:12px; color:#1d1d1f;">Status Management</h4>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Status</label>
            <select id="editStatus">
              <option value="open_request">New Request</option>
              <option value="pending">Pending</option>
              <option value="scheduled">Scheduled</option>
              <option value="finished">Finished</option>
              <option value="canceled">Canceled</option>
            </select>
          </div>
        </div>

        <!-- Quick Actions -->
        <div style="margin-bottom:24px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.1);">
          <h4 style="font-size:1rem; font-weight:600; margin-bottom:12px; color:#1d1d1f;">Quick Actions</h4>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn" onclick="resetRequestToOpen()" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">
              ðŸ”„ Reset to Open
            </button>
            <button type="button" class="btn" onclick="deleteRequestPermanently()" style="background:#dc3545; color:white; border:none;">
              ðŸ—‘ï¸ Delete Permanently
            </button>
          </div>
        </div>

        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelEditRequest" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Request Modal -->
  <div class="modal-backdrop" id="createRequestModal">
    <div class="modal" style="max-width:700px; max-height:90vh; overflow-y:auto;">
      <h3 style="color:var(--ink); font-weight:500;">Create New Request</h3>
      <form class="modal-form" id="createRequestForm" style="max-height:calc(90vh - 150px); overflow-y:auto;">

        <!-- Customer Information -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:1rem; font-weight:600; margin-bottom:12px; color:#1d1d1f;">Customer Information</h4>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Vorname</label>
            <input type="text" id="createFirstName" required>
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Nachname</label>
            <input type="text" id="createLastName" required>
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Email</label>
            <input type="email" id="createEmail" required>
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Phone</label>
            <input type="tel" id="createPhone" required>
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Instagram</label>
            <input type="text" id="createInstagram" placeholder="@username">
          </div>
        </div>

        <!-- Request Details -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:1rem; font-weight:600; margin-bottom:12px; color:#1d1d1f;">Request Details</h4>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Booking Source</label>
            <select id="createOrigin" required>
              <option value="">-- Select Booking Source --</option>
              <option value="Booking form">Booking form</option>
              <option value="Whatsapp">Whatsapp</option>
              <option value="Instagram">Instagram</option>
              <option value="Facebook">Facebook</option>
              <option value="Phone">Phone</option>
              <option value="E-mail">E-mail</option>
              <option value="Walk-in">Walk-in</option>
              <option value="Self-Booking">Self-Booking</option>
            </select>
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Priority</label>
            <select id="createPriority">
              <option value="">-- Select Priority --</option>
              <option value="low">Low ðŸ’¤</option>
              <option value="normal" selected>Normal âœ“</option>
              <option value="high">High âš¡</option>
              <option value="urgent">Urgent ðŸ”¥</option>
            </select>
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Placement</label>
            <input type="text" id="createPlacement" placeholder="e.g., Arm, Leg, Back">
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Size</label>
            <input type="text" id="createSize" placeholder="e.g., 10x10 cm">
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Style</label>
            <input type="text" id="createStyle" placeholder="e.g., Traditional, Realism">
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Colorway</label>
            <input type="text" id="createColorway" placeholder="e.g., Black & Grey, Full Color">
          </div>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Description</label>
            <textarea id="createDescription" rows="4" placeholder="Describe the tattoo idea..."></textarea>
          </div>
        </div>

        <!-- Location Selection -->
        <div style="margin-bottom:24px;">
          <h4 style="font-size:1rem; font-weight:600; margin-bottom:12px; color:#1d1d1f;">Location</h4>
          <div class="form-group">
            <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Select Location</label>
            <select id="createLocation" required>
              <option value="">-- Select Location --</option>
              <!-- Locations will be loaded dynamically -->
            </select>
          </div>
        </div>

        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelCreateRequest" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Create Request</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Appointment Modal -->
  <div class="modal-backdrop" id="editAppointmentModal">
    <div class="modal">
      <h3 style="color:var(--ink); font-weight:500;">Edit Appointment</h3>
      <form class="modal-form" id="editAppointmentForm">
        <div class="form-group">
          <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Artist</label>
          <select id="editAppointmentArtist" required>
            <option value="">-- Select Artist --</option>
          </select>
        </div>
        <div class="form-group">
          <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Date</label>
          <input type="date" id="editAppointmentDate" required>
        </div>
        <div class="form-group">
          <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Start Time</label>
          <select id="editAppointmentStartTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="form-group">
          <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">End Time</label>
          <select id="editAppointmentEndTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelEditAppointment" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">Cancel</button>
          <button type="submit" class="btn" style="background:var(--ink); color:white; border:none;">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cancel Appointment Modal -->
  <div class="modal-backdrop" id="cancelModal">
    <div class="modal">
      <h3 style="color:var(--ink); font-weight:500;">Cancel Appointment</h3>
      <p style="margin-bottom:20px; color:var(--muted); font-size:14px;">Are you sure you want to cancel this appointment?</p>
      <form class="modal-form" id="cancelForm">
        <div class="form-group">
          <label style="font-size:1rem; font-weight:600; color:#1d1d1f;">Cancellation Reason</label>
          <textarea id="cancelReason" placeholder="Please provide a reason for cancellation..." required style="border-radius:10px;"></textarea>
        </div>
        <div class="modal-actions" style="gap:8px;">
          <button type="button" class="btn btn-secondary" id="cancelCancelModal" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1);">No, Keep it</button>
          <button type="submit" class="btn" style="background:#dc3545; color:white; border:none;">Yes, Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal-backdrop" id="addCustomerModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3>Add New Customer</h3>
      <form class="modal-form" id="addCustomerForm">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="addCustomerFirstName" required>
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="addCustomerLastName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="addCustomerEmail" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="addCustomerPhone">
        </div>
        <div class="form-group">
          <label>Instagram</label>
          <input type="text" id="addCustomerInstagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="addCustomerRank">
            <option value="">-- No Rank --</option>
            <option value="Neukunde">Neukunde</option>
            <option value="Bronze">Bronze</option>
            <option value="Silver">Silver</option>
            <option value="Gold">Gold</option>
            <option value="Platinum">Platinum</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelAddCustomer">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Customer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- CREATE GUEST SPOT MODAL -->
  <!-- ============================================ -->
  <div class="modal-backdrop" id="createGuestSpotModal">
    <div class="modal" style="max-width:700px; max-height:90vh; overflow-y:auto;">
      <h3 style="margin:0 0 24px 0; font-size:20px; font-weight:600;">Create Guest Spot</h3>

      <form id="createGuestSpotForm">
        <!-- SECTION 1: Artist Selection -->
        <div style="margin-bottom:24px; padding:20px; background:rgba(142,142,147,0.08); border-radius:12px;">
          <label style="font-size:12px; font-weight:600; color:#86868b; text-transform:uppercase; display:block; margin-bottom:12px;">Artist auswÃ¤hlen</label>

          <div style="display:flex; gap:12px; align-items:flex-start;">
            <!-- Artist Search -->
            <div style="flex:1; position:relative;">
              <input
                type="text"
                id="guestSpotArtistSearch"
                placeholder="Artist suchen (Name oder Instagram)..."
                autocomplete="off"
                style="
                  width:100%;
                  padding:12px 16px;
                  border:1px solid rgba(0,0,0,0.1);
                  border-radius:8px;
                  font-size:14px;
                "
              >
              <!-- Search Results Dropdown -->
              <div id="guestSpotArtistResults" style="
                display:none;
                position:absolute;
                top:100%;
                left:0;
                right:0;
                background:white;
                border:1px solid rgba(0,0,0,0.1);
                border-radius:8px;
                box-shadow:0 4px 12px rgba(0,0,0,0.15);
                max-height:200px;
                overflow-y:auto;
                z-index:1000;
                margin-top:4px;
              "></div>
            </div>

            <!-- Add Artist Button -->
            <button type="button" onclick="openAddArtistFromGuestSpot()" style="
              padding:12px 16px;
              border:none;
              border-radius:8px;
              background:#1d1d1f;
              color:#fff;
              font-size:14px;
              font-weight:500;
              cursor:pointer;
              display:flex;
              align-items:center;
              gap:6px;
              white-space:nowrap;
            ">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              Add Artist
            </button>
          </div>

          <!-- Selected Artist Display -->
          <div id="guestSpotSelectedArtist" style="display:none; margin-top:12px; padding:12px; background:white; border-radius:8px; border:1px solid rgba(0,0,0,0.1);">
            <div style="display:flex; align-items:center; gap:12px;">
              <img id="guestSpotArtistAvatar" src="" alt="" style="width:40px; height:40px; border-radius:50%; object-fit:cover; display:none;">
              <div style="flex:1;">
                <div id="guestSpotArtistName" style="font-weight:600; font-size:15px;"></div>
                <div id="guestSpotArtistInstagram" style="font-size:13px; color:#86868b;"></div>
              </div>
              <button type="button" onclick="clearSelectedGuestSpotArtist()" style="
                padding:6px 12px;
                border:1px solid #ff3b30;
                border-radius:6px;
                background:transparent;
                color:#ff3b30;
                font-size:12px;
                cursor:pointer;
              ">Entfernen</button>
            </div>
          </div>

          <!-- Hidden Input for Artist ID -->
          <input type="hidden" id="guestSpotArtistId" name="artist_id" required>
        </div>

        <!-- SECTION 2: Date & Time -->
        <div style="margin-bottom:24px;">
          <label style="font-size:12px; font-weight:600; color:#86868b; text-transform:uppercase; display:block; margin-bottom:12px;">Zeitraum</label>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
            <div>
              <label style="font-size:13px; color:#1d1d1f; margin-bottom:4px; display:block;">Start Datum</label>
              <div class="guest-spot-date-picker-container">
                <button type="button" class="guest-spot-date-picker-trigger" id="guestSpotDateFromTrigger" onclick="openGuestSpotDatePicker('from')">
                  <span id="guestSpotDateFromDisplay">Datum wÃ¤hlen...</span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2"/>
                    <path d="M16 2v4M8 2v4M3 10h18"/>
                  </svg>
                </button>
                <div class="guest-spot-calendar-popup" id="guestSpotDateFromPopup"></div>
                <input type="hidden" id="guestSpotDateFrom" name="date_from" required>
              </div>
            </div>
            <div>
              <label style="font-size:13px; color:#1d1d1f; margin-bottom:4px; display:block;">End Datum</label>
              <div class="guest-spot-date-picker-container">
                <button type="button" class="guest-spot-date-picker-trigger" id="guestSpotDateToTrigger" onclick="openGuestSpotDatePicker('to')">
                  <span id="guestSpotDateToDisplay">Datum wÃ¤hlen...</span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2"/>
                    <path d="M16 2v4M8 2v4M3 10h18"/>
                  </svg>
                </button>
                <div class="guest-spot-calendar-popup" id="guestSpotDateToPopup"></div>
                <input type="hidden" id="guestSpotDateTo" name="date_to" required>
              </div>
            </div>
            <div>
              <label style="font-size:13px; color:#1d1d1f; margin-bottom:4px; display:block;">Start Zeit</label>
              <input type="time" id="guestSpotTimeFrom" value="10:00" required style="
                width:100%;
                padding:12px;
                border:1px solid rgba(0,0,0,0.1);
                border-radius:8px;
                font-size:14px;
              ">
            </div>
            <div>
              <label style="font-size:13px; color:#1d1d1f; margin-bottom:4px; display:block;">End Zeit</label>
              <input type="time" id="guestSpotTimeTo" value="18:00" required style="
                width:100%;
                padding:12px;
                border:1px solid rgba(0,0,0,0.1);
                border-radius:8px;
                font-size:14px;
              ">
            </div>
          </div>
        </div>

        <!-- SECTION 3: Location -->
        <div style="margin-bottom:24px;">
          <label style="font-size:12px; font-weight:600; color:#86868b; text-transform:uppercase; display:block; margin-bottom:8px;">Location</label>
          <select id="guestSpotLocation" required style="
            width:100%;
            padding:12px;
            border:1px solid rgba(0,0,0,0.1);
            border-radius:8px;
            font-size:14px;
            background:white;
          ">
            <option value="">-- Location auswÃ¤hlen --</option>
            <!-- Options werden dynamisch geladen -->
          </select>
        </div>

        <!-- SECTION 4: Info/Notes -->
        <div style="margin-bottom:24px;">
          <label style="font-size:12px; font-weight:600; color:#86868b; text-transform:uppercase; display:block; margin-bottom:8px;">Info / Notizen</label>
          <textarea id="guestSpotNotes" rows="3" placeholder="ZusÃ¤tzliche Informationen..." style="
            width:100%;
            padding:12px;
            border:1px solid rgba(0,0,0,0.1);
            border-radius:8px;
            font-size:14px;
            resize:vertical;
            font-family:inherit;
          "></textarea>
        </div>

        <!-- SECTION 5: Self Booking -->
        <div style="margin-bottom:24px; padding:16px 20px; background:rgba(255,149,0,0.08); border-radius:12px; border:1px solid rgba(255,149,0,0.2);">
          <div style="display:flex; align-items:center; gap:12px;">
            <input type="checkbox" id="guestSpotSelfBooking" onchange="toggleSelfBookingMode()" style="width:20px; height:20px; cursor:pointer;">
            <div>
              <label for="guestSpotSelfBooking" style="font-size:14px; font-weight:600; cursor:pointer; color:#1d1d1f; display:flex; align-items:center; gap:6px;">
                <span style="display:inline-flex; color:#ff9500;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg></span> Self Booking
              </label>
              <p style="font-size:12px; color:#86868b; margin:4px 0 0 0;">
                Artist bucht und verwaltet seine Termine selbst
              </p>
            </div>
          </div>
        </div>

        <!-- SECTION 6: Unterkunft -->
        <div style="margin-bottom:24px; padding:20px; background:rgba(142,142,147,0.08); border-radius:12px;">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
            <input type="checkbox" id="guestSpotAccommodation" onchange="toggleAccommodationFields()" style="width:18px; height:18px; cursor:pointer;">
            <label for="guestSpotAccommodation" style="font-size:14px; font-weight:500; cursor:pointer; display:flex; align-items:center; gap:6px;">
              <span style="display:inline-flex; color:#86868b;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span> Artist wohnt bei uns
            </label>
          </div>

          <div id="accommodationFields" style="display:none; margin-top:16px;">
            <label style="font-size:13px; color:#1d1d1f; margin-bottom:4px; display:block;">Gesamt Miete (â‚¬)</label>
            <input type="number" id="guestSpotAccommodationCost" step="0.01" min="0" placeholder="0.00" style="
              width:100%;
              padding:12px;
              border:1px solid rgba(0,0,0,0.1);
              border-radius:8px;
              font-size:14px;
            ">
            <p style="font-size:12px; color:#86868b; margin-top:8px; display:flex; align-items:flex-start; gap:6px;">
              <span style="display:inline-flex; flex-shrink:0;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg></span>
              <span>Die Miete wird separat erfasst und kann vom Artist-Anteil abgezogen werden</span>
            </p>
          </div>
        </div>

        <!-- SECTION 6: Share Split (NEU) -->
        <div style="margin-bottom:24px; padding:20px; background:rgba(0,122,255,0.08); border-radius:12px; border:1px solid rgba(0,122,255,0.2);">
          <label style="font-size:12px; font-weight:600; color:#007aff; text-transform:uppercase; display:flex; align-items:center; gap:6px; margin-bottom:16px;">
            <span style="display:inline-flex;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></span> Share Split
          </label>

          <!-- Artist Rang Info -->
          <div id="artistRankInfo" style="display:none; margin-bottom:16px; padding:12px; background:white; border-radius:8px; border:1px solid rgba(0,0,0,0.05);">
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size:13px; color:#86868b;">Artist Rang:</span>
              <span id="selectedArtistRankBadge" class="rank-badge" style="font-size:12px; padding:4px 10px;"></span>
            </div>
          </div>

          <!-- Share Display -->
          <div id="shareSplitDisplay" style="display:flex; justify-content:space-between; padding:20px; background:white; border-radius:8px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
            <div style="text-align:center; flex:1;">
              <div style="font-size:28px; font-weight:700; color:#1d1d1f;" id="studioSharePercent">25%</div>
              <div style="font-size:12px; color:#86868b; margin-top:4px;">Studio Cut</div>
            </div>
            <div style="width:1px; background:rgba(0,0,0,0.1); margin:0 20px;"></div>
            <div style="text-align:center; flex:1;">
              <div style="font-size:28px; font-weight:700; color:#34c759;" id="artistSharePercent">75%</div>
              <div style="font-size:12px; color:#86868b; margin-top:4px;">Artist Cut</div>
            </div>
          </div>

          <!-- Share Source Info -->
          <p id="shareSourceInfo" style="font-size:12px; color:#007aff; margin-bottom:16px; text-align:center; display:flex; align-items:center; justify-content:center; gap:6px;">
            <span style="display:inline-flex;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></span>
            <span>WÃ¤hle einen Artist um den Share zu sehen</span>
          </p>

          <!-- Custom Share Checkbox -->
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px; padding:12px; background:rgba(255,149,0,0.08); border-radius:8px;">
            <input type="checkbox" id="guestSpotCustomShare" onchange="toggleCustomShareSlider()" style="width:18px; height:18px; cursor:pointer;">
            <label for="guestSpotCustomShare" style="font-size:14px; cursor:pointer; display:flex; align-items:center; gap:6px;">
              <span style="display:inline-flex; color:#ff9500;"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span> Custom Share Split aktivieren
            </label>
          </div>

          <!-- Slider Container (ausgegraut bis aktiviert) -->
          <div id="customShareSliderContainer" style="opacity:0.4; pointer-events:none; transition:opacity 0.3s;">
            <div style="display:flex; justify-content:space-between; font-size:11px; color:#86868b; margin-bottom:8px;">
              <span>Studio 100%</span>
              <span>50 / 50</span>
              <span>Artist 100%</span>
            </div>
            <input type="range" id="shareSlider" min="0" max="100" value="75"
              style="width:100%; cursor:pointer; height:8px;"
              oninput="updateShareFromSlider(this.value)">
            <div style="display:flex; justify-content:space-between; margin-top:12px;">
              <div style="text-align:center; padding:8px 16px; background:rgba(0,0,0,0.05); border-radius:6px;">
                <div style="font-size:11px; color:#86868b;">Studio</div>
                <div style="font-size:16px; font-weight:600;" id="sliderStudioValue">25%</div>
              </div>
              <div style="text-align:center; padding:8px 16px; background:rgba(52,199,89,0.1); border-radius:6px;">
                <div style="font-size:11px; color:#86868b;">Artist</div>
                <div style="font-size:16px; font-weight:600; color:#34c759;" id="sliderArtistValue">75%</div>
              </div>
            </div>
          </div>

          <!-- Zahlungsnotiz -->
          <div style="margin-top:16px;">
            <label style="font-size:13px; color:#1d1d1f; margin-bottom:4px; display:flex; align-items:center; gap:6px;"><span style="display:inline-flex;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></span> Zahlungsnotiz (optional)</label>
            <input type="text" id="guestSpotPaymentNotes" placeholder="z.B. Bar bezahlt, PayPal erhalten, Ãœberweisung ausstehend..." style="
              width:100%;
              padding:12px;
              border:1px solid rgba(0,0,0,0.1);
              border-radius:8px;
              font-size:14px;
            ">
          </div>

          <!-- Hidden Inputs fÃ¼r Form Submit -->
          <input type="hidden" id="guestSpotShareArtist" name="share_percentage_artist" value="">
          <input type="hidden" id="guestSpotShareStudio" name="share_percentage_studio" value="">
          <input type="hidden" id="guestSpotIsCustomShare" name="custom_share" value="false">
        </div>

        <!-- Modal Actions -->
        <div class="modal-actions" style="display:flex; gap:12px; justify-content:flex-end; padding-top:16px; border-top:1px solid rgba(0,0,0,0.1);">
          <button type="button" onclick="closeCreateGuestSpotModal()" class="btn btn-secondary" style="
            padding:12px 24px;
            border:1px solid rgba(0,0,0,0.1);
            border-radius:8px;
            background:white;
            color:#1d1d1f;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
          ">Abbrechen</button>
          <button type="submit" class="btn btn-primary" style="
            padding:12px 24px;
            border:none;
            border-radius:8px;
            background:#1d1d1f;
            color:#fff;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
          ">Guest Spot erstellen</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- GUEST SPOT DETAIL/EDIT MODAL -->
  <!-- ============================================ -->
  <div class="modal-backdrop" id="guestSpotDetailModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3 id="guestSpotDetailTitle" style="margin:0 0 20px 0; font-size:20px; font-weight:600;">Guest Spot Details</h3>

      <!-- View Mode Content -->
      <div id="guestSpotViewMode">
        <!-- Artist Info -->
        <div style="display:flex; align-items:center; gap:16px; padding:16px; background:rgba(142,142,147,0.08); border-radius:12px; margin-bottom:20px;">
          <img id="guestSpotDetailAvatar" src="" alt="" style="width:56px; height:56px; border-radius:50%; object-fit:cover; display:none;">
          <div style="flex:1;">
            <div id="guestSpotDetailArtistName" style="font-weight:600; font-size:17px;"></div>
            <div id="guestSpotDetailArtistInstagram" style="font-size:14px; color:#86868b;"></div>
          </div>
          <span id="guestSpotDetailPaidBadge" style="padding:6px 14px; border-radius:20px; font-size:12px; font-weight:600;"></span>
        </div>

        <!-- Details Grid -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
          <div>
            <div style="font-size:12px; color:#86868b; margin-bottom:4px;">Zeitraum</div>
            <div id="guestSpotDetailDateRange" style="font-weight:500;"></div>
          </div>
          <div>
            <div style="font-size:12px; color:#86868b; margin-bottom:4px;">Uhrzeit</div>
            <div id="guestSpotDetailTimeRange" style="font-weight:500;"></div>
          </div>
          <div>
            <div style="font-size:12px; color:#86868b; margin-bottom:4px;">Location</div>
            <div id="guestSpotDetailLocation" style="font-weight:500;"></div>
          </div>
          <div>
            <div style="font-size:12px; color:#86868b; margin-bottom:4px;">Buchungstyp</div>
            <div id="guestSpotDetailBookingType" style="font-weight:500;"></div>
          </div>
        </div>

        <!-- Payment Info (Internal) -->
        <div id="guestSpotDetailInternalPayment" style="display:none; padding:16px; background:rgba(52, 199, 89, 0.08); border-radius:12px; margin-bottom:20px;">
          <div style="font-size:13px; font-weight:600; color:#34c759; margin-bottom:12px;">Interne Buchung</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div>
              <div style="font-size:12px; color:#86868b;">Anzahlung</div>
              <div id="guestSpotDetailInternalDeposit" style="font-weight:600;"></div>
            </div>
            <div>
              <div style="font-size:12px; color:#86868b;">Vor Ort</div>
              <div id="guestSpotDetailInternalOnsite" style="font-weight:600;"></div>
            </div>
          </div>
          <div style="margin-top:12px;">
            <div style="font-size:12px; color:#86868b;">Notiz</div>
            <div id="guestSpotDetailInternalNotes" style="font-size:14px;"></div>
          </div>
        </div>

        <!-- Payment Info (External) -->
        <div id="guestSpotDetailExternalPayment" style="display:none; padding:16px; background:rgba(0, 122, 255, 0.08); border-radius:12px; margin-bottom:20px;">
          <div style="font-size:13px; font-weight:600; color:#007aff; margin-bottom:12px;">Self-Booking</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div>
              <div style="font-size:12px; color:#86868b;">Total Preis</div>
              <div id="guestSpotDetailExternalTotal" style="font-weight:600;"></div>
            </div>
            <div>
              <div style="font-size:12px; color:#86868b;">Deposit</div>
              <div id="guestSpotDetailExternalDeposit" style="font-weight:600;"></div>
            </div>
            <div>
              <div style="font-size:12px; color:#86868b;">Studio Share</div>
              <div id="guestSpotDetailStudioShare" style="font-weight:600;"></div>
            </div>
            <div>
              <div style="font-size:12px; color:#86868b;">Artist Share</div>
              <div id="guestSpotDetailArtistShare" style="font-weight:600;"></div>
            </div>
          </div>
          <div style="margin-top:12px;">
            <div style="font-size:12px; color:#86868b;">Notiz</div>
            <div id="guestSpotDetailExternalNotes" style="font-size:14px;"></div>
          </div>
        </div>

        <!-- Notes -->
        <div id="guestSpotDetailNotesSection" style="display:none; margin-bottom:20px;">
          <div style="font-size:12px; color:#86868b; margin-bottom:4px;">Info / Notizen</div>
          <div id="guestSpotDetailNotes" style="padding:12px; background:rgba(142,142,147,0.08); border-radius:8px;"></div>
        </div>

        <!-- Canceled Info -->
        <div id="guestSpotDetailCanceledInfo" style="display:none; padding:16px; background:rgba(255, 59, 48, 0.1); border-radius:12px; margin-bottom:20px;">
          <div style="font-size:13px; font-weight:600; color:#ff3b30; margin-bottom:8px; display:flex; align-items:center; gap:8px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
            Storniert
          </div>
          <div id="guestSpotDetailCancelReason" style="font-size:14px;"></div>
        </div>

        <!-- VerknÃ¼pfte Appointments Section -->
        <div id="guestSpotAppointmentsSection" style="margin-top:24px; padding-top:24px; border-top:1px solid rgba(0,0,0,0.1);">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h4 style="margin:0; font-size:14px; font-weight:600; color:#1d1d1f; display:flex; align-items:center; gap:6px;">
              <span style="display:inline-flex;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span> VerknÃ¼pfte Appointments
            </h4>
            <div id="addAppointmentBtnContainer" style="display:none;">
              <button type="button" onclick="openAddGuestSpotAppointmentModal()" style="
                padding:8px 16px;
                border:none;
                border-radius:6px;
                background:#1d1d1f;
                color:white;
                font-size:13px;
                font-weight:500;
                cursor:pointer;
                display:flex;
                align-items:center;
                gap:6px;
              ">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
                Add Appointment
              </button>
            </div>
          </div>
          <div id="guestSpotAppointmentsList" style="max-height:300px; overflow-y:auto;">
            <div style="text-align:center; padding:20px; color:#86868b;">
              <p>Lade Appointments...</p>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div id="guestSpotDetailActions" style="display:flex; gap:12px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.1);">
          <button type="button" onclick="toggleGuestSpotPaid()" id="guestSpotTogglePaidBtn" style="
            flex:1;
            padding:12px;
            border:none;
            border-radius:8px;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
          "></button>
          <button type="button" onclick="openGuestSpotEditMode()" id="guestSpotEditBtn" style="
            flex:1;
            padding:12px;
            border:none;
            border-radius:8px;
            background:rgba(142,142,147,0.12);
            color:#1d1d1f;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
          ">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Edit
          </button>
          <button type="button" onclick="cancelGuestSpot()" id="guestSpotCancelBtn" style="
            flex:1;
            padding:12px;
            border:none;
            border-radius:8px;
            background:#ff9500;
            color:#fff;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
          ">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
            Cancel
          </button>
          <button type="button" onclick="reactivateGuestSpot()" id="guestSpotReactivateBtn" style="
            flex:1;
            padding:12px;
            border:none;
            border-radius:8px;
            background:#34c759;
            color:#fff;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
            display:none;
            align-items:center;
            justify-content:center;
            gap:8px;
          ">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
            </svg>
            Reaktivieren
          </button>
          <button type="button" onclick="deleteGuestSpot()" id="guestSpotDeleteBtn" style="
            flex:1;
            padding:12px;
            border:none;
            border-radius:8px;
            background:#ff3b30;
            color:#fff;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
          ">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Delete
          </button>
        </div>
      </div>

      <!-- Edit Mode Content (hidden by default) -->
      <div id="guestSpotEditMode" style="display:none;">
        <!-- Edit form will be populated dynamically -->
      </div>

      <!-- Close Button -->
      <button type="button" onclick="closeGuestSpotDetailModal()" style="
        position:absolute;
        top:16px;
        right:16px;
        width:32px;
        height:32px;
        border:none;
        border-radius:50%;
        background:rgba(142,142,147,0.12);
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
      ">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>

      <!-- Hidden Data -->
      <input type="hidden" id="guestSpotDetailId">
      <input type="hidden" id="guestSpotDetailSlotIds">
    </div>
  </div>

  <!-- Edit Customer Modal -->
  <div class="modal-backdrop" id="editCustomerModal">
    <div class="modal" style="max-width:650px; max-height:90vh; overflow-y:auto;">
      <h3>Edit Customer</h3>
      <form class="modal-form" id="editCustomerForm">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="editCustomerFirstName" required>
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="editCustomerLastName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="editCustomerEmail" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="editCustomerPhone">
        </div>
        <div class="form-group">
          <label>Instagram</label>
          <input type="text" id="editCustomerInstagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="editCustomerRank">
            <option value="">-- No Rank --</option>
            <option value="Neukunde">Neukunde</option>
            <option value="Bronze">Bronze</option>
            <option value="Silver">Silver</option>
            <option value="Gold">Gold</option>
            <option value="Platinum">Platinum</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelEditCustomer">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Customer Profile Modal -->
  <div class="modal-backdrop" id="customerProfileModal">
    <div class="modal" style="max-width:900px; max-height:90vh; overflow-y:auto;">
      <div class="profile-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(0,0,0,0.1);">
        <div>
          <h3 id="customerProfileName" style="margin:0 0 8px 0; color:var(--macos-text-primary); font-weight:600; font-size:24px;">Customer Profile</h3>
          <div id="customerProfileRankBadge"></div>
        </div>
        <button type="button" class="btn btn-secondary" onclick="closeCustomerProfile()" style="padding:8px 16px;">Close</button>
      </div>

      <!-- Customer Details Section (Editable) -->
      <div class="profile-section" style="margin-bottom:32px;">
        <h4 style="font-size:17px; font-weight:600; color:var(--macos-text-primary); margin-bottom:16px;">Customer Details</h4>
        <form id="customerDetailsForm" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:16px; padding:20px; background:rgba(255,255,255,0.7); backdrop-filter:saturate(180%) blur(20px); border-radius:12px; border:1px solid rgba(0,0,0,0.1);">
          <div class="form-group" style="margin:0;">
            <label style="font-size:13px; color:var(--macos-text-secondary); display:block; margin-bottom:6px;">First Name</label>
            <input type="text" id="profileCustomerFirstName" required style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.2); border-radius:8px; font-size:14px;">
          </div>
          <div class="form-group" style="margin:0;">
            <label style="font-size:13px; color:var(--macos-text-secondary); display:block; margin-bottom:6px;">Last Name</label>
            <input type="text" id="profileCustomerLastName" required style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.2); border-radius:8px; font-size:14px;">
          </div>
          <div class="form-group" style="margin:0;">
            <label style="font-size:13px; color:var(--macos-text-secondary); display:block; margin-bottom:6px;">Email</label>
            <input type="email" id="profileCustomerEmail" required style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.2); border-radius:8px; font-size:14px;">
          </div>
          <div class="form-group" style="margin:0;">
            <label style="font-size:13px; color:var(--macos-text-secondary); display:block; margin-bottom:6px;">Phone</label>
            <input type="tel" id="profileCustomerPhone" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.2); border-radius:8px; font-size:14px;">
          </div>
          <div class="form-group" style="margin:0;">
            <label style="font-size:13px; color:var(--macos-text-secondary); display:block; margin-bottom:6px;">Instagram</label>
            <input type="text" id="profileCustomerInstagram" placeholder="@username" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.2); border-radius:8px; font-size:14px;">
          </div>
          <div class="form-group" style="margin:0;">
            <label style="font-size:13px; color:var(--macos-text-secondary); display:block; margin-bottom:6px;">Rank</label>
            <select id="profileCustomerRank" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.2); border-radius:8px; font-size:14px;">
              <option value="">-- No Rank --</option>
              <option value="Neukunde">Neukunde</option>
              <option value="Bronze">Bronze</option>
              <option value="Silver">Silver</option>
              <option value="Gold">Gold</option>
              <option value="Platinum">Platinum</option>
            </select>
          </div>
          <div style="grid-column:1/-1; display:flex; gap:12px; margin-top:8px;">
            <button type="button" class="btn btn-primary" onclick="saveCustomerDetails()" style="padding:8px 16px;">Save Changes</button>
            <button type="button" class="btn btn-danger" onclick="deleteCustomerFromProfile()" style="padding:8px 16px;">Delete Customer</button>
          </div>
        </form>
      </div>

      <!-- Requests & Appointments Section with Toggle -->
      <div class="profile-section" style="margin-bottom:32px;">
        <!-- Toggle Buttons -->
        <div style="display:flex; gap:8px; margin-bottom:16px; background:rgba(0,0,0,0.05); border-radius:10px; padding:4px;">
          <button id="showRequestsBtn" class="view-toggle-btn active" onclick="toggleCustomerView('requests')" style="flex:1; padding:10px 20px; border:none; background:rgba(255,255,255,0.9); border-radius:8px; font-size:14px; font-weight:600; color:var(--macos-text-primary); cursor:pointer; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            Requests
          </button>
          <button id="showAppointmentsBtn" class="view-toggle-btn" onclick="toggleCustomerView('appointments')" style="flex:1; padding:10px 20px; border:none; background:transparent; border-radius:8px; font-size:14px; font-weight:600; color:var(--macos-text-secondary); cursor:pointer; transition:all 0.2s ease;">
            Appointments
          </button>
        </div>

        <!-- Requests Content -->
        <div id="customerRequestsView" class="customer-view-content" style="display:block;">
          <div id="customerRequestsList" style="display:flex; flex-direction:column; gap:12px;">
            <!-- Requests will be loaded here -->
          </div>
        </div>

        <!-- Appointments Content -->
        <div id="customerAppointmentsView" class="customer-view-content" style="display:none;">
          <div id="customerAppointmentsList" style="display:flex; flex-direction:column; gap:12px;">
            <!-- Appointments will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- File Upload Modal -->
  <div class="modal-backdrop" id="fileUploadModal">
    <div class="modal">
      <h3>Agreement Files</h3>
      <div style="margin-bottom:20px;">
        <div id="existingFiles" style="margin-bottom:16px;">
          <!-- Existing files will be shown here -->
        </div>
        <div style="border:2px dashed rgba(0,0,0,0.2); border-radius:12px; padding:32px; text-align:center; background:rgba(0,0,0,0.02);">
          <input type="file" id="fileUploadInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display:none;">
          <div style="font-size:48px; margin-bottom:12px;">ðŸ“Ž</div>
          <button type="button" class="btn btn-primary" onclick="document.getElementById('fileUploadInput').click()">Choose Files</button>
          <p style="margin-top:12px; font-size:13px; color:var(--muted);">PDF, DOC, DOCX, JPG, PNG accepted</p>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="closeFileUpload">Close</button>
      </div>
    </div>
  </div>

  <!-- Create Event Modal -->
  <div class="modal-backdrop" id="createEventModal">
    <div class="modal" style="max-width:600px;">
      <h3>Create New Event</h3>
      <form class="modal-form" id="createEventForm">
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="createEventTitle" placeholder="e.g. Team Meeting, Workshop, etc." required>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <input type="text" id="createEventType" placeholder="e.g. Meeting, Training, Workshop" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="createEventDescription" placeholder="Event details and notes..." style="border-radius:10px; min-height:80px; resize:vertical;"></textarea>
        </div>
        
        <div class="form-group">
          <label>Visible for Groups</label>
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px; background:rgba(0,0,0,0.02); border-radius:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:600; grid-column:1/-1; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:4px;">
              <input type="checkbox" id="groupCheckboxAll" style="width:auto; padding:0;">
              All Groups
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="geschÃ¤ftsfÃ¼hrung" style="width:auto; padding:0;">
              GeschÃ¤ftsfÃ¼hrung
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="management" style="width:auto; padding:0;">
              Management
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="booking_team" style="width:auto; padding:0;">
              Booking Team
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="mediadepartment" style="width:auto; padding:0;">
              Mediadepartment
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="resident_artists" style="width:auto; padding:0;">
              Resident Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="guest_artists" style="width:auto; padding:0;">
              Guest Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="azubis" style="width:auto; padding:0;">
              Azubis
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="andere" style="width:auto; padding:0;">
              Andere
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
            <input type="checkbox" id="createEventAttendanceRequired" style="width:auto; padding:0;">
            <span style="font-weight:500;">Anwesenheitspflicht</span>
          </label>
          <p style="font-size:12px; color:var(--muted); margin:4px 0 0 24px;">Markieren Sie dieses Event als verpflichtend fÃ¼r alle ausgewÃ¤hlten Gruppen</p>
        </div>

        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="createEventDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="createEventStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="createEventEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelCreateEvent">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Event</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Booking Modal -->
  <div class="modal-backdrop" id="editBookingModal">
    <div class="modal" style="max-width:600px;">
      <h3>Edit Booking</h3>
      <form class="modal-form" id="editBookingForm">
        <input type="hidden" id="editBookingId">
        
        <div class="form-group">
          <label>Customer Name</label>
          <input type="text" id="editBookingCustomer" placeholder="Customer Name" required>
        </div>
        
        <div class="form-group">
          <label>Booking Type</label>
          <select id="editBookingType" required>
            <option value="">-- Select Type --</option>
            <option value="consultation">Consultation</option>
            <option value="new_tattoo">New Tattoo</option>
            <option value="continuing_tattoo">Continuing Tattoo</option>
            <option value="touch_up">Touch Up</option>
            <option value="selfbooking">Selfbooking</option>
            <option value="wannado">WannaDo</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Artist</label>
          <input type="text" id="editBookingArtistName" disabled style="background:#f5f5f5;">
          <input type="hidden" id="editBookingArtistId">
          <p style="font-size:12px; color:var(--muted); margin:4px 0 0 0;">Artist cannot be changed after booking creation</p>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="editBookingDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="editBookingStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="editBookingEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteBookingBtn">Delete Booking</button>
          <div style="flex:1;"></div>
          <button type="button" class="btn btn-secondary" id="cancelEditBooking">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Customer/Artist Side Panel (neben dem Appointment Modal) -->
  <div id="profileSidePanel" style="
    display: none;
    position: fixed;
    top: 0;
    right: 0;
    width: 380px;
    height: 100vh;
    background: var(--macos-elevated, #fff);
    box-shadow: -4px 0 20px rgba(0,0,0,0.15);
    z-index: 10001;
    overflow-y: auto;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  ">
    <div id="profileSidePanelContent" style="padding: 20px;">
      <!-- Content wird dynamisch geladen -->
    </div>
  </div>

  <!-- Appointment Details Modal -->
  <div class="modal-backdrop" id="appointmentDetailsModal">
    <div class="modal" style="max-width:800px; max-height:90vh; overflow-y:auto;">
      <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:16px;">
        <h3 style="margin:0;">Appointment Details</h3>
        <button type="button" class="btn btn-icon" onclick="closeAppointmentDetailsModal()" style="padding:4px 12px; font-size:20px; line-height:1;">Ã—</button>
      </div>
      <div id="appointmentDetailsContent" style="display:flex; flex-direction:column; gap:24px;">
        <!-- Content will be dynamically inserted -->
      </div>
      <div class="appointment-detail-actions">
        <button type="button" class="appointment-btn close" onclick="closeAppointmentDetailsModal()">
          SchlieÃŸen
        </button>
        <button type="button" class="appointment-btn edit" id="appointmentDetailsEditBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
          Bearbeiten
        </button>
        <button type="button" class="appointment-btn cancel" id="appointmentDetailsCancelBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          Stornieren
        </button>
        <button type="button" class="appointment-btn delete" id="appointmentDetailsDeleteBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
          LÃ¶schen
        </button>
      </div>
    </div>
  </div>

  <!-- Create Booking Modal -->
  <div class="modal-backdrop" id="createBookingModal">
    <div class="modal" style="max-width:600px;">
      <h3>Create New Booking</h3>
      <form class="modal-form" id="createBookingForm">
        <div class="form-group">
          <label>Customer Name</label>
          <input type="text" id="createBookingCustomer" placeholder="e.g. John Doe" required>
        </div>
        
        <div class="form-group">
          <label>Booking Type</label>
          <select id="createBookingType" required>
            <option value="">-- Select Type --</option>
            <option value="consultation">Consultation</option>
            <option value="new_tattoo">New Tattoo</option>
            <option value="continuing_tattoo">Continuing Tattoo</option>
            <option value="touch_up">Touch Up</option>
            <option value="selfbooking">Selfbooking</option>
            <option value="wannado">WannaDo</option>
            <option value="internal">Internal</option>
            <option value="move">Move</option>
            <option value="reserved">Reserved</option>
            <option value="no_show">No Show</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Artist Type</label>
          <select id="createBookingArtistType" required>
            <option value="">-- Select Artist Type --</option>
            <option value="resident">Resident</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Search Artist</label>
          <input type="text" id="createBookingArtistSearch" placeholder="Type to search artist..." disabled>
          <input type="hidden" id="createBookingArtistId">
          <div id="artistSearchResults" style="display:none; max-height:200px; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); border-radius:8px; margin-top:4px; background:white;"></div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="createBookingDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="createBookingStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="createBookingEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelCreateBooking">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Booking</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit/View Event Modal -->
  <div class="modal-backdrop" id="editEventModal">
    <div class="modal" style="max-width:600px;">
      <h3 id="editEventModalTitle">Event Details</h3>
      <form class="modal-form" id="editEventForm">
        <input type="hidden" id="editEventId">
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="editEventTitle" required>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <input type="text" id="editEventType" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="editEventDescription" rows="3" style="border-radius:10px; resize:vertical;"></textarea>
        </div>
        
        <div class="form-group" id="editEventArtistGroup" style="display:none;">
          <label>Artist</label>
          <input type="text" id="editEventArtistName" readonly style="background:rgba(0,0,0,0.05);">
        </div>
        
        <div class="form-group" id="editEventGroupsContainer">
          <label>Visible for Groups</label>
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px; background:rgba(0,0,0,0.02); border-radius:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:600; grid-column:1/-1; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:4px;">
              <input type="checkbox" id="editGroupCheckboxAll" style="width:auto; padding:0;">
              All Groups
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="geschÃ¤ftsfÃ¼hrung" style="width:auto; padding:0;">
              GeschÃ¤ftsfÃ¼hrung
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="management" style="width:auto; padding:0;">
              Management
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="booking_team" style="width:auto; padding:0;">
              Booking Team
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="mediadepartment" style="width:auto; padding:0;">
              Mediadepartment
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="resident_artists" style="width:auto; padding:0;">
              Resident Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="guest_artists" style="width:auto; padding:0;">
              Guest Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="azubis" style="width:auto; padding:0;">
              Azubis
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="andere" style="width:auto; padding:0;">
              Andere
            </label>
          </div>
        </div>
        
        <div class="form-group" id="editEventAttendanceGroup">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
            <input type="checkbox" id="editEventAttendanceRequired" style="width:auto; padding:0;">
            <span style="font-weight:500;">Anwesenheitspflicht</span>
          </label>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="editEventDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="editEventStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="editEventEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
              <option value="20.5">20:30</option>
              <option value="21.0">21:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete Event</button>
          <div style="flex:1;"></div>
          <button type="button" class="btn btn-secondary" id="cancelEditEvent">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ============================================
       TATTOO STUDIO MANAGEMENT SYSTEM v81
       ============================================

       FIXES IN v81:
       âœ… Updated: Location filter as dropdown in Request Tab (Alle, Mommy, GON, MuttersÃ¶hne, Pardon Paris)
       âœ… Removed: "Location:" label from dropdown
       âœ… Moved: Location dropdown next to Create Request button
       âœ… Added: Search bar for filtering requests by keywords
       âœ… Added: initRequestSearch() function with debounced search (300ms)
       âœ… Added: currentRequestSearchKeyword state variable
       âœ… Updated: loadRequests() to filter by status, location AND search keywords
       âœ… Search includes: name, email, instagram, phone, description, notes, artist, location, request number
       âœ… Updated: Request Status Switcher and Auto-Refresh Controls aligned on same line
       âœ… Updated: Version number from v80 to v81

       FIXES IN v80:
       âœ… Fixed: Artist location now displays correctly in table (shows city_location field)
       âœ… Fixed: Add Artist modal HTML structure (removed extra closing div tag, added missing closing select tag)
       âœ… Fixed: Cache refresh for Artists and Customers after add/edit/delete operations

       Request Management now supports location-based filtering for better organization.
       ============================================ */

    // Default Avatar fÃ¼r fehlende Bilder
    const DEFAULT_AVATAR_SVG = "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48"><circle cx="24" cy="24" r="24" fill="#e5e7eb"/><circle cx="24" cy="18" r="8" fill="#9ca3af"/><path d="M8 42c0-8.8 7.2-16 16-16s16 7.2 16 16" fill="#9ca3af"/></svg>');

    const SUPABASE_URL = "https://auxxyehgzkozdjylhqnx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1eHh5ZWhnemtvemRqeWxocW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDczODgsImV4cCI6MjA3NjEyMzM4OH0.bg8NunF2qkps28Aj0ZqY35eKK--QOu8NduCkFyqp5KA";

    // Use window.supabaseClient to avoid conflict with CDN global
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storage: window.localStorage
      }
    });
    // Alias for backwards compatibility
    window.supabase = supabaseClient;

    // ========================================
    // GLOBAL CHART INSTANCES (Declared early to avoid TDZ errors)
    // ========================================
    let requestStatusChartInstance = null;
    let appointmentStatusChartInstance = null;
    let projectsTimelineChartInstance = null;
    let revenueByMonthChartInstance = null;
    let topArtistsChartInstance = null;
    let originsPieChart = null;
    let timelineChart = null;
    let revenueTimelineChart = null;
    let artistDistributionChartInstance = null;
    let revenueByStatusChartInstance = null;

    // ==========================================
    // CALENDAR CATEGORY CONFIG (Declared early for Desktop rendering)
    // ==========================================
    // Kategorie-Farben und SVG-Icons fÃ¼r Calendar (Desktop + Mobile)
    // WICHTIG: Matching auf work_process (deutsch, lowercase) UND booking_type (englisch)
    const calendarCategoryConfig = {
      // === WORK_PROCESS MAPPINGS (deutsch, lowercase) ===
      'neustechen': {
        bg: 'rgba(233, 30, 99, 0.1)', color: '#E91E63', textColor: '#AD1457',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M12 5v14M5 12h14"/></svg>',
        label: 'Neustechen'
      },
      'weiterstechen': {
        bg: 'rgba(33, 150, 243, 0.1)', color: '#2196F3', textColor: '#1565C0',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>',
        label: 'Weiterstechen'
      },
      'nachstechen': {
        bg: 'rgba(255, 193, 7, 0.15)', color: '#FFC107', textColor: '#F57F17',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"/><polygon points="18 2 22 6 12 16 8 16 8 12 18 2"/></svg>',
        label: 'Nachstechen'
      },
      'beratung': {
        bg: 'rgba(76, 175, 80, 0.1)', color: '#4CAF50', textColor: '#2E7D32',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
        label: 'Beratung'
      },

      // === BOOKING_TYPE MAPPINGS (englisch) ===
      'consultation': {
        bg: 'rgba(76, 175, 80, 0.1)', color: '#4CAF50', textColor: '#2E7D32',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
        label: 'Beratung'
      },
      'new_tattoo': {
        bg: 'rgba(233, 30, 99, 0.1)', color: '#E91E63', textColor: '#AD1457',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M12 5v14M5 12h14"/></svg>',
        label: 'Neustechen'
      },
      'continuing_tattoo': {
        bg: 'rgba(33, 150, 243, 0.1)', color: '#2196F3', textColor: '#1565C0',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>',
        label: 'Weiterstechen'
      },
      'touch_up': {
        bg: 'rgba(255, 193, 7, 0.15)', color: '#FFC107', textColor: '#F57F17',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"/><polygon points="18 2 22 6 12 16 8 16 8 12 18 2"/></svg>',
        label: 'Nachstechen'
      },
      'selfbooking': {
        bg: 'rgba(121, 85, 72, 0.1)', color: '#795548', textColor: '#5D4037',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
        label: 'Selfbooking'
      },
      'wannado': {
        bg: 'rgba(156, 39, 176, 0.1)', color: '#9C27B0', textColor: '#7B1FA2',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
        label: 'WannaDo'
      },
      'internal': {
        bg: 'rgba(244, 67, 54, 0.1)', color: '#F44336', textColor: '#C62828',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6v6H9z"/></svg>',
        label: 'Intern'
      },
      'move': {
        bg: 'rgba(0, 188, 212, 0.1)', color: '#00BCD4', textColor: '#00838F',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/></svg>',
        label: 'Verschiebung'
      },
      'reserved': {
        bg: 'rgba(158, 158, 158, 0.1)', color: '#9E9E9E', textColor: '#616161',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>',
        label: 'Reserviert'
      },
      'no_show': {
        bg: 'rgba(255, 255, 255, 0.9)', color: '#BDBDBD', textColor: '#757575',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>',
        label: 'No Show'
      },

      // === STATUS-BASIERTE MAPPINGS ===
      'finished': {
        bg: 'rgba(76, 175, 80, 0.1)', color: '#4CAF50', textColor: '#2E7D32',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M20 6L9 17l-5-5"/></svg>',
        label: 'Abgeschlossen'
      },
      'canceled': {
        bg: 'rgba(244, 67, 54, 0.1)', color: '#F44336', textColor: '#C62828',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>',
        label: 'Storniert'
      },
      'rescheduled': {
        bg: 'rgba(0, 188, 212, 0.1)', color: '#00BCD4', textColor: '#00838F',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>',
        label: 'Verschoben'
      },
      'scheduled': {
        bg: 'rgba(33, 150, 243, 0.1)', color: '#2196F3', textColor: '#1565C0',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
        label: 'Geplant'
      },
      'unknown': {
        bg: 'rgba(158, 158, 158, 0.1)', color: '#9E9E9E', textColor: '#616161',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>',
        label: 'Unbekannt'
      },

      // === EVENTS KATEGORIE ===
      'event': {
        bg: 'rgba(255, 152, 0, 0.1)', color: '#FF9800', textColor: '#E65100',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
        label: 'Event'
      },
      'event_required': {
        bg: 'rgba(244, 67, 54, 0.1)', color: '#F44336', textColor: '#C62828',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
        label: 'Event (Pflicht)'
      },
      // Guest Spot Kategorie
      'guest_spot': {
        bg: 'rgba(88, 86, 214, 0.1)', color: '#5856D6', textColor: '#4B49B6',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
        label: 'Guest Spot'
      }
    };

    // Global verfÃ¼gbar machen
    window.calendarCategoryConfig = calendarCategoryConfig;

    // === HELPER FUNCTION: Typ aus Appointment ermitteln ===
    function getAppointmentCategory(apt) {
      if (!apt) return 'unknown';
      // PrioritÃ¤t: work_process > booking_type > status > 'unknown'
      const workProcess = (apt.work_process || apt.workProcess || '').toLowerCase().trim();
      const bookingType = (apt.booking_type || apt.bookingType || apt.type || '').toLowerCase().trim();
      const status = (apt.status || '').toLowerCase().trim();

      // Wannado Prefix erkennen
      if (workProcess.startsWith('wannado')) return 'wannado';

      // work_process direkt matchen
      if (calendarCategoryConfig[workProcess]) return workProcess;

      // booking_type matchen
      if (calendarCategoryConfig[bookingType]) return bookingType;

      // status als Fallback
      if (calendarCategoryConfig[status]) return status;

      return 'unknown';
    }

    window.getAppointmentCategory = getAppointmentCategory;

    // ==========================================
    // BOOKING TEAM MEMBERS (Dynamic Loading)
    // ==========================================
    let bookingTeamMembers = [];

    // Team Members aus Datenbank laden
    async function loadBookingTeamMembers() {
      try {
        const { data, error } = await supabase
          .from('booking_team_members')  // View aus Supabase
          .select('id, username, email, role')  // OHNE avatar_url - Spalte existiert nicht
          .order('username', { ascending: true });

        if (error) {
          console.warn('âš ï¸ booking_team_members view error, using fallback:', error.message);
          // Fallback: Direkt aus profiles laden
          const { data: profiles, error: profileError } = await supabase
            .from('profiles')
            .select('id, username, email, role')  // OHNE avatar_url
            .in('role', ['admin', 'booking', 'management', 'team']);

          if (!profileError && profiles) {
            bookingTeamMembers = profiles;
            console.log('âœ… Team loaded from profiles:', bookingTeamMembers.length);
            return bookingTeamMembers;
          }

          // Letzter Fallback: Hardcoded
          bookingTeamMembers = [
            { id: '4048a85a-7018-4003-b4a1-41b05676c758', username: 'Aman', role: 'team' },
            { id: '48c82f73-8e00-437f-af32-b1ec13b12d4e', username: 'Bennet', role: 'team' },
            { id: 'b67d032d-5206-498f-b4ec-0e145d468052', username: 'Cara', role: 'team' },
            { id: '77c75e8e-8b4e-4502-9f78-93b1936097c6', username: 'Dennis', role: 'team' },
            { id: 'feb0f09d-4461-44c5-a769-67a7716ba7ad', username: 'Fay', role: 'team' },
            { id: 'feef5b54-4506-4324-af8b-1617636e3ee2', username: 'Jan', role: 'team' }
          ];
          return bookingTeamMembers;
        }

        bookingTeamMembers = data || [];
        console.log('âœ… Booking Team geladen:', bookingTeamMembers.length, 'Mitglieder');
        return bookingTeamMembers;

      } catch (err) {
        console.error('âŒ loadBookingTeamMembers error:', err);
        // Fallback bei totalem Fehler
        bookingTeamMembers = [
          { id: '4048a85a-7018-4003-b4a1-41b05676c758', username: 'Aman', role: 'team' },
          { id: '48c82f73-8e00-437f-af32-b1ec13b12d4e', username: 'Bennet', role: 'team' },
          { id: 'b67d032d-5206-498f-b4ec-0e145d468052', username: 'Cara', role: 'team' },
          { id: 'feb0f09d-4461-44c5-a769-67a7716ba7ad', username: 'Fay', role: 'team' },
          { id: 'feef5b54-4506-4324-af8b-1617636e3ee2', username: 'Jan', role: 'team' }
        ];
        return bookingTeamMembers;
      }
    }

    // Debug-Funktion fÃ¼r Team Members (in Console aufrufen: debugTeam())
    window.debugTeam = async function() {
      console.log('ðŸ” Current bookingTeamMembers:', bookingTeamMembers);
      console.log('ðŸ” Length:', bookingTeamMembers.length);
      await loadBookingTeamMembers();
      console.log('âœ… After reload:', bookingTeamMembers);
      console.log('âœ… New Length:', bookingTeamMembers.length);
      return bookingTeamMembers;
    };

    // ==========================================
    // FIND OR CREATE CUSTOMER
    // ==========================================
    /**
     * Findet existierenden Customer oder erstellt neuen
     * @param {Object} customerData - { first_name, last_name, email, phone, instagram }
     * @returns {Promise<string|null>} customer_id (UUID) oder null
     */
    async function findOrCreateCustomer(customerData) {
      const { first_name, last_name, email, phone, instagram } = customerData;

      try {
        // 1. Suche per Email (case-insensitive)
        if (email && email.trim()) {
          const { data: existingByEmail, error: emailError } = await supabase
            .from('customers')
            .select('id')
            .ilike('email', email.trim())
            .limit(1);

          // Kein .single() - stattdessen Array prÃ¼fen
          if (!emailError && existingByEmail && existingByEmail.length > 0) {
            console.log('âœ… Customer found by email:', existingByEmail[0].id);
            return existingByEmail[0].id;
          }
        }

        // 2. Suche per Phone
        if (phone && phone.trim()) {
          const normalizedPhone = phone.replace(/\s+/g, '').replace(/[^0-9+]/g, '');
          if (normalizedPhone.length >= 6) {
            const { data: existingByPhone, error: phoneError } = await supabase
              .from('customers')
              .select('id')
              .ilike('phone', `%${normalizedPhone.slice(-8)}%`)
              .limit(1);

            if (!phoneError && existingByPhone && existingByPhone.length > 0) {
              console.log('âœ… Customer found by phone:', existingByPhone[0].id);
              return existingByPhone[0].id;
            }
          }
        }

        // 3. Neuen Customer erstellen
        const { data: newCustomer, error: insertError } = await supabase
          .from('customers')
          .insert({
            first_name: first_name?.trim() || null,
            last_name: last_name?.trim() || null,
            email: email?.trim().toLowerCase() || null,
            phone: phone?.trim() || null,
            instagram: instagram?.trim() || null,
            rank: 'Bronze',
            total_bookings: 0,
            total_spent: 0
          })
          .select('id')
          .single();

        if (insertError) {
          console.error('âŒ Error creating customer:', insertError);
          return null; // Nicht werfen, Request trotzdem erstellen
        }

        console.log('âœ… New customer created:', newCustomer.id);
        return newCustomer.id;

      } catch (err) {
        console.error('âŒ findOrCreateCustomer error:', err);
        return null; // Nicht werfen, Request trotzdem erstellen
      }
    }

    // ==========================================
    // CREATE APPOINTMENT FROM REQUEST
    // ==========================================
    /**
     * Erstellt ein vollstÃ¤ndiges Appointment aus einem Request
     * ÃœbertrÃ¤gt ALLE relevanten Daten inkl. IDs und Tattoo-Details
     * @param {Object} request - Der vollstÃ¤ndige Request mit Relations
     * @param {Object} options - { projectId, projectNumber } optional
     * @returns {Promise<Object>} Das erstellte Appointment
     */
    async function createAppointmentFromRequest(request, options = {}) {
      const { projectId, projectNumber } = options;

      // Datum und Zeit
      const scheduledDate = request.scheduled_date
        ? new Date(request.scheduled_date)
        : new Date();

      const startTime = request.start_time || '10:00';
      const endTime = request.end_time || '12:00';

      const [startHour, startMin] = startTime.split(':');
      const startDateTime = new Date(scheduledDate);
      startDateTime.setHours(parseInt(startHour), parseInt(startMin), 0, 0);

      const [endHour, endMin] = endTime.split(':');
      const endDateTime = new Date(scheduledDate);
      endDateTime.setHours(parseInt(endHour), parseInt(endMin), 0, 0);

      // VollstÃ¤ndiges Appointment
      const appointmentData = {
        // IDs
        request_id: request.id,
        customer_id: request.customer_id || null,
        artist_id: request.artist_id || null,
        location_id: request.location_id || null,
        project_id: projectId || null,
        project_number: projectNumber || null,

        // Emails
        customer_email: request.email || request.customer?.email || null,
        artist_email: request.artist?.email || null,

        // Zeit
        start: startDateTime.toISOString(),
        end: endDateTime.toISOString(),

        // Tattoo-Details
        placement: request.placement || null,
        size: request.size || null,
        style: request.style || null,
        colorway: request.colorway || null,
        description: request.description || null,
        reference_images: request.reference_images || null,
        booking_type: request.booking_type || null,
        priority: request.priority || null,

        // Status
        status: 'scheduled',
        state: 'Zugesagt',
        payment_status: request.payment_status || 'unpaid',
        payment_amount: request.total_amount || null,

        // Meta
        created_at: new Date().toISOString()
      };

      console.log('ðŸ“… Creating appointment:', appointmentData);

      const { data: appointment, error } = await supabase
        .from('appointments')
        .insert(appointmentData)
        .select()
        .single();

      if (error) {
        console.error('âŒ Error creating appointment:', error);
        throw error;
      }

      // Bidirektional verknÃ¼pfen
      await supabase
        .from('requests')
        .update({ appointment_id: appointment.id })
        .eq('id', request.id);

      console.log('âœ… Appointment created:', appointment.id);
      return appointment;
    }

    // ==========================================
    // SCHEDULE WITH PAYMENT - Edge Function
    // ==========================================
    /**
     * Schedule + Payment Link via Edge Function
     * @param {string} requestId - Die Request ID (optional)
     */
    async function scheduleWithPayment(requestId = null) {
      const targetRequestId = requestId || selectedRequestId || window.selectedRequestId;

      if (!targetRequestId) {
        alert('Kein Request ausgewÃ¤hlt');
        return;
      }

      // Request finden
      const requestsArray = allRequests || window.allRequests || [];
      let request = requestsArray.find(r => r.id === targetRequestId);

      if (!request) {
        // Direkt aus DB laden
        const { data, error } = await supabase
          .from('requests')
          .select(`*, customer:customers(*), artist:artists(*), location:locations!requests_location_id_fkey(*)`)
          .eq('id', targetRequestId)
          .single();

        if (error || !data) {
          alert('Request nicht gefunden');
          return;
        }
        request = data;
      }

      // Validierungen
      if (!request.artist_id) {
        alert('Bitte erst einen Artist auswÃ¤hlen');
        return;
      }
      if (!request.scheduled_date) {
        alert('Bitte erst ein Datum auswÃ¤hlen');
        return;
      }
      if (!request.total_amount || request.total_amount <= 0) {
        alert('Bitte erst den Preis eingeben');
        return;
      }

      const customerEmail = request.email || request.customer?.email;
      if (!customerEmail) {
        alert('Keine Email-Adresse vorhanden');
        return;
      }

      // Confirmation
      const artistName = request.artist?.name || 'Artist';
      const scheduledDate = new Date(request.scheduled_date).toLocaleDateString('de-DE');
      const confirmed = confirm(
        `Termin bestÃ¤tigen und Payment Link senden?\n\n` +
        `ðŸ“… Datum: ${scheduledDate}\n` +
        `ðŸŽ¨ Artist: ${artistName}\n` +
        `ðŸ’° Betrag: ${request.total_amount.toFixed(2)} â‚¬\n` +
        `ðŸ“§ Email: ${customerEmail}`
      );

      if (!confirmed) return;

      // Button Status
      const btn = event?.target;
      const originalText = btn?.innerHTML;
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = 'â³ Wird verarbeitet...';
      }

      try {
        console.log('ðŸš€ Calling Edge Function...');

        // Edge Function mit Timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 Sekunden Timeout

        const response = await fetch(
          'https://auxxyehgzkozdjylhqnx.supabase.co/functions/v1/create-payment-link',
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1eHh5ZWhnemtvemRqeWxocW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDczODgsImV4cCI6MjA3NjEyMzM4OH0.bg8NunF2qkps28Aj0ZqY35eKK--QOu8NduCkFyqp5KA',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1eHh5ZWhnemtvemRqeWxocW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDczODgsImV4cCI6MjA3NjEyMzM4OH0.bg8NunF2qkps28Aj0ZqY35eKK--QOu8NduCkFyqp5KA'
            },
            body: JSON.stringify({ request_id: targetRequestId }),
            signal: controller.signal
          }
        );

        clearTimeout(timeoutId);

        const result = await response.json();
        console.log('ðŸ“¥ Edge Function Response:', result);

        if (!result.success) {
          throw new Error(result.error || 'Unbekannter Fehler');
        }

        // ERFOLG - UI aktualisieren
        console.log('âœ… Payment Link erstellt:', result.payment_link);

        // Activity Log erstellen
        await supabase.from('request_activity_log').insert({
          request_id: targetRequestId,
          appointment_id: result.appointment_id,
          action: 'scheduled_with_payment',
          action_by: window.currentUsername || 'Unknown',
          details: {
            scheduled_date: request.scheduled_date,
            artist_id: request.artist_id,
            payment_link: result.payment_link
          }
        });

        // Last Action updaten
        await supabase.from('requests').update({
          last_action: 'scheduled_with_payment',
          last_action_at: new Date().toISOString()
        }).eq('id', targetRequestId);

        // Request im Cache aktualisieren
        await updateRequestInCache(targetRequestId, {
          status: 'scheduled',
          payment_status: 'pending',
          stripe_payment_link: result.payment_link,
          appointment_id: result.appointment_id
        });

        // Tabs neu filtern
        if (typeof filterAndRenderRequests === 'function') {
          filterAndRenderRequests();
        }

        // Detail-View schlieÃŸen oder aktualisieren
        if (typeof closeRequestDetail === 'function') {
          closeRequestDetail();
        }

        alert(
          `âœ… Erfolgreich!\n\n` +
          `ðŸ“… Appointment erstellt\n` +
          `ðŸ’³ Payment Link: ${result.payment_link}\n` +
          `ðŸ“§ Email an: ${result.email_sent_to || customerEmail}`
        );

      } catch (err) {
        console.error('âŒ Error:', err);

        // Bei Timeout trotzdem prÃ¼fen ob es geklappt hat
        if (err.name === 'AbortError') {
          const checkResult = await checkPaymentLinkCreated(targetRequestId);
          if (checkResult) {
            alert('âœ… Payment Link wurde erstellt (Verbindung war langsam)\n\n' + checkResult);
            await updateRequestInCache(targetRequestId, { status: 'scheduled', payment_status: 'pending' });
            if (typeof filterAndRenderRequests === 'function') filterAndRenderRequests();
            return;
          }
        }

        alert('Fehler: ' + err.message);

      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText || 'ðŸ’³ Schedule + Payment Link';
        }
      }
    }

    /**
     * PrÃ¼ft ob Payment Link trotz Timeout erstellt wurde
     */
    async function checkPaymentLinkCreated(requestId) {
      try {
        const { data } = await supabase
          .from('requests')
          .select('stripe_payment_link, status, appointment_id')
          .eq('id', requestId)
          .single();

        if (data?.stripe_payment_link) {
          return `Payment Link: ${data.stripe_payment_link}`;
        }
        return null;
      } catch {
        return null;
      }
    }

    /**
     * Request im lokalen Cache aktualisieren
     */
    async function updateRequestInCache(requestId, updates) {
      // Lokalen Cache aktualisieren
      const requestsArray = allRequests || window.allRequests || [];
      const index = requestsArray.findIndex(r => r.id === requestId);

      if (index !== -1) {
        Object.assign(requestsArray[index], updates);
        console.log('âœ… Cache updated for request:', requestId);
      }

      // Auch von DB neu laden fÃ¼r vollstÃ¤ndige Daten
      if (typeof refreshSingleRequest === 'function') {
        await refreshSingleRequest(requestId);
      } else if (typeof window.refreshSingleRequest === 'function') {
        await window.refreshSingleRequest(requestId);
      }
    }

    // Global machen
    window.scheduleWithPayment = scheduleWithPayment;
    window.checkPaymentLinkCreated = checkPaymentLinkCreated;
    window.updateRequestInCache = updateRequestInCache;

    /**
     * Schedule Appointment OHNE Payment Link
     * Erstellt nur einen Termin, sendet keine Email
     * @param {string} requestId - Die Request ID (optional)
     */
    async function scheduleAppointmentDirect(requestId = null) {
      const targetRequestId = requestId || selectedRequestId || window.selectedRequestId;

      if (!targetRequestId) {
        alert('Kein Request ausgewÃ¤hlt');
        return;
      }

      // Request finden
      const requestsArray = allRequests || window.allRequests || [];
      let request = requestsArray.find(r => r.id === targetRequestId);

      if (!request) {
        // Direkt aus DB laden
        const { data, error } = await supabase
          .from('requests')
          .select(`*, customer:customers(*), artist:artists(*), location:locations!requests_location_id_fkey(*)`)
          .eq('id', targetRequestId)
          .single();

        if (error || !data) {
          alert('Request nicht gefunden');
          return;
        }
        request = data;
      }

      // Validierungen
      if (!request.artist_id) {
        alert('Bitte erst einen Artist auswÃ¤hlen');
        return;
      }
      if (!request.scheduled_date) {
        alert('Bitte erst ein Datum auswÃ¤hlen');
        return;
      }

      // Confirmation
      const artistName = request.artist?.name || 'Artist';
      const scheduledDate = new Date(request.scheduled_date).toLocaleDateString('de-DE');
      const confirmed = confirm(
        `Termin erstellen (ohne Payment Link)?\n\n` +
        `ðŸ“… Datum: ${scheduledDate}\n` +
        `ðŸŽ¨ Artist: ${artistName}\n\n` +
        `âš ï¸ Es wird KEIN Payment Link erstellt und KEINE Email gesendet.`
      );

      if (!confirmed) return;

      // Button Status
      const btn = event?.target;
      const originalText = btn?.innerHTML;
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = 'â³ Wird erstellt...';
      }

      try {
        console.log('ðŸ“… Creating Appointment without Payment...');

        // Datum und Zeit vorbereiten
        const scheduledDateObj = new Date(request.scheduled_date);
        const startTime = request.start_time || '10:00';
        const endTime = request.end_time || '12:00';

        const [startHour, startMin] = startTime.split(':').map(Number);
        const [endHour, endMin] = endTime.split(':').map(Number);

        const startDateTime = new Date(scheduledDateObj);
        startDateTime.setHours(startHour, startMin, 0, 0);

        const endDateTime = new Date(scheduledDateObj);
        endDateTime.setHours(endHour, endMin, 0, 0);

        // Appointment erstellen
        const { data: appointment, error: aptError } = await supabase
          .from('appointments')
          .insert({
            request_id: request.id,
            customer_id: request.customer_id,
            artist_id: request.artist_id,
            location_id: request.location_id,
            customer_email: request.email || request.customer?.email,
            start: startDateTime.toISOString(),
            end: endDateTime.toISOString(),
            placement: request.placement,
            size: request.size,
            style: request.style,
            colorway: request.colorway,
            description: request.description,
            booking_type: request.booking_type,
            priority: request.priority,
            status: 'scheduled',
            state: 'Zugesagt',
            payment_status: 'unpaid',
            payment_amount: request.total_amount || null,
          })
          .select()
          .single();

        if (aptError) {
          throw new Error('Appointment konnte nicht erstellt werden: ' + aptError.message);
        }

        console.log('âœ… Appointment created:', appointment.id);

        // Request updaten
        const { error: updateError } = await supabase
          .from('requests')
          .update({
            status: 'scheduled',
            appointment_id: appointment.id,
          })
          .eq('id', targetRequestId);

        if (updateError) {
          console.error('âš ï¸ Request update error:', updateError);
        }

        console.log('âœ… Request updated to scheduled');

        // Activity Log erstellen
        await supabase.from('request_activity_log').insert({
          request_id: targetRequestId,
          appointment_id: appointment.id,
          action: 'scheduled',
          action_by: window.currentUsername || 'Unknown',
          details: {
            scheduled_date: request.scheduled_date,
            artist_id: request.artist_id,
            payment_link: null
          }
        });

        // Last Action updaten
        await supabase.from('requests').update({
          last_action: 'scheduled',
          last_action_at: new Date().toISOString()
        }).eq('id', targetRequestId);

        // Cache aktualisieren
        if (typeof updateRequestInCache === 'function') {
          await updateRequestInCache(targetRequestId, {
            status: 'scheduled',
            appointment_id: appointment.id
          });
        } else if (typeof refreshSingleRequest === 'function') {
          await refreshSingleRequest(targetRequestId);
        } else if (typeof window.refreshSingleRequest === 'function') {
          await window.refreshSingleRequest(targetRequestId);
        }

        // Tabs neu filtern
        if (typeof filterAndRenderRequests === 'function') {
          filterAndRenderRequests();
        } else if (typeof window.filterAndRenderRequests === 'function') {
          window.filterAndRenderRequests();
        }

        // Detail-View schlieÃŸen
        if (typeof closeRequestDetail === 'function') {
          closeRequestDetail();
        } else if (typeof window.closeRequestDetail === 'function') {
          window.closeRequestDetail();
        }

        alert(
          `âœ… Termin erstellt!\n\n` +
          `ðŸ“… Datum: ${scheduledDate}\n` +
          `ðŸŽ¨ Artist: ${artistName}\n\n` +
          `â„¹ï¸ Kein Payment Link gesendet.\n` +
          `Der Kunde muss separat kontaktiert werden.`
        );

      } catch (err) {
        console.error('âŒ Error:', err);
        alert('Fehler: ' + err.message);

      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText || 'ðŸ“… Schedule';
        }
      }
    }

    // Global machen
    window.scheduleAppointmentDirect = scheduleAppointmentDirect;

    /**
     * Legacy-Alias fÃ¼r alten Payment Workflow
     * Leitet auf die neue Edge Function-basierte Implementation um
     */
    function openPaymentWorkflowModalNew(requestId) {
      console.warn('âš ï¸ openPaymentWorkflowModalNew() redirects to scheduleWithPayment()');
      scheduleWithPayment(requestId);
    }

    window.openPaymentWorkflowModalNew = openPaymentWorkflowModalNew;

    // ==========================================
    // NAVBAR INDICATORS (Hover + Active)
    // ==========================================
    function setupNavbarHover() {
      const container = document.querySelector('nav.navbar-container');
      if (!container) return;

      const hoverBg = container.querySelector('.hover-background');
      const activeIndicator = container.querySelector('.active-indicator');
      if (!hoverBg || !activeIndicator) return;

      const links = container.querySelectorAll('.nav-link');

      // Funktion: Active-Indikator positionieren
      function updateActiveIndicator() {
        const activeLink = container.querySelector('.nav-link.active');
        if (activeLink) {
          const rect = activeLink.getBoundingClientRect();
          const containerRect = container.getBoundingClientRect();
          activeIndicator.style.width = rect.width + 'px';
          activeIndicator.style.left = (rect.left - containerRect.left) + 'px';
        }
      }

      // Initial Position
      updateActiveIndicator();

      // Hover: Grauer Container bewegt sich
      links.forEach(link => {
        link.addEventListener('mouseenter', function() {
          if (window.innerWidth > 768) {
            const rect = this.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            hoverBg.style.width = rect.width + 'px';
            hoverBg.style.left = (rect.left - containerRect.left) + 'px';
            hoverBg.style.opacity = '1';
          }
        });
      });

      // Mouse leave: Hover-Background ausblenden
      container.addEventListener('mouseleave', function() {
        hoverBg.style.opacity = '0';
      });

      // Update bei Tab-Click
      links.forEach(link => {
        link.addEventListener('click', function() {
          setTimeout(updateActiveIndicator, 10);
        });
      });

      // Update bei Resize
      window.addEventListener('resize', updateActiveIndicator);
    }

    // ==========================================
    // MOBILE NAVIGATION
    // ==========================================
    function setupMobileNavigation() {
      const mobileFooterNav = document.querySelector('.mobile-footer-nav');
      const isMobile = window.innerWidth <= 768;

      if (isMobile && mobileFooterNav) {
        mobileFooterNav.style.display = 'flex';
        // Note: Click handlers are registered once in DOMContentLoaded (line ~34068)
        // to avoid duplicate event listeners
      } else if (mobileFooterNav) {
        mobileFooterNav.style.display = 'none';
      }
    }

    // Named handler function for mobile navigation clicks
    function handleMobileNavClick(e) {
      e.preventDefault();
      e.stopPropagation();

      const viewName = this.dataset.mobileView;
      console.log('ðŸ“± Mobile nav clicked:', viewName);

      if (!viewName) return;

      // Update active state for mobile nav
      document.querySelectorAll('.mobile-nav-item').forEach(i => i.classList.remove('active'));
      this.classList.add('active');

      // Hide all sections first
      document.querySelectorAll('section[id$="-section"]').forEach(section => {
        section.style.display = 'none';
        section.classList.remove('active');
      });

      // Show the selected section
      const sectionElement = document.getElementById(viewName + '-section');
      if (sectionElement) {
        sectionElement.style.display = 'block';
        sectionElement.classList.add('active');
        console.log('âœ… Switched to section:', viewName + '-section');
      } else {
        console.error('âŒ Section not found:', viewName + '-section');
      }

      // Also update desktop nav active state if exists
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.dataset.view === viewName) {
          link.classList.add('active');
        }
      });

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ========================================
    // RETRY LOGIC FOR NETWORK REQUESTS
    // ========================================

    /**
     * Retry a Supabase request with exponential backoff
     * @param {Function} requestFn - Async function that returns a Supabase query
     * @param {number} maxRetries - Maximum number of retries (default: 3)
     * @param {number} baseDelay - Base delay in ms (default: 1000)
     * @returns {Promise} - The successful result or throws final error
     */
    async function retryWithBackoff(requestFn, maxRetries = 3, baseDelay = 1000) {
      let lastError = null;

      for (let attempt = 0; attempt <= maxRetries; attempt++) {
        try {
          const result = await requestFn();

          // Check for Supabase error
          if (result.error) {
            throw result.error;
          }

          return result;
        } catch (error) {
          lastError = error;

          // Don't retry on final attempt
          if (attempt === maxRetries) {
            break;
          }

          // Calculate exponential backoff delay
          const delay = baseDelay * Math.pow(2, attempt);
          const jitter = Math.random() * 200; // Add jitter to prevent thundering herd
          const totalDelay = delay + jitter;

          console.warn(`âš ï¸ Request failed (attempt ${attempt + 1}/${maxRetries + 1}), retrying in ${Math.round(totalDelay)}ms...`, error.message);

          // Wait before retrying
          await new Promise(resolve => setTimeout(resolve, totalDelay));
        }
      }

      // All retries failed
      console.error('âŒ All retry attempts failed:', lastError);
      throw lastError;
    }

    // ========================================
    // LOADING PROGRESS BAR SYSTEM
    // ========================================

    const ProgressBar = {
      overlay: null,
      fill: null,
      percent: null,
      text: null,
      currentProgress: 0,

      init() {
        this.overlay = document.getElementById('loadingOverlay');
        this.fill = document.getElementById('progressFill');
        this.percent = document.getElementById('progressPercent');
        this.text = document.getElementById('progressText');
      },

      show(message = 'Loading data...') {
        if (!this.overlay) this.init();
        this.currentProgress = 0;
        this.overlay.classList.remove('hidden');
        this.updateProgress(0, message);
      },

      updateProgress(progress, message = null) {
        if (!this.overlay) this.init();
        this.currentProgress = Math.min(100, Math.max(0, progress));
        this.fill.style.width = this.currentProgress + '%';
        this.percent.textContent = Math.round(this.currentProgress) + '%';
        if (message) {
          this.text.textContent = message;
        }
      },

      hide() {
        if (!this.overlay) this.init();
        this.updateProgress(100, 'Complete!');
        setTimeout(() => {
          this.overlay.classList.add('hidden');
        }, 300);
      },

      // Simulate progress for async operations
      simulateProgress(startPercent, endPercent, duration, message) {
        return new Promise((resolve) => {
          const start = this.currentProgress || startPercent;
          const diff = endPercent - start;
          const steps = 20;
          const stepDuration = duration / steps;
          let currentStep = 0;

          const interval = setInterval(() => {
            currentStep++;
            const progress = start + (diff * (currentStep / steps));
            this.updateProgress(progress, message);

            if (currentStep >= steps) {
              clearInterval(interval);
              resolve();
            }
          }, stepDuration);
        });
      }
    };

    // ========================================
    // PAYMENT SYSTEM CONFIGURATION
    // ========================================

    // Stripe Configuration (TEST MODE for now)
    // ðŸ” IMPORTANT: Replace these placeholders with your actual Stripe API keys
    const STRIPE_SECRET_KEY = 'INSERT_STRIPE_SECRET_KEY_HERE'; // Get from https://dashboard.stripe.com/test/apikeys
    const STRIPE_PUBLISHABLE_KEY = 'INSERT_STRIPE_PUBLISHABLE_KEY_HERE'; // Get from https://dashboard.stripe.com/test/apikeys

    // Resend Configuration (for email sending)
    // ðŸ” IMPORTANT: Replace this placeholder with your actual Resend API key
    const RESEND_API_KEY = 'INSERT_RESEND_API_KEY_HERE'; // Get from https://resend.com/api-keys

    // Email Configuration
    const EMAIL_FROM = 'onboarding@resend.dev'; // Testing email - no domain verification needed
    const EMAIL_REPLY_TO = 'info@mommyimsorry.com';

    // Business Information (used in email template)
    const BUSINESS_INFO = {
      name: 'Mommy I\'m Sorry Verwaltung GmbH',
      iban: 'DE65 6005 0101 0405 7944 09',
      address: 'TÃ¼binger Str. 73',
      city: '70178 Stuttgart',
      phone: '071151875672',
      email: 'Info@mommyimsorry.com',
      instagram: '@mommyimsorry',
      faq_url: 'https://www.mommyimsorry.com/faq'
    };

    // ============================================
    // PERMISSION HELPER FUNCTIONS
    // ============================================

    // Permission check function
    async function userHasPermission(permission) {
      try {
        const { data, error } = await supabase.rpc('user_has_permission', {
          p_permission: permission
        });

        if (error) {
          console.error('Permission check error:', error);
          return false;
        }

        return data === true;
      } catch (err) {
        console.error('Permission check failed:', err);
        return false;
      }
    }

    // Get current user role
    async function getCurrentUserRole() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return 'guest';

        const { data: profile } = await supabase
          .from('profiles')
          .select('role')
          .eq('id', user.id)
          .single();

        return profile?.role || 'user';
      } catch (err) {
        console.error('Error getting user role:', err);
        return 'guest';
      }
    }

    let currentDate = new Date();
    let dienstplanDate = new Date();
    let agreementsDate = new Date();
    let events = [];
    let loadedDateRangeStart = null;
    let loadedDateRangeEnd = null;
    let allArtists = [];
    let allTeamMembers = [];
    let allLocations = []; // FIXED: Declare allLocations globally to prevent undefined errors
    let currentTimeIndicatorInterval = null; // FIXED: Track interval to prevent memory leak

    // Sorting state
    let artistSortConfig = { field: 'name', order: 'asc' };
    let customerSortConfig = { field: 'created_at', order: 'desc' };
    let currentEditingEvent = null;
    let selectedLocationId = null;
    let showCanceledGuestSpots = false; // Checkbox fÃ¼r stornierte Guest Spots im Kalender
    let selectedDienstplanLocationId = null;
    let selectedAgreementsLocationId = null;
    let currentLocationName = '';
    let openCategories = new Set();
    let currentAgreementEventId = null;
    let agreementFiles = [];
    
    // Category visibility state
    let visibleCategories = {
      events: true,
      residents: true,
      guests: true
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ZENTRALES CACHE-SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const DataCache = {
      config: {
        requests:     { ttl: 5 * 60 * 1000,  data: null, timestamp: null, loading: false },
        artists:      { ttl: 10 * 60 * 1000, data: null, timestamp: null, loading: false },
        customers:    { ttl: 10 * 60 * 1000, data: null, timestamp: null, loading: false },
        appointments: { ttl: 2 * 60 * 1000,  data: null, timestamp: null, loading: false },
        dashboard:    { ttl: 2 * 60 * 1000,  data: null, timestamp: null, loading: false }
      },

      get(key) {
        const cache = this.config[key];
        if (!cache) return null;
        if (cache.data && cache.timestamp && (Date.now() - cache.timestamp < cache.ttl)) {
          console.log(`ðŸ“¦ Cache HIT: ${key} (${Math.round((Date.now() - cache.timestamp) / 1000)}s old)`);
          return cache.data;
        }
        console.log(`ðŸ“­ Cache MISS: ${key}`);
        return null;
      },

      set(key, data) {
        if (this.config[key]) {
          this.config[key].data = data;
          this.config[key].timestamp = Date.now();
          this.config[key].loading = false;
          console.log(`ðŸ’¾ Cache SET: ${key} (${Array.isArray(data) ? data.length + ' items' : 'object'})`);
        }
      },

      invalidate(key) {
        if (key) {
          if (this.config[key]) {
            this.config[key].data = null;
            this.config[key].timestamp = null;
            console.log(`ðŸ—‘ï¸ Cache INVALIDATED: ${key}`);
          }
        } else {
          // Invalidate all caches
          Object.keys(this.config).forEach(k => {
            this.config[k].data = null;
            this.config[k].timestamp = null;
          });
          console.log('ðŸ—‘ï¸ ALL CACHES INVALIDATED');
        }
      },

      isLoading(key) {
        return this.config[key]?.loading || false;
      },

      setLoading(key, loading) {
        if (this.config[key]) this.config[key].loading = loading;
      }
    };

    // Global function for manual refresh
    window.refreshData = function(dataType) {
      DataCache.invalidate(dataType);
      switch(dataType) {
        case 'requests': loadRequests({ forceReload: true }); break;
        case 'artists': loadArtists(true); break;
        case 'customers': loadCustomers(true); break;
        case 'appointments': loadEvents(); break;
        case 'dashboard': loadDashboard(); break;
        default: DataCache.invalidate(); location.reload();
      }
    };

    // Make DataCache globally available
    window.DataCache = DataCache;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CENTRAL DATA MANAGER - Einmaliges Laden & Realtime Updates
    // Version: 2025-12-16
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const CentralDataManager = {
      // Zentrale Datenspeicherung
      data: {
        requests: [],
        artists: [],
        customers: [],
        appointments: [],
        dienstplan: [],
        workTracking: [],
        locations: [],
        profiles: [],
        wannados: [],
        projectTasks: [],
        taskProjects: [],
        projects: []  // NEU: Projects fÃ¼r Analytics
      },

      // Lade-Status
      loadingStatus: {
        isInitialLoadComplete: false,
        isLoading: false,
        loadedTables: new Set(),
        errors: []
      },

      // Progress Tracking
      progress: {
        totalRecords: 0,
        loadedRecords: 0,
        currentPercent: 0
      },

      // Realtime Subscriptions
      subscriptions: {},

      // UI Update Listeners (fÃ¼r Tab-Refreshes)
      listeners: {},

      // Status Texts fÃ¼r jede Tabelle
      statusTexts: {
        locations: 'Lade Standorte...',
        profiles: 'Lade Profile...',
        artists: 'Lade Artists...',
        appointments: 'Lade Termine...',
        dienstplan: 'Lade Dienstplan...',
        work_tracking: 'Lade Arbeitszeiten...',
        requests: 'Lade Anfragen...',
        customers: 'Lade Kunden...',
        projects: 'Lade Projekte...',
        wannados: 'Lade Wannados...',
        project_tasks: 'Lade Aufgaben...',
        task_projects: 'Lade Task-Projekte...'
      },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // BATCH LOADING CONFIGURATION
      // Optimiert fÃ¼r Timeout-Vermeidung: kleinere Batches, weniger parallel
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      tableConfig: {
        // Kleine Tabellen - schnell laden
        locations:     { batchSize: 100,  parallel: 1, relations: '*' },
        profiles:      { batchSize: 100,  parallel: 1, relations: '*' },
        task_projects: { batchSize: 100,  parallel: 1, relations: '*' },
        wannados:      { batchSize: 500,  parallel: 1, relations: '*' },
        project_tasks: { batchSize: 500,  parallel: 1, relations: '*' },
        work_tracking: { batchSize: 500,  parallel: 1, relations: '*' },
        artists:       { batchSize: 500,  parallel: 1, relations: '*' },

        // Mittlere Tabellen - moderate Batches
        // Dienstplan MIT Artist Relations fÃ¼r Namen-Anzeige
        dienstplan:    { batchSize: 1000, parallel: 2, relations: '*, artist:artists!artist_id(id, name, email, instagram, rank, is_guest), location:locations!location_id(id, name, city)' },
        appointments:  { batchSize: 1000, parallel: 1, relations: '*, customer:customers(id, first_name, last_name, email, phone), artist:artists(id, name, email, is_guest)' },

        // GroÃŸe Tabellen - kleinere Batches, einfache Relations
        customers:     { batchSize: 2000, parallel: 2, relations: '*' },
        // âœ… WICHTIG: Requests von View laden fÃ¼r korrekten customer_rank
        requests:      { batchSize: 2000, parallel: 2, relations: '*', viewName: 'request_cards_view' },
        projects:      { batchSize: 1000, parallel: 2, relations: '*' }
      },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // INITIAL LOAD - Mit Smooth Progress Tracking
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async initialLoad() {
        if (this.loadingStatus.isLoading) {
          console.log('â³ Initial load already in progress...');
          return;
        }

        this.loadingStatus.isLoading = true;
        console.log('ðŸš€ CENTRAL DATA MANAGER - Starting initial load...');

        const startTime = Date.now();

        try {
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // STEP 1: ZÃ¤hle alle Records fÃ¼r Progress-Berechnung
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          LoadingScreen.updateProgress(0, 'Initialisiere...');

          const tablesToLoad = Object.keys(this.tableConfig);
          const counts = {};

          console.log('ðŸ“Š Counting records in all tables...');

          await Promise.all(tablesToLoad.map(async (table) => {
            try {
              const { count, error } = await supabase
                .from(table)
                .select('*', { count: 'exact', head: true });

              counts[table] = error ? 0 : (count || 0);
            } catch (e) {
              counts[table] = 0;
            }
          }));

          this.progress.totalRecords = Object.values(counts).reduce((a, b) => a + b, 0);
          this.progress.loadedRecords = 0;
          this.progress.currentPercent = 0;

          console.log('ðŸ“Š Total records to load:', this.progress.totalRecords);
          console.log('ðŸ“Š Breakdown:', counts);

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // STEP 2: Lade alle Tabellen mit Progress Tracking
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          // Kleine Tabellen zuerst (schnell, blockiert nicht)
          await this.loadTableWithProgress('locations', counts.locations);
          await this.loadTableWithProgress('profiles', counts.profiles);
          await this.loadTableWithProgress('artists', counts.artists);
          console.log('âœ… Phase 1 complete: Stammdaten geladen');

          // Mittlere Tabellen parallel
          await Promise.all([
            this.loadTableWithProgress('appointments', counts.appointments),
            this.loadTableWithProgress('dienstplan', counts.dienstplan),
            this.loadTableWithProgress('work_tracking', counts.work_tracking)
          ]);
          console.log('âœ… Phase 2 complete: Termine & Dienstplan geladen');

          // GroÃŸe Tabellen parallel
          await Promise.all([
            this.loadTableWithProgress('requests', counts.requests),
            this.loadTableWithProgress('customers', counts.customers),
            this.loadTableWithProgress('projects', counts.projects)
          ]);
          console.log('âœ… Phase 3 complete: Anfragen, Kunden & Projekte geladen');

          // Restliche Tabellen
          await Promise.all([
            this.loadTableWithProgress('wannados', counts.wannados),
            this.loadTableWithProgress('project_tasks', counts.project_tasks),
            this.loadTableWithProgress('task_projects', counts.task_projects)
          ]);
          console.log('âœ… Phase 4 complete: Alle Daten geladen');

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // STEP 3: Finalisieren
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          // Sync mit globalen Variablen fÃ¼r KompatibilitÃ¤t
          this.syncToGlobalVariables();

          // Setup Realtime Subscriptions
          this.setupRealtimeSubscriptions();

          this.loadingStatus.isInitialLoadComplete = true;
          this.loadingStatus.isLoading = false;

          const duration = ((Date.now() - startTime) / 1000).toFixed(2);
          console.log(`ðŸŽ‰ CENTRAL DATA MANAGER - Initial load complete in ${duration}s`);
          console.log('ðŸ“Š Data counts:', {
            requests: this.data.requests.length,
            customers: this.data.customers.length,
            artists: this.data.artists.length,
            appointments: this.data.appointments.length,
            dienstplan: this.data.dienstplan.length,
            locations: this.data.locations.length,
            projects: this.data.projects.length
          });

          // Ensure we're at 100%
          LoadingScreen.updateProgress(100, 'Fertig!');

          // Check fÃ¼r gespeicherte Session
          await this.checkSavedSession();

        } catch (error) {
          console.error('âŒ CENTRAL DATA MANAGER - Initial load failed:', error);
          this.loadingStatus.errors.push(error);
          this.loadingStatus.isLoading = false;
          LoadingScreen.updateProgress(0, 'Fehler beim Laden!');
          throw error;
        }
      },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // LOAD TABLE WITH PROGRESS - Smooth 1% Updates
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async loadTableWithProgress(tableName, expectedCount) {
        const config = this.tableConfig[tableName];
        if (!config) {
          console.warn(`âš ï¸ No config for table: ${tableName}`);
          return;
        }

        const normalizedName = this.normalizeTableName(tableName);
        const statusText = this.statusTexts[tableName] || `Lade ${tableName}...`;

        // âœ… NEU: Verwende View wenn konfiguriert (z.B. request_cards_view fÃ¼r requests)
        const sourceTable = config.viewName || tableName;
        console.log(`ðŸ“¥ Loading ${tableName} from ${sourceTable} (expecting ${expectedCount} records)...`);

        try {
          if (expectedCount === 0) {
            this.data[normalizedName] = [];
            this.loadingStatus.loadedTables.add(tableName);
            return;
          }

          // Kleine Tabellen: Single Request
          if (expectedCount <= config.batchSize) {
            LoadingScreen.updateProgress(this.progress.currentPercent, statusText);

            const { data, error } = await supabase
              .from(sourceTable)
              .select(config.relations)
              .order('created_at', { ascending: false });

            if (error) throw error;

            this.data[normalizedName] = data || [];
            this.progress.loadedRecords += expectedCount;
            this.updateProgressSmooth(statusText);

            // âœ… Debug fÃ¼r requests
            if (tableName === 'requests' && data?.length > 0) {
              console.log('ðŸ“Š Sample request with customer_rank:', data[0]);
              console.log('ðŸ“Š Unique ranks in requests:', [...new Set(data.map(r => r.customer_rank))]);
            }

          } else {
            // GroÃŸe Tabellen: Batch Loading mit Progress pro Batch
            const totalBatches = Math.ceil(expectedCount / config.batchSize);
            let allData = [];

            for (let i = 0; i < totalBatches; i += config.parallel) {
              const batchPromises = [];

              for (let j = 0; j < config.parallel && (i + j) < totalBatches; j++) {
                const start = (i + j) * config.batchSize;
                const end = start + config.batchSize - 1;

                batchPromises.push(
                  supabase
                    .from(sourceTable)
                    .select(config.relations)
                    .order('created_at', { ascending: false })
                    .range(start, end)
                );
              }

              const results = await Promise.all(batchPromises);

              let batchLoaded = 0;
              results.forEach(({ data, error }) => {
                if (error) {
                  console.error(`Batch error for ${tableName}:`, error);
                } else if (data) {
                  allData = allData.concat(data);
                  batchLoaded += data.length;
                }
              });

              // Progress nach jedem Batch-Group Update
              this.progress.loadedRecords += batchLoaded;
              this.updateProgressSmooth(statusText);
            }

            this.data[normalizedName] = allData;

            // âœ… Debug fÃ¼r requests
            if (tableName === 'requests' && allData?.length > 0) {
              console.log('ðŸ“Š Sample request with customer_rank:', allData[0]);
              console.log('ðŸ“Š Unique ranks in requests:', [...new Set(allData.map(r => r.customer_rank))]);
            }
          }

          this.loadingStatus.loadedTables.add(tableName);
          console.log(`âœ… ${tableName}: ${this.data[normalizedName].length} records`);

        } catch (error) {
          console.error(`âŒ Failed to load ${tableName}:`, error);
          this.data[normalizedName] = [];
          this.loadingStatus.errors.push({ table: tableName, error });
        }
      },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // UPDATE PROGRESS SMOOTH - Berechnet % basierend auf geladenen Records
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      updateProgressSmooth(statusText) {
        if (this.progress.totalRecords === 0) {
          this.progress.currentPercent = 100;
        } else {
          // Berechne Prozent basierend auf geladenen Records
          const rawPercent = (this.progress.loadedRecords / this.progress.totalRecords) * 100;

          // Smooth: Nur erhÃ¶hen, nie senken, max 99% bis final
          const newPercent = Math.min(99, Math.floor(rawPercent));

          if (newPercent > this.progress.currentPercent) {
            this.progress.currentPercent = newPercent;
            LoadingScreen.updateProgress(this.progress.currentPercent, statusText);
          }
        }
      },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CHECK SAVED SESSION - SECURE SUPABASE AUTH VERSION
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async checkSavedSession() {
        console.log('ðŸ” Checking for existing session...');

        try {
          // ZUERST: Supabase Auth Session prÃ¼fen
          const { data: { session }, error: sessionError } = await supabase.auth.getSession();

          if (sessionError) {
            console.error('âŒ Session check error:', sessionError.message);
            LoadingScreen.showLogin();
            return false;
          }

          if (session && session.user) {
            console.log('âœ… Active Supabase Auth session found:', session.user.id);

            // Profile via auth_user_id laden
            const { data: profile, error: profileError } = await supabase
              .from('profiles')
              .select('id, username, email, role, avatar_url, location_id, is_active, auth_user_id')
              .eq('auth_user_id', session.user.id)
              .single();

            if (profileError || !profile) {
              console.warn('âš ï¸ No profile found for auth user, signing out...');
              await supabase.auth.signOut();
              this.clearLocalStorage();
              LoadingScreen.showLogin();
              return false;
            }

            // PrÃ¼fen ob User aktiv ist
            if (profile.is_active === false) {
              console.log('âš ï¸ User is deactivated:', profile.username);
              await supabase.auth.signOut();
              this.clearLocalStorage();
              LoadingScreen.showLogin();
              return false;
            }

            // Session gÃ¼ltig!
            console.log('âœ… Session restored for:', profile.username);
            currentUser = profile;
            window.currentUser = profile;

            // LocalStorage aktualisieren
            localStorage.setItem('rememberMe', 'true');
            localStorage.setItem('username', profile.username);
            localStorage.setItem('userRole', profile.role || 'user');
            if (profile.avatar_url) {
              localStorage.setItem('avatarUrl', profile.avatar_url);
            }

            // Update UI
            if (typeof updateUIForUser === 'function') {
              updateUIForUser(profile);
            }

            // Hide Loading Screen
            LoadingScreen.hide();

            // Post-login initialization
            setTimeout(async () => {
              try {
                if (typeof initializePermissions === 'function') {
                  await initializePermissions();
                }
                if (typeof loadInitialData === 'function') {
                  await loadInitialData();
                }
                if (typeof loadEvents === 'function') {
                  await loadEvents();
                }
                if (typeof renderCalendar === 'function') {
                  renderCalendar();
                }
                if (typeof window.loadTodoProjects === 'function') {
                  await window.loadTodoProjects();
                }

                // Mobile UI
                if (window.matchMedia('(max-width: 768px)').matches) {
                  document.body.classList.add('logged-in');
                  document.body.classList.remove('logged-out');
                  const mobileNav = document.querySelector('.mobile-footer-nav');
                  if (mobileNav) mobileNav.classList.add('visible');
                  if (typeof updateMobileProfileData === 'function') updateMobileProfileData();
                  if (typeof initMobileCalendar === 'function') initMobileCalendar();
                  if (typeof initMobileDienstplan === 'function') initMobileDienstplan();
                }

                console.log('âœ… Post-session-restore initialization complete');
              } catch (err) {
                console.error('âš ï¸ Post-session-restore error:', err);
              }
            }, 100);

            return true;
          }

          // Keine aktive Session
          console.log('â„¹ï¸ No active session found');
          this.clearLocalStorage();
          LoadingScreen.showLogin();
          return false;

        } catch (err) {
          console.error('ðŸ’¥ Session check failed:', err);
          LoadingScreen.showLogin();
          return false;
        }
      },

      // Helper: LocalStorage leeren
      clearLocalStorage() {
        localStorage.removeItem('rememberMe');
        localStorage.removeItem('username');
        localStorage.removeItem('userRole');
        localStorage.removeItem('avatarUrl');
      },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // LOAD TABLE - Mit Batch-Loading fÃ¼r groÃŸe Tabellen
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async loadTable(tableName) {
        const config = this.tableConfig[tableName];
        if (!config) {
          console.warn(`âš ï¸ No config for table: ${tableName}`);
          return;
        }

        console.log(`ðŸ“¥ Loading ${tableName}...`);
        const startTime = Date.now();

        try {
          // Erst Count holen
          const { count, error: countError } = await supabase
            .from(tableName)
            .select('*', { count: 'exact', head: true });

          if (countError) throw countError;

          const totalRecords = count || 0;

          if (totalRecords === 0) {
            this.data[this.normalizeTableName(tableName)] = [];
            this.loadingStatus.loadedTables.add(tableName);
            console.log(`âœ… ${tableName}: 0 records`);
            return;
          }

          // Kleine Tabellen: Single Request
          if (totalRecords <= config.batchSize) {
            const { data, error } = await supabase
              .from(tableName)
              .select(config.relations)
              .order('created_at', { ascending: false });

            if (error) throw error;
            this.data[this.normalizeTableName(tableName)] = data || [];
          } else {
            // GroÃŸe Tabellen: Parallel Batch Loading
            const totalBatches = Math.ceil(totalRecords / config.batchSize);
            let allData = [];

            for (let i = 0; i < totalBatches; i += config.parallel) {
              const batchPromises = [];

              for (let j = 0; j < config.parallel && (i + j) < totalBatches; j++) {
                const start = (i + j) * config.batchSize;
                const end = start + config.batchSize - 1;

                batchPromises.push(
                  supabase
                    .from(tableName)
                    .select(config.relations)
                    .order('created_at', { ascending: false })
                    .range(start, end)
                );
              }

              const results = await Promise.all(batchPromises);

              results.forEach(({ data, error }) => {
                if (error) {
                  console.error(`Batch error for ${tableName}:`, error);
                } else if (data) {
                  allData = allData.concat(data);
                }
              });
            }

            this.data[this.normalizeTableName(tableName)] = allData;
          }

          this.loadingStatus.loadedTables.add(tableName);
          const duration = ((Date.now() - startTime) / 1000).toFixed(2);
          console.log(`âœ… ${tableName}: ${this.data[this.normalizeTableName(tableName)].length} records in ${duration}s`);

        } catch (error) {
          console.error(`âŒ Failed to load ${tableName}:`, error);
          this.loadingStatus.errors.push({ table: tableName, error });
          throw error;
        }
      },

      // Normalisiere Tabellennamen (work_tracking -> workTracking)
      normalizeTableName(name) {
        return name.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());
      },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SYNC TO GLOBAL VARIABLES - FÃ¼r KompatibilitÃ¤t mit bestehendem Code
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      syncToGlobalVariables() {
        console.log('ðŸ”„ Syncing to global variables...');

        // Diese globalen Variablen werden im bestehenden Code verwendet
        window.allRequests = this.data.requests;
        window.allArtists = this.data.artists;
        window.allCustomers = this.data.customers;
        window.customersCache = this.data.customers;
        window.allLocations = this.data.locations;
        window.dienstplanCache = this.data.dienstplan;
        window.workTrackingCache = this.data.workTracking;
        window.artistsCache = this.data.artists;
        window.projectsCache = this.data.projects;

        // Auch lokale Variablen setzen
        allRequests = this.data.requests;
        allArtists = this.data.artists;
        allCustomers = this.data.customers;
        customersCache = this.data.customers;
        allLocations = this.data.locations;
        dienstplanCache = this.data.dienstplan;
        artistsCache = this.data.artists;

        // DataCache auch befÃ¼llen
        DataCache.set('requests', this.data.requests);
        DataCache.set('artists', this.data.artists);
        DataCache.set('customers', this.data.customers);
        DataCache.set('appointments', this.data.appointments);
        DataCache.set('dienstplan', this.data.dienstplan);
        DataCache.set('projects', this.data.projects);

        console.log('âœ… Global variables synced');
        console.log('ðŸ“… dienstplanCache synced:', window.dienstplanCache?.length || 0);
        console.log('â° workTrackingCache synced:', window.workTrackingCache?.length || 0);
      },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // REALTIME SUBSCRIPTIONS - FÃ¼r Live-Updates
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      setupRealtimeSubscriptions() {
        console.log('ðŸ“¡ Setting up Realtime subscriptions...');

        const tablesToWatch = [
          'requests',
          'customers',
          'artists',
          'appointments',
          'dienstplan',
          'wannados'
        ];

        tablesToWatch.forEach(table => {
          const channelName = `central_${table}_changes`;

          // Unsubscribe if already exists
          if (this.subscriptions[table]) {
            supabase.removeChannel(this.subscriptions[table]);
          }

          this.subscriptions[table] = supabase
            .channel(channelName)
            .on('postgres_changes',
              { event: '*', schema: 'public', table: table },
              (payload) => this.handleRealtimeUpdate(table, payload)
            )
            .subscribe((status) => {
              if (status === 'SUBSCRIBED') {
                console.log(`ðŸ“¡ Subscribed to ${table}`);
              }
            });
        });

        console.log('âœ… Realtime subscriptions active for', tablesToWatch.length, 'tables');
      },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // HANDLE REALTIME UPDATE - Einzelne Ã„nderungen verarbeiten
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      async handleRealtimeUpdate(table, payload) {
        const normalizedTable = this.normalizeTableName(table);
        console.log(`ðŸ“¡ Realtime ${payload.eventType} on ${table}:`, payload.new?.id || payload.old?.id);

        try {
          switch(payload.eventType) {
            case 'INSERT':
              // Bei INSERT: Volle Daten mit Relations laden
              const newRecord = await this.fetchRecordWithRelations(table, payload.new.id);
              if (newRecord) {
                this.data[normalizedTable].unshift(newRecord); // Am Anfang einfÃ¼gen
              }
              break;

            case 'UPDATE':
              // Bei UPDATE: Record aktualisieren
              const updatedRecord = await this.fetchRecordWithRelations(table, payload.new.id);
              if (updatedRecord) {
                const idx = this.data[normalizedTable].findIndex(r => r.id === payload.new.id);
                if (idx >= 0) {
                  this.data[normalizedTable][idx] = updatedRecord;
                }
              }
              break;

            case 'DELETE':
              // Bei DELETE: Record entfernen
              this.data[normalizedTable] = this.data[normalizedTable].filter(
                r => r.id !== payload.old.id
              );
              break;
          }

          // Globale Variablen aktualisieren
          this.syncToGlobalVariables();

          // UI Listeners benachrichtigen
          this.notifyListeners(normalizedTable, payload.eventType, payload.new || payload.old);

        } catch (error) {
          console.error(`âŒ Error handling realtime update for ${table}:`, error);
        }
      },

      // Record mit Relations laden (fÃ¼r INSERT/UPDATE)
      async fetchRecordWithRelations(table, id) {
        const config = this.tableConfig[table];
        if (!config) return null;

        const { data, error } = await supabase
          .from(table)
          .select(config.relations)
          .eq('id', id)
          .single();

        if (error) {
          console.error(`Error fetching ${table} record:`, error);
          return null;
        }

        return data;
      },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // LISTENER SYSTEM - FÃ¼r UI Updates
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      addListener(table, callback) {
        if (!this.listeners[table]) {
          this.listeners[table] = [];
        }
        this.listeners[table].push(callback);
        return () => {
          this.listeners[table] = this.listeners[table].filter(cb => cb !== callback);
        };
      },

      notifyListeners(table, eventType, record) {
        if (this.listeners[table]) {
          this.listeners[table].forEach(callback => {
            try {
              callback(eventType, record, this.data[table]);
            } catch (error) {
              console.error(`Listener error for ${table}:`, error);
            }
          });
        }

        // Global event fÃ¼r allgemeine Updates
        window.dispatchEvent(new CustomEvent('centralDataUpdate', {
          detail: { table, eventType, record }
        }));
      },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // GETTER METHODS - FÃ¼r Tab-Zugriff
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      getRequests() { return this.data.requests; },
      getCustomers() { return this.data.customers; },
      getArtists() { return this.data.artists; },
      getAppointments() { return this.data.appointments; },
      getDienstplan() { return this.data.dienstplan; },
      getLocations() { return this.data.locations; },
      getProfiles() { return this.data.profiles; },
      getWorkTracking() { return this.data.workTracking; },
      getProjects() { return this.data.projects; },

      // Gefilterte Daten
      getRequestsByStatus(status) {
        return this.data.requests.filter(r => r.status === status);
      },

      getRequestsByLocation(locationId) {
        return this.data.requests.filter(r => r.location_id === locationId);
      },

      getArtistsByLocation(locationId) {
        return this.data.artists.filter(a => a.location_id === locationId);
      },

      getProjectsByLocation(locationId) {
        return this.data.projects.filter(p => p.location_id === locationId);
      },

      getProjectsByStatus(status) {
        return this.data.projects.filter(p => p.status === status);
      },

      // Status Check
      isReady() {
        return this.loadingStatus.isInitialLoadComplete;
      }
    };

    // Global verfÃ¼gbar machen
    window.CentralDataManager = CentralDataManager;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOADING SCREEN CONTROLLER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const LoadingScreen = {
      elements: {
        screen: null,
        status: null,
        progressFill: null,
        progressPercent: null,
        glassOverlay: null,
        loginForm: null
      },

      currentProgress: 0,

      init() {
        this.elements.screen = document.getElementById('loadingScreen');
        this.elements.status = document.getElementById('loadingStatus');
        this.elements.progressFill = document.getElementById('loadingProgressFill');
        this.elements.progressPercent = document.getElementById('loadingProgressPercent');
        this.elements.glassOverlay = document.getElementById('loadingGlassOverlay');
        this.elements.loginForm = document.getElementById('loadingLoginFormElement');

        // Ensure mobile nav is hidden during loading
        document.querySelector('.mobile-footer-nav')?.classList.remove('visible');
        document.body.classList.add('logged-out');

        // Login Form Event Listener
        if (this.elements.loginForm) {
          this.elements.loginForm.addEventListener('submit', (e) => this.handleLogin(e));

          // Input Validation fÃ¼r Button
          const usernameInput = document.getElementById('loadingUsername');
          const passwordInput = document.getElementById('loadingPassword');
          const submitBtn = this.elements.loginForm.querySelector('button[type="submit"]');

          // Button initial disabled
          if (submitBtn) {
            submitBtn.disabled = true;
          }

          // Check Inputs on every keystroke
          const validateInputs = () => {
            const hasUsername = usernameInput && usernameInput.value.trim().length > 0;
            const hasPassword = passwordInput && passwordInput.value.length > 0;

            if (submitBtn) {
              submitBtn.disabled = !(hasUsername && hasPassword);
            }
          };

          if (usernameInput) {
            usernameInput.addEventListener('input', validateInputs);
            usernameInput.addEventListener('change', validateInputs);
          }

          if (passwordInput) {
            passwordInput.addEventListener('input', validateInputs);
            passwordInput.addEventListener('change', validateInputs);
          }
        }

        console.log('ðŸŽ¬ LoadingScreen initialized');
      },

      // Update Progress
      updateProgress(percent, statusText) {
        this.currentProgress = Math.min(100, Math.max(0, percent));

        if (this.elements.progressFill) {
          this.elements.progressFill.style.width = `${this.currentProgress}%`;
        }

        if (this.elements.progressPercent) {
          this.elements.progressPercent.textContent = `${Math.round(this.currentProgress)}%`;
          this.elements.progressPercent.style.left = `${this.currentProgress}%`;
        }

        if (statusText && this.elements.status) {
          this.elements.status.textContent = statusText;
        }
      },

      // Loading Complete - Show Glass Overlay + Login
      showLogin() {
        console.log('ðŸ” Showing login overlay...');

        // WICHTIG: LoadingScreen wieder sichtbar machen (falls durch hide() versteckt)
        if (this.elements.screen) {
          this.elements.screen.style.display = 'flex';
          this.elements.screen.classList.remove('fade-out');
          this.elements.screen.classList.add('active');
        }

        // Progress Bar verstecken (nicht relevant fÃ¼r Login nach Logout)
        if (this.elements.progress) {
          this.elements.progress.style.display = 'none';
        }
        if (this.elements.status) {
          this.elements.status.style.display = 'none';
        }

        // Glass Overlay (Login-Formular) sofort einblenden
        if (this.elements.glassOverlay) {
          this.elements.glassOverlay.classList.add('active');
        }

        // Login-Formular Felder zurÃ¼cksetzen
        const usernameInput = document.getElementById('loadingUsername');
        const passwordInput = document.getElementById('loadingPassword');
        const rememberCheckbox = document.getElementById('loadingRememberMe');

        if (usernameInput) usernameInput.value = '';
        if (passwordInput) passwordInput.value = '';
        if (rememberCheckbox) rememberCheckbox.checked = false;

        console.log('âœ… Login overlay shown');
      },

      // Hide Loading Screen completely
      hide() {
        console.log('ðŸŽ¬ Hiding loading screen...');

        if (this.elements.screen) {
          this.elements.screen.classList.add('fade-out');

          setTimeout(() => {
            this.elements.screen.classList.remove('active');
            this.elements.screen.style.display = 'none';
          }, 500);
        }
      },

      // Handle Login Submit - SECURE SUPABASE AUTH VERSION
      async handleLogin(e) {
        e.preventDefault();

        const username = document.getElementById('loadingUsername').value.trim();
        const password = document.getElementById('loadingPassword').value;
        const rememberMe = document.getElementById('loadingRememberMe').checked;

        if (!username || !password) {
          alert('Bitte fÃ¼lle alle Felder aus');
          return;
        }

        const submitBtn = this.elements.loginForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Anmelden...';
        submitBtn.disabled = true;

        try {
          console.log('ðŸ”‘ Login attempt for:', username);

          // SCHRITT 1: Email fÃ¼r Username holen (KEINE sensiblen Daten!)
          const { data: profileData, error: profileError } = await supabase
            .from('profiles')
            .select('id, email, auth_user_id')
            .ilike('username', username)
            .single();

          if (profileError || !profileData) {
            console.log('âš ï¸ User not found:', username);
            alert('Benutzername nicht gefunden');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return;
          }

          // PrÃ¼fen ob Profile mit Auth verknÃ¼pft ist
          if (!profileData.auth_user_id) {
            console.error('âŒ Profile not linked to auth.users:', username);
            alert('Dein Account ist noch nicht aktiviert. Bitte kontaktiere einen Administrator.');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return;
          }

          // SCHRITT 2: Mit Supabase Auth einloggen
          console.log('ðŸ” Attempting Supabase Auth sign-in for:', profileData.email);

          const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
            email: profileData.email,
            password: password
          });

          if (authError) {
            console.error('âŒ Auth error:', authError.message);

            if (authError.message.includes('Invalid login credentials')) {
              alert('Falsches Passwort');
            } else if (authError.message.includes('Email not confirmed')) {
              alert('Email noch nicht bestÃ¤tigt. Bitte prÃ¼fe dein Postfach.');
            } else {
              alert('Anmeldefehler: ' + authError.message);
            }

            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return;
          }

          console.log('âœ… Supabase Auth successful, user ID:', authData.user.id);

          // SCHRITT 3: VollstÃ¤ndiges Profile laden
          const { data: fullProfile, error: fullProfileError } = await supabase
            .from('profiles')
            .select('id, username, email, role, avatar_url, location_id, is_active, auth_user_id')
            .eq('auth_user_id', authData.user.id)
            .single();

          if (fullProfileError || !fullProfile) {
            console.error('âŒ Could not load profile for auth user:', authData.user.id);
            alert('Profil konnte nicht geladen werden.');
            await supabase.auth.signOut();
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return;
          }

          // PrÃ¼fen ob User aktiv ist
          if (fullProfile.is_active === false) {
            console.log('âš ï¸ User is deactivated:', fullProfile.username);
            alert('Dein Account ist deaktiviert. Bitte kontaktiere einen Administrator.');
            await supabase.auth.signOut();
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return;
          }

          // Login erfolgreich!
          console.log('âœ… Login successful for:', fullProfile.username);
          currentUser = fullProfile;
          window.currentUser = fullProfile;

          // Remember Me - speichere Auth Session Info
          if (rememberMe) {
            localStorage.setItem('rememberMe', 'true');
            localStorage.setItem('username', fullProfile.username);
            localStorage.setItem('userRole', fullProfile.role || 'user');
            if (fullProfile.avatar_url) {
              localStorage.setItem('avatarUrl', fullProfile.avatar_url);
            }
          }

          // Update last_login_at in profiles
          supabase
            .from('profiles')
            .update({ last_login_at: new Date().toISOString() })
            .eq('id', fullProfile.id)
            .then(({ error }) => {
              if (error) console.warn('âš ï¸ Could not update last_login_at:', error.message);
            });

          // Update UI
          if (typeof updateUIForUser === 'function') {
            updateUIForUser(fullProfile);
          }

          // Hide Loading Screen
          this.hide();

          // Post-login initialization
          setTimeout(async () => {
            try {
              if (typeof initializePermissions === 'function') {
                await initializePermissions();
              }
              if (typeof loadInitialData === 'function') {
                await loadInitialData();
              }
              if (typeof loadEvents === 'function') {
                await loadEvents();
              }
              if (typeof renderCalendar === 'function') {
                renderCalendar();
              }
              if (typeof window.loadTodoProjects === 'function') {
                await window.loadTodoProjects();
              }

              // Mobile UI initialization
              if (window.matchMedia('(max-width: 768px)').matches) {
                console.log('ðŸ“± Mobile device detected, initializing mobile UI...');
                document.body.classList.add('logged-in');
                document.body.classList.remove('logged-out');

                const mobileNav = document.querySelector('.mobile-footer-nav');
                if (mobileNav) {
                  mobileNav.classList.add('visible');
                }

                if (typeof updateMobileProfileData === 'function') {
                  updateMobileProfileData();
                }
                if (typeof initMobileCalendar === 'function') initMobileCalendar();
                if (typeof initMobileDienstplan === 'function') initMobileDienstplan();
              }

              console.log('âœ… Post-login initialization complete');
            } catch (postLoginErr) {
              console.error('âš ï¸ Post-login initialization error:', postLoginErr);
            }
          }, 100);

          // Show notification
          if (typeof showNotification === 'function') {
            showNotification(`Willkommen zurÃ¼ck, ${fullProfile.username}!`, 'success');
          }

        } catch (err) {
          console.error('ðŸ’¥ Login failed:', err);
          alert('Ein Fehler ist aufgetreten: ' + err.message);
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      }
    };

    // Global verfÃ¼gbar machen
    window.LoadingScreen = LoadingScreen;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REALTIME UI UPDATE HANDLERS
    // Automatische UI-Updates bei DatenÃ¤nderungen
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Requests Tab - Auto-Refresh bei Ã„nderungen
    CentralDataManager.addListener('requests', (eventType, record, allData) => {
      console.log(`ðŸ”„ Requests updated: ${eventType}`);

      // Aktualisiere globale Variable
      allRequests = allData;
      window.allRequests = allData;

      // Wenn Requests-Tab aktiv ist, neu rendern
      const requestsSection = document.getElementById('requests-section');
      if (requestsSection && requestsSection.classList.contains('active')) {
        if (typeof filterAndRenderRequests === 'function') {
          filterAndRenderRequests();
        }
        if (typeof showNotification === 'function') {
          showNotification(`Request ${eventType === 'INSERT' ? 'hinzugefÃ¼gt' : eventType === 'UPDATE' ? 'aktualisiert' : 'gelÃ¶scht'}`, 'info');
        }
      }

      // Badge Counts aktualisieren
      if (typeof updateRequestBadges === 'function') {
        updateRequestBadges();
      }
    });

    // Customers Tab - Auto-Refresh
    CentralDataManager.addListener('customers', (eventType, record, allData) => {
      console.log(`ðŸ”„ Customers updated: ${eventType}`);

      customersCache = allData;
      allCustomers = allData;

      const customersSection = document.getElementById('customers-section');
      if (customersSection && customersSection.classList.contains('active')) {
        if (typeof applyCustomerFilters === 'function') {
          applyCustomerFilters();
          if (typeof loadCustomers === 'function') {
            loadCustomers(currentCustomersPage || 1);
          }
        }
      }
    });

    // Artists Tab - Auto-Refresh
    CentralDataManager.addListener('artists', (eventType, record, allData) => {
      console.log(`ðŸ”„ Artists updated: ${eventType}`);

      allArtists = allData;
      artistsCache = allData;

      const artistsSection = document.getElementById('artists-section');
      if (artistsSection && artistsSection.classList.contains('active')) {
        if (typeof loadArtists === 'function') {
          loadArtists(currentArtistsPage || 1);
        }
      }
    });

    // Appointments - Calendar Refresh
    CentralDataManager.addListener('appointments', (eventType, record, allData) => {
      console.log(`ðŸ”„ Appointments updated: ${eventType}`);

      // Calendar neu laden wenn aktiv
      const calendarSection = document.getElementById('calendar-section');
      if (calendarSection && calendarSection.classList.contains('active')) {
        if (typeof loadEvents === 'function' && typeof renderCalendar === 'function') {
          loadEvents().then(() => renderCalendar());
        }
      }
    });

    // Dienstplan - Auto-Refresh
    CentralDataManager.addListener('dienstplan', (eventType, record, allData) => {
      console.log(`ðŸ”„ Dienstplan updated: ${eventType}`);

      dienstplanCache = allData;

      const dienstplanSection = document.getElementById('dienstplan-section');
      if (dienstplanSection && dienstplanSection.classList.contains('active')) {
        if (typeof applyDienstplanFilters === 'function') {
          applyDienstplanFilters();
        }
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REQUEST BADGE UPDATE FUNCTION
    // Berechnet Badge Counts aus dem Cache
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function updateRequestBadges() {
      const requests = CentralDataManager.getRequests();
      if (!requests || requests.length === 0) return;

      // Open Requests Badge (letzte 7 Tage)
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      const openCount = requests.filter(r =>
        r.status === 'open_request' &&
        new Date(r.created_at) > sevenDaysAgo
      ).length;

      const openBadge = document.getElementById('openRequestsBadge');
      if (openBadge) {
        openBadge.textContent = openCount;
        openBadge.style.display = openCount > 0 ? 'inline-flex' : 'none';
      }

      // Pending Badge
      const pendingCount = requests.filter(r => r.status === 'pending').length;
      const pendingBadge = document.getElementById('pendingRequestsBadge');
      if (pendingBadge) {
        pendingBadge.textContent = pendingCount;
        pendingBadge.style.display = pendingCount > 0 ? 'inline-flex' : 'none';
      }

      // My Requests Badge (assigned to current user)
      if (typeof currentUser !== 'undefined' && currentUser) {
        const myCount = requests.filter(r =>
          r.assigned_to_user_id === currentUser.id &&
          r.status !== 'finished'
        ).length;

        const myBadge = document.getElementById('myRequestsBadge');
        if (myBadge) {
          myBadge.textContent = myCount;
          myBadge.style.display = myCount > 0 ? 'inline-flex' : 'none';
        }
      }

      console.log('ðŸ·ï¸ Badges updated:', { openCount, pendingCount });
    }

    // Global verfÃ¼gbar machen
    window.updateRequestBadges = updateRequestBadges;

    // Google-inspirierte Farbschemata pro Location
    const locationColors = {
      'mommy': {
        primary: '#8E24AA',      // Purple
        light: '#F3E5F5',
        dark: '#6A1B9A',
        accent: '#BA68C8'
      },
      'gon': {
        primary: '#1976D2',      // Blue
        light: '#E3F2FD',
        dark: '#0D47A1',
        accent: '#42A5F5'
      },
      'muttersÃ¶hne': {
        primary: '#43A047',      // Green
        light: '#E8F5E9',
        dark: '#2E7D32',
        accent: '#66BB6A'
      },
      'pardon': {
        primary: '#E53935',      // Red
        light: '#FFEBEE',
        dark: '#C62828',
        accent: '#EF5350'
      },
      'default': {
        primary: '#111827',      // Dark Gray
        light: '#F3F4F6',
        dark: '#0F172A',
        accent: '#6B7280'
      }
    };

    function getLocationColors(locationName) {
      const name = (locationName || '').toLowerCase();
      if (name.includes('mommy')) return locationColors.mommy;
      if (name.includes('gon')) return locationColors.gon;
      if (name.includes('muttersÃ¶hne') || name.includes('muttersohne')) return locationColors.muttersÃ¶hne;
      if (name.includes('pardon')) return locationColors.pardon;
      return locationColors.default;
    }

    // REMOVED: Old dienstplan system function
    // function getCurrentLocationName() {
    //   const select = document.querySelector('#dienstplanLocationDropdown option:checked');
    //   return select ? select.textContent : '';
    // }

    // ============================================
    // UI PERMISSIONS INITIALIZATION
    // ============================================

    async function initializePermissions() {
      try {
        // Check if user is logged in
        const { data: { user } } = await supabase.auth.getUser();

        // âœ… CHANGED: Always show buttons by default (anon key allows public access)
        // Only hide if explicitly no permission when logged in
        console.log('User login status:', user ? 'Logged in' : 'Anonymous (using anon key)');

        // If no user logged in, show all buttons (anon key provides access)
        if (!user) {
          console.log('âœ… Anonymous access - all buttons visible with anon key');
          return; // Exit early - keep all buttons visible
        }

        // Check all permissions in parallel for faster load
        // NOTE: Artists and Customers management is always allowed (no permission check)
        const [
          canCreateBooking,
          canCreateEvent,
          canManageRequests,
          canManageDienstplan
        ] = await Promise.all([
          userHasPermission('calendar.create_booking'),
          userHasPermission('calendar.create_event'),
          userHasPermission('requests.manage'),
          userHasPermission('dienstplan.manage')
        ]);

        console.log('Permissions loaded:', {
          canCreateBooking,
          canCreateEvent,
          canManageRequests,
          canManageDienstplan
        });

        // Hide/show buttons based on permissions
        if (!canCreateBooking) {
          const createBookingBtns = document.querySelectorAll('[onclick*="createBooking"]');
          createBookingBtns.forEach(btn => btn.style.display = 'none');
        }

        if (!canCreateEvent) {
          const createEventBtns = document.querySelectorAll('[onclick*="createEvent"]');
          createEventBtns.forEach(btn => btn.style.display = 'none');
        }

        // NOTE: Artists and Customers buttons are ALWAYS visible (no permission check)

        if (!canManageRequests) {
          const requestBtns = document.querySelectorAll('[onclick*="assignRequest"], [onclick*="scheduleAppointment"]');
          requestBtns.forEach(btn => btn.style.display = 'none');
        }

        if (!canManageDienstplan) {
          // Make dienstplan cells read-only
          const dienstplanCells = document.querySelectorAll('.dp-cell');
          dienstplanCells.forEach(cell => {
            cell.style.cursor = 'not-allowed';
            cell.style.pointerEvents = 'none';
          });
        }
      } catch (err) {
        console.error('Error initializing permissions:', err);
      }
    }

    function hideManagementButtons() {
      // NOTE: Artist and Customer buttons are ALWAYS visible (removed from selectors)
      const selectors = [
        '[onclick*="createBooking"]',
        '[onclick*="createEvent"]',
        '[onclick*="assignRequest"]',
        '[onclick*="scheduleAppointment"]'
      ];

      selectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => el.style.display = 'none');
      });

      // Make dienstplan read-only
      const dienstplanCells = document.querySelectorAll('.dp-cell');
      dienstplanCells.forEach(cell => {
        cell.style.cursor = 'not-allowed';
        cell.style.pointerEvents = 'none';
      });
    }



    // Sorting Functions
    function sortArtists(artists, field, order) {
      const sorted = [...artists].sort((a, b) => {
        let aVal, bVal;
        
        if (field === 'name') {
          aVal = (a.name || '').toLowerCase();
          bVal = (b.name || '').toLowerCase();
        } else if (field === 'rank') {
          const rankOrder = { 'Friends': 1, 'Crew': 2, 'Fam': 3, 'VIP': 4 };
          aVal = rankOrder[a.rank] || 999;
          bVal = rankOrder[b.rank] || 999;
        } else if (field === 'location') {
          aVal = (a.city_location || '').toLowerCase();
          bVal = (b.city_location || '').toLowerCase();
        }
        
        if (aVal < bVal) return order === 'asc' ? -1 : 1;
        if (aVal > bVal) return order === 'asc' ? 1 : -1;
        return 0;
      });
      
      return sorted;
    }
    
    function sortCustomers(customers, field, order) {
      const sorted = [...customers].sort((a, b) => {
        let aVal, bVal;
        
        if (field === 'name') {
          aVal = `${a.first_name || ''} ${a.last_name || ''}`.toLowerCase();
          bVal = `${b.first_name || ''} ${b.last_name || ''}`.toLowerCase();
        } else if (field === 'rank') {
          const rankOrder = { 'Bronze': 1, 'Silver': 2, 'Gold': 3, 'Platinum': 4 };
          aVal = rankOrder[a.rank] || 0;
          bVal = rankOrder[b.rank] || 0;
        } else if (field === 'created') {
          aVal = new Date(a.created_at).getTime();
          bVal = new Date(b.created_at).getTime();
        }
        
        if (aVal < bVal) return order === 'asc' ? -1 : 1;
        if (aVal > bVal) return order === 'asc' ? 1 : -1;
        return 0;
      });
      
      return sorted;
    }

    function applyLocationTheme(colors) {
      const root = document.documentElement;
      root.style.setProperty('--location-primary', colors.primary);
      root.style.setProperty('--location-light', colors.light);
      root.style.setProperty('--location-dark', colors.dark);
      root.style.setProperty('--location-accent', colors.accent);
    }

    // ============================================
    // PROJECT MENU & TASK FUNCTIONS (GLOBAL)
    // ============================================

    // Project MenÃ¼ anzeigen (3-Punkte MenÃ¼)
    function showProjectMenu(event, projectId) {
      event.stopPropagation();

      // SchlieÃŸe andere offene MenÃ¼s
      document.querySelectorAll('.project-menu-dropdown').forEach(m => m.remove());

      const button = event.currentTarget;
      const rect = button.getBoundingClientRect();

      const menu = document.createElement('div');
      menu.className = 'project-menu-dropdown';
      menu.style.cssText = `
        position: fixed;
        left: ${rect.left}px;
        top: ${rect.bottom + 5}px;
        background: var(--macos-elevated, #fff);
        border: 1px solid var(--border-color, #e0e0e0);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        min-width: 150px;
        overflow: hidden;
      `;

      menu.innerHTML = `
        <button onclick="editProject('${projectId}')" style="width:100%;padding:10px 16px;border:none;background:none;text-align:left;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:8px;">
          <span>âœï¸</span> Bearbeiten
        </button>
        <button onclick="confirmDeleteProject('${projectId}')" style="width:100%;padding:10px 16px;border:none;background:none;text-align:left;cursor:pointer;font-size:14px;color:#ff3b30;display:flex;align-items:center;gap:8px;">
          <span>ðŸ—‘ï¸</span> LÃ¶schen
        </button>
      `;

      document.body.appendChild(menu);

      // SchlieÃŸen bei Klick auÃŸerhalb
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 10);
    }

    // Task Input anzeigen
    function showAddTaskInput(projectId) {
      // Falls projectId nicht Ã¼bergeben wird, versuche currentProjectDetail zu verwenden (Modal-Kontext)
      if (!projectId && typeof currentProjectDetail !== 'undefined' && currentProjectDetail) {
        // Modal-Version: zeige den addTaskContainer
        const addTaskContainer = document.getElementById('addTaskContainer');
        const newTaskInput = document.getElementById('newTaskInput');
        if (addTaskContainer) {
          addTaskContainer.style.display = 'block';
          if (newTaskInput) newTaskInput.focus();
          return;
        }
        projectId = currentProjectDetail.id;
      }

      const container = document.getElementById('tasks-' + projectId) ||
                        document.querySelector(`[data-project-id="${projectId}"] .tasks-container`);

      if (!container) {
        console.error('Tasks container nicht gefunden fÃ¼r Projekt:', projectId);
        return;
      }

      // PrÃ¼fe ob Input bereits existiert
      if (container.querySelector('.new-task-input-wrapper')) return;

      const inputDiv = document.createElement('div');
      inputDiv.className = 'new-task-input-wrapper';
      inputDiv.style.cssText = 'display:flex;gap:8px;margin-top:12px;padding:8px;background:var(--macos-window,#f5f5f5);border-radius:8px;';

      inputDiv.innerHTML = `
        <input type="text" class="new-task-input" placeholder="Neue Aufgabe..."
          style="flex:1;padding:8px 12px;border:1px solid var(--border-color,#e0e0e0);border-radius:6px;font-size:14px;background:white;">
        <button onclick="addTaskToProject('${projectId}')"
          style="padding:8px 16px;background:var(--apple-blue,#007aff);color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;">
          HinzufÃ¼gen
        </button>
      `;

      container.appendChild(inputDiv);

      const input = inputDiv.querySelector('input');
      input.focus();
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addTaskToProject(projectId);
        }
      });
    }

    // Task zu Projekt hinzufÃ¼gen
    async function addTaskToProject(projectId) {
      const container = document.getElementById('tasks-' + projectId) ||
                        document.querySelector(`[data-project-id="${projectId}"] .tasks-container`);
      const input = container?.querySelector('.new-task-input');
      const title = input?.value?.trim();

      if (!title) {
        showNotification('Bitte Task-Titel eingeben', 'warning');
        return;
      }

      try {
        const { error } = await supabase
          .from('project_tasks')
          .insert([{
            project_id: projectId,
            title: title,
            is_completed: false,
            created_at: new Date().toISOString()
          }]);

        if (error) throw error;

        showNotification('Task hinzugefÃ¼gt', 'success');
        await loadTodoProjects();

      } catch (error) {
        console.error('Error adding task:', error);
        showNotification('Fehler: ' + error.message, 'error');
      }
    }

    // Projekt lÃ¶schen bestÃ¤tigen
    function confirmDeleteProject(projectId) {
      // SchlieÃŸe MenÃ¼
      document.querySelectorAll('.project-menu-dropdown').forEach(m => m.remove());

      if (!confirm('Projekt wirklich lÃ¶schen? Alle Tasks werden auch gelÃ¶scht.')) return;

      deleteProject(projectId);
    }

    // Projekt lÃ¶schen
    async function deleteProject(projectId) {
      try {
        // Erst Tasks lÃ¶schen
        await supabase.from('project_tasks').delete().eq('project_id', projectId);

        // Dann Projekt-Members lÃ¶schen (falls vorhanden)
        await supabase.from('project_members').delete().eq('project_id', projectId);

        // Dann Projekt lÃ¶schen
        const { error } = await supabase.from('task_projects').delete().eq('id', projectId);

        if (error) throw error;

        showNotification('Projekt gelÃ¶scht', 'success');
        await loadTodoProjects();

      } catch (error) {
        console.error('Error deleting project:', error);
        showNotification('Fehler: ' + error.message, 'error');
      }
    }

    // Projekt bearbeiten
    function editProject(projectId) {
      // SchlieÃŸe MenÃ¼
      document.querySelectorAll('.project-menu-dropdown').forEach(m => m.remove());

      // Ã–ffne Projekt-Detail oder Edit-Modal
      if (typeof openProjectDetail === 'function') {
        openProjectDetail(projectId);
      } else {
        console.log('Edit project:', projectId);
        showNotification('Projekt bearbeiten: ' + projectId, 'info');
      }
    }

    // ============================================
    // END PROJECT MENU & TASK FUNCTIONS
    // ============================================

    document.addEventListener("DOMContentLoaded", async () => {
      const tabs = document.querySelectorAll("nav a[id^='tab-']");
      const sections = document.querySelectorAll("section");

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // STEP 0: INITIALIZE LOADING SCREEN & THEME
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      LoadingScreen.init();
      console.log('ðŸŽ¬ LoadingScreen initialized');

      // Initialize mobile theme from localStorage
      if (typeof initMobileTheme === 'function') {
        initMobileTheme();
        console.log('ðŸŽ¨ Mobile theme initialized');
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // STEP 1: CENTRAL DATA LOAD (VOR Login)
      // Alle Daten werden im Loading Screen geladen
      // Der CentralDataManager ruft checkSavedSession() auf und zeigt
      // entweder das Login-Formular oder versteckt den Loading Screen
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      console.log('ðŸš€ Starting Central Data Load...');

      try {
        // Zentrale Daten laden (im Loading Screen)
        await CentralDataManager.initialLoad();

        // Nach dem Laden: UI initialisieren
        console.log('âœ… Central Data Load complete');
      } catch (err) {
        console.error('âŒ Central Data Load failed:', err);
        // Error wird bereits im CentralDataManager an LoadingScreen gesendet
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // STEP 2: UI INITIALIZATION (nach Daten-Load)
      // Diese werden bereits nach erfolgreichem Login ausgefÃ¼hrt
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      try {
        await loadInitialData(); // Locations, Dropdowns, etc.
        await loadBookingTeamMembers();
        console.log('âœ… UI initialization complete');
      } catch (err) {
        console.error('âŒ UI initialization error:', err);
      }

      // Note: Der alte initialLoader wird nicht mehr verwendet.
      // LoadingScreen wird durch checkSavedSession() oder handleLogin() versteckt.

      // Request tabs initialization function
      function initRequestTabs() {
        const requestTabs = document.querySelectorAll('.request-tab');
        const requestsIndicator = document.getElementById('requestsIndicator');
        
        console.log('Init Request tabs found:', requestTabs.length);
        console.log('Init Indicator element:', requestsIndicator);
        
        if (!requestsIndicator || requestTabs.length === 0) {
          console.error('Missing indicator or tabs');
          return;
        }
        
        function updateRequestsIndicator(tab) {
          if (!requestsIndicator || !tab) return;
          
          const tabRect = tab.getBoundingClientRect();
          const containerRect = tab.parentElement.getBoundingClientRect();
          const left = tabRect.left - containerRect.left;
          const width = tabRect.width;
          
          console.log('Updating indicator - Left:', left, 'Width:', width);
          
          requestsIndicator.style.width = `${width}px`;
          requestsIndicator.style.transform = `translateX(${left}px)`;
        }
        
        // Initialize indicator position
        setTimeout(() => {
          const activeTab = document.querySelector('.request-tab.active');
          if (activeTab) {
            console.log('Initializing indicator for active tab');
            updateRequestsIndicator(activeTab);
          }
        }, 50);
        
        // Add click listeners
        requestTabs.forEach((tab, index) => {
          console.log('Adding click listener to tab', index, tab.textContent);
          
          // Remove old listeners by cloning
          const newTab = tab.cloneNode(true);
          tab.parentNode.replaceChild(newTab, tab);
          
          newTab.addEventListener('click', function(e) {
            console.log('Tab clicked:', this.textContent, 'Status:', this.dataset.status);
            
            // Update current status
            currentRequestStatus = this.dataset.status;
            console.log('Updated currentRequestStatus to:', currentRequestStatus);
            
            document.querySelectorAll('.request-tab').forEach(t => {
              t.classList.remove('active');
              t.style.color = '#86868b';
            });
            this.classList.add('active');
            this.style.color = '#1d1d1f';
            
            updateRequestsIndicator(this);

            // Show/hide Create Request button based on tab
            const createRequestBtnContainer = document.getElementById('createRequestBtnContainer');
            if (createRequestBtnContainer) {
              if (this.dataset.status === 'open_request') {
                createRequestBtnContainer.style.display = 'flex';
              } else {
                createRequestBtnContainer.style.display = 'none';
              }
            }

            // Close detail view when switching tabs
            selectedRequestId = null;
            closeRequestDetail();

            loadRequests();
          });
        });
      }

      // âœ… NEW: Request Location dropdown initialization function
      function initRequestLocationDropdown() {
        const locationDropdown = document.getElementById('requestLocationDropdown');

        console.log('Init Request Location dropdown:', locationDropdown);

        if (!locationDropdown) {
          console.error('Missing location dropdown');
          return;
        }

        // Set initial value
        currentRequestLocation = 'all';

        // Add change listener
        locationDropdown.addEventListener('change', function(e) {
          const selectedLocation = e.target.value;
          console.log('Location dropdown changed:', selectedLocation);

          // Update current location
          currentRequestLocation = selectedLocation;
          console.log('Updated currentRequestLocation to:', currentRequestLocation);

          // Close detail view when switching location
          selectedRequestId = null;
          closeRequestDetail();

          loadRequests();
        });
      }

      // âœ… NEW: Request Search initialization function
      function initRequestSearch() {
        const searchInput = document.getElementById('requestSearchInput');

        console.log('Init Request Search input:', searchInput);

        if (!searchInput) {
          console.error('Missing search input');
          return;
        }

        // Set initial value
        currentRequestSearchKeyword = '';

        // Add input listener with debounce
        let searchTimeout;
        searchInput.addEventListener('input', function(e) {
          const keyword = e.target.value;
          console.log('Search input changed:', keyword);

          // Clear previous timeout
          clearTimeout(searchTimeout);

          // Debounce search for 300ms
          searchTimeout = setTimeout(() => {
            currentRequestSearchKeyword = keyword;
            console.log('Updated currentRequestSearchKeyword to:', currentRequestSearchKeyword);

            // Close detail view when searching
            selectedRequestId = null;
            closeRequestDetail();

            loadRequests();
          }, 300);
        });
      }

      // Refresh Requests Functionality
      let autoRefreshInterval = null;
      let isRefreshing = false;

      async function refreshRequests() {
        if (isRefreshing) return;

        isRefreshing = true;
        const refreshBtn = document.getElementById('refreshRequestsBtn');
        const refreshIcon = document.getElementById('refreshIcon');
        const refreshText = document.getElementById('refreshBtnText');

        // Add loading state
        if (refreshBtn) {
          refreshBtn.disabled = true;
          refreshBtn.style.opacity = '0.7';
          refreshBtn.style.cursor = 'not-allowed';
        }
        if (refreshIcon) {
          refreshIcon.style.transform = 'rotate(360deg)';
        }
        if (refreshText) {
          refreshText.textContent = 'LÃ¤dt...';
        }

        try {
          const beforeCount = allRequests.length;
          await loadRequests();
          const afterCount = allRequests.length;
          const newRequestsCount = afterCount - beforeCount;

          // Show success notification
          if (refreshText) {
            refreshText.textContent = `âœ“ ${allRequests.length} Requests geladen`;
          }

          // Reset button after 2 seconds
          setTimeout(() => {
            if (refreshText) refreshText.textContent = 'Neue Requests laden';
            if (refreshBtn) {
              refreshBtn.disabled = false;
              refreshBtn.style.opacity = '1';
              refreshBtn.style.cursor = 'pointer';
            }
            if (refreshIcon) {
              refreshIcon.style.transform = 'rotate(0deg)';
            }
          }, 2000);

          console.log(`âœ… Refreshed: ${allRequests.length} total requests${newRequestsCount > 0 ? ` (+${newRequestsCount} new)` : ''}`);
        } catch (error) {
          console.error('âŒ Refresh failed:', error);
          if (refreshText) refreshText.textContent = 'âŒ Fehler';

          setTimeout(() => {
            if (refreshText) refreshText.textContent = 'Neue Requests laden';
            if (refreshBtn) {
              refreshBtn.disabled = false;
              refreshBtn.style.opacity = '1';
              refreshBtn.style.cursor = 'pointer';
            }
            if (refreshIcon) {
              refreshIcon.style.transform = 'rotate(0deg)';
            }
          }, 2000);
        } finally {
          isRefreshing = false;
        }
      }

      // Auto-Refresh Functionality
      function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);

        autoRefreshInterval = setInterval(() => {
          // Only refresh if no modal is open and we're on the requests section
          const isModalOpen = document.querySelector('.modal.active') ||
                              document.getElementById('requestDetail').querySelector('h2');
          const isRequestsSection = document.getElementById('requests-section').classList.contains('active');

          if (!isModalOpen && isRequestsSection && !isRefreshing) {
            console.log('ðŸ”„ Auto-refreshing requests...');
            refreshRequests();
          }
        }, 30000); // 30 seconds

        console.log('âœ… Auto-refresh enabled (30s interval)');
      }

      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          console.log('âŒ Auto-refresh disabled');
        }
      }

      // Initialize Refresh Button
      document.getElementById('refreshRequestsBtn')?.addEventListener('click', refreshRequests);

      // Initialize Auto-Refresh Toggle
      document.getElementById('autoRefreshToggle')?.addEventListener('change', (e) => {
        if (e.target.checked) {
          startAutoRefresh();
        } else {
          stopAutoRefresh();
        }
      });

      // Image Modal Functions
      window.openImageModal = function(imageUrl) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        if (modal && modalImg) {
          modalImg.src = imageUrl;
          modal.classList.add('active');
        }
      };

      window.closeImageModal = function() {
        const modal = document.getElementById('imageModal');
        if (modal) {
          modal.classList.remove('active');
        }
      };

      function showSection(tab) {
        tabs.forEach(x => x.classList.remove("active"));
        sections.forEach(s => {
          s.classList.remove("active");
          s.style.display = "none";
        });
        tab.classList.add("active");

        const tabName = tab.id.replace("tab-", "");
        const target = document.getElementById(tabName + "-section");
        if (target) {
          target.classList.add("active");
          target.style.display = "block";
          if (tabName === "dashboard") {
            loadDashboard();
            loadPinnedEvents();
            loadSchwarzesBrett();
          }
          else if (tabName === "requests") {
            loadRequests();
            initRequestTabs();
            initRequestLocationDropdown(); // âœ… NEW: Initialize location filter dropdown
            initRequestSearch(); // âœ… NEW: Initialize search functionality
          }
          else if (tabName === "calendar") renderCalendar();
          else if (tabName === "dienstplan") initializeDienstplan();
          else if (tabName === "agreements") {
            updateAgreementsDateDisplay();
            loadAgreements();
          }
          else if (tabName === "artists") loadArtists();
          else if (tabName === "customers") loadCustomers();
          else if (tabName === "wannados") window.loadWannadoCollections();
          else if (tabName === "guestspots") {
            // Guest Spots Tab - lÃ¤dt Upcoming Guest Spots als Default
            if (typeof loadUpcomingGuestSpotsTab === 'function') {
              loadUpcomingGuestSpotsTab();
            }
          }
          else if (tabName === "waitlist") {
            // Waitlist Tab - lÃ¤dt Waitlist Slots (KÃ¼nstler ohne feste Buchungsdaten)
            if (typeof loadWaitlistOnlySlots === 'function') {
              loadWaitlistOnlySlots('all');
            }
          }
        }
      }

      tabs.forEach(tab => tab.addEventListener("click", (e) => {
        e.preventDefault();

        // Prevent artist users from accessing restricted tabs via click
        if (isArtistUser()) {
          const tabName = tab.id.replace('tab-', '');
          const allowedTabs = ['dashboard', 'calendar', 'dienstplan'];
          if (!allowedTabs.includes(tabName)) {
            console.log('ðŸš« Artist user blocked from accessing:', tabName);
            return;
          }
        }

        showSection(tab);
      }));

      async function loadInitialData() {
        try {
          console.log('ðŸ”§ Initializing UI with cached data...');

          // Artists aus Cache (nicht neu laden!)
          allArtists = CentralDataManager.getArtists();
          console.log('âœ… Artists from cache:', allArtists.length);

          // Team Members noch separat laden (nicht im CentralDataManager)
          const { data: teamMembersResult } = await supabase
            .from('dienstplan_resources')
            .select('*')
            .order('sort_order', { ascending: true })
            .order('name', { ascending: true });
          allTeamMembers = teamMembersResult || [];
          console.log('âœ… Team members loaded:', allTeamMembers.length);

          // Locations aus Cache
          const locations = CentralDataManager.getLocations();
          allLocations = locations;
          console.log('âœ… Locations from cache:', allLocations.length);

          if (locations && locations.length > 0) {
            // Finde "mommy i'm sorry" oder nimm die erste Location
            const mommyLocation = locations.find(l => l.name.toLowerCase().includes("mommy"));
            selectedLocationId = mommyLocation ? mommyLocation.id : locations[0].id;
            selectedDienstplanLocationId = selectedLocationId;

            // Set initial location name and theme
            const initialLocation = locations.find(l => l.id === selectedLocationId);
            if (initialLocation) {
              currentLocationName = initialLocation.name;
              const colors = getLocationColors(currentLocationName);
              applyLocationTheme(colors);
            }

            const locSelect = document.getElementById('locationDropdown');
            if (locSelect) {
              locSelect.innerHTML = locations.map(l =>
                `<option value="${l.id}" ${l.id === selectedLocationId ? 'selected' : ''}>${l.name}</option>`
              ).join('');

              locSelect.onchange = async (e) => {
                selectedLocationId = e.target.value;
                console.log('Location changed to:', selectedLocationId);

                // Get location name and apply theme
                const selectedLocation = locations.find(l => l.id === selectedLocationId);
                if (selectedLocation) {
                  currentLocationName = selectedLocation.name;
                  const colors = getLocationColors(currentLocationName);
                  applyLocationTheme(colors);
                }

                await loadEvents();
                renderCalendar();
              };
            }

            // Artist Location Filter Dropdown
            const artistLocFilter = document.getElementById('artistLocationFilter');
            if (artistLocFilter) {
              const locationOptions = locations.map(l =>
                `<option value="${l.id}">${l.name}</option>`
              ).join('');
              artistLocFilter.innerHTML = `
                <option value="">Alle Locations</option>
                <option value="NULL">Ohne Location</option>
                ${locationOptions}
              `;
            }

            // Waitlist Location Filter Dropdown
            const waitlistLocFilter = document.getElementById('waitlistLocationFilter');
            if (waitlistLocFilter) {
              const locationOptions = locations.map(l =>
                `<option value="${l.id}">${l.name}</option>`
              ).join('');
              waitlistLocFilter.innerHTML = `
                <option value="all">All Locations</option>
                ${locationOptions}
              `;
            }
          }

          // Load events and dashboard (diese nutzen bereits cached Daten)
          await Promise.all([
            loadEvents(),
            loadDashboard(),
            loadPinnedEvents(),
            loadSchwarzesBrett()
          ]);

          // Start auto-refresh for pinned events
          startPinnedEventsAutoRefresh();

        } catch(err) {
          console.error("Load error:", err);
        }
      }

      // ============================================
      // PROJECT METRICS CALCULATION (GLOBAL)
      // ============================================
      /**
       * Calculate project metrics from requests and appointments
       * Supports both old signature (appointments only) and new signature (requests, appointments)
       */
      window.calculateProjectMetrics = function calculateProjectMetrics(requestsOrAppointments, appointments) {
        console.log('ðŸ“Š Calculating project metrics...', {
          arg1Count: requestsOrAppointments?.length || 0,
          arg2Count: appointments?.length || 0
        });

        // Support old signature: calculateProjectMetrics(appointments)
        if (!appointments && Array.isArray(requestsOrAppointments)) {
          appointments = requestsOrAppointments;
          requestsOrAppointments = [];
          console.log('  â†³ Using legacy signature (appointments only)');
        }

        const requests = Array.isArray(requestsOrAppointments) ? requestsOrAppointments : [];
        appointments = appointments || [];

        if (requests.length === 0 && appointments.length === 0) {
          console.warn('âš ï¸ No requests or appointments provided for project metrics');
          return {
            totalProjects: 0,
            activeProjects: 0,
            completedProjects: 0,
            canceledProjects: 0,
            total_projects: 0,
            active_projects: 0,
            finished_projects: 0,
            total_revenue: 0,
            avg_project_value: 0,
            projects_with_appointments: 0,
            avg_appointments_per_project: 0,
            totalRevenue: 0,
            avgAppointmentsPerProject: 0,
            completionRate: 0,
            projectsArray: []
          };
        }

        // Group by project_id
        const projectsMap = new Map();

        // Process requests
        requests.forEach(req => {
          if (!req.project_id) return;

          if (!projectsMap.has(req.project_id)) {
            projectsMap.set(req.project_id, {
              project_id: req.project_id,
              project_number: req.project_number,
              project_title: req.project_title,
              customer_email: req.email,
              customer_id: req.customer_id,
              customer_name: null,
              requests: [],
              appointments: [],
              total_price: 0,
              total_revenue: 0,
              status: req.status
            });
          }

          const project = projectsMap.get(req.project_id);
          project.requests.push(req);
          if (req.total_amount) {
            project.total_price += parseFloat(req.total_amount) || 0;
            project.total_revenue += parseFloat(req.total_amount) || 0;
          }
        });

        // Process appointments
        appointments.forEach(apt => {
          const projId = apt.project_id || apt.project_number;
          if (!projId) return;

          if (!projectsMap.has(projId)) {
            projectsMap.set(projId, {
              project_id: projId,
              project_number: apt.project_number,
              project_title: apt.project_title,
              customer_email: apt.customer_email,
              customer_id: apt.customer_id,
              customer_name: null,
              requests: [],
              appointments: [],
              total_price: 0,
              total_revenue: 0,
              status: apt.status
            });
          }

          const project = projectsMap.get(projId);
          project.appointments.push(apt);

          // Customer name
          if (apt.first_name || apt.last_name) {
            project.customer_name = `${apt.first_name || ''} ${apt.last_name || ''}`.trim();
          }

          // Calculate revenue
          const revenue = parseFloat(apt.payment_amount || apt.price || apt.total_amount || 0);
          project.total_price += revenue;
          project.total_revenue += revenue;
        });

        const projects = Array.from(projectsMap.values());

        // Count projects by status using PROPER completion logic
        let completedProjects = 0;
        let activeProjects = 0;
        let canceledProjects = 0;
        let finishedProjects = 0;

        projects.forEach(project => {
          if (project.appointments.length > 0) {
            const statuses = project.appointments.map(a => a.status);

            // Check if ALL appointments are finished
            const allFinished = statuses.every(s => s === 'finished');

            // Check if has any scheduled
            const hasScheduled = statuses.some(s => s === 'scheduled');

            // Check if ALL appointments are canceled
            const allCanceled = statuses.every(s => s === 'canceled');

            if (allFinished) {
              completedProjects++;
              finishedProjects++;
              project.project_status = 'completed';
            } else if (allCanceled) {
              canceledProjects++;
              project.project_status = 'canceled';
            } else if (hasScheduled) {
              activeProjects++;
              project.project_status = 'active';
            } else {
              // Mixed finished/canceled but no scheduled = completed
              completedProjects++;
              finishedProjects++;
              project.project_status = 'completed';
            }
          } else {
            // Use request status if no appointments
            if (['open_request', 'pending', 'scheduled'].includes(project.status)) {
              activeProjects++;
              project.project_status = 'active';
            } else if (project.status === 'finished') {
              completedProjects++;
              finishedProjects++;
              project.project_status = 'completed';
            } else if (project.status === 'canceled') {
              canceledProjects++;
              project.project_status = 'canceled';
            }
          }
        });

        // Calculate metrics
        const totalProjects = projects.length;
        const totalRevenue = projects.reduce((sum, p) => sum + p.total_revenue, 0);
        const avgProjectValue = totalProjects > 0 ? totalRevenue / totalProjects : 0;
        const projectsWithAppointments = projects.filter(p => p.appointments.length > 0).length;
        const avgAppointmentsPerProject = totalProjects > 0
          ? projects.reduce((sum, p) => sum + p.appointments.length, 0) / totalProjects
          : 0;
        const completionRate = totalProjects > 0 ? (completedProjects / totalProjects) * 100 : 0;

        const metrics = {
          // New format
          total_projects: totalProjects,
          active_projects: activeProjects,
          finished_projects: finishedProjects,
          total_revenue: totalRevenue,
          avg_project_value: avgProjectValue,
          projects_with_appointments: projectsWithAppointments,
          avg_appointments_per_project: avgAppointmentsPerProject,
          // Legacy format (for backward compatibility)
          totalProjects,
          activeProjects,
          completedProjects,
          canceledProjects,
          totalRevenue,
          avgAppointmentsPerProject,
          completionRate,
          projectsArray: projects
        };

        console.log('âœ… Project metrics calculated:', metrics);
        return metrics;
      }

      // ============================================
      // COMPLETE DASHBOARD STATS FUNCTION
      // ============================================
      async function loadDashboard() {
        console.log('ðŸ“Š Loading Dashboard Statistics...');

        try {
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // USE CENTRAL CACHE - Kein separates Loading!
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          // Requests aus Cache holen
          let allRequests = [];
          let allAppointments = [];

          if (CentralDataManager.isReady()) {
            allRequests = CentralDataManager.getRequests();
            allAppointments = CentralDataManager.getAppointments();
            console.log('ðŸ“Š Dashboard using cached requests:', allRequests.length);
            console.log('ðŸ“Š Dashboard using cached appointments:', allAppointments.length);
          } else {
            console.log('âš ï¸ CentralDataManager not ready, dashboard may have incomplete data');
          }

          // 2. COUNT REQUESTS BY STATUS (INCLUDING ARCHIVED)
          const requestCounts = {
            open_request: 0,
            pending: 0,
            scheduled: 0,
            finished: 0,
            canceled: 0,
            archived: 0
          };

          (allRequests || []).forEach(req => {
            if (requestCounts.hasOwnProperty(req.status)) {
              requestCounts[req.status]++;
            }
          });

          console.log('ðŸ“Š Request counts:', requestCounts);

          // 4. COUNT APPOINTMENTS BY STATUS
          const appointmentCounts = {
            scheduled: 0,
            finished: 0,
            canceled: 0,
            no_show: 0,
            rescheduled: 0,
            reserved: 0,
            unknown: 0
          };

          // Count today's appointments
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);

          let todayAppointments = 0;

          (allAppointments || []).forEach(apt => {
            // Count by status
            if (appointmentCounts.hasOwnProperty(apt.status)) {
              appointmentCounts[apt.status]++;
            }

            // Count today's appointments
            if (apt.start) {
              const aptDate = new Date(apt.start);
              if (aptDate >= today && aptDate < tomorrow) {
                todayAppointments++;
              }
            }
          });

          console.log('ðŸ“… Appointment counts:', appointmentCounts);
          console.log('ðŸ“… Today\'s appointments:', todayAppointments);

          // 5. CUSTOMERS & ARTISTS COUNTS FROM CACHE
          const customerCount = CentralDataManager.isReady()
            ? CentralDataManager.getCustomers().length
            : 0;
          const artistCount = CentralDataManager.isReady()
            ? CentralDataManager.getArtists().length
            : 0;

          // 6. CALCULATE WEEKLY STATISTICS
          // Get start of current week (Monday)
          const now = new Date();
          const dayOfWeek = now.getDay();
          const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Adjust when day is Sunday
          const weekStart = new Date(now);
          weekStart.setDate(now.getDate() - diff);
          weekStart.setHours(0, 0, 0, 0);

          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 7);

          // Count new open requests this week
          let weeklyOpenRequests = 0;
          (allRequests || []).forEach(req => {
            if (req.status === 'open_request' && req.created_at) {
              const createdDate = new Date(req.created_at);
              if (createdDate >= weekStart && createdDate < weekEnd) {
                weeklyOpenRequests++;
              }
            }
          });

          // Count events (appointments) this week
          let weeklyEvents = 0;
          (allAppointments || []).forEach(apt => {
            if (apt.start) {
              const aptDate = new Date(apt.start);
              if (aptDate >= weekStart && aptDate < weekEnd) {
                weeklyEvents++;
              }
            }
          });

          // Count bookings (appointments created) this week
          let weeklyBookings = 0;
          (allAppointments || []).forEach(apt => {
            if (apt.created_at) {
              const createdDate = new Date(apt.created_at);
              if (createdDate >= weekStart && createdDate < weekEnd) {
                weeklyBookings++;
              }
            }
          });

          // 7. UPDATE DASHBOARD CHARTS
          ProgressBar.updateProgress(80, 'Rendering charts...');
          updateRequestStatusBreakdown(requestCounts, allRequests?.length || 0);
          updateAppointmentStatusBreakdown(appointmentCounts, allAppointments?.length || 0);

          // 8. Load project overview KPIs
          ProgressBar.updateProgress(90, 'Loading project metrics...');
          await loadProjectOverviewKPIs();

          console.log('âœ… Dashboard statistics loaded successfully');
          ProgressBar.hide();

        } catch(err) {
          console.error("âŒ Dashboard error:", err);
          ProgressBar.hide();
        }
      }

      // ============================================
      // PINNED EVENTS - LOAD FROM EVENTS TABLE
      // Zeigt Events mit Anwesenheitspflicht die noch nicht vorbei sind
      // ============================================

      let pinnedEventsInterval = null;

      async function loadPinnedEvents() {
        console.log('ðŸ“ Loading Pinned Events from events table...');

        const container = document.getElementById('pinnedEventsContainer');
        if (!container) {
          console.warn('âš ï¸ pinnedEventsContainer not found');
          return;
        }

        try {
          // Aktuelle Zeit fÃ¼r den Filter
          const now = new Date().toISOString();

          // Lade Events mit Anwesenheitspflicht die noch nicht vorbei sind
          const { data: events, error } = await supabase
            .from('events')
            .select('*')
            .eq('attendance_required', true)
            .gt('end_time', now)
            .order('start_time', { ascending: true });

          if (error) throw error;

          console.log('ðŸ“ Found', events?.length || 0, 'upcoming required events');

          if (!events || events.length === 0) {
            container.innerHTML = '<div class="event-empty" style="padding: 20px; text-align: center; color: #86868b; font-size: 14px;">Keine anstehenden Pflicht-Events</div>';
            return;
          }

          const eventsHTML = events.map(event => {
            const startDate = new Date(event.start_time);
            const endDate = new Date(event.end_time);

            const formattedDate = startDate.toLocaleDateString('de-DE', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            });

            const formattedStartTime = startDate.toLocaleTimeString('de-DE', {
              hour: '2-digit',
              minute: '2-digit'
            });

            const formattedEndTime = endDate.toLocaleTimeString('de-DE', {
              hour: '2-digit',
              minute: '2-digit'
            });

            // Berechne wie viel Zeit noch bis zum Event
            const nowMs = Date.now();
            const startMs = startDate.getTime();
            const diffMs = startMs - nowMs;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            let urgencyBadge = '';
            let cardStyle = 'background: rgba(244, 67, 54, 0.1); border: 1px solid #F44336; color: #C62828;';

            if (diffMs < 0) {
              // Event lÃ¤uft gerade
              urgencyBadge = '<span style="font-size:10px; background:#4CAF50; color:white; padding:2px 6px; border-radius:4px; font-weight:600; margin-left:8px;">JETZT</span>';
              cardStyle = 'background: rgba(76, 175, 80, 0.1); border: 1px solid #4CAF50; color: #2E7D32;';
            } else if (diffHours < 1) {
              // Weniger als 1 Stunde
              urgencyBadge = '<span style="font-size:10px; background:#FF5722; color:white; padding:2px 6px; border-radius:4px; font-weight:600; margin-left:8px;">BALD</span>';
            } else if (diffDays === 0) {
              // Heute
              urgencyBadge = '<span style="font-size:10px; background:#FF9800; color:white; padding:2px 6px; border-radius:4px; font-weight:600; margin-left:8px;">HEUTE</span>';
            } else if (diffDays === 1) {
              // Morgen
              urgencyBadge = '<span style="font-size:10px; background:#FFC107; color:#333; padding:2px 6px; border-radius:4px; font-weight:600; margin-left:8px;">MORGEN</span>';
            }

            // Icon fÃ¼r Pflicht-Event (Personen-Icon)
            const icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>';

            return `
              <div class="pinned-event-card" style="${cardStyle} padding:12px; border-radius:8px; margin-bottom:10px;">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                  <span style="display:inline-flex;">${icon}</span>
                  <span style="font-weight:600; font-size:14px;">${event.title || 'Event'}</span>
                  <span style="font-size:10px; background:#F44336; color:white; padding:2px 6px; border-radius:4px; font-weight:600;">PFLICHT</span>
                  ${urgencyBadge}
                </div>
                <div style="font-size:12px; opacity:0.8;">
                  ${formattedDate} Â· ${formattedStartTime} - ${formattedEndTime}
                </div>
                ${event.location ? `<div style="margin-top:6px;"><span style="font-size:11px; background:rgba(0,0,0,0.1); padding:3px 8px; border-radius:4px;">ðŸ“ ${event.location}</span></div>` : ''}
              </div>
            `;
          }).join('');

          container.innerHTML = eventsHTML;
          console.log('âœ… Loaded', events.length, 'pinned events');

        } catch (err) {
          console.error('âŒ Error loading pinned events:', err);
          container.innerHTML = '<div class="event-empty" style="padding: 20px; text-align: center; color: #ff3b30; font-size: 14px;">Fehler beim Laden der Events</div>';
        }
      }

      // ============================================
      // PINNED EVENTS - AUTO-REFRESH (alle 60 Sekunden)
      // ============================================
      function startPinnedEventsAutoRefresh() {
        // Safe check - variable might not be initialized yet
        if (typeof pinnedEventsInterval !== 'undefined' && pinnedEventsInterval) {
          clearInterval(pinnedEventsInterval);
        }

        // Starte neuen Interval - alle 60 Sekunden
        pinnedEventsInterval = setInterval(async () => {
          console.log('ðŸ”„ Auto-refreshing pinned events...');
          await loadPinnedEvents();
        }, 60000); // 60 Sekunden

        console.log('â° Pinned events auto-refresh started (every 60s)');
      }

      function stopPinnedEventsAutoRefresh() {
        if (pinnedEventsInterval) {
          clearInterval(pinnedEventsInterval);
          pinnedEventsInterval = null;
          console.log('â¹ï¸ Pinned events auto-refresh stopped');
        }
      }

      // Expose functions to window
      window.loadPinnedEvents = loadPinnedEvents;
      window.startPinnedEventsAutoRefresh = startPinnedEventsAutoRefresh;
      window.stopPinnedEventsAutoRefresh = stopPinnedEventsAutoRefresh;

      // ============================================
      // SCHWARZES BRETT - LOAD FROM SUPABASE
      // ============================================
      async function loadSchwarzesBrett() {
        console.log('ðŸ“‹ Loading Schwarzes Brett...');

        const container = document.getElementById('brettMessages');
        if (!container) return;

        try {
          // Get current auth session to compare author_id correctly
          const { data: { session } } = await supabase.auth.getSession();
          const currentAuthUserId = session?.user?.id;

          console.log('ðŸ”‘ Current Auth User ID:', currentAuthUserId);
          console.log('ðŸ‘¤ Current User Profile ID:', currentUser?.id);

          const { data: messages, error } = await supabase
            .from('schwarzes_brett')
            .select('*')
            .eq('is_active', true)
            .order('created_at', { ascending: false })
            .limit(20);

          if (error) throw error;

          if (!messages || messages.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#86868b;">Keine Nachrichten vorhanden</div>';
            return;
          }

          // Get all profiles for avatar lookup
          const allProfiles = window.centralDataManager?.data?.profiles || [];

          const messagesHTML = messages.map(msg => {
            const createdDate = new Date(msg.created_at);
            const timeAgo = getTimeAgo(createdDate);

            // Load avatar from profiles table based on author_id
            let avatarUrl = null;
            let authorName = msg.author || 'User';

            // Look up profile by author_id (which is the auth.uid)
            const authorProfile = allProfiles.find(p => p.auth_uid === msg.author_id);
            if (authorProfile) {
              avatarUrl = authorProfile.avatar_url;
              authorName = authorProfile.username || msg.author || 'User';
            } else if (msg.author_id === currentAuthUserId && currentUser?.avatar_url) {
              // Fallback: If it's current user, use their avatar
              avatarUrl = currentUser.avatar_url;
              authorName = currentUser.username || msg.author;
            }

            // Create initials for fallback
            const initials = authorName.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase() || 'U';

            // Avatar HTML - either image or initials circle
            const avatarHtml = avatarUrl
              ? `<img src="${avatarUrl}" alt="${authorName}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                 <div style="display:none; width:40px; height:40px; border-radius:50%; background:#e5e5e5; align-items:center; justify-content:center; font-weight:600; font-size:14px; color:#666;">${initials}</div>`
              : `<div style="width:40px; height:40px; border-radius:50%; background:#e5e5e5; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:14px; color:#666;">${initials}</div>`;

            // CRITICAL: Compare msg.author_id with Auth UID (not profiles.id!)
            const isOwnMessage = msg.author_id === currentAuthUserId;
            console.log(`ðŸ“ Message "${msg.content.substring(0,20)}..." by ${msg.author_id} - isOwn: ${isOwnMessage}`);

            // Build the message HTML
            return `
              <div class="brett-item" data-id="${msg.id}" style="display:flex; gap:12px; padding:12px 0;">
                <!-- Avatar -->
                <div style="flex-shrink:0;">
                  ${avatarHtml}
                </div>

                <!-- Content -->
                <div style="flex:1; min-width:0;">
                  <!-- Header Row: Name, Time, Menu -->
                  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
                    <div style="display:flex; align-items:center; gap:6px;">
                      <span style="font-weight:600; font-size:14px; color:#1d1d1f;">${authorName}</span>
                      <span style="font-size:13px; color:#86868b;">Â· ${timeAgo}</span>
                    </div>

                    <!-- 3-Dot Menu (horizontal â‹¯) - only for own messages -->
                    ${isOwnMessage ? `
                      <div class="brett-menu" style="position:relative;">
                        <button
                          onclick="event.stopPropagation(); toggleBrettMenu('${msg.id}')"
                          style="background:none; border:none; cursor:pointer; padding:8px; color:#86868b; font-size:20px; line-height:1; border-radius:50%; transition:background 0.15s;"
                          onmouseover="this.style.background='rgba(0,0,0,0.05)'"
                          onmouseout="this.style.background='none'"
                          title="Optionen"
                        >â‹¯</button>
                        <div
                          class="brett-menu-dropdown"
                          id="brettMenu-${msg.id}"
                          style="display:none; position:absolute; right:0; top:100%; background:#fff; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.15); min-width:150px; z-index:1000; overflow:hidden;"
                        >
                          <button
                            onclick="event.stopPropagation(); editBrettMessage('${msg.id}')"
                            style="display:flex; align-items:center; gap:10px; width:100%; padding:12px 16px; text-align:left; border:none; background:none; cursor:pointer; font-size:14px; color:#1d1d1f; transition:background 0.15s;"
                            onmouseover="this.style.background='#f5f5f7'"
                            onmouseout="this.style.background='none'"
                          >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            Bearbeiten
                          </button>
                          <button
                            onclick="event.stopPropagation(); deleteBrettMessage('${msg.id}')"
                            style="display:flex; align-items:center; gap:10px; width:100%; padding:12px 16px; text-align:left; border:none; background:none; cursor:pointer; font-size:14px; color:#ff3b30; transition:background 0.15s;"
                            onmouseover="this.style.background='#fff5f5'"
                            onmouseout="this.style.background='none'"
                          >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            LÃ¶schen
                          </button>
                        </div>
                      </div>
                    ` : ''}
                  </div>

                  <!-- Message Content -->
                  <div style="font-size:15px; line-height:1.5; color:#1d1d1f; margin-bottom:8px; white-space:pre-wrap;">${msg.content}</div>

                  <!-- Category Tag -->
                  <div style="display:flex; gap:8px;">
                    <span style="font-size:12px; padding:4px 10px; background:rgba(0,0,0,0.04); border-radius:999px; color:#666;">${msg.category || 'Info'}</span>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          container.innerHTML = messagesHTML;
          console.log('âœ… Loaded', messages.length, 'messages');

        } catch (err) {
          console.error('âŒ Error loading schwarzes brett:', err);
          container.innerHTML = '<div style="padding:20px; text-align:center; color:#ff3b30;">Fehler beim Laden</div>';
        }
      }

      // ============================================
      // BRETT MENU FUNCTIONS
      // ============================================

      // Store messages for edit function
      window.schwarzesBrettMessages = [];

      /**
       * Toggle the dropdown menu for a specific message
       */
      function toggleBrettMenu(messageId) {
        const menu = document.getElementById(`brettMenu-${messageId}`);
        if (!menu) {
          console.error('âŒ Menu not found for message:', messageId);
          return;
        }

        // Close all other open menus first
        document.querySelectorAll('.brett-menu-dropdown').forEach(m => {
          if (m.id !== `brettMenu-${messageId}`) {
            m.style.display = 'none';
          }
        });

        // Toggle this menu
        const isVisible = menu.style.display === 'block';
        menu.style.display = isVisible ? 'none' : 'block';
      }

      /**
       * Close all menus when clicking outside
       */
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.brett-menu')) {
          document.querySelectorAll('.brett-menu-dropdown').forEach(m => {
            m.style.display = 'none';
          });
        }
      });

      /**
       * Edit a message - opens prompt with current content
       */
      async function editBrettMessage(messageId) {
        // Close the menu
        document.querySelectorAll('.brett-menu-dropdown').forEach(m => m.style.display = 'none');

        // Find the message element and get current content
        const messageEl = document.querySelector(`.brett-item[data-id="${messageId}"]`);
        const currentContent = messageEl?.querySelector('div[style*="white-space:pre-wrap"]')?.textContent || '';

        // Prompt for new content
        const newContent = prompt('Nachricht bearbeiten:', currentContent);

        // Only update if content changed and is not empty
        if (newContent && newContent.trim() && newContent.trim() !== currentContent) {
          try {
            const { error } = await supabase
              .from('schwarzes_brett')
              .update({
                content: newContent.trim(),
                updated_at: new Date().toISOString()
              })
              .eq('id', messageId);

            if (error) throw error;

            console.log('âœ… Message updated successfully');
            await loadSchwarzesBrett();

          } catch (err) {
            console.error('âŒ Error updating message:', err);
            alert('Fehler beim Speichern: ' + err.message);
          }
        }
      }

      /**
       * Delete a message - with confirmation
       */
      async function deleteBrettMessage(messageId) {
        // Close the menu
        document.querySelectorAll('.brett-menu-dropdown').forEach(m => m.style.display = 'none');

        if (!confirm('MÃ¶chtest du diese Nachricht wirklich lÃ¶schen?')) {
          return;
        }

        try {
          const { error } = await supabase
            .from('schwarzes_brett')
            .delete()
            .eq('id', messageId);

          if (error) throw error;

          console.log('âœ… Message deleted successfully');
          await loadSchwarzesBrett();

        } catch (err) {
          console.error('âŒ Error deleting message:', err);
          alert('Fehler beim LÃ¶schen: ' + err.message);
        }
      }

      // Expose functions to window for onclick handlers
      window.toggleBrettMenu = toggleBrettMenu;
      window.editBrettMessage = editBrettMessage;
      window.deleteBrettMessage = deleteBrettMessage;

      // ============================================
      // ADMIN: DELETE SAMPLE DATA
      // ============================================
      async function deleteSampleData() {
        if (!confirm('Alle Sample-Daten (Posts ohne Author und Sample-Events) wirklich lÃ¶schen?')) {
          return;
        }

        console.log('ðŸ—‘ï¸ Deleting sample data...');

        try {
          // Delete sample posts from schwarzes_brett (author_id is NULL)
          const { error: brettError, count: brettCount } = await supabase
            .from('schwarzes_brett')
            .delete()
            .is('author_id', null);

          if (brettError) {
            console.error('Error deleting brett samples:', brettError);
          } else {
            console.log('âœ… Deleted sample brett posts');
          }

          // Reload Schwarzes Brett
          await loadSchwarzesBrett();

          alert('Sample-Daten wurden gelÃ¶scht!');

        } catch (err) {
          console.error('âŒ Error deleting sample data:', err);
          alert('Fehler: ' + err.message);
        }
      }

      // Expose to window for console access
      window.deleteSampleData = deleteSampleData;

      // ============================================
      // HELPER: TIME AGO
      // ============================================
      function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Gerade eben';
        if (diffMins < 60) return `vor ${diffMins} Min`;
        if (diffHours < 24) return `vor ${diffHours} Std`;
        if (diffDays === 1) return 'Gestern';
        if (diffDays < 7) return `vor ${diffDays} Tagen`;

        return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }

      // ============================================
      // SCHWARZES BRETT - ADD NEW MESSAGE
      // ============================================
      async function addNewMessage(content, category, location) {
        console.log('ðŸ“ Adding new message...');

        try {
          // Get current user
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) {
            alert('Du musst angemeldet sein, um eine Nachricht zu posten.');
            return;
          }

          // Use currentUser from global state instead of querying profiles
          const authorName = currentUser?.name || currentUser?.username || 'Anonymous';

          const { error } = await supabase
            .from('schwarzes_brett')
            .insert([{
              author: authorName,
              author_id: user.id,
              content: content,
              category: category,
              location: location,
              is_active: true
            }]);

          if (error) throw error;

          console.log('âœ… Message added successfully');

          // Reload messages
          await loadSchwarzesBrett();

          // Close popup and reset form
          document.getElementById('newMessagePopup').classList.remove('active');
          document.getElementById('messageContent').value = '';

        } catch (err) {
          console.error('âŒ Error adding message:', err);
          alert('Fehler beim HinzufÃ¼gen der Nachricht: ' + err.message);
        }
      }

      // ============================================
      // EVENT LISTENERS FOR SCHWARZES BRETT
      // ============================================
      document.getElementById('addMessageBtn')?.addEventListener('click', function() {
        document.getElementById('newMessagePopup').classList.add('active');
      });

      document.getElementById('closePopupBtn')?.addEventListener('click', function() {
        document.getElementById('newMessagePopup').classList.remove('active');
      });

      document.getElementById('submitMessageBtn')?.addEventListener('click', async function() {
        const content = document.getElementById('messageContent').value.trim();
        const category = document.getElementById('messageCategory').value;
        const location = document.getElementById('messageLocation').value;

        if (!content) {
          alert('Bitte gib eine Nachricht ein.');
          return;
        }

        await addNewMessage(content, category, location);
      });

      // ============================================
      // TO-DO PROJECTS SYSTEM (NEW VERSION)
      // ============================================

      // State
      let todoProjects = [];
      let selectedTodoProject = null;
      let todoCollaborators = [];

      // Helper: Get Current User ID
      async function getTodoUserId() {
        console.log('ðŸ” getTodoUserId() called');
        console.log('  - currentUser defined:', typeof currentUser !== 'undefined');
        console.log('  - currentUser:', currentUser);

        // PRIORITY 1: Use currentUser.id (this is always profiles.id)
        if (typeof currentUser !== 'undefined' && currentUser?.id) {
          console.log('  âœ… Returning currentUser.id (profiles.id):', currentUser.id);
          return currentUser.id;
        }

        // PRIORITY 2: If we have currentUser.email, look up profiles.id
        if (typeof currentUser !== 'undefined' && currentUser?.email) {
          console.log('  ðŸ” Looking up profile by email:', currentUser.email);
          const { data: profile } = await supabase.from('profiles').select('id').eq('email', currentUser.email).single();
          if (profile?.id) {
            console.log('  âœ… Found profiles.id by email:', profile.id);
            return profile.id;
          }
        }

        // PRIORITY 3: Try to get profile from Supabase Auth session
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (session?.user?.email) {
            console.log('  ðŸ” Looking up profile by auth email:', session.user.email);
            const { data: profile } = await supabase.from('profiles').select('id').eq('email', session.user.email).single();
            if (profile?.id) {
              console.log('  âœ… Found profiles.id by auth email:', profile.id);
              return profile.id;
            }
          }
        } catch (e) {
          console.warn('  âš ï¸ Error getting auth session:', e);
        }

        console.log('  âŒ No user ID found, returning null');
        return null;
      }

      // Calculate Due Days
      function calculateDueDays(deadline) {
        if (!deadline) return null;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const dueDate = new Date(deadline);
        dueDate.setHours(0, 0, 0, 0);
        const diffTime = dueDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
      }

      // Format Due Badge
      function formatDueBadge(deadline) {
        const days = calculateDueDays(deadline);
        if (days === null) return '';
        if (days < 0) {
          return `<span class="todo-due-badge overdue">Overdue ${Math.abs(days)} days</span>`;
        } else if (days === 0) {
          return `<span class="todo-due-badge overdue">Due today</span>`;
        } else if (days === 1) {
          return `<span class="todo-due-badge due-soon">Due 1 day</span>`;
        } else if (days <= 7) {
          return `<span class="todo-due-badge due-soon">Due ${days} days</span>`;
        } else {
          return `<span class="todo-due-badge on-track">Due ${days} days</span>`;
        }
      }

      // Format Collaborators Text
      function formatCollaboratorsText(collaborators) {
        if (!collaborators || collaborators.length === 0) return 'No collaborators';
        const names = collaborators.map(c => c.profiles?.username || 'Unknown');
        if (names.length <= 3) {
          return `Collaborators: ${names.join(', ')}`;
        }
        return `Collaborators: ${names.slice(0, 3).join(', ')} + ${names.length - 3} others`;
      }

      // Load Projects
      async function loadTodoProjects() {
        console.log('ðŸ“‹ loadTodoProjects() called');
        console.log('ðŸ“‹ currentUser at call time:', currentUser ? `${currentUser.username} (${currentUser.id})` : 'NULL');

        const container = document.getElementById('todoProjectsList');
        if (!container) {
          console.warn('âš ï¸ todoProjectsList container not found');
          return;
        }

        // Skip loading if no user is logged in yet
        if (!currentUser?.id) {
          console.warn('âš ï¸ No currentUser set - skipping project load');
          container.innerHTML = '<div class="todo-empty-state">Bitte einloggen...</div>';
          return;
        }

        try {
          console.log('ðŸ“‹ ========================================');
          console.log('ðŸ“‹ Loading To-Do Projects for:', currentUser.username);
          console.log('ðŸ“‹ ========================================');

          // Check Supabase Auth session first
          const { data: { session } } = await supabase.auth.getSession();
          console.log('ðŸ” Auth Session:', session ? 'EXISTS' : 'NULL');
          console.log('ðŸ”‘ auth.uid():', session?.user?.id || 'NULL');
          console.log('ðŸŽ« Access Token:', session?.access_token ? 'EXISTS' : 'NULL');

          // Get current user for debugging
          const currentUserId = await getTodoUserId();
          console.log('ðŸ‘¤ Current User ID (from profile):', currentUserId);

          const { data: projects, error } = await supabase
            .from('task_projects')
            .select(`
              *,
              project_tasks (*),
              project_collaborators (
                id,
                user_id,
                role,
                profiles:user_id (id, username, email)
              )
            `)
            .order('created_at', { ascending: false });

          console.log('ðŸ“¦ Raw Supabase Response:');
          console.log('  - Error:', error);
          console.log('  - Projects count:', projects?.length || 0);

          if (error) {
            console.error('âŒ Supabase error details:', JSON.stringify(error, null, 2));
            throw error;
          }

          // Log each project with details
          (projects || []).forEach((p, i) => {
            console.log(`ðŸ“ Project ${i + 1}: "${p.title}" (ID: ${p.id})`);
            console.log(`   - Created by: ${p.created_by}`);
            console.log(`   - Tasks: ${p.project_tasks?.length || 0}`);
            console.log(`   - Collaborators: ${p.project_collaborators?.length || 0}`);
            if (p.project_collaborators?.length > 0) {
              p.project_collaborators.forEach(c => {
                console.log(`     â€¢ ${c.role}: ${c.profiles?.username || c.user_id}`);
              });
            }
          });

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // FILTER DEBUG - Detailed logging to diagnose filter issues
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          console.log('=== FILTER DEBUG ===');
          console.log('Current User ID:', currentUserId);
          console.log('Current User ID type:', typeof currentUserId);
          console.log('All projects:', (projects || []).map(p => ({
              id: p.id,
              title: p.title,
              created_by: p.created_by,
              created_by_type: typeof p.created_by,
              collaborators: p.project_collaborators?.map(c => ({ user_id: c.user_id, role: c.role }))
          })));
          console.log('Filter check for each project:');
          (projects || []).forEach(p => {
              const isCreator = p.created_by === currentUserId;
              const isCollaborator = p.project_collaborators?.some(c => c.user_id === currentUserId);
              console.log(`  "${p.title}": created_by=${p.created_by}, isCreator=${isCreator}, isCollaborator=${isCollaborator}`);
              if (p.project_collaborators?.length > 0) {
                  p.project_collaborators.forEach(c => {
                      const match = c.user_id === currentUserId;
                      console.log(`    - Collaborator: ${c.user_id} === ${currentUserId} ? ${match}`);
                  });
              }
          });
          console.log('=== END FILTER DEBUG ===');

          // FRONTEND FILTER: Only show projects where user is creator OR collaborator
          const filteredProjects = (projects || []).filter(project => {
            const isCreator = project.created_by === currentUserId;
            const isCollaborator = project.project_collaborators?.some(c => c.user_id === currentUserId);
            return isCreator || isCollaborator;
          });

          console.log(`ðŸ” Filtered: ${filteredProjects.length} of ${projects?.length || 0} projects visible for user`);

          todoProjects = filteredProjects.map(project => {
            const tasks = project.project_tasks || [];
            const completed = tasks.filter(t => t.is_completed).length;
            const total = tasks.length;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
            return { ...project, tasks, progress, completed, total };
          });

          renderTodoProjects();
          console.log('âœ… Projects loaded and rendered:', todoProjects.length);
          console.log('ðŸ“‹ ========================================');
        } catch (err) {
          console.error('âŒ Error loading projects:', err);
          console.error('âŒ Stack trace:', err.stack);
          container.innerHTML = '<div class="todo-empty-state">Fehler beim Laden</div>';
        }
      }
      // IMMEDIATELY expose to window - MUST be right after function definition
      window.loadTodoProjects = loadTodoProjects;

      // Listen for authentication event to load projects
      window.addEventListener('user-authenticated', async (event) => {
        console.log('ðŸ“‹ user-authenticated event received:', event.detail);
        if (typeof loadTodoProjects === 'function') {
          await loadTodoProjects();
        }
      });

      // Also check if user is already authenticated when this script runs
      if (typeof currentUser !== 'undefined' && currentUser?.id) {
        console.log('ðŸ“‹ User already authenticated, loading projects immediately...');
        loadTodoProjects();
      }

      // Render Projects List
      function renderTodoProjects() {
        const container = document.getElementById('todoProjectsList');
        if (!container) return;

        const isMobileView = window.innerWidth <= 768;

        if (todoProjects.length === 0) {
          container.innerHTML = '<div class="todo-empty-state">Keine Projekte vorhanden</div>';
          return;
        }

        container.innerHTML = todoProjects.map(project => {
          const isSelected = selectedTodoProject?.id === project.id;
          const dueBadge = formatDueBadge(project.deadline);
          const collabText = formatCollaboratorsText(project.project_collaborators);

          // Mobile: Include tasks inside card for accordion
          const tasks = project.tasks || [];
          const tasksHtml = isMobileView ? tasks.map(task => `
            <div class="mobile-task-item ${task.is_completed ? 'completed' : ''}" data-task-id="${task.id}">
              <span class="mobile-task-checkbox ${task.is_completed ? 'completed' : ''}" onclick="event.stopPropagation(); toggleMobileTask('${task.id}', ${!task.is_completed}, '${project.id}')"></span>
              <span class="mobile-task-title" onclick="event.stopPropagation(); openTaskViewPopup('${task.id}')" style="cursor: pointer; flex: 1;">${task.title}</span>
            </div>
          `).join('') : '';

          // Mobile arrow icon
          const arrowHtml = isMobileView ? `
            <svg class="mobile-project-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"/>
            </svg>
          ` : '';

          return `
            <div class="todo-project-card ${isSelected ? 'selected' : ''}" data-project-id="${project.id}">
              <div class="todo-project-header">
                <h4 class="todo-project-title">${project.title}</h4>
                <div class="todo-project-meta">
                  ${dueBadge}
                  <span class="todo-project-percent">${project.progress}%</span>
                </div>
                ${arrowHtml}
              </div>
              <div class="todo-progress-container">
                <div class="todo-progress-bar" style="width: ${project.progress}%"></div>
              </div>
              <div class="todo-project-footer">
                <span class="todo-project-collaborators">${collabText}</span>
                <button class="todo-edit-btn" onclick="event.stopPropagation(); openTodoEditModal('${project.id}')">Edit</button>
              </div>
              ${isMobileView ? `<div class="mobile-project-tasks">
                ${tasksHtml || '<div style="padding:12px 0;color:#86868b;font-size:14px;">Keine Tasks</div>'}
                <button class="mobile-add-task-btn" onclick="event.stopPropagation(); openAddTaskModal('${project.id}')">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  Task hinzufÃ¼gen
                </button>
              </div>` : ''}
            </div>
          `;
        }).join('');

        // Add click handlers for project selection / accordion toggle
        container.querySelectorAll('.todo-project-card').forEach(card => {
          card.addEventListener('click', () => {
            const projectId = card.dataset.projectId;
            const isMobileView = window.innerWidth <= 768;

            if (isMobileView) {
              // Mobile: Toggle accordion
              toggleMobileProjectAccordion(card);
            } else {
              // Desktop: Select project
              selectTodoProject(projectId);
            }
          });
        });
      }

      // Mobile: Toggle project accordion
      function toggleMobileProjectAccordion(card) {
        // Close other expanded cards
        document.querySelectorAll('.todo-project-card.expanded').forEach(c => {
          if (c !== card) c.classList.remove('expanded');
        });
        // Toggle current card
        card.classList.toggle('expanded');
      }
      window.toggleMobileProjectAccordion = toggleMobileProjectAccordion;

      // Mobile: Toggle task completion
      window.toggleMobileTask = async function(taskId, isCompleted, projectId) {
        try {
          const userId = await getTodoUserId();
          const { error } = await supabase
            .from('project_tasks')
            .update({
              is_completed: isCompleted,
              completed_by: isCompleted ? userId : null,
              completed_at: isCompleted ? new Date().toISOString() : null
            })
            .eq('id', taskId);

          if (error) throw error;

          // Update local state
          const projectIdx = todoProjects.findIndex(p => p.id === projectId);
          if (projectIdx !== -1) {
            const taskIdx = todoProjects[projectIdx].tasks?.findIndex(t => t.id === taskId);
            if (taskIdx !== -1 && todoProjects[projectIdx].tasks) {
              todoProjects[projectIdx].tasks[taskIdx].is_completed = isCompleted;
              // Recalculate progress
              const tasks = todoProjects[projectIdx].tasks;
              const completed = tasks.filter(t => t.is_completed).length;
              todoProjects[projectIdx].progress = Math.round((completed / tasks.length) * 100);
            }
          }

          // Re-render to show updated state
          renderTodoProjects();
          console.log('âœ… Mobile task toggled:', taskId, isCompleted);
        } catch (err) {
          console.error('âŒ Error toggling mobile task:', err);
        }
      };

      // Mobile: Open Add Task Modal
      async function openAddTaskModal(projectId) {
        console.log('ðŸ“ openAddTaskModal called for project:', projectId);

        // Finde das Projekt in den geladenen Daten
        let project = null;

        // Method 1: Global todoProjects
        if (typeof todoProjects !== 'undefined' && todoProjects) {
          project = todoProjects.find(p => p.id === projectId);
        }

        // Method 2: CentralDataManager
        if (!project && typeof CentralDataManager !== 'undefined' && CentralDataManager.getProjects) {
          const projects = CentralDataManager.getProjects() || [];
          project = projects.find(p => p.id === projectId);
        }

        // Method 3: Fetch from Supabase
        if (!project && typeof supabase !== 'undefined') {
          try {
            const { data } = await supabase
              .from('task_projects')
              .select('*, project_collaborators(user_id, role, profiles(username))')
              .eq('id', projectId)
              .single();
            project = data;
          } catch (err) {
            console.error('Supabase fetch error:', err);
          }
        }

        if (!project) {
          console.error('âŒ Projekt nicht gefunden:', projectId);
          alert('Projekt nicht gefunden');
          return;
        }

        // WICHTIG: selectedTodoProject setzen (wird von saveTodoTask verwendet)
        selectedTodoProject = project;
        console.log('âœ… selectedTodoProject gesetzt:', project.title);

        // Modal Inputs zurÃ¼cksetzen
        const titleInput = document.getElementById('todoTaskTitle');
        const assigneeSelect = document.getElementById('todoTaskAssignee');
        const assigneeGroup = document.getElementById('todoTaskAssigneeGroup');

        if (titleInput) titleInput.value = '';
        if (assigneeSelect) assigneeSelect.value = '';

        // Collaborators Dropdown befÃ¼llen
        const collabs = project.project_collaborators || [];
        if (collabs.length > 0 && assigneeGroup && assigneeSelect) {
          assigneeGroup.style.display = 'block';
          const options = collabs.map(c =>
            `<option value="${c.user_id}">${c.profiles?.username || 'Unknown'} (${c.role})</option>`
          );
          assigneeSelect.innerHTML = '<option value="">Niemand</option>' + options.join('');
        } else if (assigneeGroup) {
          assigneeGroup.style.display = 'none';
        }

        // Modal Ã¶ffnen
        const modal = document.getElementById('todoTaskModal');
        if (modal) {
          modal.classList.add('active');
          if (titleInput) setTimeout(() => titleInput.focus(), 100);
        }
      }
      window.openAddTaskModal = openAddTaskModal;

      // Select Project
      function selectTodoProject(projectId) {
        selectedTodoProject = todoProjects.find(p => p.id === projectId) || null;
        renderTodoProjects();
        renderTodoTasks();
      }

      // Render Tasks
      function renderTodoTasks() {
        const titleEl = document.getElementById('todoTasksTitle');
        const listEl = document.getElementById('todoTasksList');
        const addBtn = document.getElementById('todoAddTaskBtn');

        if (!selectedTodoProject) {
          titleEl.textContent = 'Select Project to view';
          listEl.innerHTML = '<div class="todo-empty-state">Select Project to view</div>';
          addBtn.style.display = 'none';
          return;
        }

        titleEl.textContent = selectedTodoProject.title;
        addBtn.style.display = 'block';

        const tasks = selectedTodoProject.tasks || [];
        if (tasks.length === 0) {
          listEl.innerHTML = '<div class="todo-empty-state">Keine Tasks vorhanden</div>';
          return;
        }

        // Sort by order_index
        const sortedTasks = [...tasks].sort((a, b) => (a.order_index || 0) - (b.order_index || 0));

        listEl.innerHTML = sortedTasks.map(task => {
          const assignee = task.assigned_to ? getAssigneeName(task.assigned_to) : '';
          const completedClass = task.is_completed ? 'completed' : '';

          return `
            <div class="todo-task-item ${completedClass}" data-task-id="${task.id}">
              <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0;">
                <input type="checkbox" class="todo-task-checkbox" ${task.is_completed ? 'checked' : ''} onchange="toggleTodoTask('${task.id}', this.checked)">
                <span class="todo-task-title" onclick="openTaskViewPopup('${task.id}')" style="cursor: pointer; flex: 1; min-width: 0;">${task.title}</span>
              </div>
              <div class="todo-task-right">
                ${assignee ? `<span class="todo-task-assignee">${assignee}</span>` : ''}
                <div class="task-menu-container">
                  <button class="task-menu-trigger" onclick="toggleTaskMenu('${task.id}', event)">â‹¯</button>
                  <div class="task-menu-dropdown" id="taskMenu-${task.id}">
                    <button class="task-menu-item" onclick="openTaskEditPopup('${task.id}')">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                      </svg>
                      Bearbeiten
                    </button>
                    <button class="task-menu-item delete" onclick="deleteTask('${task.id}')">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                      </svg>
                      LÃ¶schen
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      // Get Assignee Name
      function getAssigneeName(userId) {
        if (!selectedTodoProject?.project_collaborators) return '';
        const collab = selectedTodoProject.project_collaborators.find(c => c.user_id === userId);
        return collab?.profiles?.username || '';
      }

      // Toggle Task
      window.toggleTodoTask = async function(taskId, isCompleted) {
        try {
          const userId = await getTodoUserId();
          const { error } = await supabase
            .from('project_tasks')
            .update({
              is_completed: isCompleted,
              completed_by: isCompleted ? userId : null,
              completed_at: isCompleted ? new Date().toISOString() : null
            })
            .eq('id', taskId);

          if (error) throw error;

          // Update local state
          const projectIdx = todoProjects.findIndex(p => p.id === selectedTodoProject.id);
          if (projectIdx !== -1) {
            const taskIdx = todoProjects[projectIdx].tasks.findIndex(t => t.id === taskId);
            if (taskIdx !== -1) {
              todoProjects[projectIdx].tasks[taskIdx].is_completed = isCompleted;
              // Recalculate progress
              const tasks = todoProjects[projectIdx].tasks;
              const completed = tasks.filter(t => t.is_completed).length;
              todoProjects[projectIdx].progress = tasks.length > 0 ? Math.round((completed / tasks.length) * 100) : 0;
              todoProjects[projectIdx].completed = completed;
            }
          }

          selectedTodoProject = todoProjects.find(p => p.id === selectedTodoProject.id);
          renderTodoProjects();
          renderTodoTasks();
        } catch (err) {
          console.error('âŒ Error toggling task:', err);
          alert('Fehler beim Aktualisieren des Tasks');
        }
      };

      // ============================================
      // TASK MENU FUNCTIONS
      // ============================================

      function toggleTaskMenu(taskId, event) {
        event.stopPropagation();

        // SchlieÃŸe alle anderen offenen MenÃ¼s
        document.querySelectorAll('.task-menu-dropdown.active').forEach(menu => {
          if (menu.id !== `taskMenu-${taskId}`) {
            menu.classList.remove('active');
          }
        });

        // Toggle das aktuelle MenÃ¼
        const menu = document.getElementById(`taskMenu-${taskId}`);
        if (menu) {
          menu.classList.toggle('active');
        }
      }

      // ============================================
      // TASK VIEW POPUP (Nur Ansicht)
      // ============================================

      async function openTaskViewPopup(taskId) {
        // Lade Task-Daten
        const { data: task, error: taskError } = await supabase
          .from('project_tasks')
          .select('*')
          .eq('id', taskId)
          .single();

        if (taskError || !task) {
          console.error('Error loading task:', taskError);
          return;
        }

        // Lade Attachments
        const { data: attachments, error: attachError } = await supabase
          .from('task_attachments')
          .select('*')
          .eq('task_id', taskId)
          .order('created_at', { ascending: true });

        if (attachError) {
          console.error('Error loading attachments:', attachError);
        }

        // Entferne existierendes Popup
        const existingPopup = document.getElementById('taskViewPopup');
        if (existingPopup) existingPopup.remove();

        // Erstelle Popup
        const popup = document.createElement('div');
        popup.id = 'taskViewPopup';
        popup.className = 'task-popup-overlay';

        const attachmentsHTML = attachments && attachments.length > 0
          ? attachments.map(att => `
              <div class="task-attachment-item">
                <div class="task-attachment-preview ${att.file_type === 'application/pdf' ? 'pdf' : ''}">
                  ${att.file_type === 'application/pdf'
                    ? 'PDF'
                    : `<img src="${att.file_url}" alt="${att.file_name}">`
                  }
                </div>
                <div class="task-attachment-info">
                  <div class="task-attachment-name">${att.file_name}</div>
                  <div class="task-attachment-size">${formatFileSize(att.file_size)}</div>
                </div>
                <div class="task-attachment-actions">
                  <a href="${att.file_url}" download="${att.file_name}" class="task-attachment-btn" title="Herunterladen">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                  </a>
                  <a href="${att.file_url}" target="_blank" class="task-attachment-btn" title="Ã–ffnen">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                      <polyline points="15 3 21 3 21 9"/>
                      <line x1="10" y1="14" x2="21" y2="3"/>
                    </svg>
                  </a>
                </div>
              </div>
            `).join('')
          : '<div class="task-no-attachments">Keine AnhÃ¤nge vorhanden</div>';

        popup.innerHTML = `
          <div class="task-popup">
            <div class="task-popup-header">
              <h3 class="task-popup-title">Task Details</h3>
              <button class="task-popup-close" onclick="closeTaskViewPopup()">âœ•</button>
            </div>
            <div class="task-popup-body">
              <div class="task-popup-section">
                <label class="task-popup-label">Name</label>
                <p class="task-popup-text">${task.title || 'Kein Titel'}</p>
              </div>
              <div class="task-popup-section">
                <label class="task-popup-label">Beschreibung</label>
                <p class="task-popup-text">${task.description || 'Keine Beschreibung'}</p>
              </div>
              <div class="task-popup-section">
                <label class="task-popup-label">AnhÃ¤nge (${attachments?.length || 0}/3)</label>
                <div class="task-attachments-list">
                  ${attachmentsHTML}
                </div>
              </div>
            </div>
            <div class="task-popup-actions">
              <button class="task-popup-btn secondary" onclick="closeTaskViewPopup()">SchlieÃŸen</button>
              <button class="task-popup-btn primary" onclick="closeTaskViewPopup(); openTaskEditPopup('${taskId}');">Bearbeiten</button>
            </div>
          </div>
        `;

        document.body.appendChild(popup);

        // SchlieÃŸen bei Klick auf Overlay
        popup.addEventListener('click', (e) => {
          if (e.target === popup) closeTaskViewPopup();
        });

        // SchlieÃŸen bei Escape
        document.addEventListener('keydown', handleTaskViewEscape);
      }

      function handleTaskViewEscape(e) {
        if (e.key === 'Escape') {
          closeTaskViewPopup();
        }
      }

      function closeTaskViewPopup() {
        const popup = document.getElementById('taskViewPopup');
        if (popup) popup.remove();
        document.removeEventListener('keydown', handleTaskViewEscape);
      }

      // Expose to window
      window.openTaskViewPopup = openTaskViewPopup;
      window.closeTaskViewPopup = closeTaskViewPopup;

      // ============================================
      // TASK EDIT POPUP (Mit Datei-Upload)
      // ============================================

      let currentEditTaskId = null;
      let pendingAttachments = []; // Neue Dateien zum Hochladen
      let attachmentsToDelete = []; // Bestehende Dateien zum LÃ¶schen

      async function openTaskEditPopup(taskId) {
        currentEditTaskId = taskId;
        pendingAttachments = [];
        attachmentsToDelete = [];

        // SchlieÃŸe andere Popups/MenÃ¼s
        closeTaskViewPopup();
        document.querySelectorAll('.task-menu-dropdown.active').forEach(m => m.classList.remove('active'));

        // Lade Task-Daten
        const { data: task, error: taskError } = await supabase
          .from('project_tasks')
          .select('*')
          .eq('id', taskId)
          .single();

        if (taskError || !task) {
          console.error('Error loading task:', taskError);
          alert('Fehler beim Laden der Task');
          return;
        }

        // Lade bestehende Attachments
        const { data: attachments, error: attachError } = await supabase
          .from('task_attachments')
          .select('*')
          .eq('task_id', taskId)
          .order('created_at', { ascending: true });

        // Entferne existierendes Popup
        const existingPopup = document.getElementById('taskEditPopup');
        if (existingPopup) existingPopup.remove();

        // Erstelle Popup
        const popup = document.createElement('div');
        popup.id = 'taskEditPopup';
        popup.className = 'task-popup-overlay';

        const currentAttachmentCount = attachments?.length || 0;

        popup.innerHTML = `
          <div class="task-popup">
            <div class="task-popup-header">
              <h3 class="task-popup-title">Task bearbeiten</h3>
              <button class="task-popup-close" onclick="closeTaskEditPopup()">âœ•</button>
            </div>
            <div class="task-popup-body">
              <div class="task-popup-section">
                <label class="task-popup-label">Name</label>
                <input type="text" class="task-popup-input" id="editTaskTitle" value="${task.title || ''}" placeholder="Task Name...">
              </div>
              <div class="task-popup-section">
                <label class="task-popup-label">Beschreibung</label>
                <textarea class="task-popup-textarea" id="editTaskDescription" placeholder="Beschreibung hinzufÃ¼gen...">${task.description || ''}</textarea>
              </div>
              <div class="task-popup-section">
                <label class="task-popup-label">AnhÃ¤nge (<span id="attachmentCount">${currentAttachmentCount}</span>/3)</label>
                <div class="task-attachments-list" id="editAttachmentsList">
                  ${renderEditAttachments(attachments || [])}
                </div>
                <div class="task-file-upload ${currentAttachmentCount >= 3 ? 'disabled' : ''}" id="taskFileUpload" onclick="document.getElementById('taskFileInput').click()">
                  <input type="file" id="taskFileInput" accept="image/jpeg,image/png,image/gif,image/webp,application/pdf" multiple onchange="handleTaskFileSelect(event)">
                  <div class="task-file-upload-icon">ðŸ“Ž</div>
                  <div class="task-file-upload-text"><strong>Klicken</strong> oder Datei hierher ziehen</div>
                  <div class="task-file-upload-hint">Bilder & PDFs, max. 8MB pro Datei</div>
                </div>
              </div>
            </div>
            <div class="task-popup-actions">
              <button class="task-popup-btn secondary" onclick="closeTaskEditPopup()">Abbrechen</button>
              <button class="task-popup-btn primary" onclick="saveTaskEdit()" id="saveTaskBtn">Speichern</button>
            </div>
          </div>
        `;

        document.body.appendChild(popup);

        // Setup Drag & Drop
        const uploadArea = document.getElementById('taskFileUpload');
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
          uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
          handleTaskFileSelect({ target: { files: e.dataTransfer.files } });
        });

        // Focus auf Title
        setTimeout(() => document.getElementById('editTaskTitle')?.focus(), 100);

        // Escape Handler
        document.addEventListener('keydown', handleTaskEditEscape);
      }

      function handleTaskEditEscape(e) {
        if (e.key === 'Escape') closeTaskEditPopup();
      }

      function closeTaskEditPopup() {
        const popup = document.getElementById('taskEditPopup');
        if (popup) popup.remove();
        currentEditTaskId = null;
        pendingAttachments = [];
        attachmentsToDelete = [];
        document.removeEventListener('keydown', handleTaskEditEscape);
      }

      function renderEditAttachments(attachments) {
        if (!attachments || attachments.length === 0) {
          return '';
        }

        return attachments.map(att => `
          <div class="task-attachment-item" data-attachment-id="${att.id}">
            <div class="task-attachment-preview ${att.file_type === 'application/pdf' ? 'pdf' : ''}">
              ${att.file_type === 'application/pdf'
                ? 'PDF'
                : `<img src="${att.file_url}" alt="${att.file_name}">`
              }
            </div>
            <div class="task-attachment-info">
              <div class="task-attachment-name">${att.file_name}</div>
              <div class="task-attachment-size">${formatFileSize(att.file_size)}</div>
            </div>
            <div class="task-attachment-actions">
              <a href="${att.file_url}" download="${att.file_name}" class="task-attachment-btn" title="Herunterladen">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
              </a>
              <a href="${att.file_url}" target="_blank" class="task-attachment-btn" title="Ã–ffnen">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                  <polyline points="15 3 21 3 21 9"/>
                  <line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
              </a>
              <button class="task-attachment-btn delete" onclick="markAttachmentForDeletion('${att.id}')" title="LÃ¶schen">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            </div>
          </div>
        `).join('');
      }

      function handleTaskFileSelect(event) {
        const files = Array.from(event.target.files || []);
        const currentCount = document.querySelectorAll('#editAttachmentsList .task-attachment-item:not(.pending-delete)').length + pendingAttachments.length;
        const maxFiles = 3;
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
        const maxSize = 8 * 1024 * 1024; // 8MB

        for (const file of files) {
          if (currentCount + pendingAttachments.length >= maxFiles) {
            alert('Maximal 3 AnhÃ¤nge pro Task erlaubt');
            break;
          }

          if (!allowedTypes.includes(file.type)) {
            alert(`Dateityp nicht erlaubt: ${file.name}\nErlaubt: Bilder (JPG, PNG, GIF, WebP) und PDFs`);
            continue;
          }

          if (file.size > maxSize) {
            alert(`Datei zu groÃŸ: ${file.name}\nMaximal 8MB pro Datei`);
            continue;
          }

          pendingAttachments.push(file);
          addPendingAttachmentToUI(file);
        }

        updateAttachmentCount();
        event.target.value = ''; // Reset input
      }

      function addPendingAttachmentToUI(file) {
        const list = document.getElementById('editAttachmentsList');
        const item = document.createElement('div');
        item.className = 'task-attachment-item pending';
        item.dataset.fileName = file.name;

        const isPdf = file.type === 'application/pdf';
        let previewContent = 'PDF';

        if (!isPdf) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = item.querySelector('.task-attachment-preview img');
            if (img) img.src = e.target.result;
          };
          reader.readAsDataURL(file);
          previewContent = '<img src="" alt="Preview">';
        }

        item.innerHTML = `
          <div class="task-attachment-preview ${isPdf ? 'pdf' : ''}">
            ${previewContent}
          </div>
          <div class="task-attachment-info">
            <div class="task-attachment-name">${file.name}</div>
            <div class="task-attachment-size">${formatFileSize(file.size)} Â· Neu</div>
          </div>
          <div class="task-attachment-actions">
            <button class="task-attachment-btn delete" onclick="removePendingAttachment('${file.name}')" title="Entfernen">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        `;

        list.appendChild(item);
      }

      function removePendingAttachment(fileName) {
        pendingAttachments = pendingAttachments.filter(f => f.name !== fileName);
        const item = document.querySelector(`.task-attachment-item.pending[data-file-name="${fileName}"]`);
        if (item) item.remove();
        updateAttachmentCount();
      }

      function markAttachmentForDeletion(attachmentId) {
        const item = document.querySelector(`[data-attachment-id="${attachmentId}"]`);
        if (item) {
          item.classList.add('pending-delete');
          item.style.opacity = '0.4';
          item.style.textDecoration = 'line-through';
          attachmentsToDelete.push(attachmentId);
        }
        updateAttachmentCount();
      }

      function updateAttachmentCount() {
        const existingCount = document.querySelectorAll('#editAttachmentsList .task-attachment-item:not(.pending-delete):not(.pending)').length;
        const totalCount = existingCount + pendingAttachments.length;

        const countEl = document.getElementById('attachmentCount');
        if (countEl) countEl.textContent = totalCount;

        const uploadArea = document.getElementById('taskFileUpload');
        if (uploadArea) {
          if (totalCount >= 3) {
            uploadArea.classList.add('disabled');
          } else {
            uploadArea.classList.remove('disabled');
          }
        }
      }

      async function saveTaskEdit() {
        if (!currentEditTaskId) return;

        const title = document.getElementById('editTaskTitle')?.value?.trim();
        const description = document.getElementById('editTaskDescription')?.value?.trim();

        if (!title) {
          alert('Bitte einen Task-Namen eingeben');
          return;
        }

        const saveBtn = document.getElementById('saveTaskBtn');
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.textContent = 'Speichern...';
        }

        try {
          // 1. Update Task
          const { error: updateError } = await supabase
            .from('project_tasks')
            .update({ title, description })
            .eq('id', currentEditTaskId);

          if (updateError) throw updateError;

          // 2. Delete marked attachments
          for (const attachmentId of attachmentsToDelete) {
            const { data: att } = await supabase
              .from('task_attachments')
              .select('file_url')
              .eq('id', attachmentId)
              .single();

            if (att?.file_url) {
              // Extrahiere Pfad aus URL
              const urlParts = att.file_url.split('/task-attachments/');
              if (urlParts[1]) {
                await supabase.storage.from('task-attachments').remove([urlParts[1]]);
              }
            }

            await supabase.from('task_attachments').delete().eq('id', attachmentId);
          }

          // 3. Upload neue Dateien
          console.log('ðŸ“Ž Uploading to bucket: task-attachments');
          console.log('ðŸ“Ž Files to upload:', pendingAttachments.length);

          const { data: { user } } = await supabase.auth.getUser();

          for (const file of pendingAttachments) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${currentEditTaskId}/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
            console.log('ðŸ“Ž Uploading file:', file.name, 'as:', fileName);

            const { data: uploadData, error: uploadError } = await supabase.storage
              .from('task-attachments')
              .upload(fileName, file);

            console.log('ðŸ“Ž Upload result:', { uploadData, uploadError });

            if (uploadError) {
              console.error('ðŸ“Ž Upload error details:', uploadError);
              alert(`Fehler beim Hochladen von ${file.name}: ${uploadError.message}`);
              continue;
            }

            const { data: urlData } = supabase.storage
              .from('task-attachments')
              .getPublicUrl(fileName);

            console.log('ðŸ“Ž Public URL data:', urlData);
            const publicUrl = urlData.publicUrl;

            await supabase.from('task_attachments').insert({
              task_id: currentEditTaskId,
              file_url: publicUrl,
              file_name: file.name,
              file_size: file.size,
              file_type: file.type,
              uploaded_by: user?.id
            });
            console.log('ðŸ“Ž Attachment saved to database');
          }

          console.log('âœ… Task updated successfully');
          closeTaskEditPopup();

          // Refresh Tasks
          if (window.selectedProjectId && typeof loadProjectTasks === 'function') {
            await loadProjectTasks(window.selectedProjectId);
          } else if (typeof loadTodoProjects === 'function') {
            await loadTodoProjects();
          }

          // Update local state and refresh
          if (selectedTodoProject) {
            const taskIdx = selectedTodoProject.tasks?.findIndex(t => t.id === currentEditTaskId);
            if (taskIdx !== -1) {
              selectedTodoProject.tasks[taskIdx].title = title;
              selectedTodoProject.tasks[taskIdx].description = description;
            }
          }
          renderTodoTasks();

        } catch (err) {
          console.error('âŒ Error saving task:', err);
          alert('Fehler beim Speichern');
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Speichern';
          }
        }
      }

      // Hilfsfunktion: DateigrÃ¶ÃŸe formatieren
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }

      // Expose to window
      window.openTaskEditPopup = openTaskEditPopup;
      window.closeTaskEditPopup = closeTaskEditPopup;
      window.handleTaskFileSelect = handleTaskFileSelect;
      window.removePendingAttachment = removePendingAttachment;
      window.markAttachmentForDeletion = markAttachmentForDeletion;
      window.saveTaskEdit = saveTaskEdit;
      window.formatFileSize = formatFileSize;

      async function deleteTask(taskId) {
        // SchlieÃŸe das MenÃ¼
        document.querySelectorAll('.task-menu-dropdown.active').forEach(menu => {
          menu.classList.remove('active');
        });

        if (!confirm('Task wirklich lÃ¶schen?')) return;

        try {
          const { error } = await supabase
            .from('project_tasks')
            .delete()
            .eq('id', taskId);

          if (error) throw error;

          console.log('âœ… Task deleted:', taskId);

          // Update local state and refresh
          if (selectedTodoProject) {
            selectedTodoProject.tasks = selectedTodoProject.tasks?.filter(t => t.id !== taskId) || [];
            // Recalculate progress
            const tasks = selectedTodoProject.tasks;
            const completed = tasks.filter(t => t.is_completed).length;
            selectedTodoProject.progress = tasks.length > 0 ? Math.round((completed / tasks.length) * 100) : 0;
            selectedTodoProject.completed = completed;

            // Update in todoProjects array
            const projectIdx = todoProjects.findIndex(p => p.id === selectedTodoProject.id);
            if (projectIdx !== -1) {
              todoProjects[projectIdx] = selectedTodoProject;
            }
          }
          renderTodoProjects();
          renderTodoTasks();
        } catch (err) {
          console.error('âŒ Error deleting task:', err);
          alert('Fehler beim LÃ¶schen der Task');
        }
      }

      // SchlieÃŸe Task-MenÃ¼s bei Klick auÃŸerhalb
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.task-menu-container')) {
          document.querySelectorAll('.task-menu-dropdown.active').forEach(menu => {
            menu.classList.remove('active');
          });
        }
      });

      // Expose to window
      window.toggleTaskMenu = toggleTaskMenu;
      window.deleteTask = deleteTask;

      // Open Edit Modal
      window.openTodoEditModal = function(projectId) {
        const project = todoProjects.find(p => p.id === projectId);
        if (!project) return;

        document.getElementById('todoEditTitle').value = project.title || '';
        document.getElementById('todoEditDescription').value = project.description || '';
        document.getElementById('todoEditDeadline').value = project.deadline ? project.deadline.split('T')[0] : '';
        document.getElementById('todoEditModalTitle').textContent = 'Projekt bearbeiten';
        document.getElementById('todoEditModal').dataset.projectId = projectId;
        document.getElementById('todoEditModal').dataset.mode = 'edit';

        // Load collaborators
        todoCollaborators = (project.project_collaborators || []).map(c => ({
          id: c.user_id,
          username: c.profiles?.username || 'Unknown'
        }));
        renderTodoCollabList();

        document.getElementById('todoEditModal').classList.add('active');
      };

      // Open Add Project Modal
      function openTodoAddModal() {
        document.getElementById('todoEditTitle').value = '';
        document.getElementById('todoEditDescription').value = '';
        document.getElementById('todoEditDeadline').value = '';
        document.getElementById('todoEditModalTitle').textContent = 'Neues Projekt';
        document.getElementById('todoEditModal').dataset.projectId = '';
        document.getElementById('todoEditModal').dataset.mode = 'add';
        todoCollaborators = [];
        renderTodoCollabList();
        document.getElementById('todoEditModal').classList.add('active');
      }

      // Render Collaborators List
      function renderTodoCollabList() {
        const container = document.getElementById('todoCollabList');
        if (!container) return;

        if (todoCollaborators.length === 0) {
          container.innerHTML = '<span style="color: #9ca3af; font-size: 13px;">Keine Collaborators</span>';
          return;
        }

        container.innerHTML = todoCollaborators.map(c => `
          <div class="todo-collab-tag">
            <span>${c.username}</span>
            <span class="todo-collab-remove" onclick="removeTodoCollab('${c.id}')">&times;</span>
          </div>
        `).join('');
      }

      // Remove Collaborator
      window.removeTodoCollab = function(userId) {
        todoCollaborators = todoCollaborators.filter(c => c.id !== userId);
        renderTodoCollabList();
      };

      // Search Collaborators
      let todoCollabTimeout;
      document.getElementById('todoCollabSearch')?.addEventListener('input', (e) => {
        clearTimeout(todoCollabTimeout);
        const term = e.target.value.trim();
        if (term.length < 2) {
          document.getElementById('todoCollabResults').classList.remove('active');
          return;
        }
        todoCollabTimeout = setTimeout(() => searchTodoCollabs(term), 300);
      });

      async function searchTodoCollabs(term) {
        try {
          const userId = await getTodoUserId();
          const { data, error } = await supabase
            .from('profiles')
            .select('id, username, email')
            .or(`username.ilike.%${term}%,email.ilike.%${term}%`)
            .neq('id', userId)
            .limit(5);

          if (error) throw error;

          const resultsEl = document.getElementById('todoCollabResults');
          if (!data || data.length === 0) {
            resultsEl.innerHTML = '<div class="todo-collab-item" style="color: #9ca3af;">Keine Ergebnisse</div>';
          } else {
            resultsEl.innerHTML = data.map(u => `
              <div class="todo-collab-item" onclick="addTodoCollab('${u.id}', '${u.username}')">${u.username} <span style="color: #9ca3af; font-size: 12px;">${u.email}</span></div>
            `).join('');
          }
          resultsEl.classList.add('active');
        } catch (err) {
          console.error('Error searching users:', err);
        }
      }

      // Add Collaborator
      window.addTodoCollab = function(userId, username) {
        if (!todoCollaborators.find(c => c.id === userId)) {
          todoCollaborators.push({ id: userId, username });
          renderTodoCollabList();
        }
        document.getElementById('todoCollabSearch').value = '';
        document.getElementById('todoCollabResults').classList.remove('active');
      };

      // Save Project (Create or Update)
      async function saveTodoProject() {
        const modal = document.getElementById('todoEditModal');
        const mode = modal.dataset.mode;
        const projectId = modal.dataset.projectId;
        const title = document.getElementById('todoEditTitle').value.trim();
        const description = document.getElementById('todoEditDescription').value.trim();
        const deadline = document.getElementById('todoEditDeadline').value || null;

        if (!title) {
          alert('Bitte Projekttitel eingeben');
          return;
        }

        try {
          const userId = await getTodoUserId();
          if (!userId) {
            alert('Nicht eingeloggt');
            return;
          }

          if (mode === 'add') {
            console.log('=== CREATE PROJECT DEBUG ===');
            console.log('User ID:', userId);
            console.log('Title:', title);

            // Create new project
            const { data: project, error } = await supabase
              .from('task_projects')
              .insert({ title, description, deadline, created_by: userId, is_team_project: todoCollaborators.length > 0 })
              .select()
              .single();

            if (error) {
              console.error('âŒ Failed to create project:', error);
              throw error;
            }

            console.log('âœ… Project created:', project.id);

            // CRITICAL: Add owner as collaborator with error handling
            console.log('ðŸ“ Adding owner as collaborator...');
            const { data: ownerCollab, error: ownerError } = await supabase
              .from('project_collaborators')
              .insert({ project_id: project.id, user_id: userId, role: 'owner' })
              .select();

            if (ownerError) {
              console.error('âŒ CRITICAL: Failed to add owner as collaborator:', ownerError);
              // Alert user about the issue
              alert('Warnung: Owner konnte nicht als Collaborator hinzugefÃ¼gt werden. Bitte versuche es erneut.');
            } else {
              console.log('âœ… Owner added as collaborator:', ownerCollab);
            }

            // Verify owner was added
            const { data: verifyOwner } = await supabase
              .from('project_collaborators')
              .select('*')
              .eq('project_id', project.id)
              .eq('user_id', userId);
            console.log('Verification - Owner in project_collaborators:', verifyOwner);

            // Add other collaborators
            if (todoCollaborators.length > 0) {
              const collabs = todoCollaborators.map(c => ({ project_id: project.id, user_id: c.id, role: 'member' }));
              const { error: membersError } = await supabase.from('project_collaborators').insert(collabs);
              if (membersError) {
                console.error('âš ï¸ Failed to add some collaborators:', membersError);
              }
            }

            console.log('=== END CREATE PROJECT ===');
          } else {
            // Update project
            const { error } = await supabase
              .from('task_projects')
              .update({ title, description, deadline, is_team_project: todoCollaborators.length > 0 })
              .eq('id', projectId);

            if (error) throw error;

            // Update collaborators: delete all except owner, then re-add
            const { data: existingCollabs } = await supabase.from('project_collaborators').select('*').eq('project_id', projectId);
            const ownerCollab = existingCollabs?.find(c => c.role === 'owner');

            await supabase.from('project_collaborators').delete().eq('project_id', projectId).neq('role', 'owner');

            const newCollabs = todoCollaborators
              .filter(c => c.id !== ownerCollab?.user_id)
              .map(c => ({ project_id: projectId, user_id: c.id, role: 'member' }));

            if (newCollabs.length > 0) {
              await supabase.from('project_collaborators').insert(newCollabs);
            }
          }

          modal.classList.remove('active');
          await loadTodoProjects();

          if (mode === 'edit' && selectedTodoProject?.id === projectId) {
            selectedTodoProject = todoProjects.find(p => p.id === projectId);
            renderTodoTasks();
          }
        } catch (err) {
          console.error('Error saving project:', err);
          alert('Fehler beim Speichern: ' + err.message);
        }
      }

      // Delete Project
      async function deleteTodoProject() {
        const modal = document.getElementById('todoEditModal');
        const projectId = modal.dataset.projectId;
        if (!projectId || !confirm('Projekt wirklich lÃ¶schen? Alle Tasks werden auch gelÃ¶scht.')) return;

        try {
          await supabase.from('project_tasks').delete().eq('project_id', projectId);
          await supabase.from('project_collaborators').delete().eq('project_id', projectId);
          await supabase.from('task_projects').delete().eq('id', projectId);

          modal.classList.remove('active');
          if (selectedTodoProject?.id === projectId) {
            selectedTodoProject = null;
          }
          await loadTodoProjects();
          renderTodoTasks();
        } catch (err) {
          console.error('Error deleting project:', err);
          alert('Fehler beim LÃ¶schen');
        }
      }

      // Open Add Task Modal
      function openTodoTaskModal() {
        if (!selectedTodoProject) {
          console.warn('âš ï¸ No project selected');
          return;
        }

        console.log('ðŸ“ Opening Add Task Modal');
        console.log('ðŸ“ Selected Project:', selectedTodoProject.id, selectedTodoProject.title);
        console.log('ðŸ‘¥ Project Collaborators:', selectedTodoProject.project_collaborators);

        document.getElementById('todoTaskTitle').value = '';
        document.getElementById('todoTaskAssignee').value = '';

        // Populate assignee dropdown
        const assigneeSelect = document.getElementById('todoTaskAssignee');
        const collabs = selectedTodoProject.project_collaborators || [];

        console.log('ðŸ‘¥ Collaborators count:', collabs.length);

        if (collabs.length > 0) {
          document.getElementById('todoTaskAssigneeGroup').style.display = 'block';
          const options = collabs.map(c => {
            console.log('  - Collaborator:', c.user_id, c.profiles?.username, c.role);
            return `<option value="${c.user_id}">${c.profiles?.username || 'Unknown'} (${c.role})</option>`;
          });
          assigneeSelect.innerHTML = '<option value="">Niemand</option>' + options.join('');
        } else {
          console.log('âš ï¸ No collaborators found - hiding dropdown');
          document.getElementById('todoTaskAssigneeGroup').style.display = 'none';
        }

        document.getElementById('todoTaskModal').classList.add('active');
      }

      // Save Task
      async function saveTodoTask() {
        const title = document.getElementById('todoTaskTitle').value.trim();
        const assignedTo = document.getElementById('todoTaskAssignee').value || null;

        if (!title || !selectedTodoProject) {
          alert('Bitte Task-Titel eingeben');
          return;
        }

        const projectId = selectedTodoProject.id;

        console.log('=== TASK INSERT DEBUG ===');
        console.log('Project ID:', projectId);

        // Check Supabase Auth session
        const { data: { session } } = await supabase.auth.getSession();
        console.log('ðŸ” Auth Session:', session ? 'EXISTS' : 'NULL');
        console.log('ðŸ”‘ auth.uid():', session?.user?.id || 'NULL');
        console.log('ðŸŽ« Access Token:', session?.access_token ? 'EXISTS' : 'NULL');

        if (!session) {
          console.error('âŒ NO AUTH SESSION! RLS policies will fail!');
          console.error('ðŸ“ User needs to re-login to create a Supabase Auth session');
        }

        try {
          // Get current user ID
          const currentUserId = await getTodoUserId();
          console.log('Current User ID (from profile):', currentUserId);

          // Check if user is collaborator (DATABASE CHECK)
          const { data: collabCheck, error: collabCheckError } = await supabase
            .from('project_collaborators')
            .select('*')
            .eq('project_id', projectId)
            .eq('user_id', currentUserId);

          console.log('User is collaborator (DB check):', collabCheck);
          if (collabCheckError) console.error('Collab check error:', collabCheckError);

          // Check if user is creator (DATABASE CHECK)
          const { data: projectCheck, error: projectCheckError } = await supabase
            .from('task_projects')
            .select('created_by')
            .eq('id', projectId)
            .single();

          console.log('Project created_by:', projectCheck?.created_by);
          console.log('User is creator:', projectCheck?.created_by === currentUserId);
          if (projectCheckError) console.error('Project check error:', projectCheckError);

          // If user is neither collaborator nor creator, add as collaborator
          const isCollaborator = collabCheck && collabCheck.length > 0;
          const isCreator = projectCheck?.created_by === currentUserId;

          console.log('Summary:');
          console.log('  - Is Collaborator:', isCollaborator);
          console.log('  - Is Creator:', isCreator);

          if (!isCollaborator) {
            console.warn('âš ï¸ User is NOT a collaborator! Adding now...');

            const { data: insertedCollab, error: collabError } = await supabase
              .from('project_collaborators')
              .insert({
                project_id: projectId,
                user_id: currentUserId,
                role: isCreator ? 'owner' : 'member'
              })
              .select();

            if (collabError) {
              console.error('âŒ Failed to add user as collaborator:', collabError);
              // Try upsert as fallback
              console.log('ðŸ”„ Trying upsert as fallback...');
              const { error: upsertError } = await supabase
                .from('project_collaborators')
                .upsert({
                  project_id: projectId,
                  user_id: currentUserId,
                  role: isCreator ? 'owner' : 'member'
                }, { onConflict: 'project_id,user_id' });

              if (upsertError) {
                console.error('âŒ Upsert also failed:', upsertError);
              } else {
                console.log('âœ… User added via upsert');
              }
            } else {
              console.log('âœ… User added as collaborator:', insertedCollab);
            }

            // Verify the collaborator was added
            const { data: verifyCollab } = await supabase
              .from('project_collaborators')
              .select('*')
              .eq('project_id', projectId)
              .eq('user_id', currentUserId);
            console.log('Verification - User now collaborator:', verifyCollab);
          }

          // Get max order_index
          const maxOrder = selectedTodoProject.tasks.reduce((max, t) => Math.max(max, t.order_index || 0), -1);

          const taskData = {
            project_id: selectedTodoProject.id,
            title,
            assigned_to: assignedTo,
            order_index: maxOrder + 1,
            is_completed: false
          };

          console.log('ðŸ“¦ Task data:', taskData);

          const { data: task, error } = await supabase
            .from('project_tasks')
            .insert(taskData)
            .select()
            .single();

          if (error) {
            console.error('âŒ Supabase error:', error);
            throw error;
          }

          console.log('âœ… Task created successfully:', task);

          // Update local state
          const projectIdx = todoProjects.findIndex(p => p.id === selectedTodoProject.id);
          if (projectIdx !== -1) {
            todoProjects[projectIdx].tasks.push(task);
            todoProjects[projectIdx].total++;
            const tasks = todoProjects[projectIdx].tasks;
            const completed = tasks.filter(t => t.is_completed).length;
            todoProjects[projectIdx].progress = tasks.length > 0 ? Math.round((completed / tasks.length) * 100) : 0;
          }

          selectedTodoProject = todoProjects.find(p => p.id === selectedTodoProject.id);

          document.getElementById('todoTaskModal').classList.remove('active');
          renderTodoProjects();
          renderTodoTasks();
        } catch (err) {
          console.error('âŒ Error creating task:', err);
          console.error('Error details:', JSON.stringify(err, null, 2));
          alert('Fehler beim Erstellen des Tasks: ' + (err.message || err));
        }
      }

      // Event Listeners
      document.getElementById('todoAddProjectBtn')?.addEventListener('click', openTodoAddModal);
      document.getElementById('todoEditCloseBtn')?.addEventListener('click', () => document.getElementById('todoEditModal').classList.remove('active'));
      document.getElementById('todoEditCancelBtn')?.addEventListener('click', () => document.getElementById('todoEditModal').classList.remove('active'));
      document.getElementById('todoEditSaveBtn')?.addEventListener('click', saveTodoProject);
      document.getElementById('todoDeleteBtn')?.addEventListener('click', deleteTodoProject);
      document.getElementById('todoAddTaskBtn')?.addEventListener('click', openTodoTaskModal);
      document.getElementById('todoTaskCloseBtn')?.addEventListener('click', () => document.getElementById('todoTaskModal').classList.remove('active'));
      document.getElementById('todoTaskCancelBtn')?.addEventListener('click', () => document.getElementById('todoTaskModal').classList.remove('active'));
      document.getElementById('todoTaskSaveBtn')?.addEventListener('click', saveTodoTask);

      // Close modals on backdrop click
      document.getElementById('todoEditModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'todoEditModal') e.target.classList.remove('active');
      });
      document.getElementById('todoTaskModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'todoTaskModal') e.target.classList.remove('active');
      });

      // NOTE: Projects are loaded AFTER login/session restore in:
      // - initAuth() after session restore
      // - updateUIForUser() after login
      // DO NOT load here - currentUser is not set yet!
      console.log('ðŸ“‹ To-Do system initialized. Projects will load after authentication.');

      // ============================================
      // PROJECT INVITATIONS INBOX
      // ============================================

      let currentInvitations = [];

      // Load Pending Invitations
      async function loadPendingInvitations() {
        try {
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) return;

          const { data, error } = await supabase
            .from('project_members')
            .select(`
              id,
              project_id,
              invited_at,
              task_projects (
                id,
                title,
                description,
                created_by
              )
            `)
            .eq('user_id', user.id)
            .eq('status', 'pending');

          if (error) throw error;

          // Get creator info for each invitation
          const invitationsWithCreators = await Promise.all(
            (data || []).map(async (invitation) => {
              const { data: creatorProfile } = await supabase
                .from('profiles')
                .select('username')
                .eq('id', invitation.task_projects.created_by)
                .single();

              return {
                ...invitation,
                creator_username: creatorProfile?.username || 'Unbekannt'
              };
            })
          );

          currentInvitations = invitationsWithCreators;
          renderInvitationsInInbox();
          updateNotificationBadge();

          console.log('âœ… Invitations loaded:', currentInvitations.length);
        } catch (err) {
          console.error('âŒ Error loading invitations:', err);
        }
      }

      // Render Invitations in Inbox
      function renderInvitationsInInbox() {
        const container = document.querySelector('.notifications-content');
        if (!container) return;

        if (currentInvitations.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="empty-icon">
                <rect x="3" y="6" width="18" height="13" rx="2" stroke="currentColor" stroke-width="1.5"/>
                <path d="M3 9L12 14L21 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <p class="empty-text">Keine neuen Benachrichtigungen</p>
            </div>`;
          return;
        }

        container.innerHTML = currentInvitations.map(invitation => `
          <div class="invitation-card" style="margin: 8px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
            <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px; color: var(--text-primary);">
              Projekt-Einladung: ${invitation.task_projects.title}
            </div>
            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
              Von: ${invitation.creator_username}
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
              <button class="invitation-btn invitation-btn-decline" onclick="declineInvitation('${invitation.id}')" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 13px;">
                Ablehnen
              </button>
              <button class="invitation-btn invitation-btn-accept" onclick="acceptInvitation('${invitation.id}')" style="padding: 6px 12px; border-radius: 6px; border: none; background: var(--primary-color); color: white; cursor: pointer; font-size: 13px;">
                âœ“ Annehmen
              </button>
            </div>
          </div>
        `).join('');
      }

      // Update Notification Badge (for main notification button)
      function updateNotificationBadge() {
        // Add badge to notification button if it doesn't exist
        let badge = document.querySelector('#notificationButton .notification-badge');
        if (!badge && currentInvitations.length > 0) {
          badge = document.createElement('span');
          badge.className = 'notification-badge';
          badge.style.cssText = 'position: absolute; top: 8px; right: 8px; background: var(--primary-color); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600;';
          document.getElementById('notificationButton').appendChild(badge);
        }

        if (badge) {
          if (currentInvitations.length > 0) {
            badge.textContent = currentInvitations.length;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }
      }

      // Keep old badge function for backwards compatibility
      function updateInvitationsBadge() {
        const badge = document.getElementById('invitationsBadge');
        if (badge) {
          if (currentInvitations.length > 0) {
            badge.textContent = currentInvitations.length;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }
      }

      // Accept Invitation
      async function acceptInvitation(memberId) {
        try {
          const { error } = await supabase
            .from('project_members')
            .update({
              status: 'accepted',
              accepted_at: new Date().toISOString()
            })
            .eq('id', memberId);

          if (error) throw error;

          console.log('âœ… Invitation accepted');
          await loadPendingInvitations();
          await loadTodoProjects();
        } catch (err) {
          console.error('âŒ Error accepting invitation:', err);
          alert('Fehler beim Annehmen der Einladung');
        }
      }

      // Decline Invitation
      async function declineInvitation(memberId) {
        try {
          const { error } = await supabase
            .from('project_members')
            .delete()
            .eq('id', memberId);

          if (error) throw error;

          console.log('âœ… Invitation declined');
          await loadPendingInvitations();
        } catch (err) {
          console.error('âŒ Error declining invitation:', err);
          alert('Fehler beim Ablehnen der Einladung');
        }
      }

      // Toggle Invitations Dropdown
      document.getElementById('projectInvitationsButton')?.addEventListener('click', (e) => {
        e.stopPropagation();
        const dropdown = document.getElementById('invitationsDropdown');
        const profileDropdown = document.getElementById('profileDropdown');

        // Close profile dropdown if open
        profileDropdown.style.display = 'none';

        // Toggle invitations dropdown
        if (dropdown.style.display === 'block') {
          dropdown.style.display = 'none';
        } else {
          dropdown.style.display = 'block';
          loadPendingInvitations();
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('invitationsDropdown');
        const button = document.getElementById('projectInvitationsButton');

        if (dropdown && !dropdown.contains(e.target) && !button.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });

      // Load invitations on page load
      loadPendingInvitations();

      // ============================================
      // REALTIME UPDATES FOR TODO PROJECTS
      // ============================================

      // Subscribe to tasks changes
      const tasksChannel = supabase
        .channel('tasks-changes')
        .on(
          'postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'tasks'
          },
          (payload) => {
            console.log('ðŸ“¡ Task changed:', payload);
            loadTodoProjects();
          }
        )
        .subscribe();

      // Subscribe to projects changes
      const projectsChannel = supabase
        .channel('projects-changes')
        .on(
          'postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'task_projects'
          },
          (payload) => {
            console.log('ðŸ“¡ Project changed:', payload);
            loadTodoProjects();
          }
        )
        .subscribe();

      // Subscribe to project_members changes
      const membersChannel = supabase
        .channel('members-changes')
        .on(
          'postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'project_members'
          },
          (payload) => {
            console.log('ðŸ“¡ Project member changed:', payload);
            loadTodoProjects();
            loadPendingInvitations();
          }
        )
        .subscribe();

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        supabase.removeChannel(tasksChannel);
        supabase.removeChannel(projectsChannel);
        supabase.removeChannel(membersChannel);
      });

      // ============================================
      // UPDATE REQUEST STATUS BREAKDOWN CHART (PIE)
      // ============================================
      function updateRequestStatusBreakdown(counts, total) {
        console.log('ðŸ“Š Updating request status breakdown');

        const container = document.getElementById('requestStatusChart');

        if (!container) {
          console.warn('âš ï¸ Request status chart container not found');
          return;
        }

        // Prepare data for pie chart
        const statusData = [
          { key: 'archived', label: 'Archived', color: '#8E8E93', count: counts.archived || 0 },
          { key: 'finished', label: 'Finished', color: '#34C759', count: counts.finished || 0 },
          { key: 'open_request', label: 'Open Request', color: '#FFA500', count: counts.open_request || 0 },
          { key: 'scheduled', label: 'Scheduled', color: '#007AFF', count: counts.scheduled || 0 },
          { key: 'canceled', label: 'Canceled', color: '#FF3B30', count: counts.canceled || 0 },
          { key: 'pending', label: 'Pending', color: '#FFCC00', count: counts.pending || 0 }
        ];

        // Filter and sort
        const filteredData = statusData.filter(s => s.count > 0).sort((a, b) => b.count - a.count);

        // Generate legend
        const legendItems = filteredData.map(s => {
          const percentage = ((s.count / total) * 100).toFixed(1);
          return `
            <div style="display: flex; align-items: center; gap: 10px; font-size: 13px; padding: 4px 0;">
              <span style="width: 12px; height: 12px; background: ${s.color}; border-radius: 50%; flex-shrink: 0;"></span>
              <span style="flex: 1;">${s.label}: <strong>${s.count.toLocaleString('de-DE')}</strong> (${percentage}%)</span>
            </div>
          `;
        }).join('');

        container.innerHTML = `
          <div style="margin-bottom: 16px;">
            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #1d1d1f;">
              Request Status Breakdown
            </h3>
            <p style="margin: 0; font-size: 14px; color: #86868b;">
              ${total.toLocaleString('de-DE')} Total Requests
            </p>
          </div>

          <div style="position: relative; width: 300px; max-width: 300px; height: 300px; margin: 0 auto 20px;">
            <canvas id="requestStatusPieCanvas" width="300" height="300" style="display: block; box-sizing: border-box;"></canvas>
          </div>

          <div style="display: flex; flex-direction: column; gap: 4px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.1);">
            ${legendItems}
          </div>
        `;

        // Create pie chart after DOM is ready
        requestAnimationFrame(() => {
          const canvas = document.getElementById('requestStatusPieCanvas');
          if (!canvas) {
            console.error('âŒ Request status pie canvas not found after render');
            return;
          }

          console.log('âœ… Creating request status pie chart with', filteredData.length, 'segments');

          if (requestStatusChartInstance) {
            requestStatusChartInstance.destroy();
          }

          try {
            requestStatusChartInstance = new Chart(canvas, {
              type: 'pie',
              data: {
                labels: filteredData.map(s => s.label),
                datasets: [{
                  data: filteredData.map(s => s.count),
                  backgroundColor: filteredData.map(s => s.color),
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${label}: ${value.toLocaleString('de-DE')} (${percentage}%)`;
                      }
                    }
                  }
                }
              }
            });
            console.log('âœ… Request status pie chart created successfully');
          } catch (error) {
            console.error('âŒ Error creating request status pie chart:', error);
          }
        });
      }

      // ============================================
      // UPDATE APPOINTMENT STATUS BREAKDOWN (PIE)
      // ============================================
      function updateAppointmentStatusBreakdown(counts, total) {
        console.log('ðŸ“Š Updating appointment status breakdown');

        const container = document.getElementById('appointmentStatusChart');

        if (!container) {
          console.warn('âš ï¸ Appointment status chart container not found');
          return;
        }

        // Prepare data for pie chart
        const statusData = [
          { key: 'finished', label: 'Finished', color: '#34C759', count: counts.finished || 0 },
          { key: 'scheduled', label: 'Scheduled', color: '#007AFF', count: counts.scheduled || 0 },
          { key: 'no_show', label: 'No Show', color: '#FF3B30', count: counts.no_show || 0 },
          { key: 'rescheduled', label: 'Rescheduled', color: '#FF9500', count: counts.rescheduled || 0 },
          { key: 'canceled', label: 'Canceled', color: '#FF2D55', count: counts.canceled || 0 },
          { key: 'reserved', label: 'Reserved', color: '#5856D6', count: counts.reserved || 0 },
          { key: 'unknown', label: 'Unknown', color: '#8E8E93', count: counts.unknown || 0 }
        ];

        // Filter and sort
        const filteredData = statusData.filter(s => s.count > 0).sort((a, b) => b.count - a.count);

        // Generate legend
        const legendItems = filteredData.map(s => {
          const percentage = ((s.count / total) * 100).toFixed(1);
          return `
            <div style="display: flex; align-items: center; gap: 10px; font-size: 13px; padding: 4px 0;">
              <span style="width: 12px; height: 12px; background: ${s.color}; border-radius: 50%; flex-shrink: 0;"></span>
              <span style="flex: 1;">${s.label}: <strong>${s.count.toLocaleString('de-DE')}</strong> (${percentage}%)</span>
            </div>
          `;
        }).join('');

        container.innerHTML = `
          <div style="margin-bottom: 16px;">
            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #1d1d1f;">
              Appointment Status Breakdown
            </h3>
            <p style="margin: 0; font-size: 14px; color: #86868b;">
              ${total.toLocaleString('de-DE')} Total Appointments
            </p>
          </div>

          <div style="position: relative; width: 300px; max-width: 300px; height: 300px; margin: 0 auto 20px;">
            <canvas id="appointmentStatusPieCanvas" width="300" height="300" style="display: block; box-sizing: border-box;"></canvas>
          </div>

          <div style="display: flex; flex-direction: column; gap: 4px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.1);">
            ${legendItems}
          </div>
        `;

        // Create pie chart after DOM is ready
        requestAnimationFrame(() => {
          const canvas = document.getElementById('appointmentStatusPieCanvas');
          if (!canvas) {
            console.error('âŒ Appointment status pie canvas not found after render');
            return;
          }

          console.log('âœ… Creating appointment status pie chart with', filteredData.length, 'segments');

          if (appointmentStatusChartInstance) {
            appointmentStatusChartInstance.destroy();
          }

          try {
            appointmentStatusChartInstance = new Chart(canvas, {
              type: 'pie',
              data: {
                labels: filteredData.map(s => s.label),
                datasets: [{
                  data: filteredData.map(s => s.count),
                  backgroundColor: filteredData.map(s => s.color),
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${label}: ${value.toLocaleString('de-DE')} (${percentage}%)`;
                      }
                    }
                  }
                }
              }
            });
            console.log('âœ… Appointment status pie chart created successfully');
          } catch (error) {
            console.error('âŒ Error creating appointment status pie chart:', error);
          }
        });
      }

      // ============================================
      // PROJECT OVERVIEW KPIs (Dashboard only)
      // ============================================
      async function loadProjectOverviewKPIs() {
        console.log('ðŸ“¦ Loading Project Overview KPIs for Dashboard...');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RACE-CONDITION FIX: Check if calculateProjectMetrics is available
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (typeof window.calculateProjectMetrics !== 'function') {
          console.warn('âš ï¸ calculateProjectMetrics not yet available, skipping KPIs');
          return;
        }

        try {
          const { data: appointments, error } = await supabase
            .from('appointments')
            .select(`
              id,
              project_number,
              customer_id,
              status,
              payment_amount,
              total_amount
            `)
            .not('project_number', 'is', null)
            .not('customer_id', 'is', null);

          if (error) throw error;

          // Calculate metrics
          const metrics = window.calculateProjectMetrics(appointments || []);

          // Update ONLY KPI cards on dashboard
          const kpiContainer = document.getElementById('projectKPIs');
          if (kpiContainer) {
            kpiContainer.innerHTML = `
              <div class="kpi-grid">
                <div class="kpi-card">
                  <div class="kpi-icon">ðŸ“¦</div>
                  <div class="kpi-content">
                    <div class="kpi-value">${metrics.totalProjects.toLocaleString()}</div>
                    <div class="kpi-label">Total Projects</div>
                  </div>
                </div>

                <div class="kpi-card active">
                  <div class="kpi-icon">ðŸ”„</div>
                  <div class="kpi-content">
                    <div class="kpi-value">${metrics.activeProjects.toLocaleString()}</div>
                    <div class="kpi-label">Active Projects</div>
                  </div>
                </div>

                <div class="kpi-card completed">
                  <div class="kpi-icon">âœ…</div>
                  <div class="kpi-content">
                    <div class="kpi-value">${metrics.completedProjects.toLocaleString()}</div>
                    <div class="kpi-label">Completed Projects</div>
                  </div>
                </div>

                <div class="kpi-card revenue">
                  <div class="kpi-icon">ðŸ’°</div>
                  <div class="kpi-content">
                    <div class="kpi-value">â‚¬${metrics.totalRevenue.toLocaleString('de-DE', { maximumFractionDigits: 0 })}</div>
                    <div class="kpi-label">Total Revenue</div>
                  </div>
                </div>

                <div class="kpi-card">
                  <div class="kpi-icon">ðŸ“Š</div>
                  <div class="kpi-content">
                    <div class="kpi-value">${metrics.avgAppointmentsPerProject.toFixed(1)}</div>
                    <div class="kpi-label">Avg Sessions/Project</div>
                  </div>
                </div>

                <div class="kpi-card">
                  <div class="kpi-icon">âœ¨</div>
                  <div class="kpi-content">
                    <div class="kpi-value">${metrics.completionRate.toFixed(1)}%</div>
                    <div class="kpi-label">Completion Rate</div>
                  </div>
                </div>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error loading project overview KPIs:', error);
        }
      }

      // Helper function to get project status badge
      function getProjectStatusBadge(appointments) {
        const statuses = appointments.map(a => a.status);
        const allFinished = statuses.every(s => s === 'finished');
        const hasScheduled = statuses.some(s => s === 'scheduled');
        const allCanceled = statuses.every(s => s === 'canceled');

        if (allFinished) {
          return '<span class="project-status-badge completed">âœ… Completed</span>';
        } else if (allCanceled) {
          return '<span class="project-status-badge canceled">âŒ Canceled</span>';
        } else if (hasScheduled) {
          return '<span class="project-status-badge active">ðŸ”„ Active</span>';
        } else {
          return '<span class="project-status-badge completed">âœ… Completed</span>';
        }
      }

      window.loadProjectsTimelineChart = function loadProjectsTimelineChart(appointments) {
        const chartCanvas = document.getElementById('projectsTimelineChart');
        if (!chartCanvas) return;

        // Destroy existing chart
        if (projectsTimelineChartInstance) {
          projectsTimelineChartInstance.destroy();
          projectsTimelineChartInstance = null;
        }

        // Group projects by month
        const projectsByMonth = {};
        const processedProjects = new Set();

        appointments.forEach(apt => {
          if (!apt.start || !apt.project_number) return;
          if (processedProjects.has(apt.project_number)) return;

          const date = new Date(apt.start);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

          projectsByMonth[monthKey] = (projectsByMonth[monthKey] || 0) + 1;
          processedProjects.add(apt.project_number);
        });

        // Sort by date
        const sortedMonths = Object.keys(projectsByMonth).sort();
        const counts = sortedMonths.map(m => projectsByMonth[m]);

        // Create chart
        projectsTimelineChartInstance = new Chart(chartCanvas, {
          type: 'line',
          data: {
            labels: sortedMonths.map(m => {
              const [year, month] = m.split('-');
              return new Date(year, month - 1).toLocaleDateString('de-DE', {
                month: 'short',
                year: 'numeric'
              });
            }),
            datasets: [{
              label: 'New Projects',
              data: counts,
              borderColor: '#0071e3',
              backgroundColor: 'rgba(0, 113, 227, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: 'Projects Started Over Time',
                font: {
                  size: 16,
                  weight: '600',
                  family: "'Helvetica Neue', sans-serif"
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 100
                }
              }
            }
          }
        });
      }

      window.loadRevenueByMonthChart = function loadRevenueByMonthChart(appointments) {
        const chartCanvas = document.getElementById('revenueByMonthChart');
        if (!chartCanvas) return;

        // Destroy existing chart
        if (revenueByMonthChartInstance) {
          revenueByMonthChartInstance.destroy();
          revenueByMonthChartInstance = null;
        }

        // Group revenue by month
        const revenueByMonth = {};

        appointments.forEach(apt => {
          if (!apt.start) return;

          const date = new Date(apt.start);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

          const revenue = parseFloat(apt.payment_amount || apt.total_amount || 0);
          revenueByMonth[monthKey] = (revenueByMonth[monthKey] || 0) + revenue;
        });

        // Sort by date
        const sortedMonths = Object.keys(revenueByMonth).sort();
        const revenues = sortedMonths.map(m => revenueByMonth[m]);

        // Create chart
        revenueByMonthChartInstance = new Chart(chartCanvas, {
          type: 'bar',
          data: {
            labels: sortedMonths.map(m => {
              const [year, month] = m.split('-');
              return new Date(year, month - 1).toLocaleDateString('de-DE', {
                month: 'short',
                year: 'numeric'
              });
            }),
            datasets: [{
              label: 'Revenue (â‚¬)',
              data: revenues,
              backgroundColor: '#34c759',
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: 'Revenue by Month',
                font: {
                  size: 16,
                  weight: '600',
                  family: "'Helvetica Neue', sans-serif"
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'â‚¬' + value.toLocaleString('de-DE');
                  }
                }
              }
            }
          }
        });
      }

      window.loadTopArtistsChart = function loadTopArtistsChart(appointments) {
        const chartCanvas = document.getElementById('topArtistsChart');
        if (!chartCanvas) return;

        // Destroy existing chart
        if (topArtistsChartInstance) {
          topArtistsChartInstance.destroy();
          topArtistsChartInstance = null;
        }

        // Count unique projects per artist
        const artistProjects = {};
        const processedProjects = new Set();

        appointments.forEach(apt => {
          if (!apt.artist_id || !apt.project_number) return;

          const key = `${apt.artist_id}-${apt.project_number}`;
          if (processedProjects.has(key)) return;

          artistProjects[apt.artist_id] = (artistProjects[apt.artist_id] || 0) + 1;
          processedProjects.add(key);
        });

        // Sort and get top 10
        const sorted = Object.entries(artistProjects)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        if (sorted.length === 0) {
          if (chartCanvas.getContext) {
            chartCanvas.getContext('2d').clearRect(0, 0, chartCanvas.width, chartCanvas.height);
          }
          return;
        }

        // Fetch artist names
        fetchArtistNames(sorted.map(([id]) => id)).then(artistNames => {
          const labels = sorted.map(([id]) => artistNames[id] || 'Unknown');
          const counts = sorted.map(([, count]) => count);

          topArtistsChartInstance = new Chart(chartCanvas, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Projects',
                data: counts,
                backgroundColor: '#ff9500',
                borderRadius: 6
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: 'y',
              plugins: {
                legend: {
                  display: false
                },
                title: {
                  display: true,
                  text: 'Top Artists by Projects',
                  font: {
                    size: 16,
                    weight: '600',
                    family: "'Helvetica Neue', sans-serif"
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true
                }
              }
            }
          });
        });
      }

      async function fetchArtistNames(artistIds) {
        if (!artistIds || artistIds.length === 0) return {};

        const { data: artists } = await supabase
          .from('artists')
          .select('id, name')
          .in('id', artistIds);

        const nameMap = {};
        (artists || []).forEach(artist => {
          nameMap[artist.id] = artist.name;
        });

        return nameMap;
      }

      window.loadArtistPerformanceReport = async function loadArtistPerformanceReport() {
        console.log('ðŸ“Š Loading Artist Performance Report...');

        try {
          const { data: appointments, error } = await supabase
            .from('appointments')
            .select(`
              *
            `)
            .not('project_number', 'is', null);

          if (error) {
            console.error('Error:', error);
            return;
          }

          // Fetch all artists for name mapping
          const { data: artists } = await supabase
            .from('artists')
            .select('id, name, email');

          const artistMap = {};
          (artists || []).forEach(artist => {
            artistMap[artist.id] = artist;
          });

          // Group by artist
          const artistStats = {};

          (appointments || []).forEach(apt => {
            const artistId = apt.artist_id;
            if (!artistId) return;

            // Initialize
            if (!artistStats[artistId]) {
              artistStats[artistId] = {
                artist_name: artistMap[artistId]?.name || 'Unknown',
                total_appointments: 0,
                unique_projects: new Set(),
                total_revenue: 0,
                completed_projects: new Set(),
                active_projects: new Set()
              };
            }

            const stats = artistStats[artistId];
            stats.total_appointments++;
            stats.unique_projects.add(apt.project_number);

            // Revenue
            const revenue = parseFloat(apt.payment_amount || apt.total_amount || 0);
            stats.total_revenue += revenue;

            // Project status
            if (apt.status === 'finished') {
              stats.completed_projects.add(apt.project_number);
            } else if (apt.status === 'scheduled') {
              stats.active_projects.add(apt.project_number);
            }
          });

          // Convert to array and calculate final metrics
          const artistsArray = Object.values(artistStats).map(stats => ({
            artist_name: stats.artist_name,
            total_projects: stats.unique_projects.size,
            total_appointments: stats.total_appointments,
            total_revenue: stats.total_revenue,
            completed_projects: stats.completed_projects.size,
            active_projects: stats.active_projects.size,
            avg_revenue_per_project: stats.total_revenue / (stats.unique_projects.size || 1),
            completion_rate: stats.unique_projects.size > 0 ? (stats.completed_projects.size / stats.unique_projects.size) * 100 : 0
          }));

          // Sort by total revenue
          artistsArray.sort((a, b) => b.total_revenue - a.total_revenue);

          // Render table
          renderArtistPerformanceTable(artistsArray);
        } catch (error) {
          console.error('Error loading artist performance report:', error);
        }
      }

      function renderArtistPerformanceTable(artists) {
        const container = document.getElementById('artistPerformanceTable');
        if (!container) return;

        if (artists.length === 0) {
          container.innerHTML = '<p style="color: #86868b; text-align: center;">No artist data available</p>';
          return;
        }

        container.innerHTML = `
          <div class="performance-table-wrapper">
            <table class="performance-table">
              <thead>
                <tr>
                  <th>Artist</th>
                  <th>Projects</th>
                  <th>Appointments</th>
                  <th>Revenue</th>
                  <th>Avg/Project</th>
                  <th>Completed</th>
                  <th>Active</th>
                  <th>Completion %</th>
                </tr>
              </thead>
              <tbody>
                ${artists.map(artist => `
                  <tr>
                    <td class="artist-name">${artist.artist_name}</td>
                    <td>${artist.total_projects}</td>
                    <td>${artist.total_appointments}</td>
                    <td class="revenue">â‚¬${artist.total_revenue.toLocaleString('de-DE', { maximumFractionDigits: 0 })}</td>
                    <td>â‚¬${artist.avg_revenue_per_project.toLocaleString('de-DE', { maximumFractionDigits: 0 })}</td>
                    <td><span class="badge-success">${artist.completed_projects}</span></td>
                    <td><span class="badge-warning">${artist.active_projects}</span></td>
                    <td>${artist.completion_rate.toFixed(1)}%</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }

      window.loadMultiProjectCustomerReport = async function loadMultiProjectCustomerReport() {
        console.log('ðŸ‘¥ Loading Multi-Project Customer Report...');

        try {
          const { data: appointments } = await supabase
            .from('appointments')
            .select('*')
            .not('project_number', 'is', null)
            .not('customer_id', 'is', null);

          // Group by customer
          const customerStats = {};

          (appointments || []).forEach(apt => {
            const customerId = apt.customer_id;
            const customerKey = apt.customer_email || customerId;

            if (!customerStats[customerKey]) {
              customerStats[customerKey] = {
                customer_name: `${apt.first_name || ''} ${apt.last_name || ''}`.trim() || 'Unknown',
                customer_email: apt.customer_email,
                projects: new Set(),
                total_appointments: 0,
                total_spent: 0
              };
            }

            customerStats[customerKey].projects.add(apt.project_number);
            customerStats[customerKey].total_appointments++;
            customerStats[customerKey].total_spent += parseFloat(apt.payment_amount || apt.total_amount || 0);
          });

          // Filter multi-project customers
          const multiProjectCustomers = Object.values(customerStats)
            .filter(c => c.projects.size > 1)
            .map(c => ({
              ...c,
              projects: c.projects.size
            }))
            .sort((a, b) => b.projects - a.projects);

          console.log('Found', multiProjectCustomers.length, 'multi-project customers');

          renderMultiProjectCustomerTable(multiProjectCustomers);
        } catch (error) {
          console.error('Error loading multi-project customer report:', error);
        }
      }

      function renderMultiProjectCustomerTable(customers) {
        const container = document.getElementById('multiProjectCustomersTable');
        if (!container) return;

        if (customers.length === 0) {
          container.innerHTML = '<p style="color: #86868b; text-align: center;">No multi-project customers found</p>';
          return;
        }

        container.innerHTML = `
          <div class="stats-summary">
            <h3>ðŸŒŸ VIP Customers: ${customers.length} customers with multiple projects</h3>
          </div>
          <div class="performance-table-wrapper">
            <table class="performance-table">
              <thead>
                <tr>
                  <th>Customer</th>
                  <th>Email</th>
                  <th>Projects</th>
                  <th>Total Appointments</th>
                  <th>Total Spent</th>
                  <th>Avg per Project</th>
                </tr>
              </thead>
              <tbody>
                ${customers.map(customer => `
                  <tr>
                    <td class="customer-name">${customer.customer_name}</td>
                    <td>${customer.customer_email || '-'}</td>
                    <td><strong>${customer.projects}</strong></td>
                    <td>${customer.total_appointments}</td>
                    <td class="revenue">â‚¬${customer.total_spent.toLocaleString('de-DE', { maximumFractionDigits: 0 })}</td>
                    <td>â‚¬${(customer.total_spent / customer.projects).toLocaleString('de-DE', { maximumFractionDigits: 0 })}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }

      let allRequests = [];
      let currentRequestStatus = 'open_request';
      let currentRequestLocation = 'all'; // âœ… NEW: Track selected location filter
      let currentRequestSearchKeyword = ''; // âœ… NEW: Track search keyword
      let selectedRequestId = null;
      window.selectedRequestId = null; // Also on window for onclick handlers
      // currentUser is declared globally outside this scope

      // Helper to set selectedRequestId (updates both local and window)
      function setSelectedRequestId(id) {
        selectedRequestId = id;
        window.selectedRequestId = id;
      }

      // ==========================================
      // REQUEST LOADING (using central DataCache)
      // ==========================================
      async function loadRequests(options = {}) {
        const { forceReload = false } = options;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // USE CENTRAL DATA MANAGER - Kein separates Loading mehr!
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (CentralDataManager.isReady()) {
          // Daten aus Cache holen
          allRequests = CentralDataManager.getRequests();
          window.allRequests = allRequests;

          console.log(`ðŸ“‹ Using cached requests: ${allRequests.length} total`);

          // Filter und Render (bestehende Logik)
          filterAndRenderRequests();

          // Update badge counts
          if (typeof updateRequestBadges === 'function') {
            updateRequestBadges();
          }
          return;
        }

        // Fallback: Falls CentralDataManager nicht bereit, alte Logik
        console.log('âš ï¸ CentralDataManager not ready, using fallback loading...');

        if (!forceReload) {
          const cached = DataCache.get('requests');
          if (cached) {
            allRequests = cached;
            window.allRequests = allRequests;
            filterAndRenderRequests();
            return;
          }
        }

        // Prevent parallel loads
        if (DataCache.isLoading('requests')) {
          console.log('â³ Requests already loading, skipping duplicate request...');
          return;
        }
        DataCache.setLoading('requests', true);

        try {
          ProgressBar.show('Loading requests...');
          console.log('ðŸ“‹ Loading requests for status:', currentRequestStatus, 'location:', currentRequestLocation);
          console.log('ðŸš€ FALLBACK PARALLEL BATCH LOADING');

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // FALLBACK: Parallel batch loading
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          const BATCH_SIZE = 5000;
          const PARALLEL_BATCHES = 4;

          ProgressBar.updateProgress(5, 'Getting total count...');

          // âœ… WICHTIG: Von request_cards_view laden fÃ¼r korrekten customer_rank
          const { count, error: countError } = await supabase
            .from('request_cards_view')
            .select('*', { count: 'exact', head: true });

          if (countError) throw countError;

          const totalRecords = count || 0;
          const totalBatches = Math.ceil(totalRecords / BATCH_SIZE);
          console.log(`ðŸ“Š Total requests from view: ${totalRecords}, loading in ${totalBatches} batches`);

          ProgressBar.updateProgress(10, `Loading ${totalRecords.toLocaleString()} requests...`);

          let allData = [];

          for (let i = 0; i < totalBatches; i += PARALLEL_BATCHES) {
            const batchPromises = [];

            for (let j = 0; j < PARALLEL_BATCHES && (i + j) < totalBatches; j++) {
              const start = (i + j) * BATCH_SIZE;
              const end = start + BATCH_SIZE - 1;

              // âœ… View enthÃ¤lt bereits alle gejointen Felder (customer_rank, customer_name, location)
              batchPromises.push(
                supabase
                  .from('request_cards_view')
                  .select('*')
                  .order('created_at', { ascending: false })
                  .range(start, end)
              );
            }

            const results = await Promise.all(batchPromises);

            results.forEach(({ data, error }) => {
              if (error) {
                console.error('Batch error:', error);
              } else if (data) {
                allData = allData.concat(data);
              }
            });

            const loaded = Math.min((i + PARALLEL_BATCHES) * BATCH_SIZE, totalRecords);
            const progressPercent = 10 + Math.round((loaded / totalRecords) * 60);
            ProgressBar.updateProgress(progressPercent, `Loading requests (${loaded.toLocaleString()}/${totalRecords.toLocaleString()})...`);
          }

          allRequests = allData || [];
          window.allRequests = allRequests;
          DataCache.set('requests', allRequests);
          console.log(`âœ… Loaded ${allRequests.length.toLocaleString()} total requests from view`);

          // âœ… Debug: Zeige vorhandene RÃ¤nge
          if (allRequests.length > 0) {
            console.log('ðŸ“Š Sample request:', allRequests[0]);
            console.log('ðŸ“Š Unique customer_ranks:', [...new Set(allRequests.map(r => r.customer_rank))]);
          }
          ProgressBar.updateProgress(70, 'Filtering and rendering...');

          // Filter by status
          let filteredRequests = allRequests;
          if (currentRequestStatus === 'my-requests') {
            // Filter by assigned user (nur UUID prÃ¼fen - zuverlÃ¤ssiger)
            // Exclude finished requests from My Requests view
            filteredRequests = allRequests.filter(r =>
              r.assigned_to_user_id === currentUser?.id &&
              r.status !== 'finished'
            );
          } else if (currentRequestStatus === 'open_request') {
            // âœ… Show ALL open_request items (not just last 7 days)
            // Badge count still only shows last 7 days as "new"
            filteredRequests = allRequests.filter(r => r.status === 'open_request');
          } else if (currentRequestStatus !== 'all') {
            filteredRequests = allRequests.filter(r => r.status === currentRequestStatus);
          }

          // âœ… NEW: Filter by location
          if (currentRequestLocation !== 'all') {
            filteredRequests = filteredRequests.filter(r => {
              const locationName = (r.location?.name || '').toLowerCase();

              if (currentRequestLocation === 'mommy') {
                return locationName.includes('mommy');
              } else if (currentRequestLocation === 'gon') {
                return locationName.includes('gon');
              } else if (currentRequestLocation === 'muttersohne') {
                return locationName.includes('muttersÃ¶hne') || locationName.includes('muttersohne');
              } else if (currentRequestLocation === 'pardon') {
                return locationName.includes('pardon');
              }
              return true;
            });
          }

          // âœ… NEW: Filter by search keyword
          if (currentRequestSearchKeyword && currentRequestSearchKeyword.trim() !== '') {
            const keyword = currentRequestSearchKeyword.toLowerCase().trim();
            filteredRequests = filteredRequests.filter(r => {
              // Search in multiple fields
              const searchableFields = [
                r.first_name || '',
                r.last_name || '',
                r.customer?.first_name || '',
                r.customer?.last_name || '',
                r.customer?.email || '',
                r.customer?.instagram || '',
                r.instagram || '',
                r.email || '',
                r.phone || '',
                r.description || '',
                r.notes || '',
                r.artist?.name || '',
                r.location?.name || '',
                r.request_number || '',
                r.id || ''
              ].join(' ').toLowerCase();

              return searchableFields.includes(keyword);
            });
          }

          console.log('ðŸ“Š Filtered to', filteredRequests.length, 'requests for status:', currentRequestStatus, 'location:', currentRequestLocation, 'keyword:', currentRequestSearchKeyword);
          renderRequestsList(filteredRequests);
          updateRequestBadges();
          ProgressBar.hide();
        } catch(err) {
          console.error("âŒ Requests error:", err);
          DataCache.setLoading('requests', false); // Reset loading state on error
          ProgressBar.hide();
          document.getElementById('requestsList').innerHTML = `
            <div style="text-align:center; padding:40px; color:#E53935;">
              <div style="font-size:48px; margin-bottom:16px;">âš ï¸</div>
              <div style="font-size:16px; font-weight:600; margin-bottom:8px;">Fehler beim Laden</div>
              <div style="font-size:14px; color:var(--muted);">${err.message}</div>
            </div>
          `;
        }
      }

      /**
       * Filter und Render aus Cache (ohne Neu-Laden)
       */
      function filterAndRenderRequests() {
        // Filter by status
        let filteredRequests = allRequests;

        // Deleted Tab - nur gelÃ¶schte Requests anzeigen
        if (currentRequestStatus === 'deleted') {
          filteredRequests = allRequests.filter(r => r.deleted_at !== null && r.deleted_at !== undefined);
        }
        // My Requests - keine gelÃ¶schten und keine finished
        else if (currentRequestStatus === 'my-requests') {
          filteredRequests = allRequests.filter(r =>
            r.assigned_to_user_id === currentUser?.id &&
            !r.deleted_at &&
            r.status !== 'finished'
          );
        }
        // Open Requests - keine gelÃ¶schten
        else if (currentRequestStatus === 'open_request') {
          filteredRequests = allRequests.filter(r => r.status === 'open_request' && !r.deleted_at);
        }
        // Alle anderen Status - keine gelÃ¶schten
        else if (currentRequestStatus !== 'all') {
          filteredRequests = allRequests.filter(r => r.status === currentRequestStatus && !r.deleted_at);
        }
        // All - auch keine gelÃ¶schten (die sind im Deleted Tab)
        else {
          filteredRequests = allRequests.filter(r => !r.deleted_at);
        }

        // Filter by location
        if (currentRequestLocation !== 'all') {
          filteredRequests = filteredRequests.filter(r => {
            const locationName = (r.location?.name || '').toLowerCase();
            if (currentRequestLocation === 'mommy') return locationName.includes('mommy');
            if (currentRequestLocation === 'gon') return locationName.includes('gon');
            if (currentRequestLocation === 'muttersohne') return locationName.includes('muttersÃ¶hne') || locationName.includes('muttersohne');
            if (currentRequestLocation === 'pardon') return locationName.includes('pardon');
            return true;
          });
        }

        // Filter by search keyword
        if (currentRequestSearchKeyword && currentRequestSearchKeyword.trim() !== '') {
          const keyword = currentRequestSearchKeyword.toLowerCase().trim();
          filteredRequests = filteredRequests.filter(r => {
            const searchableFields = [
              r.first_name || '', r.last_name || '',
              r.customer?.first_name || '', r.customer?.last_name || '',
              r.customer?.email || '', r.email || '',
              r.phone || '', r.description || '', r.notes || '',
              r.artist?.name || '', r.location?.name || '',
              r.request_number || '', r.id || ''
            ].join(' ').toLowerCase();
            return searchableFields.includes(keyword);
          });
        }

        console.log('ðŸ“Š Filtered from cache:', filteredRequests.length, 'requests');
        renderRequestsList(filteredRequests);
        updateRequestBadges();
      }

      /**
       * Einzelnen Request im Cache aktualisieren (statt alle neu laden)
       * @param {string} requestId - ID des Requests
       */
      async function refreshSingleRequest(requestId) {
        try {
          const { data, error } = await supabase
            .from('requests')
            .select(`
              *,
              customer:customers(id, first_name, last_name, email, phone, rank, instagram),
              artist:artists(id, name, email, instagram),
              location:locations!requests_location_id_fkey(id, name, city)
            `)
            .eq('id', requestId)
            .single();

          if (error) throw error;

          // Im Cache aktualisieren
          const index = allRequests.findIndex(r => r.id === requestId);
          if (index !== -1) {
            allRequests[index] = data;
          } else {
            allRequests.unshift(data); // Neuen Request am Anfang einfÃ¼gen
          }

          // UI aktualisieren ohne komplettes Neu-Rendern
          filterAndRenderRequests();

          console.log('âœ… Single request refreshed:', requestId);
          return data;

        } catch (err) {
          console.error('âŒ Error refreshing request:', err);
          return null;
        }
      }

      // Global verfÃ¼gbar machen fÃ¼r scheduleWithPayment() etc.
      window.refreshSingleRequest = refreshSingleRequest;

      /**
       * Neuen Request zum Cache hinzufÃ¼gen
       * @param {Object} request - Der neue Request (mit Relations)
       */
      function addRequestToCache(request) {
        allRequests.unshift(request);
        filterAndRenderRequests();
        console.log('âœ… Request added to cache');
      }

      /**
       * Request Cache invalidieren und neu laden
       */
      async function reloadRequests() {
        requestsLoaded = false;
        requestsLastLoadTime = null;
        await loadRequests({ forceReload: true });
      }

      /**
       * Generiert den Status-Indikator fÃ¼r die Card
       */
      function getCardStatusIndicator(request) {
        var lastAction = request.last_action;
        var paymentStatus = request.payment_status;

        if (!lastAction && !request.stripe_payment_link && paymentStatus !== 'paid') {
          return '';
        }

        var indicator = '';
        var bgColor = '';
        var textColor = '';

        // PRIORITÃ„T 1: Bezahlt (hÃ¶chste PrioritÃ¤t)
        if (paymentStatus === 'paid' || paymentStatus === 'fully_paid') {
          indicator = 'âœ… Bezahlt';
          bgColor = '#e8f5e9';
          textColor = '#2e7d32';
        }
        // PRIORITÃ„T 2: Payment Failed
        else if (paymentStatus === 'failed' || lastAction === 'payment_failed') {
          indicator = 'âŒ Fehlgeschlagen';
          bgColor = '#ffebee';
          textColor = '#c62828';
        }
        // PRIORITÃ„T 3: Storniert
        else if (lastAction === 'storniert' || lastAction === 'auto_storniert') {
          indicator = 'Storniert';
          bgColor = '#ffebee';
          textColor = '#c62828';
        }
        // PRIORITÃ„T 4: 2nd Reminder
        else if (lastAction === 'reminder_2_sent' || lastAction === 'auto_reminder_2') {
          indicator = '2nd Reminder';
          bgColor = '#fff3e0';
          textColor = '#e65100';
        }
        // PRIORITÃ„T 5: 1st Reminder
        else if (lastAction === 'reminder_1_sent' || lastAction === 'auto_reminder_1') {
          indicator = '1st Reminder';
          bgColor = '#fff8e1';
          textColor = '#f57f17';
        }
        // PRIORITÃ„T 6: Rescheduled
        else if (lastAction === 'rescheduled') {
          indicator = 'Rescheduled';
          bgColor = '#e8eaf6';
          textColor = '#3949ab';
        }
        // PRIORITÃ„T 7: Payment Pending (Zahlungslink gesendet, noch nicht bezahlt)
        else if (request.stripe_payment_link && paymentStatus === 'pending') {
          indicator = 'â³ Offen';
          bgColor = '#fff3e0';
          textColor = '#e65100';
        }
        // PRIORITÃ„T 8: Payment Link Sent
        else if (lastAction === 'scheduled_with_payment' || lastAction === 'payment_link_sent') {
          indicator = 'Payment Link';
          bgColor = '#e3f2fd';
          textColor = '#1565c0';
        }

        if (!indicator) {
          return '';
        }

        return '<span style="display:inline-block;margin-left:8px;padding:2px 8px;font-size:11px;font-weight:600;background:' + bgColor + ';color:' + textColor + ';border-radius:4px">' + indicator + '</span>';
      }

      window.getCardStatusIndicator = getCardStatusIndicator;

      /**
       * Generiert den Countdown fÃ¼r gelÃ¶schte Requests
       */
      function getDeletedCountdown(request) {
        if (!request.deleted_at) return '';

        var deletedAt = new Date(request.deleted_at);
        var now = new Date();
        var daysElapsed = Math.floor((now.getTime() - deletedAt.getTime()) / (1000 * 60 * 60 * 24));
        var daysLeft = Math.max(0, 5 - daysElapsed);

        return '<div style="background:#fff3cd;padding:6px 10px;border-radius:6px;margin-top:8px;font-size:11px;color:#856404">â³ Wird in ' + daysLeft + ' Tag' + (daysLeft !== 1 ? 'en' : '') + ' permanent geloescht</div>';
      }

      window.getDeletedCountdown = getDeletedCountdown;

      function renderRequestsList(requests) {
        const listEl = document.getElementById('requestsList');

        // Check if viewing "My Requests" without being logged in
        if (currentRequestStatus === 'my-requests' && !currentUser) {
          listEl.innerHTML = `
            <div style="text-align:center; padding:60px 20px; color:var(--muted);">
              <div style="font-size:48px; margin-bottom:16px;">ðŸ”’</div>
              <div style="font-size:18px; font-weight:600; margin-bottom:8px; color:var(--ink);">Nicht angemeldet</div>
              <div style="font-size:14px;">Bitte melden Sie sich an, um Ihre zugewiesenen Requests zu sehen.</div>
            </div>
          `;
          return;
        }
        
        if (requests.length === 0) {
          let emptyMessage = 'No requests found';
          if (currentRequestStatus === 'my-requests') {
            emptyMessage = 'Sie haben keine zugewiesenen Requests';
          } else if (currentRequestStatus === 'open_request') {
            emptyMessage = 'Keine neuen Requests';
          } else if (currentRequestStatus === 'pending') {
            emptyMessage = 'Keine Requests in Bearbeitung';
          } else if (currentRequestStatus === 'scheduled') {
            emptyMessage = 'Keine geplanten Termine';
          } else if (currentRequestStatus === 'finished') {
            emptyMessage = 'Keine abgeschlossenen Requests';
          } else if (currentRequestStatus === 'canceled') {
            emptyMessage = 'Keine stornierten Requests';
          } else if (currentRequestStatus === 'archived') {
            emptyMessage = 'Keine archivierten Requests';
          }

          listEl.innerHTML = `<div style="text-align:center; padding:40px; color:var(--muted);">${emptyMessage}</div>`;
          return;
        }
        
        // Status display names mapping
        const statusNames = {
          'open_request': 'NEW',
          'pending': 'PENDING',
          'scheduled': 'SCHEDULED',
          'finished': 'FINISHED',
          'canceled': 'CANCELED',
          'no_show': 'NO SHOW'
        };

        // Rank display names mapping (mit GroÃŸschreibung wie in DB)
        const rankNames = {
          'Platinum': 'Platinum',
          'platinum': 'Platinum',
          'Gold': 'Gold',
          'gold': 'Gold',
          'Silver': 'Silver',
          'silver': 'Silver',
          'Silber': 'Silver',
          'silber': 'Silver',
          'Bronze': 'Bronze',
          'bronze': 'Bronze',
          'Neukunde': 'Neukunde',
          'neukunde': 'Neukunde',
          'new_customer': 'Neukunde',
          '': 'Neukunde',
          'null': 'Neukunde',
          'undefined': 'Neukunde'
        };

        listEl.innerHTML = requests.map(req => {
          // âœ… NEU: Felder direkt aus request_cards_view
          // customer_name ist bereits gejoint in der View
          const customerName = req.customer_name || `${req.first_name || ''} ${req.last_name || ''}`.trim() || 'Unbekannt';

          // âœ… customer_rank direkt aus View (Neukunde, Bronze, Silver, Gold, Platinum)
          const rank = req.customer_rank || '';
          const rankDisplay = rankNames[rank] || 'Neukunde';
          const rankClass = rank?.toLowerCase() || 'neukunde';

          // âœ… location direkt aus View (bereits als String)
          const locationName = req.location || req.location?.name || '';

          // âœ… request_id aus View (= request_number)
          const requestNumber = req.request_id || req.request_number || `R${req.id?.substring(0, 8).toUpperCase() || ''}`;

          // Status
          const status = req.status || 'open_request';
          const statusDisplay = statusNames[status] || status.toUpperCase();
          const statusClass = status.replace('open_request', 'new');

          // Format date
          const createdAt = new Date(req.created_at);
          const dateStr = createdAt.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }) +
                          ', ' + createdAt.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

          // Check if request is older than 7 days (for background color)
          const now = new Date();
          const daysDiff = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));
          const oldStatusClass = req.status === 'open_request' && daysDiff >= 7 ? 'old-status' : '';

          return `
            <div class="request-item ${oldStatusClass}" data-id="${req.id}">
              <div class="request-card-header">
                <span class="request-card-id">${requestNumber}</span>
                <div class="request-card-badges">
                  <span class="request-card-rank ${rankClass}">${rankDisplay}</span>
                  <span class="request-card-status ${statusClass}">${statusDisplay}</span>
                </div>
              </div>
              <div class="request-card-name">${customerName}</div>
              ${locationName ? `<div class="request-card-location">${locationName}</div>` : ''}
              <div class="request-card-date">${dateStr}</div>
              ${getDeletedCountdown(req)}
            </div>
          `;
        }).join('');
        
        // Add click handlers with toggle functionality
        document.querySelectorAll('.request-item').forEach(item => {
          item.addEventListener('click', () => {
            const isAlreadyActive = item.classList.contains('active');
            
            // Remove active class from all items
            document.querySelectorAll('.request-item').forEach(i => i.classList.remove('active'));
            
            if (isAlreadyActive) {
              // If clicking on already active item, close detail view
              selectedRequestId = null;
              closeRequestDetail();
            } else {
              // Otherwise, open the clicked item
              item.classList.add('active');
              selectedRequestId = item.dataset.id;
              showRequestDetail(selectedRequestId);
            }
          });
        });
      }
      
      function closeRequestDetail() {
        const detailEl = document.getElementById('requestDetail');
        detailEl.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--muted); font-size:16px;">
            Select a request to view details
          </div>
        `;
      }

      /**
       * Generiert die Action-Buttons basierend auf Request-Status
       * @param {Object} request - Der Request
       * @param {string} currentUser - Aktueller Benutzer
       * @returns {string} HTML fÃ¼r Buttons
       */
      function generateActionButtons(request, currentUser) {
        var buttons = [];
        var status = request.status;
        var hasPaymentLink = !!request.stripe_payment_link;
        var hasArtist = !!request.artist_id;
        var hasDate = !!request.scheduled_date;
        var hasPrice = request.total_amount && request.total_amount > 0;
        var isDeleted = !!request.deleted_at;
        var allDataComplete = hasArtist && hasDate && hasPrice;

        // GelÃ¶schte Requests
        if (isDeleted) {
          var daysLeft = 5 - Math.floor((Date.now() - new Date(request.deleted_at).getTime()) / (1000 * 60 * 60 * 24));
          buttons.push('<div style="background:#fff3cd;padding:12px 16px;border-radius:8px;margin-bottom:12px;border-left:4px solid #ffc107"><p style="margin:0;font-size:13px;color:#856404">â³ Wird in <strong>' + Math.max(0, daysLeft) + ' Tagen</strong> permanent geloescht</p></div>');
          buttons.push('<button onclick="restoreRequest(\'' + request.id + '\')" style="flex:1;padding:12px 16px;background:#34c759;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Restore</button>');
          buttons.push('<button onclick="permanentDeleteRequest(\'' + request.id + '\')" style="flex:1;padding:12px 16px;background:#ff3b30;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Permanent Delete</button>');
          return '<div style="display:flex;flex-direction:column;gap:12px;margin-top:20px;padding-top:20px;border-top:1px solid #e5e5e5">' + buttons.join('') + '</div>';
        }

        // New Request
        if (status === 'open_request') {
          buttons.push('<button onclick="assignRequest(\'' + request.id + '\')" style="flex:1;padding:12px 16px;background:#1d1d1f;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Assign to User</button>');
          buttons.push('<button onclick="softDeleteRequest(\'' + request.id + '\')" style="padding:12px 16px;background:white;color:#ff3b30;border:2px solid #ff3b30;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Delete</button>');
        }

        // Pending
        else if (status === 'pending') {
          buttons.push('<button onclick="editRequest(\'' + request.id + '\')" style="padding:12px 16px;background:#1d1d1f;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Edit Request</button>');

          if (allDataComplete) {
            buttons.push('<button onclick="scheduleAppointmentDirect(\'' + request.id + '\')" style="padding:12px 16px;background:white;color:#1d1d1f;border:2px solid #1d1d1f;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Schedule</button>');
            buttons.push('<button onclick="scheduleWithPayment(\'' + request.id + '\')" style="padding:12px 16px;background:white;color:#1d1d1f;border:2px solid #1d1d1f;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Schedule + Payment</button>');
          }

          buttons.push('<button onclick="softDeleteRequest(\'' + request.id + '\')" style="padding:12px 16px;background:white;color:#ff3b30;border:2px solid #ff3b30;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Delete</button>');
        }

        // Scheduled
        else if (status === 'scheduled') {
          buttons.push('<button onclick="editRequestInfos(\'' + request.id + '\')" style="padding:12px 16px;background:#1d1d1f;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Edit Infos</button>');
          buttons.push('<button onclick="rescheduleRequest(\'' + request.id + '\')" style="padding:12px 16px;background:white;color:#1d1d1f;border:2px solid #1d1d1f;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Reschedule</button>');

          if (hasPaymentLink) {
            buttons.push('<button onclick="storniereRequest(\'' + request.id + '\')" style="padding:12px 16px;background:white;color:#ff3b30;border:2px solid #ff3b30;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Stornierung</button>');
          } else {
            buttons.push('<button onclick="cancelRequest(\'' + request.id + '\')" style="padding:12px 16px;background:white;color:#ff9500;border:2px solid #ff9500;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Cancel</button>');
          }

          buttons.push('<button onclick="softDeleteRequest(\'' + request.id + '\')" style="padding:12px 16px;background:white;color:#ff3b30;border:2px solid #ff3b30;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Delete</button>');
        }

        // Canceled
        else if (status === 'canceled') {
          buttons.push('<button onclick="restoreRequest(\'' + request.id + '\')" style="flex:1;padding:12px 16px;background:#34c759;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Restore</button>');
          buttons.push('<button onclick="softDeleteRequest(\'' + request.id + '\')" style="padding:12px 16px;background:white;color:#ff3b30;border:2px solid #ff3b30;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px">Delete</button>');
        }

        // Warnung wenn Daten fehlen (bei pending)
        var warnings = [];
        if (status === 'pending' && !allDataComplete) {
          var missing = [];
          if (!hasArtist) missing.push('Artist');
          if (!hasDate) missing.push('Datum');
          if (!hasPrice) missing.push('Preis');
          warnings.push('<div style="background:#fff3cd;padding:12px 16px;border-radius:8px;border-left:4px solid #ffc107;margin-top:12px"><p style="margin:0;font-size:13px;color:#856404">Fuer Terminierung fehlt: <strong>' + missing.join(', ') + '</strong></p></div>');
        }

        var buttonsHtml = '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:20px;padding-top:20px;border-top:1px solid #e5e5e5">' + buttons.join('') + '</div>';

        return buttonsHtml + warnings.join('');
      }

      /**
       * Generiert die Verlauf-Cards aus request_activity_log
       * @param {string} requestId - Die Request ID
       * @param {Object} request - Der Request mit allen Daten
       * @returns {Promise<string>} HTML fÃ¼r Verlauf-Cards
       */
      async function generateActivityCards(requestId, request) {
        try {
          // Activity Log laden
          var result = await supabase
            .from('request_activity_log')
            .select('*')
            .eq('request_id', requestId)
            .order('action_at', { ascending: false });

          var activities = result.data || [];

          // Falls keine Activities, prÃ¼fe ob Payment Link existiert (Legacy-Daten)
          if (activities.length === 0 && request.stripe_payment_link) {
            activities = [{
              action: 'payment_link_sent',
              action_at: request.payment_link_sent_at || request.updated_at,
              action_by: 'System',
              details: {
                payment_link: request.stripe_payment_link,
                amount: request.total_amount
              }
            }];
          }

          if (activities.length === 0) {
            return '';
          }

          var cardsHtml = '<div style="margin-top:24px;padding-top:20px;border-top:1px solid #e5e5e5"><h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#86868b;text-transform:uppercase">Verlauf</h4>';

          for (var i = 0; i < activities.length; i++) {
            var activity = activities[i];
            var card = generateSingleActivityCard(activity, request);
            cardsHtml += card;
          }

          cardsHtml += '</div>';
          return cardsHtml;

        } catch (err) {
          console.error('Error loading activity log:', err);
          return '';
        }
      }

      /**
       * Generiert eine einzelne Verlauf-Card
       */
      function generateSingleActivityCard(activity, request) {
        var action = activity.action;
        var actionAt = new Date(activity.action_at).toLocaleString('de-DE');
        var actionBy = activity.action_by || 'System';
        var details = activity.details || {};
        var isSystem = activity.is_system_action;

        var icon = '';
        var title = '';
        var bgColor = '#f5f5f7';
        var borderColor = '#e5e5e5';
        var extraContent = '';

        switch (action) {
          case 'payment_link_sent':
          case 'scheduled_with_payment':
            icon = 'âœ…';
            title = 'Zahlungslink versendet';
            bgColor = '#e8f5e9';
            borderColor = '#4caf50';
            var paymentLink = details.payment_link || request.stripe_payment_link || '';
            var amount = details.amount || request.total_amount || 0;
            extraContent = '<p style="margin:8px 0 4px;font-size:13px;color:#424245">ðŸ”— <a href="' + paymentLink + '" target="_blank" style="color:#0071e3">' + paymentLink + '</a></p>';
            extraContent += '<p style="margin:0;font-size:13px;color:#424245">Gesamtpreis: ' + Number(amount).toFixed(2) + ' EUR</p>';
            break;

          case 'scheduled':
            icon = 'ðŸ“…';
            title = 'Scheduled';
            bgColor = '#e3f2fd';
            borderColor = '#2196f3';
            break;

          case 'reminder_1_sent':
          case 'auto_reminder_1':
            icon = 'ðŸ“§';
            title = '1st Reminder sent';
            bgColor = '#fff8e1';
            borderColor = '#ffc107';
            if (isSystem) title += ' (Auto)';
            break;

          case 'reminder_2_sent':
          case 'auto_reminder_2':
            icon = 'ðŸ“§âš ï¸';
            title = '2nd Reminder sent';
            bgColor = '#fff3e0';
            borderColor = '#ff9800';
            if (isSystem) title += ' (Auto)';
            break;

          case 'rescheduled':
            icon = 'ðŸ”„';
            title = 'Rescheduled';
            bgColor = '#e8eaf6';
            borderColor = '#3f51b5';
            break;

          case 'canceled':
            icon = 'â¸ï¸';
            title = 'Canceled';
            bgColor = '#fff3e0';
            borderColor = '#ff9800';
            break;

          case 'storniert':
          case 'auto_storniert':
            icon = 'âŒ';
            title = 'Storniert';
            bgColor = '#ffebee';
            borderColor = '#f44336';
            if (isSystem) title += ' (Auto)';
            if (details.email_sent) {
              extraContent = '<p style="margin:4px 0 0;font-size:12px;color:#666">Email versendet an: ' + (details.email_sent_to || 'Kunde') + '</p>';
            }
            break;

          case 'deleted':
            icon = 'ðŸ—‘ï¸';
            title = 'Geloescht';
            bgColor = '#fce4ec';
            borderColor = '#e91e63';
            break;

          case 'restored':
            icon = 'â™»ï¸';
            title = 'Wiederhergestellt';
            bgColor = '#e8f5e9';
            borderColor = '#4caf50';
            break;

          case 'assigned':
            icon = 'ðŸ‘¤';
            title = 'Assigned';
            bgColor = '#e3f2fd';
            borderColor = '#2196f3';
            if (details.assigned_to) {
              extraContent = '<p style="margin:4px 0 0;font-size:12px;color:#666">An: ' + details.assigned_to + '</p>';
            }
            break;

          case 'payment_received':
            icon = 'ðŸ’°';
            title = 'Zahlung eingegangen';
            bgColor = '#e8f5e9';
            borderColor = '#4caf50';
            break;

          default:
            icon = 'ðŸ“';
            title = action;
            break;
        }

        var html = '<div style="background:' + bgColor + ';border-left:4px solid ' + borderColor + ';border-radius:8px;padding:12px 16px;margin-bottom:12px">';
        html += '<div style="display:flex;justify-content:space-between;align-items:flex-start">';
        html += '<div>';
        html += '<p style="margin:0;font-size:14px;font-weight:600;color:#1d1d1f">' + icon + ' ' + title + '</p>';
        html += '<p style="margin:4px 0 0;font-size:12px;color:#86868b">' + actionAt + '</p>';
        html += '</div>';
        html += '<span style="font-size:11px;color:#86868b;background:white;padding:2px 8px;border-radius:4px">' + actionBy + '</span>';
        html += '</div>';
        html += extraContent;
        html += '</div>';

        return html;
      }

      window.generateActivityCards = generateActivityCards;
      window.generateSingleActivityCard = generateSingleActivityCard;

      async function showRequestDetail(requestId) {
        const request = allRequests.find(r => r.id === requestId);
        if (!request) return;

        // Set selectedRequestId globally for onclick handlers
        selectedRequestId = requestId;
        window.selectedRequestId = requestId;

        console.log('ðŸ“‹ Showing request detail:', requestId, request);

        const detailEl = document.getElementById('requestDetail');

        // Status display names
        const statusNames = {
          'open_request': 'New',
          'pending': 'Pending',
          'scheduled': 'Scheduled',
          'finished': 'Finished',
          'canceled': 'Canceled'
        };

        // Get customer data directly from requests table (first_name, last_name, email, customer_phone columns)
        // Use customer relation only for rank and instagram
        const customer = {
          first_name: request.first_name,
          last_name: request.last_name,
          email: request.email,
          phone: request.customer_phone,
          rank: request.customer?.rank || null,
          instagram: request.customer?.instagram || request.instagram || null
        };

        const customerName = `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unbekannt';

        // Rank badge styling
        const rankBadgeStyle = customer.rank ? {
          'Platinum': 'background:#FFD700; color:#1d1d1f;',
          'Gold': 'background:#FF8C00; color:white;',
          'Silver': 'background:#C0C0C0; color:#1d1d1f;',
          'Bronze': 'background:#CD7F32; color:white;'
        }[customer.rank] || '' : '';

        // Action Buttons generieren
        var currentUser = window.currentUsername || 'Unknown';
        var actionButtonsHtml = generateActionButtons(request, currentUser);

        // Activity Cards laden
        var activityCardsHtml = await generateActivityCards(requestId, request);

        detailEl.innerHTML = `
          <div style="margin-bottom:24px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
              <h2 style="margin:0; font-size:24px; font-weight:600;">
                ${request.request_number || `#${request.id.substring(0, 8).toUpperCase()}`}
              </h2>
              <span class="request-badge ${request.status}" style="font-size:13px; padding:6px 16px;">
                ${statusNames[request.status] || request.status}
              </span>
            </div>
            ${request.location ? `
              <div style="color:var(--muted); font-size:14px;">
                ${request.location.name}${request.location.city ? ` (${request.location.city})` : ''}
              </div>
            ` : ''}
          </div>

          <div class="detail-section">
            <h3>Customer Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Vorname</div>
                <div class="detail-value">${customer.first_name || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Nachname</div>
                <div class="detail-value">
                  ${customer.last_name || '<span class="no-data-placeholder">No entry data</span>'}
                  ${customer.rank ? `
                    <span style="display:inline-block; margin-left:8px; padding:4px 10px; border-radius:999px; font-size:11px; font-weight:600; ${rankBadgeStyle}">
                      ${customer.rank}
                    </span>
                  ` : ''}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Email</div>
                <div class="detail-value">
                  ${customer.email ? `<a href="mailto:${customer.email}" style="color:var(--accent);">${customer.email}</a>` : '<span class="no-data-placeholder">No entry data</span>'}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Phone</div>
                <div class="detail-value">
                  ${customer.phone ? `<a href="tel:${customer.phone}" style="color:var(--accent);">${customer.phone}</a>` : '<span class="no-data-placeholder">No entry data</span>'}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Instagram</div>
                <div class="detail-value">
                  ${customer.instagram ? `<a href="https://instagram.com/${customer.instagram}" target="_blank" style="color:var(--accent);">@${customer.instagram}</a>` : '<span class="no-data-placeholder">No entry data</span>'}
                </div>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <h3>Request Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Priority</div>
                <div class="detail-value">
                  ${request.priority ? `
                    <span class="priority-badge ${request.priority}">
                      ${request.priority === 'urgent' ? 'ðŸ”¥' : request.priority === 'high' ? 'âš¡' : request.priority === 'normal' ? 'âœ“' : 'ðŸ’¤'}
                      ${request.priority.toUpperCase()}
                    </span>
                  ` : '<span class="no-data-placeholder">No entry data</span>'}
                </div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Placement</div>
                <div class="detail-value">${request.placement || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Size</div>
                <div class="detail-value">${request.size || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Style</div>
                <div class="detail-value">${request.style || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Colorway</div>
                <div class="detail-value">${request.colorway || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Booking Type</div>
                <div class="detail-value">${request.booking_type || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Origin</div>
                <div class="detail-value">${request.origin || '<span class="no-data-placeholder">No entry data</span>'}</div>
              </div>
            </div>

            <div class="detail-item" style="margin-top:16px;">
              <div class="detail-label">Artist PrÃ¤ferenz</div>
              <div class="detail-value">
                ${request.artist_preference && request.artist_preference.trim() ? `
                  <div class="artist-preference-tags">
                    ${request.artist_preference.split(',')
                      .map(name => name.trim())
                      .filter(name => name.length > 0)
                      .map(name => `<span class="artist-tag">${name}</span>`)
                      .join('')}
                  </div>
                ` : '<span class="no-data-placeholder">No entry data</span>'}
              </div>
            </div>

            <div class="detail-item" style="margin-top:16px;">
              <div class="detail-label">Description</div>
              <div class="detail-value" style="white-space:pre-wrap;">${request.description || '<span class="no-data-placeholder">No entry data</span>'}</div>
            </div>

            <div class="detail-item" style="margin-top:16px;">
              <div class="detail-label" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Reference Images${request.reference_images && request.reference_images.length > 0 ? ` (${request.reference_images.length})` : ''}</span>
                ${request.reference_images && request.reference_images.length > 0 ? `
                  <button onclick="downloadAllImages('${request.id}')" style="padding:4px 12px;background:#0071e3;color:white;border:none;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600">
                    â¬‡ Download All
                  </button>
                ` : ''}
              </div>
              <div class="detail-value">
                ${request.reference_images && request.reference_images.length > 0 ? `
                  <div class="reference-images" style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${request.reference_images.map((img, idx) => `
                      <div style="position:relative;">
                        <div class="reference-image-thumb" onclick="openImageModal('${img}')" style="cursor:pointer;">
                          <img src="${img}" alt="Reference ${idx + 1}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                        </div>
                        <button onclick="event.stopPropagation();downloadSingleImage('${img}', 'reference_${idx + 1}')" style="position:absolute;bottom:4px;right:4px;width:24px;height:24px;background:rgba(0,0,0,0.7);color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px" title="Download">â¬‡</button>
                      </div>
                    `).join('')}
                  </div>
                ` : '<span class="no-data-placeholder">No entry data</span>'}
              </div>
            </div>
          </div>

          ${request.artist || request.assigned_to ? `
            <div class="detail-section">
              <h3>Assignment</h3>
              <div class="detail-grid">
                ${request.artist ? `
                  <div class="detail-item">
                    <div class="detail-label">Artist</div>
                    <div class="detail-value">
                      ${request.artist.name}
                      ${request.artist.email ? `<br/><small style="color:var(--muted);">${request.artist.email}</small>` : ''}
                      ${request.artist.instagram ? `<br/><a href="https://instagram.com/${request.artist.instagram}" target="_blank" style="color:var(--accent); font-size:13px;">@${request.artist.instagram}</a>` : ''}
                    </div>
                  </div>
                ` : request.assigned_to ? `
                  <div class="detail-item">
                    <div class="detail-label">Assigned To</div>
                    <div class="detail-value">${request.assigned_to}</div>
                  </div>
                ` : ''}
              </div>
            </div>
          ` : ''}

          ${request.scheduled_date || request.payment_status ? `
            <div class="detail-section">
              <h3>Appointment & Payment</h3>
              <div class="detail-grid">
                ${request.scheduled_date ? `
                  <div class="detail-item">
                    <div class="detail-label">Scheduled Date</div>
                    <div class="detail-value">${new Date(request.scheduled_date).toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                  </div>
                ` : ''}
                ${request.start_time ? `
                  <div class="detail-item">
                    <div class="detail-label">Start Time</div>
                    <div class="detail-value">${request.start_time}</div>
                  </div>
                ` : ''}
                ${request.end_time ? `
                  <div class="detail-item">
                    <div class="detail-label">End Time</div>
                    <div class="detail-value">${request.end_time}</div>
                  </div>
                ` : ''}
                ${request.payment_status ? `
                  <div class="detail-item">
                    <div class="detail-label">Payment Status</div>
                    <div class="detail-value">
                      <span style="padding:4px 12px; border-radius:999px; font-size:12px; font-weight:500; ${
                        request.payment_status === 'fully_paid' ? 'background:#D1FAE5; color:#065F46;' :
                        request.payment_status === 'deposit_paid' ? 'background:#DBEAFE; color:#1E40AF;' :
                        request.payment_status === 'refunded' ? 'background:#FEE2E2; color:#991B1B;' :
                        'background:#FEF3C7; color:#92400E;'
                      }">
                        ${request.payment_status}
                      </span>
                    </div>
                  </div>
                ` : ''}
                ${request.total_amount ? `
                  <div class="detail-item">
                    <div class="detail-label">Total Amount</div>
                    <div class="detail-value">${request.total_amount}â‚¬</div>
                  </div>
                ` : ''}
              </div>
            </div>
          ` : ''}

          ${request.cancel_reason ? `
            <div class="detail-section">
              <h3>Cancellation</h3>
              <div class="detail-item">
                <div class="detail-label">Reason</div>
                <div class="detail-value">${request.cancel_reason}</div>
              </div>
            </div>
          ` : ''}

          ${request.notes ? `
            <div class="detail-section">
              <h3>Notes</h3>
              <div class="detail-value" style="white-space:pre-wrap;">${request.notes}</div>
            </div>
          ` : ''}

          <div class="detail-section">
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Created At</div>
                <div class="detail-value">${new Date(request.created_at).toLocaleString('de-DE')}</div>
              </div>
              ${request.updated_at && request.updated_at !== request.created_at ? `
                <div class="detail-item">
                  <div class="detail-label">Updated At</div>
                  <div class="detail-value">${new Date(request.updated_at).toLocaleString('de-DE')}</div>
                </div>
              ` : ''}
            </div>
          </div>

          ${actionButtonsHtml}

          ${request.stripe_payment_link ? `
            <div style="background:rgba(52,199,89,0.1); padding:16px; border-radius:10px; margin-top:24px; border:1px solid rgba(52,199,89,0.3);">
              <div style="display:flex; align-items:start; gap:12px;">
                <span style="font-size:24px;">âœ…</span>
                <div style="flex:1;">
                  <div style="font-size:15px; font-weight:600; color:var(--macos-accent-green); margin-bottom:6px;">Zahlungslink versendet</div>
                  <div style="font-size:13px; color:var(--macos-text-secondary); margin-bottom:8px;">
                    ${request.payment_link_sent_at ? 'Versendet am: ' + new Date(request.payment_link_sent_at).toLocaleString('de-DE') : ''}
                  </div>
                  <div style="font-size:12px; margin-top:8px;">
                    <a href="${request.stripe_payment_link}" target="_blank" style="color:var(--macos-accent-blue); text-decoration:none; word-break:break-all;">
                      ðŸ”— ${request.stripe_payment_link}
                    </a>
                  </div>
                  ${request.total_price || request.total_amount ? `
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(52,199,89,0.2);">
                      <div style="font-size:13px; color:var(--macos-text-secondary); margin-bottom:4px;">
                        <strong>Gesamtpreis:</strong> â‚¬${(request.total_price || request.total_amount || 0).toFixed(2)}
                      </div>
                      ${request.deposit_amount ? `
                        <div style="font-size:13px; color:var(--macos-text-secondary);">
                          <strong>Terminkaution (50%):</strong> â‚¬${request.deposit_amount.toFixed(2)}
                        </div>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
          ` : ''}

          ${activityCardsHtml}
        `;
      }

      function updateRequestBadges() {
        // âœ… Nur Requests der letzten 7 Tage als "new" zÃ¤hlen (keine gelÃ¶schten)
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

        const newCount = allRequests.filter(r => {
          if (r.status !== 'open_request') return false;
          if (r.deleted_at) return false; // GelÃ¶schte ausschlieÃŸen
          const createdAt = new Date(r.created_at);
          return createdAt >= sevenDaysAgo;
        }).length;

        const badgeEl = document.getElementById('badge-new');
        if (badgeEl) {
          badgeEl.textContent = newCount;
          badgeEl.style.display = newCount > 0 ? 'inline-block' : 'none';
        }

        // Deleted count
        const deletedCount = allRequests.filter(r => r.deleted_at !== null && r.deleted_at !== undefined).length;

        const deletedBadge = document.getElementById('badge-deleted');
        if (deletedBadge) {
          deletedBadge.textContent = deletedCount;
          deletedBadge.style.display = deletedCount > 0 ? 'inline-block' : 'none';
        }
      }

      // Request Tab Switching is handled in initRequestTabs()

      // ============================================
      // ALLE UI-FUNKTIONEN GLOBAL VERFÃœGBAR MACHEN
      // (fÃ¼r onclick-Handler in dynamisch generiertem HTML)
      // ============================================
      if (typeof showRequestDetail === 'function') window.showRequestDetail = showRequestDetail;
      if (typeof closeRequestDetail === 'function') window.closeRequestDetail = closeRequestDetail;
      if (typeof filterAndRenderRequests === 'function') window.filterAndRenderRequests = filterAndRenderRequests;
      if (typeof loadRequests === 'function') window.loadRequests = loadRequests;
      if (typeof updateRequestBadges === 'function') window.updateRequestBadges = updateRequestBadges;

      console.log('âœ… UI functions exposed to window');

      // Assign Request
      let assigningRequestId = null; // Track which request is being assigned

      window.assignRequest = async function(requestId = null) {
        // Request ID bestimmen
        const targetRequestId = requestId || selectedRequestId || window.selectedRequestId;

        if (!targetRequestId) {
          alert('Kein Request ausgewÃ¤hlt');
          console.error('âŒ assignRequest: No request ID available');
          return;
        }

        // Store for form submission
        assigningRequestId = targetRequestId;

        // Dynamisch Team Members laden (falls noch nicht geladen)
        if (bookingTeamMembers.length === 0) {
          await loadBookingTeamMembers();
        }

        const teamMemberSelect = document.getElementById('assignTeamMember');
        teamMemberSelect.innerHTML = '<option value="">-- Select Team Member --</option>' +
          bookingTeamMembers.map(m => `<option value="${m.id}">${m.username}</option>`).join('');

        document.getElementById('assignModal').classList.add('active');
      };

      document.getElementById('cancelAssign')?.addEventListener('click', () => {
        document.getElementById('assignModal').classList.remove('active');
        assigningRequestId = null;
      });

      document.getElementById('assignForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Use the stored request ID
        const targetRequestId = assigningRequestId || selectedRequestId || window.selectedRequestId;

        if (!targetRequestId) {
          alert('Kein Request ausgewÃ¤hlt');
          return;
        }

        const userId = document.getElementById('assignTeamMember').value;

        // Username aus bookingTeamMembers holen
        const selectedMember = bookingTeamMembers.find(m => m.id === userId);
        const username = selectedMember?.username || 'Unknown';

        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'pending',
              assigned_to_user_id: userId,      // UUID fÃ¼r Joins
              assigned_to: username              // âœ… Username fÃ¼r Anzeige
            })
            .eq('id', targetRequestId);

          if (error) throw error;

          console.log(`âœ… Request zugewiesen an: ${username}`);
          document.getElementById('assignModal').classList.remove('active');
          document.getElementById('assignForm').reset();

          // Nur diesen einen Request im Cache aktualisieren
          await refreshSingleRequest(targetRequestId);
          showRequestDetail(targetRequestId);

          assigningRequestId = null;
          alert(`Request erfolgreich an ${username} zugewiesen!`);
        } catch (err) {
          alert('Error assigning request: ' + err.message);
        }
      });
      
      // Schedule Appointment
      let schedulingRequestId = null; // Track which request is being scheduled

      window.scheduleAppointment = async function(requestId = null) {
        // Request ID bestimmen
        const targetRequestId = requestId || selectedRequestId || window.selectedRequestId;

        if (!targetRequestId) {
          alert('Kein Request ausgewÃ¤hlt');
          console.error('âŒ scheduleAppointment: No request ID available');
          return;
        }

        // Store for form submission
        schedulingRequestId = targetRequestId;

        // Load artists
        const { data: artists } = await supabase.from('artists').select('*').order('name');
        const artistSelect = document.getElementById('scheduleArtist');
        artistSelect.innerHTML = '<option value="">-- Select Artist --</option>' +
          (artists || []).map(a => `<option value="${a.id}">${a.name}</option>`).join('');

        // Request finden - mit Fallback auf window.allRequests und DB
        const requestsArray = window.allRequests || [];
        let request = requestsArray.find(r => r.id === targetRequestId);

        // Falls nicht im Cache, direkt aus DB laden
        if (!request) {
          console.log('ðŸ“¥ Request not in cache, loading from DB...');
          const { data, error } = await supabase
            .from('requests')
            .select(`
              *,
              customer:customers(id, first_name, last_name, email, phone),
              artist:artists(id, name, email),
              location:locations!requests_location_id_fkey(id, name, city)
            `)
            .eq('id', targetRequestId)
            .single();

          if (!error && data) {
            request = data;
          }
        }

        // Pre-fill with existing data if available
        if (request) {
          if (request.artist_id) {
            artistSelect.value = request.artist_id;
          }
          if (request.scheduled_date) {
            document.getElementById('scheduleDate').value = request.scheduled_date;
          }
          if (request.start_time) {
            document.getElementById('scheduleStartTime').value = request.start_time;
          }
          if (request.end_time) {
            document.getElementById('scheduleEndTime').value = request.end_time;
          }
        }

        document.getElementById('scheduleModal').classList.add('active');
      };

      document.getElementById('cancelSchedule')?.addEventListener('click', () => {
        document.getElementById('scheduleModal').classList.remove('active');
        schedulingRequestId = null;
      });

      document.getElementById('scheduleForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Use the stored request ID
        const targetRequestId = schedulingRequestId || selectedRequestId || window.selectedRequestId;

        if (!targetRequestId) {
          alert('Kein Request ausgewÃ¤hlt');
          return;
        }

        const artistId = document.getElementById('scheduleArtist').value;
        const date = document.getElementById('scheduleDate').value;
        const startTime = document.getElementById('scheduleStartTime').value;
        const endTime = document.getElementById('scheduleEndTime').value;

        try {
          // Get artist name
          const { data: artist } = await supabase
            .from('artists')
            .select('name')
            .eq('id', artistId)
            .single();

          const { error } = await supabase
            .from('requests')
            .update({
              status: 'scheduled',
              artist_id: artistId,
              artist_name: artist?.name,
              scheduled_date: date,
              start_time: startTime,
              end_time: endTime
            })
            .eq('id', targetRequestId);

          if (error) throw error;

          document.getElementById('scheduleModal').classList.remove('active');
          document.getElementById('scheduleForm').reset();

          // Nur diesen einen Request im Cache aktualisieren
          await refreshSingleRequest(targetRequestId);
          showRequestDetail(targetRequestId);

          schedulingRequestId = null;
          alert('Appointment scheduled successfully!');
        } catch (err) {
          alert('Error scheduling appointment: ' + err.message);
        }
      });
      
      // Cancel Appointment
      window.cancelAppointment = function() {
        document.getElementById('cancelModal').classList.add('active');
      };
      
      document.getElementById('cancelCancelModal')?.addEventListener('click', () => {
        document.getElementById('cancelModal').classList.remove('active');
      });
      
      document.getElementById('cancelForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const reason = document.getElementById('cancelReason').value;
        
        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'canceled',
              cancel_reason: reason
            })
            .eq('id', selectedRequestId);
          
          if (error) throw error;
          
          document.getElementById('cancelModal').classList.remove('active');
          document.getElementById('cancelForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('Appointment canceled');
        } catch (err) {
          alert('Error canceling appointment: ' + err.message);
        }
      });

      // Edit Request Functions
      let editingRequestId = null;

      window.editRequest = async function(requestId) {
        editingRequestId = requestId;
        selectedRequestId = requestId;

        // Find the request
        const request = allRequests.find(r => r.id === requestId);
        if (!request) {
          alert('Request not found');
          return;
        }

        console.log('âœï¸ Editing request in full frame:', request);

        const detailEl = document.getElementById('requestDetail');

        // Status display names
        const statusNames = {
          'open_request': 'New',
          'pending': 'Pending',
          'scheduled': 'Scheduled',
          'finished': 'Finished',
          'canceled': 'Canceled'
        };

        // Get customer data
        const customer = {
          first_name: request.first_name,
          last_name: request.last_name,
          email: request.email,
          phone: request.customer_phone,
          rank: request.customer?.rank || null,
          instagram: request.customer?.instagram || request.instagram || null
        };

        // Rank badge styling
        const rankBadgeStyle = customer.rank ? {
          'Platinum': 'background:#FFD700; color:#1d1d1f;',
          'Gold': 'background:#FF8C00; color:white;',
          'Silver': 'background:#C0C0C0; color:#1d1d1f;',
          'Bronze': 'background:#CD7F32; color:white;'
        }[customer.rank] || '' : '';

        detailEl.innerHTML = `
          <form id="fullFrameEditForm" style="height:100%; display:flex; flex-direction:column;">
            <div style="flex:1; overflow-y:auto;">
              <div style="margin-bottom:24px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                  <h2 style="margin:0; font-size:24px; font-weight:600;">
                    Edit Request: ${request.request_number || `#${request.id.substring(0, 8).toUpperCase()}`}
                  </h2>
                  <span class="request-badge ${request.status}" style="font-size:13px; padding:6px 16px;">
                    ${statusNames[request.status] || request.status}
                  </span>
                </div>
                ${request.location ? `
                  <div style="color:var(--muted); font-size:14px;">
                    ${request.location.name}${request.location.city ? ` (${request.location.city})` : ''}
                  </div>
                ` : ''}
              </div>

              <!-- Customer Information -->
              <div class="detail-section">
                <h3>Customer Information</h3>
                <div class="detail-grid">
                  <div class="detail-item">
                    <div class="detail-label">Vorname</div>
                    <input type="text" id="fullEditFirstName" value="${request.first_name || ''}" required
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Nachname
                      ${customer.rank ? `
                        <span style="display:inline-block; margin-left:8px; padding:4px 10px; border-radius:999px; font-size:11px; font-weight:600; ${rankBadgeStyle}">
                          ${customer.rank}
                        </span>
                      ` : ''}
                    </div>
                    <input type="text" id="fullEditLastName" value="${request.last_name || ''}" required
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <input type="email" id="fullEditEmail" value="${request.email || ''}" required
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Phone</div>
                    <input type="tel" id="fullEditPhone" value="${request.customer_phone || ''}" required
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Instagram</div>
                    <input type="text" id="fullEditInstagram" value="${request.instagram || ''}" placeholder="@username"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                </div>
              </div>

              <!-- Request Details -->
              <div class="detail-section">
                <h3>Request Details</h3>
                <div class="detail-grid">
                  <div class="detail-item">
                    <div class="detail-label">Priority</div>
                    <select id="fullEditPriority" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                      <option value="">-- Select Priority --</option>
                      <option value="low" ${request.priority === 'low' ? 'selected' : ''}>Low ðŸ’¤</option>
                      <option value="normal" ${request.priority === 'normal' ? 'selected' : ''}>Normal âœ“</option>
                      <option value="high" ${request.priority === 'high' ? 'selected' : ''}>High âš¡</option>
                      <option value="urgent" ${request.priority === 'urgent' ? 'selected' : ''}>Urgent ðŸ”¥</option>
                    </select>
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Placement</div>
                    <input type="text" id="fullEditPlacement" value="${request.placement || ''}" placeholder="No entry data"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Size</div>
                    <input type="text" id="fullEditSize" value="${request.size || ''}" placeholder="No entry data"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Style</div>
                    <input type="text" id="fullEditStyle" value="${request.style || ''}" placeholder="No entry data"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Colorway</div>
                    <input type="text" id="fullEditColorway" value="${request.colorway || ''}" placeholder="No entry data"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item" style="grid-column:1/-1;">
                    <div class="detail-label">Description</div>
                    <textarea id="fullEditDescription" rows="4" placeholder="No entry data"
                              style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px; resize:vertical;">${request.description || ''}</textarea>
                  </div>
                </div>
              </div>

              <!-- Reference Images -->
              <div class="detail-section">
                <h3>Reference Images</h3>
                <div id="existingReferenceImages" class="reference-images-editable">
                  ${request.reference_images && request.reference_images.length > 0
                    ? request.reference_images.map((img, idx) => `
                      <div class="reference-image-editable" data-image-url="${img}">
                        <img src="${img}" alt="Reference ${idx + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                        <button type="button" class="reference-image-delete" onclick="deleteReferenceImage('${img}')" title="Delete image">Ã—</button>
                      </div>
                    `).join('')
                    : '<div class="no-data-placeholder">No reference images</div>'
                  }
                </div>

                <input type="file" id="imageUploadInput" accept="image/jpeg,image/jpg,image/png,image/webp" multiple style="display:none;">

                <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageUploadInput').click()">
                  <div class="image-upload-icon">ðŸ“¸</div>
                  <div class="image-upload-text"><strong>Click to upload</strong> or drag and drop</div>
                  <div class="image-upload-hint">JPG, PNG, WebP (Max 5MB per file)</div>
                </div>

                <div id="uploadProgress" style="display:none; margin-top:12px;">
                  <div style="background:rgba(0,0,0,0.05); border-radius:8px; height:8px; overflow:hidden;">
                    <div id="uploadProgressBar" style="background:var(--accent); height:100%; width:0%; transition:width 0.3s;"></div>
                  </div>
                  <div id="uploadProgressText" style="font-size:12px; color:var(--muted); margin-top:6px; text-align:center;"></div>
                </div>
              </div>

              <!-- Artist Assignment -->
              <div class="detail-section">
                <h3>Artist Assignment</h3>
                <div class="detail-item">
                  <div class="detail-label">Search Artist</div>
                  <input type="text" id="fullEditArtistSearch" placeholder="Type to search artists..."
                         style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  <div id="fullEditArtistSearchResults" style="display:none; max-height:200px; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); border-radius:8px; margin-top:8px; background:white;"></div>
                  <input type="hidden" id="fullEditArtistId" value="${request.artist_id || ''}">
                  <div id="fullEditSelectedArtist" style="margin-top:8px; font-size:13px; color:var(--muted);">
                    ${request.artist ? `Selected: ${request.artist.name}` : ''}
                  </div>
                  <!-- Availability Calendar Container -->
                  <div id="artistAvailabilityCalendar" style="display:none;"></div>
                </div>
              </div>

              <!-- Hidden fields for appointment data (filled by availability calendar) -->
              <input type="hidden" id="fullEditScheduledDate" value="${request.scheduled_date || ''}">
              <input type="hidden" id="fullEditStartTime" value="${request.start_time || ''}">
              <input type="hidden" id="fullEditEndTime" value="${request.end_time || ''}">

              <!-- Payment & Pricing -->
              <div class="detail-section">
                <h3>Payment & Pricing</h3>
                <div class="detail-grid">
                  <div class="detail-item">
                    <div class="detail-label">Gesamtpreis (â‚¬)</div>
                    <input type="number" id="fullEditTotalAmount" value="${request.total_amount || ''}"
                           step="0.01" min="0" placeholder="z.B. 500.00"
                           style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                  </div>
                  <div class="detail-item">
                    <div class="detail-label">Payment Status</div>
                    <select id="fullEditPaymentStatus" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                      <option value="unpaid" ${request.payment_status === 'unpaid' ? 'selected' : ''}>Unpaid</option>
                      <option value="deposit_paid" ${request.payment_status === 'deposit_paid' ? 'selected' : ''}>Deposit Paid</option>
                      <option value="fully_paid" ${request.payment_status === 'fully_paid' ? 'selected' : ''}>Fully Paid</option>
                      <option value="refunded" ${request.payment_status === 'refunded' ? 'selected' : ''}>Refunded</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Work Process -->
              <div class="detail-section">
                <h3>ðŸŽ¨ Work Process</h3>
                <div class="detail-item">
                  <div class="detail-label">Art des Termins</div>
                  <select id="fullEditWorkProcess" style="width:100%; padding:8px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; font-size:14px;">
                    <option value="Consultation" ${request.work_process === 'Consultation' ? 'selected' : ''}>Consultation</option>
                    <option value="New Tattoo" ${request.work_process === 'New Tattoo' || !request.work_process ? 'selected' : ''}>New Tattoo</option>
                    <option value="Continuing Tattoo" ${request.work_process === 'Continuing Tattoo' ? 'selected' : ''}>Continuing Tattoo</option>
                    <option value="Touch Up" ${request.work_process === 'Touch Up' ? 'selected' : ''}>Touch Up</option>
                    <option value="WannaDo" ${request.work_process === 'WannaDo' ? 'selected' : ''}>WannaDo</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Action Button (Fixed Footer) -->
            <div style="margin-top:24px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.1); background:rgba(255,255,255,0.95);">
              <button type="submit" class="btn" style="background:var(--ink); color:white; border:none; width:100%; padding:14px;">
                ðŸ’¾ Save Changes
              </button>
            </div>
          </form>
        `;

        // Setup artist search for full frame edit
        const fullEditArtistSearch = document.getElementById('fullEditArtistSearch');
        const fullEditArtistSearchResults = document.getElementById('fullEditArtistSearchResults');

        if (fullEditArtistSearch) {
          fullEditArtistSearch.addEventListener('input', async (e) => {
            const query = e.target.value.trim().toLowerCase();

            if (query.length < 2) {
              fullEditArtistSearchResults.style.display = 'none';
              return;
            }

            const filteredArtists = allArtists.filter(artist =>
              artist.name.toLowerCase().includes(query)
            );

            if (filteredArtists.length === 0) {
              fullEditArtistSearchResults.innerHTML = '<div style="padding:12px; color:var(--muted); font-size:13px;">No artists found</div>';
              fullEditArtistSearchResults.style.display = 'block';
              return;
            }

            fullEditArtistSearchResults.innerHTML = filteredArtists.map(artist => `
              <div
                onclick="selectFullEditArtist('${artist.id}', '${artist.name.replace(/'/g, "\\'")}')"
                style="padding:12px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.05); transition:background 0.2s;"
                onmouseover="this.style.background='rgba(0,0,0,0.03)'"
                onmouseout="this.style.background='white'">
                <div style="font-weight:500; font-size:14px;">${artist.name}</div>
                ${artist.specialty ? `<div style="font-size:12px; color:var(--muted); margin-top:2px;">${artist.specialty}</div>` : ''}
              </div>
            `).join('');

            fullEditArtistSearchResults.style.display = 'block';
          });
        }

        // Setup form submission
        document.getElementById('fullFrameEditForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await saveFullFrameEdit();
        });

        // Setup image upload handlers
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imageUploadInput = document.getElementById('imageUploadInput');

        // Drag and drop handlers
        imageUploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          imageUploadArea.classList.add('drag-over');
        });

        imageUploadArea.addEventListener('dragleave', (e) => {
          e.preventDefault();
          imageUploadArea.classList.remove('drag-over');
        });

        imageUploadArea.addEventListener('drop', async (e) => {
          e.preventDefault();
          imageUploadArea.classList.remove('drag-over');
          const files = Array.from(e.dataTransfer.files).filter(file =>
            file.type.match(/^image\/(jpeg|jpg|png|webp)$/i)
          );
          if (files.length > 0) {
            await uploadReferenceImages(files);
          }
        });

        // File input handler
        imageUploadInput.addEventListener('change', async (e) => {
          const files = Array.from(e.target.files);
          if (files.length > 0) {
            await uploadReferenceImages(files);
          }
          imageUploadInput.value = ''; // Reset input
        });

        // Zeige Kalender wenn bereits Artist ausgewÃ¤hlt
        if (request.artist_id && request.artist?.name) {
          setTimeout(() => {
            showArtistAvailabilityCalendar(request.artist_id, request.artist.name);
          }, 100);
        }
      };

      // Helper functions for full frame edit
      window.selectFullEditArtist = async function(artistId, artistName) {
        document.getElementById('fullEditArtistId').value = artistId;
        document.getElementById('fullEditArtistSearch').value = artistName;
        document.getElementById('fullEditSelectedArtist').textContent = `Selected: ${artistName}`;
        document.getElementById('fullEditArtistSearchResults').style.display = 'none';

        // Aktiviert Date-Picker wenn Artist ausgewÃ¤hlt wird
        onArtistSelected(artistId);

        // Zeige VerfÃ¼gbarkeitskalender
        if (artistId) {
          await showArtistAvailabilityCalendar(artistId, artistName);
        } else {
          hideArtistAvailabilityCalendar();
        }
      };

      /**
       * Wird aufgerufen wenn Artist ausgewÃ¤hlt/entfernt wird
       * Setzt die versteckten Appointment-Felder zurÃ¼ck wenn kein Artist
       */
      function onArtistSelected(artistId) {
        // Werte zurÃ¼cksetzen wenn Artist entfernt wird
        if (!artistId) {
          const dateInput = document.getElementById('fullEditScheduledDate');
          const startTimeInput = document.getElementById('fullEditStartTime');
          const endTimeInput = document.getElementById('fullEditEndTime');

          if (dateInput) dateInput.value = '';
          if (startTimeInput) startTimeInput.value = '';
          if (endTimeInput) endTimeInput.value = '';
        }
      }

      window.onArtistSelected = onArtistSelected;

      // ========================================
      // Artist Availability Calendar System
      // ========================================

      let artistAvailabilityData = [];
      let selectedAvailabilityArtistId = null;
      let availabilityCalendarMonth = new Date();
      let selectedAppointmentDate = null;
      let selectedStartTime = null;
      let selectedEndTime = null;

      /**
       * LÃ¤dt VerfÃ¼gbarkeitsdaten fÃ¼r einen Artist aus der dienstplan Tabelle
       */
      async function loadArtistAvailability(artistId) {
        if (!artistId) {
          artistAvailabilityData = [];
          return;
        }

        const today = new Date();
        const oneYearLater = new Date();
        oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);

        try {
          const { data, error } = await supabase
            .from('dienstplan')
            .select('id, start_date, end_date, state, working_start, working_end')
            .eq('artist_id', artistId)
            .eq('state', 'Available')
            .gte('start_date', today.toISOString().split('T')[0])
            .lte('start_date', oneYearLater.toISOString().split('T')[0])
            .order('start_date', { ascending: true });

          if (error) {
            console.error('Error loading artist availability:', error);
            artistAvailabilityData = [];
            return;
          }

          artistAvailabilityData = data || [];
          console.log(`âœ… Loaded ${artistAvailabilityData.length} availability entries for artist`);
        } catch (err) {
          console.error('Exception loading availability:', err);
          artistAvailabilityData = [];
        }
      }

      /**
       * Zeigt den VerfÃ¼gbarkeitskalender fÃ¼r den ausgewÃ¤hlten Artist
       */
      async function showArtistAvailabilityCalendar(artistId, artistName) {
        selectedAvailabilityArtistId = artistId;
        availabilityCalendarMonth = new Date();
        selectedAppointmentDate = null;
        selectedStartTime = null;
        selectedEndTime = null;

        // Lade VerfÃ¼gbarkeitsdaten
        await loadArtistAvailability(artistId);

        const container = document.getElementById('artistAvailabilityCalendar');
        if (!container) return;

        container.style.display = 'block';
        renderAvailabilityCalendar(artistName);
      }

      /**
       * Versteckt den VerfÃ¼gbarkeitskalender
       */
      function hideArtistAvailabilityCalendar() {
        const container = document.getElementById('artistAvailabilityCalendar');
        if (container) {
          container.style.display = 'none';
          container.innerHTML = '';
        }
        artistAvailabilityData = [];
        selectedAvailabilityArtistId = null;
      }

      /**
       * Rendert den Kalender fÃ¼r den aktuellen Monat
       */
      function renderAvailabilityCalendar(artistName) {
        const container = document.getElementById('artistAvailabilityCalendar');
        if (!container) return;

        const today = new Date();
        const currentMonth = availabilityCalendarMonth.getMonth();
        const currentYear = availabilityCalendarMonth.getFullYear();
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        const adjustedStartDay = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;

        // Max date (1 year from today)
        const maxDate = new Date();
        maxDate.setFullYear(maxDate.getFullYear() + 1);

        // Check if we can navigate
        const canGoPrev = currentYear > today.getFullYear() ||
                          (currentYear === today.getFullYear() && currentMonth > today.getMonth());
        const canGoNext = currentYear < maxDate.getFullYear() ||
                          (currentYear === maxDate.getFullYear() && currentMonth < maxDate.getMonth());

        const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni',
                            'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];

        // Build available dates set for quick lookup
        const availableDates = new Set();
        artistAvailabilityData.forEach(entry => {
          const start = new Date(entry.start_date);
          const end = entry.end_date ? new Date(entry.end_date) : start;
          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            availableDates.add(d.toISOString().split('T')[0]);
          }
        });

        let html = `
          <div class="availability-calendar-container">
            <div class="availability-calendar-layout">
              <div class="availability-calendar-left">
                <div class="availability-calendar-header">
                  <div class="availability-calendar-title">
                    <span>ðŸ“…</span>
                    <span>${artistName || 'Artist'}</span>
                  </div>
                  <div class="availability-calendar-nav">
                    <button type="button" onclick="navigateAvailabilityCalendar(-1)" ${!canGoPrev ? 'disabled' : ''}>â€¹</button>
                    <span class="availability-calendar-month">${monthNames[currentMonth]} ${currentYear}</span>
                    <button type="button" onclick="navigateAvailabilityCalendar(1)" ${!canGoNext ? 'disabled' : ''}>â€º</button>
                  </div>
                </div>

                <div class="availability-calendar-weekdays">
                  <div class="availability-calendar-weekday">Mo</div>
                  <div class="availability-calendar-weekday">Di</div>
                  <div class="availability-calendar-weekday">Mi</div>
                  <div class="availability-calendar-weekday">Do</div>
                  <div class="availability-calendar-weekday">Fr</div>
                  <div class="availability-calendar-weekday">Sa</div>
                  <div class="availability-calendar-weekday">So</div>
                </div>

                <div class="availability-calendar-days">
        `;

        // Empty cells before first day
        for (let i = 0; i < adjustedStartDay; i++) {
          html += `<div class="availability-calendar-day empty"></div>`;
        }

        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(currentYear, currentMonth, day);
          const dateStr = date.toISOString().split('T')[0];
          const isToday = dateStr === today.toISOString().split('T')[0];
          const isPast = date < new Date(today.toDateString());
          const isAvailable = availableDates.has(dateStr) && !isPast;
          const isSelected = selectedAppointmentDate === dateStr;

          let dayClass = 'availability-calendar-day';
          if (isToday) dayClass += ' today';
          if (isPast) {
            dayClass += ' past';
          } else if (isAvailable) {
            dayClass += ' available';
          } else {
            dayClass += ' unavailable';
          }
          if (isSelected) dayClass += ' selected';

          const clickHandler = isAvailable ? `onclick="selectAvailabilityDate('${dateStr}')"` : '';

          html += `<div class="${dayClass}" ${clickHandler}>${day}</div>`;
        }

        html += `
                </div>
              </div>

              <div class="availability-calendar-right ${!selectedAppointmentDate ? 'empty' : ''}" id="timeSlotsColumn">
                ${!selectedAppointmentDate ? '<span>ðŸ‘† WÃ¤hle einen grÃ¼nen Tag</span>' : ''}
                <div id="timeSlotsContainer"></div>
                <div id="selectedTimeDisplay"></div>
              </div>
            </div>
          </div>
        `;

        container.innerHTML = html;

        // Wenn bereits ein Datum ausgewÃ¤hlt war, zeige Time Slots
        if (selectedAppointmentDate) {
          showTimeSlots(selectedAppointmentDate);
        }
      }

      /**
       * Navigiert im Kalender vor/zurÃ¼ck
       */
      function navigateAvailabilityCalendar(direction) {
        availabilityCalendarMonth.setMonth(availabilityCalendarMonth.getMonth() + direction);

        const artistName = document.getElementById('fullEditArtistSearch')?.value || 'Artist';
        renderAvailabilityCalendar(artistName);
      }

      window.navigateAvailabilityCalendar = navigateAvailabilityCalendar;

      /**
       * WÃ¤hlt ein Datum aus und zeigt die verfÃ¼gbaren Time Slots
       */
      function selectAvailabilityDate(dateStr) {
        selectedAppointmentDate = dateStr;
        selectedStartTime = null;
        selectedEndTime = null;

        // Update calendar display
        document.querySelectorAll('.availability-calendar-day').forEach(el => {
          el.classList.remove('selected');
        });
        event.target.classList.add('selected');

        showTimeSlots(dateStr);
        updateSelectedTimeDisplay();
      }

      window.selectAvailabilityDate = selectAvailabilityDate;

      /**
       * Zeigt die verfÃ¼gbaren 30-Minuten Time Slots fÃ¼r ein Datum
       */
      function showTimeSlots(dateStr) {
        // Remove empty state from right column
        const rightColumn = document.getElementById('timeSlotsColumn');
        if (rightColumn) {
          rightColumn.classList.remove('empty');
          // Remove placeholder text if exists
          const placeholder = rightColumn.querySelector('span');
          if (placeholder && placeholder.textContent.includes('WÃ¤hle')) {
            placeholder.remove();
          }
        }

        const container = document.getElementById('timeSlotsContainer');
        if (!container) return;

        // Finde die VerfÃ¼gbarkeit fÃ¼r dieses Datum
        const availability = artistAvailabilityData.find(entry => {
          const start = new Date(entry.start_date);
          const end = entry.end_date ? new Date(entry.end_date) : start;
          const checkDate = new Date(dateStr);
          return checkDate >= start && checkDate <= end;
        });

        if (!availability) {
          container.innerHTML = `<p style="color:#86868b; font-size:13px; margin-top:12px;">Keine VerfÃ¼gbarkeit fÃ¼r dieses Datum gefunden.</p>`;
          return;
        }

        const workingStart = availability.working_start || '09:00:00';
        const workingEnd = availability.working_end || '21:00:00';

        // Parse times
        const [startHour, startMin] = workingStart.split(':').map(Number);
        const [endHour, endMin] = workingEnd.split(':').map(Number);

        // Generate 30-minute slots
        const slots = [];
        let currentHour = startHour;
        let currentMin = startMin;

        while (currentHour < endHour || (currentHour === endHour && currentMin < endMin)) {
          const timeStr = `${String(currentHour).padStart(2, '0')}:${String(currentMin).padStart(2, '0')}`;
          slots.push(timeStr);

          currentMin += 30;
          if (currentMin >= 60) {
            currentMin = 0;
            currentHour++;
          }
        }

        // Format date for display
        const dateObj = new Date(dateStr);
        const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
        const formattedDate = `${dayNames[dateObj.getDay()]}, ${dateObj.getDate()}.${dateObj.getMonth() + 1}.${dateObj.getFullYear()}`;

        let html = `
          <div class="time-slots-container">
            <div class="time-slots-header">
              <span class="time-slots-title">â° Startzeit wÃ¤hlen</span>
              <span class="time-slots-date">${formattedDate}</span>
            </div>
            <div class="time-slots-grid">
        `;

        slots.forEach(slot => {
          const isSelected = selectedStartTime === slot;
          html += `
            <div class="time-slot ${isSelected ? 'selected' : ''}"
                 onclick="selectStartTime('${slot}', '${workingEnd.substring(0,5)}')">
              ${slot}
            </div>
          `;
        });

        html += `
            </div>
            <div id="endTimeSection"></div>
          </div>
        `;

        container.innerHTML = html;

        // Wenn bereits Startzeit ausgewÃ¤hlt, zeige Endzeit-Auswahl
        if (selectedStartTime) {
          showEndTimeSlots(selectedStartTime, workingEnd.substring(0, 5));
        }
      }

      /**
       * WÃ¤hlt eine Startzeit aus
       */
      function selectStartTime(timeStr, maxEndTime) {
        selectedStartTime = timeStr;
        selectedEndTime = null;

        // Update UI
        document.querySelectorAll('.time-slots-grid .time-slot').forEach(el => {
          el.classList.remove('selected');
          if (el.textContent.trim() === timeStr) {
            el.classList.add('selected');
          }
        });

        showEndTimeSlots(timeStr, maxEndTime);
        updateSelectedTimeDisplay();
      }

      window.selectStartTime = selectStartTime;

      /**
       * Zeigt die Endzeit-Auswahl (basierend auf Startzeit)
       */
      function showEndTimeSlots(startTime, maxEndTime) {
        const container = document.getElementById('endTimeSection');
        if (!container) return;

        const [startHour, startMin] = startTime.split(':').map(Number);
        const [maxHour, maxMin] = maxEndTime.split(':').map(Number);

        // Generate end time slots (mindestens 30 min nach Start)
        const slots = [];
        let currentHour = startHour;
        let currentMin = startMin + 30;

        if (currentMin >= 60) {
          currentMin = 0;
          currentHour++;
        }

        while (currentHour < maxHour || (currentHour === maxHour && currentMin <= maxMin)) {
          const timeStr = `${String(currentHour).padStart(2, '0')}:${String(currentMin).padStart(2, '0')}`;
          slots.push(timeStr);

          currentMin += 30;
          if (currentMin >= 60) {
            currentMin = 0;
            currentHour++;
          }
        }

        // Add max end time if not already included
        if (!slots.includes(maxEndTime) && slots.length > 0) {
          slots.push(maxEndTime);
        }

        let html = `
          <div class="end-time-section">
            <div class="end-time-label">ðŸ Endzeit wÃ¤hlen</div>
            <div class="time-slots-grid">
        `;

        slots.forEach(slot => {
          const isSelected = selectedEndTime === slot;
          html += `
            <div class="time-slot ${isSelected ? 'selected' : ''}"
                 onclick="selectEndTime('${slot}')">
              ${slot}
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;

        container.innerHTML = html;
      }

      /**
       * WÃ¤hlt eine Endzeit aus und aktualisiert die Form-Felder
       */
      function selectEndTime(timeStr) {
        selectedEndTime = timeStr;

        // Update UI
        document.querySelectorAll('#endTimeSection .time-slot').forEach(el => {
          el.classList.remove('selected');
          if (el.textContent.trim() === timeStr) {
            el.classList.add('selected');
          }
        });

        // Update form fields
        updateAppointmentFields();
        updateSelectedTimeDisplay();
      }

      window.selectEndTime = selectEndTime;

      /**
       * Aktualisiert die versteckten Form-Felder mit den ausgewÃ¤hlten Werten
       */
      function updateAppointmentFields() {
        const dateInput = document.getElementById('fullEditScheduledDate');
        const startTimeInput = document.getElementById('fullEditStartTime');
        const endTimeInput = document.getElementById('fullEditEndTime');

        if (dateInput && selectedAppointmentDate) {
          dateInput.value = selectedAppointmentDate;
        }

        if (startTimeInput && selectedStartTime) {
          startTimeInput.value = selectedStartTime;
        }

        if (endTimeInput && selectedEndTime) {
          endTimeInput.value = selectedEndTime;
        }
      }

      /**
       * Zeigt die aktuelle Auswahl an
       */
      function updateSelectedTimeDisplay() {
        const container = document.getElementById('selectedTimeDisplay');
        if (!container) return;

        if (!selectedAppointmentDate || !selectedStartTime || !selectedEndTime) {
          container.innerHTML = '';
          return;
        }

        const dateObj = new Date(selectedAppointmentDate);
        const formattedDate = `${dateObj.getDate()}.${dateObj.getMonth() + 1}.${dateObj.getFullYear()}`;

        container.innerHTML = `
          <div class="selected-time-display">
            <div class="selected-time-info">
              <span class="selected-time-date">ðŸ“… ${formattedDate}</span>
              <span class="selected-time-range">â° ${selectedStartTime} - ${selectedEndTime} Uhr</span>
            </div>
            <button type="button" class="selected-time-clear" onclick="clearTimeSelection()">
              âœ• ZurÃ¼cksetzen
            </button>
          </div>
        `;
      }

      /**
       * Setzt die Zeitauswahl zurÃ¼ck
       */
      function clearTimeSelection() {
        selectedAppointmentDate = null;
        selectedStartTime = null;
        selectedEndTime = null;

        // Clear form fields
        const dateInput = document.getElementById('fullEditScheduledDate');
        const startTimeInput = document.getElementById('fullEditStartTime');
        const endTimeInput = document.getElementById('fullEditEndTime');

        if (dateInput) dateInput.value = '';
        if (startTimeInput) startTimeInput.value = '10:00';
        if (endTimeInput) endTimeInput.value = '12:00';

        // Re-render calendar
        const artistName = document.getElementById('fullEditArtistSearch')?.value || 'Artist';
        renderAvailabilityCalendar(artistName);
      }

      window.clearTimeSelection = clearTimeSelection;

      // Make functions globally available
      window.showArtistAvailabilityCalendar = showArtistAvailabilityCalendar;
      window.hideArtistAvailabilityCalendar = hideArtistAvailabilityCalendar;

      // Upload reference images
      window.uploadReferenceImages = async function(files) {
        if (!editingRequestId) return;

        const maxSize = 5 * 1024 * 1024; // 5MB
        const validFiles = files.filter(file => {
          if (file.size > maxSize) {
            alert(`File ${file.name} is too large. Maximum size is 5MB.`);
            return false;
          }
          return true;
        });

        if (validFiles.length === 0) return;

        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadProgressText = document.getElementById('uploadProgressText');

        try {
          uploadProgress.style.display = 'block';
          uploadProgressText.textContent = 'Uploading...';

          const request = allRequests.find(r => r.id === editingRequestId);
          const currentImages = request?.reference_images || [];
          const newImageUrls = [];

          for (let i = 0; i < validFiles.length; i++) {
            const file = validFiles[i];
            const progress = ((i + 1) / validFiles.length) * 100;
            uploadProgressBar.style.width = `${progress * 0.8}%`; // Reserve 20% for DB update
            uploadProgressText.textContent = `Uploading ${i + 1} of ${validFiles.length}...`;

            const fileExt = file.name.split('.').pop();
            const fileName = `${editingRequestId}_${Date.now()}_${i}.${fileExt}`;

            // Upload to Supabase Storage
            const { data: uploadData, error: uploadError } = await supabase.storage
              .from('request-images')
              .upload(fileName, file, {
                cacheControl: '3600',
                upsert: false
              });

            if (uploadError) throw uploadError;

            // Get public URL
            const { data: { publicUrl } } = supabase.storage
              .from('request-images')
              .getPublicUrl(fileName);

            newImageUrls.push(publicUrl);
          }

          // Update database with new images
          uploadProgressBar.style.width = '90%';
          uploadProgressText.textContent = 'Saving...';

          const updatedImages = [...currentImages, ...newImageUrls];

          const { error: updateError } = await supabase
            .from('requests')
            .update({ reference_images: updatedImages })
            .eq('id', editingRequestId);

          if (updateError) throw updateError;

          uploadProgressBar.style.width = '100%';
          uploadProgressText.textContent = 'Upload complete!';

          // Reload nur diesen einen Request
          await refreshSingleRequest(editingRequestId);
          const updatedRequest = allRequests.find(r => r.id === editingRequestId);

          // Update the image display
          const existingReferenceImages = document.getElementById('existingReferenceImages');
          if (updatedRequest.reference_images && updatedRequest.reference_images.length > 0) {
            existingReferenceImages.innerHTML = updatedRequest.reference_images.map((img, idx) => `
              <div class="reference-image-editable" data-image-url="${img}">
                <img src="${img}" alt="Reference ${idx + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                <button type="button" class="reference-image-delete" onclick="deleteReferenceImage('${img}')" title="Delete image">Ã—</button>
              </div>
            `).join('');
          }

          setTimeout(() => {
            uploadProgress.style.display = 'none';
            uploadProgressBar.style.width = '0%';
          }, 2000);

        } catch (err) {
          console.error('Error uploading images:', err);
          alert('âŒ Error uploading images: ' + err.message);
          uploadProgress.style.display = 'none';
          uploadProgressBar.style.width = '0%';
        }
      };

      // Delete reference image
      window.deleteReferenceImage = async function(imageUrl) {
        if (!editingRequestId) return;

        const confirmed = confirm('Are you sure you want to delete this image?');
        if (!confirmed) return;

        try {
          const request = allRequests.find(r => r.id === editingRequestId);
          const currentImages = request?.reference_images || [];
          const updatedImages = currentImages.filter(img => img !== imageUrl);

          // Update database
          const { error: updateError } = await supabase
            .from('requests')
            .update({ reference_images: updatedImages })
            .eq('id', editingRequestId);

          if (updateError) throw updateError;

          // Extract filename from URL and delete from storage
          const urlParts = imageUrl.split('/');
          const fileName = urlParts[urlParts.length - 1];

          const { error: deleteError } = await supabase.storage
            .from('request-images')
            .remove([fileName]);

          if (deleteError) {
            console.warn('Warning: Could not delete file from storage:', deleteError);
          }

          // Reload nur diesen einen Request
          await refreshSingleRequest(editingRequestId);
          const updatedRequest = allRequests.find(r => r.id === editingRequestId);

          // Update the image display
          const existingReferenceImages = document.getElementById('existingReferenceImages');
          if (updatedRequest.reference_images && updatedRequest.reference_images.length > 0) {
            existingReferenceImages.innerHTML = updatedRequest.reference_images.map((img, idx) => `
              <div class="reference-image-editable" data-image-url="${img}">
                <img src="${img}" alt="Reference ${idx + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2216%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                <button type="button" class="reference-image-delete" onclick="deleteReferenceImage('${img}')" title="Delete image">Ã—</button>
              </div>
            `).join('');
          } else {
            existingReferenceImages.innerHTML = '<div class="no-data-placeholder">No reference images</div>';
          }

        } catch (err) {
          console.error('Error deleting image:', err);
          alert('âŒ Error deleting image: ' + err.message);
        }
      };

      window.saveFullFrameEdit = async function() {
        if (!editingRequestId) return;

        try {
          // Parse total_amount as float
          const totalAmountValue = document.getElementById('fullEditTotalAmount')?.value;
          const totalAmount = totalAmountValue ? parseFloat(totalAmountValue) : null;

          const updateData = {
            first_name: document.getElementById('fullEditFirstName').value,
            last_name: document.getElementById('fullEditLastName').value,
            email: document.getElementById('fullEditEmail').value,
            customer_phone: document.getElementById('fullEditPhone').value,
            instagram: document.getElementById('fullEditInstagram').value,
            priority: document.getElementById('fullEditPriority').value,
            placement: document.getElementById('fullEditPlacement').value,
            size: document.getElementById('fullEditSize').value,
            style: document.getElementById('fullEditStyle').value,
            colorway: document.getElementById('fullEditColorway').value,
            description: document.getElementById('fullEditDescription').value,
            scheduled_date: document.getElementById('fullEditScheduledDate').value || null,
            start_time: document.getElementById('fullEditStartTime').value || null,
            end_time: document.getElementById('fullEditEndTime').value || null,
            // Status wird nicht mehr im Edit Window geÃ¤ndert
            artist_id: document.getElementById('fullEditArtistId').value || null,
            total_amount: totalAmount,
            payment_status: document.getElementById('fullEditPaymentStatus')?.value || 'unpaid',
            work_process: document.getElementById('fullEditWorkProcess')?.value || 'New Tattoo'
          };

          const { error } = await supabase
            .from('requests')
            .update(updateData)
            .eq('id', editingRequestId);

          if (error) throw error;

          // Nur diesen einen Request im Cache aktualisieren
          await refreshSingleRequest(editingRequestId);
          showRequestDetail(editingRequestId);

          alert('âœ… Request updated successfully!');
          editingRequestId = null;
        } catch (err) {
          console.error('Error updating request:', err);
          alert('âŒ Error updating request: ' + err.message);
        }
      };

      window.cancelFullFrameEdit = function() {
        if (editingRequestId) {
          showRequestDetail(editingRequestId);
          editingRequestId = null;
        } else {
          closeRequestDetail();
        }
      };

      window.scheduleFromEdit = async function() {
        if (!editingRequestId) return;

        // First save current changes
        const confirmed = confirm('Do you want to save your changes before scheduling?');
        if (confirmed) {
          await saveFullFrameEdit();
        }

        // Open schedule modal
        selectedRequestId = editingRequestId;
        await scheduleAppointment();
      };

      window.resetRequestToOpenFullFrame = async function() {
        if (!editingRequestId) return;

        const confirmed = confirm('Are you sure you want to reset this request to "Open Request" status?\n\nThis will remove any assignment and scheduling information.');
        if (!confirmed) return;

        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'open_request',
              assigned_to: null,
              assigned_to_user_id: null,
              artist_id: null,
              scheduled_date: null,
              start_time: null,
              end_time: null
            })
            .eq('id', editingRequestId);

          if (error) throw error;

          await loadRequests();
          showRequestDetail(editingRequestId);

          alert('âœ… Request has been reset to Open Request status');
          editingRequestId = null;
        } catch (err) {
          console.error('Error resetting request:', err);
          alert('âŒ Error resetting request: ' + err.message);
        }
      };

      window.deleteRequestPermanentlyFullFrame = async function() {
        if (!editingRequestId) return;

        const confirmed1 = confirm('âš ï¸ WARNING: Are you sure you want to DELETE this request permanently?\n\nThis action CANNOT be undone and will remove the request from ALL databases!');
        if (!confirmed1) return;

        const confirmed2 = confirm('âš ï¸ FINAL WARNING: This will permanently delete the request and ALL associated data.\n\nType "DELETE" in the next dialog to confirm.');
        if (!confirmed2) return;

        const deleteConfirmation = prompt('Type "DELETE" to confirm permanent deletion:');
        if (deleteConfirmation !== 'DELETE') {
          alert('Deletion cancelled - confirmation text did not match.');
          return;
        }

        try {
          const { error } = await supabase
            .from('requests')
            .delete()
            .eq('id', editingRequestId);

          if (error) throw error;

          await loadRequests();
          closeRequestDetail();

          alert('âœ… Request has been permanently deleted');
          editingRequestId = null;
        } catch (err) {
          console.error('Error deleting request:', err);
          alert('âŒ Error deleting request: ' + err.message);
        }
      };

      // Artist search functionality for edit form
      const editArtistSearch = document.getElementById('editArtistSearch');
      const editArtistSearchResults = document.getElementById('editArtistSearchResults');

      if (editArtistSearch) {
        editArtistSearch.addEventListener('input', async (e) => {
          const query = e.target.value.trim().toLowerCase();

          if (query.length < 2) {
            editArtistSearchResults.style.display = 'none';
            return;
          }

          // Filter artists
          const filteredArtists = allArtists.filter(artist =>
            artist.name.toLowerCase().includes(query)
          );

          if (filteredArtists.length === 0) {
            editArtistSearchResults.innerHTML = '<div style="padding:12px; color:var(--muted); font-size:13px;">No artists found</div>';
            editArtistSearchResults.style.display = 'block';
            return;
          }

          editArtistSearchResults.innerHTML = filteredArtists.map(artist => `
            <div
              onclick="selectEditArtist('${artist.id}', '${artist.name.replace(/'/g, "\\'")}')"
              style="padding:12px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.05); transition:background 0.2s;"
              onmouseover="this.style.background='rgba(0,0,0,0.03)'"
              onmouseout="this.style.background='white'">
              <div style="font-weight:500; font-size:14px;">${artist.name}</div>
              ${artist.specialty ? `<div style="font-size:12px; color:var(--muted); margin-top:2px;">${artist.specialty}</div>` : ''}
            </div>
          `).join('');

          editArtistSearchResults.style.display = 'block';
        });
      }

      // Select artist from search results
      window.selectEditArtist = function(artistId, artistName) {
        document.getElementById('editArtistId').value = artistId;
        document.getElementById('editArtistSearch').value = artistName;
        document.getElementById('editSelectedArtist').textContent = `Selected: ${artistName}`;
        document.getElementById('editArtistSearchResults').style.display = 'none';
      };

      document.getElementById('cancelEditRequest')?.addEventListener('click', () => {
        document.getElementById('editRequestModal').classList.remove('active');
        editingRequestId = null;
      });

      // Submit handler for edit request form
      document.getElementById('editRequestForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!editingRequestId) return;

        try {
          const updateData = {
            first_name: document.getElementById('editFirstName').value,
            last_name: document.getElementById('editLastName').value,
            email: document.getElementById('editEmail').value,
            customer_phone: document.getElementById('editPhone').value,
            instagram: document.getElementById('editInstagram').value,
            priority: document.getElementById('editPriority').value,
            placement: document.getElementById('editPlacement').value,
            size: document.getElementById('editSize').value,
            style: document.getElementById('editStyle').value,
            colorway: document.getElementById('editColorway').value,
            description: document.getElementById('editDescription').value,
            scheduled_date: document.getElementById('editScheduledDate').value || null,
            start_time: document.getElementById('editStartTime').value || null,
            end_time: document.getElementById('editEndTime').value || null,
            status: document.getElementById('editStatus').value,
            artist_id: document.getElementById('editArtistId').value || null
          };

          const { error } = await supabase
            .from('requests')
            .update(updateData)
            .eq('id', editingRequestId);

          if (error) throw error;

          document.getElementById('editRequestModal').classList.remove('active');

          // Nur diesen einen Request im Cache aktualisieren (statt alle neu laden)
          await refreshSingleRequest(editingRequestId);

          // Reload detail view if still showing this request
          if (selectedRequestId === editingRequestId) {
            showRequestDetail(selectedRequestId);
          }

          // Show appropriate success message
          if (updateData.status === 'scheduled') {
            alert('âœ… Request scheduled successfully!\n\nðŸ“… An appointment has been automatically created in the appointments table.');
            console.log('âœ… Request scheduled - Appointment auto-created by SQL trigger');
          } else {
            alert('âœ… Request updated successfully!');
          }

          editingRequestId = null;
        } catch (err) {
          console.error('Error updating request:', err);
          alert('âŒ Error updating request: ' + err.message);
        }
      });

      // Create Request Button - Opens Create Request Modal
      document.getElementById('createRequestBtn')?.addEventListener('click', () => {
        // Load locations into dropdown
        const locationSelect = document.getElementById('createLocation');
        if (locationSelect && allLocations) {
          locationSelect.innerHTML = '<option value="">-- Select Location --</option>';
          allLocations.forEach(location => {
            const option = document.createElement('option');
            option.value = location.id;
            option.textContent = `${location.name}${location.city ? ` (${location.city})` : ''}`;
            locationSelect.appendChild(option);
          });
        }
        document.getElementById('createRequestModal').classList.add('active');
      });

      // Cancel Create Request
      document.getElementById('cancelCreateRequest')?.addEventListener('click', () => {
        document.getElementById('createRequestModal').classList.remove('active');
        document.getElementById('createRequestForm').reset();
      });

      // Submit handler for create request form
      document.getElementById('createRequestForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        try {
          // Collect form data
          const firstName = document.getElementById('createFirstName').value;
          const lastName = document.getElementById('createLastName').value;
          const email = document.getElementById('createEmail').value;
          const phone = document.getElementById('createPhone').value;
          const instagram = document.getElementById('createInstagram').value || null;

          // Find or create customer to link the request
          let customerId = null;
          try {
            customerId = await findOrCreateCustomer({
              first_name: firstName,
              last_name: lastName,
              email: email,
              phone: phone,
              instagram: instagram
            });
            console.log('âœ… Customer linked:', customerId);
          } catch (customerErr) {
            console.warn('âš ï¸ Could not link customer:', customerErr);
            // Continue without customer_id - not critical
          }

          const requestData = {
            first_name: firstName,
            last_name: lastName,
            email: email,
            customer_phone: phone,
            instagram: instagram,
            customer_id: customerId,  // Link to customer
            priority: document.getElementById('createPriority').value || 'normal',
            placement: document.getElementById('createPlacement').value || null,
            size: document.getElementById('createSize').value || null,
            style: document.getElementById('createStyle').value || null,
            colorway: document.getElementById('createColorway').value || null,
            description: document.getElementById('createDescription').value || null,
            location_id: document.getElementById('createLocation').value,
            status: 'open_request',
            origin: document.getElementById('createOrigin').value,
            booking_type: 'request',
            payment_status: 'unpaid'
          };

          const { data, error } = await supabase
            .from('requests')
            .insert([requestData])
            .select()
            .single();

          if (error) throw error;

          // Neuen Request mit Relations laden und zum Cache hinzufÃ¼gen (statt alle neu laden)
          if (data && data.id) {
            const { data: newRequestWithRelations } = await supabase
              .from('requests')
              .select(`
                *,
                customer:customers(id, first_name, last_name, email, phone, rank, instagram),
                artist:artists(id, name, email, instagram),
                location:locations!requests_location_id_fkey(id, name, city)
              `)
              .eq('id', data.id)
              .single();

            if (newRequestWithRelations) {
              addRequestToCache(newRequestWithRelations);
            }
          }

          document.getElementById('createRequestModal').classList.remove('active');
          document.getElementById('createRequestForm').reset();

          alert('âœ… Request created successfully!');
        } catch (err) {
          console.error('Error creating request:', err);
          alert('âŒ Error creating request: ' + err.message);
        }
      });

      window.resetRequestToOpen = async function() {
        if (!editingRequestId) return;

        // Confirmation dialog
        const confirmed = confirm('Are you sure you want to reset this request to "Open Request" status?\n\nThis will remove any assignment and scheduling information.');

        if (!confirmed) return;

        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'open_request',
              assigned_to: null,
              assigned_to_user_id: null,
              artist_id: null,
              scheduled_date: null,
              start_time: null,
              end_time: null
            })
            .eq('id', editingRequestId);

          if (error) throw error;

          document.getElementById('editRequestModal').classList.remove('active');
          await loadRequests();

          // Close detail view or reload it
          selectedRequestId = null;
          closeRequestDetail();

          alert('âœ… Request has been reset to Open Request status');
          editingRequestId = null;
        } catch (err) {
          console.error('Error resetting request:', err);
          alert('âŒ Error resetting request: ' + err.message);
        }
      };

      window.deleteRequestPermanently = async function() {
        if (!editingRequestId) return;

        // First confirmation
        const confirmed1 = confirm('âš ï¸ WARNING: Are you sure you want to DELETE this request permanently?\n\nThis action CANNOT be undone and will remove the request from ALL databases!');

        if (!confirmed1) return;

        // Second confirmation
        const confirmed2 = confirm('âš ï¸ FINAL WARNING: This will permanently delete the request and ALL associated data.\n\nType "DELETE" in the next dialog to confirm.');

        if (!confirmed2) return;

        // Third confirmation with text input
        const deleteConfirmation = prompt('Type "DELETE" to confirm permanent deletion:');

        if (deleteConfirmation !== 'DELETE') {
          alert('âŒ Deletion cancelled. You must type "DELETE" exactly to confirm.');
          return;
        }

        try {
          // Delete from requests table
          const { error } = await supabase
            .from('requests')
            .delete()
            .eq('id', editingRequestId);

          if (error) throw error;

          document.getElementById('editRequestModal').classList.remove('active');
          await loadRequests();

          // Close detail view
          selectedRequestId = null;
          closeRequestDetail();

          alert('âœ… Request has been permanently deleted from all databases');
          editingRequestId = null;
        } catch (err) {
          console.error('Error deleting request:', err);
          alert('âŒ Error deleting request: ' + err.message);
        }
      };

      // Edit Appointment for Scheduled Requests
      window.editAppointment = async function() {
        const request = allRequests.find(r => r.id === selectedRequestId);
        if (!request) return;

        // Load artists
        const { data: artists } = await supabase.from('artists').select('*');
        const artistSelect = document.getElementById('editAppointmentArtist');
        artistSelect.innerHTML = '<option value="">-- Select Artist --</option>' +
          (artists || []).map(a => `<option value="${a.id}">${a.name}</option>`).join('');

        // Pre-fill form with current values
        document.getElementById('editAppointmentArtist').value = request.artist_id || '';
        document.getElementById('editAppointmentDate').value = request.scheduled_date || '';
        document.getElementById('editAppointmentStartTime').value = request.start_time || '';
        document.getElementById('editAppointmentEndTime').value = request.end_time || '';

        document.getElementById('editAppointmentModal').classList.add('active');
      };

      document.getElementById('cancelEditAppointment')?.addEventListener('click', () => {
        document.getElementById('editAppointmentModal').classList.remove('active');
      });

      document.getElementById('editAppointmentForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const artistId = document.getElementById('editAppointmentArtist').value;
        const date = document.getElementById('editAppointmentDate').value;
        const startTime = document.getElementById('editAppointmentStartTime').value;
        const endTime = document.getElementById('editAppointmentEndTime').value;

        try {
          // Get artist name
          const { data: artist } = await supabase
            .from('artists')
            .select('name')
            .eq('id', artistId)
            .single();

          const { error } = await supabase
            .from('requests')
            .update({
              artist_id: artistId,
              scheduled_date: date,
              start_time: startTime,
              end_time: endTime
            })
            .eq('id', selectedRequestId);

          if (error) throw error;

          document.getElementById('editAppointmentModal').classList.remove('active');
          document.getElementById('editAppointmentForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('âœ… Appointment updated successfully!');
        } catch (err) {
          console.error('Error updating appointment:', err);
          alert('âŒ Error updating appointment: ' + err.message);
        }
      });

      // Reset Appointment (clear appointment details but keep status scheduled)
      window.resetAppointment = async function() {
        if (!confirm('Are you sure you want to reset this appointment?\n\nThis will clear the artist, date, and time details but keep the request in "Scheduled" status.')) {
          return;
        }

        try {
          const { error } = await supabase
            .from('requests')
            .update({
              artist_id: null,
              scheduled_date: null,
              start_time: null,
              end_time: null
            })
            .eq('id', selectedRequestId);

          if (error) throw error;

          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('âœ… Appointment details reset successfully!');
        } catch (err) {
          console.error('Error resetting appointment:', err);
          alert('âŒ Error resetting appointment: ' + err.message);
        }
      };

      // Cancel Appointment Request (set status to canceled)
      window.cancelAppointmentRequest = function() {
        document.getElementById('cancelModal').classList.add('active');
      };

      // Delete Request (direct delete with confirmation)
      // @param {string} requestId - Optional Request ID (falls back to selectedRequestId)
      window.deleteRequest = async function(requestId) {
        const idToDelete = requestId || selectedRequestId;

        if (!idToDelete) {
          alert('Keine Request ID');
          return;
        }

        if (!confirm('âš ï¸ Request wirklich lÃ¶schen?\n\nDiese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden.')) {
          return;
        }

        try {
          const { error } = await supabase
            .from('requests')
            .delete()
            .eq('id', idToDelete);

          if (error) throw error;

          console.log('âœ… Request deleted:', idToDelete);

          // Aus Cache entfernen
          const index = allRequests.findIndex(r => r.id === idToDelete);
          if (index !== -1) {
            allRequests.splice(index, 1);
          }

          selectedRequestId = null;
          closeRequestDetail();

          // Liste neu rendern
          if (typeof filterAndRenderRequests === 'function') {
            filterAndRenderRequests();
          } else {
            await loadRequests();
          }

          alert('âœ… Request wurde gelÃ¶scht');
        } catch (err) {
          console.error('âŒ Delete error:', err);
          alert('Fehler beim LÃ¶schen: ' + err.message);
        }
      };

      /**
       * Soft Delete - Request in Deleted Tab verschieben
       */
      async function softDeleteRequest(requestId) {
        if (!confirm('Request loeschen? Er kann innerhalb von 5 Tagen wiederhergestellt werden.')) return;

        var currentUser = window.currentUsername || 'Unknown';

        try {
          var now = new Date().toISOString();

          // Request soft delete in DB
          var updateResult = await supabase.from('requests').update({
            deleted_at: now,
            deleted_by: currentUser
          }).eq('id', requestId);

          if (updateResult.error) throw updateResult.error;

          // Activity Log
          await supabase.from('request_activity_log').insert({
            request_id: requestId,
            action: 'deleted',
            action_by: currentUser,
            details: { deleted_at: now }
          });

          // WICHTIG: Lokalen Cache aktualisieren
          var requestsArray = window.allRequests || allRequests || [];
          for (var i = 0; i < requestsArray.length; i++) {
            if (requestsArray[i].id === requestId) {
              requestsArray[i].deleted_at = now;
              requestsArray[i].deleted_by = currentUser;
              break;
            }
          }

          // Detail schlieÃŸen
          if (typeof closeRequestDetail === 'function') closeRequestDetail();

          // WICHTIG: Zu Deleted Tab wechseln und neu rendern
          var deletedTab = document.querySelector('[data-status="deleted"]');
          if (deletedTab) deletedTab.click();

          // Badges aktualisieren
          if (typeof updateRequestBadges === 'function') updateRequestBadges();

          alert('Request wurde geloescht.');
        } catch (err) {
          console.error('Delete error:', err);
          alert('Fehler: ' + (err.message || err));
        }
      }
      window.softDeleteRequest = softDeleteRequest;

      /**
       * Permanent Delete - Endgueltig loeschen
       */
      async function permanentDeleteRequest(requestId) {
        if (!confirm('ACHTUNG: Request ENDGUELTIG loeschen? Dies kann NICHT rueckgaengig gemacht werden!')) return;

        try {
          await supabase.from('requests').delete().eq('id', requestId);

          if (typeof closeRequestDetail === 'function') closeRequestDetail();
          if (typeof filterAndRenderRequests === 'function') filterAndRenderRequests();

          alert('Request wurde permanent geloescht.');
        } catch (err) {
          alert('Fehler: ' + err.message);
        }
      }
      window.permanentDeleteRequest = permanentDeleteRequest;

      /**
       * Restore - Wiederherstellen aus Deleted/Canceled
       */
      async function restoreRequest(requestId) {
        var currentUser = window.currentUsername || 'Unknown';

        try {
          // Request laden um vorherigen Status zu ermitteln
          var result = await supabase.from('requests').select('*').eq('id', requestId).single();
          var request = result.data;

          // Neuer Status: pending (oder open_request wenn nie assigned)
          var newStatus = request.assigned_to ? 'pending' : 'open_request';

          await supabase.from('requests').update({
            deleted_at: null,
            deleted_by: null,
            restored_at: new Date().toISOString(),
            restored_by: currentUser,
            status: request.status === 'canceled' ? newStatus : request.status,
            last_action: 'restored',
            last_action_at: new Date().toISOString()
          }).eq('id', requestId);

          // Activity Log
          await supabase.from('request_activity_log').insert({
            request_id: requestId,
            action: 'restored',
            action_by: currentUser,
            details: { previous_status: request.status, new_status: newStatus }
          });

          if (typeof closeRequestDetail === 'function') closeRequestDetail();
          if (typeof filterAndRenderRequests === 'function') filterAndRenderRequests();

          alert('Request wurde wiederhergestellt.');
        } catch (err) {
          alert('Fehler: ' + err.message);
        }
      }
      window.restoreRequest = restoreRequest;

      /**
       * Cancel - Ohne Email, nur Status Ã¤ndern
       */
      async function cancelRequest(requestId) {
        if (!confirm('Request wirklich canceln? Es wird KEINE Email gesendet.')) return;

        var currentUser = window.currentUsername || 'Unknown';
        var now = new Date().toISOString();

        try {
          // Request updaten
          var updateResult = await supabase.from('requests').update({
            status: 'canceled',
            last_action: 'canceled',
            last_action_at: now
          }).eq('id', requestId);

          if (updateResult.error) throw updateResult.error;

          // Appointment auch canceln falls vorhanden
          var reqResult = await supabase.from('requests').select('appointment_id').eq('id', requestId).single();
          if (reqResult.data && reqResult.data.appointment_id) {
            await supabase.from('appointments').update({
              status: 'canceled',
              canceled_at: now,
              cancel_reason: 'manual_cancel'
            }).eq('id', reqResult.data.appointment_id);
          }

          // Activity Log
          await supabase.from('request_activity_log').insert({
            request_id: requestId,
            action: 'canceled',
            action_by: currentUser,
            details: { email_sent: false }
          });

          // WICHTIG: Lokalen Cache aktualisieren
          var requestsArray = window.allRequests || allRequests || [];
          for (var i = 0; i < requestsArray.length; i++) {
            if (requestsArray[i].id === requestId) {
              requestsArray[i].status = 'canceled';
              requestsArray[i].last_action = 'canceled';
              requestsArray[i].last_action_at = now;
              break;
            }
          }

          // Detail schlieÃŸen
          if (typeof closeRequestDetail === 'function') closeRequestDetail();

          // WICHTIG: Zu Canceled Tab wechseln
          var canceledTab = document.querySelector('[data-status="canceled"]');
          if (canceledTab) canceledTab.click();

          // Badges aktualisieren
          if (typeof updateRequestBadges === 'function') updateRequestBadges();

          alert('Request wurde gecancelt.');
        } catch (err) {
          console.error('Cancel error:', err);
          alert('Fehler: ' + (err.message || err));
        }
      }
      window.cancelRequest = cancelRequest;

      /**
       * Stornierung - Mit Email senden
       */
      async function storniereRequest(requestId) {
        if (!confirm('Request stornieren und Stornierungsmail senden?')) return;

        var currentUser = window.currentUsername || 'Unknown';
        var btn = event ? event.target : null;
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = 'Wird storniert...';
        }

        try {
          // Request laden
          var reqResult = await supabase.from('requests')
            .select('*, customer:customers(*), artist:artists(*)')
            .eq('id', requestId)
            .single();
          var request = reqResult.data;

          // Stornierungsmail senden via Edge Function
          var response = await fetch('https://auxxyehgzkozdjylhqnx.supabase.co/functions/v1/send-cancellation-email', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1eHh5ZWhnemtvemRqeWxocW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDczODgsImV4cCI6MjA3NjEyMzM4OH0.bg8NunF2qkps28Aj0ZqY35eKK--QOu8NduCkFyqp5KA'
            },
            body: JSON.stringify({ request_id: requestId, action_by: currentUser })
          });

          var result = await response.json();

          // Request Status updaten
          await supabase.from('requests').update({
            status: 'canceled',
            last_action: 'storniert',
            last_action_at: new Date().toISOString()
          }).eq('id', requestId);

          // Activity Log
          await supabase.from('request_activity_log').insert({
            request_id: requestId,
            action: 'storniert',
            action_by: currentUser,
            details: { email_sent: result.success, email_sent_to: request.email || request.customer?.email }
          });

          if (typeof closeRequestDetail === 'function') closeRequestDetail();
          if (typeof filterAndRenderRequests === 'function') filterAndRenderRequests();

          alert('Request wurde storniert und Email versendet.');
        } catch (err) {
          alert('Fehler: ' + err.message);
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = 'Stornierung';
          }
        }
      }
      window.storniereRequest = storniereRequest;

      /**
       * Reschedule - ZurÃ¼ck zu Pending
       */
      async function rescheduleRequest(requestId) {
        if (!confirm('Request zurueck zu Pending setzen? Der Termin wird zurueckgesetzt.')) return;

        var currentUser = window.currentUsername || 'Unknown';

        try {
          await supabase.from('requests').update({
            status: 'pending',
            last_action: 'rescheduled',
            last_action_at: new Date().toISOString()
          }).eq('id', requestId);

          // Activity Log
          await supabase.from('request_activity_log').insert({
            request_id: requestId,
            action: 'rescheduled',
            action_by: currentUser,
            details: { previous_status: 'scheduled' }
          });

          if (typeof closeRequestDetail === 'function') closeRequestDetail();
          if (typeof filterAndRenderRequests === 'function') filterAndRenderRequests();

          alert('Request wurde zurueck zu Pending gesetzt.');
        } catch (err) {
          alert('Fehler: ' + err.message);
        }
      }
      window.rescheduleRequest = rescheduleRequest;

      /**
       * Edit Infos - Nur bestimmte Felder editierbar
       */
      async function editRequestInfos(requestId) {
        // Oeffnet Edit Modal aber mit eingeschraenkten Feldern
        // Nur: placement, size, style, colorway, description, start_time, end_time
        window.editMode = 'infos_only';
        await editRequest(requestId);
      }
      window.editRequestInfos = editRequestInfos;

      /**
       * Einzelnes Bild herunterladen
       */
      async function downloadSingleImage(imageUrl, filename) {
        try {
          var response = await fetch(imageUrl);
          var blob = await response.blob();
          var extension = imageUrl.split('.').pop().split('?')[0] || 'jpg';
          var a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = filename + '.' + extension;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(a.href);
        } catch (err) {
          console.error('Download error:', err);
          // Fallback: In neuem Tab Ã¶ffnen
          window.open(imageUrl, '_blank');
        }
      }
      window.downloadSingleImage = downloadSingleImage;

      /**
       * Alle Bilder eines Requests herunterladen
       */
      async function downloadAllImages(requestId) {
        var requestsArray = window.allRequests || allRequests || [];
        var request = requestsArray.find(function(r) { return r.id === requestId; });

        if (!request || !request.reference_images || request.reference_images.length === 0) {
          alert('Keine Bilder vorhanden');
          return;
        }

        var images = request.reference_images;
        var customerName = ((request.first_name || '') + '_' + (request.last_name || '')).replace(/\s+/g, '_') || 'customer';

        for (var i = 0; i < images.length; i++) {
          var img = images[i];
          var imgUrl = typeof img === 'string' ? img : (img.url || img.path || '');
          if (imgUrl) {
            await downloadSingleImage(imgUrl, customerName + '_ref_' + (i + 1));
            // Kleine Pause zwischen Downloads
            await new Promise(function(resolve) { setTimeout(resolve, 500); });
          }
        }
      }
      window.downloadAllImages = downloadAllImages;

      /**
       * Bild in Modal Ã¶ffnen (Vollansicht)
       */
      function openImageModal(imageUrl) {
        // Existierendes Modal entfernen falls vorhanden
        var existingModal = document.getElementById('image-modal');
        if (existingModal) existingModal.remove();

        var modal = document.createElement('div');
        modal.id = 'image-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;cursor:pointer';
        modal.onclick = function() { document.body.removeChild(modal); };

        var img = document.createElement('img');
        img.src = imageUrl;
        img.style.cssText = 'max-width:90%;max-height:90%;object-fit:contain;border-radius:8px';

        var downloadBtn = document.createElement('button');
        downloadBtn.innerHTML = 'â¬‡ Download';
        downloadBtn.style.cssText = 'position:absolute;bottom:20px;right:20px;padding:12px 24px;background:#0071e3;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer';
        downloadBtn.onclick = function(e) {
          e.stopPropagation();
          downloadSingleImage(imageUrl, 'reference_image');
        };

        var closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = 'position:absolute;top:20px;right:20px;width:40px;height:40px;background:rgba(255,255,255,0.2);color:white;border:none;border-radius:50%;font-size:20px;cursor:pointer';
        closeBtn.onclick = function(e) {
          e.stopPropagation();
          document.body.removeChild(modal);
        };

        modal.appendChild(img);
        modal.appendChild(downloadBtn);
        modal.appendChild(closeBtn);
        document.body.appendChild(modal);
      }
      window.openImageModal = openImageModal;

      // Auto-move scheduled to finished (check every minute)
      setInterval(async () => {
        const now = new Date();
        const scheduledRequests = allRequests.filter(r => r.status === 'scheduled' && r.scheduled_date && r.end_time);
        
        for (const req of scheduledRequests) {
          const endDateTime = new Date(`${req.scheduled_date}T${req.end_time}`);
          if (now > endDateTime) {
            await supabase
              .from('requests')
              .update({ status: 'finished' })
              .eq('id', req.id);
          }
        }
        
        if (scheduledRequests.length > 0) {
          await loadRequests();
        }
      }, 60000); // Check every minute

      let currentEditArtistId = null;
      let currentEditCustomerId = null;

      
      // Open Add Artist Modal
      document.getElementById('addArtistBtn')?.addEventListener('click', () => {
        // Reset form
        document.getElementById('addArtistForm')?.reset();
        
        // Open modal (location dropdown is static HTML, no need to populate)
        document.getElementById('addArtistModal').classList.add('active');
      });
      
      // Close Add Artist Modal
      document.getElementById('cancelAddArtist')?.addEventListener('click', () => {
        document.getElementById('addArtistModal').classList.remove('active', 'elevated');
      });
      
      // ============================================
      // ARTISTS FILTER FUNCTIONALITY
      // ============================================

      let artistsCache = [];
      let artistsFiltered = [];
      let currentArtistsPage = 1;
      const artistsPageSize = 50;

      // Image Upload State Management
      let currentEditingArtistId = null;
      let uploadedProfilePicture = null;
      let uploadedBackgroundImage = null;

      async function loadArtists(page = 1) {
        console.log('ðŸ‘¤ Loading artists (page ' + page + ')...');

        try {
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // USE CENTRAL DATA MANAGER
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if (CentralDataManager.isReady()) {
            artistsCache = CentralDataManager.getArtists();
            allArtists = artistsCache;
            console.log(`ðŸŽ¨ Using cached artists: ${artistsCache.length} total`);
          } else if (artistsCache.length === 0) {
            // Fallback: Load from database
            ProgressBar.show('Loading artists...');
            ProgressBar.updateProgress(30, 'Fetching artists from database...');
            const { data, error } = await supabase
              .from('artists')
              .select(`
                *,
                location:locations!location_id(id, name, city)
              `)
              .order('name');

            if (error) throw error;

            artistsCache = data || [];
            console.log('âœ… Loaded', artistsCache.length, 'artists into cache');
          }

          // Apply filters
          applyArtistFilters();

          // Apply sorting
          const sorted = sortArtists(artistsFiltered, artistSortConfig.field, artistSortConfig.order);

          // Pagination
          const startIndex = (page - 1) * artistsPageSize;
          const endIndex = startIndex + artistsPageSize;
          const paginatedArtists = sorted.slice(startIndex, endIndex);

          // Render table
          renderArtistsTable(paginatedArtists);

          // Update results count
          document.getElementById('artistsResultCount').textContent = artistsFiltered.length;

          // Render pagination
          renderArtistsPagination(page);

          currentArtistsPage = page;
          ProgressBar.hide();

        } catch (error) {
          console.error('âŒ Failed to load artists:', error);
          ProgressBar.hide();
          const tbody = document.getElementById('artistsTableBody');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#E53935;">Fehler beim Laden der Artists: ' + error.message + '</td></tr>';
          }
        }
      }

      // Apply Artist Filters
      function applyArtistFilters() {
        const searchTerm = document.getElementById('artistSearchInput')?.value.toLowerCase().trim() || '';
        const locationFilter = document.getElementById('artistLocationFilter')?.value || '';
        const rankFilter = document.getElementById('artistRankFilter')?.value || '';
        const typeFilter = document.getElementById('artistTypeFilter')?.value || '';
        const statusFilter = document.getElementById('artistStatusFilter')?.value || '';

        artistsFiltered = artistsCache.filter(artist => {
          // Search filter (Name, Email, Instagram)
          if (searchTerm) {
            const matchesSearch =
              (artist.name && artist.name.toLowerCase().includes(searchTerm)) ||
              (artist.email && artist.email.toLowerCase().includes(searchTerm)) ||
              (artist.instagram && artist.instagram.toLowerCase().includes(searchTerm));

            if (!matchesSearch) return false;
          }

          // Location filter
          if (locationFilter) {
            if (locationFilter === 'NULL') {
              if (artist.location_id !== null) return false;
            } else {
              if (artist.location_id !== locationFilter) return false;
            }
          }

          // Rank filter
          if (rankFilter) {
            if (artist.rank !== rankFilter) return false;
          }

          // Type filter (Guest/Resident)
          if (typeFilter) {
            const isGuest = artist.is_guest === true;
            if (typeFilter === 'guest' && !isGuest) return false;
            if (typeFilter === 'resident' && isGuest) return false;
          }

          // Status filter (Active/Inactive)
          if (statusFilter) {
            const isActive = artist.active === true;
            if (statusFilter === 'active' && !isActive) return false;
            if (statusFilter === 'inactive' && isActive) return false;
          }

          return true;
        });

        console.log('ðŸ” Filtered:', artistsFiltered.length, 'of', artistsCache.length, 'artists');
      }

      // Filter Artists (debounced for search input)
      let filterArtistsTimeout;
      function filterArtists() {
        clearTimeout(filterArtistsTimeout);
        filterArtistsTimeout = setTimeout(() => {
          loadArtists(1); // Reset to page 1 when filtering
        }, 300);
      }

      // Clear Artist Filters
      function clearArtistFilters() {
        document.getElementById('artistSearchInput').value = '';
        document.getElementById('artistLocationFilter').value = '';
        document.getElementById('artistRankFilter').value = '';
        document.getElementById('artistTypeFilter').value = '';
        document.getElementById('artistStatusFilter').value = '';

        loadArtists(1);
      }

      // Render Artists Table
      function renderArtistsTable(artists) {
        const tbody = document.getElementById('artistsTableBody');
        if (!tbody) return;

        if (artists.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--muted);">Keine Artists gefunden. Versuche andere Filter-Einstellungen.</td></tr>';
          return;
        }

        tbody.innerHTML = artists.map(artist => {
          // Show location from city_location field (text) or location relation
          const locationDisplay = artist.city_location
            ? `<span class="location-badge">${artist.city_location}</span>`
            : (artist.location && artist.location.name)
              ? `<span class="location-badge">${artist.location.name}</span>`
              : '<span style="color:#8E8E93;">Keine</span>';

          return `
            <tr>
              <td>${artist.name || '-'}</td>
              <td>${artist.instagram ? `<span style="color:var(--muted); font-size:13px;">@${artist.instagram}</span>` : '-'}</td>
              <td>${artist.phone || '-'}</td>
              <td><span class="type-badge ${artist.is_guest ? 'guest' : 'resident'}">${artist.is_guest ? 'Guest' : 'Resident'}</span></td>
              <td>${locationDisplay}</td>
              <td><span class="rank-badge rank-${artist.rank || 'R1'}">${artist.rank || 'R1'}</span></td>
              <td><span class="status-badge ${artist.active ? 'active' : 'inactive'}">${artist.active ? 'Aktiv' : 'Inaktiv'}</span></td>
              <td style="text-align:right;">
                <button class="btn btn-primary" onclick="viewArtistProfile('${artist.id}')" style="padding:6px 16px; font-size:13px; background:#1d1d1f; color:white;">View Profile</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Render Artists Pagination
      function renderArtistsPagination(currentPage) {
        const totalPages = Math.ceil(artistsFiltered.length / artistsPageSize);
        const container = document.getElementById('artistsTableBody')?.parentElement?.parentElement;

        if (!container) return;

        // Remove old pagination if exists
        let paginationEl = container.querySelector('.pagination-controls');
        if (paginationEl) paginationEl.remove();

        if (totalPages <= 1) return;

        let html = '<div class="pagination-controls">';

        // Previous
        if (currentPage > 1) {
          html += `<button class="btn-pagination" onclick="loadArtists(${currentPage - 1})">â—€ ZurÃ¼ck</button>`;
        }

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<button class="btn-pagination ${i === currentPage ? 'active' : ''}" onclick="loadArtists(${i})">${i}</button>`;
          } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<span class="pagination-dots">...</span>';
          }
        }

        // Next
        if (currentPage < totalPages) {
          html += `<button class="btn-pagination" onclick="loadArtists(${currentPage + 1})">Weiter â–¶</button>`;
        }

        html += '</div>';
        container.insertAdjacentHTML('beforeend', html);
      }

      let allCustomers = [];
      
      // Customers Cache & Pagination
      let customersCache = [];
      let customersFiltered = [];
      let currentCustomersPage = 1;
      const customersPageSize = 50;

      async function loadCustomers(page = 1) {
        console.log('ðŸ‘¥ Loading customers (page ' + page + ')...');

        try {
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // USE CENTRAL DATA MANAGER
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if (CentralDataManager.isReady()) {
            customersCache = CentralDataManager.getCustomers();
            allCustomers = customersCache;
            console.log(`ðŸ‘¥ Using cached customers: ${customersCache.length} total`);
          } else if (customersCache.length === 0) {
            // Fallback: Load from database
            ProgressBar.show('Loading customers...');
            console.log('ðŸ”„ Loading ALL customers from Supabase in batches...');
            ProgressBar.updateProgress(20, 'Fetching customers from database...');

            let allData = [];
            let from = 0;
            const batchSize = 1000;
            let hasMore = true;

            while (hasMore) {
              const { data, error, count } = await supabase
                .from('customers')
                .select('*', { count: 'exact' })
                .order('created_at', { ascending: false })
                .range(from, from + batchSize - 1);

              if (error) throw error;

              if (data && data.length > 0) {
                allData = allData.concat(data);
                from += batchSize;
                const customerProgress = 20 + Math.min(30, (allData.length / 1000) * 3);
                ProgressBar.updateProgress(customerProgress, `Loading customers (${allData.length} loaded)...`);
                if (data.length < batchSize) {
                  hasMore = false;
                }
              } else {
                hasMore = false;
              }
            }

            customersCache = allData;
            allCustomers = customersCache;
            console.log('âœ… Loaded ALL', customersCache.length, 'customers into cache');
          }

          // Apply filters
          applyCustomerFilters();

          // Apply sorting
          const sorted = sortCustomers(customersFiltered, customerSortConfig.field, customerSortConfig.order);

          // Pagination
          const startIndex = (page - 1) * customersPageSize;
          const endIndex = startIndex + customersPageSize;
          const paginatedCustomers = sorted.slice(startIndex, endIndex);

          // Render table
          renderCustomersTable(paginatedCustomers);

          // Update results count
          document.getElementById('customersResultCount').textContent = customersFiltered.length;

          // Render pagination
          renderCustomersPagination(page);

          currentCustomersPage = page;
          ProgressBar.hide();

        } catch (error) {
          console.error('âŒ Failed to load customers:', error);
          ProgressBar.hide();
          const tbody = document.getElementById('customersTableBody');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#E53935;">Fehler beim Laden der Customers: ' + error.message + '</td></tr>';
          }
        }
      }

      // Make loadCustomers globally accessible for pagination onclick handlers
      window.loadCustomers = loadCustomers;

      // Apply Customer Filters
      function applyCustomerFilters() {
        const searchTerm = document.getElementById('customerSearchInput')?.value.toLowerCase().trim() || '';
        const rankFilter = document.getElementById('customerRankFilter')?.value || '';
        const blacklistFilter = document.getElementById('customerBlacklistFilter')?.value || '';
        const bookingsFilter = document.getElementById('customerBookingsFilter')?.value || '';

        console.log('ðŸ” [Filter Debug] Starting filter with', customersCache.length, 'total customers');
        console.log('ðŸ” [Filter Debug] Search term:', searchTerm ? `"${searchTerm}"` : '(none)');
        console.log('ðŸ” [Filter Debug] Rank filter:', rankFilter || '(none)');
        console.log('ðŸ” [Filter Debug] Blacklist filter:', blacklistFilter || '(none)');
        console.log('ðŸ” [Filter Debug] Bookings filter:', bookingsFilter || '(none)');

        let filteredBySearch = customersCache;

        customersFiltered = customersCache.filter(customer => {
          // Search filter (Name, Email, Phone, Instagram)
          if (searchTerm) {
            const matchesSearch =
              (customer.first_name && customer.first_name.toLowerCase().includes(searchTerm)) ||
              (customer.last_name && customer.last_name.toLowerCase().includes(searchTerm)) ||
              (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
              (customer.phone && customer.phone.toLowerCase().includes(searchTerm)) ||
              (customer.instagram && customer.instagram.toLowerCase().includes(searchTerm));

            if (!matchesSearch) return false;
          }

          // Rank filter
          if (rankFilter) {
            if (customer.rank !== rankFilter) return false;
          }

          // Blacklist filter
          if (blacklistFilter) {
            const isBlacklisted = customer.blacklisted === true;
            if (blacklistFilter === 'true' && !isBlacklisted) return false;
            if (blacklistFilter === 'false' && isBlacklisted) return false;
          }

          // Bookings range filter
          if (bookingsFilter) {
            const bookingsCount = customer.total_bookings || 0;
            if (bookingsFilter === '0' && bookingsCount !== 0) return false;
            if (bookingsFilter === '1-2' && (bookingsCount < 1 || bookingsCount > 2)) return false;
            if (bookingsFilter === '3-5' && (bookingsCount < 3 || bookingsCount > 5)) return false;
            if (bookingsFilter === '6-10' && (bookingsCount < 6 || bookingsCount > 10)) return false;
            if (bookingsFilter === '11+' && bookingsCount < 11) return false;
          }

          return true;
        });

        console.log('âœ… [Filter Debug] Final filtered count:', customersFiltered.length, 'of', customersCache.length, 'customers');

        if (searchTerm && customersFiltered.length === 0) {
          console.warn('âš ï¸ [Filter Debug] Search returned 0 results. Check if search term exists in any customer fields.');
        }
      }

      // Filter Customers with Debouncing
      let filterCustomersTimeout;
      function filterCustomers() {
        clearTimeout(filterCustomersTimeout);
        filterCustomersTimeout = setTimeout(() => {
          loadCustomers(1); // Reset to page 1 when filtering
        }, 300);
      }

      // Clear Customer Filters
      function clearCustomerFilters() {
        document.getElementById('customerSearchInput').value = '';
        document.getElementById('customerRankFilter').value = '';
        document.getElementById('customerBlacklistFilter').value = '';
        document.getElementById('customerBookingsFilter').value = '';
        loadCustomers(1);
      }

      // Render Customers Table
      function renderCustomersTable(customers) {
        const tbody = document.getElementById('customersTableBody');

        if (!tbody) {
          console.error('âŒ customersTableBody not found');
          return;
        }

        if (customers.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--muted);">Keine Customers gefunden</td></tr>';
          return;
        }

        tbody.innerHTML = customers.map(customer => {
          // Rank badge - direkt aus Datenbank (bereits korrekt gesetzt)
          const rank = customer.rank || '';
          const rankDisplayMap = { 'Platinum': 'Platinum', 'platinum': 'Platinum', 'Gold': 'Gold', 'gold': 'Gold', 'Silver': 'Silver', 'silver': 'Silver', 'Silber': 'Silver', 'silber': 'Silver', 'Bronze': 'Bronze', 'bronze': 'Bronze', 'Neukunde': 'Neukunde', 'neukunde': 'Neukunde', 'new_customer': 'Neukunde', '': 'Neukunde' };
          const rankDisplay = rankDisplayMap[rank] || 'Neukunde';
          const rankClass = rank?.toLowerCase() || 'neukunde';
          const rankBadge = `<span class="rank-badge rank-${rankClass}">${rankDisplay}</span>`;

          // Blacklist badge
          const blacklistBadge = customer.blacklisted
            ? '<span style="background:#FEE2E2; color:#991B1B; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:600;">ðŸš« Blacklisted</span>'
            : '';

          // Instagram link
          const instagramDisplay = customer.instagram
            ? `<a href="https://instagram.com/${customer.instagram.replace('@', '')}" target="_blank" style="color:var(--accent);">@${customer.instagram.replace('@', '')}</a>`
            : '-';

          return `
            <tr>
              <td>${customer.first_name || '-'}</td>
              <td>${customer.last_name || '-'}</td>
              <td>${customer.email || '-'}</td>
              <td>${customer.phone || '-'}</td>
              <td>${instagramDisplay}</td>
              <td>${rankBadge} ${blacklistBadge}</td>
              <td style="font-size:13px; color:var(--muted);">${new Date(customer.created_at).toLocaleDateString()}</td>
              <td style="text-align:right;">
                <button class="btn btn-primary" onclick="openCustomerProfile('${customer.id}')" style="padding:6px 16px; font-size:13px; background:#1d1d1f; color:white;">View Profile</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Render Customers Pagination
      function renderCustomersPagination(currentPage) {
        const totalPages = Math.ceil(customersFiltered.length / customersPageSize);
        const container = document.getElementById('customersTableBody')?.parentElement?.parentElement;

        if (!container) return;

        // Remove old pagination if exists
        let paginationEl = container.querySelector('.pagination-controls');
        if (paginationEl) paginationEl.remove();

        if (totalPages <= 1) return;

        let html = '<div class="pagination-controls">';

        // Previous
        if (currentPage > 1) {
          html += `<button class="btn-pagination" onclick="loadCustomers(${currentPage - 1})">â—€ ZurÃ¼ck</button>`;
        }

        // Page numbers with ellipsis
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<button class="btn-pagination ${i === currentPage ? 'active' : ''}" onclick="loadCustomers(${i})">${i}</button>`;
          } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<span class="pagination-dots">...</span>';
          }
        }

        // Next
        if (currentPage < totalPages) {
          html += `<button class="btn-pagination" onclick="loadCustomers(${currentPage + 1})">Weiter â–¶</button>`;
        }

        html += '</div>';
        container.insertAdjacentHTML('beforeend', html);
      }

      // Agreements Functions
      async function loadAgreements() {
        try {
          const dateStr = agreementsDate.toISOString().split('T')[0];

          // Load agreements from agreements table for the selected date
          const { data: agreementData, error } = await supabase
            .from('agreements')
            .select('*')
            .gte('signed_at', `${dateStr}T00:00:00`)
            .lte('signed_at', `${dateStr}T23:59:59`)
            .order('signed_at', { ascending: false });  // Newest first

          if (error) {
            // Check if table doesn't exist (404)
            if (error.code === 'PGRST116' || error.message.includes('relation') || error.message.includes('does not exist')) {
              console.log('Agreements table not yet created - showing empty state');
              renderAgreements([]);
              return;
            }
            throw error;
          }

          console.log(`Agreements loaded for ${dateStr}:`, agreementData?.length);

          // Get artist details
          const agreements = (agreementData || []).map((agreement) => {
            let artistName = '-';
            if (agreement.artist_id) {
              const artist = allArtists.find(a => a.id === agreement.artist_id);
              if (artist) {
                artistName = artist.name;
              }
            }

            const signedTime = new Date(agreement.signed_at);
            const timeStr = signedTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

            return {
              id: agreement.id,
              customerName: agreement.full_name || 'Unknown',
              customerEmail: agreement.email || '-',
              artistName,
              time: timeStr,
              language: agreement.language,
              signatureData: agreement.signature_data
            };
          });

          renderAgreements(agreements);
        } catch (err) {
          console.log("Agreements table not available:", err.message);
          renderAgreements([]);
        }
      }
      
      function renderAgreements(agreements) {
        const tbody = document.getElementById('agreementsTableBody');
        
        if (!agreements || agreements.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px; color:var(--muted);">No agreements for this date</td></tr>';
          return;
        }
        
        tbody.innerHTML = agreements.map(agreement => `
          <tr style="transition:background 0.15s ease;">
            <td>
              <span style="font-weight:500;">${agreement.customerName}</span>
            </td>
            <td>${agreement.customerEmail}</td>
            <td>${agreement.artistName}</td>
            <td style="font-weight:500;">${agreement.time}</td>
            <td style="text-align:center;">
              ${agreement.signatureData 
                ? '<span style="color:#34c759; font-size:20px; font-weight:600;">âœ“</span>' 
                : '<span style="color:#ff3b30; font-size:20px; font-weight:600;">âœ•</span>'}
            </td>
          </tr>
        `).join('');
      }
      
      function updateAgreementsDateDisplay() {
        const dateDisplayEl = document.getElementById('agreementsDateDisplay');
        const datePickerEl = document.getElementById('agreementsDatePickerInput');
        
        if (datePickerEl) {
          datePickerEl.value = agreementsDate.toISOString().split('T')[0];
        }
        
        if (dateDisplayEl) {
          const day = agreementsDate.getDate();
          const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 
                              'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
          const month = monthNames[agreementsDate.getMonth()];
          const year = agreementsDate.getFullYear();
          const weekdayShort = agreementsDate.toLocaleDateString('de-DE', { weekday: 'short' });
          dateDisplayEl.textContent = `${weekdayShort} ${day}. ${month} ${year}`;
        }
      }
      
      // Agreements Date Navigation
      document.getElementById('agreementsPrevDayBtn')?.addEventListener('click', () => {
        agreementsDate.setDate(agreementsDate.getDate() - 1);
        updateAgreementsDateDisplay();
        loadAgreements();
      });
      
      document.getElementById('agreementsNextDayBtn')?.addEventListener('click', () => {
        agreementsDate.setDate(agreementsDate.getDate() + 1);
        updateAgreementsDateDisplay();
        loadAgreements();
      });
      
      document.getElementById('agreementsTodayBtn')?.addEventListener('click', () => {
        agreementsDate = new Date();
        updateAgreementsDateDisplay();
        loadAgreements();
      });
      
      document.getElementById('agreementsDatePickerInput')?.addEventListener('change', (e) => {
        agreementsDate = new Date(e.target.value + 'T12:00:00');
        updateAgreementsDateDisplay();
        loadAgreements();
      });
      
      // Customer Detail Modal
      window.showCustomerDetail = async function(customerId) {
        if (!customerId) return;
        
        try {
          const { data: customer, error } = await supabase
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();
          
          if (error) throw error;
          if (!customer) return;
          
          const content = document.getElementById('customerDetailContent');
          content.innerHTML = `
            <div class="detail-item">
              <div class="detail-label">Name</div>
              <div class="detail-value">${customer.first_name || ''} ${customer.last_name || ''}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Email</div>
              <div class="detail-value">${customer.email || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Phone</div>
              <div class="detail-value">${customer.phone || '-'}</div>
            </div>
            ${customer.rank ? `
              <div class="detail-item">
                <div class="detail-label">Rank</div>
                <div class="detail-value"><span class="customer-rank ${customer.rank.toLowerCase()}">${customer.rank}</span></div>
              </div>
            ` : ''}
            <div class="detail-item">
              <div class="detail-label">Customer Since</div>
              <div class="detail-value">${new Date(customer.created_at).toLocaleDateString('de-DE')}</div>
            </div>
          `;
          
          document.getElementById('customerDetailModal').classList.add('active');
        } catch (err) {
          console.error('Error loading customer:', err);
          alert('Error loading customer details');
        }
      };
      
      document.getElementById('closeCustomerDetail')?.addEventListener('click', () => {
        document.getElementById('customerDetailModal').classList.remove('active');
      });
      
      // File Upload Modal
      window.openFileUpload = async function(eventId) {
        currentAgreementEventId = eventId;
        
        try {
          const { data: event, error } = await supabase
            .from('events')
            .select('title, agreement_file_url, agreement_file_name')
            .eq('id', eventId)
            .single();
          
          if (error) throw error;
          
          // Show existing files if any
          const existingSection = document.getElementById('existingFiles');
          if (event.agreement_file_url) {
            existingSection.innerHTML = `
              <div style="background:var(--location-light); padding:12px; border-radius:8px; margin-bottom:12px;">
                <div style="font-size:13px; font-weight:600; color:var(--location-dark); margin-bottom:4px;">Current File:</div>
                <div style="font-size:14px; color:var(--ink);">${event.agreement_file_name || 'agreement.pdf'}</div>
              </div>
            `;
          } else {
            existingSection.innerHTML = '<div style="color:var(--muted); font-size:13px; margin-bottom:12px;">No files uploaded yet</div>';
          }
          
          document.getElementById('fileUploadModal').classList.add('active');
        } catch (err) {
          console.error('Error loading file info:', err);
        }
      };

      document.getElementById('cancelFileUpload')?.addEventListener('click', () => {
        document.getElementById('fileUploadModal').classList.remove('active');
        document.getElementById('fileUploadInput').value = '';
      });
      
      document.getElementById('fileUploadInput')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          // In a real implementation, upload to Supabase Storage
          // For now, we'll just store the filename
          const { error } = await supabase
            .from('events')
            .update({
              agreement_file_name: file.name,
              agreement_file_url: `uploads/${file.name}` // Placeholder
            })
            .eq('id', currentAgreementEventId);
          
          if (error) throw error;
          
          alert('File uploaded successfully!');
          document.getElementById('fileUploadModal').classList.remove('active');
          document.getElementById('fileUploadInput').value = '';
          loadAgreements();
        } catch (err) {
          console.error('Error uploading file:', err);
          alert('Error uploading file: ' + err.message);
        }
      });


      async function loadEvents() {
        try {
          if (!selectedLocationId) {
            console.log('No location selected');
            events = [];
            return;
          }

          // Parse time without timezone conversion
          const parseLocalTime = (timeStr) => {
            const [datePart, timePart] = timeStr.split('T');
            const [hours, minutes] = timePart.split(':').map(Number);
            return hours + minutes / 60;
          };

          // Calculate date range: Â±2 weeks from current date for better performance
          const startDate = new Date(currentDate);
          startDate.setDate(startDate.getDate() - 14);
          const endDate = new Date(currentDate);
          endDate.setDate(endDate.getDate() + 14);

          const startDateStr = startDate.toISOString().split('T')[0];
          const endDateStr = endDate.toISOString().split('T')[0];

          // Store the loaded date range for future reference
          loadedDateRangeStart = new Date(startDateStr);
          loadedDateRangeEnd = new Date(endDateStr);

          console.log(`Loading events for date range: ${startDateStr} to ${endDateStr}`);

          // 1. Load events from events table with date range filter
          const { data: eventsData, error: eventsError } = await supabase
            .from('events')
            .select('*')
            .eq('location_id', selectedLocationId)
            .gte('start_time', startDateStr)
            .lte('start_time', endDateStr + 'T23:59:59');

          if (eventsError) throw eventsError;

          console.log(`Events loaded for location ${selectedLocationId}:`, eventsData?.length || 0);

          const processedEvents = (eventsData || []).map(e => {
            const artist = allArtists.find(a => a.id === e.artist_id);

            const startHour = parseLocalTime(e.start_time);
            const endHour = parseLocalTime(e.end_time);

            // Determine category:
            // - If no artist_id, it's an 'events' category event
            // - If artist exists and is guest, it's 'guest'
            // - If artist exists and is not guest, it's 'resident'
            let category = 'events';
            if (e.artist_id && artist) {
              category = artist.is_guest ? 'guest' : 'resident';
            }

            return {
              id: e.id,
              date: e.start_time.split('T')[0],
              category: category,
              slot: e.slot || 1, // Use slot from database, default to 1 if not set
              title: e.title || artist?.name || 'Event',
              type: e.type || null,
              artistName: artist?.name || null,
              artistId: artist?.id || e.artist_id || null,
              customerName: e.title || null,
              customerId: null, // Events don't have customers
              attendanceRequired: e.attendance_required || false,
              startHour: startHour,
              endHour: endHour,
              startTimeRaw: e.start_time,
              endTimeRaw: e.end_time,
              isAppointment: false // Flag to distinguish from appointments table entries
            };
          });

          // 2. Load appointments from appointments table with date range filter and batch loading
          let allAppointmentsData = [];
          let hasMore = true;
          let page = 0;
          const pageSize = 1000;

          while (hasMore) {
            const { data: appointmentsBatch, error: appointmentsError } = await supabase
              .from('appointments')
              .select(`
                *,
                customer:customers(first_name, last_name),
                artist:artists(id, name, is_guest)
              `)
              .eq('location_id', selectedLocationId)
              .gte('start', startDateStr)
              .lte('start', endDateStr + 'T23:59:59')
              .not('start', 'is', null)
              .not('end', 'is', null)
              .order('start', { ascending: true })
              .range(page * pageSize, (page + 1) * pageSize - 1);

            if (appointmentsError) {
              console.error('Error loading appointments batch:', appointmentsError);
              hasMore = false;
              break;
            }

            if (appointmentsBatch && appointmentsBatch.length > 0) {
              allAppointmentsData = [...allAppointmentsData, ...appointmentsBatch];
              console.log(`Loaded batch ${page + 1}: ${appointmentsBatch.length} appointments`);

              // If we got less than pageSize, we've reached the end
              if (appointmentsBatch.length < pageSize) {
                hasMore = false;
              } else {
                page++;
              }
            } else {
              hasMore = false;
            }
          }

          console.log(`Total appointments loaded for location ${selectedLocationId}:`, allAppointmentsData.length);

          const processedAppointments = (allAppointmentsData || []).map(apt => {
            const artist = apt.artist || allArtists.find(a => a.email === apt.artist_email);

            const startHour = parseLocalTime(apt.start);
            const endHour = parseLocalTime(apt.end);

            // Determine category based on guest_spot_id or artist type
            let category = 'resident'; // Default to resident
            let isGuestSpotAppointment = false;

            if (apt.guest_spot_id) {
              // Appointment belongs to a Guest Spot â†’ show in Guests category (not Guest Spots)
              // Guest Spots category is only for Availability, appointments get normal category
              category = 'guest';
              isGuestSpotAppointment = true;
            } else if (artist && artist.is_guest) {
              category = 'guest';
            }

            // Build customer name
            const customerName = apt.customer
              ? `${apt.customer.first_name || ''} ${apt.customer.last_name || ''}`.trim()
              : null;

            return {
              id: apt.id,
              date: apt.start.split('T')[0],
              category: category,
              slot: apt.slot || 1,
              title: customerName || 'Customer',
              type: apt.booking_type || null,
              artistName: artist?.name || null,
              artistId: artist?.id || apt.artist_id || null,
              customerName: customerName,
              customerId: apt.customer_id || null,
              attendanceRequired: false,
              startHour: startHour,
              endHour: endHour,
              startTimeRaw: apt.start,
              endTimeRaw: apt.end,
              isAppointment: true, // Flag to distinguish from events table entries
              isGuestSpot: false, // Guest Spot Appointments render as normal appointments (with booking_type colors)
              isGuestSpotAppointment: isGuestSpotAppointment, // Flag for click handler (opens edit modal)
              guestSpotId: apt.guest_spot_id || null,
              // Include all payment and appointment data
              paymentStatus: apt.payment_status || 'unpaid',
              paymentAmount: apt.payment_amount,
              depositAmount: apt.deposit_amount,
              totalAmount: apt.total_amount,
              priceEstimate: apt.price_estimate,
              price: apt.price || apt.total_amount || apt.price_estimate,
              stripePaymentLink: apt.stripe_payment_link,
              projectNumber: apt.project_number,
              customerEmail: apt.customer_email,
              customerPhone: apt.customer_phone,
              placement: apt.placement,
              size: apt.size,
              style: apt.style,
              colorway: apt.colorway,
              instagram: apt.instagram,
              internalNotes: apt.internal_notes,
              customerNotes: apt.customer_notes,
              status: apt.status,
              durationMinutes: apt.duration_minutes,
              workProcess: apt.work_process || null,
              fullData: apt // Store full appointment data for modal
            };
          });

          // Log Guest Spot Appointments count
          const guestSpotAppointmentsCount = processedAppointments.filter(a => a.isGuestSpotAppointment).length;
          if (guestSpotAppointmentsCount > 0) {
            console.log(`ðŸ“… Found ${guestSpotAppointmentsCount} appointments linked to Guest Spots (will show in Guests category with normal booking_type colors)`);
          }

          // 3. Load ARTIST INFOS (internal artist blocks/notes)
          console.log('ðŸ“Œ Loading artist infos...');
          let allArtistInfosData = [];
          page = 0;
          hasMore = true;

          while (hasMore) {
            const { data: artistInfosBatch, error: artistInfosError } = await supabase
              .from('artist_infos')
              .select(`
                *,
                artist:artists(id, name, is_guest, email)
              `)
              .eq('location_id', selectedLocationId)
              .gte('start', startDateStr)
              .lte('start', endDateStr + 'T23:59:59')
              .not('start', 'is', null)
              .not('end', 'is', null)
              .order('start', { ascending: true })
              .range(page * pageSize, (page + 1) * pageSize - 1);

            if (artistInfosError) {
              console.warn('âš ï¸ Error loading artist infos batch:', artistInfosError);
              console.warn('   Artist infos table may not exist yet - skipping');
              hasMore = false;
              break;
            }

            if (artistInfosBatch && artistInfosBatch.length > 0) {
              allArtistInfosData = [...allArtistInfosData, ...artistInfosBatch];
              console.log(`Loaded artist infos batch ${page + 1}: ${artistInfosBatch.length} items`);

              if (artistInfosBatch.length < pageSize) {
                hasMore = false;
              } else {
                page++;
              }
            } else {
              hasMore = false;
            }
          }

          console.log(`âœ… Total artist infos loaded:`, allArtistInfosData.length);

          // Process artist infos
          const processedArtistInfos = (allArtistInfosData || []).map(info => {
            const artist = info.artist || allArtists.find(a => a.id === info.artist_id);

            const startHour = parseLocalTime(info.start);
            const endHour = parseLocalTime(info.end);

            return {
              id: `artist-info-${info.id}`,
              originalId: info.id,
              date: info.start.split('T')[0],
              category: 'artist_info', // Special category for artist infos
              slot: info.slot || 1,
              title: info.notice || 'Artist Note',
              type: 'artist_info',
              artistName: artist?.name || 'Unknown Artist',
              artistId: info.artist_id,
              customerName: null, // Artist infos have no customers
              customerId: null,
              attendanceRequired: false,
              startHour: startHour,
              endHour: endHour,
              startTimeRaw: info.start,
              endTimeRaw: info.end,
              isAppointment: false,
              isArtistInfo: true, // Flag for special rendering
              notice: info.notice,
              fullData: info
            };
          });

          // 4. Load Guest Spots from guest_spot_calendar_view
          let processedGuestSpots = [];
          try {
            // Build query - conditionally include canceled spots
            let guestSpotQuery = supabase
              .from('guest_spot_calendar_view')
              .select('*')
              .eq('location_id', selectedLocationId)
              .gte('entry_date', startDateStr)
              .lte('entry_date', endDateStr);

            // Only filter by active if showCanceledGuestSpots is false
            if (!showCanceledGuestSpots) {
              guestSpotQuery = guestSpotQuery.eq('entry_status', 'active');
            }

            const { data: guestSpotsData, error: guestSpotsError } = await guestSpotQuery;

            if (guestSpotsError) {
              console.error('Error loading guest spots for calendar:', guestSpotsError);
            } else if (guestSpotsData && guestSpotsData.length > 0) {
              console.log(`ðŸ“ Guest spots loaded for calendar: ${guestSpotsData.length}`);

              processedGuestSpots = guestSpotsData.map(gs => {
                // Parse times
                const timeFrom = gs.time_from || '10:00:00';
                const timeTo = gs.time_to || '18:00:00';
                const startHour = parseInt(timeFrom.split(':')[0]) + parseInt(timeFrom.split(':')[1]) / 60;
                const endHour = parseInt(timeTo.split(':')[0]) + parseInt(timeTo.split(':')[1]) / 60;

                return {
                  id: `guest-spot-${gs.id}`,
                  originalId: gs.id,
                  guestSpotId: gs.guest_spot_id,
                  date: gs.entry_date,
                  category: 'guest_spot',
                  slot: gs.slot_number || 1,
                  title: gs.display_title || `Guest Spot - ${gs.artist_name || 'Artist'}`,
                  type: 'guest_spot',
                  artistName: gs.artist_name || 'Unknown Artist',
                  artistId: gs.artist_id,
                  customerName: null,
                  customerId: null,
                  attendanceRequired: false,
                  startHour: startHour,
                  endHour: endHour,
                  startTimeRaw: `${gs.entry_date}T${timeFrom}`,
                  endTimeRaw: `${gs.entry_date}T${timeTo}`,
                  isAppointment: false,
                  isGuestSpot: true,
                  isPaid: gs.is_paid || false,
                  bookingType: gs.booking_type || 'external',
                  spotStatus: gs.spot_status,
                  entryStatus: gs.entry_status,
                  isCanceled: gs.entry_status === 'canceled',
                  // Full data for detail view
                  fullGuestSpotData: gs
                };
              });
            }
          } catch (gsError) {
            console.error('Error in guest spot calendar loading:', gsError);
          }

          // 5. Combine all: events, appointments, artist infos, and guest spots
          events = [...processedEvents, ...processedAppointments, ...processedArtistInfos, ...processedGuestSpots];

          console.log(`Total items in calendar: ${events.length} (${processedEvents.length} events + ${processedAppointments.length} appointments + ${processedArtistInfos.length} artist infos + ${processedGuestSpots.length} guest spots)`);

          // Update Location Info
          const { data: locationData } = await supabase
            .from('locations')
            .select('name')
            .eq('id', selectedLocationId)
            .single();

          const infoDiv = document.getElementById('locationInfo');
          if (infoDiv) {
            const dateRangeText = `${startDateStr} to ${endDateStr}`;
            infoDiv.textContent = `${locationData?.name || 'Location'} â€¢ ${events.length} item${events.length !== 1 ? 's' : ''} (${processedEvents.length} events, ${processedAppointments.length} appointments, ${processedArtistInfos.length} artist notes) â€¢ Date range: ${dateRangeText}`;
          }

          console.log('Processed calendar items:', events);
        } catch(err) {
          console.error("Events error:", err);
          events = [];
        }
      }

      // Make loadEvents globally available
      window.loadEvents = loadEvents;

      // ============================================
      // CREATE EVENT / BOOKING FUNCTIONS (STUBS)
      // ============================================
      // NOTE: These functions are referenced by onclick handlers in the HTML
      // but their full implementation is not yet complete

      window.createEvent = function createEvent() {
        console.warn('âš ï¸ createEvent() called but not fully implemented');
        alert('Event-Erstellung:\n\nDiese Funktion wird derzeit entwickelt.\n\nBitte verwenden Sie vorerst alternative Methoden zum Erstellen von Events oder kontaktieren Sie den Administrator.');
        // TODO: Implement full event creation flow
        // - Show modal with event form
        // - Collect event details (title, start, end, artist_id, location_id)
        // - Validate input
        // - Insert into events table
        // - Reload calendar
      };

      window.createBooking = function createBooking() {
        console.warn('âš ï¸ createBooking() called but not fully implemented');
        alert('Booking-Erstellung:\n\nDiese Funktion wird derzeit entwickelt.\n\nBitte verwenden Sie vorerst alternative Methoden zum Erstellen von Bookings oder kontaktieren Sie den Administrator.');
        // TODO: Implement full booking creation flow
        // - Show modal with booking form
        // - Collect booking details (customer, artist, type, start, end, location_id)
        // - Validate input
        // - Insert into appointments table
        // - Reload calendar
      };

      // ============================================
      // ARTIST INFO MODAL
      // ============================================
      window.openArtistInfoModal = function openArtistInfoModal(infoId, eventData) {
        console.log('ðŸ“Œ Opening artist info modal:', infoId, eventData);

        // Create modal if it doesn't exist
        let modal = document.getElementById('artistInfoModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'artistInfoModal';
          modal.className = 'modal-backdrop';
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
          `;
          document.body.appendChild(modal);

          // Close on backdrop click
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeArtistInfoModal();
            }
          });
        }

        // Format dates
        const formatDateTime = (dateStr) => {
          if (!dateStr) return 'N/A';
          const date = new Date(dateStr);
          return date.toLocaleString('de-DE', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        };

        modal.innerHTML = `
          <div style="background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="padding: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                  ðŸ“Œ Artist Note
                </h2>
                <button onclick="closeArtistInfoModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #86868b; line-height: 1; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.05)'" onmouseout="this.style.background='none'">Ã—</button>
              </div>

              <div style="background: rgba(0,0,0,0.03); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                <div style="font-size: 14px; color: #86868b; margin-bottom: 4px;">Artist</div>
                <div style="font-size: 18px; font-weight: 600;">${eventData.artistName || 'Unknown Artist'}</div>
              </div>

              <div style="background: rgba(0,0,0,0.03); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                <div style="font-size: 14px; color: #86868b; margin-bottom: 4px;">Note</div>
                <div style="font-size: 16px; white-space: pre-wrap;">${eventData.notice || 'No note'}</div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div style="background: rgba(0,0,0,0.03); padding: 16px; border-radius: 12px;">
                  <div style="font-size: 14px; color: #86868b; margin-bottom: 4px;">Start</div>
                  <div style="font-size: 16px; font-weight: 600;">${formatDateTime(eventData.startTimeRaw)}</div>
                </div>
                <div style="background: rgba(0,0,0,0.03); padding: 16px; border-radius: 12px;">
                  <div style="font-size: 14px; color: #86868b; margin-bottom: 4px;">End</div>
                  <div style="font-size: 16px; font-weight: 600;">${formatDateTime(eventData.endTimeRaw)}</div>
                </div>
              </div>

              <div style="padding: 16px; background: rgba(255, 193, 7, 0.1); border-radius: 12px; border-left: 4px solid #FFC107;">
                <div style="font-size: 13px; color: #856404; font-weight: 500;">
                  â„¹ï¸ Artist notes are internal blocks for scheduling and do not count in statistics.
                </div>
              </div>
            </div>
          </div>
        `;

        modal.style.display = 'flex';
      };

      window.closeArtistInfoModal = function closeArtistInfoModal() {
        const modal = document.getElementById('artistInfoModal');
        if (modal) {
          modal.style.display = 'none';
        }
      };

      // ============================================
      // CREATE ARTIST INFO FUNCTION
      // ============================================
      window.createArtistInfo = async function createArtistInfo(artistId, start, end, notice) {
        try {
          console.log('ðŸ“Œ Creating artist info:', { artistId, start, end, notice });

          if (!artistId || !start || !end) {
            throw new Error('Artist ID, start, and end times are required');
          }

          if (!selectedLocationId) {
            throw new Error('No location selected');
          }

          const { data: newInfo, error } = await supabase
            .from('artist_infos')
            .insert({
              artist_id: artistId,
              location_id: selectedLocationId,
              start: start,
              end: end,
              notice: notice || ''
            })
            .select()
            .single();

          if (error) throw error;

          console.log('âœ… Created artist info:', newInfo);
          alert('âœ… Artist Note erfolgreich erstellt!');

          // Reload calendar events
          await loadEvents();
          renderCalendar();

          return newInfo;

        } catch (error) {
          console.error('âŒ Error creating artist info:', error);
          alert('Fehler beim Erstellen der Artist Note: ' + error.message);
          throw error;
        }
      };

      // Show create artist info modal (stub - to be implemented later)
      window.showCreateArtistInfoModal = function showCreateArtistInfoModal() {
        console.warn('âš ï¸ showCreateArtistInfoModal() called but not fully implemented');
        alert('Artist Note Erstellung:\n\nDiese Funktion wird derzeit entwickelt.\n\nVerwenden Sie vorerst die API oder kontaktieren Sie den Administrator.');
        // TODO: Implement full UI modal for creating artist infos
        // - Show form with artist selector, date/time pickers, notice textarea
        // - Validate and call createArtistInfo()
      };

      // Helper function to check if current date is outside loaded range
      function isDateOutsideLoadedRange() {
        if (!loadedDateRangeStart || !loadedDateRangeEnd) {
          return true; // No data loaded yet
        }

        const currentDateOnly = new Date(currentDate);
        currentDateOnly.setHours(0, 0, 0, 0);

        return currentDateOnly < loadedDateRangeStart || currentDateOnly > loadedDateRangeEnd;
      }

      // Smart function to change date and reload if necessary
      async function changeDateAndReloadIfNeeded(newDate) {
        const oldDate = new Date(currentDate);
        currentDate = newDate;

        // Check if we need to reload events
        if (isDateOutsideLoadedRange()) {
          console.log('Date is outside loaded range, reloading events...');
          await loadEvents();
        }

        renderCalendar();
      }

      // Find available slot for a given date, category, start and end hour
      function findAvailableSlot(date, category, startHour, endHour) {
        // Get all events for this date and category
        const dateEvents = events.filter(e => 
          e.date === date && 
          e.category === category
        );
        
        // Check each slot from 1-10
        for (let slot = 1; slot <= 10; slot++) {
          // Check if this slot has any overlapping events
          const hasConflict = dateEvents.some(e => 
            e.slot === slot &&
            !(endHour <= e.startHour || startHour >= e.endHour)
          );
          
          if (!hasConflict) {
            return slot; // Found a free slot
          }
        }
        
        return null; // All slots are occupied
      }


      // Helper function to get readable event type labels
      function getEventTypeLabel(type) {
        const typeLabels = {
          'consultation': 'Consultation',
          'new_tattoo': 'New Tattoo',
          'continuing_tattoo': 'Continuing',
          'touch_up': 'Touch Up',
          'selfbooking': 'Selfbooking',
          'wannado': 'WannaDo',
          'internal': 'Internal',
          'move': 'Move',
          'reserved': 'Reserved',
          'no_show': 'No Show'
        };
        return typeLabels[type] || type;
      }

      // Toggle canceled guest spots visibility in calendar
      function toggleShowCanceledGuestSpots() {
        showCanceledGuestSpots = document.getElementById('showCanceledGuestSpots')?.checked || false;
        console.log('ðŸ“… Show canceled guest spots:', showCanceledGuestSpots);
        // Reload calendar data
        if (selectedLocationId) {
          loadEvents(selectedLocationId);
        }
      }
      window.toggleShowCanceledGuestSpots = toggleShowCanceledGuestSpots;

      function renderCalendar() {
        const dateStr = currentDate.toISOString().split('T')[0];
        document.getElementById('datePickerInput').value = dateStr;

        // Update date display (z.B. "Mo. 20. Oktober 2025")
        const dateDisplayTop = document.getElementById('currentDateDisplayTop');
        if (dateDisplayTop) {
          const day = currentDate.getDate();
          const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni',
                              'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
          const month = monthNames[currentDate.getMonth()];
          const year = currentDate.getFullYear();
          const weekdayShort = currentDate.toLocaleDateString('de-DE', { weekday: 'short' });
          const formattedDate = `${weekdayShort} ${day}. ${month} ${year}`;
          dateDisplayTop.textContent = formattedDate;
        }

        // Check if today
        const today = new Date();
        const isToday = dateStr === today.toISOString().split('T')[0];

        const container = document.getElementById('calendarContainer');
        if (!container) return;

        let html = '<div class="calendar-grid" style="position:relative;">';

        html += '<div class="calendar-header"><div class="slot-header">Slots</div>';
        for (let h = 9; h <= 21; h++) html += `<div class="hour-header" style="grid-column:span 2;">${h}:00</div>`;
        html += '</div>';

        // Define categories to render
        const categoriesToRender = [
          { key: 'events', label: 'Events', visible: visibleCategories.events },
          { key: 'resident', label: 'Residents', visible: visibleCategories.residents },
          { key: 'guest', label: 'Guests', visible: visibleCategories.guests },
          { key: 'guest_spot', label: 'Guest Spots', visible: true }, // Always show guest spots
          { key: 'artist_info', label: 'Artist Notes', visible: true } // Always show artist infos
        ];

        categoriesToRender.forEach(({ key, label, visible }) => {
          const cat = key === 'events' ? 'events' : key;

          // Always show category header
          html += '<div class="calendar-header"><div class="category-header">' + label + '</div>';
          for (let h = 9; h <= 21; h++) html += '<div class="category-spacer" style="grid-column:span 2;"></div>';
          html += '</div>';

          // Only show slots if visible
          if (visible) {
            // Get all events for this category and date
            let categoryEvents = events.filter(e =>
              e.date === dateStr && e.category === cat
            );

            // Filter for artist users: Only show their own appointments
            if (isArtistUser() && currentUserArtistId) {
              categoryEvents = categoryEvents.filter(e => {
                // Artist Info events: Always show (they're general info)
                if (e.category === 'artist_info') return true;

                // Events without artistId: Don't show to artist users
                if (!e.artistId) return false;

                // Only show events where the artistId matches the logged-in user's artist ID
                return e.artistId === currentUserArtistId;
              });
            }

            // Enhanced logging for Guest Spots category
            if (cat === 'guest_spot') {
              const guestSpotAvailability = categoryEvents.filter(e => !e.isGuestSpotAppointment).length;
              const guestSpotAppointments = categoryEvents.filter(e => e.isGuestSpotAppointment).length;
              console.log(`ðŸ“… Rendering ${categoryEvents.length} ${label} for ${dateStr} (${guestSpotAvailability} Availability + ${guestSpotAppointments} Appointments)`);
            } else {
              console.log(`ðŸ“… Rendering ${categoryEvents.length} ${label} for ${dateStr}`);
            }

            // CRITICAL: Each appointment gets its OWN ROW
            // Sort by start time
            const sortedEvents = categoryEvents.sort((a, b) => a.startHour - b.startHour);

            // If no events, show at least one empty slot (but not for artist users)
            if (sortedEvents.length === 0 && !isArtistUser()) {
              html += `<div class="slot-row empty-row"><div class="slot-label">Slot 1</div>`;

              // Empty cells
              for (let h = 9; h <= 21; h++) {
                html += `<div class="slot-cell"></div>`;
                html += `<div class="slot-cell half-hour"></div>`;
              }

              html += '</div>';
            } else {
              // Render each event in its own row
              sortedEvents.forEach((evt, index) => {
                const slotNumber = index + 1;
                const artistName = evt.artistName || '';
                const slotLabel = artistName ? `Slot ${slotNumber} - ${artistName}` : `Slot ${slotNumber}`;

                html += `<div class="slot-row"><div class="slot-label">${slotLabel}</div>`;

                // Create cells for time slots 09:00 - 21:00
                const cells = [];
                for (let h = 9; h <= 21; h++) {
                  [0, 0.5].forEach(offset => {
                    const currentTime = h + offset;
                    cells.push({
                      time: currentTime,
                      isEventStart: false,
                      span: 0
                    });
                  });
                }

                // Mark where this event starts and its span
                const startIndex = Math.max(0, Math.floor((evt.startHour - 9) * 2));
                const endIndex = Math.min(cells.length, Math.floor((evt.endHour - 9) * 2));
                const span = endIndex - startIndex;

                if (span > 0 && startIndex < cells.length) {
                  cells[startIndex].isEventStart = true;
                  cells[startIndex].span = span;
                  cells[startIndex].event = evt;

                  // Mark occupied cells
                  for (let i = startIndex + 1; i < endIndex && i < cells.length; i++) {
                    cells[i].occupied = true;
                  }
                }

                // Render cells
                cells.forEach((cell, index) => {
                  if (cell.occupied) {
                    // Skip - covered by span
                    return;
                  }

                  if (cell.isEventStart && cell.event) {
                    // This is the start of an event
                    const isHalfHour = (index % 2) === 1;
                    // Kategorie fÃ¼r data-type Attribut ermitteln (work_process > booking_type > status)
                    const eventCategory = window.getAppointmentCategory ?
                      window.getAppointmentCategory(cell.event.fullData || cell.event) :
                      (cell.event.type || 'unknown');
                    const typeAttr = `data-type="${eventCategory}"`;

                    // Format start and end time
                    const startHour = Math.floor(cell.event.startHour);
                    const startMin = Math.round((cell.event.startHour % 1) * 60);
                    const endHour = Math.floor(cell.event.endHour);
                    const endMin = Math.round((cell.event.endHour % 1) * 60);
                    const startTimeStr = `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}`;
                    const endTimeStr = `${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`;
                    const timeStr = `${startTimeStr} - ${endTimeStr}`;

                    // Type label mapping
                    const typeLabels = {
                      'consultation': 'Beratung',
                      'new_tattoo': 'Neustechen',
                      'continuing_tattoo': 'Weiterstechen',
                      'touch_up': 'Nachstechen',
                      'selfbooking': 'Selfbooking',
                      'wannado': 'WannaDo',
                      'internal': 'Intern',
                      'move': 'Verschiebung',
                      'reserved': 'Reserviert',
                      'no_show': 'No Show'
                    };

                    const typeLabel = cell.event.type ? typeLabels[cell.event.type] || cell.event.type : '';

                    // Payment status text labels
                    const paymentLabels = {
                      'paid': 'âœ… Bezahlt',
                      'fully_paid': 'âœ… Bezahlt',
                      'deposit_paid': 'ðŸ’° Anzahlung',
                      'pending': 'â³ Offen',
                      'failed': 'âŒ Fehlgeschlagen',
                      'refunded': 'â†©ï¸ RÃ¼ckerstattet',
                      'unpaid': 'ðŸ’³ Unbezahlt'
                    };
                    const paymentLabel = cell.event.isAppointment && cell.event.paymentStatus
                      ? paymentLabels[cell.event.paymentStatus] || paymentLabels['unpaid']
                      : '';

                    // Build content based on category
                    let content = '';
                    let isArtistInfoEvent = cell.event.isArtistInfo === true;

                    if (cell.event.isGuestSpot) {
                      // Check if this is a Guest Spot Appointment (has customer) vs Guest Spot Availability
                      if (cell.event.isGuestSpotAppointment) {
                        // Guest Spot APPOINTMENT: Show customer, time, price
                        const gsAptCustomer = cell.event.customerName || 'Kunde';
                        const gsAptPrice = cell.event.price ? `â‚¬${cell.event.price}` : '';
                        const gsAptType = cell.event.type || 'Termin';

                        content = `
                          <div style="display:flex; align-items:center; gap:4px; margin-bottom:3px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                              <line x1="16" y1="2" x2="16" y2="6"></line>
                              <line x1="8" y1="2" x2="8" y2="6"></line>
                              <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span style="font-weight:600; font-size:12px;">${timeStr}</span>
                          </div>
                          <div style="font-weight:700; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:3px;">
                            ${gsAptCustomer}
                          </div>
                          <div style="display:flex; align-items:center; gap:6px;">
                            <span style="font-size:10px; font-weight:600; text-transform:uppercase; opacity:0.7;">${gsAptType}</span>
                            ${gsAptPrice ? `<span style="font-size:10px; font-weight:600; opacity:0.9;">${gsAptPrice}</span>` : ''}
                          </div>
                        `;
                      } else {
                        // Guest Spot AVAILABILITY: Show artist name, time, and booking type (paid status shown in detail modal)
                        const gsTypeLabel = cell.event.bookingType === 'internal' ? 'Intern' : 'Extern';

                        content = `
                          <div style="display:flex; align-items:center; gap:4px; margin-bottom:3px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                              <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <span style="font-weight:600; font-size:12px;">${timeStr}</span>
                          </div>
                          <div style="font-weight:700; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:3px; cursor:pointer; text-decoration:underline;" onclick="event.stopPropagation(); viewArtistProfile('${cell.event.artistId}');">
                            ${cell.event.artistName}
                          </div>
                          <div style="display:flex; align-items:center; gap:6px;">
                            <span style="font-size:10px; font-weight:600; text-transform:uppercase; opacity:0.7;">${gsTypeLabel}</span>
                          </div>
                        `;
                      }
                    } else if (isArtistInfoEvent) {
                      // Artist Info: Compact display with just notice text
                      content = `<div style="font-weight:600; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${cell.event.title}</div>`;
                    } else if (cat === 'events') {
                      // For events: SVG icon + time, title, and type
                      const catConfig = (window.calendarCategoryConfig || {})[eventCategory] || {};
                      const typeIcon = catConfig.icon || '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>';
                      const displayLabel = catConfig.label || typeLabel || 'Event';

                      const titleContent = cell.event.artistId
                        ? `<div style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:2px; cursor:pointer; text-decoration:underline; font-weight:600;" onclick="event.stopPropagation(); viewArtistProfile('${cell.event.artistId}');">${cell.event.title}</div>`
                        : `<div style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:2px; font-weight:600;">${cell.event.title}</div>`;

                      content = `
                        <div style="display:flex; align-items:center; gap:4px; margin-bottom:3px;">
                          <span style="display:inline-flex; align-items:center;">${typeIcon}</span>
                          <span style="font-weight:600; font-size:12px;">${timeStr}</span>
                        </div>
                        ${titleContent}
                        ${displayLabel ? `<div style="font-size:10px; font-weight:500; text-transform:uppercase; letter-spacing:0.3px; opacity:0.8;">${displayLabel}</div>` : ''}
                      `;
                    } else {
                      // For bookings: SVG Icon + Type, Time + Name, Payment Badge
                      const customerName = cell.event.customerName || 'Kunde';
                      const customerLink = cell.event.customerId
                        ? `<span style="cursor:pointer; text-decoration:underline;" onclick="event.stopPropagation(); openCustomerProfile('${cell.event.customerId}');">${customerName}</span>`
                        : customerName;

                      // Get category config for icon (uses eventCategory calculated above)
                      const catConfig = (window.calendarCategoryConfig || {})[eventCategory] || {};
                      const typeIcon = catConfig.icon || '';
                      const displayLabel = catConfig.label || typeLabel || eventCategory;

                      // Payment status badge with SVG icons
                      const paymentBadges = {
                        'paid': {
                          icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><path d="M20 6L9 17l-5-5"/></svg>',
                          label: 'Bezahlt', bg: 'rgba(46, 125, 50, 0.15)', color: '#2E7D32'
                        },
                        'fully_paid': {
                          icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><path d="M20 6L9 17l-5-5"/></svg>',
                          label: 'Bezahlt', bg: 'rgba(46, 125, 50, 0.15)', color: '#2E7D32'
                        },
                        'deposit_paid': {
                          icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
                          label: 'Anzahlung', bg: 'rgba(21, 101, 192, 0.15)', color: '#1565C0'
                        },
                        'pending': {
                          icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
                          label: 'Offen', bg: 'rgba(245, 127, 23, 0.15)', color: '#F57F17'
                        },
                        'failed': {
                          icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>',
                          label: 'Fehlgeschlagen', bg: 'rgba(198, 40, 40, 0.15)', color: '#C62828'
                        },
                        'refunded': {
                          icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><path d="M3 10h10a5 5 0 0 1 0 10H3"/><path d="M7 6l-4 4 4 4"/></svg>',
                          label: 'Erstattet', bg: 'rgba(69, 90, 100, 0.15)', color: '#455A64'
                        },
                        'unpaid': {
                          icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>',
                          label: 'Unbezahlt', bg: 'rgba(198, 40, 40, 0.1)', color: '#C62828'
                        }
                      };
                      const paymentInfo = cell.event.isAppointment && cell.event.paymentStatus
                        ? paymentBadges[cell.event.paymentStatus] || paymentBadges['unpaid']
                        : null;

                      content = `
                        <div style="display:flex; align-items:center; gap:4px; margin-bottom:4px;">
                          ${typeIcon ? `<span style="display:inline-flex; align-items:center;">${typeIcon}</span>` : ''}
                          <span style="font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; opacity:0.9;">${displayLabel}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:4px; gap:6px; width:100%;">
                          <span style="font-weight:600; font-size:11px; opacity:0.8; white-space:nowrap;">${timeStr}</span>
                          <span style="font-weight:700; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1; text-align:right;">${customerLink}</span>
                        </div>
                        ${paymentInfo ? `
                          <div style="display:inline-flex; align-items:center; gap:3px; padding:2px 6px; border-radius:4px; background:${paymentInfo.bg}; margin-top:2px;">
                            <span style="display:inline-flex; color:${paymentInfo.color};">${paymentInfo.icon}</span>
                            <span style="font-size:9px; font-weight:600; color:${paymentInfo.color}; text-transform:uppercase;">${paymentInfo.label}</span>
                          </div>
                        ` : ''}
                      `;
                    }

                    // Add attendance required indicator for events
                    const attendanceIndicator = (cat === 'events' && cell.event.attendanceRequired) ?
                      `<div style="position:absolute; top:8px; right:8px; width:8px; height:8px; background:#ff3b30; border-radius:50%; box-shadow:0 1px 3px rgba(255,59,48,0.4);"></div>` : '';

                    // Artist Info: Use special CSS class and click handler
                    const artistInfoClass = isArtistInfoEvent ? 'artist-info-event' : '';
                    const guestSpotCanceledClass = cell.event.isCanceled ? 'canceled' : '';
                    // Guest Spot Appointment gets different class for styling (tÃ¼rkis instead of braun)
                    const guestSpotAppointmentClass = cell.event.isGuestSpotAppointment ? 'guest_spot_appointment' : '';
                    const guestSpotClass = cell.event.isGuestSpot ? `guest_spot ${guestSpotCanceledClass} ${guestSpotAppointmentClass}` : '';

                    // Click handler: Guest Spot Appointments open edit modal, Guest Spot Availability opens detail modal
                    let clickHandler;
                    if (cell.event.isGuestSpotAppointment) {
                      // Guest Spot Appointment â†’ open edit appointment modal
                      clickHandler = `onclick="openEditEventModal('${cell.event.id}')"`;
                    } else if (cell.event.isGuestSpot) {
                      // Guest Spot Availability â†’ open guest spot detail modal
                      clickHandler = `onclick="handleGuestSpotCalendarClick('${cell.event.id}')"`;
                    } else if (isArtistInfoEvent) {
                      clickHandler = `onclick="openArtistInfoModal('${cell.event.originalId}', ${JSON.stringify(cell.event).replace(/"/g, '&quot;')})"`;
                    } else {
                      clickHandler = `onclick="openEditEventModal('${cell.event.id}')"`;
                    }

                    html += `<div class="slot-cell ${isHalfHour ? 'half-hour' : ''}" style="grid-column: span ${cell.span}; position: relative;">
                      <div class="event ${cat} ${artistInfoClass} ${guestSpotClass}" ${typeAttr} data-event-id="${cell.event.id}" ${clickHandler} style="position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px; display:flex; flex-direction:column; justify-content:${isArtistInfoEvent ? 'center' : 'flex-start'}; align-items:flex-start; overflow:hidden;">
                        ${content}
                        ${attendanceIndicator}
                      </div>
                    </div>`;
                  } else {
                    // Empty cell
                    const isHalfHour = (index % 2) === 1;
                    html += `<div class="slot-cell ${isHalfHour ? 'half-hour' : ''}"></div>`;
                  }
                });

                html += '</div>';
              });
            }
          }
        });

        html += '</div>';
        container.innerHTML = html;

        // Render mobile calendar view
        renderMobileCalendar();

        // Add current time indicator if today
        // Clear old interval if exists (prevent memory leak)
        if (currentTimeIndicatorInterval) {
          clearInterval(currentTimeIndicatorInterval);
          currentTimeIndicatorInterval = null;
        }

        if (isToday) {
          addCurrentTimeIndicator();
          // Update every minute and track interval
          currentTimeIndicatorInterval = setInterval(updateCurrentTimeIndicator, 60000);
        }
      }

      // Make renderCalendar globally available
      window.renderCalendar = renderCalendar;

      // Mobile calendar state
      let mobileSelectedDate = new Date();

      function renderMobileCalendar() {
        const container = document.getElementById('calendarContainer');
        if (!container) return;

        // Check if mobile elements already exist
        let weekHeader = container.querySelector('.mobile-week-header');
        let calendarView = container.querySelector('.mobile-calendar-view');

        if (!weekHeader) {
          weekHeader = document.createElement('div');
          weekHeader.className = 'mobile-week-header';
          container.appendChild(weekHeader);
        }

        if (!calendarView) {
          calendarView = document.createElement('div');
          calendarView.className = 'mobile-calendar-view';
          container.appendChild(calendarView);
        }

        // Render 7-day header starting from current day
        renderMobileWeekHeader(weekHeader);

        // Render day view for selected date
        renderMobileDayView(calendarView, mobileSelectedDate);
      }

      function renderMobileWeekHeader(container) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const selectedDateStr = mobileSelectedDate.toISOString().split('T')[0];
        const todayStr = today.toISOString().split('T')[0];

        let html = '';

        // Generate 7 days starting from current day
        for (let i = 0; i < 7; i++) {
          const date = new Date(currentDate);
          date.setDate(date.getDate() + i);

          const dayName = date.toLocaleDateString('de-DE', { weekday: 'short' });
          const dayNumber = date.getDate();
          const dateStr = date.toISOString().split('T')[0];

          const isActive = dateStr === selectedDateStr;
          const isToday = dateStr === todayStr;

          const classes = ['mobile-day-item'];
          if (isActive) classes.push('active');
          if (isToday) classes.push('today');

          html += `
            <div class="${classes.join(' ')}" onclick="selectMobileDate('${dateStr}')">
              <div class="mobile-day-name">${dayName}</div>
              <div class="mobile-day-number">${dayNumber}</div>
            </div>
          `;
        }

        container.innerHTML = html;
      }

      function renderMobileDayView(container, date) {
        const dateStr = date.toISOString().split('T')[0];

        // Get all events for this date
        const dayEvents = events.filter(e => e.date === dateStr);

        // Group events by hour
        const eventsByHour = {};
        for (let h = 5; h < 24; h++) {
          eventsByHour[h] = [];
        }

        dayEvents.forEach(evt => {
          const hour = Math.floor(evt.startHour);
          if (eventsByHour[hour]) {
            eventsByHour[hour].push(evt);
          }
        });

        let html = '<div class="mobile-time-column">';

        // Render hours from 5:00 to 23:00
        for (let h = 5; h < 24; h++) {
          const hourLabel = `${h.toString().padStart(2, '0')}:00`;
          const hourEvents = eventsByHour[h] || [];

          html += `
            <div class="mobile-hour-row">
              <div class="mobile-hour-label">${hourLabel}</div>
              <div class="mobile-hour-content">
          `;

          // Render events for this hour
          hourEvents.forEach(evt => {
            const startTime = `${Math.floor(evt.startHour)}:${String(Math.round((evt.startHour % 1) * 60)).padStart(2, '0')}`;
            const endTime = `${Math.floor(evt.endHour)}:${String(Math.round((evt.endHour % 1) * 60)).padStart(2, '0')}`;
            const timeRange = `${startTime} - ${endTime}`;

            const eventClass = ['mobile-event'];
            if (evt.category === 'guest') eventClass.push('guest');
            else if (evt.category === 'resident') eventClass.push('resident');
            else if (evt.category === 'events') eventClass.push('events');

            let title = evt.title;
            if (evt.isAppointment && evt.customerName) {
              title = evt.customerName;
            }

            html += `
              <div class="${eventClass.join(' ')}" onclick="viewEvent('${evt.id}')">
                <div class="mobile-event-time">${timeRange}</div>
                <div class="mobile-event-title">${title}</div>
              </div>
            `;
          });

          html += `
              </div>
            </div>
          `;
        }

        html += '</div>';
        container.innerHTML = html;
      }

      window.selectMobileDate = function(dateStr) {
        mobileSelectedDate = new Date(dateStr + 'T12:00:00');
        currentDate = new Date(dateStr + 'T12:00:00');
        renderCalendar();
      };

      function addCurrentTimeIndicator() {
        const now = new Date();
        const currentHour = now.getHours() + now.getMinutes() / 60;
        
        // Only show if current time is within calendar range (10-20)
        if (currentHour < 10 || currentHour > 20) return;
        
        updateCurrentTimeIndicator();
      }
      
      function updateCurrentTimeIndicator() {
        // Remove old indicator
        const oldIndicator = document.querySelector('.current-time-indicator');
        if (oldIndicator) oldIndicator.remove();
        
        const now = new Date();
        const currentHour = now.getHours() + now.getMinutes() / 60;
        
        // Only show if current time is within calendar range
        if (currentHour < 10 || currentHour > 20) return;
        
        const calendarGrid = document.querySelector('.calendar-grid');
        if (!calendarGrid) return;
        
        // Calculate position (10:00 = 0%, 20:00 = 100%)
        const startHour = 10;
        const endHour = 20;
        const totalHours = endHour - startHour;
        const hoursFromStart = currentHour - startHour;
        const percentage = (hoursFromStart / totalHours) * 100;
        
        // Calculate pixel position
        // Grid has 1 slot column (120px) + 22 time columns
        const slotColumnWidth = 120;
        const gridWidth = calendarGrid.offsetWidth;
        const timeColumnsWidth = gridWidth - slotColumnWidth;
        const pixelPosition = slotColumnWidth + (timeColumnsWidth * percentage / 100);
        
        const indicator = document.createElement('div');
        indicator.className = 'current-time-indicator';
        indicator.style.left = `${pixelPosition}px`;
        indicator.style.top = '0';
        indicator.style.bottom = '0';
        
        calendarGrid.appendChild(indicator);
      }

      document.getElementById('prevDayBtn').addEventListener('click', async () => {
        const newDate = new Date(currentDate);
        newDate.setDate(newDate.getDate() - 1);
        await changeDateAndReloadIfNeeded(newDate);
      });

      document.getElementById('nextDayBtn').addEventListener('click', async () => {
        const newDate = new Date(currentDate);
        newDate.setDate(newDate.getDate() + 1);
        await changeDateAndReloadIfNeeded(newDate);
      });

      document.getElementById('todayBtn').addEventListener('click', async () => {
        await changeDateAndReloadIfNeeded(new Date());
      });

      document.getElementById('datePickerInput').addEventListener('change', async (e) => {
        await changeDateAndReloadIfNeeded(new Date(e.target.value));
      });

      // ============================================
      // CALENDAR KEYBOARD NAVIGATION (â† â†’ T)
      // ============================================
      document.addEventListener('keydown', async (e) => {
        // Nur wenn Calendar Tab aktiv ist
        const calendarSection = document.getElementById('calendar-section');
        const isCalendarVisible = calendarSection &&
          calendarSection.style.display !== 'none' &&
          !calendarSection.classList.contains('hidden') &&
          calendarSection.offsetParent !== null;

        if (!isCalendarVisible) return;

        // Nicht wenn User in Input/Textarea tippt
        const activeElement = document.activeElement;
        const isTyping = activeElement && (
          activeElement.tagName === 'INPUT' ||
          activeElement.tagName === 'TEXTAREA' ||
          activeElement.isContentEditable
        );

        if (isTyping) return;

        // Nicht wenn Modal/Popup offen ist
        const hasOpenModal = document.querySelector('.modal.active, .modal.show, .popup-overlay, .slot-popup-overlay, .task-popup-overlay, .event-popup-overlay');
        if (hasOpenModal) return;

        // Pfeiltaste Links â†’ Previous Day
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          const prevBtn = document.getElementById('prevDayBtn');
          if (prevBtn) {
            prevBtn.click();
            console.log('â¬…ï¸ Calendar: Previous (keyboard)');
          }
        }

        // Pfeiltaste Rechts â†’ Next Day
        if (e.key === 'ArrowRight') {
          e.preventDefault();
          const nextBtn = document.getElementById('nextDayBtn');
          if (nextBtn) {
            nextBtn.click();
            console.log('âž¡ï¸ Calendar: Next (keyboard)');
          }
        }

        // "T" fÃ¼r Today (ohne Modifier)
        if ((e.key === 't' || e.key === 'T') && !e.ctrlKey && !e.altKey && !e.metaKey) {
          e.preventDefault();
          const todayBtn = document.getElementById('todayBtn');
          if (todayBtn) {
            todayBtn.click();
            console.log('ðŸ“… Calendar: Today (keyboard)');
          }
        }
      });

      console.log('âŒ¨ï¸ Calendar keyboard navigation enabled (â† â†’ T)');

      // Add Artist Button - Opens Add Artist Modal
      document.getElementById('addArtistBtn')?.addEventListener('click', async () => {
        // Populate location dropdown
        const { data: locations } = await supabase.from('locations').select('*').order('name', { ascending: true });
        const locSelect = document.getElementById('addArtistLocation');
        if (locSelect && locations) {
          locSelect.innerHTML = '<option value="">-- Select Location --</option>' + 
            locations.map(l => `<option value="${l.id}" ${l.id === selectedLocationId ? 'selected' : ''}>${l.name}</option>`).join('');
        }
        
        // Open modal
        document.getElementById('addArtistModal').classList.add('active');
      });
      
      // Cancel Add Artist
      document.getElementById('cancelAddArtist')?.addEventListener('click', () => {
        document.getElementById('addArtistModal').classList.remove('active', 'elevated');
        document.getElementById('addArtistForm').reset();
      });
      
      // Submit Add Artist Form
      document.getElementById('addArtistForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('addArtistName').value.trim();
        const instagram = document.getElementById('addArtistInstagram').value.trim();
        const type = document.getElementById('addArtistType').value;
        const locationId = document.getElementById('addArtistLocation').value;
        const active = document.getElementById('addArtistActive').checked;

        if (!name || !locationId) return alert('Please enter name and select location');

        try {
          const { data, error } = await supabase.from('artists').insert({
            name,
            instagram: instagram || null,
            is_guest: type === 'guest',
            active,
            location_id: locationId
          }).select();

          if (error) throw error;

          document.getElementById('addArtistModal').classList.remove('active', 'elevated');
          document.getElementById('addArtistForm').reset();
          artistsCache = []; // âœ… Clear cache to force reload
          await loadInitialData();
          await loadArtists();

          // Check if we came from Guest Spot Modal
          if (window.addArtistFromGuestSpot && data && data[0]) {
            const newArtist = data[0];
            selectGuestSpotArtist(
              newArtist.id,
              newArtist.name || '',
              newArtist.instagram || '',
              newArtist.profile_picture_url || ''
            );
            window.addArtistFromGuestSpot = false;
          }

          alert('Artist added successfully!');
        } catch(err) {
          alert('Error: ' + err.message);
        }
      });
      
      // Add Customer Button - Opens Add Customer Modal
      document.getElementById('addCustomerBtn')?.addEventListener('click', () => {
        document.getElementById('addCustomerModal').classList.add('active');
      });
      
      // Cancel Add Customer
      document.getElementById('cancelAddCustomer')?.addEventListener('click', () => {
        document.getElementById('addCustomerModal').classList.remove('active');
        document.getElementById('addCustomerForm').reset();
      });
      
      // Submit Add Customer Form
      document.getElementById('addCustomerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const firstName = document.getElementById('addCustomerFirstName').value.trim();
        const lastName = document.getElementById('addCustomerLastName').value.trim();
        const email = document.getElementById('addCustomerEmail').value.trim();
        const phone = document.getElementById('addCustomerPhone').value.trim();
        const instagram = document.getElementById('addCustomerInstagram').value.trim();
        const rank = document.getElementById('addCustomerRank').value;

        if (!firstName || !lastName || !email) {
          return alert('Please fill in first name, last name, and email');
        }

        try {
          const { error } = await supabase.from('customers').insert({
            first_name: firstName,
            last_name: lastName,
            email,
            phone: phone || null,
            instagram: instagram || null,
            rank: rank || null
          });

          if (error) throw error;

          document.getElementById('addCustomerModal').classList.remove('active');
          document.getElementById('addCustomerForm').reset();
          customersCache = []; // âœ… Clear cache to force reload
          await loadCustomers();
          alert('âœ… Customer added successfully!');
        } catch(err) {
          alert('âŒ Error: ' + err.message);
        }
      });
      
      // Artist Filter Event Listeners
      document.getElementById('artistSearchInput')?.addEventListener('input', filterArtists);
      document.getElementById('artistLocationFilter')?.addEventListener('change', filterArtists);
      document.getElementById('artistRankFilter')?.addEventListener('change', filterArtists);
      document.getElementById('artistTypeFilter')?.addEventListener('change', filterArtists);
      document.getElementById('artistStatusFilter')?.addEventListener('change', filterArtists);

      // Customer Filter Event Listeners
      document.getElementById('customerSearchInput')?.addEventListener('input', filterCustomers);
      document.getElementById('customerRankFilter')?.addEventListener('change', filterCustomers);
      document.getElementById('customerBlacklistFilter')?.addEventListener('change', filterCustomers);
      document.getElementById('customerBookingsFilter')?.addEventListener('change', filterCustomers);
      
      // Edit Artist Functions
      window.editArtist = async function(artistId) {
        const artist = allArtists.find(a => a.id === artistId);
        if (!artist) return;
        
        currentEditArtistId = artistId;
        
        document.getElementById('editArtistName').value = artist.name;
        document.getElementById('editArtistInstagram').value = artist.instagram || '';
        document.getElementById('editArtistType').value = artist.is_guest ? 'guest' : 'resident';
        
        // Set location dropdown (static values, so just select current)
        document.getElementById('editArtistLocation').value = artist.city_location || '';
        document.getElementById('editArtistRank').value = artist.rank || '';
        document.getElementById('editArtistActive').checked = artist.active;
        
        document.getElementById('editArtistModal').classList.add('active');
      };
      
      document.getElementById('cancelEditArtist')?.addEventListener('click', () => {
        document.getElementById('editArtistModal').classList.remove('active');
        currentEditArtistId = null;
      });
      
      document.getElementById('editArtistForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('editArtistName').value.trim();
        const instagram = document.getElementById('editArtistInstagram').value.trim();
        const type = document.getElementById('editArtistType').value;
        const active = document.getElementById('editArtistActive').checked;
        
        if (!name) return alert('Name is required');
        
        try {
          const location = document.getElementById('editArtistLocation').value;
          const rank = document.getElementById('editArtistRank').value;
          
          const { error } = await supabase
            .from('artists')
            .update({
              name,
              instagram: instagram || null,
              is_guest: type === 'guest',
              city_location: location || null,
              rank: rank || null,
              active
            })
            .eq('id', currentEditArtistId);
          
          if (error) throw error;

          document.getElementById('editArtistModal').classList.remove('active');
          currentEditArtistId = null;

          // Clear cache and reload all data to ensure fresh info
          artistsCache = []; // âœ… Clear cache to force reload
          await loadInitialData();
          await loadArtists();
          renderCalendar();
          alert('Artist updated successfully!');
        } catch (err) {
          alert('Error updating artist: ' + err.message);
        }
      });
      
      // Delete Artist Function
      window.deleteArtist = async function(artistId) {
        const artist = allArtists.find(a => a.id === artistId);
        if (!artist) return;

        if (!confirm(`Are you sure you want to delete "${artist.name}"? This action cannot be undone.`)) {
          return;
        }

        try {
          const { error } = await supabase
            .from('artists')
            .delete()
            .eq('id', artistId);

          if (error) throw error;

          artistsCache = []; // âœ… Clear cache to force reload
          await loadInitialData();
          await loadArtists();
          renderCalendar();
          alert('Artist deleted successfully!');
        } catch (err) {
          alert('Error deleting artist: ' + err.message);
        }
      };

      // ==========================================
      // ARTIST IMAGE UPLOAD FUNCTIONS
      // ==========================================

      function openEditArtistModal(artistId) {
        currentEditingArtistId = artistId;

        // Reset uploaded images
        uploadedProfilePicture = null;
        uploadedBackgroundImage = null;

        // Load artist data
        const artist = artistsCache.find(a => a.id === artistId) || allArtists.find(a => a.id === artistId);
        if (!artist) return;

        const modalHtml = `
          <div id="customEditArtistModal" style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
          ">
            <div style="
              background: white;
              padding: 32px;
              border-radius: 16px;
              width: 90%;
              max-width: 800px;
              max-height: 90vh;
              overflow-y: auto;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            ">
              <h2 style="margin: 0 0 24px 0; font-size: 24px; font-weight: 600;">
                Edit Artist - ${artist.name}
              </h2>

              <form id="customEditArtistForm" onsubmit="saveArtistChanges(event)">
                <!-- Basic Info -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                  <div>
                    <label style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase;">Name</label>
                    <input type="text" id="customEditArtistName" value="${artist.name || ''}" required style="
                      width: 100%;
                      padding: 10px 12px;
                      border: 1px solid rgba(0,0,0,0.1);
                      border-radius: 8px;
                      font-size: 14px;
                      margin-top: 4px;
                    ">
                  </div>

                  <div>
                    <label style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase;">Email</label>
                    <input type="email" id="customEditArtistEmail" value="${artist.email || ''}" style="
                      width: 100%;
                      padding: 10px 12px;
                      border: 1px solid rgba(0,0,0,0.1);
                      border-radius: 8px;
                      font-size: 14px;
                      margin-top: 4px;
                    ">
                  </div>
                </div>

                <!-- Images Section -->
                <div style="background: rgba(0,0,0,0.02); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                  <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Images</h3>

                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Profile Picture -->
                    <div>
                      <label style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase; display: block; margin-bottom: 8px;">
                        Profile Picture (Square)
                      </label>

                      <!-- Current Image -->
                      <div id="currentProfilePic" style="
                        width: 100%;
                        height: 200px;
                        border-radius: 8px;
                        background: ${artist.profile_picture_url ? `url('${artist.profile_picture_url}')` : '#f0f0f0'};
                        background-size: cover;
                        background-position: center;
                        margin-bottom: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #86868b;
                        font-size: 14px;
                      ">
                        ${!artist.profile_picture_url ? 'No Image' : ''}
                      </div>

                      <!-- Upload & Delete Buttons -->
                      <div style="display: flex; gap: 8px;">
                        <input type="file" id="profilePicInput" accept="image/*" style="display: none;" onchange="handleProfilePicUpload(event)">
                        <button type="button" onclick="document.getElementById('profilePicInput').click()" style="
                          flex: 1;
                          padding: 10px;
                          background: #007AFF;
                          color: white;
                          border: none;
                          border-radius: 8px;
                          font-weight: 600;
                          cursor: pointer;
                        ">Upload</button>
                        ${artist.profile_picture_url ? `
                        <button type="button" onclick="deleteProfilePicture()" style="
                          flex: 1;
                          padding: 10px;
                          background: #FF3B30;
                          color: white;
                          border: none;
                          border-radius: 8px;
                          font-weight: 600;
                          cursor: pointer;
                        ">Delete</button>
                        ` : ''}
                      </div>
                      <div id="profilePicStatus" style="margin-top: 8px; font-size: 12px; color: #34C759;"></div>
                    </div>

                    <!-- Background Image -->
                    <div>
                      <label style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase; display: block; margin-bottom: 8px;">
                        Background Image (Landscape)
                      </label>

                      <!-- Current Image -->
                      <div id="currentBackgroundImg" style="
                        width: 100%;
                        height: 200px;
                        border-radius: 8px;
                        background: ${artist.background_image_url ? `url('${artist.background_image_url}')` : '#f0f0f0'};
                        background-size: cover;
                        background-position: center;
                        margin-bottom: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #86868b;
                        font-size: 14px;
                      ">
                        ${!artist.background_image_url ? 'No Image' : ''}
                      </div>

                      <!-- Upload & Delete Buttons -->
                      <div style="display: flex; gap: 8px;">
                        <input type="file" id="backgroundImgInput" accept="image/*" style="display: none;" onchange="handleBackgroundImgUpload(event)">
                        <button type="button" onclick="document.getElementById('backgroundImgInput').click()" style="
                          flex: 1;
                          padding: 10px;
                          background: #007AFF;
                          color: white;
                          border: none;
                          border-radius: 8px;
                          font-weight: 600;
                          cursor: pointer;
                        ">Upload</button>
                        ${artist.background_image_url ? `
                        <button type="button" onclick="deleteBackgroundImage()" style="
                          flex: 1;
                          padding: 10px;
                          background: #FF3B30;
                          color: white;
                          border: none;
                          border-radius: 8px;
                          font-weight: 600;
                          cursor: pointer;
                        ">Delete</button>
                        ` : ''}
                      </div>
                      <div id="backgroundImgStatus" style="margin-top: 8px; font-size: 12px; color: #34C759;"></div>
                    </div>
                  </div>
                </div>

                <!-- Bio & Description -->
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase;">Short Description</label>
                  <input type="text" id="customEditArtistShortDesc" value="${artist.short_description || ''}" maxlength="150" style="
                    width: 100%;
                    padding: 10px 12px;
                    border: 1px solid rgba(0,0,0,0.1);
                    border-radius: 8px;
                    font-size: 14px;
                    margin-top: 4px;
                  ">
                  <small style="color: #86868b; font-size: 11px;">Max 150 characters for Webflow Waitlist Display</small>
                </div>

                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase;">Bio</label>
                  <textarea id="customEditArtistBio" rows="4" style="
                    width: 100%;
                    padding: 10px 12px;
                    border: 1px solid rgba(0,0,0,0.1);
                    border-radius: 8px;
                    font-size: 14px;
                    margin-top: 4px;
                    resize: vertical;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                  ">${artist.bio || ''}</textarea>
                </div>

                <!-- Type & Location -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                  <div>
                    <label style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase;">Type</label>
                    <select id="customEditArtistType" style="
                      width: 100%;
                      padding: 10px 12px;
                      border: 1px solid rgba(0,0,0,0.1);
                      border-radius: 8px;
                      font-size: 14px;
                      margin-top: 4px;
                      background: white;
                    ">
                      <option value="resident" ${!artist.is_guest ? 'selected' : ''}>Resident</option>
                      <option value="guest" ${artist.is_guest ? 'selected' : ''}>Guest</option>
                    </select>
                  </div>

                  <div>
                    <label style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase;">Location</label>
                    <select id="customEditArtistLocation" style="
                      width: 100%;
                      padding: 10px 12px;
                      border: 1px solid rgba(0,0,0,0.1);
                      border-radius: 8px;
                      font-size: 14px;
                      margin-top: 4px;
                      background: white;
                    ">
                      <option value="">-- Select Location --</option>
                      <option value="Stuttgart" ${artist.city_location === 'Stuttgart' ? 'selected' : ''}>Stuttgart</option>
                      <option value="KÃ¶ln" ${artist.city_location === 'KÃ¶ln' ? 'selected' : ''}>KÃ¶ln</option>
                      <option value="Berlin" ${artist.city_location === 'Berlin' ? 'selected' : ''}>Berlin</option>
                      <option value="MÃ¼nchen" ${artist.city_location === 'MÃ¼nchen' ? 'selected' : ''}>MÃ¼nchen</option>
                    </select>
                  </div>
                </div>

                <!-- Instagram, Rank & Style -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                  <div>
                    <label style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase;">Instagram</label>
                    <input type="text" id="customEditArtistInstagram" value="${artist.instagram || ''}" placeholder="@username" style="
                      width: 100%;
                      padding: 10px 12px;
                      border: 1px solid rgba(0,0,0,0.1);
                      border-radius: 8px;
                      font-size: 14px;
                      margin-top: 4px;
                    ">
                  </div>

                  <div>
                    <label style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase;">Rank</label>
                    <select id="customEditArtistRank" style="
                      width: 100%;
                      padding: 10px 12px;
                      border: 1px solid rgba(0,0,0,0.1);
                      border-radius: 8px;
                      font-size: 14px;
                      margin-top: 4px;
                      background: white;
                    ">
                      <option value="">No Rank</option>
                      <option value="R1" ${artist.rank === 'R1' ? 'selected' : ''}>R1</option>
                      <option value="R2" ${artist.rank === 'R2' ? 'selected' : ''}>R2</option>
                      <option value="R3" ${artist.rank === 'R3' ? 'selected' : ''}>R3</option>
                      <option value="R4" ${artist.rank === 'R4' ? 'selected' : ''}>R4</option>
                      <option value="R5" ${artist.rank === 'R5' ? 'selected' : ''}>R5</option>
                    </select>
                  </div>

                  <div>
                    <label style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase;">Style</label>
                    <input type="text" id="customEditArtistStyle" value="${artist.style || ''}" placeholder="e.g. Realism, Traditional" style="
                      width: 100%;
                      padding: 10px 12px;
                      border: 1px solid rgba(0,0,0,0.1);
                      border-radius: 8px;
                      font-size: 14px;
                      margin-top: 4px;
                    ">
                  </div>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                  <button type="button" onclick="closeEditArtistModal()" style="
                    padding: 12px 24px;
                    background: #f0f0f0;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                  ">Cancel</button>

                  <button type="submit" style="
                    padding: 12px 24px;
                    background: #34C759;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                  ">Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }

      function closeEditArtistModal() {
        const modal = document.getElementById('customEditArtistModal');
        if (modal) modal.remove();
        currentEditingArtistId = null;
        uploadedProfilePicture = null;
        uploadedBackgroundImage = null;
      }

      // Make openEditArtistModal globally accessible
      window.openEditArtistModal = openEditArtistModal;
      window.closeEditArtistModal = closeEditArtistModal;

      // Image Upload Handlers
      async function handleProfilePicUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        console.log('ðŸ“¤ Uploading profile picture...');
        document.getElementById('profilePicStatus').textContent = 'â³ Uploading...';
        document.getElementById('profilePicStatus').style.color = '#007AFF';

        const url = await uploadArtistImage(currentEditingArtistId, file, 'profile');

        if (url) {
          uploadedProfilePicture = url;
          document.getElementById('currentProfilePic').style.backgroundImage = `url('${url}')`;
          document.getElementById('currentProfilePic').textContent = '';
          document.getElementById('profilePicStatus').textContent = 'âœ… Uploaded successfully!';
          document.getElementById('profilePicStatus').style.color = '#34C759';
        } else {
          document.getElementById('profilePicStatus').textContent = 'âŒ Upload failed';
          document.getElementById('profilePicStatus').style.color = '#FF3B30';
        }
      }

      async function handleBackgroundImgUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        console.log('ðŸ“¤ Uploading background image...');
        document.getElementById('backgroundImgStatus').textContent = 'â³ Uploading...';
        document.getElementById('backgroundImgStatus').style.color = '#007AFF';

        const url = await uploadArtistImage(currentEditingArtistId, file, 'background');

        if (url) {
          uploadedBackgroundImage = url;
          document.getElementById('currentBackgroundImg').style.backgroundImage = `url('${url}')`;
          document.getElementById('currentBackgroundImg').textContent = '';
          document.getElementById('backgroundImgStatus').textContent = 'âœ… Uploaded successfully!';
          document.getElementById('backgroundImgStatus').style.color = '#34C759';
        } else {
          document.getElementById('backgroundImgStatus').textContent = 'âŒ Upload failed';
          document.getElementById('backgroundImgStatus').style.color = '#FF3B30';
        }
      }

      async function uploadArtistImage(artistId, imageFile, imageType) {
        try {
          // Validate file type
          if (!imageFile.type.startsWith('image/')) {
            alert('Please upload an image file!');
            return null;
          }

          // Validate file size (max 5MB)
          if (imageFile.size > 5 * 1024 * 1024) {
            alert('File too large! Maximum size is 5MB.');
            return null;
          }

          // Generate unique filename
          const fileExt = imageFile.name.split('.').pop();
          const fileName = `${artistId}_${imageType}_${Date.now()}.${fileExt}`;
          const filePath = `${fileName}`;

          console.log('ðŸ“¤ Uploading to Supabase Storage:', filePath);

          // Upload to Supabase Storage
          const { data, error } = await supabase.storage
            .from('artist-images')
            .upload(filePath, imageFile, {
              cacheControl: '3600',
              upsert: false
            });

          if (error) {
            console.error('âŒ Upload error:', error);
            alert('Upload failed: ' + error.message);
            return null;
          }

          // Get public URL
          const { data: urlData } = supabase.storage
            .from('artist-images')
            .getPublicUrl(filePath);

          const publicUrl = urlData.publicUrl;
          console.log('âœ… Image uploaded successfully:', publicUrl);

          return publicUrl;

        } catch (err) {
          console.error('ðŸ’¥ Upload failed:', err);
          alert('Upload error: ' + err.message);
          return null;
        }
      }

      // Make upload functions globally accessible
      window.handleProfilePicUpload = handleProfilePicUpload;
      window.handleBackgroundImgUpload = handleBackgroundImgUpload;

      // Delete Image Functions
      async function deleteProfilePicture() {
        if (!confirm('Are you sure you want to delete the profile picture?')) return;

        try {
          document.getElementById('profilePicStatus').textContent = 'Deleting...';
          document.getElementById('profilePicStatus').style.color = '#007AFF';

          // Update database to remove URL
          const { error } = await supabase
            .from('artists')
            .update({ profile_picture_url: null })
            .eq('id', currentEditingArtistId);

          if (error) throw error;

          // Update UI
          uploadedProfilePicture = null;
          document.getElementById('currentProfilePic').style.backgroundImage = '';
          document.getElementById('currentProfilePic').textContent = 'No Image';
          document.getElementById('profilePicStatus').textContent = 'Image deleted successfully';
          document.getElementById('profilePicStatus').style.color = '#34C759';

          console.log('Profile picture deleted successfully');

          // Refresh modal to remove delete button
          setTimeout(() => {
            closeEditArtistModal();
            openEditArtistModal(currentEditingArtistId);
          }, 1000);

        } catch (err) {
          console.error('Error deleting profile picture:', err);
          document.getElementById('profilePicStatus').textContent = 'Delete failed';
          document.getElementById('profilePicStatus').style.color = '#FF3B30';
          alert('Error deleting image: ' + err.message);
        }
      }

      async function deleteBackgroundImage() {
        if (!confirm('Are you sure you want to delete the background image?')) return;

        try {
          document.getElementById('backgroundImgStatus').textContent = 'Deleting...';
          document.getElementById('backgroundImgStatus').style.color = '#007AFF';

          // Update database to remove URL
          const { error } = await supabase
            .from('artists')
            .update({ background_image_url: null })
            .eq('id', currentEditingArtistId);

          if (error) throw error;

          // Update UI
          uploadedBackgroundImage = null;
          document.getElementById('currentBackgroundImg').style.backgroundImage = '';
          document.getElementById('currentBackgroundImg').textContent = 'No Image';
          document.getElementById('backgroundImgStatus').textContent = 'Image deleted successfully';
          document.getElementById('backgroundImgStatus').style.color = '#34C759';

          console.log('Background image deleted successfully');

          // Refresh modal to remove delete button
          setTimeout(() => {
            closeEditArtistModal();
            openEditArtistModal(currentEditingArtistId);
          }, 1000);

        } catch (err) {
          console.error('Error deleting background image:', err);
          document.getElementById('backgroundImgStatus').textContent = 'Delete failed';
          document.getElementById('backgroundImgStatus').style.color = '#FF3B30';
          alert('Error deleting image: ' + err.message);
        }
      }

      // Make delete functions globally accessible
      window.deleteProfilePicture = deleteProfilePicture;
      window.deleteBackgroundImage = deleteBackgroundImage;

      // Save Artist Changes Function
      async function saveArtistChanges(event) {
        event.preventDefault();

        console.log('Saving artist changes...');

        const updateData = {
          name: document.getElementById('customEditArtistName').value,
          email: document.getElementById('customEditArtistEmail').value || null,
          short_description: document.getElementById('customEditArtistShortDesc').value || null,
          bio: document.getElementById('customEditArtistBio').value || null,
          instagram: document.getElementById('customEditArtistInstagram').value || null,
          rank: document.getElementById('customEditArtistRank').value || null,
          style: document.getElementById('customEditArtistStyle').value || null,
          is_guest: document.getElementById('customEditArtistType').value === 'guest',
          city_location: document.getElementById('customEditArtistLocation').value || null
        };

        // Add uploaded images if any
        if (uploadedProfilePicture) {
          updateData.profile_picture_url = uploadedProfilePicture;
          console.log('ðŸ’¾ Saving profile picture URL:', uploadedProfilePicture);
        }
        if (uploadedBackgroundImage) {
          updateData.background_image_url = uploadedBackgroundImage;
          console.log('ðŸ’¾ Saving background image URL:', uploadedBackgroundImage);
        }

        const { data, error } = await supabase
          .from('artists')
          .update(updateData)
          .eq('id', currentEditingArtistId);

        if (error) {
          console.error('âŒ Error saving artist:', error);
          alert('Error: ' + error.message);
          return;
        }

        console.log('âœ… Artist updated successfully');
        alert('âœ… Artist updated successfully!');

        closeEditArtistModal();

        // Clear cache and reload
        artistsCache = [];
        await loadInitialData();
        await loadArtists();
      }

      // Make saveArtistChanges globally accessible
      window.saveArtistChanges = saveArtistChanges;

      // Current Artist ID for modal tabs
      let currentArtistIdInModal = null;

      // View Artist Profile Functions - Apple-Inspired Design with Images
      window.viewArtistProfile = async function(artistId) {
        const artist = artistsCache.find(a => a.id === artistId) || allArtists.find(a => a.id === artistId);
        if (!artist) {
          alert('Artist not found');
          return;
        }

        // Store current artist ID for tab switching
        currentArtistIdInModal = artistId;

        const modalHtml = `
          <div id="customViewArtistModal" style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
          ">
            <div style="
              background: white;
              border-radius: 8px;
              width: 90%;
              max-width: 800px;
              max-height: 90vh;
              overflow: hidden;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              position: relative;
            ">
              <!-- Close Button - Top Right -->
              <button onclick="closeViewArtistModal()" style="
                position: absolute;
                top: 16px;
                right: 16px;
                background: rgba(0,0,0,0.5);
                backdrop-filter: blur(10px);
                border: none;
                color: white;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                font-size: 18px;
                cursor: pointer;
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
              " onmouseover="this.style.background='rgba(0,0,0,0.7)'" onmouseout="this.style.background='rgba(0,0,0,0.5)'">Ã—</button>

              <!-- Background Header -->
              <div style="
                height: 300px;
                background: ${artist.background_image_url ? `url('${artist.background_image_url}')` : 'linear-gradient(135deg, #e0e0e0 0%, #9e9e9e 100%)'};
                background-size: cover;
                background-position: center;
                position: relative;
                display: flex;
                align-items: flex-end;
                padding: 30px;
              ">
                <div style="
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  bottom: 0;
                  background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.7) 100%);
                "></div>

                <!-- Profile Picture & Name -->
                <div style="position: relative; z-index: 2; display: flex; align-items: flex-end; gap: 20px; width: 100%;">
                  ${artist.profile_picture_url ? `
                    <img src="${artist.profile_picture_url}" style="
                      width: 120px;
                      height: 120px;
                      border-radius: 50%;
                      border: 4px solid white;
                      object-fit: cover;
                    ">
                  ` : `
                    <div style="
                      width: 120px;
                      height: 120px;
                      border-radius: 50%;
                      border: 4px solid white;
                      background: rgba(255,255,255,0.2);
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 48px;
                      color: white;
                      font-weight: 600;
                    ">
                      ${artist.name.charAt(0).toUpperCase()}
                    </div>
                  `}

                  <div style="flex: 1; color: white;">
                    <h2 style="margin: 0 0 8px 0; font-size: 32px; font-weight: 600;">${artist.name}</h2>
                    ${artist.rank ? `<span style="
                      display: inline-block;
                      padding: 6px 12px;
                      background: rgba(255,255,255,0.2);
                      backdrop-filter: blur(10px);
                      border-radius: 6px;
                      font-size: 14px;
                      font-weight: 600;
                    ">${artist.rank}</span>` : ''}
                    ${artist.is_guest ? `<span style="
                      display: inline-block;
                      padding: 6px 12px;
                      background: rgba(90, 200, 250, 0.3);
                      backdrop-filter: blur(10px);
                      border-radius: 6px;
                      font-size: 14px;
                      font-weight: 600;
                      margin-left: 8px;
                    ">Guest</span>` : ''}
                  </div>
                </div>
              </div>

              <!-- Content -->
              <div style="padding: 32px; overflow-y: auto; max-height: calc(90vh - 300px);">
                <!-- Short Description -->
                ${artist.short_description ? `
                  <div style="margin-bottom: 24px;">
                    <label style="font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; display: block; margin-bottom: 8px;">Short Description</label>
                    <p style="margin: 0; font-size: 14px; line-height: 1.6; color: #1d1d1f;">${artist.short_description}</p>
                  </div>
                ` : ''}

                <!-- Info Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                  <div>
                    <label style="font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase;">Email</label>
                    <p style="margin: 4px 0 0 0; font-size: 14px;">${artist.email || 'N/A'}</p>
                  </div>

                  <div>
                    <label style="font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase;">Instagram</label>
                    <p style="margin: 4px 0 0 0; font-size: 14px;">
                      ${artist.instagram ? `<a href="https://instagram.com/${artist.instagram.replace('@', '')}" target="_blank" style="color: #007AFF; text-decoration: none;">@${artist.instagram.replace('@', '')}</a>` : 'N/A'}
                    </p>
                  </div>

                  <div>
                    <label style="font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase;">Type</label>
                    <p style="margin: 4px 0 0 0; font-size: 14px;">${artist.is_guest ? 'Guest Artist' : 'Resident'}</p>
                  </div>

                  <div>
                    <label style="font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase;">Rank</label>
                    <p style="margin: 4px 0 0 0; font-size: 14px;">${artist.rank || 'No rank'}</p>
                  </div>

                  <div>
                    <label style="font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase;">Style</label>
                    <p style="margin: 4px 0 0 0; font-size: 14px;">${artist.style || 'N/A'}</p>
                  </div>
                </div>

                <!-- Bio -->
                ${artist.bio ? `
                  <div style="margin-bottom: 24px;">
                    <label style="font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; display: block; margin-bottom: 8px;">Bio</label>
                    <p style="margin: 0; font-size: 14px; line-height: 1.6; color: #1d1d1f;">${artist.bio}</p>
                  </div>
                ` : ''}

                <!-- Images Section -->
                <div style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 24px; margin-bottom: 24px;">
                  <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Images</h3>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                      <label style="font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; display: block; margin-bottom: 8px;">Profile Picture</label>
                      ${artist.profile_picture_url ? `
                        <img src="${artist.profile_picture_url}" style="
                          width: 100%;
                          height: 200px;
                          object-fit: cover;
                          border-radius: 8px;
                        ">
                        <div style="margin-top: 8px;">
                          <a href="${artist.profile_picture_url}" target="_blank" style="font-size: 11px; color: #007AFF; text-decoration: none;">Open full size</a>
                        </div>
                      ` : '<div style="width: 100%; height: 200px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #86868b;">No Image</div>'}
                    </div>

                    <div>
                      <label style="font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; display: block; margin-bottom: 8px;">Background Image</label>
                      ${artist.background_image_url ? `
                        <img src="${artist.background_image_url}" style="
                          width: 100%;
                          height: 200px;
                          object-fit: cover;
                          border-radius: 8px;
                        ">
                        <div style="margin-top: 8px;">
                          <a href="${artist.background_image_url}" target="_blank" style="font-size: 11px; color: #007AFF; text-decoration: none;">Open full size</a>
                        </div>
                      ` : '<div style="width: 100%; height: 200px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #86868b;">No Image</div>'}
                    </div>
                  </div>
                </div>

                <!-- Tab Navigation -->
                <div style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 24px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="display: flex; gap: 0; border-bottom: 2px solid rgba(0,0,0,0.1);">
                      <button class="artist-profile-tab active" data-tab="projects" onclick="showArtistProfileTab('projects')" style="
                        padding: 12px 20px;
                        background: none;
                        border: none;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        color: #007aff;
                        border-bottom: 2px solid #007aff;
                        margin-bottom: -2px;
                        transition: all 0.2s;
                      ">Completed Projects</button>
                      <button class="artist-profile-tab" data-tab="guestspots" onclick="showArtistProfileTab('guestspots')" style="
                        padding: 12px 20px;
                        background: none;
                        border: none;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        color: #86868b;
                        border-bottom: 2px solid transparent;
                        margin-bottom: -2px;
                        transition: all 0.2s;
                      ">Waitlist</button>
                    </div>
                    <button onclick="closeViewArtistModal(); openEditArtistModal('${artist.id}');" style="
                      padding: 8px 16px;
                      background: #007AFF;
                      color: white;
                      border: none;
                      border-radius: 8px;
                      font-weight: 500;
                      font-size: 14px;
                      cursor: pointer;
                      display: flex;
                      align-items: center;
                      gap: 6px;
                    ">âœï¸ Edit</button>
                  </div>

                  <!-- Tab Content -->
                  <div id="artist-profile-tab-content" style="min-height: 200px;">
                    <div id="artistProjectsList" style="display: flex; flex-direction: column; gap: 12px;">
                      <div style="padding: 20px; text-align: center; color: #86868b;">Loading projects...</div>
                    </div>
                  </div>
                </div>

                <!-- Actions -->
                <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                  <button onclick="closeViewArtistModal()" style="
                    padding: 12px 24px;
                    background: #f0f0f0;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                  ">Close</button>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Load artist projects asynchronously
        try {
          console.log('Loading projects for artist:', artistId);

          const { data: projects, error } = await supabase
            .from('appointments')
            .select(`
              *,
              customer:customers(first_name, last_name, email, instagram),
              location:locations!appointments_location_id_fkey(name, city)
            `)
            .eq('artist_id', artistId)
            .not('artist_id', 'is', null)
            .order('start', { ascending: false });

          if (error) {
            console.error('Error loading artist projects:', error);
            document.getElementById('artistProjectsList').innerHTML =
              '<div style="padding: 20px; text-align: center; color: #FF3B30;">Error loading projects</div>';
            return;
          }

          console.log('Projects loaded:', projects?.length || 0);
          renderArtistProjectsSection(projects || []);

        } catch (err) {
          console.error('Error loading artist projects:', err);
          document.getElementById('artistProjectsList').innerHTML =
            '<div style="padding: 20px; text-align: center; color: #FF3B30;">Error loading projects</div>';
        }
      };

      function closeViewArtistModal() {
        const modal = document.getElementById('customViewArtistModal');
        if (modal) modal.remove();
      }

      // Make globally accessible
      window.closeViewArtistModal = closeViewArtistModal;

      // Render Artist Projects Section
      function renderArtistProjectsSection(appointments) {
        const container = document.getElementById('artistProjectsList');

        if (!container) {
          console.error('artistProjectsList container not found');
          return;
        }

        if (!appointments || appointments.length === 0) {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: #86868b; background: rgba(0,0,0,0.02); border-radius: 8px;">No appointments found</div>';
          return;
        }

        // Group appointments by project_number
        const projectGroups = {};

        appointments.forEach(appointment => {
          const projectNum = appointment.project_number || 'no-project';

          if (!projectGroups[projectNum]) {
            projectGroups[projectNum] = {
              project_number: projectNum,
              appointments: [],
              customer_name: null,
              customer_email: null,
              first_appointment: null,
              last_appointment: null
            };
          }

          projectGroups[projectNum].appointments.push(appointment);

          // Set customer info (all appointments in project have same customer)
          if (appointment.customer) {
            projectGroups[projectNum].customer_name =
              `${appointment.customer.first_name || ''} ${appointment.customer.last_name || ''}`.trim();
            projectGroups[projectNum].customer_email = appointment.customer.email;
          }
        });

        // Calculate date ranges for each project
        Object.values(projectGroups).forEach(project => {
          project.appointments.sort((a, b) => new Date(a.start) - new Date(b.start));
          project.first_appointment = project.appointments[0]?.start;
          project.last_appointment = project.appointments[project.appointments.length - 1]?.start;
        });

        console.log('Grouped into', Object.keys(projectGroups).length, 'projects');

        // Convert to array and sort by most recent
        const projects = Object.values(projectGroups)
          .sort((a, b) => new Date(b.last_appointment) - new Date(a.last_appointment));

        // Render project cards
        container.innerHTML = projects.map((project, index) => {
          const projectId = project.project_number.replace(/[^a-zA-Z0-9]/g, '-');

          return `
            <div class="project-card" data-project-number="${project.project_number}">
              <div class="project-header" onclick="toggleArtistProjectDetails('${projectId}')" style="cursor: pointer;">
                <div class="project-info">
                  <div class="project-title">
                    <span class="project-badge">${project.project_number === 'no-project' ? 'Ungrouped' : project.project_number}</span>
                    <span class="customer-name">${project.customer_name || project.customer_email || 'Unknown Customer'}</span>
                  </div>
                  <div class="project-meta">
                    <span class="appointment-count">${project.appointments.length} ${project.appointments.length === 1 ? 'session' : 'sessions'}</span>
                    <span class="date-range">
                      ${formatProjectDate(project.first_appointment)}
                      ${project.appointments.length > 1 ? ' â†’ ' + formatProjectDate(project.last_appointment) : ''}
                    </span>
                  </div>
                </div>
                <button class="expand-btn" aria-label="Toggle details" style="background: none; border: none; cursor: pointer;">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>

              <div class="project-details" id="project-details-${projectId}" style="display: none;">
                ${project.appointments.map(appointment => {
                  const statusClass = appointment.status ? `status-${appointment.status}` : '';
                  return `
                    <div class="appointment-item" style="cursor: pointer; padding: 12px; border-radius: 6px; transition: all 0.2s;" onclick="openAppointmentFromProfile('${appointment.id}')" onmouseover="this.style.backgroundColor='rgba(0,0,0,0.03)'" onmouseout="this.style.backgroundColor=''">
                      <div class="appointment-date" style="font-size: 13px; color: #86868b; margin-bottom: 4px;">
                        ${formatProjectDateTime(appointment.start)}
                      </div>
                      <div class="appointment-info" style="display: flex; gap: 8px; align-items: center; margin-bottom: 4px;">
                        <span class="booking-type" style="font-weight: 600; font-size: 14px;">${appointment.booking_type || 'Appointment'}</span>
                        ${appointment.status ? `<span class="status-badge ${statusClass}">${appointment.status}</span>` : ''}
                      </div>
                      ${appointment.notes ? `<div class="appointment-notes" style="font-size: 13px; color: #86868b;">${appointment.notes}</div>` : ''}
                      ${appointment.placement ? `<div class="appointment-notes" style="font-size: 13px; color: #86868b;">Placement: ${appointment.placement}</div>` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
      }

      // Toggle function for artist project details
      window.toggleArtistProjectDetails = function(projectId) {
        const detailsEl = document.getElementById(`project-details-${projectId}`);

        if (!detailsEl) return;

        const isVisible = detailsEl.style.display !== 'none';

        // Toggle visibility
        detailsEl.style.display = isVisible ? 'none' : 'block';

        // Rotate expand button
        const expandBtn = detailsEl.previousElementSibling?.querySelector('.expand-btn svg');
        if (expandBtn) {
          expandBtn.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
        }
      };

      // Helper function for project dates
      function formatProjectDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }

      // Helper function for project date-time
      function formatProjectDateTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('de-DE', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      // ============================================
      // Artist Profile Tab Functions
      // ============================================
      async function loadArtistGuestSpots(artistId) {
        const container = document.getElementById('artist-profile-tab-content');
        if (!container) return;

        container.innerHTML = '<div style="text-align:center;padding:40px;">LÃ¤dt...</div>';

        try {
          const { data, error } = await supabase
            .from('artist_guest_spots')
            .select('*')
            .eq('artist_id', artistId)
            .order('status_order', { ascending: true })
            .order('date_from', { ascending: false });

          if (error) {
            console.error('Error loading artist guest spots:', error);
            throw error;
          }

          if (!data || data.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:60px;color:var(--muted);">Keine Guest Spots vorhanden</div>';
            return;
          }

          const statusConfig = {
            'active': { color: '#34c759', label: 'Active', icon: '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="6"/></svg>' },
            'upcoming': { color: '#007aff', label: 'Upcoming', icon: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' },
            'waiting': { color: '#ff9500', label: 'Waiting', icon: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>' },
            'completed': { color: '#8e8e93', label: 'Completed', icon: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>' },
            'canceled': { color: '#ff3b30', label: 'Canceled', icon: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>' }
          };

          container.innerHTML = data.map(function(spot) {
            const config = statusConfig[spot.status] || { color: '#8e8e93', label: spot.status };
            const dateFrom = spot.date_from ? new Date(spot.date_from).toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' }) : 'N/A';
            const dateTo = spot.date_to ? new Date(spot.date_to).toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' }) : 'N/A';

            // Show date range or single date
            const dateDisplay = dateFrom === dateTo ? dateFrom : dateFrom + ' - ' + dateTo;

            // Show slot count badge if grouped (more than 1 slot)
            const slotCountBadge = spot.slot_count > 1
              ? '<span style="background:#8e8e93;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:8px;">' + spot.slot_count + ' Tage</span>'
              : '';

            return '<div style="padding:16px 20px;border:1px solid var(--border-color,#e0e0e0);border-radius:12px;margin-bottom:12px;">' +
              '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                '<div>' +
                  '<p style="margin:0;font-weight:600;font-size:15px;">' + (spot.location_name || 'Unknown Location') + (spot.location_city ? ' (' + spot.location_city + ')' : '') + '</p>' +
                  '<p style="margin:6px 0 0 0;color:var(--muted);font-size:13px;">' + dateDisplay + slotCountBadge + '</p>' +
                  (spot.cancel_reason ? '<p style="margin:8px 0 0 0;color:#ff3b30;font-size:13px;">Grund: ' + spot.cancel_reason + '</p>' : '') +
                '</div>' +
                '<span style="background:' + config.color + ';color:white;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:500;display:inline-flex;align-items:center;gap:4px;">' + (config.icon || '') + ' ' + config.label + '</span>' +
              '</div>' +
            '</div>';
          }).join('');

        } catch (error) {
          console.error('Error loading artist guest spots:', error);
          container.innerHTML = '<div style="text-align:center;padding:40px;color:#ff3b30;">Fehler beim Laden</div>';
        }
      }

      function showArtistProfileTab(tab) {
        document.querySelectorAll('.artist-profile-tab').forEach(function(btn) {
          btn.classList.remove('active');
          btn.style.borderBottomColor = 'transparent';
          btn.style.color = '#86868b';
        });

        const activeBtn = document.querySelector('.artist-profile-tab[data-tab="' + tab + '"]');
        if (activeBtn) {
          activeBtn.classList.add('active');
          activeBtn.style.borderBottomColor = '#007aff';
          activeBtn.style.color = '#007aff';
        }

        if (tab === 'projects') {
          loadArtistCompletedProjects(currentArtistIdInModal);
        } else if (tab === 'guestspots') {
          loadArtistGuestSpots(currentArtistIdInModal);
        }
      }

      // Load artist completed projects (for tab switching)
      async function loadArtistCompletedProjects(artistId) {
        const container = document.getElementById('artist-profile-tab-content');
        if (!container) return;

        container.innerHTML = '<div id="artistProjectsList" style="display: flex; flex-direction: column; gap: 12px;"><div style="padding: 20px; text-align: center; color: #86868b;">Loading projects...</div></div>';

        try {
          const { data: projects, error } = await supabase
            .from('appointments')
            .select(`
              *,
              customer:customers(first_name, last_name, email, instagram),
              location:locations!appointments_location_id_fkey(name, city)
            `)
            .eq('artist_id', artistId)
            .not('artist_id', 'is', null)
            .order('start', { ascending: false });

          if (error) throw error;

          renderArtistProjectsSection(projects || []);

        } catch (err) {
          console.error('Error loading artist projects:', err);
          document.getElementById('artistProjectsList').innerHTML =
            '<div style="padding: 20px; text-align: center; color: #FF3B30;">Error loading projects</div>';
        }
      }

      // Make tab functions globally accessible
      window.showArtistProfileTab = showArtistProfileTab;
      window.loadArtistGuestSpots = loadArtistGuestSpots;
      window.loadArtistCompletedProjects = loadArtistCompletedProjects;

      // Open appointment from profile (if not already defined)
      if (typeof window.openAppointmentFromProfile === 'undefined') {
        window.openAppointmentFromProfile = function(appointmentId) {
          console.log('Opening appointment:', appointmentId);
          // This function should be implemented elsewhere to open appointment details
          alert('Open appointment: ' + appointmentId);
        };
      }

      // Keep old closeViewProfile for backward compatibility
      window.closeViewProfile = function() {
        // Try closing both old and new modals
        closeViewArtistModal();
        const oldModal = document.getElementById('viewArtistProfileModal');
        if (oldModal) {
          oldModal.classList.remove('active');
          const content = document.getElementById('viewArtistProfileContent');
          if (content) content.innerHTML = '';
          const title = document.querySelector('#viewArtistProfileModal h3');
          if (title) title.textContent = 'Artist Profile';
        }
      };

      // Update editArtistFromProfile to use new modal
      window.editArtistFromProfile = function(artistId) {
        closeViewArtistModal();
        openEditArtistModal(artistId);
      };


      // Edit Customer Functions
      window.editCustomer = async function(customerId) {
        try {
          const { data, error } = await supabase
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();
          
          if (error) throw error;
          if (!data) return;
          
          currentEditCustomerId = customerId;
          
          console.log('Loading customer for edit:', data);
          console.log('Customer rank:', data.rank);
          
          document.getElementById('editCustomerFirstName').value = data.first_name || '';
          document.getElementById('editCustomerLastName').value = data.last_name || '';
          document.getElementById('editCustomerEmail').value = data.email || '';
          document.getElementById('editCustomerPhone').value = data.phone || '';
          document.getElementById('editCustomerInstagram').value = data.instagram || '';
          document.getElementById('editCustomerRank').value = data.rank || '';
          
          console.log('Rank field set to:', document.getElementById('editCustomerRank').value);
          
          document.getElementById('editCustomerModal').classList.add('active');
        } catch (err) {
          alert('Error loading customer: ' + err.message);
        }
      };
      
      document.getElementById('cancelEditCustomer')?.addEventListener('click', () => {
        document.getElementById('editCustomerModal').classList.remove('active');
        currentEditCustomerId = null;
      });
      
      document.getElementById('editCustomerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const firstName = document.getElementById('editCustomerFirstName').value.trim();
        const lastName = document.getElementById('editCustomerLastName').value.trim();
        const email = document.getElementById('editCustomerEmail').value.trim();
        const phone = document.getElementById('editCustomerPhone').value.trim();
        const instagram = document.getElementById('editCustomerInstagram').value.trim();
        const rank = document.getElementById('editCustomerRank').value;

        if (!firstName || !lastName || !email) {
          return alert('First name, last name, and email are required');
        }

        try {
          console.log('Updating customer with rank:', rank);
          console.log('Customer ID to update:', currentEditCustomerId);

          const updateData = {
            first_name: firstName,
            last_name: lastName,
            email,
            phone: phone || null,
            instagram: instagram || null,
            rank: rank || null
          };
          
          console.log('Update data:', updateData);
          
          const { data, error } = await supabase
            .from('customers')
            .update(updateData)
            .eq('id', currentEditCustomerId)
            .select();
          
          console.log('Update result:', data, 'Error:', error);
          
          if (error) throw error;
          
          if (!data || data.length === 0) {
            console.error('WARNING: Update returned no data. Customer ID might be wrong:', currentEditCustomerId);
            alert('Warning: Customer was updated but could not verify the result. Please refresh the page.');
          }
          
          console.log('Customer updated successfully, reloading list...');
          
          document.getElementById('editCustomerModal').classList.remove('active');
          currentEditCustomerId = null;

          // Clear cache and reload customers to show updated data
          customersCache = []; // âœ… Clear cache to force reload
          await loadCustomers();

          alert('Customer updated successfully!');
        } catch (err) {
          alert('Error updating customer: ' + err.message);
        }
      });
      
      // Delete Customer Function
      window.deleteCustomer = async function(customerId) {
        try {
          const { data, error } = await supabase
            .from('customers')
            .select('first_name, last_name')
            .eq('id', customerId)
            .single();

          if (error) throw error;
          if (!data) return;

          if (!confirm(`Are you sure you want to delete "${data.first_name} ${data.last_name}"? This action cannot be undone.`)) {
            return;
          }

          const { error: deleteError } = await supabase
            .from('customers')
            .delete()
            .eq('id', customerId);

          if (deleteError) throw deleteError;

          customersCache = []; // âœ… Clear cache to force reload
          await loadCustomers();
          alert('Customer deleted successfully!');
        } catch (err) {
          alert('Error deleting customer: ' + err.message);
        }
      };

      // Customer Profile Functions
      let currentCustomerProfileId = null;

      window.openCustomerProfile = async function(customerId) {
        console.log('ðŸ” Opening customer profile for:', customerId);
        currentCustomerProfileId = customerId;

        try {
          // Show loading state
          document.getElementById('customerProfileModal').classList.add('active');
          document.getElementById('customerProfileName').textContent = 'Loading...';

          // 1. Fetch customer data
          const { data: customer, error: customerError } = await supabase
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();

          if (customerError) throw customerError;
          if (!customer) {
            alert('Customer not found');
            closeCustomerProfile();
            return;
          }

          console.log('âœ… Customer loaded:', customer);

          // 2. Fetch customer's requests
          const { data: requests, error: requestsError } = await supabase
            .from('requests')
            .select('*')
            .eq('customer_id', customerId)
            .order('created_at', { ascending: false });

          if (requestsError) {
            console.error('Error loading requests:', requestsError);
          }

          console.log('âœ… Requests loaded:', requests?.length || 0);

          // 3. Fetch customer's appointments
          const { data: appointments, error: appointmentsError } = await supabase
            .from('appointments')
            .select(`
              *,
              artist:artists(name, instagram),
              location:locations!appointments_location_id_fkey(name, city)
            `)
            .eq('customer_id', customerId)
            .order('start', { ascending: false });

          if (appointmentsError) {
            console.error('Error loading appointments:', appointmentsError);
          }

          console.log('âœ… Appointments loaded:', appointments?.length || 0);

          // 4. Render the profile
          renderCustomerProfile(customer, requests || [], appointments || []);

        } catch (err) {
          console.error('âŒ Error loading customer profile:', err);
          alert('Error loading customer profile: ' + err.message);
          closeCustomerProfile();
        }
      };

      function renderCustomerProfile(customer, requests, appointments) {
        // Update header
        document.getElementById('customerProfileName').textContent =
          `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unnamed Customer';

        // Render rank badge - direkt aus Datenbank (bereits korrekt gesetzt)
        const rank = customer.rank || '';
        const rankNames = { 'Platinum': 'Platinum', 'platinum': 'Platinum', 'Gold': 'Gold', 'gold': 'Gold', 'Silver': 'Silver', 'silver': 'Silver', 'Silber': 'Silver', 'silber': 'Silver', 'Bronze': 'Bronze', 'bronze': 'Bronze', 'Neukunde': 'Neukunde', 'neukunde': 'Neukunde', 'new_customer': 'Neukunde', '': 'Neukunde' };
        const rankDisplayText = rankNames[rank] || 'Neukunde';
        const rankClass = rank?.toLowerCase() || 'neukunde';
        const rankBadge = `<span class="rank-badge rank-${rankClass}" style="display:inline-block; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; text-transform:uppercase;">${rankDisplayText}</span>`;
        document.getElementById('customerProfileRankBadge').innerHTML = rankBadge;

        // Fill form fields
        document.getElementById('profileCustomerFirstName').value = customer.first_name || '';
        document.getElementById('profileCustomerLastName').value = customer.last_name || '';
        document.getElementById('profileCustomerEmail').value = customer.email || '';
        document.getElementById('profileCustomerPhone').value = customer.phone || '';
        document.getElementById('profileCustomerInstagram').value = customer.instagram || '';
        document.getElementById('profileCustomerRank').value = customer.rank || '';

        // Render project timeline (NEW: combines requests and appointments)
        renderCustomerProjectsTimeline(requests, appointments);

        // Render requests section
        renderCustomerRequestsSection(requests);

        // Render appointments section
        renderCustomerAppointmentsSection(appointments);
      }

      // NEW: Customer Project Timeline
      function renderCustomerProjectsTimeline(requests, appointments) {
        const container = document.getElementById('customerProjectsTimeline');

        if (!container) {
          console.log('âš ï¸ customerProjectsTimeline container not found - add to HTML');
          return;
        }

        // Group by project_number
        const projects = groupCustomerProjects(requests, appointments);

        console.log('ðŸ“¦ Customer has', Object.keys(projects).length, 'projects');

        const projectsArray = Object.values(projects)
          .sort((a, b) => {
            const aDate = a.appointments[0]?.start || '2000-01-01';
            const bDate = b.appointments[0]?.start || '2000-01-01';
            return new Date(bDate) - new Date(aDate);
          });

        if (projectsArray.length === 0) {
          container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--muted);">No projects yet</div>';
          return;
        }

        container.innerHTML = projectsArray.map(project => `
          <div class="customer-project-card ${project.status}">
            <div class="project-status-indicator"></div>
            <div class="project-content">
              <div class="project-header-row">
                <span class="project-number-small">${project.project_number}</span>
                <span class="project-status-badge status-${project.status}">
                  ${project.status === 'completed' ? 'âœ… Completed' :
                    project.status === 'in_progress' ? 'ðŸ”„ In Progress' :
                    project.status === 'requested' ? 'ðŸ“‹ Requested' : 'â“ Unknown'}
                </span>
              </div>
              <div class="project-artist">
                with ${project.artist_name || 'Artist TBD'}
              </div>
              <div class="project-stats">
                <span>${project.appointments.length} appointments</span>
                ${project.requests.length > 0 ? `<span>â€¢</span><span>${project.requests.length} requests</span>` : ''}
              </div>
              ${project.appointments.length > 0 ? `
                <div class="project-timeline-dates">
                  ${formatProjectDate(project.appointments[0].start)}
                  ${project.appointments.length > 1 ? 'â†’ ' + formatProjectDate(project.appointments[project.appointments.length - 1].start) : ''}
                </div>
              ` : ''}
            </div>
          </div>
        `).join('');
      }

      function groupCustomerProjects(requests, appointments) {
        const projects = {};

        // Group appointments
        appointments.forEach(appointment => {
          const projectNumber = appointment.project_number || 'no-project';

          if (!projects[projectNumber]) {
            projects[projectNumber] = {
              project_number: projectNumber,
              requests: [],
              appointments: [],
              artist_name: null,
              status: 'unknown'
            };
          }

          projects[projectNumber].appointments.push(appointment);
          if (appointment.artist) {
            projects[projectNumber].artist_name = appointment.artist.name;
          }
        });

        // Add requests if they have project_number
        requests.forEach(request => {
          if (request.project_number && projects[request.project_number]) {
            projects[request.project_number].requests.push(request);
          }
        });

        // Calculate project status
        Object.values(projects).forEach(project => {
          const hasFinished = project.appointments.some(a => a.status === 'finished' || a.status === 'completed');
          const hasScheduled = project.appointments.some(a => a.status === 'scheduled');

          if (hasFinished && !hasScheduled) {
            project.status = 'completed';
          } else if (hasScheduled) {
            project.status = 'in_progress';
          } else if (project.requests.length > 0) {
            project.status = 'requested';
          } else {
            project.status = 'unknown';
          }

          // Sort appointments by date
          project.appointments.sort((a, b) => new Date(a.start) - new Date(b.start));
        });

        return projects;
      }

      function renderCustomerRequestsSection(requests) {
        const container = document.getElementById('customerRequestsList');

        if (!requests || requests.length === 0) {
          container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--macos-text-secondary); background:rgba(0,0,0,0.02); border-radius:8px;">No requests found</div>';
          return;
        }

        // Group requests by project_number
        const projectGroups = {};

        requests.forEach(request => {
          const projectNum = request.project_number || `ungrouped-req-${request.id}`;
          if (!projectGroups[projectNum]) {
            projectGroups[projectNum] = {
              project_number: projectNum,
              requests: []
            };
          }
          projectGroups[projectNum].requests.push(request);
        });

        console.log('ðŸ“Š Customer requests grouped into', Object.keys(projectGroups).length, 'projects');

        const sortedProjects = Object.values(projectGroups).sort((a, b) =>
          new Date(b.requests[0].created_at) - new Date(a.requests[0].created_at)
        );

        container.innerHTML = sortedProjects.map(project => {
          // If only one request and no project number, show it directly
          if (project.requests.length === 1 && project.project_number.startsWith('ungrouped')) {
            const request = project.requests[0];
            const statusColors = {
              'open_request': { bg: 'rgba(255, 149, 0, 0.1)', color: '#ff9500' },
              'pending': { bg: 'rgba(255, 204, 0, 0.1)', color: '#ffcc00' },
              'scheduled': { bg: 'rgba(0, 113, 227, 0.1)', color: '#0071e3' },
              'finished': { bg: 'rgba(52, 199, 89, 0.1)', color: '#34c759' },
              'canceled': { bg: 'rgba(255, 59, 48, 0.1)', color: '#ff3b30' }
            };
            const statusStyle = statusColors[request.status] || statusColors['open_request'];

            const bookingTypeBadge = request.booking_type
              ? `<span style="background:rgba(0,0,0,0.06); padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; text-transform:uppercase;">${request.booking_type.replace('_', ' ')}</span>`
              : '';

            return `
              <div class="request-card" style="background:rgba(255,255,255,0.7); backdrop-filter:saturate(180%) blur(20px); border-radius:8px; padding:16px; border:1px solid rgba(0,0,0,0.1); transition:all 0.2s ease; cursor:pointer;" onclick="editRequest('${request.id}')" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                  <div>
                    <span style="font-size:12px; color:var(--macos-text-secondary);">Request #${request.id.substring(0, 8)}</span>
                    <div style="margin-top:4px;">${bookingTypeBadge}</div>
                  </div>
                  <span style="background:${statusStyle.bg}; color:${statusStyle.color}; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:600; text-transform:uppercase;">${request.status.replace('_', ' ')}</span>
                </div>
                <div style="font-size:13px; color:var(--macos-text-secondary); margin-bottom:8px;">
                  Created: ${new Date(request.created_at).toLocaleDateString()}
                  ${request.scheduled_date ? `â€¢ Scheduled: ${new Date(request.scheduled_date).toLocaleDateString()}` : ''}
                </div>
                ${request.placement ? `<div style="font-size:13px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Placement:</strong> ${request.placement}</div>` : ''}
                ${request.size ? `<div style="font-size:13px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Size:</strong> ${request.size}</div>` : ''}
                ${request.style ? `<div style="font-size:13px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Style:</strong> ${request.style}</div>` : ''}
                ${request.description ? `<div style="font-size:13px; color:var(--macos-text-secondary); margin-top:8px; line-height:1.5;">${request.description.substring(0, 150)}${request.description.length > 150 ? '...' : ''}</div>` : ''}
              </div>
            `;
          }

          // Multiple requests in same project - show as grouped
          const firstRequest = project.requests[0];
          const lastRequest = project.requests[project.requests.length - 1];

          return `
            <div class="project-group">
              <div class="project-header" onclick="toggleProjectDetails(this)">
                <div class="project-info">
                  <h4>${project.project_number}</h4>
                  <div>
                    <span class="project-stats">
                      ${project.requests.length} Request${project.requests.length > 1 ? 's' : ''} â€¢
                      ${new Date(firstRequest.created_at).toLocaleDateString('de-DE')}
                    </span>
                  </div>
                </div>
                <button class="expand-btn">â–¼</button>
              </div>

              <div class="project-details">
                ${project.requests.map(request => {
                  const statusColors = {
                    'open_request': { bg: 'rgba(255, 149, 0, 0.1)', color: '#ff9500' },
                    'pending': { bg: 'rgba(255, 204, 0, 0.1)', color: '#ffcc00' },
                    'scheduled': { bg: 'rgba(0, 113, 227, 0.1)', color: '#0071e3' },
                    'finished': { bg: 'rgba(52, 199, 89, 0.1)', color: '#34c759' },
                    'canceled': { bg: 'rgba(255, 59, 48, 0.1)', color: '#ff3b30' }
                  };
                  const statusStyle = statusColors[request.status] || statusColors['open_request'];

                  const bookingTypeBadge = request.booking_type
                    ? `<span style="background:rgba(0,0,0,0.06); padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; text-transform:uppercase;">${request.booking_type.replace('_', ' ')}</span>`
                    : '';

                  return `
                    <div class="request-card" style="background:rgba(255,255,255,0.9); border-radius:8px; padding:14px; margin-bottom:8px; border:1px solid rgba(0,0,0,0.08); cursor:pointer; transition:all 0.2s;" onclick="editRequest('${request.id}')" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                        <div>
                          <span style="font-size:12px; color:var(--macos-text-secondary);">Request #${request.id.substring(0, 8)}</span>
                          <div style="margin-top:4px;">${bookingTypeBadge}</div>
                        </div>
                        <span style="background:${statusStyle.bg}; color:${statusStyle.color}; padding:3px 8px; border-radius:4px; font-size:10px; font-weight:600; text-transform:uppercase;">${request.status.replace('_', ' ')}</span>
                      </div>
                      <div style="font-size:12px; color:var(--macos-text-secondary); margin-bottom:6px;">
                        Created: ${new Date(request.created_at).toLocaleDateString()}
                      </div>
                      ${request.placement ? `<div style="font-size:12px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Placement:</strong> ${request.placement}</div>` : ''}
                      ${request.size ? `<div style="font-size:12px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Size:</strong> ${request.size}</div>` : ''}
                      ${request.style ? `<div style="font-size:12px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Style:</strong> ${request.style}</div>` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
      }

      function renderCustomerAppointmentsSection(appointments) {
        const container = document.getElementById('customerAppointmentsList');

        if (!appointments || appointments.length === 0) {
          container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--macos-text-secondary); background:rgba(0,0,0,0.02); border-radius:8px;">No appointments found</div>';
          return;
        }

        // Group appointments by project_number
        const projectGroups = {};

        appointments.forEach(appointment => {
          const projectNum = appointment.project_number || `ungrouped-apt-${appointment.id}`;
          if (!projectGroups[projectNum]) {
            projectGroups[projectNum] = {
              project_number: projectNum,
              appointments: [],
              artist: appointment.artist
            };
          }
          projectGroups[projectNum].appointments.push(appointment);
        });

        console.log('ðŸ“Š Customer appointments grouped into', Object.keys(projectGroups).length, 'projects');

        // Calculate project statistics
        Object.values(projectGroups).forEach(project => {
          project.appointments.sort((a, b) => new Date(a.start) - new Date(b.start));
          project.totalAppointments = project.appointments.length;
          project.firstAppointment = project.appointments[0];
          project.lastAppointment = project.appointments[project.appointments.length - 1];

          // Determine project status
          if (project.appointments.every(a => a.status === 'completed')) {
            project.status = 'Completed';
          } else if (project.appointments.some(a => a.status === 'scheduled')) {
            project.status = 'In Progress';
          } else {
            project.status = 'Scheduled';
          }
        });

        const sortedProjects = Object.values(projectGroups).sort((a, b) =>
          new Date(b.firstAppointment.start) - new Date(a.firstAppointment.start)
        );

        container.innerHTML = sortedProjects.map(project => {
          const artistName = project.artist ? project.artist.name : 'Unassigned';
          const artistInstagram = project.artist?.instagram
            ? ` (@${project.artist.instagram})`
            : '';

          const startDate = new Date(project.firstAppointment.start).toLocaleDateString('de-DE');
          const endDate = new Date(project.lastAppointment.start).toLocaleDateString('de-DE');
          const dateRange = startDate === endDate ? startDate : `${startDate} - ${endDate}`;

          const statusClass = project.status.toLowerCase().replace(' ', '-');

          return `
            <div class="project-group">
              <div class="project-header" onclick="toggleProjectDetails(this)">
                <div class="project-info">
                  <h4>${project.project_number.startsWith('ungrouped') ? 'No Project #' : project.project_number}</h4>
                  <div>
                    <span class="customer-name">${artistName}${artistInstagram}</span>
                    <span class="project-stats">
                      ${project.totalAppointments} Appointment${project.totalAppointments > 1 ? 's' : ''} â€¢ ${dateRange}
                    </span>
                    <span class="project-status ${statusClass}">${project.status}</span>
                  </div>
                </div>
                <button class="expand-btn">â–¼</button>
              </div>

              <div class="project-details">
                ${project.appointments.map(appointment => {
                  const statusColors = {
                    'scheduled': { bg: 'rgba(0, 113, 227, 0.1)', color: '#0071e3' },
                    'completed': { bg: 'rgba(52, 199, 89, 0.1)', color: '#34c759' },
                    'cancelled': { bg: 'rgba(255, 59, 48, 0.1)', color: '#ff3b30' }
                  };
                  const statusStyle = statusColors[appointment.status] || statusColors['scheduled'];

                  const paymentColors = {
                    'paid': { bg: 'rgba(52, 199, 89, 0.1)', color: '#34c759' },
                    'unpaid': { bg: 'rgba(255, 59, 48, 0.1)', color: '#ff3b30' },
                    'partial': { bg: 'rgba(255, 149, 0, 0.1)', color: '#ff9500' }
                  };
                  const paymentStyle = paymentColors[appointment.payment_state] || paymentColors['unpaid'];

                  const locationInfo = appointment.location
                    ? `${appointment.location.name} - ${appointment.location.city}`
                    : 'No location';

                  const bookingTypeBadge = appointment.booking_type
                    ? `<span style="background:rgba(0,0,0,0.06); padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; text-transform:uppercase;">${appointment.booking_type.replace('_', ' ')}</span>`
                    : '';

                  return `
                    <div class="project-card" style="background:rgba(255,255,255,0.9); border-radius:8px; padding:14px; margin-bottom:8px; border:1px solid rgba(0,0,0,0.08); cursor:pointer; transition:all 0.2s;" onclick="openAppointmentFromProfile('${appointment.id}')" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                        <div>
                          <span style="font-size:14px; font-weight:600; color:var(--macos-text-primary);">${new Date(appointment.start).toLocaleString('de-DE')}</span>
                          <div style="margin-top:4px;">${bookingTypeBadge}</div>
                        </div>
                        <div style="display:flex; gap:6px;">
                          <span style="background:${statusStyle.bg}; color:${statusStyle.color}; padding:3px 8px; border-radius:4px; font-size:10px; font-weight:600; text-transform:uppercase;">${appointment.status}</span>
                          <span style="background:${paymentStyle.bg}; color:${paymentStyle.color}; padding:3px 8px; border-radius:4px; font-size:10px; font-weight:600; text-transform:uppercase;">${appointment.payment_state || 'unpaid'}</span>
                        </div>
                      </div>
                      <div style="font-size:12px; color:var(--macos-text-primary); margin-bottom:6px;">
                        <strong>Location:</strong> ${locationInfo}
                      </div>
                      ${appointment.placement ? `<div style="font-size:12px; color:var(--macos-text-primary); margin-bottom:4px;"><strong>Placement:</strong> ${appointment.placement}</div>` : ''}
                      ${appointment.size || appointment.style ? `<div style="font-size:12px; color:var(--macos-text-primary); margin-bottom:4px;">${appointment.size ? `<strong>Size:</strong> ${appointment.size}` : ''} ${appointment.size && appointment.style ? '|' : ''} ${appointment.style ? `<strong>Style:</strong> ${appointment.style}` : ''}</div>` : ''}
                      ${appointment.description ? `<div style="font-size:12px; color:var(--macos-text-secondary); margin-top:6px; line-height:1.4;">${appointment.description.substring(0, 100)}${appointment.description.length > 100 ? '...' : ''}</div>` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
      }

      window.saveCustomerDetails = async function() {
        if (!currentCustomerProfileId) {
          alert('Error: No customer selected');
          return;
        }

        const firstName = document.getElementById('profileCustomerFirstName').value.trim();
        const lastName = document.getElementById('profileCustomerLastName').value.trim();
        const email = document.getElementById('profileCustomerEmail').value.trim();
        const phone = document.getElementById('profileCustomerPhone').value.trim();
        const instagram = document.getElementById('profileCustomerInstagram').value.trim();
        const rank = document.getElementById('profileCustomerRank').value;

        if (!firstName || !lastName || !email) {
          alert('First name, last name, and email are required');
          return;
        }

        try {
          console.log('ðŸ’¾ Saving customer details...');

          const updateData = {
            first_name: firstName,
            last_name: lastName,
            email,
            phone: phone || null,
            instagram: instagram || null,
            rank: rank || null
          };

          const { data, error } = await supabase
            .from('customers')
            .update(updateData)
            .eq('id', currentCustomerProfileId)
            .select();

          if (error) throw error;

          console.log('âœ… Customer updated successfully');

          // Clear cache and reload
          customersCache = [];
          await loadCustomers();

          // Re-fetch customer data to update the modal
          const { data: updatedCustomer } = await supabase
            .from('customers')
            .select('*')
            .eq('id', currentCustomerProfileId)
            .single();

          if (updatedCustomer) {
            // Update the display
            document.getElementById('customerProfileName').textContent =
              `${updatedCustomer.first_name || ''} ${updatedCustomer.last_name || ''}`.trim();

            // Rang direkt aus Datenbank (bereits korrekt gesetzt)
            const rank = updatedCustomer.rank || '';
            const rankNames = { 'Platinum': 'Platinum', 'platinum': 'Platinum', 'Gold': 'Gold', 'gold': 'Gold', 'Silver': 'Silver', 'silver': 'Silver', 'Silber': 'Silver', 'silber': 'Silver', 'Bronze': 'Bronze', 'bronze': 'Bronze', 'Neukunde': 'Neukunde', 'neukunde': 'Neukunde', 'new_customer': 'Neukunde', '': 'Neukunde' };
            const updatedRankDisplay = rankNames[rank] || 'Neukunde';
            const rankClass = rank?.toLowerCase() || 'neukunde';
            const rankBadge = `<span class="rank-badge rank-${rankClass}" style="display:inline-block; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:600; text-transform:uppercase;">${updatedRankDisplay}</span>`;
            document.getElementById('customerProfileRankBadge').innerHTML = rankBadge;
          }

          alert('âœ… Customer details saved successfully!');

        } catch (err) {
          console.error('âŒ Error saving customer details:', err);
          alert('Error saving customer details: ' + err.message);
        }
      };

      window.deleteCustomerFromProfile = async function() {
        if (!currentCustomerProfileId) {
          alert('Error: No customer selected');
          return;
        }

        try {
          const { data: customer } = await supabase
            .from('customers')
            .select('first_name, last_name')
            .eq('id', currentCustomerProfileId)
            .single();

          if (!customer) {
            alert('Customer not found');
            return;
          }

          if (!confirm(`âš ï¸ Are you sure you want to delete "${customer.first_name} ${customer.last_name}"?\n\nThis will also delete all their requests and appointments. This action cannot be undone.`)) {
            return;
          }

          if (!confirm(`ðŸš¨ FINAL WARNING: This will permanently delete the customer and all related data. Click OK to confirm.`)) {
            return;
          }

          console.log('ðŸ—‘ï¸ Deleting customer...');

          const { error } = await supabase
            .from('customers')
            .delete()
            .eq('id', currentCustomerProfileId);

          if (error) throw error;

          console.log('âœ… Customer deleted successfully');

          // Close modal
          closeCustomerProfile();

          // Clear cache and reload
          customersCache = [];
          await loadCustomers();

          alert('âœ… Customer deleted successfully!');

        } catch (err) {
          console.error('âŒ Error deleting customer:', err);
          alert('Error deleting customer: ' + err.message);
        }
      };

      window.closeCustomerProfile = function() {
        document.getElementById('customerProfileModal').classList.remove('active');
        currentCustomerProfileId = null;
      };

      // Toggle between Requests and Appointments view in Customer Profile
      window.toggleCustomerView = function(view) {
        const requestsBtn = document.getElementById('showRequestsBtn');
        const appointmentsBtn = document.getElementById('showAppointmentsBtn');
        const requestsView = document.getElementById('customerRequestsView');
        const appointmentsView = document.getElementById('customerAppointmentsView');

        if (view === 'requests') {
          // Show Requests
          requestsView.style.display = 'block';
          appointmentsView.style.display = 'none';

          // Update button styles
          requestsBtn.style.background = 'rgba(255,255,255,0.9)';
          requestsBtn.style.color = 'var(--macos-text-primary)';
          requestsBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
          appointmentsBtn.style.background = 'transparent';
          appointmentsBtn.style.color = 'var(--macos-text-secondary)';
          appointmentsBtn.style.boxShadow = 'none';
        } else if (view === 'appointments') {
          // Show Appointments
          requestsView.style.display = 'none';
          appointmentsView.style.display = 'block';

          // Update button styles
          appointmentsBtn.style.background = 'rgba(255,255,255,0.9)';
          appointmentsBtn.style.color = 'var(--macos-text-primary)';
          appointmentsBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
          requestsBtn.style.background = 'transparent';
          requestsBtn.style.color = 'var(--macos-text-secondary)';
          requestsBtn.style.boxShadow = 'none';
        }
      };

      // Close modals on backdrop click
      document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.addEventListener('click', (e) => {
          if (e.target === backdrop) {
            backdrop.classList.remove('active');
          }
        });
      });
      
      // Create Event Functions
      document.getElementById('createEventBtn')?.addEventListener('click', () => {
        // Set current date as default
        const dateInput = document.getElementById('createEventDate');
        if (dateInput) {
          dateInput.value = currentDate.toISOString().split('T')[0];
        }
        
        // Open modal
        document.getElementById('createEventModal').classList.add('active');
      });
      
      // "All Groups" checkbox handler
      document.getElementById('groupCheckboxAll')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const groupCheckboxes = document.querySelectorAll('.group-checkbox');
        groupCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });
      
      // Individual group checkbox handler - uncheck "All" if any individual is unchecked
      document.querySelectorAll('.group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const allCheckbox = document.getElementById('groupCheckboxAll');
          if (allCheckbox) {
            allCheckbox.checked = allChecked;
          }
        });
      });
      
      document.getElementById('cancelCreateEvent')?.addEventListener('click', () => {
        document.getElementById('createEventModal').classList.remove('active');
        document.getElementById('createEventForm').reset();
      });
      
      document.getElementById('createEventForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('createEventTitle').value.trim();
        const type = document.getElementById('createEventType').value.trim();
        const description = document.getElementById('createEventDescription').value.trim();
        const date = document.getElementById('createEventDate').value;
        const startHour = parseFloat(document.getElementById('createEventStartTime').value);
        const endHour = parseFloat(document.getElementById('createEventEndTime').value);
        const attendanceRequired = document.getElementById('createEventAttendanceRequired').checked;
        // Pinned Events werden automatisch aus events mit attendance_required=true geladen

        console.log('ðŸ“Œ Event creation - attendanceRequired:', attendanceRequired);

        // Collect selected groups
        const selectedGroups = [];
        const groupCheckboxes = document.querySelectorAll('.group-checkbox:checked');
        groupCheckboxes.forEach(checkbox => {
          selectedGroups.push(checkbox.value);
        });
        
        // Validation
        if (!title || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Events category is always 'events'
        const category = 'events';
        
        // Find available slot
        const slot = findAvailableSlot(date, category, startHour, endHour);
        
        if (slot === null) {
          return alert('All slots are occupied for this time range. Please choose a different time or date.');
        }
        
        try {
          // Create event in Supabase
          const { data, error } = await supabase.from('events').insert({
            title,
            type,
            description: description || null,
            visible_groups: selectedGroups.length > 0 ? selectedGroups : null,
            attendance_required: attendanceRequired,
            slot: slot,
            artist_id: null,
            location_id: selectedLocationId,
            start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
            end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
          });
          
          if (error) throw error;
          
          // Add to local events array
          events.push({
            id: data?.[0]?.id || Date.now(),
            title,
            type,
            description,
            visible_groups: selectedGroups,
            attendance_required: attendanceRequired,
            date,
            slot,
            startHour,
            endHour,
            category,
            artist_id: null
          });

          // Close modal and reset form
          document.getElementById('createEventModal').classList.remove('active');
          document.getElementById('createEventForm').reset();
          
          // Uncheck all group checkboxes
          groupCheckboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) checkbox.checked = false;
          });
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();

          // Refresh pinned events falls es ein Pflicht-Event ist
          if (attendanceRequired) {
            await loadPinnedEvents();
          }

          alert('Event created successfully!');
        } catch (err) {
          console.error('Error creating event:', err);
          alert('Error creating event: ' + err.message);
        }
      });
      
      // Create Booking Button - Opens Create Booking Modal
      document.getElementById('createBookingBtn')?.addEventListener('click', () => {
        // Set current date as default
        const dateInput = document.getElementById('createBookingDate');
        if (dateInput) {
          dateInput.value = currentDate.toISOString().split('T')[0];
        }
        
        // Reset artist search
        document.getElementById('createBookingArtistSearch').value = '';
        document.getElementById('createBookingArtistSearch').disabled = true;
        document.getElementById('createBookingArtistId').value = '';
        document.getElementById('artistSearchResults').style.display = 'none';
        
        // Open modal
        document.getElementById('createBookingModal').classList.add('active');
      });
      
      // Artist Type change handler
      document.getElementById('createBookingArtistType')?.addEventListener('change', (e) => {
        const artistType = e.target.value;
        const searchInput = document.getElementById('createBookingArtistSearch');
        
        if (artistType) {
          searchInput.disabled = false;
          searchInput.value = '';
          document.getElementById('createBookingArtistId').value = '';
          document.getElementById('artistSearchResults').style.display = 'none';
        } else {
          searchInput.disabled = true;
          searchInput.value = '';
          document.getElementById('createBookingArtistId').value = '';
          document.getElementById('artistSearchResults').style.display = 'none';
        }
      });
      
      // Artist search functionality
      document.getElementById('createBookingArtistSearch')?.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        const artistType = document.getElementById('createBookingArtistType').value;
        const resultsDiv = document.getElementById('artistSearchResults');
        
        if (!searchTerm || !artistType) {
          resultsDiv.style.display = 'none';
          return;
        }
        
        // Filter artists by type and search term
        const isGuest = artistType === 'guest';
        const filteredArtists = allArtists.filter(artist => 
          artist.is_guest === isGuest && 
          artist.active &&
          artist.name.toLowerCase().includes(searchTerm)
        );
        
        if (filteredArtists.length === 0) {
          resultsDiv.innerHTML = '<div style="padding:12px; color:var(--muted); font-size:13px;">No artists found</div>';
          resultsDiv.style.display = 'block';
          return;
        }
        
        resultsDiv.innerHTML = filteredArtists.map(artist => `
          <div class="artist-search-result" data-id="${artist.id}" data-name="${artist.name}" style="padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.06); font-size:14px; transition:background 0.15s;">
            ${artist.name}${artist.instagram ? ` <span style="color:var(--muted); font-size:12px;">@${artist.instagram}</span>` : ''}
          </div>
        `).join('');
        
        resultsDiv.style.display = 'block';
        
        // Add click handlers
        document.querySelectorAll('.artist-search-result').forEach(item => {
          item.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(0,113,227,0.06)';
          });
          item.addEventListener('mouseleave', function() {
            this.style.background = '';
          });
          item.addEventListener('click', function() {
            const artistId = this.dataset.id;
            const artistName = this.dataset.name;
            document.getElementById('createBookingArtistSearch').value = artistName;
            document.getElementById('createBookingArtistId').value = artistId;
            resultsDiv.style.display = 'none';
          });
        });
      });
      
      
      // Create Booking Modal Handlers
      document.getElementById('cancelCreateBooking')?.addEventListener('click', () => {
        document.getElementById('createBookingModal').classList.remove('active');
        document.getElementById('createBookingForm').reset();
      });
      
      document.getElementById('createBookingForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const customerName = document.getElementById('createBookingCustomer').value.trim();
        const type = document.getElementById('createBookingType').value;
        const artistId = document.getElementById('createBookingArtistId').value;
        const date = document.getElementById('createBookingDate').value;
        const startHour = parseFloat(document.getElementById('createBookingStartTime').value);
        const endHour = parseFloat(document.getElementById('createBookingEndTime').value);
        
        // Validation
        if (!customerName || !type || !artistId || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Determine category based on artist
        const artist = allArtists.find(a => a.id === artistId);
        const category = artist?.is_guest ? 'guest' : 'resident';
        
        // Find available slot
        const slot = findAvailableSlot(date, category, startHour, endHour);
        
        if (slot === null) {
          return alert('All slots are occupied for this time range. Please choose a different time or date.');
        }
        
        try {
          // 1. Find or create customer
          let customerId = null;
          const nameParts = customerName.split(' ');
          const firstName = nameParts[0] || customerName;
          const lastName = nameParts.slice(1).join(' ') || '';

          // Check if customer exists
          const { data: existingCustomers } = await supabase
            .from('customers')
            .select('id')
            .ilike('first_name', firstName)
            .ilike('last_name', lastName || '%')
            .limit(1);

          if (existingCustomers && existingCustomers.length > 0) {
            customerId = existingCustomers[0].id;
          } else {
            // Create new customer
            const { data: newCustomer, error: customerError } = await supabase
              .from('customers')
              .insert({
                first_name: firstName,
                last_name: lastName,
                source: 'quick_booking'
              })
              .select('id')
              .single();

            if (customerError) {
              console.warn('Could not create customer:', customerError);
            } else {
              customerId = newCustomer?.id;
            }
          }

          // 2. Format timestamps
          const startMin = Math.round((startHour % 1) * 60);
          const endMin = Math.round((endHour % 1) * 60);
          const startTime = `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String(startMin).padStart(2, '0')}:00`;
          const endTime = `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String(endMin).padStart(2, '0')}:00`;

          // 3. Calculate duration in minutes
          const durationMinutes = Math.round((endHour - startHour) * 60);

          // 4. Create appointment in appointments table (NOT events!)
          const { data, error } = await supabase.from('appointments').insert({
            customer_id: customerId,
            artist_id: artistId,
            location_id: selectedLocationId,
            start: startTime,
            end: endTime,
            slot: slot,
            booking_type: type,
            work_process: type,
            status: 'scheduled',
            payment_status: 'unpaid',
            duration_minutes: durationMinutes,
            created_at: new Date().toISOString()
          }).select();

          if (error) throw error;

          // Close modal and reset form
          document.getElementById('createBookingModal').classList.remove('active');
          document.getElementById('createBookingForm').reset();
          document.getElementById('createBookingArtistSearch').disabled = true;
          document.getElementById('createBookingArtistId').value = '';
          document.getElementById('artistSearchResults').style.display = 'none';
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Booking created successfully!');
        } catch (err) {
          console.error('Error creating booking:', err);
          alert('Error creating booking: ' + err.message);
        }
      });


      // Edit Event Modal Functions
      window.openEditEventModal = async function(eventId) {
        const event = events.find(e => e.id === eventId);
        if (!event) return;
        
        currentEditingEvent = event;
        
        // Load full event data from Supabase
        const { data, error } = await supabase
          .from('events')
          .select('*')
          .eq('id', eventId)
          .single();
        
        if (error) {
          console.error('Error loading event:', error);
          alert('Error loading event details');
          return;
        }
        
        // Fill form with event data
        document.getElementById('editEventTitle').value = data.title || '';
        document.getElementById('editEventType').value = data.type || '';
        document.getElementById('editEventDescription').value = data.description || '';
        document.getElementById('editEventDate').value = event.date;
        
        // Set time dropdowns with formatted values
        const startTimeValue = event.startHour.toString();
        const endTimeValue = event.endHour.toString();
        
        console.log('Setting start time to:', startTimeValue, 'Available options:', 
          Array.from(document.getElementById('editEventStartTime').options).map(o => o.value));
        console.log('Setting end time to:', endTimeValue, 'Available options:', 
          Array.from(document.getElementById('editEventEndTime').options).map(o => o.value));
        
        document.getElementById('editEventStartTime').value = startTimeValue;
        document.getElementById('editEventEndTime').value = endTimeValue;
        
        // Fallback: if value not set, try to find closest match
        if (!document.getElementById('editEventStartTime').value) {
          console.warn('Start time not set, trying fallback');
          const startSelect = document.getElementById('editEventStartTime');
          for (let option of startSelect.options) {
            if (parseFloat(option.value) === event.startHour) {
              startSelect.value = option.value;
              break;
            }
          }
        }
        
        if (!document.getElementById('editEventEndTime').value) {
          console.warn('End time not set, trying fallback');
          const endSelect = document.getElementById('editEventEndTime');
          for (let option of endSelect.options) {
            if (parseFloat(option.value) === event.endHour) {
              endSelect.value = option.value;
              break;
            }
          }
        }
        
        // Handle artist display (for bookings)
        if (data.artist_id) {
          const artist = allArtists.find(a => a.id === data.artist_id);
          document.getElementById('editEventArtistName').value = artist?.name || 'Unknown Artist';
          document.getElementById('editEventArtistGroup').style.display = 'block';
          document.getElementById('editEventGroupsContainer').style.display = 'none';
          document.getElementById('editEventAttendanceGroup').style.display = 'none';
          document.getElementById('editEventModalTitle').textContent = 'Booking Details';
        } else {
          document.getElementById('editEventArtistGroup').style.display = 'none';
          document.getElementById('editEventGroupsContainer').style.display = 'block';
          document.getElementById('editEventAttendanceGroup').style.display = 'block';
          document.getElementById('editEventModalTitle').textContent = 'Event Details';
          
          // Set visible groups checkboxes
          const visibleGroups = data.visible_groups || [];
          document.querySelectorAll('.edit-group-checkbox').forEach(checkbox => {
            checkbox.checked = visibleGroups.includes(checkbox.value);
          });
          
          // Set "All Groups" checkbox
          const allChecked = document.querySelectorAll('.edit-group-checkbox').length === visibleGroups.length;
          document.getElementById('editGroupCheckboxAll').checked = allChecked;
          
          // Set attendance required
          document.getElementById('editEventAttendanceRequired').checked = data.attendance_required || false;
        }
        
        // Open modal
        document.getElementById('editEventModal').classList.add('active');
      };
      
      // "All Groups" checkbox handler for edit modal
      document.getElementById('editGroupCheckboxAll')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox');
        groupCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });
      
      // Individual group checkbox handler for edit modal
      document.querySelectorAll('.edit-group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.edit-group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const allCheckbox = document.getElementById('editGroupCheckboxAll');
          if (allCheckbox) {
            allCheckbox.checked = allChecked;
          }
        });
      });
      
      // Cancel edit event
      document.getElementById('cancelEditEvent')?.addEventListener('click', () => {
        document.getElementById('editEventModal').classList.remove('active');
        currentEditingEvent = null;
      });
      
      // Delete event
      document.getElementById('deleteEventBtn')?.addEventListener('click', async () => {
        if (!currentEditingEvent) return;
        
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .delete()
            .eq('id', currentEditingEvent.id);
          
          if (error) throw error;
          
          // Remove from local array
          events = events.filter(e => e.id !== currentEditingEvent.id);
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          currentEditingEvent = null;
          
          // Refresh calendar
          renderCalendar();
          
          alert('Event deleted successfully!');
        } catch (err) {
          console.error('Error deleting event:', err);
          alert('Error deleting event: ' + err.message);
        }
      });
      
      // Save edited event
      document.getElementById('editEventForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentEditingEvent) return;
        
        const title = document.getElementById('editEventTitle').value.trim();
        const type = document.getElementById('editEventType').value.trim();
        const description = document.getElementById('editEventDescription').value.trim();
        const date = document.getElementById('editEventDate').value;
        const startHour = parseFloat(document.getElementById('editEventStartTime').value);
        const endHour = parseFloat(document.getElementById('editEventEndTime').value);
        
        // Validation
        if (!title || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Prepare update data
        const updateData = {
          title,
          type,
          description: description || null,
          start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
          end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
        };
        
        // Add event-specific fields (not for bookings)
        if (currentEditingEvent.category === 'events') {
          const selectedGroups = [];
          const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox:checked');
          groupCheckboxes.forEach(checkbox => {
            selectedGroups.push(checkbox.value);
          });
          
          updateData.visible_groups = selectedGroups.length > 0 ? selectedGroups : null;
          updateData.attendance_required = document.getElementById('editEventAttendanceRequired').checked;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .update(updateData)
            .eq('id', currentEditingEvent.id);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          currentEditingEvent = null;
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event updated successfully!');
        } catch (err) {
          console.error('Error updating event:', err);
          alert('Error updating event: ' + err.message);
        }
      });
      
      // Show Appointment Details Modal
      // ============================================
      // HELPER: State Badge (DEUTSCH)
      // ============================================
      window.getStateBadge = function(state) {
        const badges = {
          'Zugesagt': '<span class="state-badge confirmed">âœ… Zugesagt</span>',
          'Unbekannt': '<span class="state-badge unknown">â“ Unbekannt</span>',
          'Ill/No Show': '<span class="state-badge no-show">ðŸ‘» Ill/No Show</span>',
          'Verschoben': '<span class="state-badge rescheduled">ðŸ”„ Verschoben</span>',
          'Reserviert': '<span class="state-badge reserved">ðŸ“Œ Reserviert</span>'
        };
        return badges[state] || '<span class="state-badge unknown">â“ Unbekannt</span>';
      };

      // ============================================
      // HELPER: Status Badge (ENGLISH)
      // ============================================
      window.getStatusBadge = function(status) {
        const badges = {
          'scheduled': '<span class="status-badge scheduled">ðŸ“… Scheduled</span>',
          'finished': '<span class="status-badge finished">âœ… Finished</span>',
          'canceled': '<span class="status-badge canceled">âŒ Canceled</span>',
          'no_show': '<span class="status-badge no-show">ðŸ‘» No Show</span>',
          'reserved': '<span class="status-badge reserved">ðŸ“Œ Reserved</span>',
          'unknown': '<span class="status-badge unknown">â“ Unknown</span>',
          'rescheduled': '<span class="status-badge rescheduled">ðŸ”„ Rescheduled</span>'
        };
        return badges[status] || badges['unknown'];
      };

      // ============================================
      // HELPER: Payment Badge
      // ============================================
      window.getPaymentStatusBadge = function(paymentStatus) {
        const badges = {
          'paid': '<span class="payment-badge paid">âœ… Bezahlt</span>',
          'fully_paid': '<span class="payment-badge paid">âœ… Bezahlt</span>',
          'deposit_paid': '<span class="payment-badge deposit">ðŸ’° Anzahlung</span>',
          'pending': '<span class="payment-badge pending" style="background:#fff3e0;color:#e65100">â³ Offen</span>',
          'failed': '<span class="payment-badge failed" style="background:#ffebee;color:#c62828">âŒ Fehlgeschlagen</span>',
          'refunded': '<span class="payment-badge refunded">â†©ï¸ RÃ¼ckerstattet</span>',
          'unpaid': '<span class="payment-badge unpaid">ðŸ’³ Unbezahlt</span>'
        };
        return badges[paymentStatus] || badges['unpaid'];
      };

      // ============================================
      // COMPLETE APPOINTMENT DETAILS POPUP
      // ============================================
      window.showAppointmentDetails = async function(appointmentId) {
        console.log('ðŸ“‹ Loading complete appointment details:', appointmentId);

        // Fetch complete appointment data WITH linked request
        const { data: appointment, error } = await supabase
          .from('appointments')
          .select(`
            *,
            customer:customers(id, first_name, last_name, email, phone, instagram),
            artist:artists(id, name, email, instagram, phone),
            location:locations!appointments_location_id_fkey(id, name, city),
            request:requests!fk_appointments_request_id(
              id,
              request_number,
              placement,
              size,
              style,
              colorway,
              description,
              booking_type,
              work_process,
              preferred_artist,
              image_url,
              reference_images,
              customer_notes,
              internal_notes,
              priority
            )
          `)
          .eq('id', appointmentId)
          .single();

        if (error || !appointment) {
          console.error('Error loading appointment:', error);
          alert('Failed to load appointment details');
          return;
        }

        console.log('âœ… Loaded appointment:', appointment);

        // Render complete details
        const content = document.getElementById('appointmentDetailsContent');
        const modal = document.getElementById('appointmentDetailsModal');

        if (!content || !modal) return;

        const customerName = `${appointment.first_name || ''} ${appointment.last_name || ''}`.trim() ||
                             `${appointment.customer?.first_name || ''} ${appointment.customer?.last_name || ''}`.trim() ||
                             'Unknown Customer';

        const artistName = appointment.artist?.name || 'Unknown Artist';

        // Format dates
        const startDateTime = appointment.start ? new Date(appointment.start).toLocaleString('de-DE', {
          weekday: 'short',
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : '-';

        const endTime = appointment.end ? new Date(appointment.end).toLocaleTimeString('de-DE', {
          hour: '2-digit',
          minute: '2-digit'
        }) : '-';

        // Get badges
        const stateBadge = getStateBadge(appointment.state);
        const statusBadge = getStatusBadge(appointment.status);
        const paymentBadge = getPaymentStatusBadge(appointment.payment_status);

        content.innerHTML = `
          <!-- Header Row -->
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:16px; border-bottom:2px solid rgba(0,0,0,0.1);">
            <div>
              <h3 style="margin:0 0 8px 0; font-size:20px; font-weight:700; color:#1d1d1f;">${appointment.project_number || 'Kein Projekt'}</h3>
              <span style="font-size:13px; color:#86868b;">${appointment.location?.name || 'Unknown Location'} ${appointment.location?.city ? '- ' + appointment.location.city : ''}</span>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              ${stateBadge}
              ${statusBadge}
            </div>
          </div>

          <!-- Two Column Layout -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">

            <!-- LEFT COLUMN -->
            <div style="display:flex; flex-direction:column; gap:20px;">

              <!-- Customer Information -->
              <div style="background:#fafafa; padding:16px; border-radius:8px;">
                <h4 style="margin:0 0 12px 0; font-size:15px; font-weight:600; color:#1d1d1f;">Customer Information</h4>
                <div style="display:flex; flex-direction:column; gap:10px;">
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">VORNAME</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.first_name || appointment.customer?.first_name || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">NACHNAME</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.last_name || appointment.customer?.last_name || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">EMAIL</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.customer_email || appointment.customer?.email || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">PHONE</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.customer_phone || appointment.customer?.phone || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0;">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">INSTAGRAM</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.instagram || appointment.customer?.instagram || 'No entry data'}</span>
                  </div>
                </div>
                <!-- View Profile Buttons -->
                <div style="display:flex; gap:8px; margin-top:12px;">
                  ${appointment.customer?.id || appointment.customer_id ? `
                  <button onclick="openCustomerSidePanel('${appointment.customer?.id || appointment.customer_id}')"
                    style="flex:1; padding:8px 12px; background:#1d1d1f; color:white; border:none; border-radius:6px; font-size:12px; font-weight:500; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    View Customer
                  </button>
                  ` : ''}
                  ${appointment.artist?.id || appointment.artist_id ? `
                  <button onclick="openArtistSidePanel('${appointment.artist?.id || appointment.artist_id}')"
                    style="flex:1; padding:8px 12px; background:#1d1d1f; color:white; border:none; border-radius:6px; font-size:12px; font-weight:500; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>
                    View Artist
                  </button>
                  ` : ''}
                </div>
              </div>

              <!-- Request Details -->
              <div style="background:#fafafa; padding:16px; border-radius:8px;">
                <h4 style="margin:0 0 12px 0; font-size:15px; font-weight:600; color:#1d1d1f;">Request Details</h4>
                <div style="display:flex; flex-direction:column; gap:10px;">
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">PLACEMENT</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.placement || appointment.request?.placement || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">SIZE</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.size || appointment.request?.size || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">STYLE</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.style || appointment.request?.style || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">COLORWAY</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.colorway || appointment.request?.colorway || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">BOOKING TYPE</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.booking_type || appointment.request?.booking_type || 'No entry data'}</span>
                  </div>
                  ${(appointment.description || appointment.request?.description) ? `
                  <div style="padding:10px 0 0 0;">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase; display:block; margin-bottom:8px;">DESCRIPTION</span>
                    <div style="background:white; padding:10px; border-radius:6px; font-size:13px; color:#1d1d1f; line-height:1.5; max-height:120px; overflow-y:auto;">
                      ${appointment.description || appointment.request?.description}
                    </div>
                  </div>
                  ` : ''}
                </div>
              </div>

            </div>

            <!-- RIGHT COLUMN -->
            <div style="display:flex; flex-direction:column; gap:20px;">

              <!-- Appointment Details -->
              <div style="background:#fafafa; padding:16px; border-radius:8px;">
                <h4 style="margin:0 0 12px 0; font-size:15px; font-weight:600; color:#1d1d1f;">Appointment Details</h4>
                <div style="display:flex; flex-direction:column; gap:10px;">
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">ARTIST</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${artistName}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">START</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${startDateTime}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">END</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${endTime}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">CREATOR</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.creator_email || 'No entry data'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; padding:6px 0;">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">WORK PROCESS</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">${appointment.work_process || 'No entry data'}</span>
                  </div>
                </div>
              </div>

              <!-- Payment Information -->
              <div style="background:#fafafa; padding:16px; border-radius:8px;">
                <h4 style="margin:0 0 12px 0; font-size:15px; font-weight:600; color:#1d1d1f;">Payment Information</h4>
                <div style="display:flex; flex-direction:column; gap:10px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">PAYMENT STATUS</span>
                    ${paymentBadge}
                  </div>
                  ${appointment.price ? `
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">PRICE</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:600;">â‚¬${parseFloat(appointment.price).toFixed(2)}</span>
                  </div>
                  ` : ''}
                  ${appointment.price_estimate ? `
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">PRICE ESTIMATE</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">â‚¬${parseFloat(appointment.price_estimate).toFixed(2)}</span>
                  </div>
                  ` : ''}
                  ${appointment.deposit_amount ? `
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">DEPOSIT</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">â‚¬${parseFloat(appointment.deposit_amount).toFixed(2)}</span>
                  </div>
                  ` : ''}
                  ${appointment.payment_amount ? `
                  <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">PAID</span>
                    <span style="font-size:14px; color:#34c759; font-weight:600;">â‚¬${parseFloat(appointment.payment_amount).toFixed(2)}</span>
                  </div>
                  ` : ''}
                  ${appointment.total_amount ? `
                  <div style="display:flex; justify-content:space-between; padding:6px 0;">
                    <span style="font-size:11px; font-weight:600; color:#86868b; text-transform:uppercase;">TOTAL</span>
                    <span style="font-size:14px; color:#1d1d1f; font-weight:500;">â‚¬${parseFloat(appointment.total_amount).toFixed(2)}</span>
                  </div>
                  ` : ''}
                </div>
              </div>

              ${appointment.customer_notes || appointment.internal_notes || appointment.description || appointment.notice ? `
              <!-- Notes & Description -->
              <div style="background:#fafafa; padding:16px; border-radius:8px;">
                <h4 style="margin:0 0 12px 0; font-size:15px; font-weight:600; color:#1d1d1f;">Notes & Description</h4>
                ${appointment.description ? `
                <div style="background:white; padding:10px; border-radius:6px; margin-bottom:8px;">
                  <strong style="display:block; font-size:11px; color:#86868b; margin-bottom:6px;">DESCRIPTION</strong>
                  <p style="font-size:13px; color:#1d1d1f; margin:0; line-height:1.5;">${appointment.description}</p>
                </div>
                ` : ''}
                ${appointment.notice ? `
                <div style="background:white; padding:10px; border-radius:6px; margin-bottom:8px;">
                  <strong style="display:block; font-size:11px; color:#86868b; margin-bottom:6px;">NOTICE</strong>
                  <p style="font-size:13px; color:#1d1d1f; margin:0; line-height:1.5;">${appointment.notice}</p>
                </div>
                ` : ''}
                ${appointment.customer_notes ? `
                <div style="background:white; padding:10px; border-radius:6px; margin-bottom:8px;">
                  <strong style="display:block; font-size:11px; color:#86868b; margin-bottom:6px;">CUSTOMER NOTES</strong>
                  <p style="font-size:13px; color:#1d1d1f; margin:0; line-height:1.5;">${appointment.customer_notes}</p>
                </div>
                ` : ''}
                ${appointment.internal_notes ? `
                <div style="background:white; padding:10px; border-radius:6px;">
                  <strong style="display:block; font-size:11px; color:#86868b; margin-bottom:6px;">INTERNAL NOTES</strong>
                  <p style="font-size:13px; color:#1d1d1f; margin:0; line-height:1.5;">${appointment.internal_notes}</p>
                </div>
                ` : ''}
              </div>
              ` : ''}

            </div>

          </div>
        `;

        // Set up buttons
        document.getElementById('appointmentDetailsEditBtn').onclick = () => {
          closeAppointmentDetailsModal();
          openAppointmentEditPopup(appointmentId);
        };

        document.getElementById('appointmentDetailsCancelBtn').onclick = async () => {
          if (!confirm('MÃ¶chtest du diesen Termin wirklich stornieren?')) return;

          try {
            // Update appointment state to Cancelled
            const { error: appointmentError } = await supabase
              .from('appointments')
              .update({ state: 'Cancelled' })
              .eq('id', appointmentId);

            if (appointmentError) throw appointmentError;

            // If linked to a request, update request status too
            if (appointment.request_id) {
              const { error: requestError } = await supabase
                .from('requests')
                .update({ status: 'canceled' })
                .eq('id', appointment.request_id);

              if (requestError) console.error('Error updating request:', requestError);
            }

            showToast('Termin wurde storniert', 'success');
            closeAppointmentDetailsModal();
            loadCalendarData();
            loadAllRequests();
          } catch (error) {
            console.error('Error cancelling appointment:', error);
            showToast('Fehler beim Stornieren', 'error');
          }
        };

        document.getElementById('appointmentDetailsDeleteBtn').onclick = async () => {
          if (!confirm('MÃ¶chtest du diesen Termin wirklich PERMANENT lÃ¶schen?')) return;
          if (!confirm('ACHTUNG: Diese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden! Wirklich lÃ¶schen?')) return;

          try {
            const { error } = await supabase
              .from('appointments')
              .delete()
              .eq('id', appointmentId);

            if (error) throw error;

            showToast('Termin wurde gelÃ¶scht', 'success');
            closeAppointmentDetailsModal();
            loadCalendarData();
          } catch (error) {
            console.error('Error deleting appointment:', error);
            showToast('Fehler beim LÃ¶schen', 'error');
          }
        };

        modal.classList.add('active');
      };

      // ============================================
      // SIDE PANEL FUNCTIONS FOR CUSTOMER/ARTIST
      // ============================================

      window.openCustomerSidePanel = async function(customerId) {
        if (!customerId) return;

        const panel = document.getElementById('profileSidePanel');
        const content = document.getElementById('profileSidePanelContent');

        // Load customer data
        const { data: customer, error } = await supabase
          .from('customers')
          .select('*')
          .eq('id', customerId)
          .single();

        if (error || !customer) {
          console.error('Error loading customer:', error);
          return;
        }

        // Load customer requests
        const { data: requests } = await supabase
          .from('requests')
          .select('id, request_number, status, created_at, placement, artist_name, preferred_artist')
          .eq('customer_id', customerId)
          .order('created_at', { ascending: false })
          .limit(10);

        // Load customer appointments
        const { data: appointments } = await supabase
          .from('appointments')
          .select('id, project_number, status, state, start, artist_id, artists(name)')
          .eq('customer_id', customerId)
          .order('start', { ascending: false })
          .limit(10);

        // Render customer profile with tabs
        content.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid rgba(0,0,0,0.1);">
            <h3 style="margin:0; font-size:18px; font-weight:600; color:#1d1d1f;">Customer Profile</h3>
            <button onclick="closeProfileSidePanel()" style="background:none; border:none; cursor:pointer; padding:8px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
          </div>

          <!-- Customer Avatar/Name -->
          <div style="text-align:center; margin-bottom:20px;">
            <div style="width:80px; height:80px; border-radius:50%; background:linear-gradient(135deg, #007aff, #5856d6); margin:0 auto 12px; display:flex; align-items:center; justify-content:center;">
              <span style="color:white; font-size:28px; font-weight:600;">${(customer.first_name?.[0] || '?').toUpperCase()}${(customer.last_name?.[0] || '').toUpperCase()}</span>
            </div>
            <h4 style="margin:0 0 4px 0; font-size:18px; font-weight:600; color:#1d1d1f;">${customer.first_name || ''} ${customer.last_name || ''}</h4>
            <span style="display:inline-block; padding:4px 10px; background:${customer.rank === 'Gold' ? '#ffd60a' : customer.rank === 'Platinum' ? '#e5e5ea' : customer.rank === 'Silver' ? '#c0c0c0' : '#cd7f32'}; color:${customer.rank === 'Gold' || customer.rank === 'Silver' ? '#1d1d1f' : '#fff'}; border-radius:12px; font-size:11px; font-weight:600;">${customer.rank || 'Neukunde'}</span>
          </div>

          <!-- Contact Info -->
          <div style="background:#fafafa; padding:16px; border-radius:8px; margin-bottom:16px;">
            <h5 style="margin:0 0 12px 0; font-size:13px; font-weight:600; color:#86868b; text-transform:uppercase;">Contact</h5>
            <div style="display:flex; flex-direction:column; gap:8px;">
              <div style="display:flex; justify-content:space-between;">
                <span style="font-size:12px; color:#86868b;">Email</span>
                <span style="font-size:13px; color:#1d1d1f; font-weight:500;">${customer.email || '-'}</span>
              </div>
              <div style="display:flex; justify-content:space-between;">
                <span style="font-size:12px; color:#86868b;">Phone</span>
                <span style="font-size:13px; color:#1d1d1f; font-weight:500;">${customer.phone || '-'}</span>
              </div>
              <div style="display:flex; justify-content:space-between;">
                <span style="font-size:12px; color:#86868b;">Instagram</span>
                <span style="font-size:13px; color:#1d1d1f; font-weight:500;">${customer.instagram || '-'}</span>
              </div>
            </div>
          </div>

          <!-- Tab Switcher -->
          <div style="display:flex; gap:8px; margin-bottom:16px;">
            <button id="customerRequestsTab" onclick="switchCustomerTab('requests')"
              style="flex:1; padding:10px; background:#1d1d1f; color:white; border:none; border-radius:8px; font-size:13px; font-weight:500; cursor:pointer;">
              Requests (${requests?.length || 0})
            </button>
            <button id="customerAppointmentsTab" onclick="switchCustomerTab('appointments')"
              style="flex:1; padding:10px; background:#f5f5f7; color:#1d1d1f; border:none; border-radius:8px; font-size:13px; font-weight:500; cursor:pointer;">
              Appointments (${appointments?.length || 0})
            </button>
          </div>

          <!-- Requests Tab Content -->
          <div id="customerRequestsContent" style="display:block;">
            ${requests && requests.length > 0 ? requests.map(req => `
              <div style="background:#fafafa; padding:12px; border-radius:8px; margin-bottom:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                  <span style="font-size:13px; font-weight:600; color:#1d1d1f;">${req.request_number || 'No Number'}</span>
                  <span style="padding:3px 8px; background:${req.status === 'finished' ? '#34c759' : req.status === 'scheduled' ? '#007aff' : req.status === 'canceled' ? '#ff3b30' : '#ff9500'}; color:white; border-radius:10px; font-size:10px; font-weight:600;">${req.status || 'unknown'}</span>
                </div>
                <div style="font-size:12px; color:#86868b;">
                  ${req.placement || 'No placement'} â€¢ ${req.artist_name || req.preferred_artist || 'No artist'}
                </div>
                <div style="font-size:11px; color:#aeaeb2; margin-top:4px;">
                  ${req.created_at ? new Date(req.created_at).toLocaleDateString('de-DE') : '-'}
                </div>
              </div>
            `).join('') : '<p style="text-align:center; color:#86868b; font-size:13px;">No requests found</p>'}
          </div>

          <!-- Appointments Tab Content -->
          <div id="customerAppointmentsContent" style="display:none;">
            ${appointments && appointments.length > 0 ? appointments.map(apt => `
              <div style="background:#fafafa; padding:12px; border-radius:8px; margin-bottom:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                  <span style="font-size:13px; font-weight:600; color:#1d1d1f;">${apt.project_number || 'No Project'}</span>
                  <span style="padding:3px 8px; background:${apt.state === 'Finished' ? '#34c759' : apt.state === 'Scheduled' ? '#007aff' : apt.state === 'Cancelled' ? '#ff3b30' : '#ff9500'}; color:white; border-radius:10px; font-size:10px; font-weight:600;">${apt.state || apt.status || 'unknown'}</span>
                </div>
                <div style="font-size:12px; color:#86868b;">
                  ${apt.artists?.name || 'No artist'}
                </div>
                <div style="font-size:11px; color:#aeaeb2; margin-top:4px;">
                  ${apt.start ? new Date(apt.start).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' }) : '-'}
                </div>
              </div>
            `).join('') : '<p style="text-align:center; color:#86868b; font-size:13px;">No appointments found</p>'}
          </div>
        `;

        // Show panel
        panel.style.display = 'block';
        setTimeout(() => panel.style.transform = 'translateX(0)', 10);
      };

      window.switchCustomerTab = function(tab) {
        const requestsTab = document.getElementById('customerRequestsTab');
        const appointmentsTab = document.getElementById('customerAppointmentsTab');
        const requestsContent = document.getElementById('customerRequestsContent');
        const appointmentsContent = document.getElementById('customerAppointmentsContent');

        if (tab === 'requests') {
          requestsTab.style.background = '#1d1d1f';
          requestsTab.style.color = 'white';
          appointmentsTab.style.background = '#f5f5f7';
          appointmentsTab.style.color = '#1d1d1f';
          requestsContent.style.display = 'block';
          appointmentsContent.style.display = 'none';
        } else {
          appointmentsTab.style.background = '#1d1d1f';
          appointmentsTab.style.color = 'white';
          requestsTab.style.background = '#f5f5f7';
          requestsTab.style.color = '#1d1d1f';
          requestsContent.style.display = 'none';
          appointmentsContent.style.display = 'block';
        }
      };

      window.openArtistSidePanel = async function(artistId) {
        if (!artistId) return;

        const panel = document.getElementById('profileSidePanel');
        const content = document.getElementById('profileSidePanelContent');

        // Load artist data
        const { data: artist, error } = await supabase
          .from('artists')
          .select('*')
          .eq('id', artistId)
          .single();

        if (error || !artist) {
          console.error('Error loading artist:', error);
          return;
        }

        // Load completed projects (finished appointments) - check both state and status fields
        const { data: completedProjects } = await supabase
          .from('appointments')
          .select('id, project_number, state, status, start, customer_id, first_name, last_name, placement')
          .eq('artist_id', artistId)
          .or('state.eq.Finished,state.eq.finished,status.eq.finished')
          .order('start', { ascending: false })
          .limit(10);

        // Load upcoming shifts from dienstplan (no shift_type filter - column doesn't exist)
        const { data: guestSpots } = await supabase
          .from('dienstplan')
          .select('id, date, start_time, end_time, location_id, note')
          .eq('artist_id', artistId)
          .gte('date', new Date().toISOString().split('T')[0])
          .order('date', { ascending: true })
          .limit(10);

        // Render artist profile with tabs
        content.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid rgba(0,0,0,0.1);">
            <h3 style="margin:0; font-size:18px; font-weight:600; color:#1d1d1f;">Artist Profile</h3>
            <button onclick="closeProfileSidePanel()" style="background:none; border:none; cursor:pointer; padding:8px;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
          </div>

          <!-- Artist Avatar/Name -->
          <div style="text-align:center; margin-bottom:20px;">
            ${artist.profile_picture_url ? `
              <img src="${artist.profile_picture_url}" style="width:80px; height:80px; border-radius:50%; object-fit:cover; margin:0 auto 12px; display:block; border:3px solid #e5e5ea;">
            ` : `
              <div style="width:80px; height:80px; border-radius:50%; background:linear-gradient(135deg, #1d1d1f, #48484a); margin:0 auto 12px; display:flex; align-items:center; justify-content:center;">
                <span style="color:white; font-size:28px; font-weight:600;">${(artist.name?.[0] || '?').toUpperCase()}</span>
              </div>
            `}
            <h4 style="margin:0 0 4px 0; font-size:18px; font-weight:600; color:#1d1d1f;">${artist.name || 'Unknown Artist'}</h4>
            <span style="display:inline-block; padding:4px 10px; background:${artist.status === 'active' ? '#34c759' : '#ff9500'}; color:white; border-radius:12px; font-size:11px; font-weight:600;">${artist.status || 'Unknown'}</span>
            ${artist.artist_type ? `<span style="display:inline-block; margin-left:6px; padding:4px 10px; background:#007aff; color:white; border-radius:12px; font-size:11px; font-weight:600;">${artist.artist_type}</span>` : ''}
          </div>

          <!-- Contact Info -->
          <div style="background:#fafafa; padding:16px; border-radius:8px; margin-bottom:16px;">
            <h5 style="margin:0 0 12px 0; font-size:13px; font-weight:600; color:#86868b; text-transform:uppercase;">Contact</h5>
            <div style="display:flex; flex-direction:column; gap:8px;">
              <div style="display:flex; justify-content:space-between;">
                <span style="font-size:12px; color:#86868b;">Email</span>
                <span style="font-size:13px; color:#1d1d1f; font-weight:500;">${artist.email || '-'}</span>
              </div>
              <div style="display:flex; justify-content:space-between;">
                <span style="font-size:12px; color:#86868b;">Phone</span>
                <span style="font-size:13px; color:#1d1d1f; font-weight:500;">${artist.phone || '-'}</span>
              </div>
              <div style="display:flex; justify-content:space-between;">
                <span style="font-size:12px; color:#86868b;">Instagram</span>
                <span style="font-size:13px; color:#1d1d1f; font-weight:500;">${artist.instagram || '-'}</span>
              </div>
            </div>
          </div>

          <!-- Tab Switcher -->
          <div style="display:flex; gap:8px; margin-bottom:16px;">
            <button id="artistProjectsTab" onclick="switchArtistTab('projects')"
              style="flex:1; padding:10px; background:#1d1d1f; color:white; border:none; border-radius:8px; font-size:13px; font-weight:500; cursor:pointer;">
              Completed (${completedProjects?.length || 0})
            </button>
            <button id="artistGuestSpotsTab" onclick="switchArtistTab('guestspots')"
              style="flex:1; padding:10px; background:#f5f5f7; color:#1d1d1f; border:none; border-radius:8px; font-size:13px; font-weight:500; cursor:pointer;">
              Shifts (${guestSpots?.length || 0})
            </button>
          </div>

          <!-- Completed Projects Tab Content -->
          <div id="artistProjectsContent" style="display:block;">
            ${completedProjects && completedProjects.length > 0 ? completedProjects.map(proj => `
              <div style="background:#fafafa; padding:12px; border-radius:8px; margin-bottom:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                  <span style="font-size:13px; font-weight:600; color:#1d1d1f;">${proj.project_number || 'No Project'}</span>
                  <span style="padding:3px 8px; background:#34c759; color:white; border-radius:10px; font-size:10px; font-weight:600;">Finished</span>
                </div>
                <div style="font-size:12px; color:#86868b;">
                  ${proj.first_name || ''} ${proj.last_name || ''} ${proj.placement ? 'â€¢ ' + proj.placement : ''}
                </div>
                <div style="font-size:11px; color:#aeaeb2; margin-top:4px;">
                  ${proj.start ? new Date(proj.start).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' }) : '-'}
                </div>
              </div>
            `).join('') : '<p style="text-align:center; color:#86868b; font-size:13px;">No completed projects</p>'}
          </div>

          <!-- Shifts Tab Content -->
          <div id="artistGuestSpotsContent" style="display:none;">
            ${guestSpots && guestSpots.length > 0 ? guestSpots.map(spot => `
              <div style="background:#fafafa; padding:12px; border-radius:8px; margin-bottom:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                  <span style="font-size:13px; font-weight:600; color:#1d1d1f;">${spot.date ? new Date(spot.date).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short' }) : 'No Date'}</span>
                  <span style="padding:3px 8px; background:#007aff; color:white; border-radius:10px; font-size:10px; font-weight:600;">Shift</span>
                </div>
                <div style="font-size:12px; color:#86868b;">
                  ${spot.start_time || ''} - ${spot.end_time || ''}
                </div>
                ${spot.note ? `<div style="font-size:11px; color:#1d1d1f; margin-top:6px; font-style:italic;">"${spot.note}"</div>` : ''}
              </div>
            `).join('') : '<p style="text-align:center; color:#86868b; font-size:13px;">No upcoming shifts</p>'}
          </div>
        `;

        // Show panel
        panel.style.display = 'block';
        setTimeout(() => panel.style.transform = 'translateX(0)', 10);
      };

      window.switchArtistTab = function(tab) {
        const projectsTab = document.getElementById('artistProjectsTab');
        const guestSpotsTab = document.getElementById('artistGuestSpotsTab');
        const projectsContent = document.getElementById('artistProjectsContent');
        const guestSpotsContent = document.getElementById('artistGuestSpotsContent');

        if (tab === 'projects') {
          projectsTab.style.background = '#1d1d1f';
          projectsTab.style.color = 'white';
          guestSpotsTab.style.background = '#f5f5f7';
          guestSpotsTab.style.color = '#1d1d1f';
          projectsContent.style.display = 'block';
          guestSpotsContent.style.display = 'none';
        } else {
          guestSpotsTab.style.background = '#1d1d1f';
          guestSpotsTab.style.color = 'white';
          projectsTab.style.background = '#f5f5f7';
          projectsTab.style.color = '#1d1d1f';
          projectsContent.style.display = 'none';
          guestSpotsContent.style.display = 'block';
        }
      };

      window.closeProfileSidePanel = function() {
        const panel = document.getElementById('profileSidePanel');
        if (panel) {
          panel.style.transform = 'translateX(100%)';
          setTimeout(() => panel.style.display = 'none', 300);
        }
      };

      // Close Appointment Details Modal
      window.closeAppointmentDetailsModal = function() {
        const modal = document.getElementById('appointmentDetailsModal');
        if (modal) {
          modal.classList.remove('active');
        }
        // Also close side panel
        closeProfileSidePanel();
      };

      // ============================================
      // EDIT APPOINTMENT STATE MODAL
      // ============================================
      window.editAppointmentState = async function(appointmentId, currentState) {
        console.log('âœï¸ Edit state for appointment:', appointmentId, 'Current:', currentState);

        // First, close the details modal
        closeAppointmentDetailsModal();

        // Create or get the edit state modal
        let modal = document.getElementById('editStateModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'editStateModal';
          modal.className = 'modal-backdrop';
          document.body.appendChild(modal);
        }

        // Status options with colors (no emojis)
        const appointmentStatusOptions = [
          { value: 'Zugesagt', label: 'Zugesagt', color: '#34C759' },
          { value: 'Unbekannt', label: 'Unbekannt', color: '#8E8E93' },
          { value: 'Ill/No Show', label: 'Didn\'t Show Up', color: '#FF3B30' },
          { value: 'Verschoben', label: 'Rescheduled', color: '#007AFF' },
          { value: 'Reserviert', label: 'Reserved', color: '#FF9500' },
          { value: 'Abgeschlossen', label: 'Abgeschlossen', color: '#34C759' },
          { value: 'Storniert', label: 'Storniert', color: '#FF3B30' }
        ];

        modal.innerHTML = `
          <div class="modal" style="max-width:500px;">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <h3 style="margin:0;">Appointment Status Ã¤ndern</h3>
              <button type="button" class="btn btn-icon" onclick="closeEditStateModal()" style="padding:4px 12px; font-size:20px;">Ã—</button>
            </div>

            <div class="modal-body">
              <p style="color:#666; font-size:14px; margin:0 0 20px 0;">WÃ¤hle den neuen Status fÃ¼r diesen Termin:</p>

              <div class="state-options" style="display:flex; flex-direction:column; gap:8px;">
                ${appointmentStatusOptions.map(status => `
                  <div class="status-option ${currentState === status.value ? 'selected' : ''}" data-status="${status.value}" onclick="selectAppointmentStatusOption('${status.value}')">
                    <span class="status-indicator" style="background: ${status.color};"></span>
                    <span class="status-label">${status.label}</span>
                  </div>
                `).join('')}
              </div>
              <input type="hidden" name="state" id="selectedAppointmentState" value="${currentState || ''}">
            </div>

            <div class="modal-actions" style="margin-top:24px; display:flex; gap:12px; justify-content:flex-end;">
              <button type="button" class="btn btn-secondary" onclick="closeEditStateModal()">Abbrechen</button>
              <button type="button" class="btn btn-primary" onclick="saveAppointmentState('${appointmentId}')">Speichern</button>
            </div>
          </div>
        `;

        // Helper function to select status
        window.selectAppointmentStatusOption = function(statusValue) {
          // Remove selected from all
          modal.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
          // Add selected to clicked one
          modal.querySelector(`.status-option[data-status="${statusValue}"]`).classList.add('selected');
          // Update hidden input
          document.getElementById('selectedAppointmentState').value = statusValue;
        };

        modal.classList.add('active');
      };

      window.saveAppointmentState = async function(appointmentId) {
        const selectedState = document.getElementById('selectedAppointmentState')?.value;

        if (!selectedState) {
          alert('Bitte wÃ¤hle einen Status aus');
          return;
        }

        console.log('ðŸ’¾ Saving state:', selectedState, 'for appointment:', appointmentId);

        try {
          // Update appointment state
          // SQL trigger will automatically update status based on state + end time
          const { data, error } = await supabase
            .from('appointments')
            .update({
              state: selectedState,
              updated_at: new Date().toISOString()
            })
            .eq('id', appointmentId)
            .select()
            .single();

          if (error) throw error;

          console.log('âœ… State updated successfully:', data);

          // Close modal
          closeEditStateModal();

          // Reload calendar
          await loadInitialData();
          renderCalendar();

          // Show success message
          alert('Status erfolgreich aktualisiert!');

        } catch (error) {
          console.error('âŒ Error updating state:', error);
          alert('Fehler beim Aktualisieren des Status: ' + error.message);
        }
      };

      window.closeEditStateModal = function() {
        const modal = document.getElementById('editStateModal');
        if (modal) {
          modal.classList.remove('active');
        }
      };

      // ============================================
      // APPOINTMENT EDIT POPUP (VollstÃ¤ndig)
      // ============================================

      async function openAppointmentEditPopup(appointmentId) {
        // Lade Appointment-Daten MIT Artist-Join fÃ¼r Fallback
        const { data: appointment, error } = await supabase
          .from('appointments')
          .select(`
            *,
            artist:artists(id, name)
          `)
          .eq('id', appointmentId)
          .single();

        if (error || !appointment) {
          console.error('Error loading appointment:', error);
          alert('Fehler beim Laden des Termins');
          return;
        }

        console.log('ðŸ“‹ Edit Popup - Loaded appointment:', appointment);

        // Lade Artists fÃ¼r Artist-Name Lookup (mit mehreren Fallbacks)
        const artists = (typeof CentralDataManager !== 'undefined' && CentralDataManager.getArtists)
          ? CentralDataManager.getArtists()
          : (window.allArtists || window.artistsCache || []);

        console.log('ðŸŽ¨ Edit Popup - Artists loaded:', artists.length);

        // Entferne existierendes Popup
        const existingPopup = document.getElementById('appointmentEditPopup');
        if (existingPopup) existingPopup.remove();

        // Status Optionen
        const statusOptions = [
          { value: 'scheduled', label: 'Zugesagt' },
          { value: 'unknown', label: 'Unbekannt' },
          { value: 'no_show', label: 'Didn\'t Show Up' },
          { value: 'rescheduled', label: 'Rescheduled' },
          { value: 'reserved', label: 'Reserved' },
          { value: 'finished', label: 'Abgeschlossen' },
          { value: 'canceled', label: 'Storniert' }
        ];

        // Work Process Optionen
        const workProcessOptions = [
          { value: '', label: 'Nicht angegeben' },
          { value: 'neustechen', label: 'Neustechen' },
          { value: 'weiterstechen', label: 'Weiterstechen' },
          { value: 'coverup', label: 'Cover-up' },
          { value: 'rework', label: 'Rework' },
          { value: 'touch_up', label: 'Touch-up' }
        ];

        // Booking Type Optionen
        const bookingTypeOptions = [
          { value: '', label: 'Nicht angegeben' },
          { value: 'regular', label: 'Regular' },
          { value: 'wannado', label: 'Wannado' },
          { value: 'guest', label: 'Guest Booking' },
          { value: 'walk_in', label: 'Walk-in' },
          { value: 'consultation', label: 'Beratung' }
        ];

        // Formatiere Datum und Zeit
        const startDate = appointment.start_time || appointment.start ? new Date(appointment.start_time || appointment.start) : new Date();
        const dateStr = startDate.toISOString().split('T')[0];
        const timeStr = startDate.toTimeString().slice(0, 5);

        const endDate = appointment.end_time || appointment.end ? new Date(appointment.end_time || appointment.end) : new Date();
        const endTimeStr = endDate.toTimeString().slice(0, 5);

        // Kundenname
        const customerName = appointment.customer_name ||
          (appointment.first_name && appointment.last_name ? `${appointment.first_name} ${appointment.last_name}` :
          (appointment.first_name || appointment.last_name || 'Unbekannt'));

        // Artist Name (READ-ONLY) - Mehrere Fallbacks
        // 1. Aus dem JOIN (appointment.artist.name)
        // 2. Aus dem Artists-Cache lookup
        // 3. Aus appointment.artist_name falls vorhanden
        const artistFromJoin = appointment.artist?.name;
        const artistFromCache = artists.find(a => a.id === appointment.artist_id)?.name;
        const artistName = artistFromJoin || artistFromCache || appointment.artist_name || 'Kein Artist zugewiesen';

        console.log('ðŸŽ¨ Artist Lookup Result:', {
          artist_id: appointment.artist_id,
          fromJoin: artistFromJoin,
          fromCache: artistFromCache,
          final: artistName
        });

        const popup = document.createElement('div');
        popup.id = 'appointmentEditPopup';
        popup.className = 'appointment-edit-overlay';
        popup.innerHTML = `
          <div class="appointment-edit-popup">
            <div class="appointment-edit-header">
              <h3 class="appointment-edit-title">Termin bearbeiten</h3>
              <button class="appointment-edit-close" onclick="closeAppointmentEditPopup()">âœ•</button>
            </div>
            <div class="appointment-edit-body">

              <!-- Customer Information (Read-only) -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">Kunde</label>
                <div class="appointment-edit-readonly">
                  ${customerName}
                </div>
              </div>

              <!-- Artist (Read-only) -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">Artist</label>
                <div class="appointment-edit-readonly">
                  ${artistName}
                </div>
              </div>

              <!-- Datum und Zeit -->
              <div class="appointment-edit-row">
                <div class="appointment-edit-field">
                  <label class="appointment-edit-label">Datum *</label>
                  <input type="date" class="appointment-edit-input" id="editAppointmentDate" value="${dateStr}">
                </div>
                <div class="appointment-edit-field">
                  <label class="appointment-edit-label">Start Zeit *</label>
                  <input type="time" class="appointment-edit-input" id="editAppointmentStartTime" value="${timeStr}">
                </div>
                <div class="appointment-edit-field">
                  <label class="appointment-edit-label">End Zeit</label>
                  <input type="time" class="appointment-edit-input" id="editAppointmentEndTime" value="${endTimeStr}">
                </div>
              </div>

              <!-- Status -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">Status *</label>
                <select class="appointment-edit-input" id="editAppointmentStatus">
                  ${statusOptions.map(s => `
                    <option value="${s.value}" ${s.value === appointment.status ? 'selected' : ''}>
                      ${s.label}
                    </option>
                  `).join('')}
                </select>
              </div>

              <!-- Work Process -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">Work Process</label>
                <select class="appointment-edit-input" id="editAppointmentWorkProcess">
                  ${workProcessOptions.map(w => `
                    <option value="${w.value}" ${w.value === appointment.work_process ? 'selected' : ''}>
                      ${w.label}
                    </option>
                  `).join('')}
                </select>
              </div>

              <!-- Booking Type -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">Booking Type</label>
                <select class="appointment-edit-input" id="editAppointmentBookingType">
                  ${bookingTypeOptions.map(b => `
                    <option value="${b.value}" ${b.value === appointment.booking_type ? 'selected' : ''}>
                      ${b.label}
                    </option>
                  `).join('')}
                </select>
              </div>

              <!-- Placement -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">Placement</label>
                <input type="text" class="appointment-edit-input" id="editAppointmentPlacement"
                       value="${appointment.placement || ''}" placeholder="z.B. Unterarm, RÃ¼cken...">
              </div>

              <!-- Size -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">GrÃ¶ÃŸe</label>
                <input type="text" class="appointment-edit-input" id="editAppointmentSize"
                       value="${appointment.size || ''}" placeholder="z.B. 10cm, A4...">
              </div>

              <!-- Style -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">Style</label>
                <input type="text" class="appointment-edit-input" id="editAppointmentStyle"
                       value="${appointment.style || ''}" placeholder="z.B. Fineline, Traditional...">
              </div>

              <!-- Colorway -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">Colorway</label>
                <input type="text" class="appointment-edit-input" id="editAppointmentColorway"
                       value="${appointment.colorway || ''}" placeholder="z.B. Black & Grey, Color...">
              </div>

              <!-- Description -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">Beschreibung</label>
                <textarea class="appointment-edit-textarea" id="editAppointmentDescription"
                          placeholder="Motiv-Beschreibung...">${appointment.description || ''}</textarea>
              </div>

              <!-- Notes -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">Notizen</label>
                <textarea class="appointment-edit-textarea" id="editAppointmentNotes"
                          placeholder="Allgemeine Notizen...">${appointment.notes || ''}</textarea>
              </div>

              <!-- Internal Notes -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">Interne Notizen</label>
                <textarea class="appointment-edit-textarea" id="editAppointmentInternalNotes"
                          placeholder="Interne Notizen (nur fÃ¼r Team sichtbar)...">${appointment.internal_notes || ''}</textarea>
              </div>

              <!-- Notice -->
              <div class="appointment-edit-section">
                <label class="appointment-edit-label">Hinweis</label>
                <textarea class="appointment-edit-textarea" id="editAppointmentNotice"
                          placeholder="Besondere Hinweise...">${appointment.notice || ''}</textarea>
              </div>

            </div>
            <div class="appointment-edit-actions">
              <button class="appointment-edit-btn cancel" onclick="closeAppointmentEditPopup()">Abbrechen</button>
              <button class="appointment-edit-btn save" onclick="saveAppointmentEdit('${appointmentId}')">Speichern</button>
            </div>
          </div>
        `;

        document.body.appendChild(popup);

        // Event Listeners fÃ¼r Popup schlieÃŸen
        popup.addEventListener('click', (e) => {
          if (e.target === popup) closeAppointmentEditPopup();
        });

        document.addEventListener('keydown', handleAppointmentEditEscape);
      }

      function handleAppointmentEditEscape(e) {
        if (e.key === 'Escape') closeAppointmentEditPopup();
      }

      function closeAppointmentEditPopup() {
        const popup = document.getElementById('appointmentEditPopup');
        if (popup) popup.remove();
        document.removeEventListener('keydown', handleAppointmentEditEscape);
      }

      async function saveAppointmentEdit(appointmentId) {
        const date = document.getElementById('editAppointmentDate').value;
        const startTime = document.getElementById('editAppointmentStartTime').value;
        const endTime = document.getElementById('editAppointmentEndTime').value;
        const status = document.getElementById('editAppointmentStatus').value;
        const workProcess = document.getElementById('editAppointmentWorkProcess').value;
        const bookingType = document.getElementById('editAppointmentBookingType').value;
        const placement = document.getElementById('editAppointmentPlacement').value;
        const size = document.getElementById('editAppointmentSize').value;
        const style = document.getElementById('editAppointmentStyle').value;
        const colorway = document.getElementById('editAppointmentColorway').value;
        const description = document.getElementById('editAppointmentDescription').value;
        const notes = document.getElementById('editAppointmentNotes').value;
        const internalNotes = document.getElementById('editAppointmentInternalNotes').value;
        const notice = document.getElementById('editAppointmentNotice').value;

        if (!date || !startTime || !status) {
          alert('Bitte alle Pflichtfelder ausfÃ¼llen (Datum, Start Zeit, Status)');
          return;
        }

        // Erstelle DateTime Strings
        const startDateTime = `${date}T${startTime}:00`;
        const endDateTime = endTime ? `${date}T${endTime}:00` : null;

        try {
          // WICHTIG: artist_id wird NICHT geÃ¤ndert (ist read-only)
          const updateData = {
            start_time: startDateTime,
            start: startDateTime,
            end_time: endDateTime,
            end: endDateTime,
            status: status,
            work_process: workProcess || null,
            booking_type: bookingType || null,
            placement: placement || null,
            size: size || null,
            style: style || null,
            colorway: colorway || null,
            description: description || null,
            notes: notes || null,
            internal_notes: internalNotes || null,
            notice: notice || null
          };

          const { error } = await supabase
            .from('appointments')
            .update(updateData)
            .eq('id', appointmentId);

          if (error) throw error;

          console.log('âœ… Appointment updated:', appointmentId);
          closeAppointmentEditPopup();

          // SchlieÃŸe auch das Detail-Popup und refresh Calendar
          const detailPopup = document.querySelector('.appointment-detail-modal, #appointmentDetailModal');
          if (detailPopup) detailPopup.remove();

          // Refresh Calendar
          if (typeof loadCalendarData === 'function') {
            await loadCalendarData();
          } else if (typeof loadInitialData === 'function') {
            await loadInitialData();
          }
          if (typeof renderCalendar === 'function') {
            renderCalendar();
          }

          // Zeige Erfolg
          alert('Termin erfolgreich aktualisiert');

        } catch (err) {
          console.error('âŒ Error updating appointment:', err);
          alert('Fehler beim Speichern: ' + err.message);
        }
      }

      // Expose to window
      window.openAppointmentEditPopup = openAppointmentEditPopup;
      window.closeAppointmentEditPopup = closeAppointmentEditPopup;
      window.saveAppointmentEdit = saveAppointmentEdit;

      // Edit Event Modal Functions
      window.openEditEventModal = async function(eventId) {
        const event = events.find(e => e.id === eventId);
        if (!event) {
          console.error('Event not found:', eventId);
          return;
        }

        // Check if this is an appointment (from appointments table) or event (from events table)
        if (event.isAppointment) {
          // Show appointment details modal instead
          showAppointmentDetails(eventId);
        } else {
          // Load from events table
          const { data: fullEvent, error } = await supabase
            .from('events')
            .select('*')
            .eq('id', eventId)
            .single();

          if (error) {
            console.error('Error loading event:', error);
            alert('Error loading event details');
            return;
          }

          // Check if this is a booking (has artist_id) or an event
          if (fullEvent.artist_id) {
            // This is a booking - open booking modal
            openEditBookingModal(eventId, fullEvent, event);
          } else {
            // This is an event - open event modal
            openEditEventModalInternal(eventId, fullEvent, event);
          }
        }
      };

      // Helper function to open appointment directly from profile view
      window.openAppointmentFromProfile = async function(appointmentId) {
        try {
          // Load appointment from appointments table
          const { data: fullAppointment, error } = await supabase
            .from('appointments')
            .select(`
              *,
              customer:customers(id, first_name, last_name, email, instagram),
              artist:artists(id, name, instagram, is_guest),
              location:locations!appointments_location_id_fkey(name, city)
            `)
            .eq('id', appointmentId)
            .single();

          if (error) {
            console.error('Error loading appointment:', error);
            alert('Error loading appointment details');
            return;
          }

          // Create a minimal event object for compatibility
          const startHour = parseLocalTime(fullAppointment.start);
          const endHour = parseLocalTime(fullAppointment.end);
          const event = {
            id: appointmentId,
            date: fullAppointment.start.split('T')[0],
            startHour: startHour,
            endHour: endHour,
            isAppointment: true
          };

          // Open appointment modal
          openEditBookingModal(appointmentId, fullAppointment, event);
        } catch (err) {
          console.error('Error opening appointment:', err);
          alert('Error opening appointment: ' + err.message);
        }
      };

      // Helper function to parse local time from ISO string
      const parseLocalTime = (timeStr) => {
        const [datePart, timePart] = timeStr.split('T');
        const [hours, minutes] = timePart.split(':').map(Number);
        return hours + minutes / 60;
      };

      // Internal function to open event modal
      function openEditEventModalInternal(eventId, fullEvent, event) {
        // Populate form fields
        document.getElementById('editEventId').value = eventId;
        document.getElementById('editEventTitle').value = fullEvent.title || '';
        document.getElementById('editEventType').value = fullEvent.type || '';
        document.getElementById('editEventDescription').value = fullEvent.description || '';
        document.getElementById('editEventDate').value = event.date;
        document.getElementById('editEventStartTime').value = event.startHour.toString();
        document.getElementById('editEventEndTime').value = event.endHour.toString();
        document.getElementById('editEventAttendanceRequired').checked = fullEvent.attendance_required || false;
        
        // Clear all group checkboxes first
        document.querySelectorAll('.edit-group-checkbox').forEach(cb => cb.checked = false);
        
        // Set selected groups
        if (fullEvent.visible_groups && Array.isArray(fullEvent.visible_groups)) {
          fullEvent.visible_groups.forEach(group => {
            const checkbox = document.querySelector(`.edit-group-checkbox[value="${group}"]`);
            if (checkbox) checkbox.checked = true;
          });
          
          // Check if all groups are selected
          const allCheckboxes = document.querySelectorAll('.edit-group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          document.getElementById('editGroupCheckboxAll').checked = allChecked;
        }
        
        // Open modal
        document.getElementById('editEventModal').classList.add('active');
      }
      
      // Function to open booking modal
      function openEditBookingModal(bookingId, fullBooking, booking) {
        // Find artist
        const artist = allArtists.find(a => a.id === fullBooking.artist_id);
        
        // Populate form fields
        document.getElementById('editBookingId').value = bookingId;
        document.getElementById('editBookingCustomer').value = fullBooking.title || '';
        document.getElementById('editBookingType').value = fullBooking.type || '';
        document.getElementById('editBookingArtistName').value = artist?.name || 'Unknown Artist';
        document.getElementById('editBookingArtistId').value = fullBooking.artist_id;
        document.getElementById('editBookingDate').value = booking.date;
        document.getElementById('editBookingStartTime').value = booking.startHour.toString();
        document.getElementById('editBookingEndTime').value = booking.endHour.toString();
        
        // Open modal
        document.getElementById('editBookingModal').classList.add('active');
      }
      
      // Edit "All Groups" checkbox handler
      document.getElementById('editGroupCheckboxAll')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox');
        groupCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });
      
      // Individual edit group checkbox handler
      document.querySelectorAll('.edit-group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.edit-group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const allCheckbox = document.getElementById('editGroupCheckboxAll');
          if (allCheckbox) {
            allCheckbox.checked = allChecked;
          }
        });
      });
      
      // Cancel edit event
      document.getElementById('cancelEditEvent')?.addEventListener('click', () => {
        document.getElementById('editEventModal').classList.remove('active');
      });
      
      // Submit edit event form
      document.getElementById('editEventForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const eventId = document.getElementById('editEventId').value;
        const title = document.getElementById('editEventTitle').value.trim();
        const type = document.getElementById('editEventType').value.trim();
        const description = document.getElementById('editEventDescription').value.trim();
        const date = document.getElementById('editEventDate').value;
        const startHour = parseFloat(document.getElementById('editEventStartTime').value);
        const endHour = parseFloat(document.getElementById('editEventEndTime').value);
        const attendanceRequired = document.getElementById('editEventAttendanceRequired').checked;
        
        // Collect selected groups
        const selectedGroups = [];
        const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox:checked');
        groupCheckboxes.forEach(checkbox => {
          selectedGroups.push(checkbox.value);
        });
        
        // Validation
        if (!title || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Get current event to check if date/time changed
        const currentEvent = events.find(e => e.id === eventId);
        let newSlot = currentEvent?.slot || 1;
        
        // If date or time changed, find a new available slot
        if (currentEvent && (currentEvent.date !== date || currentEvent.startHour !== startHour || currentEvent.endHour !== endHour)) {
          // Temporarily remove current event from events array for slot calculation
          const tempEvents = events.filter(e => e.id !== eventId);
          const oldEvents = events;
          events = tempEvents;
          
          const availableSlot = findAvailableSlot(date, 'events', startHour, endHour);
          
          // Restore events array
          events = oldEvents;
          
          if (availableSlot === null) {
            return alert('All slots are occupied for this new time range. Please choose a different time or date.');
          }
          newSlot = availableSlot;
        }
        
        try {
          // Update event in Supabase
          const { error } = await supabase
            .from('events')
            .update({
              title,
              type,
              description: description || null,
              visible_groups: selectedGroups.length > 0 ? selectedGroups : null,
              attendance_required: attendanceRequired,
              slot: newSlot,
              start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
              end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
            })
            .eq('id', eventId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event updated successfully!');
        } catch (err) {
          console.error('Error updating event:', err);
          alert('Error updating event: ' + err.message);
        }
      });
      
      // Delete event
      document.getElementById('deleteEventBtn')?.addEventListener('click', async () => {
        const eventId = document.getElementById('editEventId').value;
        
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .delete()
            .eq('id', eventId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event deleted successfully!');
        } catch (err) {
          console.error('Error deleting event:', err);
          alert('Error deleting event: ' + err.message);
        }
      });
      
      // Edit Booking Modal Functions
      document.getElementById('cancelEditBooking')?.addEventListener('click', () => {
        document.getElementById('editBookingModal').classList.remove('active');
      });
      
      // Submit edit booking form
      document.getElementById('editBookingForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const bookingId = document.getElementById('editBookingId').value;
        const customerName = document.getElementById('editBookingCustomer').value.trim();
        const type = document.getElementById('editBookingType').value;
        const artistId = document.getElementById('editBookingArtistId').value;
        const date = document.getElementById('editBookingDate').value;
        const startHour = parseFloat(document.getElementById('editBookingStartTime').value);
        const endHour = parseFloat(document.getElementById('editBookingEndTime').value);
        
        // Validation
        if (!customerName || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Get current booking to check if date/time changed
        const currentBooking = events.find(e => e.id === bookingId);
        let newSlot = currentBooking?.slot || 1;
        
        // If date or time changed, find a new available slot
        if (currentBooking && (currentBooking.date !== date || currentBooking.startHour !== startHour || currentBooking.endHour !== endHour)) {
          // Determine category
          const artist = allArtists.find(a => a.id === artistId);
          const category = artist?.is_guest ? 'guest' : 'resident';
          
          // Temporarily remove current booking from events array for slot calculation
          const tempEvents = events.filter(e => e.id !== bookingId);
          const oldEvents = events;
          events = tempEvents;
          
          const availableSlot = findAvailableSlot(date, category, startHour, endHour);
          
          // Restore events array
          events = oldEvents;
          
          if (availableSlot === null) {
            return alert('All slots are occupied for this new time range. Please choose a different time or date.');
          }
          newSlot = availableSlot;
        }
        
        try {
          // Update booking in Supabase
          const { error } = await supabase
            .from('events')
            .update({
              title: customerName,
              type,
              slot: newSlot,
              start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
              end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
            })
            .eq('id', bookingId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editBookingModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Booking updated successfully!');
        } catch (err) {
          console.error('Error updating booking:', err);
          alert('Error updating booking: ' + err.message);
        }
      });
      
      // Delete booking
      document.getElementById('deleteBookingBtn')?.addEventListener('click', async () => {
        const bookingId = document.getElementById('editBookingId').value;
        
        if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .delete()
            .eq('id', bookingId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editBookingModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Booking deleted successfully!');
        } catch (err) {
          console.error('Error deleting booking:', err);
          alert('Error deleting booking: ' + err.message);
        }
      });
      
      // Category checkboxes
      document.getElementById('checkEvents').addEventListener('change', (e) => {
        visibleCategories.events = e.target.checked;
        renderCalendar();
      });
      
      document.getElementById('checkResidents').addEventListener('change', (e) => {
        visibleCategories.residents = e.target.checked;
        renderCalendar();
      });
      
      document.getElementById('checkGuests').addEventListener('change', (e) => {
        visibleCategories.guests = e.target.checked;
        renderCalendar();
      });
      
    });

    // ===== NEW DIENSTPLAN & WORK TRACKING SYSTEM =====

    // Global variables for caching
    let dienstplanCache = [];
    let dienstplanFiltered = [];
    let workTrackingCache = [];
    let workTrackingStats = {};

    // Global variables for month navigation
    let dienstplanCurrentMonth = new Date().getMonth();
    let dienstplanCurrentYear = new Date().getFullYear();

    // Initialize month selectors
    function initDienstplanMonthSelectors() {
      const monthSelect = document.getElementById('dienstplanMonthSelect');
      const yearSelect = document.getElementById('dienstplanYearSelect');

      console.log('ðŸ“… initDienstplanMonthSelectors() - Setting month:', dienstplanCurrentMonth, 'year:', dienstplanCurrentYear);

      if (monthSelect) {
        monthSelect.value = String(dienstplanCurrentMonth);
        console.log('ðŸ“… Month selector set to:', monthSelect.value, '(option text:', monthSelect.options[monthSelect.selectedIndex]?.text, ')');
      } else {
        console.warn('âš ï¸ Month selector element not found!');
      }

      if (yearSelect) {
        const currentYear = new Date().getFullYear();
        yearSelect.innerHTML = '';
        for (let y = currentYear - 1; y <= currentYear + 2; y++) {
          yearSelect.innerHTML += `<option value="${y}" ${y === dienstplanCurrentYear ? 'selected' : ''}>${y}</option>`;
        }
        console.log('ðŸ“… Year selector set to:', yearSelect.value);
      } else {
        console.warn('âš ï¸ Year selector element not found!');
      }
    }

    // Change month via dropdown
    function changeDienstplanMonth() {
      const monthSelect = document.getElementById('dienstplanMonthSelect');
      const yearSelect = document.getElementById('dienstplanYearSelect');

      if (monthSelect && yearSelect) {
        dienstplanCurrentMonth = parseInt(monthSelect.value);
        dienstplanCurrentYear = parseInt(yearSelect.value);
        applyDienstplanFilters();
      }
    }

    // Navigate to prev/next month
    function navigateDienstplanMonth(direction) {
      dienstplanCurrentMonth += direction;

      if (dienstplanCurrentMonth > 11) {
        dienstplanCurrentMonth = 0;
        dienstplanCurrentYear++;
      } else if (dienstplanCurrentMonth < 0) {
        dienstplanCurrentMonth = 11;
        dienstplanCurrentYear--;
      }

      initDienstplanMonthSelectors();
      applyDienstplanFilters();
    }

    // Jump to current month
    function goToDienstplanThisMonth() {
      dienstplanCurrentMonth = new Date().getMonth();
      dienstplanCurrentYear = new Date().getFullYear();
      initDienstplanMonthSelectors();
      applyDienstplanFilters();
    }

    // Make functions globally available
    window.navigateDienstplanMonth = navigateDienstplanMonth;
    window.changeDienstplanMonth = changeDienstplanMonth;
    window.goToDienstplanThisMonth = goToDienstplanThisMonth;
    window.initDienstplanMonthSelectors = initDienstplanMonthSelectors;

    // Helper function: Get role badge HTML
    function getRoleBadge(role) {
      const roleColors = {
        'GeschÃ¤ftsfÃ¼hrung': { bg: 'rgba(255, 215, 0, 0.15)', text: '#B8860B', label: 'GF' },
        'Management': { bg: 'rgba(0, 122, 255, 0.15)', text: '#007AFF', label: 'Management' },
        'Booking Team': { bg: 'rgba(175, 82, 222, 0.15)', text: '#AF52DE', label: 'Booking' },
        'Resident Artist': { bg: 'rgba(52, 199, 89, 0.15)', text: '#34C759', label: 'Resident' },
        'Guest Artist': { bg: 'rgba(90, 200, 250, 0.15)', text: '#5AC8FA', label: 'Guest' },
        'Mediadepartment': { bg: 'rgba(255, 149, 0, 0.15)', text: '#FF9500', label: 'Media' },
        'other': { bg: 'rgba(142, 142, 147, 0.15)', text: '#8E8E93', label: 'Other' }
      };

      const config = roleColors[role] || {
        bg: 'rgba(142, 142, 147, 0.15)',
        text: '#8E8E93',
        label: role || 'Unbekannt'
      };

      return `
        <span style="
          display: inline-block;
          padding: 4px 10px;
          border-radius: 6px;
          background: ${config.bg};
          color: ${config.text};
          font-size: 11px;
          font-weight: 600;
          letter-spacing: 0.3px;
          text-transform: uppercase;
        ">${config.label}</span>
      `;
    }

    // Helper function: Get status badge HTML
    function getStatusBadge(status) {
      const statusColors = {
        'Available': { bg: 'rgba(52, 199, 89, 0.15)', text: '#34C759' },
        'Vacation': { bg: 'rgba(255, 149, 0, 0.15)', text: '#FF9500' },
        'Blocked': { bg: 'rgba(255, 59, 48, 0.15)', text: '#FF3B30' }
      };

      const config = statusColors[status] || { bg: 'rgba(142, 142, 147, 0.15)', text: '#8E8E93' };

      return `
        <span style="
          display: inline-block;
          padding: 4px 10px;
          border-radius: 6px;
          background: ${config.bg};
          color: ${config.text};
          font-size: 11px;
          font-weight: 600;
        ">${status || 'N/A'}</span>
      `;
    }

    // Helper function: Format date
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // Load Dienstplan Data from database with BATCH LOADING
    async function loadDienstplanData() {
      console.log('ðŸ“… Loading Dienstplan data...');

      // Initialize month selectors
      initDienstplanMonthSelectors();

      try {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // USE CENTRAL DATA MANAGER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (CentralDataManager.isReady()) {
          dienstplanCache = CentralDataManager.getDienstplan();
          workTrackingCache = CentralDataManager.getWorkTracking();
          console.log(`ðŸ“… Using cached dienstplan: ${dienstplanCache.length} entries`);
          console.log(`â° Using cached work_tracking: ${workTrackingCache.length} entries`);

          // Apply filters (which will filter by date range)
          applyDienstplanFilters();
          return;
        }

        // Fallback: Load from database
        console.log('ðŸš¨ FALLBACK: BATCH LOADING ALL DIENSTPLAN DATA');

        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;
        let batchNumber = 1;

        while (hasMore) {
          console.log(`ðŸ“¦ Loading dienstplan batch ${batchNumber} (records ${from} to ${from + batchSize - 1})...`);

          const { data: batch, error } = await supabase
            .from('dienstplan')
            .select(`
              *,
              artist:artists!artist_id(
                name,
                email,
                instagram,
                rank,
                is_guest
              ),
              location:locations!location_id(
                name,
                city
              )
            `)
            .order('start_date', { ascending: true })
            .range(from, from + batchSize - 1);

          if (error) {
            console.error('âŒ Error loading dienstplan batch:', error);
            showNotification('Fehler beim Laden der Dienstplan-Daten', 'error');
            return;
          }

          if (batch && batch.length > 0) {
            allData = allData.concat(batch);
            from += batchSize;
            hasMore = batch.length === batchSize;
            console.log(`  â†³ Loaded ${allData.length} dienstplan entries so far...`);
            batchNumber++;
          } else {
            hasMore = false;
          }
        }

        dienstplanCache = allData || [];
        console.log('âœ… Loaded', dienstplanCache.length, 'total dienstplan entries in', batchNumber - 1, 'batches');

        // Apply filters (which will filter by date range)
        applyDienstplanFilters();

        // Also load work tracking data
        await loadWorkTrackingData();
      } catch (err) {
        console.error('âŒ Exception loading dienstplan:', err);
        showNotification('Fehler beim Laden der Dienstplan-Daten', 'error');
      }
    }

    // Apply filters to dienstplan data
    function applyDienstplanFilters() {
      const roleFilter = document.getElementById('dienstplanRoleFilter')?.value || 'all';
      const statusFilter = document.getElementById('dienstplanStatusFilter')?.value || 'all';

      // Use global month variables for date range
      const daysInMonth = new Date(dienstplanCurrentYear, dienstplanCurrentMonth + 1, 0).getDate();
      const startDateStr = `${dienstplanCurrentYear}-${String(dienstplanCurrentMonth + 1).padStart(2, '0')}-01`;
      const endDateStr = `${dienstplanCurrentYear}-${String(dienstplanCurrentMonth + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;

      console.log('ðŸ” Applying filters - Role:', roleFilter, 'Status:', statusFilter, 'Month:', startDateStr, 'to', endDateStr);

      dienstplanFiltered = dienstplanCache.filter(entry => {
        // Date range filter: entry overlaps with selected month
        const entryStart = entry.start_date;
        const entryEnd = entry.end_date;

        // Entry overlaps month if: entry.start <= monthEnd AND entry.end >= monthStart
        const overlapsMonth = entryStart <= endDateStr && entryEnd >= startDateStr;
        if (!overlapsMonth) return false;

        // Role filter
        if (roleFilter !== 'all') {
          if (roleFilter === 'null' && entry.role !== null) return false;
          if (roleFilter !== 'null' && entry.role !== roleFilter) return false;
        }

        // Status filter
        if (statusFilter !== 'all' && entry.state !== statusFilter) return false;

        return true;
      });

      // Sort: start_date ASC, then role ASC
      dienstplanFiltered.sort((a, b) => {
        const dateCompare = new Date(a.start_date) - new Date(b.start_date);
        if (dateCompare !== 0) return dateCompare;
        return (a.role || 'zzz').localeCompare(b.role || 'zzz');
      });

      console.log('âœ… Filtered:', dienstplanFiltered.length, 'entries from', dienstplanCache.length, 'total');
      renderDienstplanTable();

      // Update Header mit aktuellem Monat
      if (typeof updateDienstplanHeaderMonth === 'function') {
        updateDienstplanHeaderMonth();
      }
    }

    // ==========================================
    // HELPER: Format Date Key (Global)
    // ==========================================
    /**
     * Formatiert ein Datum als YYYY-MM-DD String ohne Timezone-Probleme
     */
    function formatDateKey(year, month, day) {
      return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    }
    window.formatDateKey = formatDateKey;

    // ==========================================
    // DIENSTPLAN STATE CONFIGURATION (GLOBAL)
    // ==========================================

    // SVG Icons fÃ¼r States (14x14, stroke="currentColor" fÃ¼r Farbvererbung)
    const stateIcons = {
      'Available': `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
      'Vacation': `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M2 12c0-5.5 4.5-10 10-10s10 4.5 10 10H2z"></path></svg>`,
      'Business trip': `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.8 19.2L16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"></path></svg>`,
      'Guestspot': `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>`,
      'Sick': `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"></path><path d="M12 11a1 1 0 0 0-1 1v3"></path></svg>`,
      'Training': `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path><path d="M8 7h8M8 11h6"></path></svg>`,
      'Convention': `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"></path><path d="M13 5v2M13 17v2M13 11v2"></path></svg>`,
      'Home office': `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
      'Other': `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>`
    };

    // State-Konfiguration mit Farben und SVG-Icons
    const stateConfig = {
      'Available': { label: 'Available', color: '#34C759', icon: stateIcons['Available'] },
      'Vacation': { label: 'Vacation', color: '#FF9500', icon: stateIcons['Vacation'] },
      'Business trip': { label: 'Business Trip', color: '#007AFF', icon: stateIcons['Business trip'] },
      'Other': { label: 'Other', color: '#8E8E93', icon: stateIcons['Other'] },
      'Guestspot': { label: 'Guestspot', color: '#00C7BE', icon: stateIcons['Guestspot'] },
      'Sick': { label: 'Sick', color: '#FF3B30', icon: stateIcons['Sick'] },
      'Training': { label: 'Training', color: '#AF52DE', icon: stateIcons['Training'] },
      'Convention': { label: 'Convention', color: '#FF2D55', icon: stateIcons['Convention'] },
      'Home office': { label: 'Home Office', color: '#FFCC00', icon: stateIcons['Home office'] }
    };

    // Global verfÃ¼gbar machen
    window.stateIcons = stateIcons;
    window.stateConfig = stateConfig;

    // Render Dienstplan Timeline (Horizontal View with Role Groups)
    function renderDienstplanTable() {
      const container = document.getElementById('dienstplanTableContainer');
      if (!container) return;

      // PrÃ¼fe ob Daten vorhanden
      if (!dienstplanFiltered || dienstplanFiltered.length === 0) {
        const totalInCache = dienstplanCache.length || 0;
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #86868b;">
            <p style="font-size: 16px;">Keine EintrÃ¤ge gefunden</p>
            <p style="font-size: 14px; margin-top: 8px;">
              ${totalInCache > 0
                ? `WÃ¤hlen Sie einen anderen Zeitraum oder passen Sie die Filter an. (${totalInCache} EintrÃ¤ge gesamt in Datenbank)`
                : 'Die Dienstplan-Tabelle enthÃ¤lt noch keine Daten. Bitte prÃ¼fen Sie die Datenbankverbindung.'}
            </p>
          </div>
        `;
        return;
      }

      // Nutze globale Monat-Variablen
      const currentMonth = dienstplanCurrentMonth;
      const currentYear = dienstplanCurrentYear;
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      // formatDateKey wird nun als globale Funktion verwendet

      const todayDate = new Date();
      const today = formatDateKey(todayDate.getFullYear(), todayDate.getMonth(), todayDate.getDate());

      // Toggle-Status
      const showOnlyWithEntries = document.getElementById('showOnlyWithEntries')?.checked ?? true;

      // Gruppiere nach Rolle â†’ Artist
      const groupedData = {};
      const artistsWithEntries = new Set();

      dienstplanFiltered.forEach(entry => {
        const role = entry.role || 'Ohne Rolle';
        const artistId = entry.artist_id;
        const artistName = entry.artist?.name || 'Unbekannt';

        if (!groupedData[role]) groupedData[role] = {};
        if (!groupedData[role][artistId]) {
          groupedData[role][artistId] = {
            name: artistName,
            entries: []
          };
        }
        groupedData[role][artistId].entries.push(entry);
        artistsWithEntries.add(artistId);
      });

      // Rollen-Konfiguration: DB-Wert â†’ Display Label + Farbe
      const roleConfig = {
        'GeschÃ¤ftsfÃ¼hrung': { label: 'Administrator', color: '#FFD60A' },
        'Management': { label: 'Booking Manager', color: '#007AFF' },
        'Resident Artist': { label: 'Resident', color: '#34C759' },
        'Guest Artist': { label: 'Guest', color: '#00C7BE' },
        'Mediadepartment': { label: 'Media', color: '#FF9500' },
        'Ohne Rolle': { label: 'Not defined', color: '#8E8E93' }
      };

      // Rollen-Reihenfolge fÃ¼r Anzeige
      const roleOrder = [
        'GeschÃ¤ftsfÃ¼hrung',  // â†’ Administrator
        'Management',        // â†’ Booking Manager
        'Resident Artist',   // â†’ Resident
        'Guest Artist',      // â†’ Guest
        'Mediadepartment',   // â†’ Media
        'Ohne Rolle'         // â†’ Not defined (null values)
      ];

      // stateIcons und stateConfig werden als globale Variablen verwendet

      // Wochentag-KÃ¼rzel
      const dayNames = ['S', 'M', 'D', 'M', 'D', 'F', 'S'];

      // Monatsname
      const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];

      // HTML generieren
      let html = `
        <div style="overflow-x: auto; overflow-y: auto; max-height: calc(100vh - 300px); border-radius: 12px; border: 1px solid rgba(0,0,0,0.08); background: white;">
          <div class="dienstplan-timeline" style="
            display: grid;
            grid-template-columns: 200px repeat(${daysInMonth}, minmax(36px, 1fr));
            min-width: max-content;
          ">
            <!-- Header Row - Resources (doppelt sticky: top + left) -->
            <div style="
              position: sticky;
              top: 0;
              left: 0;
              background: #f5f5f7;
              padding: 12px;
              font-weight: 600;
              font-size: 12px;
              border-bottom: 1px solid rgba(0,0,0,0.1);
              z-index: 30;
              display: flex;
              align-items: center;
            ">
              Resources
            </div>
      `;

      // Tage-Header (sticky top)
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dateKey = formatDateKey(currentYear, currentMonth, day);
        const dayOfWeek = date.getDay();
        const isToday = dateKey === today;
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

        html += `
          <div class="timeline-day-header" data-date="${dateKey}" style="
            position: sticky;
            top: 0;
            padding: 8px 4px;
            text-align: center;
            font-size: 11px;
            font-weight: ${isToday ? '700' : '500'};
            background: ${isToday ? '#FF3B30' : isWeekend ? 'rgba(0,0,0,0.03)' : '#f5f5f7'};
            color: ${isToday ? 'white' : isWeekend ? '#86868b' : '#1d1d1f'};
            border-bottom: 1px solid rgba(0,0,0,0.1);
            z-index: 20;
            ${isToday ? 'border-radius: 4px; margin: 2px;' : ''}
          ">
            ${day} ${dayNames[dayOfWeek]}
          </div>
        `;
      }

      // Rollen-Gruppen
      roleOrder.forEach(role => {
        if (!groupedData[role]) return;

        const artists = Object.entries(groupedData[role]);
        const artistCount = artists.length;
        const isCollapsed = localStorage.getItem(`dienstplan_group_${role}`) === 'collapsed';
        const roleClass = role.replace(/\s+/g, '-').replace(/[Ã¤Ã¶Ã¼]/g, c => ({Ã¤:'ae',Ã¶:'oe',Ã¼:'ue'}[c]));

        // Nutze roleConfig fÃ¼r Farbe und Label
        const config = roleConfig[role] || { label: role, color: '#8E8E93' };
        const roleColor = config.color;
        const roleLabel = config.label;

        html += `
          <!-- Role Group: ${role} -->
          <div class="timeline-role-header" style="
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: linear-gradient(180deg, rgba(0,0,0,0.03) 0%, rgba(0,0,0,0.05) 100%);
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            user-select: none;
          " onclick="toggleDienstplanGroup('${role}', this)">
            <span class="group-toggle" style="font-size: 14px; width: 18px; text-align: center; color: #86868b;">${isCollapsed ? 'âŠ•' : 'âŠ–'}</span>
            <span style="
              display: inline-block;
              width: 8px;
              height: 8px;
              border-radius: 50%;
              background: ${roleColor};
            "></span>
            <span>${roleLabel}</span>
            <span style="color: #86868b; font-weight: 400; font-size: 12px;">(${artistCount} ${artistCount === 1 ? 'Person' : 'Personen'})</span>
          </div>
        `;

        // Artist-Zeilen
        artists.forEach(([artistId, artistData]) => {
          html += `
            <div class="artist-row-${roleClass}" style="display: ${isCollapsed ? 'none' : 'contents'};">
              <div style="
                position: sticky;
                left: 0;
                padding: 8px 12px;
                font-size: 13px;
                background: white;
                border-bottom: 1px solid rgba(0,0,0,0.05);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                z-index: 5;
                display: flex;
                align-items: center;
                gap: 8px;
              ">
                <span style="
                  display: inline-block;
                  width: 6px;
                  height: 6px;
                  border-radius: 50%;
                  background: ${roleColor};
                  opacity: 0.6;
                "></span>
                ${artistData.name}
              </div>
          `;

          // ============================================
          // GRUPPIERE AUFEINANDERFOLGENDE SLOTS MIT GLEICHEM STATUS
          // ============================================
          // Sortiere EintrÃ¤ge nach start_date
          const sortedEntries = [...artistData.entries].sort((a, b) => {
            return a.start_date.localeCompare(b.start_date);
          });

          // Gruppiere aufeinanderfolgende Tage mit gleichem Status
          const groupedEntries = [];
          let currentGroup = null;

          sortedEntries.forEach(entry => {
            const entryDate = entry.start_date;
            const entryState = entry.state || 'Other';

            if (!currentGroup) {
              // Erste Gruppe starten
              currentGroup = {
                start_date: entry.start_date,
                end_date: entry.end_date || entry.start_date,
                state: entryState,
                working_start: entry.working_start,
                working_end: entry.working_end,
                location: entry.location,
                slot_ids: [entry.id],
                original_entries: [entry]
              };
            } else {
              // PrÃ¼fe ob dieser Eintrag direkt nach dem vorherigen kommt
              const lastEndDate = new Date(currentGroup.end_date);
              const thisStartDate = new Date(entry.start_date);
              const diffDays = Math.round((thisStartDate - lastEndDate) / (1000 * 60 * 60 * 24));

              // Wenn gleicher Status und aufeinanderfolgend (max 1 Tag Abstand)
              if (entryState === currentGroup.state && diffDays <= 1) {
                // Erweitere die Gruppe
                currentGroup.end_date = entry.end_date || entry.start_date;
                currentGroup.slot_ids.push(entry.id);
                currentGroup.original_entries.push(entry);
              } else {
                // Speichere vorherige Gruppe und starte neue
                groupedEntries.push(currentGroup);
                currentGroup = {
                  start_date: entry.start_date,
                  end_date: entry.end_date || entry.start_date,
                  state: entryState,
                  working_start: entry.working_start,
                  working_end: entry.working_end,
                  location: entry.location,
                  slot_ids: [entry.id],
                  original_entries: [entry]
                };
              }
            }
          });

          // Letzte Gruppe hinzufÃ¼gen
          if (currentGroup) {
            groupedEntries.push(currentGroup);
          }

          // Erstelle Map fÃ¼r alle Tage dieses Artists (String-basierte Logik)
          const dayMap = {}; // dayMap[dayNumber] = { entry, span } oder 'skip'
          const monthStartStr = formatDateKey(currentYear, currentMonth, 1);
          const monthEndStr = formatDateKey(currentYear, currentMonth, daysInMonth);

          // Verwende gruppierte EintrÃ¤ge statt Original-EintrÃ¤ge
          groupedEntries.forEach(entry => {
            // Parse Start/End als Strings (YYYY-MM-DD)
            const entryStartStr = entry.start_date;
            const entryEndStr = entry.end_date || entry.start_date;

            // Berechne effektiven Start/End im aktuellen Monat
            let effectiveStartDay = 1;
            let effectiveEndDay = daysInMonth;

            // Wenn Eintrag im oder nach Monatsstart beginnt
            if (entryStartStr >= monthStartStr && entryStartStr <= monthEndStr) {
              effectiveStartDay = parseInt(entryStartStr.split('-')[2]);
            }

            // Wenn Eintrag im oder vor Monatsende endet
            if (entryEndStr >= monthStartStr && entryEndStr <= monthEndStr) {
              effectiveEndDay = parseInt(entryEndStr.split('-')[2]);
            }

            // Wenn Eintrag vor dem Monat startet
            if (entryStartStr < monthStartStr) {
              effectiveStartDay = 1;
            }

            // Wenn Eintrag nach dem Monat endet
            if (entryEndStr > monthEndStr) {
              effectiveEndDay = daysInMonth;
            }

            const spanDays = effectiveEndDay - effectiveStartDay + 1;

            // Speichere Entry am Start-Tag (Ã¼berschreibe nicht existierende)
            if (!dayMap[effectiveStartDay]) {
              dayMap[effectiveStartDay] = {
                entry: entry,
                span: spanDays
              };

              // Markiere Folge-Tage als skip
              for (let d = effectiveStartDay + 1; d <= effectiveEndDay; d++) {
                if (!dayMap[d]) {
                  dayMap[d] = 'skip';
                }
              }
            }
          });

          // Rendere Tages-Zellen
          for (let day = 1; day <= daysInMonth; day++) {
            const cellData = dayMap[day];
            const dateKey = formatDateKey(currentYear, currentMonth, day);
            const dayOfWeek = new Date(currentYear, currentMonth, day).getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const isToday = dateKey === today;

            if (cellData === 'skip') {
              // Zelle wird vom Balken Ã¼berspannt - NICHT rendern
              continue;
            }

            if (cellData && cellData.entry) {
              // BALKEN rendern
              const entry = cellData.entry;
              const spanDays = cellData.span;

              // Nutze stateConfig fÃ¼r Farbe und Icon
              const stateInfo = stateConfig[entry.state] || { label: entry.state || 'Other', color: '#8E8E93', icon: 'â—‹' };
              const bgColor = stateInfo.color;
              const stateIcon = stateInfo.icon;
              const stateLabel = stateInfo.label;

              const workingHours = entry.working_start && entry.working_end
                ? `${entry.working_start.substring(0,5)}-${entry.working_end.substring(0,5)}`
                : '';

              const tooltipText = `${stateLabel}: ${artistData.name}\n${entry.start_date} - ${entry.end_date}${workingHours ? '\nZeit: ' + workingHours : ''}${entry.location?.name ? '\nOrt: ' + entry.location.name : ''}`;

              // Erstelle slotData fÃ¼r das Popup (nutze slot_ids aus gruppiertem Eintrag)
              const slotData = {
                id: entry.slot_ids ? entry.slot_ids[0] : entry.id,
                artist_id: artistId,
                artist_name: artistData.name,
                start_date: entry.start_date,
                end_date: entry.end_date || entry.start_date,
                start_time: entry.working_start ? entry.working_start.substring(0,5) : '10:00',
                end_time: entry.working_end ? entry.working_end.substring(0,5) : '18:00',
                type: entry.state,
                slot_ids: entry.slot_ids || [entry.id]
              };
              const slotDataStr = JSON.stringify(slotData).replace(/'/g, "\\'").replace(/"/g, '&quot;');

              html += `
                <div class="slot-group" style="
                  grid-column: span ${spanDays};
                  background: ${bgColor};
                  margin: 4px 2px;
                  color: white;
                  font-weight: 500;
                  box-shadow: 0 1px 3px rgba(0,0,0,0.12);
                "
                onclick="openSlotViewPopup(JSON.parse(this.dataset.slot))"
                data-slot="${slotDataStr}"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'"
                onmouseout="this.style.transform=''; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.12)'"
                title="${tooltipText}">
                  <span style="display: flex; align-items: center; color: white;">${stateIcon}</span>
                  ${spanDays > 2 && workingHours ? `<span style="font-size: 11px; margin-left: 4px;">${workingHours}</span>` : ''}
                </div>
              `;
            } else {
              // Leere Zelle
              html += `
                <div style="
                  background: ${isToday ? 'rgba(255, 59, 48, 0.05)' : isWeekend ? 'rgba(0,0,0,0.02)' : 'white'};
                  border-bottom: 1px solid rgba(0,0,0,0.05);
                  min-height: 36px;
                "></div>
              `;
            }
          }

          html += `</div>`; // Ende artist-row
        });
      });

      html += `
          </div>
        </div>

        <!-- Legende mit allen Status -->
        <div style="
          margin-top: 16px;
          padding: 12px 16px;
          background: rgba(0,0,0,0.02);
          border-radius: 8px;
          display: flex;
          flex-wrap: wrap;
          gap: 12px 20px;
          font-size: 12px;
        ">
          <span style="font-weight: 600; color: #86868b;">Status:</span>
          ${Object.entries(stateConfig).map(([state, config]) => `
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="
                width: 18px;
                height: 18px;
                border-radius: 4px;
                background: ${config.color};
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
              ">${config.icon}</div>
              <span>${config.label}</span>
            </div>
          `).join('')}
        </div>
      `;

      container.innerHTML = html;
    }

    // Toggle-Funktion fÃ¼r Rollen-Gruppen
    function toggleDienstplanGroup(role, headerElement) {
      const roleClass = role.replace(/\s+/g, '-').replace(/[Ã¤Ã¶Ã¼]/g, c => ({Ã¤:'ae',Ã¶:'oe',Ã¼:'ue'}[c]));
      const rows = document.querySelectorAll(`.artist-row-${roleClass}`);
      const toggleIcon = headerElement.querySelector('.group-toggle');

      const isCurrentlyCollapsed = localStorage.getItem(`dienstplan_group_${role}`) === 'collapsed';

      if (isCurrentlyCollapsed) {
        // Expand
        rows.forEach(row => row.style.display = 'contents');
        toggleIcon.textContent = 'âŠ–';
        localStorage.removeItem(`dienstplan_group_${role}`);
      } else {
        // Collapse
        rows.forEach(row => row.style.display = 'none');
        toggleIcon.textContent = 'âŠ•';
        localStorage.setItem(`dienstplan_group_${role}`, 'collapsed');
      }
    }

    // Global verfÃ¼gbar machen
    window.toggleDienstplanGroup = toggleDienstplanGroup;

    // Show detailed view for a specific day
    function showDayDetail(dateKey) {
      const dayEntries = [];

      // Find all entries for this day
      dienstplanFiltered.forEach(entry => {
        const start = new Date(entry.start_date);
        const end = new Date(entry.end_date);

        // Check if this entry includes the selected date
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          if (d.toISOString().split('T')[0] === dateKey) {
            dayEntries.push(entry);
            break;
          }
        }
      });

      const date = new Date(dateKey);
      const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
      const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
      const dayName = dayNames[date.getDay()];
      const dayNumber = date.getDate();
      const monthName = monthNames[date.getMonth()];
      const year = date.getFullYear();

      // Sort entries by working start time
      dayEntries.sort((a, b) => {
        const timeA = a.working_start || '00:00';
        const timeB = b.working_start || '00:00';
        return timeA.localeCompare(timeB);
      });

      let modalHtml = `
        <div class="modal-overlay" onclick="closeDayDetailModal(event)" style="
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          padding: 20px;
        ">
          <div class="modal-content" onclick="event.stopPropagation()" style="
            background: var(--macos-elevated);
            backdrop-filter: var(--macos-blur-strong);
            -webkit-backdrop-filter: var(--macos-blur-strong);
            border: 1px solid var(--macos-stroke-primary);
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--macos-shadow-large);
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div>
                <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: var(--macos-text-primary);">
                  ${dayName}, ${dayNumber}. ${monthName} ${year}
                </h2>
                <p style="margin: 4px 0 0 0; font-size: 14px; color: var(--macos-text-secondary);">
                  ${dayEntries.length} ${dayEntries.length === 1 ? 'Eintrag' : 'EintrÃ¤ge'}
                </p>
              </div>
              <button onclick="closeDayDetailModal()" style="
                background: var(--macos-fill-tertiary);
                border: none;
                border-radius: 8px;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 20px;
                color: var(--macos-text-secondary);
                transition: all 0.2s ease;
              " onmouseover="this.style.background='var(--macos-fill-secondary)'" onmouseout="this.style.background='var(--macos-fill-tertiary)'">
                âœ•
              </button>
            </div>
      `;

      if (dayEntries.length === 0) {
        modalHtml += `
          <div style="text-align: center; padding: 40px 20px; color: var(--macos-text-secondary);">
            <p style="font-size: 16px;">Keine EintrÃ¤ge fÃ¼r diesen Tag</p>
          </div>
        `;
      } else {
        modalHtml += `<div style="display: flex; flex-direction: column; gap: 12px;">`;

        dayEntries.forEach(entry => {
          const artistName = entry.artist?.name || 'Unbekannt';
          const statusColor = entry.state === 'Available' ? 'var(--macos-accent-green)' :
                             entry.state === 'Vacation' ? 'var(--macos-accent-orange)' :
                             'var(--macos-accent-red)';
          const statusText = entry.state === 'Available' ? 'VerfÃ¼gbar' :
                            entry.state === 'Vacation' ? 'Urlaub' :
                            'Nicht verfÃ¼gbar';
          const workingHours = entry.working_start && entry.working_end
            ? `${entry.working_start.substring(0,5)} - ${entry.working_end.substring(0,5)}`
            : 'Keine Zeiten angegeben';
          const role = entry.role || 'Keine Rolle angegeben';

          modalHtml += `
            <div style="
              background: var(--macos-panel);
              border: 1px solid var(--macos-stroke-primary);
              border-left: 4px solid ${statusColor};
              border-radius: 10px;
              padding: 16px;
              transition: all 0.2s ease;
            " onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <div style="font-size: 16px; font-weight: 600; color: var(--macos-text-primary);">
                  ${artistName}
                </div>
                <div style="
                  background: ${statusColor}20;
                  color: ${statusColor};
                  padding: 4px 10px;
                  border-radius: 6px;
                  font-size: 12px;
                  font-weight: 600;
                ">
                  ${statusText}
                </div>
              </div>
              <div style="display: flex; flex-direction: column; gap: 6px; font-size: 14px;">
                <div style="display: flex; align-items: center; gap: 8px; color: var(--macos-text-secondary);">
                  <span style="font-weight: 500;">ðŸ•</span>
                  <span>${workingHours}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; color: var(--macos-text-secondary);">
                  <span style="font-weight: 500;">ðŸ’¼</span>
                  <span>${role}</span>
                </div>
                ${entry.note ? `
                  <div style="display: flex; align-items: start; gap: 8px; color: var(--macos-text-secondary); margin-top: 4px;">
                    <span style="font-weight: 500;">ðŸ“</span>
                    <span style="flex: 1;">${entry.note}</span>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        });

        modalHtml += `</div>`;
      }

      modalHtml += `
          </div>
        </div>
      `;

      // Create and show modal
      const modalContainer = document.createElement('div');
      modalContainer.id = 'dayDetailModal';
      modalContainer.innerHTML = modalHtml;
      document.body.appendChild(modalContainer);
    }

    // Close day detail modal
    function closeDayDetailModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('dayDetailModal');
      if (modal) {
        modal.remove();
      }
    }

    // ============================================
    // Dienstplan Add Slot: Kombinierte Artist + Profile Suche
    // ============================================

    // Globale Variable fÃ¼r ausgewÃ¤hlten Slot-User
    let selectedSlotArtist = null;
    let selectedSlotState = 'Available';

    // Modal Ã¶ffnen (mit optionalem Mode: 'normal' oder 'previous')
    function openAddSlotModal(mode = 'normal') {
      const modal = document.getElementById('addSlotModal');
      if (!modal) return;

      // Setze Mode im Modal
      modal.dataset.mode = mode;

      // Update Title basierend auf Mode
      const titleEl = modal.querySelector('h3');
      if (titleEl) {
        titleEl.textContent = mode === 'previous' ? 'Previous Guest Spot hinzufÃ¼gen' : 'Neuen Slot erstellen';
      }

      // Reset Form
      document.getElementById('slotArtistSearch').value = '';
      document.getElementById('slotArtistId').value = '';

      // Default Datum basierend auf Mode
      if (mode === 'previous') {
        // Previous Mode: Default letzte Woche
        const lastWeek = new Date();
        lastWeek.setDate(lastWeek.getDate() - 7);
        const lastWeekStr = lastWeek.toISOString().split('T')[0];
        document.getElementById('slotStartDate').value = lastWeekStr;
        document.getElementById('slotEndDate').value = lastWeekStr;
      } else {
        // Normal Mode: Erster Tag des aktuellen Monats
        document.getElementById('slotStartDate').value = formatDateKey(dienstplanCurrentYear, dienstplanCurrentMonth, 1);
        document.getElementById('slotEndDate').value = formatDateKey(dienstplanCurrentYear, dienstplanCurrentMonth, 1);
      }

      document.getElementById('slotStartTime').value = '10:00';
      document.getElementById('slotEndTime').value = '18:00';
      document.getElementById('slotArtistDropdown').style.display = 'none';
      selectedSlotArtist = null;
      selectedSlotState = 'Available';

      // State Buttons generieren
      renderStateButtons();

      modal.style.display = 'flex';
    }

    // Ã–ffne Modal im "Previous" Mode
    function openAddPreviousSpotModal() {
      openAddSlotModal('previous');
    }

    // State Buttons rendern
    function renderStateButtons() {
      const container = document.getElementById('slotStateGrid');
      if (!container) return;

      container.innerHTML = Object.entries(stateConfig).map(([state, config]) => `
        <button
          type="button"
          onclick="selectSlotState('${state}')"
          data-state="${state}"
          style="
            padding: 10px 8px;
            border: 2px solid ${selectedSlotState === state ? config.color : 'rgba(0,0,0,0.1)'};
            border-radius: 8px;
            background: ${selectedSlotState === state ? config.color + '15' : 'white'};
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
          "
        >
          <span style="color: ${config.color}; display: flex;">${config.icon}</span>
          <span style="font-size: 11px; font-weight: 500; color: #1d1d1f;">${config.label}</span>
        </button>
      `).join('');
    }

    // State auswÃ¤hlen
    function selectSlotState(state) {
      selectedSlotState = state;
      renderStateButtons();
    }

    // Kombinierte Suche: Artists + Profiles
    async function searchArtistsForSlot(query) {
      const dropdown = document.getElementById('slotArtistDropdown');
      if (!dropdown) return;

      if (query.length < 2) {
        dropdown.style.display = 'none';
        return;
      }

      try {
        // Parallel-Suche in beiden Tabellen
        const [artistsResult, profilesResult] = await Promise.all([
          // Suche Artists
          supabase
            .from('artists')
            .select('id, name, email, is_guest, rank, user_id')
            .ilike('name', `%${query}%`)
            .limit(8),

          // Suche Profiles (Team-Mitglieder)
          supabase
            .from('profiles')
            .select('id, username, email, role')
            .ilike('username', `%${query}%`)
            .limit(8)
        ]);

        const artistsList = artistsResult.data || [];
        const profiles = profilesResult.data || [];

        // Kombiniere Ergebnisse
        let html = '';

        // Artists Section
        if (artistsList.length > 0) {
          html += `
            <div style="padding: 8px 16px; font-size: 11px; font-weight: 600; color: #86868b; background: #f5f5f7; text-transform: uppercase; letter-spacing: 0.5px;">
              Artists
            </div>
          `;

          artistsList.forEach(artist => {
            const typeLabel = artist.is_guest ? 'Guest Artist' : 'Resident';
            html += `
              <div
                onclick="selectSlotArtist('${artist.id}', '${artist.name.replace(/'/g, "\\'")}', '${artist.email || ''}', '${typeLabel}', 'artist')"
                style="
                  padding: 12px 16px;
                  cursor: pointer;
                  border-bottom: 1px solid rgba(0,0,0,0.05);
                  transition: background 0.15s;
                "
                onmouseover="this.style.background='rgba(0,0,0,0.03)'"
                onmouseout="this.style.background='white'"
              >
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    background: ${artist.is_guest ? '#00C7BE' : '#34C759'};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 12px;
                    font-weight: 600;
                  ">${artist.name.charAt(0).toUpperCase()}</div>
                  <div>
                    <div style="font-weight: 500; font-size: 14px; color: #1d1d1f;">${artist.name}</div>
                    <div style="font-size: 12px; color: #86868b;">
                      ${typeLabel} ${artist.rank ? 'â€¢ ' + artist.rank : ''}
                    </div>
                  </div>
                </div>
              </div>
            `;
          });
        }

        // Profiles Section (Team-Mitglieder)
        if (profiles.length > 0) {
          html += `
            <div style="padding: 8px 16px; font-size: 11px; font-weight: 600; color: #86868b; background: #f5f5f7; text-transform: uppercase; letter-spacing: 0.5px;">
              Team-Mitglieder
            </div>
          `;

          profiles.forEach(profile => {
            // Rolle formatieren
            const roleLabel = profile.role || 'Team';
            const roleColors = {
              'GeschÃ¤ftsfÃ¼hrung': '#FFD60A',
              'Management': '#007AFF',
              'Booking Team': '#AF52DE',
              'Mediadepartment': '#FF9500',
              'Resident Artist': '#34C759',
              'Guest Artist': '#00C7BE'
            };
            const roleColor = roleColors[profile.role] || '#8E8E93';

            html += `
              <div
                onclick="selectSlotProfile('${profile.id}', '${profile.username.replace(/'/g, "\\'")}', '${profile.email || ''}', '${roleLabel}')"
                style="
                  padding: 12px 16px;
                  cursor: pointer;
                  border-bottom: 1px solid rgba(0,0,0,0.05);
                  transition: background 0.15s;
                "
                onmouseover="this.style.background='rgba(0,0,0,0.03)'"
                onmouseout="this.style.background='white'"
              >
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    background: ${roleColor};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 12px;
                    font-weight: 600;
                  ">${profile.username.charAt(0).toUpperCase()}</div>
                  <div>
                    <div style="font-weight: 500; font-size: 14px; color: #1d1d1f;">${profile.username}</div>
                    <div style="font-size: 12px; color: #86868b;">
                      <span style="
                        background: ${roleColor}20;
                        color: ${roleColor};
                        padding: 2px 6px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: 500;
                      ">${roleLabel}</span>
                    </div>
                  </div>
                </div>
              </div>
            `;
          });
        }

        // Keine Ergebnisse
        if (artistsList.length === 0 && profiles.length === 0) {
          html = `
            <div style="padding: 20px; text-align: center; color: #86868b; font-size: 14px;">
              Keine Ergebnisse fÃ¼r "${query}"
            </div>
          `;
        }

        dropdown.innerHTML = html;
        dropdown.style.display = 'block';

      } catch (err) {
        console.error('Error searching:', err);
        dropdown.innerHTML = `
          <div style="padding: 16px; text-align: center; color: #FF3B30; font-size: 14px;">
            Fehler bei der Suche
          </div>
        `;
        dropdown.style.display = 'block';
      }
    }

    // Profile (Team-Mitglied) auswÃ¤hlen
    async function selectSlotProfile(profileId, username, email, role) {
      // PrÃ¼fe ob es einen verknÃ¼pften Artist gibt
      const { data: linkedArtist, error } = await supabase
        .from('artists')
        .select('id, name')
        .eq('user_id', profileId)
        .single();

      if (linkedArtist) {
        // Artist-VerknÃ¼pfung existiert â†’ nutze artist_id
        selectedSlotArtist = {
          id: linkedArtist.id,
          name: username,
          email: email,
          role: role,
          type: 'profile_linked'
        };
        document.getElementById('slotArtistId').value = linkedArtist.id;
        console.log('Profile mit Artist verknÃ¼pft:', linkedArtist.name);
      } else {
        // Keine Artist-VerknÃ¼pfung â†’ speichere Profile-Daten direkt
        selectedSlotArtist = {
          id: null,  // Kein artist_id
          profileId: profileId,
          name: username,
          email: email,
          role: role,
          type: 'profile_only'
        };
        document.getElementById('slotArtistId').value = '';
        console.log('Profile ohne Artist-VerknÃ¼pfung:', username);
      }

      document.getElementById('slotArtistSearch').value = username;
      document.getElementById('slotArtistDropdown').style.display = 'none';
    }

    // Artist auswÃ¤hlen
    function selectSlotArtist(id, name, email, roleLabel, type) {
      selectedSlotArtist = {
        id: id,
        name: name,
        email: email,
        role: roleLabel,
        type: 'artist'
      };
      document.getElementById('slotArtistSearch').value = name;
      document.getElementById('slotArtistId').value = id;
      document.getElementById('slotArtistDropdown').style.display = 'none';
    }

    // Neuen Dienstplan-Slot speichern
    async function saveNewSlot() {
      const modal = document.getElementById('addSlotModal');
      const isPreviousMode = modal?.dataset?.mode === 'previous';

      const startDate = document.getElementById('slotStartDate').value;
      const endDate = document.getElementById('slotEndDate').value;
      const startTime = document.getElementById('slotStartTime').value;
      const endTime = document.getElementById('slotEndTime').value;

      // Validierung
      if (!selectedSlotArtist) {
        showNotification('Bitte wÃ¤hle einen Artist oder Team-Mitglied aus', 'error');
        return;
      }
      if (!startDate || !endDate) {
        showNotification('Bitte wÃ¤hle Start- und Enddatum aus', 'error');
        return;
      }
      if (startDate > endDate) {
        showNotification('Startdatum muss vor dem Enddatum liegen', 'error');
        return;
      }
      if (!selectedSlotState) {
        showNotification('Bitte wÃ¤hle einen Status aus', 'error');
        return;
      }

      const today = new Date().toISOString().split('T')[0];

      // Previous Mode: Validiere dass Enddatum in der Vergangenheit liegt
      if (isPreviousMode && endDate >= today) {
        showNotification('FÃ¼r Previous Spots muss das Enddatum in der Vergangenheit liegen', 'error');
        return;
      }

      try {
        let insertData = {
          start_date: startDate,
          end_date: endDate,
          working_start: startTime ? startTime + ':00' : null,
          working_end: endTime ? endTime + ':00' : null,
          state: selectedSlotState,
          email: selectedSlotArtist.email || null
        };

        if (selectedSlotArtist.type === 'artist' || selectedSlotArtist.type === 'profile_linked') {
          // Artist oder verknÃ¼pfter Profile-User
          insertData.artist_id = selectedSlotArtist.id;

          // Hole Artist-Details fÃ¼r role und location
          const { data: artist } = await supabase
            .from('artists')
            .select('location_id, is_guest, name, profile_picture_url')
            .eq('id', selectedSlotArtist.id)
            .single();

          insertData.role = artist?.is_guest ? 'Guest Artist' : 'Resident Artist';
          insertData.location_id = artist?.location_id || null;

          // FÃ¼r Previous Mode: auch in previous_guest_spots einfÃ¼gen
          if (isPreviousMode && artist?.is_guest) {
            // Hole Location-Details
            let locationName = null;
            let locationCity = null;
            if (artist.location_id) {
              const { data: loc } = await supabase
                .from('locations')
                .select('name, city')
                .eq('id', artist.location_id)
                .single();
              locationName = loc?.name || null;
              locationCity = loc?.city || null;
            }

            const previousInsert = {
              artist_name: artist.name || selectedSlotArtist.name,
              date_from: startDate,
              date_to: endDate,
              status: 'completed',
              location_id: artist.location_id || null,
              location_name: locationName,
              location_city: locationCity,
              profile_picture_url: artist.profile_picture_url || null
            };

            console.log('Inserting previous guest spot:', previousInsert);

            const { error: prevError } = await supabase
              .from('previous_guest_spots')
              .insert(previousInsert);

            if (prevError) {
              console.error('Error inserting previous guest spot:', prevError);
              // Nicht abbrechen, Dienstplan-Eintrag trotzdem erstellen
            }
          }

        } else if (selectedSlotArtist.type === 'profile_only') {
          // Profile ohne Artist-VerknÃ¼pfung
          // artist_id bleibt NULL, aber wir setzen die Rolle aus dem Profile
          insertData.artist_id = null;
          insertData.role = selectedSlotArtist.role || 'Management';
          insertData.location_id = null;
        }

        console.log('Inserting slot:', insertData);

        // Insert neuen Slot in Dienstplan
        const { data, error } = await supabase
          .from('dienstplan')
          .insert(insertData)
          .select()
          .single();

        if (error) throw error;

        console.log('Slot created:', data);
        showNotification(
          isPreviousMode
            ? `Previous Guest Spot fÃ¼r ${selectedSlotArtist.name} hinzugefÃ¼gt`
            : `Slot fÃ¼r ${selectedSlotArtist.name} erstellt`,
          'success'
        );

        // Modal schlieÃŸen
        closeAddSlotModal();

        // Daten neu laden
        await loadDienstplanData();

        // Bei Previous Mode auch Previous Guest Spots neu laden
        if (isPreviousMode && typeof loadPreviousGuestSpots === 'function') {
          await loadPreviousGuestSpots();
        }

      } catch (err) {
        console.error('Error creating slot:', err);
        showNotification('Fehler beim Erstellen: ' + err.message, 'error');
      }
    }

    // Add Slot Modal schlieÃŸen
    function closeAddSlotModal() {
      const modal = document.getElementById('addSlotModal');
      if (modal) {
        modal.style.display = 'none';
        // Reset Mode
        modal.dataset.mode = '';
        // Reset Title
        const titleEl = modal.querySelector('h3');
        if (titleEl) {
          titleEl.textContent = 'Neuen Slot erstellen';
        }
      }
      // Reset state
      selectedSlotArtist = null;
      selectedSlotState = 'Available';
    }

    // Click outside dropdown to close
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('slotArtistDropdown');
      const searchInput = document.getElementById('slotArtistSearch');

      if (dropdown && searchInput && !searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Global verfÃ¼gbar machen
    window.openAddSlotModal = openAddSlotModal;
    window.openAddPreviousSpotModal = openAddPreviousSpotModal;
    window.closeAddSlotModal = closeAddSlotModal;
    window.renderStateButtons = renderStateButtons;
    window.selectSlotState = selectSlotState;
    window.searchArtistsForSlot = searchArtistsForSlot;
    window.selectSlotProfile = selectSlotProfile;
    window.selectSlotArtist = selectSlotArtist;
    window.saveNewSlot = saveNewSlot;
    window.openAddWaitlistSlotModal = openAddWaitlistSlotModal;
    window.switchListType = switchListType;

    // Load Work Tracking Data from database with BATCH LOADING
    async function loadWorkTrackingData() {
      console.log('â° Loading Work Tracking data...');
      console.log('ðŸš¨ BATCH LOADING ALL WORK TRACKING DATA');

      try {
        // ðŸ”¥ BATCH LOADING: Load ALL work_tracking entries in batches of 1000
        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;
        let batchNumber = 1;

        while (hasMore) {
          console.log(`ðŸ“¦ Loading work_tracking batch ${batchNumber} (records ${from} to ${from + batchSize - 1})...`);

          const { data: batch, error } = await supabase
            .from('work_tracking')
            .select(`
              *,
              profile:profiles!user_id(
                username,
                email,
                role,
                avatar_url,
                weekly_hours,
                vacation_days
              ),
              location:locations!location_id(
                name,
                city
              )
            `)
            .order('date', { ascending: false })
            .range(from, from + batchSize - 1);

          if (error) {
            console.error('âŒ Error loading work_tracking batch:', error);
            return;
          }

          if (batch && batch.length > 0) {
            allData = allData.concat(batch);
            from += batchSize;
            hasMore = batch.length === batchSize;
            console.log(`  â†³ Loaded ${allData.length} work_tracking entries so far...`);
            batchNumber++;
          } else {
            hasMore = false;
          }
        }

        workTrackingCache = allData || [];
        console.log('âœ… Loaded', workTrackingCache.length, 'total work_tracking entries in', batchNumber - 1, 'batches');

        // Calculate stats (will filter by date range)
        calculateWorkTrackingStats();
      } catch (err) {
        console.error('âŒ Exception loading work tracking:', err);
      }
    }

    // Calculate Work Tracking Statistics
    function calculateWorkTrackingStats() {
      console.log('ðŸ“Š Calculating Work Tracking stats...');

      // Use global month variables
      const daysInMonth = new Date(dienstplanCurrentYear, dienstplanCurrentMonth + 1, 0).getDate();
      const startDateStr = `${dienstplanCurrentYear}-${String(dienstplanCurrentMonth + 1).padStart(2, '0')}-01`;
      const endDateStr = `${dienstplanCurrentYear}-${String(dienstplanCurrentMonth + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;

      // Filter by date range
      const filterStartDate = new Date(startDateStr);
      const filterEndDate = new Date(endDateStr);

      const filteredEntries = workTrackingCache.filter(entry => {
        if (!entry.date) return false;
        const entryDate = new Date(entry.date);
        return entryDate >= filterStartDate && entryDate <= filterEndDate;
      });

      console.log(`ðŸ“… Filtered work_tracking to month: ${filteredEntries.length} of ${workTrackingCache.length} entries`);

      // Group by user_email
      const userStats = {};

      filteredEntries.forEach(entry => {
        const email = entry.user_email || entry.profile?.email;
        if (!email) return;

        if (!userStats[email]) {
          userStats[email] = {
            username: entry.profile?.username || email.split('@')[0],
            email: email,
            role: entry.role || entry.profile?.role,
            weekly_hours: entry.profile?.weekly_hours || 40,
            vacation_days: entry.profile?.vacation_days || 30,
            total_hours_worked: 0,
            total_days_worked: 0,
            vacation_days_taken: 0,
            sick_days: 0,
            entries: []
          };
        }

        userStats[email].entries.push(entry);

        // Calculate hours
        if (entry.total_hours) {
          userStats[email].total_hours_worked += parseFloat(entry.total_hours);
        }

        // Count working days
        if (entry.status === 'working') {
          userStats[email].total_days_worked++;
        }

        // Count vacation and sick days
        if (entry.status === 'vacation') {
          userStats[email].vacation_days_taken++;
        }
        if (entry.status === 'sick') {
          userStats[email].sick_days++;
        }
      });

      workTrackingStats = userStats;
      console.log(`ðŸ“Š Calculated stats for ${Object.keys(userStats).length} users`);
      renderWorkTrackingTable();
    }

    // Render Work Tracking Table (Table 2)
    function renderWorkTrackingTable() {
      const container = document.getElementById('workTrackingTableContainer');
      if (!container) return;

      const users = Object.values(workTrackingStats);

      if (users.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #86868b;">
            <p style="font-size: 16px;">Keine Work Tracking Daten vorhanden</p>
          </div>
        `;
        return;
      }

      let html = `
        <div style="margin-top: 40px; padding-top: 40px; border-top: 2px solid rgba(0,0,0,0.05);">
          <h3 style="margin: 0 0 16px 0; font-size: 17px; font-weight: 600; color: #1d1d1f;">
            Work Tracking - Ãœbersicht
            <span style="color: #86868b; font-weight: 500; font-size: 15px; margin-left: 8px;">
              (${users.length} Mitarbeiter)
            </span>
          </h3>

          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 8px; overflow: hidden;">
              <thead>
                <tr style="background: rgba(0,0,0,0.02);">
                  <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1);">Rolle</th>
                  <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1);">Name</th>
                  <th style="padding: 12px; text-align: left; font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1);">Email</th>
                  <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1);">Wochenstunden (Soll)</th>
                  <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1);">Gearbeitete Stunden</th>
                  <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1);">Arbeitstage</th>
                  <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1);">Urlaubstage (verfÃ¼gbar)</th>
                  <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1);">Urlaub genommen</th>
                  <th style="padding: 12px; text-align: center; font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1);">Krankheitstage</th>
                </tr>
              </thead>
              <tbody>
      `;

      users.forEach((user, index) => {
        const remainingVacation = user.vacation_days - user.vacation_days_taken;
        const avgHoursPerDay = user.total_days_worked > 0
          ? (user.total_hours_worked / user.total_days_worked).toFixed(1)
          : '0';

        html += `
          <tr style="border-bottom: 1px solid rgba(0,0,0,0.05); ${index % 2 === 0 ? 'background: rgba(0,0,0,0.01);' : ''}">
            <td style="padding: 12px;">
              ${getRoleBadge(user.role)}
            </td>
            <td style="padding: 12px; font-weight: 500; color: #1d1d1f;">
              ${user.username}
            </td>
            <td style="padding: 12px; color: #86868b; font-size: 13px;">
              ${user.email}
            </td>
            <td style="padding: 12px; text-align: center; color: #1d1d1f; font-weight: 500;">
              ${user.weekly_hours}h / Woche
            </td>
            <td style="padding: 12px; text-align: center; color: #1d1d1f; font-weight: 600; font-size: 15px;">
              ${user.total_hours_worked.toFixed(1)}h
              <span style="color: #86868b; font-size: 12px; font-weight: 400; display: block; margin-top: 2px;">(Ã˜ ${avgHoursPerDay}h/Tag)</span>
            </td>
            <td style="padding: 12px; text-align: center; color: #1d1d1f; font-weight: 500;">
              ${user.total_days_worked} Tage
            </td>
            <td style="padding: 12px; text-align: center; color: #34C759; font-weight: 600;">
              ${remainingVacation} / ${user.vacation_days}
            </td>
            <td style="padding: 12px; text-align: center; color: #FF9500; font-weight: 500;">
              ${user.vacation_days_taken} Tage
            </td>
            <td style="padding: 12px; text-align: center; color: #FF3B30; font-weight: 500;">
              ${user.sick_days} Tage
            </td>
          </tr>
        `;
      });

      html += `
              </tbody>
            </table>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // Switch Calendar View (Appointments / Work Tracking)
    function switchCalendarView(view) {
      const tabAppointments = document.getElementById('calendarTabAppointments');
      const tabWorkTracking = document.getElementById('calendarTabWorkTracking');
      const appointmentsView = document.getElementById('calendarAppointmentsView');
      const workTrackingView = document.getElementById('calendarWorkTrackingView');

      if (!tabAppointments || !tabWorkTracking || !appointmentsView || !workTrackingView) return;

      // Update active tab
      tabAppointments.style.borderBottom =
        view === 'appointments' ? '2px solid #007AFF' : '2px solid transparent';
      tabWorkTracking.style.borderBottom =
        view === 'worktracking' ? '2px solid #007AFF' : '2px solid transparent';

      if (view === 'appointments') {
        appointmentsView.style.display = 'block';
        workTrackingView.style.display = 'none';
      } else {
        appointmentsView.style.display = 'none';
        workTrackingView.style.display = 'block';
        loadCalendarWorkTracking();
      }
    }

    // Load Work Tracking for Calendar View
    async function loadCalendarWorkTracking() {
      const container = document.getElementById('calendarWorkTrackingContainer');
      if (!container) return;

      // Show loading state
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #86868b;">
          <p style="font-size: 16px;">Lade Work Tracking Daten...</p>
        </div>
      `;

      // Initialize month selectors if needed
      initDienstplanMonthSelectors();

      await loadWorkTrackingData();

      // Copy content from dienstplan work tracking container
      const sourceContainer = document.getElementById('workTrackingTableContainer');
      if (sourceContainer) {
        container.innerHTML = sourceContainer.innerHTML;
      }
    }

    // Initialize Dienstplan when tab is opened
    function initializeDienstplan() {
      console.log('ðŸ“… initializeDienstplan() - Current month:', dienstplanCurrentMonth, 'Year:', dienstplanCurrentYear);

      // Always initialize month selectors when tab is opened
      initDienstplanMonthSelectors();

      if (dienstplanCache.length === 0) {
        // First time: Load data from CentralDataManager
        loadDienstplanData();
      } else {
        // Cache already populated: Just apply filters with current month
        console.log('ðŸ“… Using existing cache:', dienstplanCache.length, 'entries');
        applyDienstplanFilters();
      }
    }

    // ============================================
    // DIENSTPLAN SLOT POPUPS
    // ============================================

    const slotTypeConfig = {
      'Available': {
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
        label: 'Available',
        color: '#34C759'
      },
      'Vacation': {
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/><path d="M14.05 2a9 9 0 0 1 8 7.94"/><path d="M14.05 6A5 5 0 0 1 18 10"/></svg>',
        label: 'Vacation',
        color: '#007AFF'
      },
      'Business Trip': {
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
        label: 'Business Trip',
        color: '#5856D6'
      },
      'Other': {
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
        label: 'Other',
        color: '#8E8E93'
      },
      'Guestspot': {
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>',
        label: 'Guestspot',
        color: '#FF9500'
      },
      'Sick': {
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
        label: 'Sick',
        color: '#FF3B30'
      },
      'Training': {
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
        label: 'Training',
        color: '#00C7BE'
      },
      'Convention': {
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
        label: 'Convention',
        color: '#FF2D55'
      },
      'Home office': {
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
        label: 'Home Office',
        color: '#AF52DE'
      }
    };

    function openSlotViewPopup(slotData) {
      // slotData enthÃ¤lt: id, artist_name, start_date, end_date, start_time, end_time, type, slot_ids (Array fÃ¼r zusammengefasste)

      const existingPopup = document.getElementById('slotViewPopup');
      if (existingPopup) existingPopup.remove();

      const typeInfo = slotTypeConfig[slotData.type] || slotTypeConfig['Other'] || { icon: 'â—‹', label: slotData.type || 'Other', color: '#8E8E93' };

      const startDate = new Date(slotData.start_date);
      const endDate = new Date(slotData.end_date);
      const dateRange = startDate.toLocaleDateString('de-DE') +
        (slotData.start_date !== slotData.end_date ? ' - ' + endDate.toLocaleDateString('de-DE') : '');

      const slotDataStr = JSON.stringify(slotData).replace(/"/g, '&quot;');

      const popup = document.createElement('div');
      popup.id = 'slotViewPopup';
      popup.className = 'slot-popup-overlay';
      popup.innerHTML = `
        <div class="slot-popup">
          <div class="slot-popup-header">
            <h3 class="slot-popup-title">Slot Details</h3>
            <button class="slot-popup-close" onclick="closeSlotViewPopup()">âœ•</button>
          </div>
          <div class="slot-popup-body">
            <div class="slot-popup-field">
              <label class="slot-popup-label">Artist / Mitarbeiter</label>
              <p class="slot-popup-value">${slotData.artist_name || 'Unbekannt'}</p>
            </div>
            <div class="slot-popup-field">
              <label class="slot-popup-label">Datum</label>
              <p class="slot-popup-value">${dateRange}</p>
            </div>
            <div class="slot-popup-field">
              <label class="slot-popup-label">Zeit</label>
              <p class="slot-popup-value">${slotData.start_time || '10:00'} - ${slotData.end_time || '18:00'}</p>
            </div>
            <div class="slot-popup-field">
              <label class="slot-popup-label">Status / Typ</label>
              <p class="slot-popup-value" style="display: flex; align-items: center; gap: 8px;">
                <span style="display: inline-flex; align-items: center; color: ${typeInfo.color};">${typeInfo.icon}</span>
                <span>${typeInfo.label}</span>
              </p>
            </div>
          </div>
          <div class="slot-popup-actions">
            <button class="slot-popup-btn edit" onclick="openSlotEditPopup(${slotDataStr})">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
              Bearbeiten
            </button>
            <button class="slot-popup-btn delete" onclick="deleteSlot(${JSON.stringify(slotData.slot_ids || [slotData.id])})">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
              LÃ¶schen
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(popup);

      popup.addEventListener('click', (e) => {
        if (e.target === popup) closeSlotViewPopup();
      });

      document.addEventListener('keydown', handleSlotViewEscape);
    }

    function handleSlotViewEscape(e) {
      if (e.key === 'Escape') closeSlotViewPopup();
    }

    function closeSlotViewPopup() {
      const popup = document.getElementById('slotViewPopup');
      if (popup) popup.remove();
      document.removeEventListener('keydown', handleSlotViewEscape);
    }

    // ============================================
    // SLOT EDIT POPUP
    // ============================================

    function openSlotEditPopup(slotData) {
      closeSlotViewPopup();

      const existingPopup = document.getElementById('slotEditPopup');
      if (existingPopup) existingPopup.remove();

      const typeOptions = Object.entries(slotTypeConfig).map(([key, val]) => `
        <div class="slot-type-option ${slotData.type === key ? 'selected' : ''}"
             data-type="${key}"
             onclick="selectSlotType('${key}')">
          <span class="type-icon" style="color: ${val.color};">${val.icon}</span>
          <span class="type-label">${val.label}</span>
        </div>
      `).join('');

      const popup = document.createElement('div');
      popup.id = 'slotEditPopup';
      popup.className = 'slot-popup-overlay';
      popup.innerHTML = `
        <div class="slot-popup">
          <div class="slot-popup-header">
            <h3 class="slot-popup-title">Slot bearbeiten</h3>
            <button class="slot-popup-close" onclick="closeSlotEditPopup()">âœ•</button>
          </div>
          <div class="slot-popup-body">
            <div class="slot-popup-field">
              <label class="slot-popup-label">Artist / Mitarbeiter</label>
              <p class="slot-popup-value">${slotData.artist_name || 'Unbekannt'}</p>
              <input type="hidden" id="editSlotArtistId" value="${slotData.artist_id || ''}">
            </div>
            <div class="slot-popup-field">
              <label class="slot-popup-label">Start Datum *</label>
              <input type="date" class="slot-popup-input" id="editSlotStartDate" value="${slotData.start_date}">
            </div>
            <div class="slot-popup-field">
              <label class="slot-popup-label">End Datum *</label>
              <input type="date" class="slot-popup-input" id="editSlotEndDate" value="${slotData.end_date}">
            </div>
            <div class="slot-popup-row">
              <div class="slot-popup-field">
                <label class="slot-popup-label">Start Zeit</label>
                <input type="time" class="slot-popup-input" id="editSlotStartTime" value="${slotData.start_time || '10:00'}">
              </div>
              <div class="slot-popup-field">
                <label class="slot-popup-label">End Zeit</label>
                <input type="time" class="slot-popup-input" id="editSlotEndTime" value="${slotData.end_time || '18:00'}">
              </div>
            </div>
            <div class="slot-popup-field">
              <label class="slot-popup-label">Status / Typ *</label>
              <div class="slot-type-grid" id="editSlotTypeGrid">
                ${typeOptions}
              </div>
              <input type="hidden" id="editSlotType" value="${slotData.type}">
            </div>
          </div>
          <div class="slot-popup-actions">
            <button class="slot-popup-btn cancel" onclick="closeSlotEditPopup()">Abbrechen</button>
            <button class="slot-popup-btn save" onclick="saveSlotEdit(${JSON.stringify(slotData.slot_ids || [slotData.id])})">
              Speichern
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(popup);
      document.addEventListener('keydown', handleSlotEditEscape);
    }

    function handleSlotEditEscape(e) {
      if (e.key === 'Escape') closeSlotEditPopup();
    }

    function closeSlotEditPopup() {
      const popup = document.getElementById('slotEditPopup');
      if (popup) popup.remove();
      document.removeEventListener('keydown', handleSlotEditEscape);
    }

    function selectSlotType(type) {
      document.querySelectorAll('.slot-type-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.type === type);
      });
      document.getElementById('editSlotType').value = type;
    }

    async function saveSlotEdit(slotIds) {
      const startDate = document.getElementById('editSlotStartDate').value;
      const endDate = document.getElementById('editSlotEndDate').value;
      const startTime = document.getElementById('editSlotStartTime').value;
      const endTime = document.getElementById('editSlotEndTime').value;
      const type = document.getElementById('editSlotType').value;

      if (!startDate || !endDate || !type) {
        alert('Bitte alle Pflichtfelder ausfÃ¼llen');
        return;
      }

      try {
        // LÃ¶sche alte EintrÃ¤ge
        for (const id of slotIds) {
          await supabase.from('dienstplan').delete().eq('id', id);
        }

        // Erstelle neue EintrÃ¤ge fÃ¼r jeden Tag im Bereich
        const artistId = document.getElementById('editSlotArtistId').value;
        const start = new Date(startDate);
        const end = new Date(endDate);

        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const dateStr = d.toISOString().split('T')[0];
          await supabase.from('dienstplan').insert({
            artist_id: artistId,
            date: dateStr,
            start_time: startTime,
            end_time: endTime,
            status: type
          });
        }

        console.log('âœ… Slot(s) updated');
        closeSlotEditPopup();

        // Refresh Dienstplan
        if (typeof loadDienstplanData === 'function') {
          await loadDienstplanData();
        }
      } catch (err) {
        console.error('âŒ Error saving slot:', err);
        alert('Fehler beim Speichern');
      }
    }

    async function deleteSlot(slotIds) {
      if (!confirm(`${slotIds.length} Eintrag/EintrÃ¤ge wirklich lÃ¶schen?`)) return;

      try {
        for (const id of slotIds) {
          await supabase.from('dienstplan').delete().eq('id', id);
        }

        console.log('âœ… Slot(s) deleted');
        closeSlotViewPopup();

        // Refresh Dienstplan
        if (typeof loadDienstplanData === 'function') {
          await loadDienstplanData();
        }
      } catch (err) {
        console.error('âŒ Error deleting slot:', err);
        alert('Fehler beim LÃ¶schen');
      }
    }

    // Dienstplan Monat im Header aktualisieren
    function updateDienstplanHeaderMonth() {
      const headerSpan = document.getElementById('dienstplanCurrentMonth');

      if (headerSpan) {
        const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni',
                            'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];

        let month, year;

        if (typeof dienstplanCurrentMonth !== 'undefined' && typeof dienstplanCurrentYear !== 'undefined') {
          month = monthNames[dienstplanCurrentMonth];
          year = dienstplanCurrentYear;
        } else {
          // Fallback: aktueller Monat
          const now = new Date();
          month = monthNames[now.getMonth()];
          year = now.getFullYear();
        }

        headerSpan.textContent = `${month} ${year}`;
      }
    }

    window.openSlotViewPopup = openSlotViewPopup;
    window.closeSlotViewPopup = closeSlotViewPopup;
    window.openSlotEditPopup = openSlotEditPopup;
    window.closeSlotEditPopup = closeSlotEditPopup;
    window.selectSlotType = selectSlotType;
    window.saveSlotEdit = saveSlotEdit;
    window.deleteSlot = deleteSlot;
    window.updateDienstplanHeaderMonth = updateDienstplanHeaderMonth;
    window.slotTypeConfig = slotTypeConfig;

    // Make functions globally available
    window.loadDienstplanData = loadDienstplanData;
    window.applyDienstplanFilters = applyDienstplanFilters;
    window.switchCalendarView = switchCalendarView;
    window.initializeDienstplan = initializeDienstplan;
  </script>

  <!-- Login Modal -->
  <div class="login-backdrop" id="loginBackdrop">
    <div class="login-modal" id="loginModalContent">
      <!-- Login Form View -->
      <div id="loginFormView">
        <div class="login-welcome">
          <h2>Willkommen zurÃ¼ck!</h2>
          <p>Bitte melde dich an, um fortzufahren</p>
        </div>
        <form class="login-form" id="loginForm">
          <div class="form-group">
            <label for="loginUsername">Benutzername</label>
            <input type="text" id="loginUsername" autocomplete="username" required>
          </div>
          <div class="form-group">
            <label for="loginPassword">Passwort</label>
            <input type="password" id="loginPassword" autocomplete="current-password" required>
          </div>
          <div class="login-remember">
            <input type="checkbox" id="rememberMe">
            <label for="rememberMe">Angemeldet bleiben</label>
          </div>
          <div class="login-actions">
            <button type="submit" class="btn btn-primary" style="width: 100%; background:#1d1d1f; color:white !important;">Anmelden</button>
          </div>
        </form>
      </div>

      <!-- Profile View -->
      <div id="profileView" class="profile-view" style="display: none;">
        <div class="profile-header">
          <img id="profileAvatarLarge" class="profile-avatar-large" src="" alt="Profilbild">
          <h2 id="profileName" style="margin: 0; font-size: 22px;">Username</h2>
        </div>

        <div class="profile-info-group">
          <label>Benutzername</label>
          <div class="profile-info-value" id="profileUsernameValue">â€”</div>
        </div>

        <div class="profile-info-group">
          <label>Passwort</label>
          <div class="password-toggle">
            <div class="profile-info-value" id="profilePasswordValue">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</div>
            <button type="button" onclick="togglePassword()">Anzeigen</button>
          </div>
          <button type="button" class="btn btn-secondary" onclick="showPasswordChangeForm()" style="width: 100%; margin-top: 8px;">Passwort Ã¤ndern</button>
        </div>

        <div id="passwordChangeForm" class="profile-info-group" style="display: none;">
          <label>Neues Passwort</label>
          <input type="password" id="newPassword" placeholder="Neues Passwort" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <input type="password" id="confirmPassword" placeholder="Passwort bestÃ¤tigen" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <div style="display: flex; gap: 8px;">
            <button type="button" class="btn btn-primary" onclick="changePassword()" style="flex: 1;">Speichern</button>
            <button type="button" class="btn btn-secondary" onclick="hidePasswordChangeForm()" style="flex: 1;">Abbrechen</button>
          </div>
        </div>

        <div class="profile-info-group">
          <label>Rolle</label>
          <div>
            <span class="profile-role-badge" id="profileRoleValue">USER</span>
          </div>
        </div>

        <div class="profile-info-group">
          <label>Profilbild</label>
          <button type="button" class="btn btn-primary" onclick="openAvatarUploadModal()" style="width: 100%;">Profilbild editieren</button>
        </div>

        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #eee; display: flex; gap: 12px;">
          <button type="button" class="btn btn-secondary" onclick="closeLoginModal()" style="flex: 1;">SchlieÃŸen</button>
          <button type="button" class="btn btn-danger" onclick="logout()" style="flex: 1;">Abmelden</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Avatar Upload Modal -->
  <div class="modal-backdrop" id="avatarUploadModal">
    <div class="modal" style="max-width: 500px;">
      <h3 style="color:var(--ink); font-weight:500; margin-bottom:20px;">Profilbild editieren</h3>

      <!-- Current Avatar Preview -->
      <div id="currentAvatarPreview" style="text-align:center; margin-bottom:24px;">
        <img id="currentAvatarImg" src="" alt="Aktuelles Profilbild" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:3px solid #f5f5f7;">
      </div>

      <!-- Drag & Drop Zone -->
      <div
        id="avatarDropZone"
        style="border:2px dashed #d1d5db; border-radius:12px; padding:40px 20px; text-align:center; background:#f9fafb; cursor:pointer; transition:all 0.3s; margin-bottom:20px;"
        ondragover="handleDragOver(event)"
        ondragleave="handleDragLeave(event)"
        ondrop="handleDrop(event)"
        onclick="document.getElementById('avatarFileInput').click()">
        <div style="font-size:48px; margin-bottom:12px;">ðŸ“¸</div>
        <div style="font-size:16px; font-weight:500; color:var(--ink); margin-bottom:8px;">
          Bild hier ablegen oder klicken
        </div>
        <div style="font-size:13px; color:var(--muted);">
          PNG, JPG oder GIF (max. 5MB)
        </div>
      </div>

      <!-- Hidden File Input -->
      <input
        type="file"
        id="avatarFileInput"
        accept="image/*"
        style="display:none;"
        onchange="handleFileSelect(event)">

      <!-- Preview Selected Image -->
      <div id="avatarPreviewContainer" style="display:none; margin-bottom:20px; text-align:center;">
        <div style="font-size:14px; font-weight:500; color:var(--ink); margin-bottom:12px;">Vorschau:</div>
        <img id="avatarPreview" src="" alt="Vorschau" style="width:150px; height:150px; border-radius:50%; object-fit:cover; border:3px solid var(--accent);">
        <div id="avatarFileName" style="font-size:13px; color:var(--muted); margin-top:8px;"></div>
      </div>

      <!-- Upload Progress -->
      <div id="uploadProgress" style="display:none; margin-bottom:20px;">
        <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">Uploading...</div>
        <div style="background:#e5e7eb; border-radius:999px; height:8px; overflow:hidden;">
          <div id="uploadProgressBar" style="background:var(--accent); height:100%; width:0%; transition:width 0.3s;"></div>
        </div>
      </div>

      <div class="modal-actions" style="gap:8px;">
        <button type="button" class="btn btn-secondary" onclick="closeAvatarUploadModal()" style="background:#f5f5f7; color:var(--ink); border:1px solid rgba(0,0,0,0.1); flex:1;">Abbrechen</button>
        <button type="button" class="btn" id="uploadAvatarBtn" onclick="uploadAvatarFromModal()" disabled style="background:var(--ink); color:white; border:none; flex:1; opacity:0.5;">Hochladen</button>
      </div>
    </div>
  </div>

  <!-- ========================================
       PAYMENT WORKFLOW MODAL
       ======================================== -->
  <div class="modal-backdrop" id="paymentWorkflowModal" style="display:none;">
    <div class="modal" style="max-width:900px; max-height:90vh; overflow-y:auto;">

      <!-- Header -->
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid rgba(0,0,0,0.1);">
        <h3 style="color:var(--macos-text-primary); font-weight:600; margin:0; font-size:20px;">
          ðŸ’³ Zahlungsabwicklung
        </h3>
        <button onclick="closePaymentWorkflowModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--macos-text-secondary); padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:6px; transition:all 0.2s;">
          Ã—
        </button>
      </div>

      <!-- SECTION 1: Customer Info Summary -->
      <div style="background:rgba(255,255,255,0.9); backdrop-filter:saturate(180%) blur(20px); padding:20px; border-radius:12px; margin-bottom:16px; border:1px solid rgba(0,0,0,0.08);">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
          <span style="font-size:20px;">ðŸ‘¤</span>
          <h4 style="font-size:15px; font-weight:600; margin:0; color:var(--macos-text-primary);">Kundeninformationen</h4>
        </div>
        <div id="paymentCustomerSummary" style="font-size:13px; line-height:1.6;"></div>
      </div>

      <!-- SECTION 2: Tattoo Details Summary -->
      <div style="background:rgba(255,255,255,0.9); backdrop-filter:saturate(180%) blur(20px); padding:20px; border-radius:12px; margin-bottom:16px; border:1px solid rgba(0,0,0,0.08);">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
          <span style="font-size:20px;">ðŸŽ¨</span>
          <h4 style="font-size:15px; font-weight:600; margin:0; color:var(--macos-text-primary);">Tattoo Details</h4>
        </div>
        <div id="paymentTattooSummary" style="font-size:13px; line-height:1.6;"></div>
      </div>

      <!-- SECTION 3: Appointment Details -->
      <div style="background:rgba(255,255,255,0.9); backdrop-filter:saturate(180%) blur(20px); padding:20px; border-radius:12px; margin-bottom:16px; border:1px solid rgba(0,0,0,0.08);">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
          <span style="font-size:20px;">ðŸ“…</span>
          <h4 style="font-size:15px; font-weight:600; margin:0; color:var(--macos-text-primary);">Termindetails</h4>
        </div>
        <div id="paymentAppointmentSummary" style="font-size:13px; line-height:1.6;"></div>
      </div>

      <!-- SECTION 4: Price Input -->
      <div style="background:linear-gradient(135deg, rgba(0,113,227,0.05), rgba(0,113,227,0.12)); backdrop-filter:saturate(180%) blur(20px); padding:24px; border-radius:12px; margin-bottom:16px; border:2px solid rgba(0,113,227,0.3);">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:16px;">
          <span style="font-size:20px;">ðŸ’¶</span>
          <h4 style="font-size:15px; font-weight:600; margin:0; color:var(--macos-accent-blue);">Preisgestaltung</h4>
        </div>

        <div class="form-group" style="margin-bottom:0;">
          <label style="font-size:13px; font-weight:600; color:var(--macos-text-primary); display:block; margin-bottom:8px;">
            Gesamtpreis (EUR)
          </label>
          <input type="number"
                 id="paymentTotalPrice"
                 placeholder="z.B. 500.00"
                 step="0.01"
                 min="0"
                 style="width:100%; padding:14px 16px; border:1px solid rgba(0,0,0,0.15); border-radius:10px; font-size:17px; font-weight:600; background:white; transition:all 0.2s;"
                 onfocus="this.style.borderColor='var(--macos-accent-blue)'; this.style.boxShadow='0 0 0 3px rgba(0,113,227,0.1)';"
                 onblur="this.style.borderColor='rgba(0,0,0,0.15)'; this.style.boxShadow='none';">
        </div>

        <div id="paymentDepositDisplay" style="margin-top:20px; padding:16px; background:rgba(255,255,255,0.95); border-radius:10px; display:none; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span style="font-size:14px; color:var(--macos-text-secondary);">Gesamtpreis:</span>
            <span id="displayTotalPrice" style="font-size:16px; font-weight:600; color:var(--macos-text-primary);">â‚¬0.00</span>
          </div>
          <div style="height:1px; background:rgba(0,0,0,0.08); margin:10px 0;"></div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:14px; color:var(--macos-text-secondary);">Terminkaution (50%):</span>
            <span id="displayDepositPrice" style="font-size:18px; font-weight:700; color:var(--macos-accent-green);">â‚¬0.00</span>
          </div>
        </div>
      </div>

      <!-- SECTION 5: Confirmation Checkbox -->
      <div style="margin-bottom:24px; padding:20px; background:rgba(255,159,10,0.08); border-radius:10px; border-left:4px solid var(--macos-accent-orange);">
        <label style="display:flex; align-items:start; cursor:pointer; user-select:none;">
          <input type="checkbox"
                 id="paymentConfirmCheckbox"
                 style="margin-right:12px; margin-top:3px; width:20px; height:20px; cursor:pointer; accent-color:var(--macos-accent-orange);">
          <span style="font-size:13px; line-height:1.6;">
            <strong style="display:block; margin-bottom:4px; color:var(--macos-text-primary);">
              Ich bestÃ¤tige, dass alle Kundeninformationen, Tattoo-Details und der Termin korrekt sind.
            </strong>
            <span style="color:var(--macos-text-secondary);">
              Nach dem Absenden wird automatisch ein Stripe Payment Link generiert und eine BestÃ¤tigungsmail an den Kunden versendet.
            </span>
          </span>
        </label>
      </div>

      <!-- SECTION 6: Action Buttons -->
      <div class="modal-actions" style="display:flex; gap:12px; margin-top:24px;">
        <button type="button"
                class="btn btn-secondary"
                onclick="closePaymentWorkflowModal()"
                style="flex:1; background:var(--macos-fill-primary); color:var(--macos-text-primary); border:1px solid var(--macos-stroke-primary); padding:12px; border-radius:10px; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s;"
                onmouseover="this.style.background='var(--macos-fill-secondary)';"
                onmouseout="this.style.background='var(--macos-fill-primary)';">
          Abbrechen
        </button>
        <button type="button"
                id="sendPaymentLinkBtn"
                onclick="executePaymentWorkflow()"
                disabled
                style="flex:2; background:var(--macos-accent-green); color:white; padding:12px 32px; border-radius:10px; font-weight:600; border:none; cursor:not-allowed; opacity:0.5; font-size:14px; transition:all 0.2s;">
          ðŸ“§ Zahlungslink versenden
        </button>
      </div>

      <!-- Loading State Overlay -->
      <div id="paymentWorkflowLoading" style="display:none; position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.95); backdrop-filter:saturate(180%) blur(20px); border-radius:16px; flex-direction:column; align-items:center; justify-content:center; z-index:10;">
        <div style="font-size:48px; margin-bottom:16px; animation:spin 2s linear infinite;">â³</div>
        <div style="font-size:16px; font-weight:600; color:var(--macos-text-primary); margin-bottom:8px;">Zahlungslink wird erstellt...</div>
        <div style="font-size:13px; color:var(--macos-text-secondary);">Email wird an Kunden versendet</div>
      </div>

    </div>
  </div>

  <style>
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  </style>

  <script>
    // ==========================================
    // MOBILE NAV HANDLER - GLOBAL FUNCTION
    // ==========================================
    function handleMobileNav(viewName, element) {
      console.log('ðŸ“± Mobile nav clicked:', viewName);

      // Visual feedback
      element.style.transform = 'scale(0.95)';
      setTimeout(() => element.style.transform = '', 150);

      // Update active states
      document.querySelectorAll('.mobile-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      element.classList.add('active');

      // Route to correct view using helper functions
      if (viewName === 'dashboard') {
        if (typeof showMobileDashboard === 'function') {
          showMobileDashboard();
        } else {
          // Fallback: show dashboard section
          document.querySelectorAll('section[id$="-section"]').forEach(s => {
            s.style.display = 'none';
            s.classList.remove('active');
          });
          const dashboard = document.getElementById('dashboard-section');
          if (dashboard) {
            dashboard.style.display = 'block';
            dashboard.classList.add('active');
          }
        }
      } else if (viewName === 'calendar') {
        if (typeof showMobileCalendar === 'function') {
          showMobileCalendar();
        }
      } else if (viewName === 'dienstplan') {
        if (typeof showMobileDienstplan === 'function') {
          showMobileDienstplan();
        }
      }

      // Update desktop nav too
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
      const navLink = document.querySelector(`.nav-link[data-view="${viewName}"]`);
      if (navLink) navLink.classList.add('active');

      console.log('âœ… Switched to:', viewName);
    }

    // Make it globally available
    window.handleMobileNav = handleMobileNav;

    // ============================================
    // AUTH & PROFILE SYSTEM
    // ============================================

    let currentUser = null;
    let currentUserArtistId = null; // Artist ID fÃ¼r den aktuellen User (via Email-Matching)

    // ============================================
    // ARTIST USER RESTRICTIONS
    // ============================================
    const ARTIST_USERNAMES = ['Gil', 'Ata', 'Ben', 'Nele', 'Silas', 'Luka', 'Mary'];

    /**
     * PrÃ¼ft ob der aktuelle User ein Artist-User ist
     */
    function isArtistUser() {
      if (!currentUser || !currentUser.username) return false;
      return ARTIST_USERNAMES.some(name =>
        name.toLowerCase() === currentUser.username.toLowerCase()
      );
    }

    /**
     * LÃ¤dt die Artist-ID fÃ¼r den aktuellen User
     * Verbindung: profiles.email = artists.email (Matching Ã¼ber E-Mail)
     */
    async function loadCurrentUserArtistId() {
      if (!currentUser || !currentUser.email) {
        currentUserArtistId = null;
        return;
      }

      try {
        // Finde Artist mit gleicher E-Mail wie der eingeloggte User
        const { data: artist, error } = await supabase
          .from('artists')
          .select('id, name, email')
          .eq('email', currentUser.email)  // profiles.email = artists.email
          .single();

        if (error || !artist) {
          console.log('â„¹ï¸ No artist record for email:', currentUser.email);
          currentUserArtistId = null;
          return;
        }

        currentUserArtistId = artist.id;
        console.log('ðŸŽ¨ Artist found for user:', currentUser.username, 'â†’', artist.name, '(ID:', artist.id, ')');
      } catch (err) {
        console.error('Error loading artist ID:', err);
        currentUserArtistId = null;
      }
    }

    /**
     * Wendet AnsichtsbeschrÃ¤nkungen fÃ¼r Artist-User an
     */
    function applyArtistUserRestrictions() {
      if (!isArtistUser()) {
        // Nicht-Artist-User: Alle Tabs anzeigen
        showAllNavigationTabs();
        return;
      }

      console.log('ðŸŽ¨ Artist User detected:', currentUser.username, '- Applying view restrictions');

      // Tabs die Artist-User sehen dÃ¼rfen
      const allowedTabs = ['dashboard', 'calendar', 'dienstplan'];

      // Alle Navigation Tabs durchgehen
      const allTabs = document.querySelectorAll('nav a[id^="tab-"]');
      allTabs.forEach(tab => {
        const tabName = tab.id.replace('tab-', '');
        if (allowedTabs.includes(tabName)) {
          tab.style.display = ''; // Anzeigen
        } else {
          tab.style.display = 'none'; // Verstecken
        }
      });
    }

    /**
     * Zeigt alle Navigation Tabs (fÃ¼r normale User)
     */
    function showAllNavigationTabs() {
      const allTabs = document.querySelectorAll('nav a[id^="tab-"]');
      allTabs.forEach(tab => {
        tab.style.display = ''; // Alle anzeigen
      });
    }

    // Global verfÃ¼gbar machen
    window.isArtistUser = isArtistUser;
    window.applyArtistUserRestrictions = applyArtistUserRestrictions;
    window.loadCurrentUserArtistId = loadCurrentUserArtistId;

    // Check for saved session on page load
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DISABLED - Login wird jetzt vom LoadingScreen gehandelt
    // Die Session-PrÃ¼fung macht jetzt CentralDataManager.checkSavedSession()
    // Das alte Login-Modal (loginBackdrop) wird nicht mehr benÃ¶tigt
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function initAuth() {
      console.log('ðŸ” initAuth() - Skipped (handled by LoadingScreen)');
      return;
    }

    // Test Database Connection (for debugging)
    async function testDatabaseConnection() {
      console.log('ðŸ§ª Testing database connection to profiles table...');

      try {
        // Test 1: Select all profiles
        const { data: allProfiles, error: error1 } = await supabase
          .from('profiles')
          .select('*');

        console.log('âœ… Test 1 - All profiles:', allProfiles);
        console.log('âŒ Error 1:', error1);

        // Test 2: Select specific username
        const { data: fayProfile, error: error2 } = await supabase
          .from('profiles')
          .select('*')
          .eq('username', 'Fay');

        console.log('âœ… Test 2 - Fay (exact match):', fayProfile);
        console.log('âŒ Error 2:', error2);

        // Test 3: Select with ilike
        const { data: fayProfileIlike, error: error3 } = await supabase
          .from('profiles')
          .select('*')
          .ilike('username', 'Fay');

        console.log('âœ… Test 3 - Fay (ilike):', fayProfileIlike);
        console.log('âŒ Error 3:', error3);

        // Display results
        let message = 'ðŸ“Š Database Test Results:\n\n';
        message += `Total profiles: ${allProfiles?.length || 0}\n`;
        message += `Fay found (exact): ${fayProfile?.length || 0}\n`;
        message += `Fay found (ilike): ${fayProfileIlike?.length || 0}\n\n`;

        if (allProfiles && allProfiles.length > 0) {
          message += 'Available usernames:\n';
          message += allProfiles.map(p => `- ${p.username}`).join('\n');
        }

        if (error1 || error2 || error3) {
          message += '\n\nâš ï¸ ERRORS DETECTED:\n';
          if (error1) message += `Error 1: ${error1.message}\n`;
          if (error2) message += `Error 2: ${error2.message}\n`;
          if (error3) message += `Error 3: ${error3.message}\n`;
        }

        alert(message);
        console.log('ðŸ“‹ Full test results:', { allProfiles, fayProfile, fayProfileIlike });

      } catch (err) {
        console.error('ðŸ’¥ Database test failed:', err);
        alert('Database test failed: ' + err.message);
      }
    }

    // Login function - SECURE SUPABASE AUTH VERSION
    async function handleLogin(e) {
      e.preventDefault();

      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const rememberMe = document.getElementById('rememberMe').checked;

      if (!username || !password) {
        alert('Bitte fÃ¼lle alle Felder aus');
        return;
      }

      const submitButton = e.target.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.textContent = 'Anmelden...';
      submitButton.disabled = true;

      try {
        console.log('ðŸ”‘ Login attempt for:', username);

        // SCHRITT 1: Email fÃ¼r Username holen
        const { data: profileData, error: profileError } = await supabase
          .from('profiles')
          .select('id, email, auth_user_id')
          .ilike('username', username)
          .single();

        if (profileError || !profileData) {
          console.log('âš ï¸ User not found:', username);
          alert('Benutzername nicht gefunden');
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        if (!profileData.auth_user_id) {
          console.error('âŒ Profile not linked to auth.users:', username);
          alert('Dein Account ist noch nicht aktiviert. Bitte kontaktiere einen Administrator.');
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        // SCHRITT 2: Supabase Auth Login
        console.log('ðŸ” Attempting Supabase Auth sign-in...');

        const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
          email: profileData.email,
          password: password
        });

        if (authError) {
          console.error('âŒ Auth error:', authError.message);

          if (authError.message.includes('Invalid login credentials')) {
            alert('Falsches Passwort');
          } else if (authError.message.includes('Email not confirmed')) {
            alert('Email noch nicht bestÃ¤tigt. Bitte prÃ¼fe dein Postfach.');
          } else {
            alert('Anmeldefehler: ' + authError.message);
          }

          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        console.log('âœ… Supabase Auth successful');

        // SCHRITT 3: VollstÃ¤ndiges Profile laden
        const { data: profile, error: fullProfileError } = await supabase
          .from('profiles')
          .select('id, username, email, role, avatar_url, location_id, is_active, auth_user_id')
          .eq('auth_user_id', authData.user.id)
          .single();

        if (fullProfileError || !profile) {
          console.error('âŒ Could not load profile');
          alert('Profil konnte nicht geladen werden.');
          await supabase.auth.signOut();
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        if (profile.is_active === false) {
          alert('Dein Account ist deaktiviert.');
          await supabase.auth.signOut();
          submitButton.textContent = originalText;
          submitButton.disabled = false;
          return;
        }

        // Login erfolgreich!
        console.log('âœ… Login successful for:', profile.username);
        currentUser = profile;
        window.currentUser = profile;

        // Remember Me
        if (rememberMe) {
          localStorage.setItem('rememberMe', 'true');
          localStorage.setItem('username', profile.username);
          localStorage.setItem('userRole', profile.role || 'user');
          if (profile.avatar_url) {
            localStorage.setItem('avatarUrl', profile.avatar_url);
          }
        }

        // Update last_login_at
        supabase
          .from('profiles')
          .update({ last_login_at: new Date().toISOString() })
          .eq('id', profile.id);

        // Update UI
        updateUIForUser(profile);
        closeLoginModal();

        alert(`Willkommen zurÃ¼ck, ${profile.username}!`);

        // Post-login initialization
        await initializePermissions();
        await loadEvents();
        renderCalendar();

        submitButton.textContent = originalText;
        submitButton.disabled = false;

      } catch (err) {
        console.error('ðŸ’¥ Login failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      }
    }

    // Update UI for logged-in user
    function updateUIForUser(profile) {
      console.log('ðŸŽ¨ Updating UI for user:', profile.username);
      console.log('ðŸ–¼ï¸ Avatar URL:', profile.avatar_url || 'No avatar URL found');

      // Update profile dropdown
      const profileDropdownUsername = document.getElementById('profileDropdownUsername');
      const profileDropdownEmail = document.getElementById('profileDropdownEmail');

      if (profileDropdownUsername) {
        profileDropdownUsername.textContent = profile.username || 'User name';
      }
      if (profileDropdownEmail) {
        profileDropdownEmail.textContent = profile.email || 'user@example.com';
      }

      // Update Account Settings Page
      const usernameDisplay = document.getElementById('usernameDisplay');
      const roleDisplay = document.getElementById('roleDisplay');
      const emailInput = document.getElementById('emailInput');
      const phoneInput = document.getElementById('phoneInput');
      const avatarDisplay = document.getElementById('avatarDisplay');

      if (usernameDisplay) {
        usernameDisplay.textContent = profile.username || 'username';
      }
      if (roleDisplay) {
        roleDisplay.textContent = (profile.role || 'user').charAt(0).toUpperCase() + (profile.role || 'user').slice(1);
      }
      if (emailInput) {
        emailInput.value = profile.email || '';
      }
      // phoneInput wird aus localStorage geladen

      // Update avatar in Account Settings
      if (avatarDisplay && profile.avatar_url) {
        avatarDisplay.style.background = 'none';
        avatarDisplay.innerHTML = `<img src="${profile.avatar_url}" alt="Avatar">`;
      }

      // Show welcome message
      const dashboardWelcome = document.getElementById('dashboardWelcome');
      const dashboardWelcomeText = document.getElementById('dashboardWelcomeText');
      const dashboardAvatar = document.getElementById('dashboardAvatar');

      if (dashboardWelcome) {
        dashboardWelcome.style.display = 'flex';
        dashboardWelcomeText.textContent = `Willkommen ${profile.username}`;

        if (profile.avatar_url && dashboardAvatar) {
          dashboardAvatar.src = profile.avatar_url;
          dashboardAvatar.onerror = function() {
            console.error('âŒ Failed to load dashboard avatar:', profile.avatar_url);
          };
          console.log('âœ… Dashboard avatar updated:', profile.avatar_url);
        }
      }

      // Update Mobile Nav Avatar (Bottom Bar)
      loadMobileNavAvatar(profile);

      // Update Mobile Dashboard Profile
      loadMobileDashboardProfile(profile);

      // Update profile modal fields
      const profileUsername = document.getElementById('profileUsername');
      const profileEmail = document.getElementById('profileEmail');
      const profileRole = document.getElementById('profileRole');
      const profileAvatarPreview = document.getElementById('profileAvatarPreview');

      if (profileUsername) profileUsername.value = profile.username || '';
      if (profileEmail) profileEmail.value = profile.email || '';
      if (profileRole) profileRole.value = profile.role || 'user';
      if (profileAvatarPreview && profile.avatar_url) {
        profileAvatarPreview.src = profile.avatar_url;
      }

      // Load artist ID for current user and apply restrictions
      loadCurrentUserArtistId().then(() => {
        applyArtistUserRestrictions();
      });

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // RELOAD TO-DO PROJECTS AFTER LOGIN
      // Use custom event to handle async script loading order
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      console.log('ðŸ“‹ Triggering todo-reload event...');
      window.dispatchEvent(new CustomEvent('user-authenticated', {
        detail: { userId: currentUser.id, username: currentUser.username }
      }));

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // MOBILE: Show mobile nav and initialize mobile views after login
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (window.matchMedia('(max-width: 768px)').matches) {
        console.log('ðŸ“± Mobile device detected, initializing mobile UI...');

        // Add logged-in class to body for CSS
        document.body.classList.add('logged-in');
        document.body.classList.remove('logged-out');

        // Show mobile nav
        const mobileNav = document.querySelector('.mobile-footer-nav');
        if (mobileNav) {
          mobileNav.classList.add('visible');
          console.log('âœ… Mobile nav shown');
        }

        // Update mobile profile with user data
        if (typeof updateMobileProfileData === 'function') {
          updateMobileProfileData();
        }

        // Pre-initialize mobile calendar/dienstplan
        if (typeof initMobileCalendar === 'function') {
          initMobileCalendar();
          console.log('âœ… Mobile calendar initialized');
        }
        if (typeof initMobileDienstplan === 'function') {
          initMobileDienstplan();
          console.log('âœ… Mobile dienstplan initialized');
        }

        // Preload month view for faster opening
        if (typeof preloadMobileCalMonthView === 'function') {
          preloadMobileCalMonthView();
        }
      }
    }

    // ==========================================
    // MOBILE AVATAR & PROFILE FUNCTIONS
    // ==========================================

    // Load avatar into mobile bottom nav bar
    function loadMobileNavAvatar(profile) {
      const img = document.getElementById('mobileNavAvatarImg');
      const initials = document.getElementById('mobileNavAvatarInitials');
      if (!img || !initials) return;

      // Set initials as fallback
      const name = profile?.username || profile?.name || 'User';
      initials.textContent = name.charAt(0).toUpperCase();

      // Try to load avatar image
      const avatarUrl = profile?.avatar_url || profile?.profile_picture_url;
      if (avatarUrl) {
        img.src = avatarUrl;
        img.onload = () => {
          img.style.display = 'block';
          initials.style.display = 'none';
        };
        img.onerror = () => {
          img.style.display = 'none';
          initials.style.display = 'flex';
        };
      }
      console.log('âœ… Mobile nav avatar updated');
    }

    // Load profile data into mobile dashboard
    function loadMobileDashboardProfile(profile) {
      const avatarImg = document.getElementById('mobileProfileAvatarImg');
      const avatarInitials = document.getElementById('mobileProfileInitials');
      const nameEl = document.getElementById('mobileProfileName');
      const roleEl = document.getElementById('mobileProfileRole');
      const emailEl = document.getElementById('mobileProfileEmail');

      if (nameEl) {
        nameEl.textContent = profile?.username || profile?.name || 'User Name';
      }

      if (roleEl) {
        const role = profile?.role || 'Artist';
        roleEl.textContent = role.charAt(0).toUpperCase() + role.slice(1);
      }

      // Set email for swipe container - check multiple sources
      if (emailEl) {
        const user = window.currentUser || (typeof currentUser !== 'undefined' ? currentUser : null);
        const email = profile?.email || user?.email || '';
        emailEl.textContent = email || 'Keine Email';
      }

      if (avatarInitials) {
        const name = profile?.username || profile?.name || 'U';
        avatarInitials.textContent = name.charAt(0).toUpperCase();
      }

      const avatarUrl = profile?.avatar_url || profile?.profile_picture_url;
      if (avatarUrl && avatarImg) {
        avatarImg.src = avatarUrl;
        avatarImg.onload = () => {
          avatarImg.style.display = 'block';
          if (avatarInitials) avatarInitials.style.display = 'none';
        };
        avatarImg.onerror = () => {
          avatarImg.style.display = 'none';
          if (avatarInitials) avatarInitials.style.display = 'flex';
        };
      }

      // Initialize swipe after profile is loaded
      initMobileProfileSwipe();
      console.log('âœ… Mobile dashboard profile updated');
    }

    // ==========================================
    // MOBILE PROFILE SWIPE (Role/Email)
    // ==========================================
    let mobileProfileCurrentSlide = 0;
    let mobileProfileTouchStartX = 0;
    let mobileProfileTouchEndX = 0;

    function initMobileProfileSwipe() {
      const container = document.getElementById('mobileProfileSwipe');
      if (!container) return;

      // Remove existing listeners by cloning
      const newContainer = container.cloneNode(true);
      container.parentNode.replaceChild(newContainer, container);

      newContainer.addEventListener('touchstart', (e) => {
        mobileProfileTouchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      newContainer.addEventListener('touchend', (e) => {
        mobileProfileTouchEndX = e.changedTouches[0].screenX;
        handleMobileProfileSwipe();
      }, { passive: true });
    }

    function handleMobileProfileSwipe() {
      const diff = mobileProfileTouchStartX - mobileProfileTouchEndX;
      const threshold = 50;

      if (diff > threshold && mobileProfileCurrentSlide === 0) {
        // Swipe left â†’ show email (slide 1)
        setMobileProfileSlide(1);
      } else if (diff < -threshold && mobileProfileCurrentSlide === 1) {
        // Swipe right â†’ show role (slide 0)
        setMobileProfileSlide(0);
      }
    }

    function setMobileProfileSlide(index) {
      mobileProfileCurrentSlide = index;

      const track = document.getElementById('mobileProfileSwipeTrack');
      if (track) {
        track.style.transform = `translateX(-${index * 50}%)`;
      }

      // Update indicators
      document.querySelectorAll('.mobile-profile-indicator').forEach((ind, i) => {
        ind.classList.toggle('active', i === index);
      });
    }

    // ==========================================
    // MOBILE THEME TOGGLE (Dark/Light)
    // ==========================================
    function setMobileTheme(theme) {
      const lightBtn = document.getElementById('mobileLightModeBtn');
      const darkBtn = document.getElementById('mobileDarkModeBtn');

      if (theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
        lightBtn?.classList.remove('active');
        darkBtn?.classList.add('active');
      } else {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('theme', 'light');
        lightBtn?.classList.add('active');
        darkBtn?.classList.remove('active');
      }
    }

    // Initialize theme on page load
    function initMobileTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      setMobileTheme(savedTheme);
    }

    // Expose functions globally
    window.loadMobileNavAvatar = loadMobileNavAvatar;
    window.loadMobileDashboardProfile = loadMobileDashboardProfile;
    window.setMobileTheme = setMobileTheme;
    window.initMobileTheme = initMobileTheme;
    window.initMobileProfileSwipe = initMobileProfileSwipe;

    // Close login modal
    function closeLoginModal() {
      document.getElementById('loginBackdrop').classList.remove('active');

      // Reset to login view and hide password change form
      setTimeout(() => {
        document.getElementById('loginFormView').style.display = 'block';
        document.getElementById('profileView').style.display = 'none';
        hidePasswordChangeForm();
      }, 300); // Wait for backdrop animation to finish
    }

    // Logout
    async function logout() {
      if (confirm('MÃ¶chtest du dich wirklich abmelden?')) {
        console.log('ðŸšª Logging out user:', currentUser?.username);

        // Sign out from Supabase Auth
        console.log('ðŸ” Signing out from Supabase Auth...');
        const { error: signOutError } = await supabase.auth.signOut();
        if (signOutError) {
          console.error('âš ï¸ Supabase Auth sign-out error:', signOutError);
        } else {
          console.log('âœ… Supabase Auth signed out');
        }

        // Clear user data
        currentUser = null;
        window.currentUser = null;
        localStorage.removeItem('rememberMe');
        localStorage.removeItem('username');
        localStorage.removeItem('userRole');
        localStorage.removeItem('avatarUrl');

        console.log('ðŸ—‘ï¸ Session data cleared');

        // Reset UI
        const dashboardWelcome = document.getElementById('dashboardWelcome');
        if (dashboardWelcome) {
          dashboardWelcome.style.display = 'none';
        }

        // Body class aktualisieren
        document.body.classList.remove('logged-in');
        document.body.classList.add('logged-out');

        // Mobile nav verstecken
        document.querySelector('.mobile-footer-nav')?.classList.remove('visible');

        // Hide mobile views
        document.getElementById('mobileCalendarView')?.classList.remove('active');
        document.getElementById('mobileDienstplanView')?.classList.remove('active');

        // Alle Sections verstecken
        document.querySelectorAll('section').forEach(s => {
          s.style.display = 'none';
          s.classList.remove('active');
        });

        // WICHTIG: LoadingScreen mit Login anzeigen (nicht loginBackdrop!)
        if (typeof LoadingScreen !== 'undefined' && LoadingScreen.showLogin) {
          console.log('ðŸ”‘ Showing LoadingScreen login...');
          LoadingScreen.showLogin();
        } else {
          // Fallback: Seite neu laden
          console.log('ðŸ”„ Reloading page for login...');
          window.location.reload();
        }

        console.log('âœ… Logout complete');
      }
    }

    // Profile button click handler
    function toggleProfileMenu() {
      if (currentUser) {
        // Navigate to profile section (full-page view)
        const tabs = document.querySelectorAll("nav a[id^='tab-']");
        const sections = document.querySelectorAll("section");

        // Deactivate all tabs and sections
        tabs.forEach(t => t.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));

        // Activate profile section
        const profileSection = document.getElementById('profile-section');
        if (profileSection) {
          profileSection.classList.add('active');
          loadProfilePage();
        }
      } else {
        // Show login modal
        document.getElementById('loginBackdrop').classList.add('active');
        document.getElementById('loginFormView').style.display = 'block';
        document.getElementById('profileView').style.display = 'none';
      }
    }

    // Show profile view with user data
    function showProfileView() {
      console.log('ðŸ“‹ Opening profile view for:', currentUser.username);
      console.log('ðŸ–¼ï¸ Profile avatar URL:', currentUser.avatar_url || 'No avatar URL');

      // Switch to profile view
      document.getElementById('loginFormView').style.display = 'none';
      document.getElementById('profileView').style.display = 'block';
      document.getElementById('loginBackdrop').classList.add('active');

      // Update profile view with current user data
      document.getElementById('profileName').textContent = currentUser.username;
      document.getElementById('profileUsernameValue').textContent = currentUser.username;
      document.getElementById('profileRoleValue').textContent = (currentUser.role || 'user').toUpperCase();

      // Update avatar if exists
      const avatarLarge = document.getElementById('profileAvatarLarge');
      if (currentUser.avatar_url) {
        avatarLarge.src = currentUser.avatar_url;
        avatarLarge.style.display = 'block';
        avatarLarge.onerror = function() {
          console.error('âŒ Failed to load large profile avatar:', currentUser.avatar_url);
          avatarLarge.style.display = 'none';
        };
        console.log('âœ… Large profile avatar set:', currentUser.avatar_url);
      } else {
        avatarLarge.style.display = 'none';
      }

      // Reset password display and hide change form
      document.getElementById('profilePasswordValue').textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
      hidePasswordChangeForm();
    }

    // Toggle password visibility
    function togglePassword() {
      const passwordValue = document.getElementById('profilePasswordValue');
      const toggleBtn = event.target;

      if (passwordValue.textContent === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
        // Show password
        passwordValue.textContent = currentUser.password_hash || 'Nicht gesetzt';
        toggleBtn.textContent = 'Verbergen';
      } else {
        // Hide password
        passwordValue.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        toggleBtn.textContent = 'Anzeigen';
      }
    }

    // Upload avatar
    async function uploadAvatar() {
      const fileInput = document.getElementById('avatarUpload');
      const file = fileInput.files[0];

      if (!file) {
        alert('Bitte wÃ¤hle ein Bild aus');
        return;
      }

      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Die Datei ist zu groÃŸ. Maximal 5MB erlaubt.');
        return;
      }

      // Check file type
      if (!file.type.startsWith('image/')) {
        alert('Bitte wÃ¤hle eine Bilddatei aus');
        return;
      }

      try {
        console.log('ðŸ“¤ Uploading avatar for:', currentUser.username);

        // Generate unique filename (without subdirectory to avoid RLS issues)
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;

        // Upload to Supabase Storage (root of bucket to avoid RLS policy issues)
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: true
          });

        if (uploadError) {
          console.error('âŒ Upload error:', uploadError);
          alert('Fehler beim Hochladen: ' + uploadError.message);
          return;
        }

        // Get public URL
        const { data: { publicUrl } } = supabase.storage
          .from('avatars')
          .getPublicUrl(fileName);

        console.log('âœ… Avatar uploaded:', publicUrl);

        // Update profile in database
        const { error: updateError } = await supabase
          .from('profiles')
          .update({ avatar_url: publicUrl })
          .eq('id', currentUser.id);

        if (updateError) {
          console.error('âŒ Database update error:', updateError);
          alert('Fehler beim Speichern: ' + updateError.message);
          return;
        }

        // Update current user object
        currentUser.avatar_url = publicUrl;

        // Update UI
        updateUIForUser(currentUser);
        document.getElementById('profileAvatarLarge').src = publicUrl;
        document.getElementById('profileAvatarLarge').style.display = 'block';

        alert('âœ… Profilbild erfolgreich hochgeladen!');
        console.log('âœ… Profile updated successfully');

      } catch (err) {
        console.error('ðŸ’¥ Avatar upload failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
      }
    }

    // ============================================
    // AVATAR UPLOAD MODAL FUNCTIONS
    // ============================================

    let selectedAvatarFile = null;

    // Open Avatar Upload Modal
    function openAvatarUploadModal() {
      // Show current avatar if exists
      const currentAvatarImg = document.getElementById('currentAvatarImg');
      const currentAvatarPreview = document.getElementById('currentAvatarPreview');

      if (currentUser && currentUser.avatar_url) {
        currentAvatarImg.src = currentUser.avatar_url;
        currentAvatarPreview.style.display = 'block';
      } else {
        currentAvatarPreview.style.display = 'none';
      }

      // Reset form
      selectedAvatarFile = null;
      document.getElementById('avatarFileInput').value = '';
      document.getElementById('avatarPreviewContainer').style.display = 'none';
      document.getElementById('uploadProgress').style.display = 'none';
      document.getElementById('uploadAvatarBtn').disabled = true;
      document.getElementById('uploadAvatarBtn').style.opacity = '0.5';

      // Show modal
      document.getElementById('avatarUploadModal').classList.add('active');
    }

    // Close Avatar Upload Modal
    function closeAvatarUploadModal() {
      document.getElementById('avatarUploadModal').classList.remove('active');
      selectedAvatarFile = null;
    }

    // Handle drag over
    function handleDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      const dropZone = document.getElementById('avatarDropZone');
      dropZone.style.borderColor = 'var(--accent)';
      dropZone.style.background = '#e0f2fe';
    }

    // Handle drag leave
    function handleDragLeave(event) {
      event.preventDefault();
      event.stopPropagation();
      const dropZone = document.getElementById('avatarDropZone');
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '#f9fafb';
    }

    // Handle drop
    function handleDrop(event) {
      event.preventDefault();
      event.stopPropagation();

      const dropZone = document.getElementById('avatarDropZone');
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '#f9fafb';

      const files = event.dataTransfer.files;
      if (files.length > 0) {
        processAvatarFile(files[0]);
      }
    }

    // Handle file select
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        processAvatarFile(file);
      }
    }

    // Process selected file
    function processAvatarFile(file) {
      // Check file type
      if (!file.type.startsWith('image/')) {
        alert('Bitte wÃ¤hle eine Bilddatei aus (PNG, JPG, GIF)');
        return;
      }

      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Die Datei ist zu groÃŸ. Maximal 5MB erlaubt.');
        return;
      }

      selectedAvatarFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('avatarPreview').src = e.target.result;
        document.getElementById('avatarFileName').textContent = file.name;
        document.getElementById('avatarPreviewContainer').style.display = 'block';

        // Enable upload button
        document.getElementById('uploadAvatarBtn').disabled = false;
        document.getElementById('uploadAvatarBtn').style.opacity = '1';
      };
      reader.readAsDataURL(file);
    }

    // Upload avatar from modal
    async function uploadAvatarFromModal() {
      if (!selectedAvatarFile) {
        alert('Bitte wÃ¤hle ein Bild aus');
        return;
      }

      const uploadBtn = document.getElementById('uploadAvatarBtn');
      const progressDiv = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('uploadProgressBar');

      try {
        // Disable button and show progress
        uploadBtn.disabled = true;
        uploadBtn.style.opacity = '0.5';
        progressDiv.style.display = 'block';
        progressBar.style.width = '30%';

        console.log('ðŸ“¤ Uploading avatar for:', currentUser.username);

        // Generate unique filename (without subdirectory to avoid RLS issues)
        const fileExt = selectedAvatarFile.name.split('.').pop();
        const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;

        progressBar.style.width = '50%';

        // Upload to Supabase Storage (root of bucket to avoid RLS policy issues)
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(fileName, selectedAvatarFile, {
            cacheControl: '3600',
            upsert: true
          });

        if (uploadError) {
          console.error('âŒ Upload error:', uploadError);
          alert('Fehler beim Hochladen: ' + uploadError.message);
          progressDiv.style.display = 'none';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          return;
        }

        progressBar.style.width = '70%';

        // Get public URL
        const { data: { publicUrl } } = supabase.storage
          .from('avatars')
          .getPublicUrl(fileName);

        console.log('âœ… Avatar uploaded:', publicUrl);

        progressBar.style.width = '90%';

        // Update profile in database
        const { error: updateError } = await supabase
          .from('profiles')
          .update({ avatar_url: publicUrl })
          .eq('id', currentUser.id);

        if (updateError) {
          console.error('âŒ Database update error:', updateError);
          alert('Fehler beim Speichern: ' + updateError.message);
          progressDiv.style.display = 'none';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          return;
        }

        progressBar.style.width = '100%';

        // Update current user object
        currentUser.avatar_url = publicUrl;

        // Save avatar URL to localStorage for persistence
        localStorage.setItem('avatarUrl', publicUrl);
        console.log('ðŸ’¾ Avatar URL saved to localStorage');

        // Update UI
        updateUIForUser(currentUser);
        document.getElementById('profileAvatarLarge').src = publicUrl;
        document.getElementById('profileAvatarLarge').style.display = 'block';

        // Close modal after short delay
        setTimeout(() => {
          closeAvatarUploadModal();
          alert('âœ… Profilbild erfolgreich hochgeladen!');
        }, 500);

        console.log('âœ… Profile updated successfully');

      } catch (err) {
        console.error('ðŸ’¥ Avatar upload failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
        progressDiv.style.display = 'none';
        uploadBtn.disabled = false;
        uploadBtn.style.opacity = '1';
      }
    }

    // ============================================
    // PROFILE PAGE FUNCTIONS
    // ============================================

    let selectedProfileAvatarFile = null;

    // Load profile page
    function loadProfilePage() {
      if (!currentUser) {
        alert('Bitte melden Sie sich zuerst an');
        return;
      }

      // Update profile information
      document.getElementById('profilePageName').textContent = currentUser.username;
      document.getElementById('profilePageUsername').textContent = currentUser.username;
      document.getElementById('profilePageRoleText').textContent = (currentUser.role || 'user').toUpperCase();
      document.getElementById('profilePageRoleBadge').textContent = (currentUser.role || 'user').toUpperCase();

      // Update avatar
      const profilePageAvatar = document.getElementById('profilePageAvatar');
      const profilePageCurrentAvatarImg = document.getElementById('profilePageCurrentAvatarImg');

      if (currentUser.avatar_url) {
        profilePageAvatar.src = currentUser.avatar_url;
        profilePageCurrentAvatarImg.src = currentUser.avatar_url;
        document.getElementById('profilePageCurrentAvatarPreview').style.display = 'block';
      } else {
        document.getElementById('profilePageCurrentAvatarPreview').style.display = 'none';
      }

      // Reset upload form
      selectedProfileAvatarFile = null;
      document.getElementById('profilePageAvatarFileInput').value = '';
      document.getElementById('profilePageAvatarPreviewContainer').style.display = 'none';
      document.getElementById('profilePageUploadProgress').style.display = 'none';
      document.getElementById('profilePageUploadAvatarBtn').disabled = true;
      document.getElementById('profilePageUploadAvatarBtn').style.opacity = '0.5';
    }

    // Handle drag over for profile page
    function handleProfileDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      const dropZone = document.getElementById('profilePageAvatarDropZone');
      dropZone.style.borderColor = 'var(--accent)';
      dropZone.style.background = '#e0f2fe';
    }

    // Handle drag leave for profile page
    function handleProfileDragLeave(event) {
      event.preventDefault();
      event.stopPropagation();
      const dropZone = document.getElementById('profilePageAvatarDropZone');
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '#f9fafb';
    }

    // Handle drop for profile page
    function handleProfileDrop(event) {
      event.preventDefault();
      event.stopPropagation();

      const dropZone = document.getElementById('profilePageAvatarDropZone');
      dropZone.style.borderColor = '#d1d5db';
      dropZone.style.background = '#f9fafb';

      const files = event.dataTransfer.files;
      if (files.length > 0) {
        processProfileAvatarFile(files[0]);
      }
    }

    // Handle file select for profile page
    function handleProfileFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        processProfileAvatarFile(file);
      }
    }

    // Process selected file for profile page
    function processProfileAvatarFile(file) {
      // Check file type
      if (!file.type.startsWith('image/')) {
        alert('Bitte wÃ¤hle eine Bilddatei aus (PNG, JPG, GIF)');
        return;
      }

      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Die Datei ist zu groÃŸ. Maximal 5MB erlaubt.');
        return;
      }

      selectedProfileAvatarFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('profilePageAvatarPreview').src = e.target.result;
        document.getElementById('profilePageAvatarFileName').textContent = file.name;
        document.getElementById('profilePageAvatarPreviewContainer').style.display = 'block';

        // Enable upload button
        document.getElementById('profilePageUploadAvatarBtn').disabled = false;
        document.getElementById('profilePageUploadAvatarBtn').style.opacity = '1';
      };
      reader.readAsDataURL(file);
    }

    // Upload avatar from profile page
    async function uploadAvatarFromProfilePage() {
      if (!selectedProfileAvatarFile) {
        alert('Bitte wÃ¤hle ein Bild aus');
        return;
      }

      const uploadBtn = document.getElementById('profilePageUploadAvatarBtn');
      const progressDiv = document.getElementById('profilePageUploadProgress');
      const progressBar = document.getElementById('profilePageUploadProgressBar');

      try {
        // Disable button and show progress
        uploadBtn.disabled = true;
        uploadBtn.style.opacity = '0.5';
        progressDiv.style.display = 'block';
        progressBar.style.width = '30%';

        console.log('ðŸ“¤ Uploading avatar for:', currentUser.username);

        // Generate unique filename (without subdirectory to avoid RLS issues)
        const fileExt = selectedProfileAvatarFile.name.split('.').pop();
        const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;

        progressBar.style.width = '50%';

        // Upload to Supabase Storage (root of bucket to avoid RLS policy issues)
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(fileName, selectedProfileAvatarFile, {
            cacheControl: '3600',
            upsert: true
          });

        if (uploadError) {
          console.error('âŒ Upload error:', uploadError);
          alert('Fehler beim Hochladen: ' + uploadError.message);
          progressDiv.style.display = 'none';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          return;
        }

        progressBar.style.width = '70%';

        // Get public URL
        const { data: { publicUrl } } = supabase.storage
          .from('avatars')
          .getPublicUrl(fileName);

        console.log('âœ… Avatar uploaded:', publicUrl);

        progressBar.style.width = '90%';

        // Update profile in database
        const { error: updateError } = await supabase
          .from('profiles')
          .update({ avatar_url: publicUrl })
          .eq('id', currentUser.id);

        if (updateError) {
          console.error('âŒ Database update error:', updateError);
          alert('Fehler beim Speichern: ' + updateError.message);
          progressDiv.style.display = 'none';
          uploadBtn.disabled = false;
          uploadBtn.style.opacity = '1';
          return;
        }

        progressBar.style.width = '100%';

        // Update current user object
        currentUser.avatar_url = publicUrl;

        // Save avatar URL to localStorage for persistence
        localStorage.setItem('avatarUrl', publicUrl);
        console.log('ðŸ’¾ Avatar URL saved to localStorage');

        // Update UI
        updateUIForUser(currentUser);
        document.getElementById('profilePageAvatar').src = publicUrl;
        document.getElementById('profilePageCurrentAvatarImg').src = publicUrl;
        document.getElementById('profilePageCurrentAvatarPreview').style.display = 'block';

        // Reset form
        setTimeout(() => {
          selectedProfileAvatarFile = null;
          document.getElementById('profilePageAvatarFileInput').value = '';
          document.getElementById('profilePageAvatarPreviewContainer').style.display = 'none';
          progressDiv.style.display = 'none';
          uploadBtn.disabled = true;
          uploadBtn.style.opacity = '0.5';
          alert('âœ… Profilbild erfolgreich hochgeladen!');
        }, 500);

        console.log('âœ… Profile updated successfully');

      } catch (err) {
        console.error('ðŸ’¥ Avatar upload failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
        progressDiv.style.display = 'none';
        uploadBtn.disabled = false;
        uploadBtn.style.opacity = '1';
      }
    }

    // Show password change form for profile page
    function showPasswordChangeFormPage() {
      document.getElementById('profilePagePasswordChangeForm').style.display = 'block';
    }

    // Hide password change form for profile page
    function hidePasswordChangeFormPage() {
      document.getElementById('profilePagePasswordChangeForm').style.display = 'none';
      document.getElementById('profilePageNewPassword').value = '';
      document.getElementById('profilePageConfirmPassword').value = '';
    }

    // Change password from profile page
    async function changePasswordPage() {
      const newPassword = document.getElementById('profilePageNewPassword').value;
      const confirmPassword = document.getElementById('profilePageConfirmPassword').value;

      // Validation
      if (!newPassword || !confirmPassword) {
        alert('Bitte fÃ¼lle beide Felder aus');
        return;
      }

      if (newPassword.length < 6) {
        alert('Das Passwort muss mindestens 6 Zeichen lang sein');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('Die PasswÃ¶rter stimmen nicht Ã¼berein');
        return;
      }

      try {
        console.log('ðŸ”‘ Changing password for:', currentUser.username);

        // Hash password using bcrypt
        const hashedPassword = await bcrypt.hash(newPassword, 10);

        // Update password in database
        const { error } = await supabase
          .from('profiles')
          .update({ password_hash: hashedPassword })
          .eq('id', currentUser.id);

        if (error) {
          console.error('âŒ Password update error:', error);
          alert('Fehler beim Ã„ndern des Passworts: ' + error.message);
          return;
        }

        console.log('âœ… Password changed successfully');
        alert('âœ… Passwort erfolgreich geÃ¤ndert!');
        hidePasswordChangeFormPage();

      } catch (err) {
        console.error('ðŸ’¥ Password change failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
      }
    }

    // Show password change form
    function showPasswordChangeForm() {
      document.getElementById('passwordChangeForm').style.display = 'block';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    // Hide password change form
    function hidePasswordChangeForm() {
      document.getElementById('passwordChangeForm').style.display = 'none';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    // Change password
    async function changePassword() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validation
      if (!newPassword || !confirmPassword) {
        alert('Bitte fÃ¼lle beide Felder aus');
        return;
      }

      if (newPassword.length < 6) {
        alert('Das Passwort muss mindestens 6 Zeichen lang sein');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('Die PasswÃ¶rter stimmen nicht Ã¼berein');
        return;
      }

      try {
        console.log('ðŸ”‘ Changing password for:', currentUser.username);

        // Hash password using bcrypt
        const hashedPassword = await bcrypt.hash(newPassword, 10);

        // Update password in database
        const { error } = await supabase
          .from('profiles')
          .update({ password_hash: hashedPassword })
          .eq('id', currentUser.id);

        if (error) {
          console.error('âŒ Password update error:', error);
          alert('Fehler beim Ã„ndern des Passworts: ' + error.message);
          return;
        }

        // Update current user object
        currentUser.password_hash = hashedPassword;

        // Hide form and show success message
        hidePasswordChangeForm();
        alert('âœ… Passwort erfolgreich geÃ¤ndert!');
        console.log('âœ… Password changed successfully');

      } catch (err) {
        console.error('ðŸ’¥ Password change failed:', err);
        alert('Ein Fehler ist aufgetreten: ' + err.message);
      }
    }

    // ============================================
    // DEBUG HELPER FUNCTIONS
    // ============================================

    // Test database connection
    async function testDatabaseConnection() {
      console.log('ðŸ”Œ Testing database connection...');
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('count')
          .limit(1);

        if (error) {
          console.error('âŒ Database connection failed:', error);
          return false;
        }

        console.log('âœ… Database connection successful');
        return true;
      } catch (err) {
        console.error('ðŸ’¥ Database connection test failed:', err);
        return false;
      }
    }

    // List all users in profiles table
    async function debugListUsers() {
      console.log('ðŸ“‹ Fetching all users from profiles table...');
      try {
        const { data: profiles, error } = await supabase
          .from('profiles')
          .select('id, username, role, email, created_at')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('âŒ Error fetching users:', error);
          return;
        }

        console.log('âœ… Found', profiles.length, 'users:');
        console.table(profiles);
        return profiles;
      } catch (err) {
        console.error('ðŸ’¥ Failed to list users:', err);
      }
    }

    // Test login with username/password - SECURE SUPABASE AUTH VERSION
    async function debugTestLogin(username, password) {
      console.log('ðŸ§ª Testing login for:', username);
      try {
        // Get email for username
        const { data: profile } = await supabase
          .from('profiles')
          .select('email, auth_user_id')
          .ilike('username', username)
          .single();

        if (!profile) {
          console.log('âš ï¸ User not found');
          return false;
        }

        if (!profile.auth_user_id) {
          console.log('âš ï¸ User not linked to auth.users');
          return false;
        }

        // Try auth login
        const { data, error } = await supabase.auth.signInWithPassword({
          email: profile.email,
          password: password
        });

        if (error) {
          console.log('âŒ Auth failed:', error.message);
          return false;
        }

        console.log('âœ… Login would succeed!');
        // Sign out again (this was just a test)
        await supabase.auth.signOut();
        return true;

      } catch (err) {
        console.error('ðŸ’¥ Test failed:', err);
        return false;
      }
    }

    // Make debug functions available globally
    window.testDatabaseConnection = testDatabaseConnection;
    window.debugListUsers = debugListUsers;
    window.debugTestLogin = debugTestLogin;

    // ========================================
    // ANALYTICS SECTION
    // ========================================

    let currentTimeRange = 'weekly';
    let appointmentsData = []; // For timeline chart
    let requestsData = []; // For origin chart
    let allRequestsData = []; // For requests count (including canceled)
    let projectsData = []; // For revenue analytics

    // Load analytics data from Supabase
    // Load appointments data for Timeline Chart (uses created_at)
    async function loadAppointmentsData(locationFilter = null) {
      try {
        console.log('ðŸ“Š Loading appointments data for timeline...');
        console.log('ðŸ“Š Location filter:', locationFilter || 'None');
        console.log('ðŸ“Š Current user:', currentUser ? currentUser.username : 'Not logged in');

        // First, try to count total appointments to check if we have access
        console.log('ðŸ” Checking table access...');
        const { count, error: countError } = await supabase
          .from('appointments')
          .select('*', { count: 'exact', head: true });

        console.log('ðŸ“Š Total appointments in table (accessible):', count);
        if (countError) {
          console.error('âŒ Count error:', countError);
        }

        // PAGINATED LOADING: Load ALL appointments in batches of 1000
        console.log('ðŸš¨ APPOINTMENTS QUERY VERSION: 2025-11-13-v7 PAGINATED - loading ALL records in batches');
        console.log('â³ Fetching all appointments from Supabase using pagination...');

        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;
        let batchNumber = 1;

        while (hasMore) {
          console.log(`ðŸ“¦ Loading batch ${batchNumber} (records ${from} to ${from + batchSize - 1})...`);

          let query = supabase
            .from('appointments')
            .select('booking_type, state, created_at, location_id, id')
            .not('created_at', 'is', null)  // Only get appointments with created_at
            .order('created_at', { ascending: true })  // Load OLDEST first to get 2024 AND 2025 data
            .range(from, from + batchSize - 1);  // Paginate with range

          // Don't apply location filter if it's an empty string or invalid
          if (locationFilter && locationFilter !== '' && locationFilter !== 'null') {
            query = query.eq('location_id', locationFilter);
          }

          const { data, error } = await query;

          if (error) {
            console.error('âŒ Supabase error on batch', batchNumber, ':', error);
            throw error;
          }

          if (data && data.length > 0) {
            allData = allData.concat(data);
            console.log(`âœ… Batch ${batchNumber}: Loaded ${data.length} records. Total so far: ${allData.length}`);
            from += batchSize;
            hasMore = data.length === batchSize;  // If we got less than batchSize, we're done
            batchNumber++;
          } else {
            hasMore = false;
          }
        }

        console.log(`âœ… Successfully loaded ${allData.length} of ${count || 'unknown'} appointments`);
        if (allData.length < count) {
          console.warn(`âš ï¸ WARNING: Only loaded ${allData.length} out of ${count} appointments!`);
        } else {
          console.log(`ðŸŽ‰ SUCCESS: All ${allData.length} appointments loaded!`);
        }

        // If no data at all, return empty array
        if (!allData || allData.length === 0) {
          console.warn('âš ï¸ Appointments table is empty');
          return [];
        }

        // DEBUG: Show sample of created_at values
        console.log('ðŸ“… Sample created_at values (first 5):', allData.slice(0, 5).map(apt => apt.created_at));

        // DEBUG: Show date range of loaded appointments
        const dates = allData.map(apt => new Date(apt.created_at)).filter(d => !isNaN(d.getTime()));
        if (dates.length > 0) {
          const minDate = new Date(Math.min(...dates));
          const maxDate = new Date(Math.max(...dates));
          console.log('ðŸ“… Date range:', minDate.toLocaleDateString('de-DE'), 'to', maxDate.toLocaleDateString('de-DE'));
          console.log('ðŸ“… Valid dates:', dates.length, 'out of', allData.length, 'appointments');
          console.log(`ðŸ“Š Total appointments loaded: ${allData.length}`);
          console.log(`ðŸ“… Oldest appointment: ${minDate.toLocaleDateString('de-DE')}`);
          console.log(`ðŸ“… Newest appointment: ${maxDate.toLocaleDateString('de-DE')}`);
        }

        // Analyze state distribution
        const stateCounts = {};
        allData.forEach(apt => {
          const state = apt.state || 'null';
          stateCounts[state] = (stateCounts[state] || 0) + 1;
        });
        console.log('ðŸ“Š State distribution:', stateCounts);

        // Filter for relevant states (if they exist)
        // Accept: scheduled, finished, completed, confirmed, or any state that's not cancelled
        const filteredData = allData.filter(apt => {
          const state = apt.state?.toLowerCase();
          return state &&
                 state !== 'cancelled' &&
                 state !== 'canceled' &&
                 state !== 'rejected';
        });

        console.log(`âœ… ${filteredData.length} appointments after filtering (excluding cancelled/rejected)`);

        // If filtering removes all data, use all data anyway
        if (filteredData.length === 0 && allData.length > 0) {
          console.warn('âš ï¸ All appointments filtered out, using all appointments instead');
          return allData;
        }

        return filteredData.length > 0 ? filteredData : allData;

      } catch (err) {
        console.error('âŒ Appointments data load failed:', err);
        console.error('âŒ Error details:', {
          message: err.message,
          code: err.code,
          details: err.details,
          hint: err.hint
        });
        return [];
      }
    }

    // Load requests data for Origin Pie Chart (uses created_at and origin)
    async function loadRequestsData(locationFilter = null) {
      try {
        console.log('ðŸ“Š Loading requests data for origin chart...');
        console.log('ðŸ“Š Location filter:', locationFilter || 'None');

        // First, count total requests
        const { count, error: countError } = await supabase
          .from('requests')
          .select('*', { count: 'exact', head: true });

        console.log('ðŸ“Š Total requests in table:', count);
        if (countError) {
          console.error('âŒ Count error:', countError);
        }

        // PAGINATED LOADING: Load ALL requests in batches of 1000
        console.log('ðŸš¨ REQUESTS ORIGIN QUERY VERSION: 2025-11-13-v7 PAGINATED - loading ALL records in batches');
        console.log('â³ Analyzing all requests for origin chart using pagination...');

        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;
        let batchNumber = 1;

        while (hasMore) {
          console.log(`ðŸ“¦ Loading requests batch ${batchNumber} (records ${from} to ${from + batchSize - 1})...`);

          let query = supabase
            .from('requests')
            .select('origin, status, created_at, location_id')
            .neq('status', 'canceled')  // Exclude canceled requests
            .range(from, from + batchSize - 1);  // Paginate with range

          if (locationFilter) {
            query = query.eq('location_id', locationFilter);
          }

          const { data, error } = await query;

          if (error) {
            console.error('âŒ Supabase error on batch', batchNumber, ':', error);
            throw error;
          }

          if (data && data.length > 0) {
            allData = allData.concat(data);
            console.log(`âœ… Batch ${batchNumber}: Loaded ${data.length} records. Total so far: ${allData.length}`);
            from += batchSize;
            hasMore = data.length === batchSize;  // If we got less than batchSize, we're done
            batchNumber++;
          } else {
            hasMore = false;
          }
        }

        console.log(`âœ… Successfully loaded ${allData.length} of ${count || 'unknown'} requests for origin chart`);
        if (allData.length < count) {
          console.warn(`âš ï¸ WARNING: Only loaded ${allData.length} out of ${count} requests!`);
        } else {
          console.log(`ðŸŽ‰ SUCCESS: All ${allData.length} requests loaded for origin analysis!`);
        }

        // ðŸ” DEBUG: Analyze origin values distribution
        console.log('ðŸ” DEBUG: Analyzing origin values in loaded requests...');
        const originDebug = {};
        let nullCount = 0;
        allData.forEach(req => {
          if (req.origin) {
            const origin = req.origin.trim();
            originDebug[origin] = (originDebug[origin] || 0) + 1;
          } else {
            nullCount++;
          }
        });
        console.log('ðŸ” Origin value distribution:', originDebug);
        console.log('ðŸ” Requests with NULL/empty origin:', nullCount);
        console.log('ðŸ” If most are NULL, check: 1) requests table schema, 2) data migration, 3) Webflow form field mapping');

        // If no data, log warning but don't throw error
        if (!allData || allData.length === 0) {
          console.warn('âš ï¸ No requests found in database');
          return [];
        }

        return allData;
      } catch (err) {
        console.error('âŒ Requests data load failed:', err);
        console.error('âŒ Error details:', {
          message: err.message,
          code: err.code,
          details: err.details
        });
        // Don't use alert() - just log and return empty array
        return [];
      }
    }

    // Load ALL requests data (including canceled) for count display
    async function loadAllRequestsData(locationFilter = null) {
      try {
        console.log('ðŸ“Š Loading ALL requests data for count...');
        console.log('ðŸ“Š Location filter:', locationFilter || 'None');

        // First, count total requests
        const { count, error: countError } = await supabase
          .from('requests')
          .select('*', { count: 'exact', head: true });

        console.log('ðŸ“Š Total requests in table:', count);
        if (countError) {
          console.error('âŒ Count error:', countError);
        }

        // PAGINATED LOADING: Load ALL requests in batches of 1000
        console.log('ðŸš¨ ALL REQUESTS COUNT QUERY VERSION: 2025-11-13-v7 PAGINATED - loading ALL records in batches');
        console.log('â³ Processing all requests for count display using pagination...');

        let allData = [];
        let from = 0;
        const batchSize = 1000;
        let hasMore = true;
        let batchNumber = 1;

        while (hasMore) {
          console.log(`ðŸ“¦ Loading all requests batch ${batchNumber} (records ${from} to ${from + batchSize - 1})...`);

          let query = supabase
            .from('requests')
            .select('id, status, created_at, location_id')
            .range(from, from + batchSize - 1);  // Paginate with range

          if (locationFilter && locationFilter !== '' && locationFilter !== 'null') {
            query = query.eq('location_id', locationFilter);
          }

          const { data, error } = await query;

          if (error) {
            console.error('âŒ Supabase error on batch', batchNumber, ':', error);
            throw error;
          }

          if (data && data.length > 0) {
            allData = allData.concat(data);
            console.log(`âœ… Batch ${batchNumber}: Loaded ${data.length} records. Total so far: ${allData.length}`);
            from += batchSize;
            hasMore = data.length === batchSize;  // If we got less than batchSize, we're done
            batchNumber++;
          } else {
            hasMore = false;
          }
        }

        console.log(`âœ… Successfully loaded ${allData.length} of ${count || 'unknown'} total requests (including canceled)`);
        if (allData.length < count) {
          console.warn(`âš ï¸ WARNING: Only loaded ${allData.length} out of ${count} total requests!`);
        } else {
          console.log(`ðŸŽ‰ SUCCESS: All ${allData.length} requests loaded for count display!`);
        }

        if (!allData || allData.length === 0) {
          console.warn('âš ï¸ No requests found in database');
          return [];
        }

        return allData;
      } catch (err) {
        console.error('âŒ All requests data load failed:', err);
        return [];
      }
    }

    // Render Pie Chart for Booking Origins
    async function renderOriginsPieChart(data) {
      console.log('ðŸ“Š Rendering origins pie chart with', data.length, 'requests');

      // Mapping from database values to chart categories
      const originMapping = {
        // Booking form variations
        'Contactform': 'booking_form',
        'contactform': 'booking_form',
        'booking_form': 'booking_form',
        'Booking Form': 'booking_form',
        'Booking form': 'booking_form',

        // WhatsApp variations
        'WhatsApp': 'whatsapp',
        'whatsapp': 'whatsapp',
        'Whatsapp': 'whatsapp',

        // Instagram variations
        'Instagram': 'instagram',
        'instagram': 'instagram',

        // Facebook variations
        'Facebook': 'facebook',
        'facebook': 'facebook',

        // Email variations
        'Email': 'email',
        'email': 'email',
        'E-Mail': 'email',
        'E-mail': 'email',

        // Phone variations
        'Phone': 'phone',
        'phone': 'phone',
        'Telefon': 'phone',

        // Walk-In variations
        'Walk-In': 'walk_in',
        'walk_in': 'walk_in',
        'Walk In': 'walk_in',
        'Walk in': 'walk_in',

        // Self-Booking variations
        'Self-Booking': 'self_booking',
        'self_booking': 'self_booking',
        'Self Booking': 'self_booking'
      };

      // Count origins
      const originCounts = {
        'booking_form': 0,
        'whatsapp': 0,
        'instagram': 0,
        'facebook': 0,
        'phone': 0,
        'email': 0,
        'walk_in': 0,
        'self_booking': 0
      };

      // Track unknown origins for debugging
      const unknownOrigins = new Set();

      data.forEach(req => {
        // Trim whitespace and handle null/undefined
        const rawOrigin = req.origin?.trim();

        if (rawOrigin && rawOrigin !== '') {
          // Map the database value to a chart category
          const mappedOrigin = originMapping[rawOrigin];

          if (mappedOrigin) {
            originCounts[mappedOrigin]++;
          } else {
            // Unknown origin value - log for debugging
            unknownOrigins.add(rawOrigin);
          }
        }
        // Note: Requests without origin value are not counted
      });

      console.log('ðŸ“Š Origin counts:', originCounts);
      console.log('ðŸ“Š Total requests processed:', data.length);
      console.log('ðŸ“Š Requests WITH origin:', data.filter(r => r.origin?.trim()).length);
      console.log('ðŸ“Š Requests WITHOUT origin:', data.filter(r => !r.origin?.trim()).length);
      if (unknownOrigins.size > 0) {
        console.warn('âš ï¸ Unknown origin values found:', Array.from(unknownOrigins));
        console.warn('âš ï¸ Add these to originMapping if they should be tracked');
      }

      // Labels and colors (order must match originCounts)
      const labels = [
        'Booking form',
        'Whatsapp',
        'Instagram',
        'Facebook',
        'Phone',
        'E-mail',
        'Walk-in',
        'Self-Booking'
      ];

      const colors = [
        '#0071e3', // Accent (Booking Form)
        '#25D366', // WhatsApp Green
        '#E1306C', // Instagram Pink
        '#1877F2', // Facebook Blue
        '#34C759', // Phone Green (iOS)
        '#EA4335', // Email Red
        '#7B1FA2', // Walk-In Purple
        '#00897B'  // Self-Booking Teal
      ];

      // Filter out categories with 0 count for cleaner chart
      const chartLabels = [];
      const chartData = [];
      const chartColors = [];

      labels.forEach((label, index) => {
        const key = Object.keys(originCounts)[index];
        const count = originCounts[key];
        // Always show all categories, even with 0 count
        chartLabels.push(label);
        chartData.push(count);
        chartColors.push(colors[index]);
      });

      const chartDataConfig = {
        labels: chartLabels,
        datasets: [{
          data: chartData,
          backgroundColor: chartColors,
          borderWidth: 2,
          borderColor: '#fff'
        }]
      };

      // Destroy existing chart
      if (originsPieChart) {
        originsPieChart.destroy();
      }

      const ctx = document.getElementById('bookingOriginsPie');
      if (!ctx) {
        console.error('âŒ Canvas element not found: bookingOriginsPie');
        return;
      }

      originsPieChart = new Chart(ctx.getContext('2d'), {
        type: 'pie',
        data: chartDataConfig,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                padding: 12,
                font: {
                  size: 12,
                  family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      console.log('âœ… Pie chart rendered successfully');
      console.log(`ðŸ“Š Total requests in chart: ${data.length}`);
      console.log(`ðŸ“Š Displayed categories: ${chartLabels.length} (excluding empty)`);
    }

    // Render Requests Count Display
    async function renderRequestsCount(data) {
      console.log('ðŸ“Š Rendering requests count with', data.length, 'requests');

      const countElement = document.getElementById('requestsCount');
      if (!countElement) {
        console.error('âŒ Count element not found: requestsCount');
        return;
      }

      // Animate the count
      const targetCount = data.length;
      let currentCount = 0;
      const duration = 1000; // 1 second
      const steps = 30;
      const increment = targetCount / steps;
      const stepDuration = duration / steps;

      const counter = setInterval(() => {
        currentCount += increment;
        if (currentCount >= targetCount) {
          countElement.textContent = targetCount.toLocaleString('de-DE');
          clearInterval(counter);
        } else {
          countElement.textContent = Math.floor(currentCount).toLocaleString('de-DE');
        }
      }, stepDuration);

      console.log('âœ… Requests count rendered successfully');
    }

    // Render Appointments Count Display
    async function renderAppointmentsCount(data) {
      console.log('ðŸ“Š Rendering appointments count with', data.length, 'appointments');

      const countElement = document.getElementById('appointmentsCount');
      if (!countElement) {
        console.error('âŒ Count element not found: appointmentsCount');
        return;
      }

      // Animate the count
      const targetCount = data.length;
      let currentCount = 0;
      const duration = 1000; // 1 second
      const steps = 30;
      const increment = targetCount / steps;
      const stepDuration = duration / steps;

      const counter = setInterval(() => {
        currentCount += increment;
        if (currentCount >= targetCount) {
          countElement.textContent = targetCount.toLocaleString('de-DE');
          clearInterval(counter);
        } else {
          countElement.textContent = Math.floor(currentCount).toLocaleString('de-DE');
        }
      }, stepDuration);

      console.log('âœ… Appointments count rendered successfully');
    }

    // ========================================
    // DATE RANGE FILTER FUNCTIONS
    // ========================================

    // Get date range from filter
    function getDateRange() {
      const rangeFilter = document.getElementById('analyticsDateRangeFilter')?.value || 'all';
      const startDateInput = document.getElementById('analyticsStartDate')?.value;
      const endDateInput = document.getElementById('analyticsEndDate')?.value;

      const now = new Date();
      let startDate = null;
      let endDate = null;

      // If custom dates are set, use them
      if (startDateInput && endDateInput) {
        startDate = new Date(startDateInput);
        endDate = new Date(endDateInput);
        endDate.setHours(23, 59, 59, 999); // End of day
        console.log('ðŸ“… Using custom date range:', startDate, 'to', endDate);
        return { startDate, endDate };
      }

      // Otherwise use predefined ranges
      switch (rangeFilter) {
        case 'today':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
          break;
        case 'week':
          const dayOfWeek = now.getDay();
          const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday as first day
          startDate = new Date(now);
          startDate.setDate(now.getDate() - diff);
          startDate.setHours(0, 0, 0, 0);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'quarter':
          const currentQuarter = Math.floor(now.getMonth() / 3);
          startDate = new Date(now.getFullYear(), currentQuarter * 3, 1);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'year':
          startDate = new Date(now.getFullYear(), 0, 1);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'last30':
          startDate = new Date(now);
          startDate.setDate(now.getDate() - 30);
          startDate.setHours(0, 0, 0, 0);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'last90':
          startDate = new Date(now);
          startDate.setDate(now.getDate() - 90);
          startDate.setHours(0, 0, 0, 0);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'last365':
          startDate = new Date(now);
          startDate.setDate(now.getDate() - 365);
          startDate.setHours(0, 0, 0, 0);
          endDate = new Date(now);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'all':
        default:
          startDate = null;
          endDate = null;
          break;
      }

      if (startDate && endDate) {
        console.log('ðŸ“… Date range:', rangeFilter, '-', startDate.toLocaleDateString('de-DE'), 'to', endDate.toLocaleDateString('de-DE'));
      } else {
        console.log('ðŸ“… Date range: All time');
      }

      return { startDate, endDate };
    }

    // Filter data by date range
    function filterByDateRange(data, dateField = 'created_at') {
      const { startDate, endDate } = getDateRange();

      if (!startDate || !endDate) {
        return data; // No filter, return all data
      }

      return data.filter(item => {
        const itemDate = new Date(item[dateField]);
        if (isNaN(itemDate.getTime())) return false;
        return itemDate >= startDate && itemDate <= endDate;
      });
    }

    // Filter projects by revenue time range (separate from global filter)
    function filterProjectsByRevenueDateRange(projects, rangeType) {
      // Use cachedProjects if projects parameter is not provided or invalid
      const projectsToFilter = projects || cachedProjects;

      // Check if projects are loaded
      if (!projectsToFilter || projectsToFilter.length === 0) {
        console.warn('âš ï¸ No projects loaded yet for filtering');
        return [];
      }

      const now = new Date();
      let startDate = null;

      switch(rangeType) {
        case 'week': {
          // Start of current week (Monday)
          const day = now.getDay();
          const diff = now.getDate() - day + (day === 0 ? -6 : 1);
          startDate = new Date(now.getFullYear(), now.getMonth(), diff);
          startDate.setHours(0, 0, 0, 0);
          break;
        }
        case 'month': {
          // Start of current month
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          startDate.setHours(0, 0, 0, 0);
          break;
        }
        case 'year': {
          // Start of current year
          startDate = new Date(now.getFullYear(), 0, 1);
          startDate.setHours(0, 0, 0, 0);
          break;
        }
        case 'all':
        default:
          // No filtering, return all projects
          return projectsToFilter;
      }

      // Filter projects by created_at date
      return projectsToFilter.filter(project => {
        if (!project.created_at) return false;
        const projectDate = new Date(project.created_at);
        return projectDate >= startDate;
      });
    }

    // Filter requests/appointments by time range
    function filterByTimeRange(data, rangeType) {
      const now = new Date();
      let startDate = null;

      switch(rangeType) {
        case 'week': {
          // Start of current week (Monday)
          const day = now.getDay();
          const diff = now.getDate() - day + (day === 0 ? -6 : 1);
          startDate = new Date(now.getFullYear(), now.getMonth(), diff);
          startDate.setHours(0, 0, 0, 0);
          break;
        }
        case 'month': {
          // Start of current month
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          startDate.setHours(0, 0, 0, 0);
          break;
        }
        case 'year': {
          // Start of current year
          startDate = new Date(now.getFullYear(), 0, 1);
          startDate.setHours(0, 0, 0, 0);
          break;
        }
        case 'all':
        default:
          // No filtering, return all data
          return data;
      }

      // Filter by created_at date
      return data.filter(item => {
        if (!item.created_at) return false;
        const itemDate = new Date(item.created_at);
        return itemDate >= startDate;
      });
    }

    // ========================================
    // REVENUE ANALYTICS FUNCTIONS
    // ========================================

    // Global variable to cache projects for filtering
    let cachedProjects = [];

    // Load projects data for revenue analytics
    async function loadProjectsData(locationFilter = null) {
      console.log('ðŸ“Š Loading projects data from cache...');

      try {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // USE CENTRAL CACHE - Kein separates Loading!
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (!CentralDataManager.isReady()) {
          console.warn('âš ï¸ CentralDataManager not ready, waiting...');
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        // Get projects from cache
        let allProjects = CentralDataManager.getProjects();

        // Apply location filter if needed
        if (locationFilter && locationFilter !== 'all' && locationFilter !== null) {
          allProjects = allProjects.filter(p => p.location_id === locationFilter);
        }

        console.log(`âœ… Using ${allProjects.length} projects from cache`);

        // IMPORTANT: Store in global variable for filtering
        cachedProjects = allProjects;

        // Count by state
        const stateCounts = {
          'Aktiv': 0,
          'Unbekannt': 0,
          'Offen': 0,
          'other': 0
        };

        let totalRevenue = 0;
        let projectsWithPrice = 0;

        allProjects.forEach(project => {
          // Count by state
          if (stateCounts.hasOwnProperty(project.state)) {
            stateCounts[project.state]++;
          } else {
            stateCounts['other']++;
          }

          // Sum revenue
          if (project.price && project.price > 0) {
            totalRevenue += parseFloat(project.price);
            projectsWithPrice++;
          }
        });

        console.log('ðŸ“Š Project counts by state:', stateCounts);
        console.log('ðŸ’° Total revenue:', totalRevenue.toFixed(2), 'â‚¬');

        // Render projects table (optional)
        renderProjectsTable(allProjects, stateCounts, totalRevenue, projectsWithPrice);

        // Return data for other functions to use
        return allProjects;

      } catch (error) {
        console.error('âŒ Error loading projects:', error);
        return [];
      }
    }

    function renderProjectsTable(projects, stateCounts, totalRevenue, projectsWithPrice) {
      const container = document.getElementById('projectsTableContainer');

      if (!container) {
        // Container doesn't exist - this is OK, projects table is optional
        console.log('â„¹ï¸ Projects table container not found (optional feature)');
        return;
      }

      const total = projects.length;
      const avgRevenue = projectsWithPrice > 0 ? (totalRevenue / projectsWithPrice).toFixed(2) : 0;

      container.innerHTML = `
        <div style="margin-bottom: 24px;">
          <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 600;">
            Projects Overview
          </h3>
          <p style="margin: 0; font-size: 14px; color: #86868b;">
            ${total.toLocaleString('de-DE')} Total Projects
          </p>
        </div>

        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div style="background: #f5f5f7; padding: 20px; border-radius: 12px;">
            <div style="font-size: 13px; color: #86868b; margin-bottom: 4px;">Total Projects</div>
            <div style="font-size: 32px; font-weight: 700; color: #1d1d1f;">${total.toLocaleString('de-DE')}</div>
          </div>

          <div style="background: #f5f5f7; padding: 20px; border-radius: 12px;">
            <div style="font-size: 13px; color: #86868b; margin-bottom: 4px;">Total Revenue</div>
            <div style="font-size: 32px; font-weight: 700; color: #34C759;">${totalRevenue.toLocaleString('de-DE', {minimumFractionDigits: 2})} â‚¬</div>
          </div>

          <div style="background: #f5f5f7; padding: 20px; border-radius: 12px;">
            <div style="font-size: 13px; color: #86868b; margin-bottom: 4px;">Avg Revenue</div>
            <div style="font-size: 32px; font-weight: 700; color: #007AFF;">${avgRevenue.toLocaleString('de-DE')} â‚¬</div>
          </div>

          <div style="background: #f5f5f7; padding: 20px; border-radius: 12px;">
            <div style="font-size: 13px; color: #86868b; margin-bottom: 4px;">Active Projects</div>
            <div style="font-size: 32px; font-weight: 700; color: #FF9500;">${stateCounts['Aktiv'].toLocaleString('de-DE')}</div>
          </div>
        </div>

        <!-- Status Breakdown -->
        <div style="margin-bottom: 24px;">
          <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Project Status Breakdown</h4>

          <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
              <span>Aktiv</span>
              <span style="font-weight: 600;">${stateCounts['Aktiv'].toLocaleString('de-DE')} (${((stateCounts['Aktiv']/total)*100).toFixed(1)}%)</span>
            </div>
            <div style="height: 8px; background: #e5e5e7; border-radius: 4px; overflow: hidden;">
              <div style="height: 100%; background: #34C759; width: ${(stateCounts['Aktiv']/total)*100}%;"></div>
            </div>
          </div>

          <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
              <span>Unbekannt</span>
              <span style="font-weight: 600;">${stateCounts['Unbekannt'].toLocaleString('de-DE')} (${((stateCounts['Unbekannt']/total)*100).toFixed(1)}%)</span>
            </div>
            <div style="height: 8px; background: #e5e5e7; border-radius: 4px; overflow: hidden;">
              <div style="height: 100%; background: #8E8E93; width: ${(stateCounts['Unbekannt']/total)*100}%;"></div>
            </div>
          </div>

          <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
              <span>Offen</span>
              <span style="font-weight: 600;">${stateCounts['Offen'].toLocaleString('de-DE')} (${((stateCounts['Offen']/total)*100).toFixed(1)}%)</span>
            </div>
            <div style="height: 8px; background: #e5e5e7; border-radius: 4px; overflow: hidden;">
              <div style="height: 100%; background: #FFA500; width: ${(stateCounts['Offen']/total)*100}%;"></div>
            </div>
          </div>
        </div>
      `;
    }

    // Render Revenue Statistics
    async function renderRevenueStats(projects) {
      console.log('ðŸ’° Rendering revenue statistics with', projects.length, 'projects');

      // Initialize stats
      const stats = {
        'Komplett bezahlt': { count: 0, revenue: 0 },
        'Offen': { count: 0, revenue: 0 },
        'Anzahlung bezahlt': { count: 0, revenue: 0 },
        'Unbekannt': { count: 0, revenue: 0 }
      };

      // Process each project
      projects.forEach(project => {
        const price = parseFloat(project.price) || 0;
        const paymentState = (project.payment_state || '').trim();

        // Determine category
        let category = 'Unbekannt';

        const stateLower = paymentState.toLowerCase();

        if (stateLower.includes('komplett bezahlt') || stateLower === 'komplett bezahlt') {
          category = 'Komplett bezahlt';
        } else if (stateLower.includes('anzahlung bezahlt') || stateLower === 'anzahlung bezahlt') {
          category = 'Anzahlung bezahlt';
        } else if (stateLower.includes('offen') || stateLower === 'offen') {
          category = 'Offen';
        }

        if (stats[category]) {
          stats[category].count++;
          stats[category].revenue += price;
        }
      });

      // Calculate GESAMT UMSATZ (only "Komplett bezahlt")
      const gesamtUmsatz = stats['Komplett bezahlt'].revenue;
      const totalCount = Object.values(stats).reduce((sum, s) => sum + s.count, 0);

      console.log('ðŸ’° Revenue breakdown:', {
        'Komplett bezahlt': `${stats['Komplett bezahlt'].revenue.toFixed(2)} â‚¬ (${stats['Komplett bezahlt'].count} projects)`,
        'Anzahlung bezahlt': `${stats['Anzahlung bezahlt'].revenue.toFixed(2)} â‚¬ (${stats['Anzahlung bezahlt'].count} projects)`,
        'Offen': `${stats['Offen'].revenue.toFixed(2)} â‚¬ (${stats['Offen'].count} projects)`,
        'Unbekannt': `${stats['Unbekannt'].revenue.toFixed(2)} â‚¬ (${stats['Unbekannt'].count} projects)`
      });
      console.log(`ðŸ’° GESAMT UMSATZ (nur Komplett bezahlt): ${gesamtUmsatz.toFixed(2)} â‚¬`);

      // Update DOM - Main totalRevenue shows GESAMT UMSATZ
      const totalRevenueEl = document.getElementById('totalRevenue');
      if (totalRevenueEl) {
        totalRevenueEl.textContent = gesamtUmsatz.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }

      // Update DOM - Paid Projects shows "Komplett bezahlt"
      const paidProjectsEl = document.getElementById('paidProjects');
      if (paidProjectsEl) {
        paidProjectsEl.textContent = stats['Komplett bezahlt'].count;
      }

      // Update DOM - Pending Revenue shows "Offen"
      const pendingRevenueEl = document.getElementById('pendingRevenue');
      if (pendingRevenueEl) {
        pendingRevenueEl.textContent = stats['Offen'].revenue.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }

      // Update DOM - Average Price
      const avgProjectPriceEl = document.getElementById('avgProjectPrice');
      if (avgProjectPriceEl && totalCount > 0) {
        const totalRevenue = Object.values(stats).reduce((sum, s) => sum + s.revenue, 0);
        const avgPrice = totalRevenue / totalCount;
        avgProjectPriceEl.textContent = avgPrice.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }

      // Update DOM - Total Projects
      const totalProjectsEl = document.getElementById('totalProjects');
      if (totalProjectsEl) {
        totalProjectsEl.textContent = totalCount;
      }

      // Update additional elements if they exist
      const vollbezahltAmount = document.getElementById('vollbezahltAmount');
      const vollbezahltCount = document.getElementById('vollbezahltCount');
      if (vollbezahltAmount) {
        vollbezahltAmount.textContent = stats['Komplett bezahlt'].revenue.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }
      if (vollbezahltCount) {
        vollbezahltCount.textContent = stats['Komplett bezahlt'].count + ' Projekte';
      }

      const offenAmount = document.getElementById('offenAmount');
      const offenCount = document.getElementById('offenCount');
      if (offenAmount) {
        offenAmount.textContent = stats['Offen'].revenue.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }
      if (offenCount) {
        offenCount.textContent = stats['Offen'].count + ' Projekte';
      }

      const anzahlungAmount = document.getElementById('anzahlungAmount');
      const anzahlungCount = document.getElementById('anzahlungCount');
      if (anzahlungAmount) {
        anzahlungAmount.textContent = stats['Anzahlung bezahlt'].revenue.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }
      if (anzahlungCount) {
        anzahlungCount.textContent = stats['Anzahlung bezahlt'].count + ' Projekte';
      }

      const gesamtUmsatzElement = document.getElementById('gesamtUmsatz');
      if (gesamtUmsatzElement) {
        gesamtUmsatzElement.textContent = gesamtUmsatz.toLocaleString('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }) + ' â‚¬';
      }

      // Update table rows if they exist
      updateRevenueTable(stats, gesamtUmsatz);

      console.log('âœ… Revenue stats rendered successfully');
    }

    // Helper function to update the revenue table
    function updateRevenueTable(stats, gesamtUmsatz) {
      // Find table rows and update them
      const rows = document.querySelectorAll('[data-payment-status]');

      rows.forEach(row => {
        const status = row.getAttribute('data-payment-status');

        if (stats[status]) {
          const countCell = row.querySelector('.count-cell');
          const revenueCell = row.querySelector('.revenue-cell');
          const avgCell = row.querySelector('.avg-cell');
          const percentCell = row.querySelector('.percent-cell');

          if (countCell) countCell.textContent = stats[status].count;
          if (revenueCell) {
            revenueCell.textContent = stats[status].revenue.toLocaleString('de-DE', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            }) + ' â‚¬';
          }
          if (avgCell && stats[status].count > 0) {
            const avg = stats[status].revenue / stats[status].count;
            avgCell.textContent = avg.toLocaleString('de-DE', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            }) + ' â‚¬';
          }
          if (percentCell && gesamtUmsatz > 0) {
            const percent = (stats[status].revenue / gesamtUmsatz * 100).toFixed(1);
            percentCell.textContent = percent + ' %';
          }
        }
      });

      // Update GESAMT row
      const gesamtRow = document.querySelector('[data-payment-status="Gesamt"]');
      if (gesamtRow) {
        const totalCount = Object.values(stats).reduce((sum, s) => sum + s.count, 0);
        const totalRevenue = Object.values(stats).reduce((sum, s) => sum + s.revenue, 0);

        const countCell = gesamtRow.querySelector('.count-cell');
        const revenueCell = gesamtRow.querySelector('.revenue-cell');
        const avgCell = gesamtRow.querySelector('.avg-cell');
        const percentCell = gesamtRow.querySelector('.percent-cell');

        if (countCell) countCell.textContent = totalCount;
        if (revenueCell) {
          revenueCell.textContent = totalRevenue.toLocaleString('de-DE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }) + ' â‚¬';
        }
        if (avgCell && totalCount > 0) {
          const avg = totalRevenue / totalCount;
          avgCell.textContent = avg.toLocaleString('de-DE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }) + ' â‚¬';
        }
        if (percentCell) {
          percentCell.textContent = '100 %';
        }
      }
    }

    // Render Revenue Timeline Chart
    async function renderRevenueTimeline(data) {
      console.log('ðŸ’° Rendering revenue timeline with', data.length, 'projects');

      if (data.length === 0) {
        console.warn('âš ï¸ No data for revenue timeline');
        return;
      }

      // Group by month
      const monthlyRevenue = {};

      data.forEach(project => {
        const date = new Date(project.created_at);
        if (isNaN(date.getTime())) return;

        const key = date.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
        const price = parseFloat(project.price) || 0;

        if (!monthlyRevenue[key]) {
          monthlyRevenue[key] = { total: 0, count: 0 };
        }

        monthlyRevenue[key].total += price;
        monthlyRevenue[key].count += 1;
      });

      // Sort by date
      const sortedKeys = Object.keys(monthlyRevenue).sort((a, b) => {
        return new Date(a) - new Date(b);
      });

      // Take last 12 months
      const last12Months = sortedKeys.slice(-12);

      const chartData = {
        labels: last12Months,
        datasets: [{
          label: 'Umsatz (â‚¬)',
          data: last12Months.map(key => monthlyRevenue[key].total),
          borderColor: '#0071e3',
          backgroundColor: 'rgba(0, 113, 227, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: '#0071e3',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointHoverRadius: 6
        }]
      };

      // Destroy existing chart
      if (revenueTimelineChart) {
        revenueTimelineChart.destroy();
      }

      const ctx = document.getElementById('revenueTimeline');
      if (!ctx) {
        console.error('âŒ Canvas element not found: revenueTimeline');
        return;
      }

      revenueTimelineChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  const key = context.label;
                  const count = monthlyRevenue[key]?.count || 0;
                  return [
                    `Umsatz: â‚¬${value.toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`,
                    `Projekte: ${count}`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'â‚¬' + value.toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                },
                font: {
                  size: 11,
                  family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
                }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });

      console.log('âœ… Revenue timeline chart rendered successfully');
    }

    // Group appointments data by time range (uses created_at)
    function groupDataByTimeRange(data, range) {
      const now = new Date();
      const groups = {};

      console.log('ðŸ“… Grouping', data.length, 'appointments by range:', range);
      console.log('ðŸ“… Current date:', now.toLocaleDateString('de-DE'));

      // DEBUG counters
      let validDates = 0;
      let invalidDates = 0;
      let outOfRange = 0;

      data.forEach((appointment, index) => {
        // Use created_at to track when bookings were made
        const date = new Date(appointment.created_at);

        // Check if date is valid
        if (isNaN(date.getTime())) {
          invalidDates++;
          if (index < 5) {
            console.warn('âš ï¸ Invalid date found:', appointment.created_at);
          }
          return;
        }

        validDates++;
        let key;

        switch(range) {
          case 'weekly':
            // Last 12 weeks (84 days)
            if (date >= new Date(now - 12 * 7 * 24 * 60 * 60 * 1000)) {
              key = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            } else {
              outOfRange++;
            }
            break;

          case 'monthly':
            // Last 12 months (365 days)
            if (date >= new Date(now - 365 * 24 * 60 * 60 * 1000)) {
              key = date.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
            } else {
              outOfRange++;
            }
            break;

          case 'yearly':
            // Last 3 years (1095 days), grouped by month
            if (date >= new Date(now - 3 * 365 * 24 * 60 * 60 * 1000)) {
              key = date.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
            } else {
              outOfRange++;
            }
            break;

          case 'all':
            // All time, grouped by month
            key = date.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
            break;
        }

        if (key) {
          groups[key] = (groups[key] || 0) + 1;
        }
      });

      console.log('ðŸ“Š Grouping stats:', {
        validDates,
        invalidDates,
        outOfRange,
        groupsCreated: Object.keys(groups).length
      });

      // Sort keys chronologically
      const sortedKeys = Object.keys(groups).sort((a, b) => {
        const parseDate = (str) => {
          if (str.includes('.')) {
            // Format: "09.11"
            const [day, month] = str.split('.');
            return new Date(now.getFullYear(), parseInt(month) - 1, parseInt(day));
          } else {
            // Format: "Nov 2025"
            return new Date(str);
          }
        };
        return parseDate(a) - parseDate(b);
      });

      console.log('âœ… Grouped into', sortedKeys.length, 'time buckets');

      // DEBUG: Show first few groups
      if (sortedKeys.length > 0) {
        const sampleGroups = sortedKeys.slice(0, 5).map(k => `${k}: ${groups[k]}`);
        console.log('ðŸ“Š Sample groups:', sampleGroups);
        console.log('ðŸ“Š Total appointments in groups:', sortedKeys.reduce((sum, k) => sum + groups[k], 0));
      }

      return {
        labels: sortedKeys,
        values: sortedKeys.map(k => groups[k])
      };
    }

    // Render Line Chart for Bookings Timeline
    async function renderBookingsTimeline(data, timeRange = 'weekly') {
      console.log('ðŸ“Š Rendering timeline chart for range:', timeRange);

      currentTimeRange = timeRange;

      // Group data by time range
      const groupedData = groupDataByTimeRange(data, timeRange);

      console.log('ðŸ“ˆ Timeline data points:', groupedData.labels.length);

      const chartData = {
        labels: groupedData.labels,
        datasets: [{
          label: 'Bookings',
          data: groupedData.values,
          borderColor: '#0071e3',
          backgroundColor: 'rgba(0,113,227,0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6,
          pointBackgroundColor: '#0071e3',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        }]
      };

      // Destroy existing chart
      if (timelineChart) {
        timelineChart.destroy();
      }

      const ctx = document.getElementById('bookingsTimeline');
      if (!ctx) {
        console.error('âŒ Canvas element not found: bookingsTimeline');
        return;
      }

      timelineChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(29,29,31,0.95)',
              padding: 12,
              cornerRadius: 8,
              titleFont: {
                size: 13,
                weight: '600'
              },
              bodyFont: {
                size: 12
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                font: {
                  size: 11
                }
              },
              grid: {
                color: 'rgba(0,0,0,0.06)'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11
                },
                maxRotation: 45,
                minRotation: 0
              },
              grid: {
                display: false
              }
            }
          }
        }
      });

      console.log('âœ… Timeline chart rendered successfully');
    }

    // Test Supabase connection and tables
    async function testSupabaseConnection() {
      console.log('ðŸ§ª Testing Supabase connection...');

      try {
        // Test 1: Check requests table
        console.log('ðŸ§ª Test 1: Checking requests table...');
        const { data: testRequests, error: reqError } = await supabase
          .from('requests')
          .select('id')
          .limit(1);

        if (reqError) {
          console.error('âŒ Requests table error:', reqError);
        } else {
          console.log('âœ… Requests table accessible:', testRequests?.length || 0, 'records');
        }

        // Test 2: Check appointments table
        console.log('ðŸ§ª Test 2: Checking appointments table...');
        const { data: testAppointments, error: aptError } = await supabase
          .from('appointments')
          .select('id')
          .limit(1);

        if (aptError) {
          console.error('âŒ Appointments table error:', aptError);
        } else {
          console.log('âœ… Appointments table accessible:', testAppointments?.length || 0, 'records');
        }

        // Test 3: Count total records
        console.log('ðŸ§ª Test 3: Counting total records...');
        const { count: reqCount } = await supabase
          .from('requests')
          .select('*', { count: 'exact', head: true });

        const { count: aptCount } = await supabase
          .from('appointments')
          .select('*', { count: 'exact', head: true });

        console.log('ðŸ“Š Total requests:', reqCount || 0);
        console.log('ðŸ“Š Total appointments:', aptCount || 0);

        // Test 4: Analyze appointment status distribution (if table not empty)
        if (aptCount > 0) {
          console.log('ðŸ§ª Test 4: Analyzing appointment status distribution...');
          const { data: statusSample } = await supabase
            .from('appointments')
            .select('status')
            .limit(1000); // Sample first 1000

          if (statusSample && statusSample.length > 0) {
            const statusCounts = {};
            statusSample.forEach(apt => {
              const status = apt.status || 'null';
              statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            console.log('ðŸ“Š Status distribution (sample of', statusSample.length, 'appointments):', statusCounts);
            console.log('ðŸ“Š Available statuses:', Object.keys(statusCounts).join(', '));

            // Check if we have the expected statuses
            const hasScheduled = statusCounts['scheduled'] || statusCounts['Scheduled'];
            const hasFinished = statusCounts['finished'] || statusCounts['Finished'] || statusCounts['completed'];

            if (!hasScheduled && !hasFinished) {
              console.warn('âš ï¸ WARNING: No appointments with status "scheduled" or "finished" found!');
              console.warn('âš ï¸ Timeline will use ALL appointments regardless of status');
            }
          }
        } else {
          console.warn('âš ï¸ Appointments table is empty - Timeline will show no data');
        }

        return true;
      } catch (err) {
        console.error('âŒ Supabase connection test failed:', err);
        return false;
      }
    }

    // ============================================
    // LOAD ANALYTICS - COMPLETE DATA
    // ============================================
    async function loadAnalytics() {
      console.log('ðŸ“Š Loading Analytics Page...');
      console.log('ðŸ“Š ANALYTICS VERSION: 2025-11-15 - Complete Fix');

      try {
        // Show progress bar
        ProgressBar.show('Starting to load analytics data...');

        // Show loading state
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          analyticsContent.innerHTML = '<div style="text-align:center; padding:40px;"><div class="spinner"></div><p>Loading analytics data...</p></div>';
        }

        ProgressBar.updateProgress(10, 'Loading requests...');

        // Load ALL requests (no pagination limit)
        console.log('ðŸ“¥ Loading all requests for analytics...');
        let allRequests = [];
        let page = 0;
        const pageSize = 1000;
        let hasMore = true;

        while (hasMore) {
          const { data: requestsBatch, error: reqError } = await supabase
            .from('requests')
            .select('*')
            .order('created_at', { ascending: false })
            .range(page * pageSize, (page + 1) * pageSize - 1);

          if (reqError) {
            console.error('Error loading requests batch:', reqError);
            break;
          }

          if (requestsBatch && requestsBatch.length > 0) {
            allRequests = [...allRequests, ...requestsBatch];
            // Update progress during request loading (10% to 35%)
            const requestProgress = 10 + (25 * Math.min(page / 10, 1));
            ProgressBar.updateProgress(requestProgress, `Loading requests (${allRequests.length} loaded)...`);

            if (page % 5 === 0) { // Log every 5 batches
              console.log(`  â†³ Loaded ${allRequests.length} requests so far...`);
            }

            if (requestsBatch.length < pageSize) {
              hasMore = false;
            } else {
              page++;
            }
          } else {
            hasMore = false;
          }
        }

        console.log(`âœ… Loaded ${allRequests.length} total requests`);
        ProgressBar.updateProgress(40, `Loaded ${allRequests.length} requests. Loading appointments...`);

        // Load ALL appointments (no pagination limit)
        console.log('ðŸ“¥ Loading all appointments for analytics...');
        let allAppointments = [];
        page = 0;
        hasMore = true;

        while (hasMore) {
          const { data: appointmentsBatch, error: aptError } = await supabase
            .from('appointments')
            .select('*')
            .order('created_at', { ascending: false })
            .range(page * pageSize, (page + 1) * pageSize - 1);

          if (aptError) {
            console.error('Error loading appointments batch:', aptError);
            break;
          }

          if (appointmentsBatch && appointmentsBatch.length > 0) {
            allAppointments = [...allAppointments, ...appointmentsBatch];
            // Update progress during appointment loading (40% to 65%)
            const appointmentProgress = 40 + (25 * Math.min(page / 10, 1));
            ProgressBar.updateProgress(appointmentProgress, `Loading appointments (${allAppointments.length} loaded)...`);

            if (page % 5 === 0) { // Log every 5 batches
              console.log(`  â†³ Loaded ${allAppointments.length} appointments so far...`);
            }

            if (appointmentsBatch.length < pageSize) {
              hasMore = false;
            } else {
              page++;
            }
          } else {
            hasMore = false;
          }
        }

        console.log(`âœ… Loaded ${allAppointments.length} total appointments`);
        ProgressBar.updateProgress(70, 'Calculating analytics...');

        // Calculate analytics data
        console.log('ðŸ“Š Calculating analytics...');

        // Request status breakdown
        const requestStatusCounts = {
          archived: 0,
          finished: 0,
          open_request: 0,
          scheduled: 0,
          canceled: 0,
          pending: 0
        };

        allRequests.forEach(req => {
          const status = req.status || 'unknown';
          if (requestStatusCounts.hasOwnProperty(status)) {
            requestStatusCounts[status]++;
          } else {
            requestStatusCounts[status] = 1;
          }
        });

        // Appointment status breakdown
        const appointmentStatusCounts = {
          finished: 0,
          scheduled: 0,
          no_show: 0,
          rescheduled: 0,
          canceled: 0,
          unknown: 0
        };

        allAppointments.forEach(apt => {
          const status = apt.status || 'unknown';
          if (appointmentStatusCounts.hasOwnProperty(status)) {
            appointmentStatusCounts[status]++;
          } else {
            appointmentStatusCounts[status] = 1;
          }
        });

        // Filter by current time range (from analytics page filter)
        const timeRangeFilter = document.getElementById('analyticsTimeRange')?.value || 'all';
        const locationFilter = document.getElementById('analyticsLocationFilter')?.value || '';

        let filteredRequests = allRequests;
        let filteredAppointments = allAppointments;

        // Apply location filter
        if (locationFilter && locationFilter !== '') {
          filteredRequests = filteredRequests.filter(req => req.location_id === locationFilter);
          filteredAppointments = filteredAppointments.filter(apt => apt.location_id === locationFilter);
        }

        // Apply time range filter
        if (timeRangeFilter !== 'all') {
          const now = new Date();
          let startDate = null;

          switch(timeRangeFilter) {
            case 'week':
              const day = now.getDay();
              const diff = now.getDate() - day + (day === 0 ? -6 : 1);
              startDate = new Date(now.getFullYear(), now.getMonth(), diff);
              startDate.setHours(0, 0, 0, 0);
              break;
            case 'month':
              startDate = new Date(now.getFullYear(), now.getMonth(), 1);
              startDate.setHours(0, 0, 0, 0);
              break;
            case 'year':
              startDate = new Date(now.getFullYear(), 0, 1);
              startDate.setHours(0, 0, 0, 0);
              break;
          }

          if (startDate) {
            filteredRequests = filteredRequests.filter(req => {
              const reqDate = new Date(req.created_at);
              return reqDate >= startDate;
            });

            filteredAppointments = filteredAppointments.filter(apt => {
              const aptDate = new Date(apt.created_at);
              return aptDate >= startDate;
            });
          }
        }

        // Calculate project metrics
        ProgressBar.updateProgress(75, 'Calculating metrics...');
        const projectMetrics = window.calculateProjectMetrics(allRequests, allAppointments);

        // Render analytics sections
        ProgressBar.updateProgress(80, 'Rendering charts...');
        console.log('ðŸŽ¨ Rendering analytics sections...');

        renderRequestsOverview(filteredRequests, filteredAppointments);
        ProgressBar.updateProgress(85, 'Rendering status breakdowns...');
        renderRequestStatusBreakdown(allRequests, requestStatusCounts);
        renderAppointmentStatusBreakdown(allAppointments, appointmentStatusCounts);
        ProgressBar.updateProgress(90, 'Rendering revenue data...');
        renderRevenueOverview(allRequests, allAppointments);
        renderRevenueTimeline(allRequests);
        ProgressBar.updateProgress(95, 'Finalizing charts...');
        renderAppointmentsByArtist(allAppointments);
        renderRevenueByPaymentStatus(allRequests);
        renderProjectAnalytics(projectMetrics);
        renderArtistPerformance(allAppointments);
        renderVIPCustomers(allRequests);

        console.log('âœ… Analytics page loaded successfully');
        ProgressBar.hide();

      } catch (error) {
        console.error('âŒ Error loading analytics:', error);
        ProgressBar.hide();
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          analyticsContent.innerHTML = `
            <div style="text-align:center; padding:40px;">
              <p style="color:var(--error); font-size:18px; margin-bottom:10px;">âš ï¸ Error Loading Analytics</p>
              <p style="color:var(--muted); font-size:14px;">${error.message}</p>
              <button onclick="loadAnalytics()" style="margin-top:20px; padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">
                Retry
              </button>
            </div>
          `;
        }
      }
    }

    // ============================================
    // RENDER REQUESTS OVERVIEW
    // ============================================
    function renderRequestsOverview(requests, appointments) {
      const totalRequests = requests.length;
      const customerRequests = requests.filter(r =>
        r.booking_type !== 'internal' && r.booking_type !== 'reserved'
      ).length;
      const totalAppointments = appointments.length;
      const scheduledAppointments = appointments.filter(a => a.status === 'scheduled').length;

      const overviewHTML = `
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:30px;">
          <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Total Requests</div>
            <div style="font-size:32px; font-weight:600; color:var(--primary);">${totalRequests.toLocaleString()}</div>
          </div>
          <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Customer Requests</div>
            <div style="font-size:32px; font-weight:600; color:var(--primary);">${customerRequests.toLocaleString()}</div>
          </div>
          <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Total Appointments</div>
            <div style="font-size:32px; font-weight:600; color:var(--success);">${totalAppointments.toLocaleString()}</div>
          </div>
          <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Scheduled Appointments</div>
            <div style="font-size:32px; font-weight:600; color:var(--success);">${scheduledAppointments.toLocaleString()}</div>
          </div>
        </div>
      `;

      // Find or create overview container
      let container = document.getElementById('requestsOverviewContainer');
      if (!container) {
        // Insert at the top of analytics content
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'requestsOverviewContainer';
          analyticsContent.insertBefore(container, analyticsContent.firstChild);
        }
      }

      if (container) {
        container.innerHTML = overviewHTML;
      }
    }

    // ============================================
    // RENDER REQUEST STATUS BREAKDOWN
    // ============================================
    function renderRequestStatusBreakdown(requests, statusCounts) {
      const total = requests.length;

      const breakdownHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">Request Status Breakdown</h3>
          <p style="color:var(--muted); margin-bottom:20px;">${total.toLocaleString()} Total Requests</p>

          <!-- Pie Chart -->
          <div style="position: relative; width: 300px; max-width: 100%; height: 300px; margin: 0 auto 30px;">
            <canvas id="analyticsRequestStatusPieCanvas" width="300" height="300"></canvas>
          </div>

          <!-- Bullet Point List -->
          <div style="display:flex; flex-direction:column; gap:12px;">
            ${Object.entries(statusCounts).map(([status, count]) => {
              const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
              const color = getStatusColor(status);
              return `
                <div style="display:flex; align-items:center; gap:12px;">
                  <div style="width:12px; height:12px; border-radius:50%; background:${color};"></div>
                  <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                      <span style="font-weight:500; text-transform:capitalize;">${formatStatusName(status)}: ${count.toLocaleString()}</span>
                      <span style="color:var(--muted);">(${percentage}%)</span>
                    </div>
                    <div style="height:8px; background:#f0f0f0; border-radius:4px; overflow:hidden;">
                      <div style="height:100%; background:${color}; width:${percentage}%;"></div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      let container = document.getElementById('requestStatusBreakdownContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'requestStatusBreakdownContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = breakdownHTML;

        // Create pie chart after DOM is updated
        requestAnimationFrame(() => {
          const canvas = document.getElementById('analyticsRequestStatusPieCanvas');
          if (!canvas) {
            console.error('âŒ Analytics request status pie canvas not found');
            return;
          }

          // Prepare data for chart
          const chartData = Object.entries(statusCounts)
            .filter(([_, count]) => count > 0)
            .map(([status, count]) => ({
              label: formatStatusName(status),
              count: count,
              color: getStatusColor(status)
            }))
            .sort((a, b) => b.count - a.count);

          console.log('âœ… Creating analytics request status pie chart with', chartData.length, 'segments');

          try {
            new Chart(canvas, {
              type: 'pie',
              data: {
                labels: chartData.map(d => d.label),
                datasets: [{
                  data: chartData.map(d => d.count),
                  backgroundColor: chartData.map(d => d.color),
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${label}: ${value.toLocaleString('de-DE')} (${percentage}%)`;
                      }
                    }
                  }
                }
              }
            });
            console.log('âœ… Analytics request status pie chart created successfully');
          } catch (error) {
            console.error('âŒ Error creating analytics request status pie chart:', error);
          }
        });
      }
    }

    // ============================================
    // RENDER APPOINTMENT STATUS BREAKDOWN
    // ============================================
    function renderAppointmentStatusBreakdown(appointments, statusCounts) {
      const total = appointments.length;

      const breakdownHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">Appointment Status Breakdown</h3>
          <p style="color:var(--muted); margin-bottom:20px;">${total.toLocaleString()} Total Appointments</p>

          <!-- Pie Chart -->
          <div style="position: relative; width: 300px; max-width: 100%; height: 300px; margin: 0 auto 30px;">
            <canvas id="analyticsAppointmentStatusPieCanvas" width="300" height="300"></canvas>
          </div>

          <!-- Bullet Point List -->
          <div style="display:flex; flex-direction:column; gap:12px;">
            ${Object.entries(statusCounts).map(([status, count]) => {
              const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
              const color = getStatusColor(status);
              return `
                <div style="display:flex; align-items:center; gap:12px;">
                  <div style="width:12px; height:12px; border-radius:50%; background:${color};"></div>
                  <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                      <span style="font-weight:500; text-transform:capitalize;">${formatStatusName(status)}: ${count.toLocaleString()}</span>
                      <span style="color:var(--muted);">(${percentage}%)</span>
                    </div>
                    <div style="height:8px; background:#f0f0f0; border-radius:4px; overflow:hidden;">
                      <div style="height:100%; background:${color}; width:${percentage}%;"></div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      let container = document.getElementById('appointmentStatusBreakdownContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'appointmentStatusBreakdownContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = breakdownHTML;

        // Create pie chart after DOM is updated
        requestAnimationFrame(() => {
          const canvas = document.getElementById('analyticsAppointmentStatusPieCanvas');
          if (!canvas) {
            console.error('âŒ Analytics appointment status pie canvas not found');
            return;
          }

          // Prepare data for chart
          const chartData = Object.entries(statusCounts)
            .filter(([_, count]) => count > 0)
            .map(([status, count]) => ({
              label: formatStatusName(status),
              count: count,
              color: getStatusColor(status)
            }))
            .sort((a, b) => b.count - a.count);

          console.log('âœ… Creating analytics appointment status pie chart with', chartData.length, 'segments');

          try {
            new Chart(canvas, {
              type: 'pie',
              data: {
                labels: chartData.map(d => d.label),
                datasets: [{
                  data: chartData.map(d => d.count),
                  backgroundColor: chartData.map(d => d.color),
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${label}: ${value.toLocaleString('de-DE')} (${percentage}%)`;
                      }
                    }
                  }
                }
              }
            });
            console.log('âœ… Analytics appointment status pie chart created successfully');
          } catch (error) {
            console.error('âŒ Error creating analytics appointment status pie chart:', error);
          }
        });
      }
    }

    // ============================================
    // RENDER REVENUE OVERVIEW
    // ============================================
    function renderRevenueOverview(requests, appointments) {
      // Calculate revenue from requests
      const requestsWithPrice = requests.filter(r => r.total_amount && r.payment_status === 'fully_paid');
      const requestRevenue = requestsWithPrice.reduce((sum, r) => sum + (parseFloat(r.total_amount) || 0), 0);

      // Calculate revenue from appointments
      const appointmentsWithPrice = appointments.filter(a => a.price && a.payment_status === 'fully_paid');
      const appointmentRevenue = appointmentsWithPrice.reduce((sum, a) => sum + (parseFloat(a.price) || 0), 0);

      const totalRevenue = requestRevenue + appointmentRevenue;
      const paidProjects = requestsWithPrice.length + appointmentsWithPrice.length;

      const overviewHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">Umsatz-Ãœbersicht</h3>

          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Gesamtumsatz</div>
              <div style="font-size:28px; font-weight:600; color:var(--success);">
                â‚¬${totalRevenue.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
              </div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Bezahlte Projekte</div>
              <div style="font-size:28px; font-weight:600; color:var(--primary);">
                ${paidProjects.toLocaleString()}
              </div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Ausstehend</div>
              <div style="font-size:28px; font-weight:600; color:var(--warning);">
                â‚¬${(0).toLocaleString('de-DE', { minimumFractionDigits: 2 })}
              </div>
            </div>
          </div>
        </div>
      `;

      let container = document.getElementById('revenueOverviewContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'revenueOverviewContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = overviewHTML;
      }
    }

    // ============================================
    // RENDER APPOINTMENTS BY ARTIST
    // ============================================
    function renderAppointmentsByArtist(appointments) {
      // Group by artist
      const artistMap = new Map();

      appointments.forEach(apt => {
        if (!apt.artist_id) return;

        const artistName = apt.artist_name || 'Unknown Artist';
        if (!artistMap.has(artistName)) {
          artistMap.set(artistName, {
            name: artistName,
            total: 0,
            finished: 0,
            scheduled: 0,
            noShow: 0
          });
        }

        const artist = artistMap.get(artistName);
        artist.total++;
        if (apt.status === 'finished') artist.finished++;
        if (apt.status === 'scheduled') artist.scheduled++;
        if (apt.status === 'no_show') artist.noShow++;
      });

      const artists = Array.from(artistMap.values())
        .sort((a, b) => b.total - a.total)
        .slice(0, 10); // Top 10

      const appointmentsHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">Appointments nach Resident Artist</h3>

          <div style="display:flex; gap:30px; margin-bottom:20px;">
            <div>
              <div style="font-size:14px; color:var(--muted);">Total Appointments</div>
              <div style="font-size:24px; font-weight:600;">${appointments.length.toLocaleString()}</div>
            </div>
            <div>
              <div style="font-size:14px; color:var(--muted);">Ungesetzte Termine</div>
              <div style="font-size:24px; font-weight:600;">
                ${appointments.filter(a => !a.artist_id).length.toLocaleString()}
                <span style="font-size:14px; color:var(--muted);">
                  (${appointments.length > 0 ? ((appointments.filter(a => !a.artist_id).length / appointments.length) * 100).toFixed(0) : 0}%)
                </span>
              </div>
            </div>
            <div>
              <div style="font-size:14px; color:var(--muted);">Nicht umgesetzt</div>
              <div style="font-size:24px; font-weight:600;">0 <span style="font-size:14px; color:var(--muted);">(0%)</span></div>
            </div>
            <div>
              <div style="font-size:14px; color:var(--muted);">Belegbar</div>
              <div style="font-size:24px; font-weight:600;">0 <span style="font-size:14px; color:var(--muted);">(0%)</span></div>
            </div>
          </div>

          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:2px solid #e0e0e0;">
                <th style="text-align:left; padding:12px 8px; font-weight:600;">Artist</th>
                <th style="text-align:right; padding:12px 8px; font-weight:600;">Total</th>
                <th style="text-align:right; padding:12px 8px; font-weight:600;">Finished</th>
                <th style="text-align:right; padding:12px 8px; font-weight:600;">Scheduled</th>
                <th style="text-align:right; padding:12px 8px; font-weight:600;">No Show</th>
              </tr>
            </thead>
            <tbody>
              ${artists.map(artist => `
                <tr style="border-bottom:1px solid #f0f0f0;">
                  <td style="padding:12px 8px;">${artist.name}</td>
                  <td style="text-align:right; padding:12px 8px; font-weight:600;">${artist.total}</td>
                  <td style="text-align:right; padding:12px 8px;">${artist.finished}</td>
                  <td style="text-align:right; padding:12px 8px;">${artist.scheduled}</td>
                  <td style="text-align:right; padding:12px 8px;">${artist.noShow}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      let container = document.getElementById('appointmentsByArtistContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'appointmentsByArtistContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = appointmentsHTML;
      }
    }

    // ============================================
    // RENDER REVENUE BY PAYMENT STATUS
    // ============================================
    function renderRevenueByPaymentStatus(requests) {
      const paymentGroups = {
        'Komplett bezahlt': { count: 0, revenue: 0 },
        'Offen': { count: 0, revenue: 0 },
        'Anzahlung bezahlt': { count: 0, revenue: 0 }
      };

      requests.forEach(req => {
        if (!req.total_amount) return;

        const amount = parseFloat(req.total_amount) || 0;

        if (req.payment_status === 'fully_paid') {
          paymentGroups['Komplett bezahlt'].count++;
          paymentGroups['Komplett bezahlt'].revenue += amount;
        } else if (req.payment_status === 'deposit_paid') {
          paymentGroups['Anzahlung bezahlt'].count++;
          paymentGroups['Anzahlung bezahlt'].revenue += amount;
        } else {
          paymentGroups['Offen'].count++;
          paymentGroups['Offen'].revenue += amount;
        }
      });

      const total = Object.values(paymentGroups).reduce((sum, g) => sum + g.revenue, 0);

      const paymentHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">Umsatz nach Zahlungsstatus</h3>

          <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; margin-bottom:20px;">
            ${Object.entries(paymentGroups).map(([status, data]) => {
              const bgColor = status === 'Komplett bezahlt' ? '#d4edda' :
                             status === 'Anzahlung bezahlt' ? '#fff3cd' : '#f8d7da';
              return `
                <div style="text-align:center; padding:20px; background:${bgColor}; border-radius:8px;">
                  <div style="font-size:14px; margin-bottom:8px;">ðŸ’° ${status}</div>
                  <div style="font-size:24px; font-weight:600; margin-bottom:4px;">
                    â‚¬${data.revenue.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </div>
                  <div style="font-size:12px; color:var(--muted);">${data.count} Projekte</div>
                </div>
              `;
            }).join('')}
          </div>

          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:2px solid #e0e0e0;">
                <th style="text-align:left; padding:12px 8px;">PAYMENT STATUS</th>
                <th style="text-align:right; padding:12px 8px;">ANZAHL PROJEKTE</th>
                <th style="text-align:right; padding:12px 8px;">GESAMT UMSATZ</th>
                <th style="text-align:right; padding:12px 8px;">DURCHSCHNITT</th>
                <th style="text-align:right; padding:12px 8px;">% VOM GESAMT</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(paymentGroups).map(([status, data]) => {
                const avg = data.count > 0 ? data.revenue / data.count : 0;
                const percentage = total > 0 ? (data.revenue / total) * 100 : 0;
                return `
                  <tr style="border-bottom:1px solid #f0f0f0;">
                    <td style="padding:12px 8px; font-weight:500;">${status}</td>
                    <td style="text-align:right; padding:12px 8px;">${data.count}</td>
                    <td style="text-align:right; padding:12px 8px;">â‚¬${data.revenue.toLocaleString('de-DE', { minimumFractionDigits: 2 })}</td>
                    <td style="text-align:right; padding:12px 8px;">â‚¬${avg.toLocaleString('de-DE', { minimumFractionDigits: 2 })}</td>
                    <td style="text-align:right; padding:12px 8px;">${percentage.toFixed(0)}%</td>
                  </tr>
                `;
              }).join('')}
              <tr style="border-top:2px solid #e0e0e0; font-weight:600;">
                <td style="padding:12px 8px;">Gesamt</td>
                <td style="text-align:right; padding:12px 8px;">
                  ${Object.values(paymentGroups).reduce((sum, g) => sum + g.count, 0)}
                </td>
                <td style="text-align:right; padding:12px 8px;">
                  â‚¬${total.toLocaleString('de-DE', { minimumFractionDigits: 2 })}
                </td>
                <td style="text-align:right; padding:12px 8px;">
                  â‚¬${(total / Object.values(paymentGroups).reduce((sum, g) => sum + g.count, 0)).toLocaleString('de-DE', { minimumFractionDigits: 2 })}
                </td>
                <td style="text-align:right; padding:12px 8px;">100%</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;

      let container = document.getElementById('revenueByPaymentStatusContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'revenueByPaymentStatusContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = paymentHTML;
      }
    }

    // ============================================
    // RENDER PROJECT ANALYTICS
    // ============================================
    function renderProjectAnalytics(metrics) {
      const analyticsHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">ðŸ“Š Project Analytics</h3>

          <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:16px;">
            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Total Projects</div>
              <div style="font-size:28px; font-weight:600;">${metrics.total_projects.toLocaleString()}</div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Active Projects</div>
              <div style="font-size:28px; font-weight:600; color:var(--warning);">${metrics.active_projects.toLocaleString()}</div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Finished Projects</div>
              <div style="font-size:28px; font-weight:600; color:var(--success);">${metrics.finished_projects.toLocaleString()}</div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Total Revenue</div>
              <div style="font-size:24px; font-weight:600; color:var(--success);">
                â‚¬${metrics.total_revenue.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
              </div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Avg Project Value</div>
              <div style="font-size:24px; font-weight:600;">
                â‚¬${metrics.avg_project_value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
              </div>
            </div>

            <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px;">
              <div style="font-size:14px; color:var(--muted); margin-bottom:8px;">Avg Appointments/Project</div>
              <div style="font-size:24px; font-weight:600;">${metrics.avg_appointments_per_project.toFixed(1)}</div>
            </div>
          </div>
        </div>
      `;

      let container = document.getElementById('projectAnalyticsContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'projectAnalyticsContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = analyticsHTML;
      }
    }

    // ============================================
    // RENDER ARTIST PERFORMANCE
    // ============================================
    function renderArtistPerformance(appointments) {
      const performanceHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">ðŸŽ¨ Artist Performance</h3>
          <div style="height:200px; display:flex; align-items:center; justify-content:center; background:#f8f9fa; border-radius:8px;">
            <p style="color:var(--muted);">Detailed artist performance metrics coming soon</p>
          </div>
        </div>
      `;

      let container = document.getElementById('artistPerformanceContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'artistPerformanceContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = performanceHTML;
      }
    }

    // ============================================
    // RENDER VIP CUSTOMERS
    // ============================================
    function renderVIPCustomers(requests) {
      const vipHTML = `
        <div style="background:white; padding:24px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:30px;">
          <h3 style="margin:0 0 16px 0;">ðŸ‘¥ VIP Customers (Multi-Project Customers)</h3>
          <div style="height:200px; display:flex; align-items:center; justify-content:center; background:#f8f9fa; border-radius:8px;">
            <p style="color:var(--muted);">VIP customer analysis coming soon</p>
          </div>
        </div>
      `;

      let container = document.getElementById('vipCustomersContainer');
      if (!container) {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
          container = document.createElement('div');
          container.id = 'vipCustomersContainer';
          analyticsContent.appendChild(container);
        }
      }

      if (container) {
        container.innerHTML = vipHTML;
      }
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function getStatusColor(status) {
      const colors = {
        'archived': '#9E9E9E',
        'finished': '#4CAF50',
        'open_request': '#FFC107',
        'scheduled': '#2196F3',
        'canceled': '#F44336',
        'pending': '#FF9800',
        'no_show': '#E91E63',
        'rescheduled': '#9C27B0',
        'unknown': '#757575'
      };
      return colors[status] || '#757575';
    }

    function formatStatusName(status) {
      const names = {
        'archived': 'Archived',
        'finished': 'Finished',
        'open_request': 'Open Request',
        'scheduled': 'Scheduled',
        'canceled': 'Canceled',
        'pending': 'Pending',
        'no_show': 'No Show',
        'rescheduled': 'Rescheduled',
        'unknown': 'Unknown'
      };
      return names[status] || status;
    }

    // Initialize analytics with data
    async function initAnalytics() {
      console.log('ðŸŽ¯ Initializing analytics...');

      try {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // USE CENTRAL CACHE - Kein separates Loading!
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Wait for CentralDataManager if not ready
        if (!CentralDataManager.isReady()) {
          console.log('â³ Analytics waiting for CentralDataManager...');
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        // Load location filter dropdown
        ProgressBar.show('Preparing analytics...');
        ProgressBar.updateProgress(10, 'Loading filters...');
        await loadAnalyticsLocationFilter();

        const locationFilter = document.getElementById('analyticsLocationFilter')?.value || null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GET DATA FROM CACHE (not from database!)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ProgressBar.updateProgress(20, 'Processing cached requests data...');

        // Requests aus Cache holen - optional nach Location filtern
        let cachedRequests = CentralDataManager.getRequests();
        if (locationFilter) {
          cachedRequests = cachedRequests.filter(r => r.location_id === locationFilter);
        }

        // For origin chart: exclude canceled
        requestsData = cachedRequests.filter(r => r.status !== 'canceled');
        // For count display: include all
        allRequestsData = cachedRequests;

        console.log('ðŸ“Š Analytics using cached requests:', requestsData.length);

        const filteredRequests = filterByDateRange(requestsData, 'created_at');
        await renderOriginsPieChart(filteredRequests);

        ProgressBar.updateProgress(30, 'Processing requests count...');
        const filteredAllRequestsForCount = filterByDateRange(allRequestsData, 'created_at');
        await renderRequestsCount(filteredAllRequestsForCount);

        // Appointments aus Cache
        ProgressBar.updateProgress(40, 'Processing cached appointments data...');
        let cachedAppointments = CentralDataManager.getAppointments();
        if (locationFilter) {
          cachedAppointments = cachedAppointments.filter(a => a.location_id === locationFilter);
        }
        appointmentsData = cachedAppointments;

        console.log('ðŸ“Š Analytics using cached appointments:', appointmentsData.length);

        const filteredAppointments = filterByDateRange(appointmentsData, 'created_at');
        await renderBookingsTimeline(filteredAppointments, 'monthly');
        await renderAppointmentsCount(filteredAppointments);

        // Load projects data for Revenue Analytics (small query, can stay)
        ProgressBar.updateProgress(50, 'Loading projects data...');
        projectsData = await loadProjectsData(locationFilter);
        const filteredProjects = filterByDateRange(projectsData, 'created_at');
        await renderRevenueStats(filteredProjects);
        await renderRevenueTimeline(filteredProjects);

        // Load NEW analytics components
        ProgressBar.updateProgress(60, 'Rendering status breakdowns...');
        await loadRequestStatus(filteredRequests);
        await loadArtistDistribution(cachedAppointments);  // Pass FULL cached appointments (not date filtered)
        await loadRevenueByPaymentStatus(CentralDataManager.getProjects());  // Pass cached projects

        // Load Project-Based Analytics from cache
        ProgressBar.updateProgress(70, 'Loading project analytics...');
        await loadProjectAnalyticsFromCache();

        // Calculate and render Pie Charts for Request and Appointment Status
        ProgressBar.updateProgress(80, 'Rendering pie charts...');

        // Calculate request status counts
        const requestStatusCounts = {
          archived: 0,
          finished: 0,
          open_request: 0,
          scheduled: 0,
          canceled: 0,
          pending: 0
        };

        allRequestsData.forEach(req => {
          const status = req.status || 'unknown';
          if (requestStatusCounts.hasOwnProperty(status)) {
            requestStatusCounts[status]++;
          } else {
            requestStatusCounts[status] = 1;
          }
        });

        // Calculate appointment status counts
        const appointmentStatusCounts = {
          finished: 0,
          scheduled: 0,
          no_show: 0,
          rescheduled: 0,
          canceled: 0,
          reserved: 0,
          unknown: 0
        };

        appointmentsData.forEach(apt => {
          const status = apt.status || 'unknown';
          if (appointmentStatusCounts.hasOwnProperty(status)) {
            appointmentStatusCounts[status]++;
          } else {
            appointmentStatusCounts[status] = 1;
          }
        });

        // Render pie charts
        ProgressBar.updateProgress(90, 'Finalizing charts...');
        renderRequestStatusBreakdown(allRequestsData, requestStatusCounts);
        renderAppointmentStatusBreakdown(appointmentsData, appointmentStatusCounts);

        console.log('âœ… Analytics initialized');
        ProgressBar.hide();

      } catch (error) {
        console.error('âŒ Error initializing analytics:', error);
        ProgressBar.hide();
      }
    }

    // ============================================
    // PROJECT-BASED ANALYTICS FROM CACHE
    // ============================================
    async function loadProjectAnalyticsFromCache() {
      console.log('ðŸ“ˆ Loading Project-Based Analytics from cache...');

      try {
        // Get appointments from cache
        const allAppointments = CentralDataManager.getAppointments();
        const appointments = allAppointments.filter(apt =>
          apt.project_number && apt.customer_id
        );

        console.log('ðŸ“¦ Using cached appointments for project analytics:', appointments.length);

        // Calculate metrics
        const metrics = window.calculateProjectMetrics(appointments || []);

        // Update Analytics KPI cards
        const analyticsKpiContainer = document.getElementById('analyticsProjectKPIs');
        if (analyticsKpiContainer) {
          analyticsKpiContainer.innerHTML = `
            <div class="kpi-card">
              <div class="kpi-icon">ðŸ“¦</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.totalProjects.toLocaleString()}</div>
                <div class="kpi-label">Total Projects</div>
              </div>
            </div>

            <div class="kpi-card active">
              <div class="kpi-icon">ðŸ”„</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.activeProjects.toLocaleString()}</div>
                <div class="kpi-label">Active Projects</div>
              </div>
            </div>

            <div class="kpi-card completed">
              <div class="kpi-icon">âœ…</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.completedProjects.toLocaleString()}</div>
                <div class="kpi-label">Completed Projects</div>
              </div>
            </div>

            <div class="kpi-card revenue">
              <div class="kpi-icon">ðŸ’°</div>
              <div class="kpi-content">
                <div class="kpi-value">â‚¬${metrics.totalRevenue.toLocaleString('de-DE', { maximumFractionDigits: 0 })}</div>
                <div class="kpi-label">Total Revenue</div>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon">ðŸ“Š</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.avgAppointmentsPerProject.toFixed(1)}</div>
                <div class="kpi-label">Avg Sessions/Project</div>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading project analytics from cache:', error);
      }
    }

    // ============================================
    // PROJECT-BASED ANALYTICS (for Analytics Tab) - FALLBACK
    // ============================================
    async function loadProjectAnalytics() {
      console.log('ðŸ“ˆ Loading Project-Based Analytics (fallback)...');

      try {
        // Fetch all appointments with full project info
        const { data: appointments, error } = await supabase
          .from('appointments')
          .select(`
            id,
            project_number,
            customer_id,
            artist_id,
            status,
            start,
            payment_status,
            payment_amount,
            deposit_amount,
            total_amount,
            first_name,
            last_name
          `)
          .not('project_number', 'is', null)
          .not('customer_id', 'is', null);

        if (error) throw error;

        console.log('ðŸ“¦ Loaded', appointments?.length || 0, 'appointments for project analytics');

        // Calculate metrics
        const metrics = window.calculateProjectMetrics(appointments || []);

        // Update Analytics KPI cards
        const analyticsKpiContainer = document.getElementById('analyticsProjectKPIs');
        if (analyticsKpiContainer) {
          analyticsKpiContainer.innerHTML = `
            <div class="kpi-card">
              <div class="kpi-icon">ðŸ“¦</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.totalProjects.toLocaleString()}</div>
                <div class="kpi-label">Total Projects</div>
              </div>
            </div>

            <div class="kpi-card active">
              <div class="kpi-icon">ðŸ”„</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.activeProjects.toLocaleString()}</div>
                <div class="kpi-label">Active Projects</div>
              </div>
            </div>

            <div class="kpi-card completed">
              <div class="kpi-icon">âœ…</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.completedProjects.toLocaleString()}</div>
                <div class="kpi-label">Completed Projects</div>
              </div>
            </div>

            <div class="kpi-card revenue">
              <div class="kpi-icon">ðŸ’°</div>
              <div class="kpi-content">
                <div class="kpi-value">â‚¬${metrics.totalRevenue.toLocaleString('de-DE', { maximumFractionDigits: 0 })}</div>
                <div class="kpi-label">Total Revenue</div>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon">ðŸ“Š</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.avgAppointmentsPerProject.toFixed(1)}</div>
                <div class="kpi-label">Avg Sessions/Project</div>
              </div>
            </div>

            <div class="kpi-card">
              <div class="kpi-icon">âœ¨</div>
              <div class="kpi-content">
                <div class="kpi-value">${metrics.completionRate.toFixed(1)}%</div>
                <div class="kpi-label">Completion Rate</div>
              </div>
            </div>
          `;
        }

        // Load charts
        loadProjectsTimelineChart(appointments || []);
        loadRevenueByMonthChart(appointments || []);
        loadTopArtistsChart(appointments || []);

        // Load tables
        await loadArtistPerformanceReport();
        await loadMultiProjectCustomerReport();

      } catch (error) {
        console.error('Error loading project analytics:', error);
      }
    }

    // NEW ANALYTICS FUNCTIONS

    // German number formatting utilities
    function formatCurrency(amount) {
      return new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount || 0);
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('de-DE').format(num || 0);
    }

    // Load Request Status (DEPRECATED - now handled by Dashboard charts)
    async function loadRequestStatus(requests) {
      // This function is deprecated. Request status is now shown in the Dashboard
      // with updateRequestStatusBreakdown() as a pie chart in Analytics tab.
      console.log('â„¹ï¸ loadRequestStatus called (deprecated, request status shown in Analytics tab)');
      return;
    }

    // Load Artist Distribution (appointments by resident artists only)
    async function loadArtistDistribution(appointments) {
      try {
        console.log('ðŸŽ¨ Processing artist distribution from cached appointments...');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // USE PASSED APPOINTMENTS FROM CACHE - Kein separates Loading!
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Filter appointments that have artist data
        const appointmentsWithArtist = (appointments || []).filter(apt =>
          apt.artist_id !== null && apt.artist !== null
        );

        console.log(`ðŸŽ¨ Using ${appointmentsWithArtist.length} appointments with artists from cache`);

        // Filter for resident artists only (is_guest = false)
        const residentAppointments = appointmentsWithArtist.filter(apt =>
          apt.artist && !apt.artist.is_guest
        ) || [];

        console.log(`ðŸŽ¨ Filtered to ${residentAppointments.length} resident artist appointments`);

        // Aggregate by artist
        const artistCounts = {};
        let completedCount = 0;
        let anyCount = 0;

        residentAppointments.forEach(apt => {
          const artistName = apt.artist?.name || apt.artist_email?.split('@')[0] || 'Unknown';
          artistCounts[artistName] = (artistCounts[artistName] || 0) + 1;

          if (apt.status === 'finished') {
            completedCount++;
          }

          if (!apt.artist_email && !apt.artist_id) {
            anyCount++;
          }
        });

        const total = residentAppointments.length;
        const notCompleted = total - completedCount;

        // Group small artists (< 10 appointments)
        const threshold = 10;
        const filteredArtists = {};
        let otherCount = 0;

        Object.entries(artistCounts).forEach(([name, count]) => {
          if (count >= threshold) {
            filteredArtists[name.charAt(0).toUpperCase() + name.slice(1)] = count;
          } else {
            otherCount += count;
          }
        });

        if (otherCount > 0) {
          filteredArtists['Sonstige (< 10 Appointments)'] = otherCount;
        }

        console.log('ðŸŽ¨ Artist counts:', artistCounts);
        console.log('ðŸŽ¨ Filtered artists (>= 10):', filteredArtists);

        // Sort by count
        const sorted = Object.entries(filteredArtists).sort((a, b) => b[1] - a[1]);
        const labels = sorted.map(([name]) => name);
        const values = sorted.map(([, count]) => count);

        // Render chart
        const ctx = document.getElementById('artistDistributionChart');
        if (!ctx) return;

        if (artistDistributionChartInstance) {
          artistDistributionChartInstance.destroy();
        }

        const chartColors = [
          '#34c759', '#9c27b0', '#e91e63', '#0071e3', '#ff9500',
          '#5856d6', '#ff2d55', '#30b0c7', '#ff6482', '#64d2ff'
        ];

        artistDistributionChartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: values,
              backgroundColor: chartColors.slice(0, labels.length),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '60%',
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  font: {
                    family: '-apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif',
                    size: 11
                  },
                  padding: 10,
                  usePointStyle: true
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });

        // Update stats
        document.getElementById('artistTotalRequests').textContent = formatNumber(total);
        const completedPercent = total > 0 ? (completedCount / total * 100).toFixed(1) : 0;
        document.getElementById('artistCompletedAppointments').textContent =
          `${formatNumber(completedCount)} (${completedPercent} %)`;
        const notCompletedPercent = total > 0 ? (notCompleted / total * 100).toFixed(1) : 0;
        document.getElementById('artistNotCompleted').textContent =
          `${formatNumber(notCompleted)} (${notCompletedPercent} %)`;
        const anyPercent = total > 0 ? (anyCount / total * 100).toFixed(1) : 0;
        document.getElementById('artistAny').textContent =
          `${formatNumber(anyCount)} (${anyPercent} %)`;

      } catch (error) {
        console.error('Error loading artist distribution:', error);
      }
    }

    // Load Revenue by Payment Status (projects.price + payment_state)
    async function loadRevenueByPaymentStatus(cachedProjects = null) {
      console.log('ðŸ’° Processing revenue by payment status from cache...');

      try {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // USE CACHED PROJECTS - Kein separates Loading!
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Use passed projects or get from CentralDataManager
        let allProjects = cachedProjects;
        if (!allProjects) {
          allProjects = CentralDataManager.getProjects();
        }

        // Filter projects with valid price
        allProjects = allProjects.filter(p => p.total_amount !== null && p.total_amount > 0);

        console.log(`âœ… Using ${allProjects.length} projects with pricing from cache`);

        // Group by payment_status
        const revenueByStatus = {};
        let totalRevenue = 0;

        allProjects.forEach(project => {
          const status = project.payment_status || 'Unbekannt';
          const price = parseFloat(project.total_amount) || 0;

          if (!revenueByStatus[status]) {
            revenueByStatus[status] = {
              count: 0,
              revenue: 0
            };
          }

          revenueByStatus[status].count++;
          revenueByStatus[status].revenue += price;
          totalRevenue += price;
        });

        console.log('ðŸ’° Revenue by payment status:', revenueByStatus);

        // Render chart
        renderRevenueByPaymentStatus(revenueByStatus, totalRevenue);

      } catch (error) {
        console.error('âŒ Error loading revenue by payment status:', error);
      }
    }

    function renderRevenueByPaymentStatus(revenueByStatus, totalRevenue) {
      const container = document.getElementById('revenueByPaymentStatusChart');

      if (!container) {
        console.log('â„¹ï¸ Revenue chart container not found (optional feature)');
        return;
      }

      // Sort by revenue (descending)
      const sortedStatuses = Object.entries(revenueByStatus)
        .sort((a, b) => b[1].revenue - a[1].revenue);

      container.innerHTML = `
        <div style="margin-bottom: 20px;">
          <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600;">
            Revenue by Payment Status
          </h3>
          <p style="margin: 0; font-size: 14px; color: #86868b;">
            Total: ${totalRevenue.toLocaleString('de-DE', {minimumFractionDigits: 2})} â‚¬
          </p>
        </div>

        ${sortedStatuses.map(([status, data]) => {
          const percentage = ((data.revenue / totalRevenue) * 100).toFixed(1);
          const color = getPaymentStatusColor(status);

          return `
            <div style="margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
                <span style="font-weight: 500;">${status}</span>
                <span style="font-weight: 600; color: ${color};">
                  ${data.revenue.toLocaleString('de-DE', {minimumFractionDigits: 2})} â‚¬
                  <span style="color: #86868b;">(${data.count} projects)</span>
                </span>
              </div>
              <div style="height: 32px; background: rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; display: flex; align-items: center; padding: 0 12px;">
                <div style="height: 20px; background: ${color}; border-radius: 4px; width: ${percentage}%; transition: width 0.3s;"></div>
                <span style="margin-left: 12px; font-size: 14px; font-weight: 600;">${percentage}%</span>
              </div>
            </div>
          `;
        }).join('')}
      `;
    }

    function getPaymentStatusColor(status) {
      const colors = {
        'Offen': '#FFA500',      // Orange
        'Bezahlt': '#34C759',    // Green
        'Teilzahlung': '#007AFF', // Blue
        'Unbekannt': '#8E8E93',  // Gray
        'Deposit': '#FF9500'     // Amber
      };
      return colors[status] || '#8E8E93';
    }

    // Load locations for filter dropdown
    async function loadAnalyticsLocationFilter() {
      try {
        const { data: locations, error } = await supabase
          .from('locations')
          .select('id, name')
          .order('name');

        if (error) throw error;

        const filterSelect = document.getElementById('analyticsLocationFilter');
        if (!filterSelect) return;

        filterSelect.innerHTML = '<option value="">All Locations</option>';
        locations.forEach(loc => {
          const option = document.createElement('option');
          option.value = loc.id;
          option.textContent = loc.name;
          filterSelect.appendChild(option);
        });

        console.log('âœ… Analytics location filter loaded with', locations.length, 'locations');
      } catch (err) {
        console.error('âŒ Failed to load locations for analytics filter:', err);
      }
    }

    // Attach event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Login form
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
      }

      // Close modal when clicking outside (only if logged in)
      document.getElementById('loginBackdrop')?.addEventListener('click', (e) => {
        if (e.target.id === 'loginBackdrop') {
          if (currentUser) {
            closeLoginModal();
          }
        }
      });

      // Analytics Tab Click - Initialize charts when Analytics tab is clicked
      const analyticsTab = document.getElementById('tab-analytics');
      if (analyticsTab) {
        analyticsTab.addEventListener('click', async function() {
          console.log('ðŸ“Š Analytics tab clicked');
          // Small delay to ensure section is visible before rendering charts
          setTimeout(async () => {
            await initAnalytics();
          }, 100);
        });
      }

      // Wannados Tab Click - Load wannado collections when tab is clicked
      const wannadosTab = document.getElementById('tab-wannados');
      if (wannadosTab) {
        wannadosTab.addEventListener('click', async function() {
          console.log('ðŸŽ¨ Wannados tab clicked');
          setTimeout(async () => {
            await loadWannadoCollections();
          }, 100);
        });
      }

      // Waitlist Tab Click - Load waitlist slots (artists WITHOUT booking dates)
      const waitlistTab = document.getElementById('tab-waitlist');
      if (waitlistTab) {
        waitlistTab.addEventListener('click', async function() {
          console.log('ðŸ“‹ Waitlist tab clicked');

          // Hide all sections
          document.querySelectorAll('section').forEach(s => s.classList.remove('active'));

          // Show waitlist section
          const waitlistSection = document.getElementById('waitlist-section');
          if (waitlistSection) {
            waitlistSection.classList.add('active');
          }

          // Update active tab
          document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
          waitlistTab.classList.add('active');

          // Load waitlist-only slots (artists WITHOUT booking dates)
          if (typeof loadWaitlistOnlySlots === 'function') {
            await loadWaitlistOnlySlots('all');
          }
        });
      }

      // Location Filter Change
      const analyticsLocationFilter = document.getElementById('analyticsLocationFilter');
      if (analyticsLocationFilter) {
        analyticsLocationFilter.addEventListener('change', async function() {
          const locationId = this.value || null;
          console.log('ðŸ¢ Analytics location filter changed:', locationId || 'All Locations');

          // Reload requests data for Origin Chart
          requestsData = await loadRequestsData(locationId);
          const filteredRequests = filterByDateRange(requestsData, 'created_at');
          await renderOriginsPieChart(filteredRequests);

          // Reload ALL requests data for Count Display (including canceled)
          allRequestsData = await loadAllRequestsData(locationId);
          const filteredAllRequestsForCount = filterByDateRange(allRequestsData, 'created_at');
          await renderRequestsCount(filteredAllRequestsForCount);

          // Reload appointments data for Timeline Chart
          appointmentsData = await loadAppointmentsData(locationId);
          const filteredAppointments = filterByDateRange(appointmentsData, 'created_at');
          await renderBookingsTimeline(filteredAppointments, 'monthly');
          await renderAppointmentsCount(filteredAppointments);

          // Reload projects data for Revenue Analytics
          projectsData = await loadProjectsData(locationId);
          const filteredProjects = filterByDateRange(projectsData, 'created_at');
          await renderRevenueStats(filteredProjects);
          await renderRevenueTimeline(filteredProjects);

          // Reload NEW analytics components
          await loadRequestStatus(filteredRequests);
          await loadArtistDistribution(filteredAppointments);
          await loadRevenueByPaymentStatus();
        });
      }

      // Date Range Filter Change
      const analyticsDateRangeFilter = document.getElementById('analyticsDateRangeFilter');
      if (analyticsDateRangeFilter) {
        analyticsDateRangeFilter.addEventListener('change', async function() {
          console.log('ðŸ“… Date range filter changed:', this.value);

          // Re-render all charts with filtered data
          const filteredRequests = filterByDateRange(requestsData, 'created_at');
          await renderOriginsPieChart(filteredRequests);

          const filteredAllRequests = filterByDateRange(allRequestsData, 'created_at');
          await renderRequestsCount(filteredAllRequests);

          const filteredAppointments = filterByDateRange(appointmentsData, 'created_at');
          await renderBookingsTimeline(filteredAppointments, 'monthly');
          await renderAppointmentsCount(filteredAppointments);

          const filteredProjects = filterByDateRange(projectsData, 'created_at');
          await renderRevenueStats(filteredProjects);
          await renderRevenueTimeline(filteredProjects);

          // Reload NEW analytics components
          await loadRequestStatus(filteredRequests);
          await loadArtistDistribution(filteredAppointments);
          await loadRevenueByPaymentStatus();
        });
      }

      // Custom Date Range Inputs
      const analyticsStartDate = document.getElementById('analyticsStartDate');
      const analyticsEndDate = document.getElementById('analyticsEndDate');

      if (analyticsStartDate && analyticsEndDate) {
        const applyCustomDateRange = async function() {
          const startVal = analyticsStartDate.value;
          const endVal = analyticsEndDate.value;

          if (startVal && endVal) {
            console.log('ðŸ“… Custom date range applied:', startVal, 'to', endVal);

            // Re-render all charts with filtered data
            const filteredRequests = filterByDateRange(requestsData, 'created_at');
            await renderOriginsPieChart(filteredRequests);

            const filteredAllRequests = filterByDateRange(allRequestsData, 'created_at');
            await renderRequestsCount(filteredAllRequests);

            const filteredAppointments = filterByDateRange(appointmentsData, 'created_at');
            await renderBookingsTimeline(filteredAppointments, 'monthly');
            await renderAppointmentsCount(filteredAppointments);

            const filteredProjects = filterByDateRange(projectsData, 'created_at');
            await renderRevenueStats(filteredProjects);
            await renderRevenueTimeline(filteredProjects);

            // Reload NEW analytics components
            await loadRequestStatus(filteredRequests);
            await loadArtistDistribution(filteredAppointments);
            await loadRevenueByPaymentStatus();
          }
        };

        analyticsStartDate.addEventListener('change', applyCustomDateRange);
        analyticsEndDate.addEventListener('change', applyCustomDateRange);
      }

      // ============================================
      // WAITLIST MANAGEMENT (DUAL LIST SYSTEM)
      // ============================================

      let currentWaitlistLocation = 'all';
      let waitlistSlots = [];
      let currentListType = 'upcoming'; // 'upcoming', 'active', 'previous', or 'canceled' (waitlist is now separate tab)

      // ============================================
      // Switch List Type (5 Tabs: Waitlist / Upcoming / Active / Previous / Canceled)
      // ============================================
      function switchListType(listType) {
        console.log(`ðŸ”„ Switching to ${listType} list`);
        currentListType = listType;

        // Reset calendar view to list when switching tabs
        if (typeof resetGuestspotView === 'function') {
          resetGuestspotView();
        }

        // Update toggle UI with tab-specific colors
        const toggleButtons = document.querySelectorAll('.list-toggle-option');
        toggleButtons.forEach(btn => {
          if (btn.dataset.listType === listType) {
            btn.classList.add('active');
            // Tab-specific colors
            if (listType === 'active') {
              btn.style.background = '#dcfce7';
              btn.style.color = '#166534';
            } else if (listType === 'canceled') {
              btn.style.background = '#fee2e2';
              btn.style.color = '#991b1b';
            } else {
              btn.style.background = 'white';
              btn.style.color = '#1d1d1f';
            }
            btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.08)';
          } else {
            btn.classList.remove('active');
            btn.style.background = 'transparent';
            btn.style.color = '#86868b';
            btn.style.boxShadow = 'none';
          }
        });

        // Show/Hide Add Buttons based on list type
        const addSlotButton = document.getElementById('addWaitlistSlotButton');
        const addPreviousButton = document.getElementById('addPreviousSpotButton');
        if (addSlotButton && addPreviousButton) {
          if (listType === 'previous' || listType === 'canceled') {
            // Hide Add buttons for history tabs
            addSlotButton.style.display = 'none';
            addPreviousButton.style.display = 'none';
          } else {
            // Show Add Slot for active tabs
            addSlotButton.style.display = 'flex';
            addPreviousButton.style.display = 'none';
          }
        }

        // Update description text
        const descriptionEl = document.getElementById('listTypeDescription');
        if (descriptionEl) {
          const descriptions = {
            'waitlist': 'Artists available NOW (no specific dates)',
            'upcoming': 'Upcoming guest spots (scheduled)',
            'active': 'Currently active guest spots',
            'previous': 'Completed guest spots',
            'canceled': 'Canceled guest spots'
          };
          descriptionEl.textContent = descriptions[listType] || '';
        }

        // Reload data based on list type
        switch(listType) {
          case 'waitlist':
            loadWaitlistSlots(currentWaitlistLocation);
            break;
          case 'upcoming':
            loadUpcomingGuestSpotsTab();
            break;
          case 'active':
            loadActiveGuestSpotsTab();
            break;
          case 'previous':
            loadPreviousGuestSpots(currentWaitlistLocation);
            break;
          case 'canceled':
            loadCanceledGuestSpotsTab();
            break;
          default:
            loadWaitlistSlots(currentWaitlistLocation);
        }
      }
      window.switchListType = switchListType;

      // ============================================
      // Load Waitlist Slots (Supports Both Lists)
      // ============================================
      async function loadWaitlistSlots(locationFilter = 'all') {
        console.log(`ðŸ“‹ Loading ${currentListType} slots...`);

        try {
          // Select appropriate VIEW based on currentListType
          // WAITLIST = Artists available NOW (NO dates) - uses ordered view
          // UPCOMING = Artists with SPECIFIC dates - uses GROUPED view (backend grouping)
          const viewName = currentListType === 'waitlist'
            ? 'waitlist_slots_ordered'    // âœ… Waitlist: ordered view
            : 'upcoming_slots_grouped';   // âœ… Upcoming: GROUPED view (backend grouping!)

          console.log(`   View: ${viewName}, Location filter: ${locationFilter || 'all'}`);

          // Build query - views already have all joined data
          let query = supabase
            .from(viewName)
            .select('*');

          // For waitlist, filter by status
          if (currentListType === 'waitlist') {
            query = query.in('status', ['waiting', 'active', 'upcoming']);
            query = query.order('display_order', { ascending: true });
          } else {
            // For upcoming (grouped view), filter to show only future/current dates
            const today = new Date().toISOString().split('T')[0];
            query = query.gte('date_from', today).order('date_from', { ascending: true });
          }

          // Apply location filter if not 'all'
          if (locationFilter && locationFilter !== 'all') {
            query = query.eq('location_id', locationFilter);
          }

          const { data, error } = await query;

          if (error) {
            console.error('âŒ Database Error:', {
              view: viewName,
              listType: currentListType,
              locationFilter: locationFilter,
              error: error.message,
              details: error.details,
              hint: error.hint,
              code: error.code
            });
            throw error;
          }

          // Transform data to match expected format
          // Grouped view provides: all_slot_ids, slot_count, date_from, date_to
          waitlistSlots = (data || []).map(slot => ({
            ...slot,
            // Map share_personal_data to share_paid for consistency
            share_paid: currentListType === 'upcoming' ? slot.share_personal_data : slot.share_paid,
            // For grouped view: use all_slot_ids from backend, or fallback to single id
            all_slot_ids: slot.all_slot_ids || [slot.id],
            // For grouped view: use slot_count from backend, or fallback to 1
            slot_count: slot.slot_count || 1
          }));

          console.log(`âœ… Loaded ${waitlistSlots.length} ${currentListType} slots (from ${viewName})`);

          // Log sample of first slot for debugging
          if (waitlistSlots.length > 0) {
            console.log('   First slot structure:', Object.keys(waitlistSlots[0]));
            if (currentListType === 'upcoming') {
              console.log('   First slot:', {
                date_from: waitlistSlots[0].date_from,
                date_to: waitlistSlots[0].date_to,
                slot_count: waitlistSlots[0].slot_count,
                all_slot_ids: waitlistSlots[0].all_slot_ids
              });
            }
          }

          // Render slots (no frontend grouping needed - backend does it!)
          renderWaitlistSlots(waitlistSlots);

          return waitlistSlots;

        } catch (error) {
          console.error(`âŒ Error loading ${currentListType} slots:`, error);
          showNotification(`Failed to load ${currentListType} slots: ${error.message}`, 'error');

          // Show empty state
          const container = document.getElementById('waitlistSlotsContainer');
          const emptyState = document.getElementById('waitlistEmptyState');
          if (container) container.innerHTML = '';
          if (emptyState) emptyState.style.display = 'block';

          return [];
        }
      }

      // ============================================
      // Load Previous Guest Spots (using grouped VIEW)
      // ============================================
      async function loadPreviousGuestSpots(locationFilter = 'all') {
        console.log('ðŸ“‹ Loading Previous Guest Spots (grouped)...');

        try {
          let query = supabase
            .from('previous_guest_spots_grouped')
            .select('*')
            .order('date_from', { ascending: false });

          if (locationFilter && locationFilter !== 'all') {
            query = query.eq('location_id', locationFilter);
          }

          const { data, error } = await query;

          if (error) throw error;

          console.log(`âœ… Loaded ${data?.length || 0} grouped previous guest spots`);
          renderPreviousGuestSpots(data || []);

        } catch (error) {
          console.error('âŒ Error loading previous guest spots:', error);
          showNotification('Fehler: ' + error.message, 'error');
        }
      }

      // ============================================
      // Load Upcoming Guest Spots (status = upcoming/active, date in future)
      // ============================================
      async function loadUpcomingGuestSpotsTab() {
        console.log('ðŸ“‹ Loading Upcoming Guest Spots...');
        const container = document.getElementById('waitlistSlotsContainer');
        if (!container) return;

        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted);">Laden...</div>';

        try {
          const today = new Date().toISOString().split('T')[0];
          const { data, error } = await supabase
            .from('upcoming_slots_grouped')
            .select('*')
            .gte('date_from', today)
            .order('date_from', { ascending: true });

          if (error) throw error;

          console.log(`âœ… Loaded ${data?.length || 0} upcoming guest spots`);

          if (!data || data.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:60px;color:var(--muted);"><p>Keine anstehenden Guest Spots</p></div>';
            return;
          }

          // Use existing renderWaitlistSlots or a similar render
          waitlistSlots = data;
          renderWaitlistSlots(data);

        } catch (error) {
          console.error('âŒ Error loading upcoming guest spots:', error);
          container.innerHTML = '<div style="text-align:center;padding:40px;color:#ff3b30;">Fehler beim Laden</div>';
        }
      }

      // ============================================
      // Load Active Guest Spots (currently active based on date)
      // ============================================
      async function loadActiveGuestSpotsTab() {
        console.log('ðŸ“‹ Loading Active Guest Spots...');
        const container = document.getElementById('waitlistSlotsContainer');
        if (!container) return;

        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted);">Laden...</div>';

        try {
          const today = new Date().toISOString().split('T')[0];
          const { data, error } = await supabase
            .from('upcoming_slots_grouped')
            .select('*')
            .lte('date_from', today)
            .gte('date_to', today)
            .neq('status', 'canceled')
            .order('date_from', { ascending: true });

          if (error) throw error;

          console.log(`âœ… Loaded ${data?.length || 0} active guest spots`);

          if (!data || data.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:60px;color:var(--muted);"><p>Keine aktiven Guest Spots</p></div>';
            return;
          }

          waitlistSlots = data;
          renderWaitlistSlots(data);

        } catch (error) {
          console.error('âŒ Error loading active guest spots:', error);
          container.innerHTML = '<div style="text-align:center;padding:40px;color:#ff3b30;">Fehler beim Laden</div>';
        }
      }

      // ============================================
      // Load Canceled Guest Spots (status = canceled)
      // ============================================
      async function loadCanceledGuestSpotsTab() {
        console.log('ðŸ“‹ Loading Canceled Guest Spots...');
        const container = document.getElementById('waitlistSlotsContainer');
        if (!container) return;

        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted);">Laden...</div>';

        try {
          const { data, error } = await supabase
            .from('previous_guest_spots_grouped')
            .select('*')
            .eq('status', 'canceled')
            .order('canceled_at', { ascending: false, nullsFirst: false })
            .limit(100);

          if (error) throw error;

          console.log(`âœ… Loaded ${data?.length || 0} canceled guest spots`);

          if (!data || data.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:60px;color:var(--muted);"><p>Keine stornierten Guest Spots</p></div>';
            return;
          }

          // Render canceled spots (similar to previous spots)
          renderPreviousGuestSpots(data);

        } catch (error) {
          console.error('âŒ Error loading canceled guest spots:', error);
          container.innerHTML = '<div style="text-align:center;padding:40px;color:#ff3b30;">Fehler beim Laden</div>';
        }
      }

      // Expose new functions
      window.loadUpcomingGuestSpotsTab = loadUpcomingGuestSpotsTab;
      window.loadActiveGuestSpotsTab = loadActiveGuestSpotsTab;
      window.loadCanceledGuestSpotsTab = loadCanceledGuestSpotsTab;

      // ============================================
      // Render Previous Guest Spots
      // ============================================
      function renderPreviousGuestSpots(spots) {
        const container = document.getElementById('waitlistSlotsContainer');
        const emptyState = document.getElementById('waitlistEmptyState');

        if (emptyState) emptyState.style.display = 'none';

        if (!spots || spots.length === 0) {
          container.innerHTML = '<div style="text-align:center;padding:60px;color:var(--muted);"><p>Keine vergangenen Guest Spots</p></div>';
          return;
        }

        container.innerHTML = spots.map(spot => {
          const statusBadge = spot.status === 'completed'
            ? '<span style="background:#34c759;color:white;padding:4px 12px;border-radius:20px;font-size:12px;display:inline-flex;align-items:center;gap:4px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg> Completed</span>'
            : '<span style="background:#ff3b30;color:white;padding:4px 12px;border-radius:20px;font-size:12px;display:inline-flex;align-items:center;gap:4px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg> Canceled</span>';

          const paidBadge = spot.is_paid
            ? '<span style="background:#34c759;color:white;padding:4px 12px;border-radius:20px;font-size:12px;display:inline-flex;align-items:center;gap:4px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg> Paid</span>'
            : '<span style="background:#ff9500;color:white;padding:4px 12px;border-radius:20px;font-size:12px;display:inline-flex;align-items:center;gap:4px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg> Unpaid</span>';

          const cancelInfo = spot.status === 'canceled' && spot.cancel_reason
            ? '<p style="color:#ff3b30;font-size:13px;margin-top:12px;"><strong>Absagegrund:</strong> ' + spot.cancel_reason + '</p>'
            : '';

          const canceledBy = spot.canceled_by_username
            ? '<p style="color:var(--muted);font-size:12px;margin-top:4px;">Abgesagt von: ' + spot.canceled_by_username + '</p>'
            : '';

          // Cache the slot for detail view
          cacheGuestSpotSlot(spot);

          // View Profile Button
          const viewProfileButton = spot.artist_id
            ? '<button onclick="viewArtistProfile(\'' + spot.artist_id + '\')" style="padding:8px 12px;border:none;border-radius:8px;background:#1d1d1f;color:#fff;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px;" onmouseover="this.style.background=\'#333\';" onmouseout="this.style.background=\'#1d1d1f\';"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> View Profile</button>'
            : '';

          // Details Button
          const detailsButton = '<button onclick="openGuestSpotDetailFromCache(\'' + spot.id + '\')" style="padding:8px 12px;border:none;border-radius:8px;background:rgba(142, 142, 147, 0.12);color:#1d1d1f;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px;" onmouseover="this.style.background=\'rgba(142, 142, 147, 0.2)\';" onmouseout="this.style.background=\'rgba(142, 142, 147, 0.12)\';"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Details</button>';

          return '<div style="background:var(--macos-elevated, #fff);border-radius:16px;padding:24px;margin-bottom:16px;border:1px solid var(--border-color, #e0e0e0);opacity:' + (spot.status === 'canceled' ? '0.7' : '1') + ';">' +
            '<div style="display:flex;justify-content:space-between;align-items:flex-start;">' +
              '<div style="flex:1;">' +
                '<h3 style="margin:0 0 4px 0;font-size:18px;font-weight:600;">' + (spot.artist_name || spot.name || 'Unknown Artist') + '</h3>' +
                '<p style="margin:0;color:var(--muted);font-size:14px;">' + (spot.location_name || '') + (spot.location_city ? ' (' + spot.location_city + ')' : '') + '</p>' +
                '<p style="margin:12px 0 8px 0;font-size:14px;"><strong>Zeitraum:</strong> ' + formatDateDE(spot.date_from) + ' - ' + formatDateDE(spot.date_to) + '</p>' +
                '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">' + statusBadge + paidBadge + '</div>' +
                cancelInfo + canceledBy +
                '<div style="margin-top:16px;display:flex;gap:8px;">' + viewProfileButton + detailsButton + '</div>' +
              '</div>' +
              (spot.profile_picture_url ? '<img src="' + spot.profile_picture_url + '" alt="' + (spot.artist_name || '') + '" style="width:60px;height:60px;border-radius:12px;object-fit:cover;margin-left:16px;">' : '') +
            '</div>' +
          '</div>';
        }).join('');
      }

      // ============================================
      // Format Date German Style
      // ============================================
      function formatDateDE(dateStr) {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' });
      }

      // ============================================
      // Group Consecutive Slots (Same Artist, Adjacent Dates)
      // ============================================
      function groupConsecutiveSlots(slots) {
        if (!slots || slots.length === 0) return [];

        // Sortiere nach artist_id, dann date_from
        const sorted = [...slots].sort((a, b) => {
          // Erst nach Artist sortieren
          if (a.artist_id !== b.artist_id) {
            return (a.artist_name || '').localeCompare(b.artist_name || '');
          }
          // Dann nach Datum
          return new Date(a.date_from) - new Date(b.date_from);
        });

        const grouped = [];
        let currentGroup = null;

        for (const slot of sorted) {
          const isConsecutive = currentGroup &&
            currentGroup.artist_id === slot.artist_id &&
            isNextDay(currentGroup.grouped_date_to, slot.date_from);

          if (!currentGroup) {
            // Erster Slot - neue Gruppe starten
            currentGroup = createSlotGroup(slot);
          } else if (isConsecutive) {
            // Aufeinanderfolgend & gleicher Artist â†’ zusammenfassen
            currentGroup.grouped_date_to = slot.date_to;
            currentGroup.original_slots.push(slot);
            currentGroup.all_slot_ids.push(slot.id);
          } else {
            // Neuer Artist ODER LÃ¼cke â†’ Gruppe abschlieÃŸen, neue starten
            grouped.push(currentGroup);
            currentGroup = createSlotGroup(slot);
          }
        }

        // Letzte Gruppe hinzufÃ¼gen
        if (currentGroup) {
          grouped.push(currentGroup);
        }

        // Sortiere nach grouped_date_from und nummeriere neu
        return grouped
          .sort((a, b) => new Date(a.grouped_date_from) - new Date(b.grouped_date_from))
          .map((group, index) => ({
            ...group,
            display_order: index + 1
          }));
      }

      function createSlotGroup(slot) {
        return {
          ...slot,
          grouped_date_from: slot.date_from,
          grouped_date_to: slot.date_to,
          original_slots: [slot],
          all_slot_ids: [slot.id]
        };
      }

      function isNextDay(date1, date2) {
        const d1 = new Date(date1);
        const d2 = new Date(date2);
        const nextDay = new Date(d1);
        nextDay.setDate(nextDay.getDate() + 1);

        return nextDay.toISOString().split('T')[0] === new Date(d2).toISOString().split('T')[0];
      }

      // ============================================
      // Render Waitlist Slots (uses backend-grouped data from VIEWs)
      // ============================================
      function renderWaitlistSlots(slots) {
        const container = document.getElementById('waitlistSlotsContainer');
        const emptyState = document.getElementById('waitlistEmptyState');

        if (!container) return;

        // Cache slots for calendar views
        guestspotCachedSlots = slots || [];

        // Show empty state if no slots
        if (!slots || slots.length === 0) {
          container.innerHTML = '';
          if (emptyState) emptyState.style.display = 'block';
          return;
        }

        // Hide empty state
        if (emptyState) emptyState.style.display = 'none';

        // No frontend grouping needed - backend VIEW does it!
        // Upcoming uses upcoming_slots_grouped which already groups consecutive slots

        // Render slots
        container.innerHTML = slots.map((slot, index) => {
          // Use display_order from VIEW, otherwise use index + 1
          const slotNumber = slot.display_order || (index + 1);

          // Dates come directly from the VIEW (already grouped if applicable)
          const displayDateFrom = slot.date_from;
          const displayDateTo = slot.date_to;

          // All slot IDs for cancel/delete (from backend VIEW)
          const allSlotIds = slot.all_slot_ids || [slot.id];
          const slotCount = slot.slot_count || allSlotIds.length;

          // Date calculations ONLY for UPCOMING (has dates)
          // WAITLIST has NO dates (artists available NOW)
          let fromDate, toDate, isActive, isUpcoming, daysRemaining, daysUntilStart;
          if (currentListType === 'upcoming' && displayDateFrom && displayDateTo) {
            fromDate = new Date(displayDateFrom);
            toDate = new Date(displayDateTo);
            const today = new Date();

            // Calculate status
            isActive = fromDate <= today && toDate >= today;
            isUpcoming = fromDate > today;
            daysRemaining = Math.ceil((toDate - today) / (1000 * 60 * 60 * 24));
            daysUntilStart = Math.ceil((fromDate - today) / (1000 * 60 * 60 * 24));
          }

          // Status badge
          let statusBadge = '';
          if (currentListType === 'upcoming') {
            // For upcoming list with dates, show date-based status
            if (isActive) {
              statusBadge = `<span class="badge" style="background:#34c759; color:white;">ðŸŽ¨ Active (${daysRemaining} days left)</span>`;
            } else if (isUpcoming) {
              statusBadge = `<span class="badge" style="background:#007aff; color:white;">ðŸ“… Starts in ${daysUntilStart} days</span>`;
            }
          } else {
            // For waitlist (NO dates), show "Available Now" badge
            statusBadge = `<span class="badge" style="background:#34c759; color:white;">ðŸ•’ Jetzt verfÃ¼gbar</span>`;
          }

          // Cache the slot data for click handling (avoids JSON in onclick)
          cacheGuestSpotSlot(slot);

          // Paid Badge fÃ¼r Upcoming/Previous (nur wenn date_from vorhanden)
          const paidBadge = (currentListType === 'upcoming' && slot.date_from)
            ? (slot.is_paid || slot.share_paid
              ? `<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:4px;background:rgba(52,199,89,0.15);color:#34c759;font-size:11px;font-weight:600;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
                  Paid
                </span>`
              : `<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:4px;background:rgba(255,59,48,0.1);color:#ff3b30;font-size:11px;font-weight:600;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                  Unpaid
                </span>`)
            : '';

          return `
            <div class="waitlist-slot-card" data-slot-id="${slot.id}" style="
              background:var(--macos-elevated);
              border-radius:16px;
              padding:24px;
              margin-bottom:16px;
              box-shadow:0 2px 8px rgba(0,0,0,0.08);
              transition:all 0.2s;
              cursor:pointer;
              border:1px solid var(--border-color);
            ">
              <!-- Slot Header -->
              <div style="display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:16px;">
                <div style="display:flex; align-items:center; gap:16px;">
                  <!-- Slot Number Badge -->
                  <div style="
                    width:48px;
                    height:48px;
                    border-radius:50%;
                    background:rgba(142, 142, 147, 0.12);
                    border:2px solid var(--border-color);
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    color:var(--ink);
                    font-size:20px;
                    font-weight:700;
                    flex-shrink:0;
                  ">
                    ${slotNumber}
                  </div>

                  <!-- Artist Info -->
                  <div>
                    <h3 style="margin:0 0 4px 0; font-size:18px; color:var(--ink);">
                      ${slot.artist_name || 'Unknown Artist'}
                    </h3>
                    <p style="margin:0; color:var(--muted); font-size:14px;">
                      ${slot.artist_email || ''}
                    </p>
                  </div>
                </div>

                <!-- Status Badges -->
                <div style="display:flex; gap:8px; align-items:center;">
                  ${paidBadge}
                  ${statusBadge}
                </div>
              </div>

              <!-- Actions: Profile and Details buttons -->
              <div style="display:flex; justify-content:flex-end; margin-bottom:16px;">
                <div style="display:flex; gap:8px;">
                  ${slot.artist_id ? `
                  <button
                    onclick="viewArtistProfile('${slot.artist_id}')"
                    style="
                      padding:8px 12px;
                      border:none;
                      border-radius:8px;
                      background:#1d1d1f;
                      cursor:pointer;
                      color:#fff;
                      font-size:14px;
                      font-weight:500;
                      transition:all 0.2s;
                      display:inline-flex;
                      align-items:center;
                      gap:6px;
                    "
                    onmouseover="this.style.background='#333';"
                    onmouseout="this.style.background='#1d1d1f';"
                  >
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    Profile
                  </button>
                  ` : ''}
                  <button
                    onclick="openGuestSpotDetailFromCache('${slot.id}')"
                    style="
                      padding:8px 12px;
                      border:none;
                      border-radius:8px;
                      background:rgba(142, 142, 147, 0.12);
                      cursor:pointer;
                      color:#1d1d1f;
                      font-size:14px;
                      font-weight:500;
                      transition:all 0.2s;
                      display:inline-flex;
                      align-items:center;
                      gap:6px;
                    "
                    onmouseover="this.style.background='rgba(142, 142, 147, 0.2)';"
                    onmouseout="this.style.background='rgba(142, 142, 147, 0.12)';"
                  >
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Details
                  </button>
                </div>
              </div>

              <!-- Date Range (UPCOMING ONLY - has dates) or Location -->
              <div style="display:flex; gap:24px; margin-bottom:12px;">
                ${currentListType === 'upcoming' && fromDate && toDate ? `
                  <div style="flex:1;">
                    <div style="color:var(--muted); font-size:12px; margin-bottom:4px;">Start Date</div>
                    <div style="font-weight:600; color:var(--ink);">
                      ${fromDate.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' })}
                    </div>
                  </div>

                  <div style="flex:1;">
                    <div style="color:var(--muted); font-size:12px; margin-bottom:4px;">End Date</div>
                    <div style="font-weight:600; color:var(--ink);">
                      ${toDate.toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' })}
                    </div>
                  </div>
                ` : ''}

                ${slot.location_name ? `
                  <div style="flex:1;">
                    <div style="color:var(--muted); font-size:12px; margin-bottom:4px;">Location</div>
                    <div style="font-weight:600; color:var(--ink);">
                      ${slot.location_name}
                    </div>
                  </div>
                ` : ''}

                ${slot.artist_style ? `
                  <div style="flex:1;">
                    <div style="color:var(--muted); font-size:12px; margin-bottom:4px;">Style</div>
                    <div style="font-weight:600; color:var(--ink);">
                      ${slot.artist_style}
                    </div>
                  </div>
                ` : ''}
              </div>

              <!-- Status Badges -->
              <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                ${statusBadge}
                ${slot.share_paid
                  ? '<span class="badge" style="background:#34c759; color:white;">âœ… Share Paid</span>'
                  : '<span class="badge" style="background:#ff3b30; color:white;">âŒ Share Not Paid</span>'
                }
              </div>

              <!-- Notes (if any) -->
              ${slot.notes ? `
                <div style="
                  margin-top:16px;
                  padding:12px;
                  background:rgba(142, 142, 147, 0.12);
                  border-radius:8px;
                  font-size:14px;
                  color:var(--muted);
                ">
                  <strong style="color:var(--ink);">Notes:</strong> ${slot.notes}
                </div>
              ` : ''}
            </div>
          `;
        }).join('');

        // Add event listeners
        attachWaitlistEventListeners();
      }

      // ============================================
      // Freie Waitlist Slots abrufen (1-30) - NUR FÃœR WAITLIST!
      // ============================================
      async function getAvailableWaitlistSlots(locationId = null) {
        // Diese Funktion ist NUR fÃ¼r waitlist_slots relevant!
        // upcoming_slots hat KEINE display_order Spalte!
        if (currentListType !== 'waitlist') {
          console.log('âš ï¸ getAvailableWaitlistSlots() nur fÃ¼r Waitlist - Ã¼bersprungen');
          return [];
        }

        try {
          // NUR waitlist_slots hat display_order
          let query = supabase
            .from('waitlist_slots')
            .select('display_order')
            .not('display_order', 'is', null);

          if (locationId && locationId !== 'all') {
            query = query.eq('location_id', locationId);
          }

          const { data: usedSlots, error } = await query;

          if (error) throw error;

          // Belegte Nummern extrahieren
          const usedNumbers = (usedSlots || []).map(s => s.display_order);

          // Freie Slots berechnen (1-30)
          const availableSlots = [];
          for (let i = 1; i <= 30; i++) {
            if (!usedNumbers.includes(i)) {
              availableSlots.push(i);
            }
          }

          console.log(`ðŸ“‹ Freie Waitlist-Slots: ${availableSlots.length}/30`, availableSlots);
          return availableSlots;

        } catch (error) {
          console.error('âŒ Fehler beim Laden freier Slots:', error);
          // Fallback: alle Slots verfÃ¼gbar
          return Array.from({ length: 30 }, (_, i) => i + 1);
        }
      }

      // Slot-Dropdown aktualisieren
      async function updateSlotDropdown(selectElement, locationId = null) {
        if (!selectElement) return;

        selectElement.innerHTML = '<option value="">LÃ¤dt...</option>';

        const availableSlots = await getAvailableWaitlistSlots(locationId);

        // Dropdown leeren und neu befÃ¼llen
        selectElement.innerHTML = '<option value="">Slot wÃ¤hlen...</option>';

        availableSlots.forEach(slot => {
          const option = document.createElement('option');
          option.value = slot;
          option.textContent = `Slot ${slot}`;
          selectElement.appendChild(option);
        });

        if (availableSlots.length === 0) {
          selectElement.innerHTML = '<option value="" disabled>Alle 30 Slots belegt!</option>';
        }
      }

      // ============================================
      // Add New Slot Modal
      // ============================================
      async function openAddSlotModal() {
        // Load all artists and locations for selection
        const [artistsResult, locationsResult] = await Promise.all([
          supabase
            .from('artists')
            .select('id, name, email, is_guest')
            .order('name', { ascending: true }),
          supabase
            .from('locations')
            .select('id, name')
            .order('name', { ascending: true })
        ]);

        if (artistsResult.error) {
          console.error('Error loading artists:', artistsResult.error);
          showNotification('Failed to load artists', 'error');
          return;
        }

        if (locationsResult.error) {
          console.error('Error loading locations:', locationsResult.error);
        }

        const artists = artistsResult.data || [];
        const locations = locationsResult.data || [];

        console.log('ðŸ“ All locations from database:', locations);
        console.log('ðŸ“ Location names:', locations.map(loc => loc.name));

        // Filter locations to only show the 5 specific ones (case-insensitive)
        const allowedLocationNames = [
          "Mommy I'm Sorry",
          "MuttersÃ¶hne",
          "Pardon Paris",
          "Gon",
          "Seventyone"
        ];
        const allowedLocationNamesLower = allowedLocationNames.map(name => name.toLowerCase());
        const filteredLocations = locations.filter(loc =>
          allowedLocationNamesLower.includes(loc.name.toLowerCase())
        );

        console.log('ðŸ“ Filtered locations:', filteredLocations);
        console.log('ðŸ“ Filtered location names:', filteredLocations.map(loc => loc.name));

        const modal = document.createElement('div');
        modal.id = 'addSlotModal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          backdrop-filter: blur(10px);
          z-index: 99999;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        `;

        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            display: flex;
            flex-direction: column;
          ">
            <h2 style="margin: 0 0 24px 0;">Add ${currentListType === 'waitlist' ? 'Waitlist' : 'Upcoming'} Artist Slot</h2>

            <form id="addSlotForm" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
              <!-- Artist Search - FIXED POSITION -->
              <div style="margin-bottom: 24px; position: relative; z-index: 1000;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1d1d1f;">
                  Artist *
                </label>
                <input
                  type="text"
                  id="slotArtistSearch"
                  placeholder="Search for an artist..."
                  autocomplete="off"
                  required
                  style="
                    width: 100%;
                    padding: 12px 16px;
                    border: 1px solid #e5e5ea;
                    border-radius: 12px;
                    font-size: 16px;
                    background: white;
                  "
                />
                <input type="hidden" id="slotArtistId" required />
              </div>

              <!-- SCROLLABLE CONTENT -->
              <div style="flex: 1; overflow-y: auto; margin: 0 -32px; padding: 0 32px; position: relative; z-index: 1;">

              <!-- Date Range (UPCOMING ONLY - has dates, Waitlist has NO dates) -->
              ${currentListType === 'upcoming' ? `
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1d1d1f;">
                    Start Date *
                  </label>
                  <input
                    type="date"
                    id="slotDateFrom"
                    required
                    min="${new Date().toISOString().split('T')[0]}"
                    style="
                      width: 100%;
                      padding: 12px 16px;
                      border: 1px solid #e5e5ea;
                      border-radius: 12px;
                      font-size: 16px;
                    "
                  />
                </div>

                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1d1d1f;">
                    End Date *
                  </label>
                  <input
                    type="date"
                    id="slotDateTo"
                    required
                    min="${new Date().toISOString().split('T')[0]}"
                    style="
                      width: 100%;
                      padding: 12px 16px;
                      border: 1px solid #e5e5ea;
                      border-radius: 12px;
                      font-size: 16px;
                    "
                  />
                </div>
              </div>
              ` : ''}

              <!-- Location -->
              <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1d1d1f;">
                  Location *
                </label>
                <select
                  id="slotLocationSelect"
                  required
                  style="
                    width: 100%;
                    padding: 12px 16px;
                    border: 1px solid #e5e5ea;
                    border-radius: 12px;
                    font-size: 16px;
                    background: white;
                  "
                >
                  <option value="">Select a location...</option>
                  ${filteredLocations.map(loc => `
                    <option value="${loc.id}">${loc.name}</option>
                  `).join('')}
                </select>
              </div>

              <!-- Slot Number (1-30) - NUR FÃœR WAITLIST -->
              ${currentListType === 'waitlist' ? `
              <div id="slotNumberContainer" style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1d1d1f;">
                  Slot Nummer (1-30) *
                </label>
                <select
                  id="slotNumberSelect"
                  required
                  style="
                    width: 100%;
                    padding: 12px 16px;
                    border: 1px solid #e5e5ea;
                    border-radius: 12px;
                    font-size: 16px;
                    background: white;
                  "
                >
                  <option value="">Zuerst Location wÃ¤hlen...</option>
                </select>
                <p style="margin: 8px 0 0 0; font-size: 12px; color: #86868b;">
                  Zeigt nur freie Slots fÃ¼r die gewÃ¤hlte Location
                </p>
              </div>
              ` : ''}

              <!-- Notes -->
              <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1d1d1f;">
                  Internal Notes (optional)
                </label>
                <textarea
                  id="slotNotes"
                  rows="3"
                  placeholder="Add any internal notes about this slot..."
                  style="
                    width: 100%;
                    padding: 12px 16px;
                    border: 1px solid #e5e5ea;
                    border-radius: 12px;
                    font-size: 16px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    resize: vertical;
                  "
                ></textarea>
              </div>

              <!-- Actions -->
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button
                  type="button"
                  id="cancelSlotButton"
                  style="
                    padding: 12px 24px;
                    border: 1px solid #e5e5ea;
                    border-radius: 12px;
                    background: white;
                    color: #1d1d1f;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                  "
                >
                  Cancel
                </button>

                <button
                  type="submit"
                  style="
                    padding: 12px 24px;
                    border: none;
                    border-radius: 12px;
                    background: #007aff;
                    color: white;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                  "
                >
                  Add Slot
                </button>
              </div>

              </div>
            </form>
          </div>
        `;

        document.body.appendChild(modal);

        // Setup location change listener to update slot dropdown - NUR FÃœR WAITLIST
        const locationSelect = document.getElementById('slotLocationSelect');
        const slotNumberSelect = document.getElementById('slotNumberSelect');

        locationSelect.addEventListener('change', async function() {
          const selectedLocationId = this.value;
          // Slot-Dropdown nur fÃ¼r Waitlist aktualisieren (existiert nur dort)
          if (currentListType === 'waitlist' && slotNumberSelect) {
            if (selectedLocationId) {
              await updateSlotDropdown(slotNumberSelect, selectedLocationId);
            } else {
              slotNumberSelect.innerHTML = '<option value="">Zuerst Location wÃ¤hlen...</option>';
            }
          }
        });

        // Setup artist search functionality
        const searchInput = document.getElementById('slotArtistSearch');
        const artistIdInput = document.getElementById('slotArtistId');

        // Create dropdown OUTSIDE modal, mounted to body
        const searchResults = document.createElement('div');
        searchResults.id = 'artistSearchResults';
        searchResults.style.cssText = `
          display: none;
          position: fixed;
          background: white;
          border: 1px solid #e5e5ea;
          border-radius: 12px;
          max-height: 300px;
          overflow-y: auto;
          box-shadow: 0 8px 16px rgba(0,0,0,0.15);
          z-index: 100000;
        `;
        document.body.appendChild(searchResults);

        // Function to position dropdown below input
        function positionDropdown() {
          const rect = searchInput.getBoundingClientRect();
          searchResults.style.top = `${rect.bottom + 4}px`;
          searchResults.style.left = `${rect.left}px`;
          searchResults.style.width = `${rect.width}px`;
        }

        let selectedArtist = null;

        searchInput.addEventListener('input', function() {
          const query = this.value.toLowerCase().trim();

          console.log('ðŸ” Artist search query:', query);

          if (query.length === 0) {
            searchResults.style.display = 'none';
            artistIdInput.value = '';
            selectedArtist = null;
            return;
          }

          // Filter artists
          const filtered = artists.filter(artist =>
            artist.name.toLowerCase().includes(query) ||
            (artist.email && artist.email.toLowerCase().includes(query))
          );

          console.log(`âœ… Found ${filtered.length} matching artists`);

          if (filtered.length === 0) {
            searchResults.innerHTML = `
              <div style="padding: 16px; text-align: center; color: #86868b;">
                No artists found
              </div>
            `;
            positionDropdown();
            searchResults.style.display = 'block';
            artistIdInput.value = '';
            selectedArtist = null;
            return;
          }

          // Render results
          searchResults.innerHTML = filtered.map(artist => `
            <div
              class="artist-search-result"
              data-artist-id="${artist.id}"
              data-artist-name="${artist.name}"
              style="
                padding: 12px 16px;
                cursor: pointer;
                border-bottom: 1px solid #f5f5f7;
                transition: background 0.2s;
                background: white;
              "
              onmouseover="this.style.background='#f5f5f7'"
              onmouseout="this.style.background='white'"
            >
              <div style="font-weight: 600; color: #1d1d1f;">${artist.name}</div>
              <div style="font-size: 14px; color: #86868b;">
                ${artist.email || ''} ${artist.is_guest ? 'Â· Guest Artist' : ''}
              </div>
            </div>
          `).join('');

          // Position and show dropdown
          positionDropdown();
          searchResults.style.display = 'block';

          console.log('ðŸ“‹ Dropdown displayed at position:', {
            top: searchResults.style.top,
            left: searchResults.style.left,
            width: searchResults.style.width,
            zIndex: searchResults.style.zIndex
          });

          // Add click handlers to results
          document.querySelectorAll('.artist-search-result').forEach(item => {
            item.addEventListener('click', function() {
              const artistId = this.dataset.artistId;
              const artistName = this.dataset.artistName;

              searchInput.value = artistName;
              artistIdInput.value = artistId;
              selectedArtist = artists.find(a => a.id === artistId);
              searchResults.style.display = 'none';

              console.log('âœ… Artist selected:', artistName, '(ID:', artistId + ')');
            });
          });
        });

        // Close search results when clicking outside
        document.addEventListener('click', function closeSearchResults(e) {
          if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
          }
        });

        // Event listeners
        document.getElementById('cancelSlotButton').addEventListener('click', () => {
          searchResults.remove();
          modal.remove();
        });

        document.getElementById('addSlotForm').addEventListener('submit', async (e) => {
          e.preventDefault();

          // Validate artist selection
          if (!artistIdInput.value) {
            showNotification('Please select an artist from the search results', 'error');
            return;
          }

          await handleAddSlot();
          searchResults.remove();
          modal.remove();
        });

        // Close on backdrop click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            searchResults.remove();
            modal.remove();
          }
        });
      }

      // ============================================
      // Utility: Show Notification
      // ============================================
      function showNotification(message, type = 'info') {
        // Simple alert for now - could be enhanced with custom UI later
        const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
        alert(`${icon} ${message}`);
      }

      // Export showNotification globally
      window.showNotification = showNotification;

      // ============================================
      // Handle Add Slot (GETRENNTE LOGIK fÃ¼r Waitlist/Upcoming)
      // ============================================
      async function handleAddSlot() {
        const artistId = document.getElementById('slotArtistId').value;
        const locationId = document.getElementById('slotLocationSelect').value;
        const notes = document.getElementById('slotNotes').value;

        // Basis-Validierung (fÃ¼r beide Listen)
        if (!artistId || !locationId) {
          showNotification('Bitte Artist und Location auswÃ¤hlen', 'error');
          return;
        }

        let slotData;
        let tableName;

        // ========== WAITLIST: MIT display_order, OHNE Datum ==========
        if (currentListType === 'waitlist') {
          const slotNumberSelect = document.getElementById('slotNumberSelect');
          const slotNumber = slotNumberSelect ? slotNumberSelect.value : null;

          if (!slotNumber) {
            showNotification('Bitte Slot-Nummer auswÃ¤hlen', 'error');
            return;
          }

          slotData = {
            artist_id: artistId,
            location_id: locationId,
            display_order: parseInt(slotNumber),
            status: 'active',
            notes: notes || null
            // KEIN date_from, date_to!
          };
          tableName = 'waitlist_slots';

        // ========== UPCOMING: OHNE display_order, MIT Datum ==========
        } else {
          const dateFrom = document.getElementById('slotDateFrom')?.value;
          const dateTo = document.getElementById('slotDateTo')?.value;

          if (!dateFrom || !dateTo) {
            showNotification('Bitte Start- und Enddatum ausfÃ¼llen', 'error');
            return;
          }

          if (new Date(dateTo) < new Date(dateFrom)) {
            showNotification('Enddatum muss nach Startdatum liegen', 'error');
            return;
          }

          slotData = {
            artist_id: artistId,
            location_id: locationId,
            date_from: dateFrom,
            date_to: dateTo,
            status: 'upcoming',
            notes: notes || null
            // KEIN display_order!
          };
          tableName = 'upcoming_slots';
        }

        try {
          console.log(`âž• Adding slot to ${tableName}:`, slotData);

          const { data, error } = await supabase
            .from(tableName)
            .insert([slotData])
            .select();

          if (error) {
            console.error('âŒ Database Error:', {
              table: tableName,
              listType: currentListType,
              slotData: slotData,
              error: error.message,
              details: error.details,
              hint: error.hint,
              code: error.code
            });
            throw error;
          }

          console.log(`âœ… ${currentListType} slot added successfully:`, data);
          showNotification('Slot erfolgreich hinzugefÃ¼gt', 'success');

          // Reload slots
          await loadWaitlistSlots(currentWaitlistLocation);

        } catch (error) {
          console.error(`âŒ Error adding ${currentListType} slot:`, error);

          // Provide more specific error messages
          let errorMessage = 'Fehler beim HinzufÃ¼gen: ';
          if (error.code === '23505') {
            errorMessage += 'Diese Slot-Nummer ist bereits vergeben';
          } else if (error.message.includes('date')) {
            errorMessage += 'UngÃ¼ltige Datumswerte';
          } else {
            errorMessage += error.message;
          }

          showNotification(errorMessage, 'error');
        }
      }

      // ============================================
      // Delete Slot (Supports Both Lists and Arrays)
      // ============================================
      async function deleteWaitlistSlot(slotIds) {
        // Support both single ID and array of IDs
        const idsArray = Array.isArray(slotIds) ? slotIds : [slotIds];

        const confirmMsg = idsArray.length > 1
          ? `${idsArray.length} zusammenhÃ¤ngende Slots wirklich lÃ¶schen?`
          : 'Slot wirklich lÃ¶schen?';

        if (!confirm(confirmMsg)) {
          return;
        }

        try {
          // Select appropriate table based on currentListType
          const tableName = currentListType === 'waitlist'
            ? 'waitlist_slots'
            : 'upcoming_slots';

          console.log(`ðŸ—‘ï¸ Deleting ${idsArray.length} slot(s) from ${tableName}:`, idsArray);

          const { error } = await supabase
            .from(tableName)
            .delete()
            .in('id', idsArray);

          if (error) {
            console.error('âŒ Database Error:', {
              table: tableName,
              slotIds: idsArray,
              error: error.message,
              details: error.details,
              hint: error.hint,
              code: error.code
            });
            throw error;
          }

          const message = idsArray.length > 1
            ? `${idsArray.length} Slots erfolgreich gelÃ¶scht`
            : 'Slot erfolgreich gelÃ¶scht';
          console.log(`âœ… ${currentListType} slot(s) deleted successfully`);
          showNotification(message, 'success');

          // Reload slots
          await loadWaitlistSlots(currentWaitlistLocation);

        } catch (error) {
          console.error(`âŒ Error deleting ${currentListType} slot(s):`, error);
          showNotification('Failed to delete slot: ' + error.message, 'error');
        }
      }

      // ============================================
      // Toggle Share Paid (Supports Both Lists)
      // ============================================
      async function toggleSharePaid(slotId, currentStatus) {
        const newStatus = !currentStatus;

        try {
          // Select appropriate table and field based on currentListType
          const tableName = currentListType === 'waitlist'
            ? 'waitlist_slots'
            : 'upcoming_slots';

          // IMPORTANT: Different tables use different field names
          // - waitlist_slots: uses 'share_paid'
          // - upcoming_slots: uses 'share_personal_data'
          const fieldName = currentListType === 'waitlist'
            ? 'share_paid'
            : 'share_personal_data';

          const updateData = { [fieldName]: newStatus };

          console.log(`ðŸ”„ Updating ${tableName}.${fieldName} to ${newStatus} for slot ${slotId}`);

          const { error } = await supabase
            .from(tableName)
            .update(updateData)
            .eq('id', slotId);

          if (error) {
            console.error('âŒ Database Error:', {
              table: tableName,
              field: fieldName,
              slotId: slotId,
              error: error.message,
              details: error.details,
              hint: error.hint
            });
            throw error;
          }

          console.log(`âœ… Successfully updated ${tableName}.${fieldName}`);
          showNotification(`Share marked as ${newStatus ? 'paid' : 'unpaid'}`, 'success');
          await loadWaitlistSlots(currentWaitlistLocation);

        } catch (error) {
          console.error('âŒ Error updating share paid status:', error);
          showNotification('Failed to update share paid status: ' + error.message, 'error');
        }
      }

      // ============================================
      // Cancel Upcoming Slot (supports single ID or array of IDs)
      // ============================================
      async function cancelUpcomingSlot(slotIds) {
        // Support both single ID and array of IDs
        const idsArray = Array.isArray(slotIds) ? slotIds : [slotIds];

        const confirmMsg = idsArray.length > 1
          ? `${idsArray.length} zusammenhÃ¤ngende Slots wirklich stornieren?`
          : 'Slot wirklich stornieren?';

        if (!confirm(confirmMsg)) return;

        const reason = prompt('Grund fÃ¼r Absage (optional):');
        if (reason === null) return; // User clicked browser Cancel

        console.log('ðŸš« Canceling slots:', idsArray);

        try {
          const { error } = await supabase
            .from('upcoming_slots')
            .update({
              status: 'canceled',
              cancel_reason: reason.trim() || null,
              canceled_at: new Date().toISOString(),
              canceled_by: currentUser?.id || null
            })
            .in('id', idsArray);

          if (error) throw error;

          const message = idsArray.length > 1
            ? `${idsArray.length} Guest Spots wurden abgesagt`
            : 'Guest Spot wurde abgesagt';
          showNotification(message, 'success');
          loadWaitlistSlots(currentWaitlistLocation);

        } catch (error) {
          console.error('âŒ Error canceling slots:', error);
          showNotification('Fehler: ' + error.message, 'error');
        }
      }

      // Make globally accessible
      window.cancelUpcomingSlot = cancelUpcomingSlot;

      // ============================================
      // Edit Slot Modal Functions
      // ============================================
      function openEditSlotModal(editData) {
        console.log('ðŸ“ Opening edit modal with data:', editData);

        // Create modal if it doesn't exist
        let modal = document.getElementById('editSlotModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'editSlotModal';
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
          `;
          modal.innerHTML = `
            <div style="
              background: var(--macos-elevated, #fff);
              border-radius: 16px;
              padding: 32px;
              max-width: 500px;
              width: 90%;
              max-height: 90vh;
              overflow-y: auto;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            ">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h2 style="margin:0; font-size:20px; color:var(--ink);">Slot bearbeiten</h2>
                <button onclick="closeEditSlotModal()" style="
                  background:none;
                  border:none;
                  font-size:24px;
                  cursor:pointer;
                  color:var(--muted);
                  padding:0;
                  line-height:1;
                ">&times;</button>
              </div>

              <form id="editSlotForm" style="display:flex; flex-direction:column; gap:16px;">
                <input type="hidden" id="editSlotIds" />

                <div>
                  <label style="display:block; margin-bottom:6px; font-weight:500; color:var(--ink);">Artist</label>
                  <input type="text" id="editSlotArtist" readonly style="
                    width:100%;
                    padding:12px;
                    border:1px solid var(--border-color);
                    border-radius:8px;
                    background:rgba(142,142,147,0.12);
                    color:var(--muted);
                    font-size:14px;
                    box-sizing:border-box;
                  " />
                </div>

                <div>
                  <label style="display:block; margin-bottom:6px; font-weight:500; color:var(--ink);">Location</label>
                  <select id="editSlotLocation" style="
                    width:100%;
                    padding:12px;
                    border:1px solid var(--border-color);
                    border-radius:8px;
                    background:var(--macos-elevated);
                    color:var(--ink);
                    font-size:14px;
                    box-sizing:border-box;
                  "></select>
                </div>

                <div style="display:flex; gap:16px;">
                  <div style="flex:1;">
                    <label style="display:block; margin-bottom:6px; font-weight:500; color:var(--ink);">Start Datum</label>
                    <input type="date" id="editSlotDateFrom" required style="
                      width:100%;
                      padding:12px;
                      border:1px solid var(--border-color);
                      border-radius:8px;
                      background:var(--macos-elevated);
                      color:var(--ink);
                      font-size:14px;
                      box-sizing:border-box;
                    " />
                  </div>
                  <div style="flex:1;">
                    <label style="display:block; margin-bottom:6px; font-weight:500; color:var(--ink);">End Datum</label>
                    <input type="date" id="editSlotDateTo" required style="
                      width:100%;
                      padding:12px;
                      border:1px solid var(--border-color);
                      border-radius:8px;
                      background:var(--macos-elevated);
                      color:var(--ink);
                      font-size:14px;
                      box-sizing:border-box;
                    " />
                  </div>
                </div>

                <div>
                  <label style="display:block; margin-bottom:6px; font-weight:500; color:var(--ink);">Notizen</label>
                  <textarea id="editSlotNotes" rows="3" style="
                    width:100%;
                    padding:12px;
                    border:1px solid var(--border-color);
                    border-radius:8px;
                    background:var(--macos-elevated);
                    color:var(--ink);
                    font-size:14px;
                    resize:vertical;
                    box-sizing:border-box;
                  "></textarea>
                </div>

                <div style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" id="editSlotSharePaid" style="width:18px; height:18px;" />
                  <label for="editSlotSharePaid" style="font-weight:500; color:var(--ink);">Share bezahlt</label>
                </div>

                <div id="editSlotGroupedInfo" style="
                  display:none;
                  padding:12px;
                  background:rgba(255,149,0,0.15);
                  border:1px solid rgba(255,149,0,0.3);
                  border-radius:8px;
                  color:#ff9500;
                  font-size:14px;
                ">
                  âš ï¸ Diese Ã„nderungen betreffen <span id="editSlotGroupedCount"></span> zusammenhÃ¤ngende Slots.
                  Die Slots werden zu einem einzigen Slot zusammengefasst.
                </div>

                <div style="display:flex; gap:12px; margin-top:8px;">
                  <button type="button" onclick="closeEditSlotModal()" style="
                    flex:1;
                    padding:14px;
                    border:1px solid var(--border-color);
                    border-radius:8px;
                    background:var(--macos-elevated);
                    color:var(--ink);
                    font-size:14px;
                    font-weight:500;
                    cursor:pointer;
                  ">Abbrechen</button>
                  <button type="submit" style="
                    flex:1;
                    padding:14px;
                    border:none;
                    border-radius:8px;
                    background:#007aff;
                    color:white;
                    font-size:14px;
                    font-weight:600;
                    cursor:pointer;
                  ">Speichern</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(modal);

          // Add form submit handler
          document.getElementById('editSlotForm').addEventListener('submit', (e) => {
            e.preventDefault();
            saveEditedSlot();
          });

          // Close on backdrop click
          modal.addEventListener('click', (e) => {
            if (e.target === modal) closeEditSlotModal();
          });
        }

        // Fill form with data
        document.getElementById('editSlotIds').value = JSON.stringify(editData.slot_ids);
        document.getElementById('editSlotArtist').value = editData.artist_name;
        document.getElementById('editSlotDateFrom').value = editData.date_from;
        document.getElementById('editSlotDateTo').value = editData.date_to;
        document.getElementById('editSlotNotes').value = editData.notes || '';
        document.getElementById('editSlotSharePaid').checked = editData.share_paid;

        // Populate location dropdown
        populateEditSlotLocationDropdown(editData.location_id);

        // Show grouped info if multiple slots
        const groupedInfo = document.getElementById('editSlotGroupedInfo');
        if (editData.is_grouped) {
          groupedInfo.style.display = 'block';
          document.getElementById('editSlotGroupedCount').textContent = editData.slot_ids.length;
        } else {
          groupedInfo.style.display = 'none';
        }

        // Show modal
        modal.style.display = 'flex';
      }

      async function populateEditSlotLocationDropdown(selectedLocationId) {
        const select = document.getElementById('editSlotLocation');
        if (!select) return;

        try {
          const { data: locations, error } = await supabase
            .from('locations')
            .select('id, name, city')
            .order('name');

          if (error) throw error;

          select.innerHTML = (locations || []).map(loc =>
            `<option value="${loc.id}" ${loc.id === selectedLocationId ? 'selected' : ''}>
              ${loc.name}${loc.city ? ` (${loc.city})` : ''}
            </option>`
          ).join('');

        } catch (error) {
          console.error('Error loading locations:', error);
          select.innerHTML = '<option value="">Fehler beim Laden</option>';
        }
      }

      function closeEditSlotModal() {
        const modal = document.getElementById('editSlotModal');
        if (modal) modal.style.display = 'none';
      }

      async function saveEditedSlot() {
        const slotIds = JSON.parse(document.getElementById('editSlotIds').value);
        const locationId = document.getElementById('editSlotLocation').value;
        const dateFrom = document.getElementById('editSlotDateFrom').value;
        const dateTo = document.getElementById('editSlotDateTo').value;
        const notes = document.getElementById('editSlotNotes').value;
        const sharePaid = document.getElementById('editSlotSharePaid').checked;

        console.log('ðŸ’¾ Saving edited slot:', { slotIds, locationId, dateFrom, dateTo, notes, sharePaid });

        // Validation
        if (!dateFrom || !dateTo) {
          showNotification('Bitte Start- und Enddatum angeben', 'error');
          return;
        }

        if (new Date(dateTo) < new Date(dateFrom)) {
          showNotification('Enddatum muss nach Startdatum liegen', 'error');
          return;
        }

        try {
          if (slotIds.length > 1) {
            // Grouped slots: Delete all old, create one new merged slot
            console.log('ðŸ”„ Merging', slotIds.length, 'slots into one...');

            // Get artist_id from first slot
            const { data: firstSlot, error: fetchError } = await supabase
              .from('upcoming_slots')
              .select('artist_id, created_by')
              .eq('id', slotIds[0])
              .single();

            if (fetchError) throw fetchError;

            // Delete all old slots
            const { error: deleteError } = await supabase
              .from('upcoming_slots')
              .delete()
              .in('id', slotIds);

            if (deleteError) throw deleteError;

            // Create one new merged slot
            const { error: insertError } = await supabase
              .from('upcoming_slots')
              .insert({
                artist_id: firstSlot.artist_id,
                location_id: locationId,
                date_from: dateFrom,
                date_to: dateTo,
                notes: notes || null,
                share_personal_data: sharePaid,
                status: 'upcoming',
                created_by: firstSlot.created_by
              });

            if (insertError) throw insertError;

            showNotification(`${slotIds.length} Slots zu einem zusammengefasst`, 'success');

          } else {
            // Single slot: Normal update
            const { error } = await supabase
              .from('upcoming_slots')
              .update({
                location_id: locationId,
                date_from: dateFrom,
                date_to: dateTo,
                notes: notes || null,
                share_personal_data: sharePaid
              })
              .eq('id', slotIds[0]);

            if (error) throw error;

            showNotification('Slot gespeichert', 'success');
          }

          closeEditSlotModal();
          await loadWaitlistSlots(currentWaitlistLocation);

        } catch (error) {
          console.error('âŒ Error saving slot:', error);
          showNotification('Fehler beim Speichern: ' + error.message, 'error');
        }
      }

      // Make edit functions globally accessible
      window.openEditSlotModal = openEditSlotModal;
      window.closeEditSlotModal = closeEditSlotModal;
      window.saveEditedSlot = saveEditedSlot;

      // ============================================
      // Event Listeners
      // ============================================
      function attachWaitlistEventListeners() {
        // Delete buttons (supports grouped slots with multiple IDs)
        document.querySelectorAll('.delete-slot-button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            // Support both old single ID and new array format
            const slotIds = btn.dataset.slotIds
              ? JSON.parse(btn.dataset.slotIds)
              : btn.dataset.slotId;
            deleteWaitlistSlot(slotIds);
          });
        });

        // Edit buttons (supports grouped slots with multiple IDs)
        document.querySelectorAll('.edit-slot-button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const slotIds = btn.dataset.slotIds
              ? JSON.parse(btn.dataset.slotIds)
              : [btn.dataset.slotId];
            const editData = {
              slot_ids: slotIds,
              artist_name: btn.dataset.artistName || 'Unknown',
              location_id: btn.dataset.locationId || '',
              date_from: btn.dataset.dateFrom || '',
              date_to: btn.dataset.dateTo || '',
              notes: btn.dataset.notes || '',
              share_paid: btn.dataset.sharePaid === 'true',
              is_grouped: slotIds.length > 1
            };
            openEditSlotModal(editData);
          });
        });

        // Toggle share paid buttons
        document.querySelectorAll('.toggle-share-paid-button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const slotId = btn.dataset.slotId;
            const currentStatus = btn.dataset.currentStatus === 'true';
            toggleSharePaid(slotId, currentStatus);
          });
        });
      }

      // ============================================
      // Initialize Waitlist Tab (Dual List System)
      // ============================================
      async function initWaitlist() {
        console.log('ðŸ“‹ Initializing Waitlist (Dual List System)...');

        // List type toggle buttons
        const toggleButtons = document.querySelectorAll('.list-toggle-option');
        toggleButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const listType = btn.dataset.listType;
            switchListType(listType);
          });
        });

        // Add slot button
        const addButton = document.getElementById('addWaitlistSlotButton');
        if (addButton) {
          addButton.addEventListener('click', openAddSlotModal);
        }

        // Search input
        const searchInput = document.getElementById('waitlistSearchInput');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            const slotCards = document.querySelectorAll('.waitlist-slot-card');

            slotCards.forEach(card => {
              const artistName = card.querySelector('h3')?.textContent.toLowerCase() || '';
              const artistEmail = card.querySelector('p')?.textContent.toLowerCase() || '';

              if (artistName.includes(searchTerm) || artistEmail.includes(searchTerm)) {
                card.style.display = '';
              } else {
                card.style.display = 'none';
              }
            });
          });
        }

        // Location filter dropdown
        const waitlistLocationFilter = document.getElementById('waitlistLocationFilter');
        if (waitlistLocationFilter) {
          waitlistLocationFilter.addEventListener('change', async (e) => {
            const location = e.target.value;
            currentWaitlistLocation = location;

            // Reload slots
            await loadWaitlistSlots(location);
          });
        }

        // Load initial data (default to upcoming since waitlist is now separate tab)
        await loadWaitlistSlots(currentWaitlistLocation);

        console.log('âœ… Waitlist (Dual List System) initialized');
      }

      // ============================================
      // WAITLIST-ONLY SECTION (Separate Head Tab)
      // ============================================
      let waitlistOnlyInitialized = false;

      async function initWaitlistOnlySection() {
        console.log('ðŸ“‹ Initializing Waitlist-Only Section...');

        // Add slot button
        const addButton = document.getElementById('addWaitlistSlotButtonMain');
        if (addButton) {
          // Remove existing listener if any
          addButton.replaceWith(addButton.cloneNode(true));
          const newButton = document.getElementById('addWaitlistSlotButtonMain');
          if (newButton) {
            newButton.addEventListener('click', openAddWaitlistSlotModal);
          }
        }

        // Search input
        const searchInput = document.getElementById('waitlistOnlySearchInput');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            const slotCards = document.querySelectorAll('#waitlistOnlySlotsContainer .waitlist-slot-card');

            slotCards.forEach(card => {
              const artistName = card.querySelector('h3')?.textContent.toLowerCase() || '';
              const artistEmail = card.querySelector('p')?.textContent.toLowerCase() || '';

              if (artistName.includes(searchTerm) || artistEmail.includes(searchTerm)) {
                card.style.display = '';
              } else {
                card.style.display = 'none';
              }
            });
          });
        }

        // Location filter dropdown
        const locationFilter = document.getElementById('waitlistOnlyLocationFilter');
        if (locationFilter) {
          // Populate with locations
          const locations = window.locationsCache || [];
          locationFilter.innerHTML = '<option value="all">All Locations</option>' +
            locations.map(loc => `<option value="${loc.id}">${loc.name}${loc.city ? ' (' + loc.city + ')' : ''}</option>`).join('');

          locationFilter.addEventListener('change', async (e) => {
            await loadWaitlistOnlySlots(e.target.value);
          });
        }

        // Load initial data
        await loadWaitlistOnlySlots('all');

        waitlistOnlyInitialized = true;
        console.log('âœ… Waitlist-Only Section initialized');
      }

      async function loadWaitlistOnlySlots(locationFilter = 'all') {
        console.log('ðŸ“‹ Loading Waitlist Slots (artists WITHOUT booking dates)...');
        console.log('   View: waitlist_slots_ordered, Location filter:', locationFilter);

        const container = document.getElementById('waitlistOnlySlotsContainer');
        const emptyState = document.getElementById('waitlistOnlyEmptyState');

        if (!container) {
          console.warn('âš ï¸ waitlistOnlySlotsContainer not found');
          return;
        }

        try {
          // Query waitlist_slots_ordered view - artists WITHOUT booking dates
          let query = supabase
            .from('waitlist_slots_ordered')
            .select('*')
            .in('status', ['waiting', 'active', 'upcoming'])
            .order('display_order', { ascending: true });

          if (locationFilter && locationFilter !== 'all') {
            query = query.eq('location_id', locationFilter);
          }

          const { data, error } = await query;

          if (error) throw error;

          console.log(`âœ… Loaded ${data?.length || 0} waitlist slots from waitlist_slots_ordered`);

          if (!data || data.length === 0) {
            container.innerHTML = '';
            if (emptyState) emptyState.style.display = 'block';
            return;
          }

          if (emptyState) emptyState.style.display = 'none';

          // Render slots using the same card format as the main waitlist
          container.innerHTML = data.map(slot => renderWaitlistOnlyCard(slot)).join('');

          // Add event listeners for cards
          attachWaitlistOnlyCardListeners();

        } catch (err) {
          console.error('âŒ Error loading waitlist-only slots:', err);
          container.innerHTML = `<p style="color: red; text-align: center;">Error loading waitlist: ${err.message}</p>`;
        }
      }

      function renderWaitlistOnlyCard(slot) {
        const artistName = slot.artist_name || 'Unknown Artist';
        const artistEmail = slot.artist_email || '';
        const locationName = slot.location_name || 'Unknown Location';
        const status = slot.status || 'waiting';
        const isPaid = slot.share_paid || false;
        const displayOrder = slot.display_order || '-';

        const statusColors = {
          'waiting': { bg: 'rgba(255, 149, 0, 0.1)', color: '#FF9500', label: 'Waiting' },
          'active': { bg: 'rgba(52, 199, 89, 0.1)', color: '#34C759', label: 'Active' },
          'upcoming': { bg: 'rgba(0, 122, 255, 0.1)', color: '#007AFF', label: 'Upcoming' }
        };
        const statusStyle = statusColors[status] || statusColors['waiting'];

        return `
          <div class="waitlist-slot-card" data-slot-id="${slot.id}" style="
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
          " onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="
                    background: rgba(142, 142, 147, 0.12);
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-size: 12px;
                    font-weight: 600;
                    color: #86868b;
                  ">#${displayOrder}</span>
                  <h3 style="margin: 0; font-size: 16px; font-weight: 600;">${artistName}</h3>
                </div>
                <p style="margin: 0 0 8px 0; font-size: 13px; color: #86868b;">${artistEmail}</p>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <span style="
                    background: ${statusStyle.bg};
                    color: ${statusStyle.color};
                    padding: 4px 10px;
                    border-radius: 6px;
                    font-size: 11px;
                    font-weight: 600;
                  ">${statusStyle.label}</span>
                  <span style="
                    background: rgba(142, 142, 147, 0.08);
                    color: #86868b;
                    padding: 4px 10px;
                    border-radius: 6px;
                    font-size: 11px;
                  ">${locationName}</span>
                  ${isPaid ? `<span style="
                    background: rgba(52, 199, 89, 0.1);
                    color: #34C759;
                    padding: 4px 10px;
                    border-radius: 6px;
                    font-size: 11px;
                    font-weight: 600;
                  ">âœ“ Paid</span>` : ''}
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="waitlist-only-edit-btn" data-slot-id="${slot.id}" style="
                  padding: 8px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 8px;
                  background: white;
                  cursor: pointer;
                " title="Edit">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
                <button class="waitlist-only-delete-btn" data-slot-id="${slot.id}" style="
                  padding: 8px;
                  border: 1px solid rgba(255, 59, 48, 0.3);
                  border-radius: 8px;
                  background: rgba(255, 59, 48, 0.05);
                  cursor: pointer;
                  color: #FF3B30;
                " title="Delete">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        `;
      }

      function attachWaitlistOnlyCardListeners() {
        // Edit buttons
        document.querySelectorAll('#waitlistOnlySlotsContainer .waitlist-only-edit-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const slotId = btn.dataset.slotId;
            // Temporarily switch to waitlist mode to use existing edit modal
            const prevListType = currentListType;
            currentListType = 'waitlist';
            await openEditSlotModalById(slotId);
            currentListType = prevListType;
          });
        });

        // Delete buttons
        document.querySelectorAll('#waitlistOnlySlotsContainer .waitlist-only-delete-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const slotId = btn.dataset.slotId;
            if (confirm('Are you sure you want to delete this waitlist slot?')) {
              try {
                const { error } = await supabase
                  .from('waitlist_slots')
                  .delete()
                  .eq('id', slotId);

                if (error) throw error;

                showNotification('Waitlist slot deleted', 'success');
                await loadWaitlistOnlySlots(document.getElementById('waitlistOnlyLocationFilter')?.value || 'all');
              } catch (err) {
                console.error('Error deleting slot:', err);
                showNotification('Error deleting slot: ' + err.message, 'error');
              }
            }
          });
        });

        // Card click - open detail
        document.querySelectorAll('#waitlistOnlySlotsContainer .waitlist-slot-card').forEach(card => {
          card.addEventListener('click', async (e) => {
            if (e.target.closest('button')) return; // Ignore button clicks
            const slotId = card.dataset.slotId;
            const prevListType = currentListType;
            currentListType = 'waitlist';
            await openEditSlotModalById(slotId);
            currentListType = prevListType;
          });
        });
      }

      async function openEditSlotModalById(slotId) {
        try {
          const { data, error } = await supabase
            .from('waitlist_slots_ordered')
            .select('*')
            .eq('id', slotId)
            .single();

          if (error) throw error;

          if (data) {
            openEditSlotModal({
              id: data.id,
              artist_id: data.artist_id,
              artist_name: data.artist_name,
              location_id: data.location_id,
              location_name: data.location_name,
              display_order: data.display_order,
              status: data.status,
              is_paid: data.share_paid,
              notes: data.notes,
              slot_ids: [data.id],
              is_grouped: false
            });
          }
        } catch (err) {
          console.error('Error loading slot for edit:', err);
          showNotification('Error loading slot: ' + err.message, 'error');
        }
      }

      // Wrapper function for adding waitlist slots from Waitlist-Only section
      function openAddWaitlistSlotModal() {
        // Temporarily set list type to waitlist to use the waitlist add modal
        const prevListType = currentListType;
        currentListType = 'waitlist';
        openAddSlotModal();
        // Note: currentListType will be restored when the modal is closed or saved
      }
      window.openAddWaitlistSlotModal = openAddWaitlistSlotModal;

      // ========================================
      // PAYMENT WORKFLOW EVENT LISTENERS
      // ========================================

      // Payment price input - Calculate deposit
      const paymentPriceInput = document.getElementById('paymentTotalPrice');
      if (paymentPriceInput) {
        paymentPriceInput.addEventListener('input', function() {
          const totalPrice = parseFloat(this.value);

          if (totalPrice && totalPrice > 0) {
            const depositAmount = totalPrice / 2;

            // Show calculation
            document.getElementById('displayTotalPrice').textContent = `â‚¬${totalPrice.toFixed(2)}`;
            document.getElementById('displayDepositPrice').textContent = `â‚¬${depositAmount.toFixed(2)}`;
            document.getElementById('paymentDepositDisplay').style.display = 'block';

            // Enable button if checkbox also checked
            updateSendButtonState();
          } else {
            document.getElementById('paymentDepositDisplay').style.display = 'none';
            updateSendButtonState();
          }
        });
      }

      // Payment confirmation checkbox
      const paymentCheckbox = document.getElementById('paymentConfirmCheckbox');
      if (paymentCheckbox) {
        paymentCheckbox.addEventListener('change', function() {
          updateSendButtonState();
        });
      }

      // Close modal on backdrop click
      const paymentModal = document.getElementById('paymentWorkflowModal');
      if (paymentModal) {
        paymentModal.addEventListener('click', function(e) {
          if (e.target.id === 'paymentWorkflowModal') {
            closePaymentWorkflowModal();
          }
        });
      }

      // ========================================
      // PAYMENT WORKFLOW SYSTEM
      // ========================================

      // Global variable for current payment request
      let currentPaymentRequest = null;

      /**
       * Open Payment Workflow Modal
       * Loads request data and displays payment configuration interface
       */
      async function openPaymentWorkflowModal(requestId) {
        console.log('ðŸ’³ Opening payment workflow for request:', requestId);

        try {
          // Load request data with all relations
          const { data: request, error } = await supabase
            .from('requests')
            .select(`
              *,
              customer:customers(*),
              artist:artists(*),
              location:locations!requests_location_id_fkey(*)
            `)
            .eq('id', requestId)
            .single();

          if (error) {
            console.error('âŒ Error loading request:', error);
            throw error;
          }

          if (!request) {
            alert('âŒ Request nicht gefunden');
            return;
          }

          console.log('âœ… Request loaded:', request);

          // Validate: Only pending requests
          if (request.status !== 'pending') {
            alert('âš ï¸ Nur Requests mit Status "Pending" kÃ¶nnen zur Zahlungsabwicklung weitergeleitet werden.\\n\\nAktueller Status: ' + request.status);
            return;
          }

          // Validate: No existing payment link
          if (request.stripe_payment_link) {
            const sentDate = request.payment_link_sent_at
              ? new Date(request.payment_link_sent_at).toLocaleString('de-DE')
              : 'unbekannt';
            alert(`â„¹ï¸ FÃ¼r diesen Request wurde bereits ein Zahlungslink erstellt.\\n\\nVersendet am: ${sentDate}\\n\\nLink: ${request.stripe_payment_link}`);
            return;
          }

          // Store for later use
          currentPaymentRequest = request;

          // Render all summaries
          renderPaymentCustomerSummary(request);
          renderPaymentTattooSummary(request);
          renderPaymentAppointmentSummary(request);

          // Reset form state
          document.getElementById('paymentTotalPrice').value = request.total_price || '';
          document.getElementById('paymentConfirmCheckbox').checked = false;
          document.getElementById('sendPaymentLinkBtn').disabled = true;
          document.getElementById('sendPaymentLinkBtn').style.opacity = '0.5';
          document.getElementById('sendPaymentLinkBtn').style.cursor = 'not-allowed';
          document.getElementById('paymentDepositDisplay').style.display = 'none';
          document.getElementById('paymentWorkflowLoading').style.display = 'none';

          // Trigger calculation if price already exists
          if (request.total_price) {
            const event = new Event('input', { bubbles: true });
            document.getElementById('paymentTotalPrice').dispatchEvent(event);
          }

          // Show modal with fade-in
          const modal = document.getElementById('paymentWorkflowModal');
          modal.style.display = 'flex';
          modal.style.opacity = '0';
          setTimeout(() => {
            modal.style.transition = 'opacity 0.2s ease';
            modal.style.opacity = '1';
          }, 10);

          console.log('âœ… Payment workflow modal opened');

        } catch (err) {
          console.error('âŒ Error opening payment workflow:', err);
          alert('âŒ Fehler beim Laden der Request-Daten:\\n\\n' + err.message);
        }
      }

      /**
       * Close Payment Workflow Modal
       */
      window.closePaymentWorkflowModal = function() {
        console.log('ðŸšª Closing payment workflow modal');
        const modal = document.getElementById('paymentWorkflowModal');
        modal.style.opacity = '0';
        setTimeout(() => {
          modal.style.display = 'none';
        }, 200);
        currentPaymentRequest = null;
      };

      /**
       * Render Customer Summary in Payment Modal
       */
      function renderPaymentCustomerSummary(request) {
        const customer = request.customer;
        if (!customer) {
          document.getElementById('paymentCustomerSummary').innerHTML =
            '<div style="color:var(--macos-accent-red);">âš ï¸ Kunde nicht gefunden</div>';
          return;
        }

        const html = `
          <div style="display:grid; grid-template-columns:140px 1fr; gap:12px 24px;">
            <div style="color:var(--macos-text-secondary);">Name:</div>
            <div style="font-weight:600;">${customer.first_name || ''} ${customer.last_name || ''}</div>

            <div style="color:var(--macos-text-secondary);">Email:</div>
            <div style="font-weight:500; color:var(--macos-accent-blue);">${customer.email || request.email || 'Keine Email'}</div>

            <div style="color:var(--macos-text-secondary);">Telefon:</div>
            <div>${customer.phone || 'N/A'}</div>

            <div style="color:var(--macos-text-secondary);">Instagram:</div>
            <div>${customer.instagram ? '@' + customer.instagram.replace('@', '') : 'N/A'}</div>
          </div>
        `;
        document.getElementById('paymentCustomerSummary').innerHTML = html;
      }

      /**
       * Render Tattoo Summary in Payment Modal
       */
      function renderPaymentTattooSummary(request) {
        const html = `
          <div style="display:grid; grid-template-columns:140px 1fr; gap:12px 24px;">
            <div style="color:var(--macos-text-secondary);">Placement:</div>
            <div style="font-weight:500;">${request.placement || 'N/A'}</div>

            <div style="color:var(--macos-text-secondary);">Size:</div>
            <div>${request.size || 'N/A'}</div>

            <div style="color:var(--macos-text-secondary);">Style:</div>
            <div>${request.style || 'N/A'}</div>

            <div style="color:var(--macos-text-secondary);">Type:</div>
            <div><span style="background:var(--macos-fill-secondary); padding:4px 8px; border-radius:6px; font-size:11px; text-transform:uppercase; font-weight:600;">${request.booking_type?.replace('_', ' ') || 'N/A'}</span></div>

            ${request.description ? `
              <div style="color:var(--macos-text-secondary); align-self:start;">Beschreibung:</div>
              <div style="line-height:1.6; color:var(--macos-text-secondary);">${request.description}</div>
            ` : ''}
          </div>
        `;
        document.getElementById('paymentTattooSummary').innerHTML = html;
      }

      /**
       * Render Appointment Summary in Payment Modal
       */
      function renderPaymentAppointmentSummary(request) {
        const scheduledDate = request.scheduled_date
          ? new Date(request.scheduled_date).toLocaleDateString('de-DE', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })
          : 'Noch nicht geplant';

        const html = `
          <div style="display:grid; grid-template-columns:140px 1fr; gap:12px 24px;">
            <div style="color:var(--macos-text-secondary);">Artist:</div>
            <div style="font-weight:600; color:var(--macos-accent-purple);">${request.artist?.name || 'Noch nicht zugewiesen'}</div>

            <div style="color:var(--macos-text-secondary);">Location:</div>
            <div>${request.location?.name || 'N/A'}</div>

            <div style="color:var(--macos-text-secondary);">Datum:</div>
            <div style="font-weight:500;">${scheduledDate}</div>

            <div style="color:var(--macos-text-secondary);">Uhrzeit:</div>
            <div>${request.start_time || 'N/A'} - ${request.end_time || 'N/A'}</div>
          </div>
        `;
        document.getElementById('paymentAppointmentSummary').innerHTML = html;
      }

      /**
       * Update Send Button State based on validation
       */
      window.updateSendButtonState = function() {
        const priceInput = document.getElementById('paymentTotalPrice');
        const checkbox = document.getElementById('paymentConfirmCheckbox');
        const sendBtn = document.getElementById('sendPaymentLinkBtn');

        const totalPrice = parseFloat(priceInput.value);
        const isChecked = checkbox.checked;

        if (totalPrice && totalPrice > 0 && isChecked) {
          sendBtn.disabled = false;
          sendBtn.style.cursor = 'pointer';
          sendBtn.style.opacity = '1';
        } else {
          sendBtn.disabled = true;
          sendBtn.style.cursor = 'not-allowed';
          sendBtn.style.opacity = '0.5';
        }
      };

      /**
       * Generate unique project_number
       * Format: P + YYYY + MM + sequence (e.g., P202511057)
       */
      async function generateProjectNumber() {
        try {
          const now = new Date();
          const year = now.getFullYear(); // 2025
          const month = String(now.getMonth() + 1).padStart(2, '0'); // 11
          const prefix = `P${year}${month}`; // P202511

          console.log('ðŸ”¢ Generating project_number with prefix:', prefix);

          // Find highest number for this month
          const { data, error } = await supabase
            .from('projects')
            .select('project_number')
            .like('project_number', `${prefix}%`)
            .order('project_number', { ascending: false })
            .limit(1);

          if (error) {
            console.error('âŒ Error fetching project numbers:', error);
            throw error;
          }

          let nextNumber = 1;
          if (data && data.length > 0) {
            const lastNumber = data[0].project_number; // e.g., "P202511057"
            const lastSequence = parseInt(lastNumber.slice(-3)); // 057 â†’ 57
            nextNumber = lastSequence + 1; // 58
            console.log('ðŸ“Š Last project_number:', lastNumber, 'â†’ Next sequence:', nextNumber);
          } else {
            console.log('ðŸ“Š No existing projects for this month, starting at 001');
          }

          const sequence = String(nextNumber).padStart(3, '0'); // "058"
          const projectNumber = `${prefix}${sequence}`; // "P202511058"

          console.log('âœ… Generated project_number:', projectNumber);
          return projectNumber;

        } catch (error) {
          console.error('âŒ Failed to generate project_number:', error);
          throw error;
        }
      }

      /**
       * Create new Project in projects table
       */
      async function createProject(requestData, projectNumber, totalPrice, stripePaymentLink) {
        try {
          console.log('ðŸ“¦ Creating new project:', projectNumber);

          const projectData = {
            project_number: projectNumber,
            customer_email: requestData.customer?.email || requestData.email,
            title: `Tattoo - ${requestData.placement || 'Custom Design'}`,
            description: requestData.description || null,
            bodypart: requestData.placement || null,
            tattoosize: requestData.size || null,
            style: requestData.style || null,
            model: requestData.colorway || null,
            work_process: null,
            state: 'pending',
            price: totalPrice,
            payment_state: 'awaiting_payment',
            payment_notice: null,
            payment_intent: stripePaymentLink,
            deposit_expired: false,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            deleted_at: null
          };

          const { data, error } = await supabase
            .from('projects')
            .insert(projectData)
            .select()
            .single();

          if (error) {
            console.error('âŒ Error creating project:', error);
            throw error;
          }

          console.log('âœ… Project created successfully:', data);
          return data;

        } catch (error) {
          console.error('âŒ Failed to create project:', error);
          throw error;
        }
      }

      /**
       * Create new Appointment in appointments table
       */
      async function createAppointment(requestData, projectId, projectNumber) {
        try {
          console.log('ðŸ“… Creating new appointment for project:', projectNumber);

          // Parse scheduled date and times
          const scheduledDate = requestData.scheduled_date ? new Date(requestData.scheduled_date) : new Date();
          const startTime = requestData.start_time || '10:00';
          const endTime = requestData.end_time || '12:00';

          // Combine date and time
          const [startHour, startMin] = startTime.split(':');
          const startDateTime = new Date(scheduledDate);
          startDateTime.setHours(parseInt(startHour), parseInt(startMin), 0, 0);

          const [endHour, endMin] = endTime.split(':');
          const endDateTime = new Date(scheduledDate);
          endDateTime.setHours(parseInt(endHour), parseInt(endMin), 0, 0);

          const appointmentData = {
            artist_email: requestData.artist?.email || null,
            customer_email: requestData.customer?.email || requestData.email,
            project_id: projectId,
            project_number: projectNumber,
            creator_email: currentUser?.email || null,
            wannado_id: null,
            state: 'scheduled',
            work_process: null,
            start: startDateTime.toISOString(),
            end: endDateTime.toISOString(),
            notice: requestData.notes || null,
            notification_24h_send: false,
            notification_2h_after_send: false,
            notification_1month_after_send: false,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            deleted_at: null
          };

          const { data, error } = await supabase
            .from('appointments')
            .insert(appointmentData)
            .select()
            .single();

          if (error) {
            console.error('âŒ Error creating appointment:', error);
            throw error;
          }

          console.log('âœ… Appointment created successfully:', data);
          return data;

        } catch (error) {
          console.error('âŒ Failed to create appointment:', error);
          throw error;
        }
      }

      /**
       * Execute Complete Payment Workflow
       * NEW: Creates project + appointment, updates request with project_number
       * Orchestrates: Project Creation â†’ Appointment Creation â†’ Stripe Payment Link â†’ Email â†’ Logging
       */
      window.executePaymentWorkflow = async function() {
        console.log('ðŸš€ ========================================');
        console.log('ðŸš€ STARTING PAYMENT WORKFLOW (3-TABLE ARCHITECTURE)');
        console.log('ðŸš€ ========================================');

        if (!currentPaymentRequest) {
          alert('âŒ Kein Request geladen');
          return;
        }

        const totalPrice = parseFloat(document.getElementById('paymentTotalPrice').value);
        if (!totalPrice || totalPrice <= 0) {
          alert('âŒ Bitte gib einen gÃ¼ltigen Gesamtpreis ein');
          return;
        }

        const depositAmount = totalPrice / 2;

        console.log('ðŸ’° Total Price:', totalPrice, 'EUR');
        console.log('ðŸ’° Deposit Amount (50%):', depositAmount, 'EUR');

        // Show loading overlay
        document.getElementById('paymentWorkflowLoading').style.display = 'flex';
        document.getElementById('sendPaymentLinkBtn').disabled = true;

        let projectNumber = null;
        let newProject = null;
        let newAppointment = null;

        try {
          // ========================================
          // STEP 1: Generate project_number
          // ========================================
          console.log('\\nðŸ”¢ STEP 1: Generating project_number...');
          projectNumber = await generateProjectNumber();
          console.log('âœ… project_number generated:', projectNumber);

          // ========================================
          // STEP 2: Create Stripe Payment Link
          // ========================================
          console.log('\\nðŸ’³ STEP 2: Creating Stripe Payment Link...');
          const paymentLink = await createStripePaymentLink(currentPaymentRequest, totalPrice);

          if (!paymentLink || !paymentLink.url) {
            throw new Error('Stripe Payment Link konnte nicht erstellt werden');
          }

          console.log('âœ… Stripe Payment Link created successfully!');
          console.log('ðŸ”— Link:', paymentLink.url);
          console.log('ðŸ†” Payment Link ID:', paymentLink.id);

          // ========================================
          // STEP 3: Create Project in projects table
          // ========================================
          console.log('\\nðŸ“¦ STEP 3: Creating project in projects table...');
          newProject = await createProject(
            currentPaymentRequest,
            projectNumber,
            totalPrice,
            paymentLink.url
          );
          console.log('âœ… Project created with ID:', newProject.id);

          // ========================================
          // STEP 4: Create Appointment in appointments table
          // ========================================
          console.log('\\nðŸ“… STEP 4: Creating appointment in appointments table...');
          newAppointment = await createAppointment(
            currentPaymentRequest,
            newProject.id,
            projectNumber
          );
          console.log('âœ… Appointment created with ID:', newAppointment.id);

          // ========================================
          // STEP 5: Update Request with project_number
          // ========================================
          console.log('\\nðŸ’¾ STEP 5: Updating request with project_number...');
          const { error: updateError } = await supabase
            .from('requests')
            .update({
              project_number: projectNumber,
              stripe_payment_link: paymentLink.url,
              payment_link_sent_at: new Date().toISOString(),
              booking_team_member_name: currentUser?.username || 'System'
            })
            .eq('id', currentPaymentRequest.id);

          if (updateError) {
            console.error('âŒ Request update error:', updateError);
            throw updateError;
          }

          console.log('âœ… Request updated with project_number:', projectNumber);

          // ========================================
          // STEP 6: Log Payment Link Creation
          // ========================================
          console.log('\\nðŸ“ STEP 6: Logging payment action...');
          await logPaymentAction(
            currentPaymentRequest.id,
            newProject.id,
            'payment_link_created',
            paymentLink.url,
            totalPrice,
            depositAmount,
            'success'
          );
          console.log('âœ… Payment action logged');

          // ========================================
          // STEP 7: Send Confirmation Email
          // ========================================
          console.log('\\nðŸ“§ STEP 7: Sending confirmation email...');
          const customerEmail = currentPaymentRequest.customer?.email || currentPaymentRequest.email;
          console.log('ðŸ“¬ Sending to:', customerEmail);

          const emailResult = await sendPaymentConfirmationEmail(
            currentPaymentRequest,
            paymentLink.url,
            totalPrice,
            depositAmount,
            projectNumber
          );

          if (!emailResult.success) {
            throw new Error('Email konnte nicht versendet werden: ' + emailResult.error);
          }

          console.log('âœ… Email sent successfully!');
          console.log('ðŸ“§ Message ID:', emailResult.messageId);

          // ========================================
          // STEP 8: Update Email Sent Flag
          // ========================================
          console.log('\\nðŸ STEP 8: Updating email confirmation flag...');
          await supabase
            .from('requests')
            .update({ payment_confirmation_email_sent: true })
            .eq('id', currentPaymentRequest.id);

          console.log('âœ… Email confirmation flag updated');

          // ========================================
          // STEP 9: Log Email Sending
          // ========================================
          console.log('\\nðŸ“ STEP 9: Logging email action...');
          await logPaymentAction(
            currentPaymentRequest.id,
            newProject.id,
            'email_sent',
            paymentLink.url,
            totalPrice,
            depositAmount,
            'success',
            customerEmail
          );
          console.log('âœ… Email action logged');

          // ========================================
          // SUCCESS!
          // ========================================
          console.log('\\nðŸŽ‰ ========================================');
          console.log('ðŸŽ‰ PAYMENT WORKFLOW COMPLETED SUCCESSFULLY!');
          console.log('ðŸŽ‰ ========================================');
          console.log('ðŸ“Š Summary:');
          console.log('   - project_number:', projectNumber);
          console.log('   - Project ID:', newProject.id);
          console.log('   - Appointment ID:', newAppointment.id);
          console.log('   - Request ID:', currentPaymentRequest.id);

          alert(
            'âœ… Zahlungsabwicklung erfolgreich abgeschlossen!\\n\\n' +
            `ðŸ†” Project Number: ${projectNumber}\\n` +
            `ðŸ’³ Payment Link erstellt\\n` +
            `ðŸ“§ Email versendet an: ${customerEmail}\\n` +
            `ðŸ’¶ Gesamtpreis: â‚¬${totalPrice.toFixed(2)}\\n` +
            `ðŸ’° Terminkaution: â‚¬${depositAmount.toFixed(2)}\\n\\n` +
            'Der Kunde hat alle notwendigen Informationen erhalten.'
          );

          // Close modal and refresh
          closePaymentWorkflowModal();
          await loadRequests(); // Refresh the requests list

        } catch (error) {
          // ========================================
          // ERROR HANDLING
          // ========================================
          console.error('\\nâŒ ========================================');
          console.error('âŒ PAYMENT WORKFLOW FAILED');
          console.error('âŒ ========================================');
          console.error('Error:', error);
          console.error('Stack:', error.stack);

          // Log error (use project ID if it was created)
          await logPaymentAction(
            currentPaymentRequest.id,
            newProject?.id || null,
            'workflow_failed',
            null,
            totalPrice,
            depositAmount,
            'failed',
            null,
            error.message
          );

          alert(
            'âŒ Fehler bei der Zahlungsabwicklung\\n\\n' +
            'Details: ' + error.message + '\\n\\n' +
            (projectNumber ? `Project Number: ${projectNumber}\\n` : '') +
            'Bitte Ã¼berprÃ¼fe:\\n' +
            'â€¢ API Keys korrekt eingetragen?\\n' +
            'â€¢ Stripe im Test Mode?\\n' +
            'â€¢ Internet-Verbindung aktiv?\\n' +
            'â€¢ Browser Console fÃ¼r Details'
          );

        } finally {
          // Hide loading overlay
          document.getElementById('paymentWorkflowLoading').style.display = 'none';
          updateSendButtonState();
        }
      };

      /**
       * Create Stripe Payment Link via API
       */
      async function createStripePaymentLink(requestData, totalPrice) {
        console.log('ðŸ”µ Calling Stripe API...');

        const customerName = requestData.customer
          ? `${requestData.customer.first_name} ${requestData.customer.last_name}`
          : 'Kunde';

        const productName = `Tattoo Session - ${customerName}`;
        const amountInCents = Math.round(totalPrice * 100); // Convert EUR to cents

        console.log('ðŸ“¦ Product:', productName);
        console.log('ðŸ’µ Amount:', amountInCents, 'cents (', totalPrice, 'EUR)');

        try {
          const response = await fetch('https://api.stripe.com/v1/payment_links', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${STRIPE_SECRET_KEY}`,
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
              'line_items[0][price_data][currency]': 'eur',
              'line_items[0][price_data][product_data][name]': productName,
              'line_items[0][price_data][unit_amount]': amountInCents,
              'line_items[0][quantity]': 1,
              'metadata[customer_id]': requestData.customer_id || '',
              'metadata[request_id]': requestData.id,
              'metadata[artist_id]': requestData.artist_id || '',
              'metadata[location_id]': requestData.location_id || '',
              'allow_promotion_codes': 'true',
              'billing_address_collection': 'auto',
              'phone_number_collection[enabled]': 'true',
              'after_completion[type]': 'hosted_confirmation',
              'after_completion[hosted_confirmation][custom_message]': 'Vielen Dank fÃ¼r deine Zahlung! Wir sehen uns zum Termin. ðŸŽ¨'
            })
          });

          console.log('ðŸ“¡ Stripe API Response Status:', response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error('âŒ Stripe API Error Response:', errorData);
            throw new Error(`Stripe API Error: ${errorData.error?.message || response.statusText}`);
          }

          const data = await response.json();
          console.log('âœ… Stripe API Success Response:', data);

          return data;

        } catch (error) {
          console.error('âŒ Stripe Payment Link Creation Failed:', error);
          throw error;
        }
      }

      /**
       * Send Payment Confirmation Email via Resend
       * Updated to use project_number instead of request_number
       */
      async function sendPaymentConfirmationEmail(requestData, paymentLink, totalPrice, depositAmount, projectNumber) {
        console.log('ðŸ“§ Preparing email...');

        const customer = requestData.customer;
        const customerName = customer?.first_name || 'Kunde';
        const customerEmail = customer?.email || requestData.email;
        const artistName = requestData.artist?.name || 'deinem Artist';
        const locationName = requestData.location?.name || 'unserem Studio';
        const scheduledDate = requestData.scheduled_date
          ? new Date(requestData.scheduled_date).toLocaleDateString('de-DE', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })
          : '[Datum folgt]';
        // Use projectNumber for bank transfer reference
        const referenceNumber = projectNumber || requestData.id.substring(0, 8).toUpperCase();
        const bookingMemberName = currentUser?.username || 'dem Team';

        console.log('ðŸ“ Email Recipients:', customerEmail);
        console.log('ðŸ“ From:', EMAIL_FROM);
        console.log('ðŸ“ Reference Number (project_number):', referenceNumber);

        // Complete Email HTML Template
        const emailHTML = `
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px 30px;
      text-align: center;
    }
    .header h1 {
      color: white;
      margin: 0;
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    .content {
      padding: 40px 30px;
    }
    .section {
      margin-bottom: 30px;
    }
    .section h2 {
      font-size: 20px;
      color: #667eea;
      margin: 0 0 16px 0;
      font-weight: 600;
    }
    .option-box {
      background: #f8f9fa;
      padding: 24px;
      border-radius: 12px;
      margin: 16px 0;
      border-left: 4px solid #667eea;
    }
    .option-box h3 {
      margin: 0 0 12px 0;
      font-size: 18px;
      color: #333;
    }
    .button {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 16px 40px;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 600;
      margin: 12px 0;
      font-size: 16px;
      transition: all 0.2s;
    }
    .button:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }
    .info-grid {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
      margin: 16px 0;
      font-size: 15px;
    }
    .info-grid strong {
      color: #666;
    }
    .warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 20px;
      border-radius: 8px;
      margin: 24px 0;
    }
    .footer {
      background: #f8f9fa;
      padding: 30px;
      text-align: center;
      font-size: 13px;
      color: #666;
      line-height: 1.8;
    }
    .price-highlight {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
    }
    @media only screen and (max-width: 600px) {
      .content { padding: 30px 20px; }
      .option-box { padding: 20px; }
      .info-grid { grid-template-columns: 1fr; gap: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <div class="header">
      <h1>Mommy I'm Sorry</h1>
    </div>

    <!-- Main Content -->
    <div class="content">

      <p style="font-size: 16px; margin: 0 0 24px 0;">Hallo ${customerName},</p>

      <p style="font-size: 16px; line-height: 1.8;">perfekt! Wir freuen uns schon sehr auf das Projekt. ðŸ˜Š</p>

      <p style="font-size: 16px; line-height: 1.8;">Ich habe Dir den Termin am <strong>${scheduledDate}</strong> mit <strong>${artistName}</strong> bereits eingetragen.</p>

      <!-- Payment Options Section -->
      <div class="section">
        <h2>ðŸ’³ ZahlungsmÃ¶glichkeiten</h2>
        <p style="margin-bottom: 20px;">Um Dir die Zahlung so angenehm wie mÃ¶glich zu gestalten, bieten wir Dir zwei Optionen an:</p>

        <!-- Option 1: Bank Transfer -->
        <div class="option-box">
          <h3>Option 1*: Ãœberweisung</h3>
          <p style="margin: 12px 0;">
            ðŸ”¹ 50 % der Gesamtsumme (<span class="price-highlight">â‚¬${depositAmount.toFixed(2)}</span>) vorab per Ãœberweisung bezahlen<br>
            ðŸ”¹ Die verbleibenden 50 % bequem am Termin in bar begleichen
          </p>
        </div>

        <!-- Option 2: Online Payment -->
        <div class="option-box">
          <h3>Option 2: Online-Zahlung</h3>
          <p style="margin: 12px 0 20px 0;">
            ðŸ’³ Die Gesamtsumme (<span class="price-highlight">â‚¬${totalPrice.toFixed(2)}</span>) direkt online begleichen:
          </p>
          <div style="text-align: center;">
            <a href="${paymentLink}" class="button">Jetzt online bezahlen â†’</a>
          </div>
          <p style="font-size: 14px; margin: 16px 0 0 0; color: #666;">
            Hier stehen dir verschiedene ZahlungsmÃ¶glichkeiten zur VerfÃ¼gung (Klarna, Kreditkarte, Apple Pay).
            Du kannst auÃŸerdem eine Ratenzahlung wÃ¤hlen oder die Zahlung auf einen spÃ¤teren Zeitpunkt verschieben.
          </p>
        </div>
      </div>

      <!-- Important Notes -->
      <div class="warning">
        <strong style="font-size: 16px; display: block; margin-bottom: 12px;">âš ï¸ Wichtige Hinweise:</strong>
        <p style="margin: 8px 0;">âŒ Bitte trinke vor deinem Termin keinen Alkohol und nimm keine blutverdÃ¼nnenden Mittel wie Aspirin o. Ã„. ein.</p>
        <p style="margin: 8px 0;">ðŸ“œ Beachte zudem unsere <a href="${BUSINESS_INFO.faq_url}" style="color: #667eea;">allgemeinen GeschÃ¤ftsbedingungen (AGB)</a></p>
      </div>

      <!-- Bank Transfer Details -->
      <div style="background: #f8f9fa; padding: 24px; border-radius: 12px; margin: 24px 0;">
        <p style="font-size: 15px; line-height: 1.8; margin-bottom: 20px;">
          <strong>*FÃ¼r Option 1:</strong> Bitte Ã¼berweise die Terminkaution (<strong>â‚¬${depositAmount.toFixed(2)}</strong>) innerhalb von 2 Tagen und sende einen Screenshot zur BestÃ¤tigung. ðŸ˜Š
        </p>
        <p style="background: rgba(255,193,7,0.2); padding: 12px; border-radius: 8px; margin: 16px 0; font-size: 14px;">
          <strong>WICHTIG:</strong> Als Verwendungszweck bitte nur "<strong>${referenceNumber}</strong>" angeben, damit die Zahlung korrekt zugeordnet wird.
        </p>

        <h3 style="margin: 24px 0 16px 0; font-size: 18px;">Bankverbindung:</h3>
        <div class="info-grid">
          <strong>EmpfÃ¤nger:</strong>
          <div>${BUSINESS_INFO.name}</div>
          <strong>IBAN:</strong>
          <div style="font-family: monospace; letter-spacing: 0.5px;">${BUSINESS_INFO.iban}</div>
          <strong>Betrag:</strong>
          <div style="font-size: 18px; font-weight: 600; color: #667eea;">â‚¬${depositAmount.toFixed(2)}</div>
        </div>
      </div>

      <!-- Studio Address -->
      <div class="section">
        <h2>ðŸ“ Adresse</h2>
        <div class="info-grid">
          <strong>Studio:</strong>
          <div>${locationName}</div>
          <strong>Adresse:</strong>
          <div>${BUSINESS_INFO.address}<br>${BUSINESS_INFO.city}</div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="section">
        <h2>ðŸ“ž Kontakt</h2>
        <div class="info-grid">
          <strong>Telefon/WhatsApp:</strong>
          <div><a href="tel:${BUSINESS_INFO.phone}" style="color: #667eea; text-decoration: none;">${BUSINESS_INFO.phone}</a></div>
          <strong>Email:</strong>
          <div><a href="mailto:${BUSINESS_INFO.email}" style="color: #667eea; text-decoration: none;">${BUSINESS_INFO.email}</a></div>
          <strong>Instagram:</strong>
          <div><a href="https://instagram.com/${BUSINESS_INFO.instagram.replace('@', '')}" style="color: #667eea; text-decoration: none;">${BUSINESS_INFO.instagram}</a></div>
          <strong>FAQ:</strong>
          <div><a href="${BUSINESS_INFO.faq_url}" style="color: #667eea; text-decoration: none;">HÃ¤ufig gestellte Fragen</a></div>
        </div>
      </div>

      <!-- Terms & Conditions -->
      <div style="font-size: 13px; color: #666; line-height: 1.8; margin-top: 40px; padding-top: 24px; border-top: 1px solid #e0e0e0;">
        <strong style="display: block; margin-bottom: 12px; color: #333;">Umgang mit Terminkautionen, Absagen, Verschiebungen und VerspÃ¤tungen:</strong>
        <p style="margin: 8px 0;">Der Gesamtpreis der TÃ¤towierung wird am ersten Termin, vor dem Stechen fÃ¤llig. Die geleistete Terminkaution wird mit dem Gesamtpreis verrechnet.</p>
        <p style="margin: 8px 0;">Zur Terminvereinbarung einer neuen TÃ¤towierung wird mindestens eine Terminkaution in HÃ¶he von 50 % des Gesamtpreises benÃ¶tigt. Alternativ kann vorab die Gesamtsumme bezahlt werden.</p>
        <p style="margin: 8px 0;">Terminkautionen werden nicht rÃ¼ckerstattet.</p>
        <p style="margin: 8px 0;">Kann der Termin nicht eingehalten werden, so ist dieser mindestens 3 Werktage vorher abzusagen. Ansonsten verfÃ¤llt die Terminkaution.</p>
        <p style="margin: 8px 0;">Wird ein Termin nicht wahrgenommen und nicht abgesagt verfÃ¤llt die Terminkaution.</p>
        <p style="margin: 8px 0;">Solltest Du einmal einen Termin verschieben mÃ¼ssen, so bitten wir Dich das spÃ¤testens 3 Werktage vor dem Termin zu tun. In diesem Fall bleibt die Terminkaution erhalten.</p>
        <p style="margin: 8px 0;">Erscheine bitte pÃ¼nktlich zu Deinem Termin. Solltest Du Dich unangekÃ¼ndigt um mehr als 30 min verspÃ¤ten, so kann der Termin unter UmstÃ¤nden nicht eingehalten werden.</p>
      </div>

      <!-- Signature -->
      <p style="margin: 40px 0 0 0; font-size: 16px;">
        Cheers,<br>
        <strong style="font-size: 18px;">${bookingMemberName}</strong>
      </p>

    </div>

    <!-- Footer -->
    <div class="footer">
      <p style="margin: 0 0 12px 0;">
        <strong>${BUSINESS_INFO.name}</strong><br>
        ${BUSINESS_INFO.address}, ${BUSINESS_INFO.city}
      </p>
      <p style="font-size: 12px; margin: 20px 0 0 0; color: #999;">
        Amtsgericht Stuttgart | HRB 746699 - GeschÃ¤ftsfÃ¼hrer: A.Supper<br>
        Diese E-Mail kann vertrauliche und/oder gesetzlich geschÃ¼tzte Informationen enthalten.
      </p>
    </div>

  </div>
</body>
</html>
        `;

        console.log('ðŸ“§ Email HTML generated (', emailHTML.length, 'characters)');

        try {
          console.log('ðŸ“¡ Calling Resend API...');

          const response = await fetch('https://api.resend.com/emails', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${RESEND_API_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              from: EMAIL_FROM,
              to: customerEmail,
              reply_to: EMAIL_REPLY_TO,
              subject: `Deine TerminbestÃ¤tigung bei Mommy I'm Sorry - ${artistName}`,
              html: emailHTML
            })
          });

          console.log('ðŸ“¡ Resend API Response Status:', response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error('âŒ Resend API Error Response:', errorData);
            throw new Error(`Resend API Error: ${errorData.message || response.statusText}`);
          }

          const data = await response.json();
          console.log('âœ… Resend API Success Response:', data);

          return {
            success: true,
            messageId: data.id
          };

        } catch (error) {
          console.error('âŒ Email Sending Failed:', error);
          return {
            success: false,
            error: error.message
          };
        }
      }

      /**
       * Log Payment Action to payment_logs table
       * Updated to include project_id for linking to projects table
       */
      async function logPaymentAction(requestId, projectId, actionType, stripeLink, totalAmount, depositAmount, status, emailSentTo = null, errorMessage = null) {
        try {
          console.log('ðŸ“ Logging action:', actionType, 'with status:', status);
          console.log('ðŸ“ Request ID:', requestId, '| Project ID:', projectId);

          const logData = {
            request_id: requestId,
            action_type: actionType,
            stripe_payment_link: stripeLink,
            email_sent_to: emailSentTo,
            total_amount: totalAmount,
            deposit_amount: depositAmount,
            status: status,
            error_message: errorMessage,
            created_by: currentUser?.id || null
          };

          // Add project_id if provided (column may not exist in older schemas)
          if (projectId) {
            logData.project_id = projectId;
          }

          const { error } = await supabase
            .from('payment_logs')
            .insert(logData);

          if (error) {
            console.error('âš ï¸ Failed to log payment action:', error);
            // Don't throw - logging failure shouldn't break the workflow
          } else {
            console.log('âœ… Payment action logged successfully');
          }
        } catch (err) {
          console.error('âš ï¸ Error logging payment action:', err);
          // Don't throw - logging failure shouldn't break the workflow
        }
      }

      // ==========================================
      // NAVBAR & MOBILE NAVIGATION SETUP
      // ==========================================

      // Initialize navbar hover and mobile navigation
      setupNavbarHover();
      setupMobileNavigation();

      // Header Title - Return to Dashboard
      const headerTitle = document.querySelector('.header-title');
      if (headerTitle) {
        headerTitle.addEventListener('click', function() {
          // Switch to dashboard view
          const sections = document.querySelectorAll('section');
          sections.forEach(s => s.classList.remove('active'));
          const dashboardSection = document.getElementById('dashboard-section');
          if (dashboardSection) {
            dashboardSection.classList.add('active');
          }

          // Update nav links
          const navLinks = document.querySelectorAll('.nav-link');
          navLinks.forEach(link => link.classList.remove('active'));
          const dashboardLink = document.querySelector('.nav-link[data-view="dashboard"]');
          if (dashboardLink) {
            dashboardLink.classList.add('active');
          }

          // Update mobile nav
          const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
          mobileNavItems.forEach(item => item.classList.remove('active'));
          const mobileDashboardItem = document.querySelector('.mobile-nav-item[data-mobile-view="dashboard"]');
          if (mobileDashboardItem) {
            mobileDashboardItem.classList.add('active');
          }
        });
      }

      // ==========================================
      // DROPDOWN MANAGEMENT
      // ==========================================

      const profileDropdown = document.getElementById('profileDropdown');
      const notificationsDropdown = document.getElementById('notificationsDropdown');
      const feedbackDropdown = document.getElementById('feedbackDropdown');

      // Profile Button Toggle
      const profileButton = document.getElementById('profileButton');
      if (profileButton) {
        profileButton.addEventListener('click', function(e) {
          e.stopPropagation();
          if (profileDropdown) profileDropdown.classList.toggle('active');
          if (notificationsDropdown) notificationsDropdown.classList.remove('active');
          if (feedbackDropdown) feedbackDropdown.classList.remove('active');
        });
      }

      // Notification Button Toggle
      const notificationButton = document.getElementById('notificationButton');
      if (notificationButton) {
        notificationButton.addEventListener('click', function(e) {
          e.stopPropagation();
          // Check if mobile view - open mobile notification panel
          if (window.innerWidth <= 768 && typeof openMobileNotificationPanel === 'function') {
            openMobileNotificationPanel();
            return;
          }
          if (notificationsDropdown) {
            notificationsDropdown.classList.toggle('active');
            // Load pending invitations when opening notifications
            if (notificationsDropdown.classList.contains('active')) {
              loadPendingInvitations();
            }
          }
          if (profileDropdown) profileDropdown.classList.remove('active');
          if (feedbackDropdown) feedbackDropdown.classList.remove('active');
        });
      }

      // Feedback Button Toggle
      const feedbackButton = document.getElementById('feedbackButton');
      if (feedbackButton) {
        feedbackButton.addEventListener('click', function(e) {
          e.stopPropagation();
          if (feedbackDropdown) feedbackDropdown.classList.toggle('active');
          if (profileDropdown) profileDropdown.classList.remove('active');
          if (notificationsDropdown) notificationsDropdown.classList.remove('active');
        });
      }

      // Notification Tabs
      const inboxTab = document.getElementById('inboxTab');
      const updatesTab = document.getElementById('updatesTab');
      if (inboxTab && updatesTab) {
        inboxTab.addEventListener('click', function() {
          inboxTab.classList.add('active');
          updatesTab.classList.remove('active');
        });
        updatesTab.addEventListener('click', function() {
          updatesTab.classList.add('active');
          inboxTab.classList.remove('active');
        });
      }

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        if (profileDropdown && !profileDropdown.contains(e.target) && (!profileButton || !profileButton.contains(e.target))) {
          profileDropdown.classList.remove('active');
        }
        if (notificationsDropdown && !notificationsDropdown.contains(e.target) && (!notificationButton || !notificationButton.contains(e.target))) {
          notificationsDropdown.classList.remove('active');
        }
        if (feedbackDropdown && !feedbackDropdown.contains(e.target) && (!feedbackButton || !feedbackButton.contains(e.target))) {
          feedbackDropdown.classList.remove('active');
        }
      });

      // Dashboard Link in Profile Dropdown
      const dashboardLinkDropdown = document.getElementById('dashboardLinkDropdown');
      if (dashboardLinkDropdown) {
        dashboardLinkDropdown.addEventListener('click', function(e) {
          e.preventDefault();
          // Switch to dashboard view
          const sections = document.querySelectorAll('section');
          sections.forEach(s => s.classList.remove('active'));
          const dashboardSection = document.getElementById('dashboard-section');
          if (dashboardSection) {
            dashboardSection.classList.add('active');
          }

          // Update nav links
          const navLinks = document.querySelectorAll('.nav-link');
          navLinks.forEach(link => link.classList.remove('active'));
          const dashboardLink = document.querySelector('.nav-link[data-view="dashboard"]');
          if (dashboardLink) {
            dashboardLink.classList.add('active');
          }

          if (profileDropdown) profileDropdown.classList.remove('active');
        });
      }

      // Account Settings Link
      const accountSettingsLink = document.getElementById('accountSettingsLink');
      if (accountSettingsLink) {
        accountSettingsLink.addEventListener('click', function(e) {
          e.preventDefault();
          switchView('accountSettings');
          if (profileDropdown) profileDropdown.classList.remove('active');
        });
      }

      // Theme Buttons
      const lightThemeBtn = document.getElementById('lightThemeBtn');
      const darkThemeBtn = document.getElementById('darkThemeBtn');

      function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);

        if (theme === 'dark') {
          if (darkThemeBtn) darkThemeBtn.classList.add('active');
          if (lightThemeBtn) lightThemeBtn.classList.remove('active');
        } else {
          if (lightThemeBtn) lightThemeBtn.classList.add('active');
          if (darkThemeBtn) darkThemeBtn.classList.remove('active');
        }
      }

      if (lightThemeBtn) {
        lightThemeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          setTheme('light');
        });
      }
      if (darkThemeBtn) {
        darkThemeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          setTheme('dark');
        });
      }

      // Load saved theme
      function loadTheme() {
        let theme = localStorage.getItem('theme');

        // If no saved theme, use system preference
        if (!theme) {
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          theme = prefersDark ? 'dark' : 'light';
        }

        setTheme(theme);
      }
      loadTheme();

      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        // Only apply system preference if user hasn't manually set a theme
        if (!localStorage.getItem('theme')) {
          setTheme(e.matches ? 'dark' : 'light');
        }
      });

      // Logout Button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async function() {
          await logout();
          if (profileDropdown) profileDropdown.classList.remove('active');
        });
      }

      // Command Menu Link (placeholder)
      const commandMenuLink = document.getElementById('commandMenuLink');
      if (commandMenuLink) {
        commandMenuLink.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Command Menu clicked - not implemented yet');
          // TODO: Implement command menu modal
        });
      }

      // Home Page Link
      const homePageLink = document.getElementById('homePageLink');
      if (homePageLink) {
        homePageLink.addEventListener('click', function(e) {
          e.preventDefault();
          // Open main website in new tab
          window.open('https://mommyimsorry.com', '_blank');
          if (profileDropdown) profileDropdown.classList.remove('active');
        });
      }

      // Feedback Send Button
      const feedbackSendBtn = document.getElementById('feedbackSendBtn');
      const feedbackSelect = document.getElementById('feedbackSelect');
      const feedbackTextarea = document.getElementById('feedbackTextarea');

      if (feedbackSendBtn) {
        feedbackSendBtn.addEventListener('click', function() {
          const topic = feedbackSelect?.value || '';
          const message = feedbackTextarea?.value || '';

          if (!topic) {
            alert('Please select a topic');
            return;
          }

          if (!message.trim()) {
            alert('Please enter your feedback');
            return;
          }

          console.log('Feedback submitted:', { topic, message });
          alert('Thank you for your feedback!');

          // Reset form
          if (feedbackSelect) feedbackSelect.value = '';
          if (feedbackTextarea) feedbackTextarea.value = '';

          // Close dropdown
          if (feedbackDropdown) feedbackDropdown.classList.remove('active');
        });
      }

      // Emoji Buttons
      const emojiButtons = document.querySelectorAll('.emoji-btn');
      emojiButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const emoji = this.getAttribute('data-emoji');
          if (feedbackTextarea) {
            feedbackTextarea.value += emoji;
          }
        });
      });

      // Re-init bei Resize
      window.addEventListener('resize', function() {
        setupNavbarHover();
        setupMobileNavigation();
      });

      // ==========================================
      // ACCOUNT SETTINGS NAVIGATION
      // ==========================================

      const mainNavbar = document.getElementById('mainNavbar');
      const settingsNavbar = document.getElementById('settingsNavbar');
      const mainTitle = document.getElementById('mainTitle');

      // Return to Dashboard from Settings Navbar
      const returnToDashboardBtn = document.getElementById('returnToDashboard');
      if (returnToDashboardBtn) {
        returnToDashboardBtn.addEventListener('click', function(e) {
          e.preventDefault();
          switchView('dashboard');
        });
      }

      // Settings Navbar Tab Switching
      const settingsNavLinks = document.querySelectorAll('#settingsNavbar .nav-link[data-tab]');
      settingsNavLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const tabName = this.dataset.tab;

          // Update navbar active state
          settingsNavLinks.forEach(l => l.classList.remove('active'));
          this.classList.add('active');

          // Update main title
          if (mainTitle) {
            mainTitle.textContent = tabName === 'activity' ? 'Account Activity' : 'Account Settings';
          }

          // Switch tab content
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(tabName + 'Tab').classList.add('active');
        });
      });

      // Sidebar Navigation
      const sidebarItems = document.querySelectorAll('.sidebar-nav .nav-item');

      sidebarItems.forEach(item => {
        item.addEventListener('click', function() {
          const section = this.dataset.section;

          // Update sidebar active state
          sidebarItems.forEach(i => i.classList.remove('active'));
          this.classList.add('active');

          // Map sidebar items to tabs
          if (section === 'activity') {
            // Switch to Activity tab
            if (mainTitle) mainTitle.textContent = 'Account Activity';
            document.querySelectorAll('#settingsNavbar .nav-link').forEach(link => {
              if (link.dataset.tab === 'activity') {
                link.click();
              }
            });
          } else {
            // All other items go to Settings tab
            if (mainTitle) mainTitle.textContent = 'Account Settings';
            document.querySelectorAll('#settingsNavbar .nav-link').forEach(link => {
              if (link.dataset.tab === 'settings') {
                link.click();
              }
            });

            // Scroll to specific section
            setTimeout(() => {
              const sectionMap = {
                'avatar': '.settings-card:nth-child(1)',
                'user-info': '.settings-card:nth-child(2)',
                'notifications': '.settings-card:nth-child(3)',
                'statistics': '.settings-card:nth-child(4)'
              };

              if (sectionMap[section]) {
                const targetSection = document.querySelector(sectionMap[section]);
                if (targetSection) {
                  targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
              }
            }, 100);
          }
        });
      });

      // ==========================================
      // AVATAR UPLOAD
      // ==========================================

      const avatarUpload = document.getElementById('avatarUpload');
      const avatarDisplay = document.getElementById('avatarDisplay');
      const deleteAvatarBtn = document.getElementById('deleteAvatarBtn');
      let currentAvatar = null;

      if (avatarUpload) {
        avatarUpload.addEventListener('change', async function(e) {
          const file = e.target.files[0];
          if (file && file.type.startsWith('image/')) {
            if (!currentUser) {
              alert('Please log in to upload an avatar');
              return;
            }

            try {
              // Show preview immediately
              const reader = new FileReader();
              reader.onload = function(event) {
                avatarDisplay.style.background = 'none';
                avatarDisplay.innerHTML = `<img src="${event.target.result}" alt="Avatar">`;
              };
              reader.readAsDataURL(file);

              // Upload to Supabase
              const fileExt = file.name.split('.').pop();
              const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;

              console.log('ðŸ“¤ Uploading avatar for:', currentUser.username);

              const { data: uploadData, error: uploadError } = await supabase.storage
                .from('avatars')
                .upload(fileName, file, {
                  cacheControl: '3600',
                  upsert: true
                });

              if (uploadError) {
                console.error('âŒ Upload error:', uploadError);
                alert('Upload failed: ' + uploadError.message);
                return;
              }

              // Get public URL
              const { data: { publicUrl } } = supabase.storage
                .from('avatars')
                .getPublicUrl(fileName);

              console.log('âœ… Avatar uploaded:', publicUrl);

              // Update database
              const { error: updateError } = await supabase
                .from('profiles')
                .update({ avatar_url: publicUrl })
                .eq('id', currentUser.id);

              if (updateError) {
                console.error('âŒ Database update error:', updateError);
                alert('Failed to update profile');
                return;
              }

              // Update currentUser
              currentUser.avatar_url = publicUrl;
              localStorage.setItem('avatarUrl', publicUrl);

              // Update all UI elements
              updateUIForUser(currentUser);

              console.log('âœ… Avatar updated successfully');
            } catch (err) {
              console.error('âŒ Upload failed:', err);
              alert('Upload failed: ' + err.message);
            }
          }
        });
      }

      if (deleteAvatarBtn) {
        deleteAvatarBtn.addEventListener('click', async function() {
          if (!confirm('Are you sure you want to delete your avatar?')) {
            return;
          }

          if (!currentUser) {
            alert('Please log in');
            return;
          }

          try {
            // Update database to remove avatar
            const { error: updateError } = await supabase
              .from('profiles')
              .update({ avatar_url: null })
              .eq('id', currentUser.id);

            if (updateError) {
              console.error('âŒ Database update error:', updateError);
              alert('Failed to delete avatar');
              return;
            }

            // Update UI
            currentUser.avatar_url = null;
            localStorage.removeItem('avatarUrl');

            avatarDisplay.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            avatarDisplay.innerHTML = '';

            // Update all UI elements
            updateUIForUser(currentUser);

            console.log('âœ… Avatar deleted successfully');
          } catch (err) {
            console.error('âŒ Delete failed:', err);
            alert('Delete failed: ' + err.message);
          }
        });
      }

      // Avatar is loaded from currentUser.avatar_url in updateUIForUser()
      // No need for separate loadSavedAvatar function

      // ==========================================
      // NOTIFICATIONS SAVE
      // ==========================================

      const phoneInput = document.getElementById('phoneInput');
      const emailInput = document.getElementById('emailInput');
      const saveNotificationsBtn = document.getElementById('saveNotificationsBtn');

      function loadNotificationSettings() {
        const savedPhone = localStorage.getItem('userPhone');
        const savedEmail = localStorage.getItem('userEmail');

        if (savedPhone && phoneInput) phoneInput.value = savedPhone;
        if (savedEmail && emailInput) emailInput.value = savedEmail;
      }

      if (saveNotificationsBtn) {
        saveNotificationsBtn.addEventListener('click', function() {
          const phone = phoneInput ? phoneInput.value.trim() : '';
          const email = emailInput ? emailInput.value.trim() : '';

          if (email && !email.includes('@')) {
            alert('Please enter a valid email address');
            return;
          }

          localStorage.setItem('userPhone', phone);
          localStorage.setItem('userEmail', email);

          const originalText = saveNotificationsBtn.textContent;
          saveNotificationsBtn.textContent = 'Saved âœ“';
          saveNotificationsBtn.style.background = '#10b981';

          setTimeout(() => {
            saveNotificationsBtn.textContent = originalText;
            saveNotificationsBtn.style.background = '';
          }, 2000);
        });
      }

      loadNotificationSettings();

      // ==========================================
      // VIEW SWITCHING WITH NAVBAR
      // ==========================================

      function switchView(viewName) {
        // Hide all sections
        document.querySelectorAll('section[id$="-section"]').forEach(section => {
          section.style.display = 'none';
          section.classList.remove('active');
        });

        // Show selected section
        const sectionElement = document.getElementById(viewName + '-section');
        if (sectionElement) {
          sectionElement.style.display = 'block';
          sectionElement.classList.add('active');
        }

        // Switch navbar based on view (Desktop only)
        if (window.innerWidth > 768) {
          if (viewName === 'accountSettings') {
            if (mainNavbar) mainNavbar.style.display = 'none';
            if (settingsNavbar) settingsNavbar.style.display = 'flex';
          } else {
            if (mainNavbar) mainNavbar.style.display = 'flex';
            if (settingsNavbar) settingsNavbar.style.display = 'none';

            // Update main navbar active state
            document.querySelectorAll('#mainNavbar .nav-link').forEach(link => {
              link.classList.remove('active');
              if (link.dataset.view === viewName) {
                link.classList.add('active');
              }
            });
          }
        }

        // Close dropdowns
        document.querySelectorAll('.profile-dropdown, .notifications-dropdown, .feedback-dropdown').forEach(dropdown => {
          dropdown.classList.remove('active');
        });
      }

      // ==========================================
      // WANNADOS TAB
      // ==========================================

      const WANNADO_ARTIST_IDS = [
        '90cd70be-f1a4-409e-8570-7aa2699fc683', // Ata
        '98b63cd4-7e2e-409c-94cd-ac259a0a2635', // Gil
        '9c60a246-68f0-4d9a-968e-03f490f10e5f', // Luca
        'a2b390b5-4898-4bd5-a6b3-8ea66878dcc9', // Mary
        'eb67d5dc-2f6f-45e1-ba56-f8e513ef32ba', // Mela
        'e84dc7a2-1883-4c75-a7d2-51b9040d6be2', // Silas
        'cfbb02bf-8b3f-4f3f-966e-260662b435a2'  // Ben
      ];

      let wannadoCollections = [];
      let allWannadoCollections = [];
      let wannadoRowCount = 0;

      async function loadWannadoCollections() {
        try {
          const { data, error } = await supabase
            .from('wannado_collections')
            .select('*, artist:artists(id, name, profile_picture_url), wannados(*)')
            .order('sort_order', { ascending: true });
          if (error) throw error;
          wannadoCollections = data || [];
          allWannadoCollections = data || [];

          // Populate artist filter dropdown
          const artistSelect = document.getElementById('wannadoArtistFilter');
          if (artistSelect) {
            const artists = [...new Map(allWannadoCollections.map(c => [c.artist_id, c.artist]).filter(([id, a]) => id && a)).values()];
            artistSelect.innerHTML = `
              <option value="all">Alle Artists</option>
              ${artists.map(a => `<option value="${a.id}">${a.name}</option>`).join('')}
            `;
          }

          renderWannadoCollections(allWannadoCollections);
        } catch (err) {
          console.error('Error:', err);
        }
      }

      // Filter function for Wannado Collections
      function filterWannadoCollections() {
        const searchTerm = document.getElementById('wannadoSearchInput')?.value.toLowerCase() || '';
        const artistFilter = document.getElementById('wannadoArtistFilter')?.value || 'all';
        const dateFilter = document.getElementById('wannadoDateFilter')?.value || 'newest';

        let filtered = [...allWannadoCollections];

        // Artist Filter
        if (artistFilter !== 'all') {
          filtered = filtered.filter(c => c.artist_id === artistFilter);
        }

        // Search Filter
        if (searchTerm) {
          filtered = filtered.filter(c => {
            const collectionName = (c.name || '').toLowerCase();
            const artistName = (c.artist?.name || '').toLowerCase();
            const wannadoNames = (c.wannados || []).map(w => w.name.toLowerCase()).join(' ');
            return collectionName.includes(searchTerm) || artistName.includes(searchTerm) || wannadoNames.includes(searchTerm);
          });
        }

        // Date Sort
        filtered.sort((a, b) => {
          const dateA = new Date(a.created_at || 0);
          const dateB = new Date(b.created_at || 0);
          return dateFilter === 'newest' ? dateB - dateA : dateA - dateB;
        });

        renderWannadoCollections(filtered);
      }

      window.filterWannadoCollections = filterWannadoCollections;

      function renderWannadoCollections(collections) {
        const container = document.getElementById('wannadoCollectionsList');
        if (!container) return;

        if (!collections || collections.length === 0) {
          container.innerHTML = `
            <div style="text-align:center; padding:60px 20px; color:#86868b;">
              <div style="font-size:48px; margin-bottom:16px;">ðŸŽ¨</div>
              <h3 style="font-weight:500; margin-bottom:8px;">Keine Collections gefunden</h3>
              <p style="margin:0;">Passe deine Suche oder Filter an</p>
            </div>
          `;
          return;
        }
        container.innerHTML = collections.map(c => {
          const artist = c.artist || {};
          const wannados = c.wannados || [];
          const available = wannados.filter(w => w.status === 'available').length;
          const sold = wannados.filter(w => w.status === 'sold').length;
          const isActive = c.is_active !== false;
          const cardStyle = !isActive ? 'opacity: 0.5; filter: grayscale(30%);' : '';
          return `
            <div class="wannado-collection-card" data-collection-id="${c.id}" draggable="true" style="${cardStyle}">
              <div class="collection-header">
                <div class="collection-header-left">
                  <span class="collection-drag-handle">â‹®â‹®</span>
                  <img src="${artist.profile_picture_url || 'https://via.placeholder.com/48'}" class="collection-artist-avatar" onerror="this.src='https://via.placeholder.com/48'">
                  <div class="collection-info">
                    <div style="display:flex;align-items:center;gap:12px;">
                      <h3 style="margin:0;">${c.name || artist.name + "'s Wannados"}</h3>
                      <button onclick="event.stopPropagation(); window.toggleCollectionVisibility('${c.id}', ${isActive})" style="padding:6px 12px;background:${isActive ? '#34c759' : '#8e8e93'};color:white;border:none;border-radius:6px;font-size:11px;cursor:pointer;font-weight:500;">${isActive ? 'â— Sichtbar' : 'â—‹ Versteckt'}</button>
                    </div>
                    <p>${artist.name} Â· ${available} verfÃ¼gbar Â· ${sold} verkauft</p>
                  </div>
                </div>
                <div style="display:flex;gap:8px;">
                  <button onclick="window.addWannadoToCollection('${c.id}','${c.artist_id}')" style="padding:8px 16px;background:rgba(0,113,227,0.1);color:#0071e3;border:none;border-radius:6px;font-size:13px;cursor:pointer;">+ Wannado</button>
                  <button onclick="window.deleteCollection('${c.id}')" style="padding:8px 12px;background:rgba(255,59,48,0.1);color:#ff3b30;border:none;border-radius:6px;cursor:pointer;">ðŸ—‘ï¸</button>
                </div>
              </div>
              <div class="collection-wannados">
                ${!wannados.length ? '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#86868b;">Noch keine Wannados</div>' :
                  wannados.map(w => `
                    <div class="wannado-card ${w.status === 'sold' ? 'sold' : ''}" onclick="window.openEditWannadoModal('${w.id}')">
                      ${w.image_url ? `<img src="${w.image_url}" class="wannado-image" onerror="this.style.display='none'">` : ''}
                      <div class="wannado-image" style="${w.image_url ? 'display:none;' : ''}display:flex;align-items:center;justify-content:center;font-size:32px;background:#f0f0f0;">ðŸŽ¨</div>
                      <div class="wannado-details">
                        <h4 class="wannado-name">${w.name}</h4>
                        <div class="wannado-meta">
                          <span class="wannado-price">${Number(w.price).toFixed(0)}â‚¬</span>
                          <span class="wannado-duration">${w.duration_hours}h</span>
                        </div>
                      </div>
                      ${w.status === 'sold' ? '<div class="wannado-sold-badge">SOLD</div>' : ''}
                    </div>
                  `).join('')}
              </div>
            </div>`;
        }).join('');
        initCollectionDragDrop();
      }

      function initCollectionDragDrop() {
        const container = document.getElementById('wannadoCollectionsList');
        let dragged = null;
        container.querySelectorAll('.wannado-collection-card').forEach(card => {
          card.addEventListener('dragstart', e => { dragged = card; card.classList.add('dragging'); });
          card.addEventListener('dragend', () => { card.classList.remove('dragging'); dragged = null; });
          card.addEventListener('dragover', e => e.preventDefault());
          card.addEventListener('drop', async e => {
            e.preventDefault();
            if (dragged === card) return;
            const cards = [...container.querySelectorAll('.wannado-collection-card')];
            const di = cards.indexOf(dragged), ti = cards.indexOf(card);
            di < ti ? card.after(dragged) : card.before(dragged);
            const newCards = [...container.querySelectorAll('.wannado-collection-card')];
            for (let i = 0; i < newCards.length; i++) {
              await supabase.from('wannado_collections').update({ sort_order: i }).eq('id', newCards[i].dataset.collectionId);
            }
          });
        });
      }

      async function openCreateCollectionModal() {
        console.log('WANNADO_ARTIST_IDS:', WANNADO_ARTIST_IDS);
        const { data: artists, error } = await supabase.from('artists').select('id, name, profile_picture_url').in('id', WANNADO_ARTIST_IDS);
        console.log('Loaded artists:', artists);
        if (error) console.error('Error loading artists:', error);
        document.getElementById('collectionArtistGrid').innerHTML = (artists || []).map(a => `
          <div class="artist-select-card" data-artist-id="${a.id}" onclick="window.selectCollectionArtist('${a.id}')">
            <img src="${a.profile_picture_url || 'https://via.placeholder.com/50'}" onerror="this.src='https://via.placeholder.com/50'">
            <div class="name">${a.name}</div>
          </div>
        `).join('');
        document.getElementById('collectionArtistId').value = '';
        document.getElementById('collectionName').value = '';
        document.getElementById('wannadoRowsContainer').innerHTML = '';
        wannadoRowCount = 0;
        addWannadoRow();
        document.getElementById('createCollectionModal').style.display = 'flex';
      }

      function closeCreateCollectionModal() { document.getElementById('createCollectionModal').style.display = 'none'; }

      function selectCollectionArtist(id) {
        document.querySelectorAll('.artist-select-card').forEach(c => c.classList.remove('selected'));
        document.querySelector(`.artist-select-card[data-artist-id="${id}"]`).classList.add('selected');
        document.getElementById('collectionArtistId').value = id;
      }

      function addWannadoRow() {
        wannadoRowCount++;
        const r = wannadoRowCount;
        document.getElementById('wannadoRowsContainer').innerHTML += `
          <div class="wannado-row" data-row-id="${r}">
            <div class="wannado-row-header">
              <span class="wannado-row-number">Wannado #${r}</span>
              <button type="button" class="wannado-row-delete" onclick="this.closest('.wannado-row').remove()">Ã—</button>
            </div>
            <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px;margin-bottom:12px;">
              <div><label style="display:block;font-size:12px;margin-bottom:4px;">Name *</label><input type="text" name="wannado_name_${r}" required style="width:100%;padding:10px;border:1px solid rgba(0,0,0,0.1);border-radius:6px;box-sizing:border-box;"></div>
              <div><label style="display:block;font-size:12px;margin-bottom:4px;">Preis â‚¬</label><input type="number" name="wannado_price_${r}" min="1" required style="width:100%;padding:10px;border:1px solid rgba(0,0,0,0.1);border-radius:6px;box-sizing:border-box;"></div>
              <div><label style="display:block;font-size:12px;margin-bottom:4px;">Dauer h</label><input type="number" name="wannado_duration_${r}" min="0.5" step="0.5" required style="width:100%;padding:10px;border:1px solid rgba(0,0,0,0.1);border-radius:6px;box-sizing:border-box;"></div>
            </div>
            <div><label style="display:block;font-size:12px;margin-bottom:4px;">Bild</label>
              <div class="wannado-image-upload" id="wannadoUpload_${r}" onclick="document.getElementById('wannadoFile_${r}').click()">ðŸ“· Bild hochladen</div>
              <input type="file" id="wannadoFile_${r}" name="wannado_file_${r}" accept="image/*" style="display:none" onchange="window.previewWannadoImage(${r},event)">
            </div>
          </div>`;
      }

      function previewWannadoImage(r, e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          const div = document.getElementById('wannadoUpload_' + r);
          div.innerHTML = '<img src="' + ev.target.result + '">';
          div.classList.add('has-image');
        };
        reader.readAsDataURL(file);
      }

      async function saveCollection(e) {
        e.preventDefault();
        const artistId = document.getElementById('collectionArtistId').value;
        if (!artistId) { alert('Bitte Artist auswÃ¤hlen'); return; }
        const btn = document.getElementById('saveCollectionBtn');
        btn.disabled = true; btn.textContent = 'Speichert...';
        try {
          const { data: coll, error } = await supabase.from('wannado_collections').insert({ artist_id: artistId, name: document.getElementById('collectionName').value.trim() || null, sort_order: 0 }).select().single();
          if (error) throw error;
          await supabase.rpc('increment_collection_sort_order');
          for (const row of document.querySelectorAll('.wannado-row')) {
            const r = row.dataset.rowId;
            const name = row.querySelector(`[name="wannado_name_${r}"]`).value.trim();
            const price = parseFloat(row.querySelector(`[name="wannado_price_${r}"]`).value);
            const duration = parseFloat(row.querySelector(`[name="wannado_duration_${r}"]`).value);
            if (!name || !price || !duration) continue;
            let imageUrl = null;
            const fileInput = document.getElementById('wannadoFile_' + r);
            if (fileInput && fileInput.files[0]) {
              const file = fileInput.files[0];
              const fileName = 'wannado_' + coll.id + '_' + Date.now() + '_' + r + '.' + file.name.split('.').pop();
              const { error: upErr } = await supabase.storage.from('wannado-images').upload(fileName, file);
              if (!upErr) imageUrl = supabase.storage.from('wannado-images').getPublicUrl(fileName).data.publicUrl;
            }
            await supabase.from('wannados').insert({ collection_id: coll.id, artist_id: artistId, name, price, duration_hours: duration, image_url: imageUrl, status: 'available' });
          }
          closeCreateCollectionModal();
          loadWannadoCollections();
        } catch (err) { alert('Fehler: ' + err.message); }
        btn.disabled = false; btn.textContent = 'Collection speichern';
      }

      async function addWannadoToCollection(collId, artistId) {
        const name = prompt('Wannado Name:'); if (!name) return;
        const price = prompt('Preis (â‚¬):'); if (!price) return;
        const duration = prompt('Dauer (h):'); if (!duration) return;
        await supabase.from('wannados').insert({ collection_id: collId, artist_id: artistId, name, price: parseFloat(price), duration_hours: parseFloat(duration), status: 'available' });
        loadWannadoCollections();
      }

      async function openEditWannadoModal(id) {
        const { data: w } = await supabase.from('wannados').select('*').eq('id', id).single();
        if (!w) return;
        document.getElementById('editWannadoId').value = w.id;
        document.getElementById('editWannadoName').value = w.name;
        document.getElementById('editWannadoPrice').value = w.price;
        document.getElementById('editWannadoDuration').value = w.duration_hours;
        document.getElementById('editWannadoStatus').value = w.status;
        document.getElementById('editWannadoImagePreview').innerHTML = w.image_url ? '<img src="' + w.image_url + '" style="max-width:100%;max-height:100%;object-fit:contain;">' : '<span style="color:#86868b;">Kein Bild</span>';
        document.getElementById('editWannadoModal').style.display = 'flex';
      }

      function closeEditWannadoModal() { document.getElementById('editWannadoModal').style.display = 'none'; }

      function previewEditWannadoImage(e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => { document.getElementById('editWannadoImagePreview').innerHTML = '<img src="' + ev.target.result + '" style="max-width:100%;max-height:100%;object-fit:contain;">'; };
        reader.readAsDataURL(file);
      }

      async function updateWannado(e) {
        e.preventDefault();
        const id = document.getElementById('editWannadoId').value;
        const data = { name: document.getElementById('editWannadoName').value, price: parseFloat(document.getElementById('editWannadoPrice').value), duration_hours: parseFloat(document.getElementById('editWannadoDuration').value), status: document.getElementById('editWannadoStatus').value };
        const fileInput = document.getElementById('editWannadoImage');
        if (fileInput.files[0]) {
          const file = fileInput.files[0];
          const fileName = 'wannado_' + id + '_' + Date.now() + '.' + file.name.split('.').pop();
          const { error } = await supabase.storage.from('wannado-images').upload(fileName, file);
          if (!error) data.image_url = supabase.storage.from('wannado-images').getPublicUrl(fileName).data.publicUrl;
        }
        await supabase.from('wannados').update(data).eq('id', id);
        closeEditWannadoModal();
        loadWannadoCollections();
      }

      async function deleteWannadoFromEdit() {
        if (!confirm('Wannado lÃ¶schen?')) return;
        await supabase.from('wannados').delete().eq('id', document.getElementById('editWannadoId').value);
        closeEditWannadoModal();
        loadWannadoCollections();
      }

      async function deleteCollection(id) {
        if (!confirm('Collection und alle Wannados lÃ¶schen?')) return;
        await supabase.from('wannado_collections').delete().eq('id', id);
        loadWannadoCollections();
      }

      async function toggleCollectionVisibility(collectionId, currentState) {
        try {
          const newState = !currentState;
          const { error } = await supabase
            .from('wannado_collections')
            .update({ is_active: newState })
            .eq('id', collectionId);
          if (error) throw error;
          showNotification(newState ? 'Collection ist jetzt sichtbar' : 'Collection ist jetzt versteckt', 'success');
          window.loadWannadoCollections();
        } catch (err) {
          console.error('Error toggling visibility:', err);
          showNotification('Fehler: ' + err.message, 'error');
        }
      }

      // Wannado functions global verfÃ¼gbar machen
      window.loadWannadoCollections = loadWannadoCollections;
      window.renderWannadoCollections = renderWannadoCollections;
      window.initCollectionDragDrop = initCollectionDragDrop;
      window.openCreateCollectionModal = openCreateCollectionModal;
      window.closeCreateCollectionModal = closeCreateCollectionModal;
      window.selectCollectionArtist = selectCollectionArtist;
      window.addWannadoRow = addWannadoRow;
      window.previewWannadoImage = previewWannadoImage;
      window.saveCollection = saveCollection;
      window.addWannadoToCollection = addWannadoToCollection;
      window.openEditWannadoModal = openEditWannadoModal;
      window.closeEditWannadoModal = closeEditWannadoModal;
      window.previewEditWannadoImage = previewEditWannadoImage;
      window.updateWannado = updateWannado;
      window.deleteWannadoFromEdit = deleteWannadoFromEdit;
      window.deleteCollection = deleteCollection;
      window.toggleCollectionVisibility = toggleCollectionVisibility;

      // ==========================================
      // MOBILE OPTIMIZATIONS
      // ==========================================

      // Mobile check helper
      const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

      // Global slider state
      window.mobileSliders = {
        pinnedEvents: {
          currentIndex: 0,
          items: [],
          interval: null,
          paused: false
        },
        schwarzesBrett: {
          currentIndex: 0,
          items: [],
          interval: null,
          paused: false
        }
      };

      // ==========================================
      // MOBILE PROFILE PANEL
      // ==========================================
      function initMobileProfilePanel() {
        const trigger = document.getElementById('mobileProfileTrigger');
        const panel = document.getElementById('mobileProfilePanel');
        const overlay = document.getElementById('mobileProfileOverlay');
        const closeBtn = document.getElementById('mobileProfileClose');

        if (!trigger || !panel || !overlay) return;

        // Open panel
        trigger.addEventListener('click', function(e) {
          if (!isMobile()) return;
          e.stopPropagation();
          panel.classList.add('active');
          overlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        });

        // Close panel
        function closePanel() {
          panel.classList.remove('active');
          overlay.classList.remove('active');
          document.body.style.overflow = '';
        }

        if (closeBtn) closeBtn.addEventListener('click', closePanel);
        overlay.addEventListener('click', closePanel);

        // Swipe to close
        let touchStartX = 0;
        let touchCurrentX = 0;
        let isSwiping = false;

        panel.addEventListener('touchstart', function(e) {
          touchStartX = e.touches[0].clientX;
          isSwiping = true;
        }, { passive: true });

        panel.addEventListener('touchmove', function(e) {
          if (!isSwiping) return;
          touchCurrentX = e.touches[0].clientX;
          const diff = touchCurrentX - touchStartX;
          if (diff > 0) {
            panel.style.transform = `translateX(${diff}px)`;
          }
        }, { passive: true });

        panel.addEventListener('touchend', function(e) {
          if (!isSwiping) return;
          isSwiping = false;
          const diff = touchCurrentX - touchStartX;
          if (diff > 100) {
            closePanel();
          }
          panel.style.transform = '';
        });

        // Menu item actions
        const dashboardBtn = document.getElementById('mobileProfileDashboard');
        const settingsBtn = document.getElementById('mobileProfileSettings');
        const commandMenuBtn = document.getElementById('mobileProfileCommandMenu');
        const homePageBtn = document.getElementById('mobileProfileHomePage');
        const logoutBtn = document.getElementById('mobileProfileLogout');

        if (dashboardBtn) {
          dashboardBtn.addEventListener('click', function() {
            closePanel();
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection) {
              document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
              dashboardSection.classList.add('active');
              dashboardSection.style.display = 'block';
            }
          });
        }

        if (settingsBtn) {
          settingsBtn.addEventListener('click', function() {
            closePanel();
            const accountSection = document.getElementById('account-section');
            if (accountSection) {
              document.querySelectorAll('section').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
              });
              accountSection.classList.add('active');
              accountSection.style.display = 'block';
            }
          });
        }

        if (commandMenuBtn) {
          commandMenuBtn.addEventListener('click', function() {
            closePanel();
            const commandMenu = document.getElementById('commandMenu');
            if (commandMenu) commandMenu.classList.add('active');
          });
        }

        if (homePageBtn) {
          homePageBtn.addEventListener('click', function() {
            window.location.href = '/';
          });
        }

        if (logoutBtn) {
          logoutBtn.addEventListener('click', async function() {
            closePanel();
            if (typeof supabase !== 'undefined') {
              await supabase.auth.signOut();
            }
            localStorage.clear();
            window.location.reload();
          });
        }

        // Theme buttons
        const lightBtn = document.getElementById('mobileLightThemeBtn');
        const darkBtn = document.getElementById('mobileDarkThemeBtn');

        function updateMobileThemeButtons() {
          const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
          if (lightBtn) lightBtn.classList.toggle('active', currentTheme === 'light');
          if (darkBtn) darkBtn.classList.toggle('active', currentTheme === 'dark');
        }

        if (lightBtn) {
          lightBtn.addEventListener('click', function() {
            document.documentElement.setAttribute('data-theme', 'light');
            localStorage.setItem('theme', 'light');
            updateMobileThemeButtons();
            // Sync with desktop theme buttons
            const desktopLight = document.getElementById('lightThemeBtn');
            const desktopDark = document.getElementById('darkThemeBtn');
            if (desktopLight) desktopLight.classList.add('active');
            if (desktopDark) desktopDark.classList.remove('active');
          });
        }

        if (darkBtn) {
          darkBtn.addEventListener('click', function() {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
            updateMobileThemeButtons();
            // Sync with desktop theme buttons
            const desktopLight = document.getElementById('lightThemeBtn');
            const desktopDark = document.getElementById('darkThemeBtn');
            if (desktopLight) desktopLight.classList.remove('active');
            if (desktopDark) desktopDark.classList.add('active');
          });
        }

        updateMobileThemeButtons();
      }

      // ==========================================
      // MOBILE TAB SWITCHER
      // ==========================================
      function initMobileTabSwitcher() {
        const tabs = document.querySelectorAll('.mobile-content-tab');
        const pinnedPane = document.getElementById('mobilePinnedEventsPane');
        const brettPane = document.getElementById('mobileSchwarzesBrettPane');

        tabs.forEach(tab => {
          tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;

            // Update tab active state
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Switch panes
            if (targetTab === 'pinned-events') {
              pinnedPane.classList.add('active');
              brettPane.classList.remove('active');
              // Restart pinned events slider
              stopMobileSlider('schwarzesBrett');
              if (isMobile()) startMobileSlider('pinnedEvents');
            } else {
              pinnedPane.classList.remove('active');
              brettPane.classList.add('active');
              // Restart schwarzes brett slider
              stopMobileSlider('pinnedEvents');
              if (isMobile()) startMobileSlider('schwarzesBrett');
            }
          });
        });
      }

      // ==========================================
      // MOBILE SLIDERS
      // ==========================================
      function initMobileSliders() {
        if (!isMobile()) return;

        // Populate sliders with content
        populateMobileSlider('pinnedEvents');
        populateMobileSlider('schwarzesBrett');

        // Start the active slider
        const activeTab = document.querySelector('.mobile-content-tab.active');
        if (activeTab) {
          const tabType = activeTab.dataset.tab === 'pinned-events' ? 'pinnedEvents' : 'schwarzesBrett';
          startMobileSlider(tabType);
        }
      }

      function populateMobileSlider(type) {
        const slider = window.mobileSliders[type];
        let sourceContainer, targetContainer, indicator;

        if (type === 'pinnedEvents') {
          sourceContainer = document.getElementById('pinnedEventsContainer');
          targetContainer = document.getElementById('mobilePinnedEventsSlider');
          indicator = document.getElementById('mobilePinnedEventsIndicator');
        } else {
          sourceContainer = document.getElementById('brettMessages');
          targetContainer = document.getElementById('mobileSchwarzesBrettSlider');
          indicator = document.getElementById('mobileSchwarzesBrettIndicator');
        }

        if (!sourceContainer || !targetContainer) return;

        // Get items from source
        let items;
        if (type === 'pinnedEvents') {
          items = sourceContainer.querySelectorAll('.event-item, .pinned-event-card');
        } else {
          items = sourceContainer.querySelectorAll('.brett-message');
        }

        // Clear target
        targetContainer.innerHTML = '';
        slider.items = [];

        if (items.length === 0) {
          targetContainer.innerHTML = '<div class="mobile-slider-item active" style="padding: 20px; text-align: center; color: var(--macos-text-secondary);">Keine EintrÃ¤ge</div>';
          if (indicator) indicator.textContent = '0 / 0';
          return;
        }

        // Clone items to slider
        items.forEach((item, index) => {
          const clone = item.cloneNode(true);
          clone.classList.add('mobile-slider-item');
          if (index === 0) clone.classList.add('active');
          clone.style.cssText = '';
          targetContainer.appendChild(clone);
          slider.items.push(clone);
        });

        slider.currentIndex = 0;
        updateSliderIndicator(type);

        // Add touch/tap handlers
        setupSliderTouchHandlers(type, targetContainer);
      }

      function setupSliderTouchHandlers(type, container) {
        const slider = window.mobileSliders[type];
        let touchStartX = 0;
        let touchEndX = 0;

        // Tap to pause/resume
        container.addEventListener('click', function(e) {
          if (e.target.closest('a, button')) return; // Don't pause on links/buttons
          slider.paused = !slider.paused;
          const indicator = type === 'pinnedEvents'
            ? document.getElementById('mobilePinnedEventsIndicator')
            : document.getElementById('mobileSchwarzesBrettIndicator');
          if (indicator) {
            indicator.classList.toggle('paused', slider.paused);
          }
        });

        // Swipe handlers
        container.addEventListener('touchstart', function(e) {
          touchStartX = e.touches[0].clientX;
        }, { passive: true });

        container.addEventListener('touchend', function(e) {
          touchEndX = e.changedTouches[0].clientX;
          const diff = touchStartX - touchEndX;

          if (Math.abs(diff) > 50) {
            if (diff > 0) {
              // Swipe left - next
              goToSlide(type, slider.currentIndex + 1);
            } else {
              // Swipe right - previous
              goToSlide(type, slider.currentIndex - 1);
            }
          }
        }, { passive: true });
      }

      function startMobileSlider(type) {
        if (!isMobile()) return;

        const slider = window.mobileSliders[type];
        if (slider.interval) clearInterval(slider.interval);

        slider.interval = setInterval(() => {
          if (!slider.paused && slider.items.length > 1) {
            goToSlide(type, slider.currentIndex + 1);
          }
        }, 5000);
      }

      function stopMobileSlider(type) {
        const slider = window.mobileSliders[type];
        if (slider.interval) {
          clearInterval(slider.interval);
          slider.interval = null;
        }
      }

      function goToSlide(type, index) {
        const slider = window.mobileSliders[type];
        if (slider.items.length === 0) return;

        // Wrap around
        if (index >= slider.items.length) index = 0;
        if (index < 0) index = slider.items.length - 1;

        // Update active state
        slider.items.forEach((item, i) => {
          item.classList.toggle('active', i === index);
        });

        slider.currentIndex = index;
        updateSliderIndicator(type);
      }

      function updateSliderIndicator(type) {
        const slider = window.mobileSliders[type];
        const indicator = type === 'pinnedEvents'
          ? document.getElementById('mobilePinnedEventsIndicator')
          : document.getElementById('mobileSchwarzesBrettIndicator');

        if (indicator) {
          indicator.textContent = `${slider.currentIndex + 1} / ${slider.items.length}`;
        }
      }

      // ==========================================
      // MOBILE LAYOUT SETUP
      // ==========================================
      function setupMobileLayout() {
        const mobileTabsWrapper = document.getElementById('mobileTabsWrapper');
        const mobileProfileTrigger = document.getElementById('mobileProfileTrigger');
        const profileButton = document.getElementById('profileButton');

        if (isMobile()) {
          // Show mobile elements
          if (mobileTabsWrapper) mobileTabsWrapper.style.display = 'block';
          if (mobileProfileTrigger) mobileProfileTrigger.style.display = 'flex';
          if (profileButton) profileButton.style.display = 'none';

          // Initialize sliders
          initMobileSliders();

          // Update mobile profile panel user info
          updateMobileProfileInfo();
        } else {
          // Hide mobile elements, restore desktop
          if (mobileTabsWrapper) mobileTabsWrapper.style.display = 'none';
          if (mobileProfileTrigger) mobileProfileTrigger.style.display = 'none';
          if (profileButton) profileButton.style.display = '';

          // Stop all sliders
          stopMobileSlider('pinnedEvents');
          stopMobileSlider('schwarzesBrett');

          // Close mobile panel if open
          const panel = document.getElementById('mobileProfilePanel');
          const overlay = document.getElementById('mobileProfileOverlay');
          if (panel) panel.classList.remove('active');
          if (overlay) overlay.classList.remove('active');
          document.body.style.overflow = '';
        }
      }

      function updateMobileProfileInfo() {
        const mobileUsername = document.getElementById('mobileProfileUsername');
        const mobileEmail = document.getElementById('mobileProfileEmail');
        const desktopUsername = document.getElementById('profileDropdownUsername');
        const desktopEmail = document.getElementById('profileDropdownEmail');

        if (mobileUsername && desktopUsername) {
          mobileUsername.textContent = desktopUsername.textContent;
        }
        if (mobileEmail && desktopEmail) {
          mobileEmail.textContent = desktopEmail.textContent;
        }
      }

      // Refresh sliders when content updates
      window.refreshMobileSliders = function() {
        if (!isMobile()) return;
        populateMobileSlider('pinnedEvents');
        populateMobileSlider('schwarzesBrett');
      };

      // === GLOBAL MOBILE PROFILE FUNCTIONS ===
      window.openMobileProfile = function() {
        if (!isMobile()) return;
        const overlay = document.getElementById('mobileProfileOverlay');
        const panel = document.getElementById('mobileProfilePanel');
        if (overlay) overlay.classList.add('active');
        if (panel) panel.classList.add('active');
        document.body.style.overflow = 'hidden';
      };

      window.closeMobileProfile = function() {
        const overlay = document.getElementById('mobileProfileOverlay');
        const panel = document.getElementById('mobileProfilePanel');
        if (overlay) overlay.classList.remove('active');
        if (panel) panel.classList.remove('active');
        document.body.style.overflow = '';
      };

      // Mobile logout handler
      window.handleMobileLogout = function() {
        console.log('ðŸšª Mobile logout triggered');
        closeMobileProfile();

        // Trigger the normal logout function
        if (typeof handleLogout === 'function') {
          handleLogout();
        } else if (typeof logout === 'function') {
          logout();
        } else {
          // Fallback: Find and click the logout button
          const logoutBtn = document.getElementById('logoutBtn') || document.getElementById('mobileProfileLogout');
          if (logoutBtn && logoutBtn !== event?.target) logoutBtn.click();
        }
      };

      // Mobile Notification Panel functions
      window.openMobileNotificationPanel = function() {
        document.getElementById('mobileNotificationPanel')?.classList.add('active');
        document.body.style.overflow = 'hidden';
        loadMobileNotifications();
      };

      window.closeMobileNotificationPanel = function() {
        document.getElementById('mobileNotificationPanel')?.classList.remove('active');
        document.body.style.overflow = '';
      };

      // Mobile Inbox Panel functions
      window.openMobileInbox = function() {
        const panel = document.getElementById('mobileInboxPanel');
        if (panel) {
          panel.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      };

      window.closeMobileInbox = function() {
        const panel = document.getElementById('mobileInboxPanel');
        if (panel) {
          panel.classList.remove('active');
          document.body.style.overflow = '';
        }
      };

      async function loadMobileNotifications() {
        const content = document.getElementById('mobileNotificationContent');
        if (!content) return;
        // TODO: Load actual notifications from schwarzes_brett or wherever they are stored
        // For now show empty state
      }

      // Update mobile profile with user data
      window.updateMobileProfileData = function() {
        const user = window.currentUser || (typeof currentUser !== 'undefined' ? currentUser : null);
        if (!user) return;

        const mobileUsername = document.getElementById('mobileProfileUsername');
        const mobileEmail = document.getElementById('mobileProfileEmail');

        if (mobileUsername) mobileUsername.textContent = user.username || user.name || 'User';
        if (mobileEmail) mobileEmail.textContent = user.email || '';

        console.log('ðŸ“± Mobile profile data updated:', user.username || user.name);
      };

      // Initialize mobile features
      initMobileProfilePanel();
      initMobileTabSwitcher();
      setupMobileLayout();

      // Handle resize
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          setupMobileLayout();
        }, 250);
      });

      // Observer to refresh sliders when content changes
      const pinnedEventsObserver = new MutationObserver(function() {
        if (isMobile()) {
          setTimeout(() => populateMobileSlider('pinnedEvents'), 100);
        }
      });
      const brettObserver = new MutationObserver(function() {
        if (isMobile()) {
          setTimeout(() => populateMobileSlider('schwarzesBrett'), 100);
        }
      });

      const pinnedContainer = document.getElementById('pinnedEventsContainer');
      const brettContainer = document.getElementById('brettMessages');
      if (pinnedContainer) {
        pinnedEventsObserver.observe(pinnedContainer, { childList: true, subtree: true });
      }
      if (brettContainer) {
        brettObserver.observe(brettContainer, { childList: true, subtree: true });
      }

      // Initialize auth
      initAuth();
    });

    // ==========================================
    // MOBILE VIEW HELPERS (called by handleMobileNav)
    // ==========================================
    function showMobileDashboard() {
      // Hide mobile-exclusive views
      document.getElementById('mobileCalendarView')?.classList.remove('active');
      document.getElementById('mobileDienstplanView')?.classList.remove('active');

      // Show dashboard section
      document.querySelectorAll('section').forEach(s => {
        s.style.display = 'none';
        s.classList.remove('active');
      });

      const dashboard = document.getElementById('dashboard-section');
      if (dashboard) {
        dashboard.style.display = 'block';
        dashboard.classList.add('active');
      }
      updateMobileHeaderTitle('dashboard');
      console.log('âœ… Switched to Dashboard');
    }

    function showMobileCalendar() {
      // Hide all sections
      document.querySelectorAll('section').forEach(s => {
        s.style.display = 'none';
        s.classList.remove('active');
      });

      // Hide mobile dienstplan
      document.getElementById('mobileDienstplanView')?.classList.remove('active');

      // Show mobile calendar
      const mobileCalendar = document.getElementById('mobileCalendarView');
      if (mobileCalendar) {
        mobileCalendar.classList.add('active');
        if (typeof loadMobileCalendarData === 'function') loadMobileCalendarData();
      }
      updateMobileHeaderTitle('calendar');
      console.log('âœ… Switched to Mobile Calendar');
    }

    function showMobileDienstplan() {
      // Hide all sections
      document.querySelectorAll('section').forEach(s => {
        s.style.display = 'none';
        s.classList.remove('active');
      });

      // Hide mobile calendar
      document.getElementById('mobileCalendarView')?.classList.remove('active');

      // Show mobile dienstplan
      const mobileDienstplan = document.getElementById('mobileDienstplanView');
      if (mobileDienstplan) {
        mobileDienstplan.classList.add('active');
        if (typeof loadMobileDienstplanData === 'function') loadMobileDienstplanData();
      }
      updateMobileHeaderTitle('dienstplan');
      console.log('âœ… Switched to Mobile Dienstplan');
    }

    // ==========================================
    // MOBILE CALENDAR - STATE & DATA
    // ==========================================
    const mobileCalState = {
      currentWeekStart: getMonday(new Date()),
      selectedDate: new Date(),
      categoryFilter: 'all'
    };

    function getMonday(d) {
      const date = new Date(d);
      const day = date.getDay();
      const diff = date.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(date.setDate(diff));
    }

    // ========================================
    // ARTIST FILTER HELPER - KRITISCH WICHTIG
    // ========================================
    function getUserArtistFilter() {
      const user = window.currentUser;
      if (!user) return { canSeeAll: false, artistId: null, artistName: null };

      const userRole = (user.role || user.user_role || '').toLowerCase();

      // These roles can see ALL entries
      const adminRoles = ['admin', 'owner', 'management', 'manager', 'booking', 'superadmin'];
      const canSeeAll = adminRoles.some(r => userRole.includes(r));

      if (canSeeAll) {
        console.log('ðŸ‘¤ User can see all entries (Role:', userRole, ')');
        return { canSeeAll: true, artistId: null, artistName: null };
      }

      // For normal users (Artists): Find artist_id via email
      let allArtists = [];
      if (typeof CentralDataManager !== 'undefined' && CentralDataManager.getArtists) {
        allArtists = CentralDataManager.getArtists() || [];
      }

      const matchingArtist = allArtists.find(a =>
        a.email && user.email &&
        a.email.toLowerCase().trim() === user.email.toLowerCase().trim()
      );

      if (matchingArtist) {
        console.log('ðŸ‘¤ Artist found:', matchingArtist.name, '(ID:', matchingArtist.id, ')');
        return { canSeeAll: false, artistId: matchingArtist.id, artistName: matchingArtist.name };
      }

      console.log('âš ï¸ No matching artist found for:', user.email);
      return { canSeeAll: false, artistId: null, artistName: null };
    }

    function filterShiftsByArtist(shifts) {
      const filter = getUserArtistFilter();

      if (filter.canSeeAll) {
        return shifts; // Admin/Management sees all
      }

      if (!filter.artistId) {
        return []; // No artist found = no entries
      }

      // Filter to ONLY own entries
      return shifts.filter(s => s.artist_id === filter.artistId);
    }

    function filterAppointmentsByArtist(appointments) {
      const filter = getUserArtistFilter();

      if (filter.canSeeAll) {
        return appointments;
      }

      if (!filter.artistId) {
        return [];
      }

      return appointments.filter(apt =>
        apt.artist_id === filter.artistId ||
        apt.artist?.id === filter.artistId
      );
    }

    window.getUserArtistFilter = getUserArtistFilter;
    window.filterShiftsByArtist = filterShiftsByArtist;
    window.filterAppointmentsByArtist = filterAppointmentsByArtist;

    function formatDateShort(date) {
      return date.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' }).replace(',', '');
    }

    function formatDateLong(date) {
      return date.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' });
    }

    // Helper to update active day indicator in mobile calendar weekdays
    function updateMobileCalActiveDay() {
      const weekdays = document.querySelectorAll('.mobile-day-item');
      weekdays.forEach(day => {
        const dateStr = day.dataset.date;
        if (dateStr && mobileCalState.selectedDate) {
          const selectedStr = mobileCalState.selectedDate.toISOString().split('T')[0];
          day.classList.toggle('active', dateStr === selectedStr);
        }
      });
    }

    // Update mobile header title based on current page
    function updateMobileHeaderTitle(page) {
      // Try multiple possible selectors
      const headerTitle = document.querySelector('.header-title')
        || document.querySelector('.mobile-header-title')
        || document.querySelector('header h1')
        || document.querySelector('[class*="header"] [class*="title"]');

      console.log('ðŸ“± updateMobileHeaderTitle:', page, 'Element found:', !!headerTitle);

      if (!headerTitle) {
        console.log('ðŸ“± Header title element not found!');
        return;
      }

      // Only update on mobile
      if (window.innerWidth > 768) return;

      const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
      const monthNames = ['Jan', 'Feb', 'MÃ¤r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];

      if (page === 'dashboard') {
        headerTitle.textContent = 'Culture over Money';
      } else if (page === 'calendar' && typeof mobileCalState !== 'undefined') {
        // Show single selected date for calendar
        const d = mobileCalState.selectedDate;
        headerTitle.textContent = `${dayNames[d.getDay()]} ${d.getDate()}. ${monthNames[d.getMonth()]} ${d.getFullYear()}`;
      } else if (page === 'dienstplan' && typeof mobileDpState !== 'undefined') {
        // Show week range for dienstplan
        const start = mobileDpState.currentWeekStart;
        const end = new Date(start);
        end.setDate(end.getDate() + 6);
        headerTitle.textContent = `${dayNames[start.getDay()]} ${start.getDate()}.${start.getMonth()+1}. - ${dayNames[end.getDay()]} ${end.getDate()}.${end.getMonth()+1}.`;
      }
    }
    window.updateMobileHeaderTitle = updateMobileHeaderTitle;

    // Initialize Mobile Calendar
    function initMobileCalendar() {
      console.log('ðŸ“… Initializing mobile calendar (Multi-Artist Grid)...');

      // Initialize new Multi-Artist Calendar Grid
      if (typeof renderMobileCalWeekStrip === 'function') {
        renderMobileCalWeekStrip();
      }
      if (typeof renderMobileCalendarGrid === 'function') {
        renderMobileCalendarGrid();
      }
      if (typeof updateMobileCalHeaderDate === 'function') {
        updateMobileCalHeaderDate();
      }

      // Initialize scroll sync for the new grid
      if (typeof initMobileCalScrollSync === 'function') {
        initMobileCalScrollSync();
      }

      // Legacy: Also call old functions for backwards compatibility
      renderMobileCalWeekdays();
      renderMobileCalTimeline();

      // REMOVE old listeners by cloning elements
      const prevBtn = document.getElementById('mobileCalPrevWeek');
      const nextBtn = document.getElementById('mobileCalNextWeek');
      const todayBtn = document.getElementById('mobileCalToday');
      const categoryFilter = document.getElementById('mobileCalCategoryFilter');

      // Prev Day Button (changed from week to day navigation)
      if (prevBtn) {
        const newPrev = prevBtn.cloneNode(true);
        prevBtn.parentNode.replaceChild(newPrev, prevBtn);
        newPrev.addEventListener('click', () => {
          const newDate = new Date(mobileCalState.selectedDate);
          newDate.setDate(newDate.getDate() - 1);
          mobileCalState.selectedDate = newDate;

          // Update week start if we moved to previous week
          const monday = getMonday(newDate);
          if (monday.getTime() !== mobileCalState.currentWeekStart.getTime()) {
            mobileCalState.currentWeekStart = monday;
            renderMobileCalWeekdays();
          } else {
            updateMobileCalActiveDay();
          }

          loadMobileCalendarData();
          updateMobileHeaderTitle('calendar');
        });
      }

      // Next Day Button (changed from week to day navigation)
      if (nextBtn) {
        const newNext = nextBtn.cloneNode(true);
        nextBtn.parentNode.replaceChild(newNext, nextBtn);
        newNext.addEventListener('click', () => {
          const newDate = new Date(mobileCalState.selectedDate);
          newDate.setDate(newDate.getDate() + 1);
          mobileCalState.selectedDate = newDate;

          // Update week start if we moved to next week
          const monday = getMonday(newDate);
          if (monday.getTime() !== mobileCalState.currentWeekStart.getTime()) {
            mobileCalState.currentWeekStart = monday;
            renderMobileCalWeekdays();
          } else {
            updateMobileCalActiveDay();
          }

          loadMobileCalendarData();
          updateMobileHeaderTitle('calendar');
        });
      }

      if (todayBtn) {
        const newToday = todayBtn.cloneNode(true);
        todayBtn.parentNode.replaceChild(newToday, todayBtn);
        newToday.addEventListener('click', () => {
          mobileCalState.currentWeekStart = getMonday(new Date());
          mobileCalState.selectedDate = new Date();
          renderMobileCalWeekdays();
          loadMobileCalendarData();
          updateMobileHeaderTitle('calendar');
        });
      }

      if (categoryFilter) {
        const newFilter = categoryFilter.cloneNode(true);
        categoryFilter.parentNode.replaceChild(newFilter, categoryFilter);
        newFilter.addEventListener('change', (e) => {
          mobileCalState.categoryFilter = e.target.value;
          loadMobileCalendarData();
        });
      }

      // Swipe support
      let touchStartX = 0;
      const timeline = document.getElementById('mobileCalTimeline');
      if (timeline) {
        const newTimeline = timeline.cloneNode(true);
        timeline.parentNode.replaceChild(newTimeline, timeline);
        newTimeline.addEventListener('touchstart', e => touchStartX = e.touches[0].clientX);
        newTimeline.addEventListener('touchend', e => {
          const diff = touchStartX - e.changedTouches[0].clientX;
          if (Math.abs(diff) > 50) {
            if (diff > 0) document.getElementById('mobileCalNextWeek')?.click();
            else document.getElementById('mobileCalPrevWeek')?.click();
          }
        });
      }

      // Load initial data
      loadMobileCalendarData();
    }

    function renderMobileCalWeekdays() {
      const container = document.getElementById('mobileCalWeekdays');
      if (!container) return;

      const weekEnd = new Date(mobileCalState.currentWeekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);

      const weekLabel = document.getElementById('mobileCalWeekLabel');
      if (weekLabel) {
        weekLabel.textContent = `${formatDateShort(mobileCalState.currentWeekStart)} - ${formatDateShort(weekEnd)}`;
      }

      const days = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
      const today = new Date().toDateString();

      container.innerHTML = '';

      for (let i = 0; i < 7; i++) {
        const date = new Date(mobileCalState.currentWeekStart);
        date.setDate(date.getDate() + i);

        const isToday = date.toDateString() === today;
        const isSelected = date.toDateString() === mobileCalState.selectedDate.toDateString();

        const dayEl = document.createElement('div');
        dayEl.className = `mobile-cal-day ${isToday ? 'today' : ''} ${isSelected ? 'active' : ''}`;
        dayEl.innerHTML = `
          <div class="mobile-cal-day-name">${days[i]}</div>
          <div class="mobile-cal-day-num">${date.getDate()}</div>
        `;
        dayEl.addEventListener('click', () => {
          mobileCalState.selectedDate = new Date(date);
          renderMobileCalWeekdays();
          loadMobileCalendarData();
        });
        container.appendChild(dayEl);
      }
    }

    function renderMobileCalTimeline() {
      const container = document.getElementById('mobileCalHours');
      if (!container) return;

      container.innerHTML = '';

      for (let hour = 8; hour <= 22; hour++) {
        const row = document.createElement('div');
        row.className = 'mobile-cal-hour-row';
        row.innerHTML = `
          <div class="mobile-cal-hour-label">${hour.toString().padStart(2, '0')}:00</div>
          <div class="mobile-cal-hour-content" data-hour="${hour}"></div>
        `;
        container.appendChild(row);
      }
    }

    async function loadMobileCalendarData() {
      console.log('ðŸ“… loadMobileCalendarData called');

      const dateStr = mobileCalState.selectedDate.toISOString().split('T')[0];
      console.log('ðŸ“… Selected date:', dateStr);

      // Update date header in top navbar (kurzes Format)
      const header = document.getElementById('mobileCalNavDate');
      if (header) {
        header.textContent = mobileCalState.selectedDate.toLocaleDateString('de-DE', {
          weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'
        });
      }

      // Render empty timeline first
      renderMobileCalTimeline();

      // Get user - check all possible locations
      const user = window.currentUser || currentUser;
      console.log('ðŸ“… User:', user ? (user.username || user.name || 'found') : 'NOT FOUND');

      if (!user) {
        console.log('ðŸ“… No user, cannot load appointments');
        return;
      }

      // Get appointments from CentralDataManager
      let allAppointments = [];
      if (typeof CentralDataManager !== 'undefined' && CentralDataManager.isReady && CentralDataManager.isReady()) {
        allAppointments = CentralDataManager.getAppointments() || [];
        console.log('ðŸ“… Got appointments from CentralDataManager:', allAppointments.length);
      } else if (window.CentralDataManager && window.CentralDataManager.isReady()) {
        allAppointments = window.CentralDataManager.getAppointments() || [];
        console.log('ðŸ“… Got appointments from window.CentralDataManager:', allAppointments.length);
      }

      if (allAppointments.length === 0) {
        console.log('ðŸ“… No appointments available');
        return;
      }

      // Filter by date - try multiple date field names
      let appointments = allAppointments.filter(apt => {
        const aptDate = (apt.date || apt.appointment_date || apt.start || '').toString().split('T')[0];
        return aptDate === dateStr;
      });
      console.log('ðŸ“… Appointments for', dateStr + ':', appointments.length);

      // KRITISCH: Zentrale Artist-Filter Funktion nutzen (erkennt alle Admin-Rollen korrekt)
      appointments = filterAppointmentsByArtist(appointments);
      console.log('ðŸ“… After artist filter:', appointments.length);

      // Filter by category if set
      if (mobileCalState.categoryFilter && mobileCalState.categoryFilter !== 'all') {
        appointments = appointments.filter(apt => {
          const cat = (apt.category || apt.type || '').toLowerCase().replace(/\s+/g, '_');
          return cat === mobileCalState.categoryFilter;
        });
      }

      // Render events
      console.log('ðŸ“… Rendering', appointments.length, 'events');

      appointments.forEach(apt => {
        // Extract time - handle multiple formats
        let startTime = apt.start_time || apt.time_start || '09:00';
        let endTime = apt.end_time || apt.time_end || '10:00';

        // If start/end are datetime strings, extract time
        if (apt.start && apt.start.includes('T')) {
          startTime = apt.start.split('T')[1]?.substring(0, 5) || startTime;
        }
        if (apt.end && apt.end.includes('T')) {
          endTime = apt.end.split('T')[1]?.substring(0, 5) || endTime;
        }

        const startHour = parseInt(startTime.split(':')[0]);
        const startMin = parseInt(startTime.split(':')[1] || '0');
        const endHour = parseInt(endTime.split(':')[0]);

        if (startHour < 8 || startHour > 22) return;

        const container = document.querySelector(`.mobile-cal-hour-content[data-hour="${startHour}"]`);
        if (!container) return;

        const duration = Math.max((endHour - startHour) + ((parseInt(endTime.split(':')[1] || '0') - startMin) / 60), 0.5);
        const top = (startMin / 60) * 60;
        const height = Math.max(duration * 60 - 4, 30);

        // Map category names to CSS classes
        const category = (apt.category || apt.type || 'internal').toLowerCase().replace(/\s+/g, '_');
        let categoryClass = category;
        if (category.includes('consult')) categoryClass = 'consultation';
        if (category.includes('new') && category.includes('tattoo')) categoryClass = 'new_tattoo';
        if (category.includes('continu')) categoryClass = 'continuing_tattoo';
        if (category.includes('touch')) categoryClass = 'touch_up';
        if (category.includes('self')) categoryClass = 'selfbooking';
        if (category.includes('wanna')) categoryClass = 'wannado';
        if (category.includes('intern')) categoryClass = 'internal';
        if (category.includes('move')) categoryClass = 'move';
        if (category.includes('reserv')) categoryClass = 'reserved';
        if (category.includes('no_show') || category.includes('noshow')) categoryClass = 'no_show';

        const el = document.createElement('div');
        el.className = `mobile-cal-event ${categoryClass}`;
        el.style.cssText = `top:${top}px;height:${height}px;`;
        el.innerHTML = `
          <div class="mobile-cal-event-title">${apt.title || apt.customer_name || apt.name || 'Termin'}</div>
          <div class="mobile-cal-event-time">${startTime} - ${endTime}</div>
        `;
        el.onclick = () => openMobileCalModal(apt);
        container.appendChild(el);
      });

      console.log('ðŸ“… âœ… Mobile calendar rendered');
    }

    // ==========================================
    // MULTI-ARTIST CALENDAR GRID (NEW)
    // ==========================================
    // NOTE: calendarCategoryConfig and getAppointmentCategory are declared early
    // in the file (after chart instances) to ensure Desktop rendering works correctly

    // Alias fÃ¼r Mobile-KompatibilitÃ¤t
    const mobileCalCategoryConfig = calendarCategoryConfig;

    // Render Multi-Artist Calendar Grid
    function renderMobileCalendarGrid() {
      const container = document.getElementById('mobileCalArtistsScroll');
      if (!container) {
        console.log('ðŸ“… mobileCalArtistsScroll container not found');
        return;
      }

      const selectedDate = mobileCalState.selectedDate;
      const dateStr = selectedDate.toISOString().split('T')[0];
      console.log('ðŸ“… renderMobileCalendarGrid for:', dateStr);

      // 1. Alle Appointments fÃ¼r diesen Tag laden
      let allAppointments = [];
      if (typeof CentralDataManager !== 'undefined' && CentralDataManager.getAppointments) {
        allAppointments = CentralDataManager.getAppointments() || [];
      }

      const dayAppointments = allAppointments.filter(apt => {
        const aptDate = (apt.date || apt.appointment_date || apt.start || '').toString().split('T')[0];
        return aptDate === dateStr;
      });
      console.log('ðŸ“… Day appointments:', dayAppointments.length);

      // 2. Alle Artists mit Terminen an diesem Tag finden
      const artistIds = [...new Set(dayAppointments.map(apt => apt.artist_id).filter(Boolean))];

      let allArtists = [];
      if (typeof CentralDataManager !== 'undefined' && CentralDataManager.getArtists) {
        allArtists = CentralDataManager.getArtists() || [];
      }

      const artistsWithAppointments = artistIds.map(id => allArtists.find(a => a.id === id)).filter(Boolean);
      console.log('ðŸ“… Artists with appointments:', artistsWithAppointments.length);

      // Falls keine Artists mit Terminen
      if (artistsWithAppointments.length === 0) {
        container.innerHTML = `<div class="mobile-cal-no-appointments">Keine Termine fÃ¼r diesen Tag</div>`;
        return;
      }

      // 3. Artist-Spalten rendern
      container.innerHTML = artistsWithAppointments.map(artist => {
        const artistApts = dayAppointments.filter(apt => apt.artist_id === artist.id);

        // Artist Header mit Bild
        const avatarUrl = artist.profile_picture_url || '';
        const avatarHtml = avatarUrl
          ? `<img src="${avatarUrl}" class="mobile-cal-artist-avatar" alt="${artist.name}" onerror="this.outerHTML='<div class=\\'mobile-cal-artist-avatar\\' style=\\'display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;\\'>${(artist.name || '?').charAt(0)}</div>';">`
          : `<div class="mobile-cal-artist-avatar" style="display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;">${(artist.name || '?').charAt(0)}</div>`;

        // Stunden-Grid (09:00 - 22:00)
        let hoursHtml = '';
        for (let hour = 9; hour <= 22; hour++) {
          hoursHtml += `<div class="mobile-cal-hour-row-grid" data-hour="${hour}"></div>`;
        }

        // Appointments als Cards positionieren
        let appointmentsHtml = artistApts.map(apt => {
          // Zeit parsen
          let startTime = apt.start_time || apt.time_start || '09:00';
          let endTime = apt.end_time || apt.time_end || '10:00';

          if (apt.start && apt.start.includes('T')) {
            startTime = apt.start.split('T')[1]?.substring(0, 5) || startTime;
          }
          if (apt.end && apt.end.includes('T')) {
            endTime = apt.end.split('T')[1]?.substring(0, 5) || endTime;
          }

          const startHour = parseInt(startTime.split(':')[0]);
          const startMin = parseInt(startTime.split(':')[1] || '0');
          const endHour = parseInt(endTime.split(':')[0]);
          const endMin = parseInt(endTime.split(':')[1] || '0');

          // Position berechnen (relativ zu 09:00, innerhalb des hour-grid)
          const top = ((startHour - 9) * 60 + startMin);
          const height = Math.max(((endHour - startHour) * 60 + (endMin - startMin)), 30);

          // Kategorie aus work_process (primÃ¤r) oder Fallbacks
          let rawCategory = apt.work_process || apt.category || apt.type || apt.booking_type || '';
          let category = rawCategory.toLowerCase().trim().replace(/\s+/g, '_');

          // Normalisiere zu bekannten Kategorien
          if (category.includes('consult') || category === 'consultation') category = 'consultation';
          else if (category.includes('new') || category.includes('neu') || category === 'new_tattoo') category = 'new_tattoo';
          else if (category.includes('continu') || category.includes('weiter') || category === 'continuing_tattoo') category = 'continuing_tattoo';
          else if (category.includes('touch') || category === 'touch_up') category = 'touch_up';
          else if (category.includes('self') || category === 'selfbooking') category = 'selfbooking';
          else if (category.includes('wanna') || category === 'wannado') category = 'wannado';
          else if (category.includes('internal') || category.includes('intern')) category = 'internal';
          else category = category || 'consultation'; // Fallback

          const config = mobileCalCategoryConfig[category] || mobileCalCategoryConfig.consultation;

          // Kunden-Name
          const customerName = apt.customer
            ? `${apt.customer.first_name || ''} ${apt.customer.last_name || ''}`.trim() || 'Kunde'
            : apt.customer_name || apt.title || 'Kunde';

          // Kategorie-Label formatieren
          const categoryLabel = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

          return `
            <div class="mobile-cal-appointment" style="
              top: ${top}px;
              height: ${height}px;
              background: ${config.bg};
              color: ${config.color};
              border: 1px solid ${config.color}40;
            " onclick="openMobileCalModal && openMobileCalModal(${JSON.stringify(apt).replace(/"/g, '&quot;')})">
              <div class="mobile-cal-apt-time">${startTime} - ${endTime}</div>
              <div class="mobile-cal-apt-customer">${customerName}</div>
              <div class="mobile-cal-apt-category">${config.icon} ${categoryLabel}</div>
            </div>
          `;
        }).join('');

        return `
          <div class="mobile-cal-artist-column">
            <div class="mobile-cal-artist-header">
              ${avatarHtml}
              <span class="mobile-cal-artist-name">${artist.name || 'Artist'}</span>
            </div>
            <div class="mobile-cal-hour-grid" style="position:relative;">
              ${hoursHtml}
              ${appointmentsHtml}
            </div>
          </div>
        `;
      }).join('');

      console.log('ðŸ“… âœ… Multi-artist calendar grid rendered');

      // Dynamische HÃ¶hen synchronisieren
      syncMobileCalHourHeights();
    }

    // ==========================================
    // DYNAMISCHE HÃ–HEN FÃœR ZEITLEISTE
    // ==========================================

    function calculateHourHeights(appointments) {
      // Standard-HÃ¶he pro Stunde
      const hourHeights = {};
      for (let h = 9; h <= 22; h++) {
        hourHeights[h] = 60; // Minimum 60px
      }

      // PrÃ¼fe jeden Termin
      appointments.forEach(apt => {
        let startTime = apt.start_time || apt.time_start || '09:00';
        let endTime = apt.end_time || apt.time_end || '10:00';

        if (apt.start && apt.start.includes('T')) {
          startTime = apt.start.split('T')[1]?.substring(0, 5) || startTime;
        }
        if (apt.end && apt.end.includes('T')) {
          endTime = apt.end.split('T')[1]?.substring(0, 5) || endTime;
        }

        const startHour = parseInt(startTime.split(':')[0]);
        const endHour = parseInt(endTime.split(':')[0]);
        const endMin = parseInt(endTime.split(':')[1] || '0');

        // Berechne HÃ¶he fÃ¼r die Startstunde basierend auf Termin-Dauer
        const durationMinutes = (endHour - startHour) * 60 + endMin - parseInt(startTime.split(':')[1] || '0');
        const requiredHeight = Math.max(durationMinutes, 60);

        // Verteile die HÃ¶he auf die betroffenen Stunden
        for (let h = startHour; h < endHour + (endMin > 0 ? 1 : 0) && h <= 22; h++) {
          hourHeights[h] = Math.max(hourHeights[h], 60);
        }
      });

      return hourHeights;
    }

    function syncMobileCalHourHeights() {
      // Finde alle Hour-Rows und deren tatsÃ¤chliche HÃ¶hen
      const hourRows = document.querySelectorAll('.mobile-cal-hour-row-grid');
      const timeSlots = document.querySelectorAll('.mobile-cal-time-slot');

      if (hourRows.length === 0 || timeSlots.length === 0) return;

      // Berechne die maximale HÃ¶he fÃ¼r jede Stunde basierend auf den Artist-Spalten
      const hourHeights = {};
      for (let h = 9; h <= 22; h++) {
        hourHeights[h] = 60; // Minimum
      }

      // PrÃ¼fe alle Termine und deren tatsÃ¤chliche HÃ¶hen
      const appointments = document.querySelectorAll('.mobile-cal-appointment');
      appointments.forEach(apt => {
        const top = parseInt(apt.style.top) || 0;
        const height = parseInt(apt.style.height) || 60;
        const startHour = Math.floor(top / 60) + 9;
        const endPixel = top + height;
        const endHour = Math.floor(endPixel / 60) + 9;

        // Alle betroffenen Stunden mÃ¼ssen mindestens 60px haben
        for (let h = startHour; h <= Math.min(endHour, 22); h++) {
          hourHeights[h] = Math.max(hourHeights[h], 60);
        }
      });

      // Setze HÃ¶hen auf Zeit-Slots
      timeSlots.forEach(slot => {
        const hour = parseInt(slot.dataset.hour);
        if (hourHeights[hour]) {
          slot.style.height = hourHeights[hour] + 'px';
        }
      });

      // Setze HÃ¶hen auf Hour-Rows
      hourRows.forEach(row => {
        const hour = parseInt(row.dataset.hour);
        if (hourHeights[hour]) {
          row.style.height = hourHeights[hour] + 'px';
        }
      });

      console.log('ðŸ“… Hour heights synchronized');
    }

    // Wochenleiste rendern mit today/selected Klassen
    function renderMobileCalWeekStrip() {
      const container = document.getElementById('mobileCalWeekStrip');
      if (!container) return;

      const selectedDate = mobileCalState.selectedDate;
      const today = new Date();
      const monday = getMonday(selectedDate);

      const dayNames = ['MO', 'DI', 'MI', 'DO', 'FR', 'SA', 'SO'];

      let html = '';
      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(date.getDate() + i);

        // PrÃ¼fe ob dieser Tag HEUTE ist
        const isToday = date.toDateString() === today.toDateString();
        // PrÃ¼fe ob dieser Tag AUSGEWÃ„HLT ist
        const isSelected = date.toDateString() === selectedDate.toDateString();

        // Klassen zusammenstellen
        let classes = 'mobile-cal-week-day';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';

        html += `
          <div class="${classes}" onclick="selectMobileCalDate('${date.toISOString().split('T')[0]}')">
            <span class="mobile-cal-week-day-name">${dayNames[i]}</span>
            <span class="mobile-cal-week-day-num">${date.getDate()}</span>
          </div>
        `;
      }

      container.innerHTML = html;

      // Heute-Button Styling aktualisieren
      updateCalTodayButtonStyle();
    }

    // Heute-Button Styling fÃ¼r Calendar
    function updateCalTodayButtonStyle() {
      const todayBtn = document.querySelector('.mobile-cal-today-btn');
      if (!todayBtn) return;

      const selectedDate = mobileCalState.selectedDate;
      const today = new Date();

      const isSelectedToday = selectedDate.toDateString() === today.toDateString();

      if (isSelectedToday) {
        // Heute ist ausgewÃ¤hlt - hellgrau
        todayBtn.classList.remove('highlight');
      } else {
        // Anderer Tag ausgewÃ¤hlt - dunkelgrau
        todayBtn.classList.add('highlight');
      }
    }

    // Datum aus Wochenleiste auswÃ¤hlen
    function selectMobileCalDate(dateStr) {
      const [year, month, day] = dateStr.split('-').map(Number);
      mobileCalState.selectedDate = new Date(year, month - 1, day);

      // UI aktualisieren (inkl. Heute-Button Styling)
      renderMobileCalWeekStrip();
      renderMobileCalendarGrid();
      updateMobileCalHeaderDate();
    }

    // Header-Datum aktualisieren (in Top-Navbar, kurzes Format)
    function updateMobileCalHeaderDate() {
      const header = document.getElementById('mobileCalNavDate');
      if (header) {
        header.textContent = mobileCalState.selectedDate.toLocaleDateString('de-DE', {
          weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'
        });
      }
    }

    // Navigation: Vorheriger Tag
    function mobileCalPrevDay() {
      const newDate = new Date(mobileCalState.selectedDate);
      newDate.setDate(newDate.getDate() - 1);
      mobileCalState.selectedDate = newDate;

      // PrÃ¼fen ob Woche gewechselt hat
      const newMonday = getMonday(newDate);
      if (newMonday.getTime() !== getMonday(mobileCalState.currentWeekStart).getTime()) {
        mobileCalState.currentWeekStart = newMonday;
      }

      renderMobileCalWeekStrip();
      renderMobileCalendarGrid();
      updateMobileCalHeaderDate();
    }

    // Navigation: NÃ¤chster Tag
    function mobileCalNextDay() {
      const newDate = new Date(mobileCalState.selectedDate);
      newDate.setDate(newDate.getDate() + 1);
      mobileCalState.selectedDate = newDate;

      const newMonday = getMonday(newDate);
      if (newMonday.getTime() !== getMonday(mobileCalState.currentWeekStart).getTime()) {
        mobileCalState.currentWeekStart = newMonday;
      }

      renderMobileCalWeekStrip();
      renderMobileCalendarGrid();
      updateMobileCalHeaderDate();
    }

    // Navigation: Heute
    function mobileCalToday() {
      mobileCalState.selectedDate = new Date();
      mobileCalState.currentWeekStart = getMonday(new Date());

      renderMobileCalWeekStrip();
      renderMobileCalendarGrid();
      updateMobileCalHeaderDate();
    }

    // Vereinfachte Scroll-Funktion - nur horizontaler Overscroll fÃ¼r Artist-Bereich
    function initMobileCalScrollSync() {
      const artistsScroll = document.getElementById('mobileCalArtistsScroll');

      if (!artistsScroll) return;

      // Nur horizontalen Overscroll verhindern (CSS macht das meiste mit overscroll-behavior-x: contain)
      artistsScroll.addEventListener('scroll', function() {
        if (this.scrollLeft < 0) this.scrollLeft = 0;
        const maxScrollLeft = this.scrollWidth - this.clientWidth;
        if (this.scrollLeft > maxScrollLeft) this.scrollLeft = maxScrollLeft;
      }, { passive: true });

      console.log('ðŸ“… Mobile calendar scroll sync initialized');
    }

    // Global verfÃ¼gbar machen
    window.renderMobileCalendarGrid = renderMobileCalendarGrid;
    window.initMobileCalScrollSync = initMobileCalScrollSync;
    window.renderMobileCalWeekStrip = renderMobileCalWeekStrip;
    window.selectMobileCalDate = selectMobileCalDate;
    window.updateMobileCalHeaderDate = updateMobileCalHeaderDate;
    window.mobileCalPrevDay = mobileCalPrevDay;
    window.mobileCalNextDay = mobileCalNextDay;
    window.mobileCalToday = mobileCalToday;

    // ==========================================
    // END MULTI-ARTIST CALENDAR GRID
    // ==========================================

    async function openMobileEventDetail(apt) {
      console.log('ðŸ“… Opening event detail:', apt);

      const detail = document.getElementById('mobileEventDetail');
      const content = document.getElementById('mobileEventDetailContent');
      const categoryBadge = document.getElementById('mobileEventCategory');

      if (!detail || !content) return;

      // Set category badge
      const category = (apt.category || apt.type || 'internal').toLowerCase().replace(/\s+/g, '_');
      const categoryDisplay = apt.category || apt.type || 'Internal';
      categoryBadge.textContent = categoryDisplay;
      categoryBadge.className = 'mobile-event-category-badge ' + category;

      // Get customer data if available
      let customer = apt.customer || null;
      if (!customer && apt.customer_id) {
        const customers = CentralDataManager.getCustomers ? CentralDataManager.getCustomers() : [];
        customer = customers.find(c => c.id === apt.customer_id);
      }

      // Get artist data
      let artist = apt.artist || null;
      if (!artist && apt.artist_id) {
        const artists = CentralDataManager.getArtists ? CentralDataManager.getArtists() : [];
        artist = artists.find(a => a.id === apt.artist_id);
      }

      // Format date/time
      const formatDateTime = (dateStr, timeStr) => {
        if (!dateStr) return 'Nicht angegeben';
        const date = new Date(dateStr);
        const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
        const monthNames = ['Jan', 'Feb', 'MÃ¤r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
        return `${dayNames[date.getDay()]}., ${date.getDate()}. ${monthNames[date.getMonth()]} ${date.getFullYear()}${timeStr ? ', ' + timeStr : ''}`;
      };

      const startTime = apt.start_time || apt.time_start || (apt.start?.split('T')[1]?.substring(0,5)) || '';
      const endTime = apt.end_time || apt.time_end || (apt.end?.split('T')[1]?.substring(0,5)) || '';
      const dateStr = apt.date || apt.appointment_date || apt.start?.split('T')[0] || '';

      // Build content
      content.innerHTML = `
        <!-- Customer Information -->
        <div class="mobile-event-section">
          <div class="mobile-event-section-title">Customer Information</div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Vorname</span>
            <span class="mobile-event-value ${!customer?.first_name ? 'empty' : ''}">${customer?.first_name || apt.customer_name?.split(' ')[0] || 'Nicht angegeben'}</span>
          </div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Nachname</span>
            <span class="mobile-event-value ${!customer?.last_name ? 'empty' : ''}">${customer?.last_name || apt.customer_name?.split(' ').slice(1).join(' ') || 'Nicht angegeben'}</span>
          </div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Email</span>
            <span class="mobile-event-value ${!customer?.email ? 'empty' : ''}">${customer?.email || 'Nicht angegeben'}</span>
          </div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Phone</span>
            <span class="mobile-event-value ${!customer?.phone ? 'empty' : ''}">${customer?.phone || 'Nicht angegeben'}</span>
          </div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Instagram</span>
            <span class="mobile-event-value ${!customer?.instagram ? 'empty' : ''}">${customer?.instagram || 'Nicht angegeben'}</span>
          </div>
        </div>

        <!-- Request Details -->
        <div class="mobile-event-section">
          <div class="mobile-event-section-title">Request Details</div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Placement</span>
            <span class="mobile-event-value ${!apt.placement ? 'empty' : ''}">${apt.placement || 'Nicht angegeben'}</span>
          </div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Size</span>
            <span class="mobile-event-value ${!apt.size ? 'empty' : ''}">${apt.size || 'Nicht angegeben'}</span>
          </div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Style</span>
            <span class="mobile-event-value ${!apt.style ? 'empty' : ''}">${apt.style || 'Nicht angegeben'}</span>
          </div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Colorway</span>
            <span class="mobile-event-value ${!apt.colorway ? 'empty' : ''}">${apt.colorway || 'Nicht angegeben'}</span>
          </div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Booking Type</span>
            <span class="mobile-event-value">${categoryDisplay}</span>
          </div>
        </div>

        <!-- Appointment Details -->
        <div class="mobile-event-section">
          <div class="mobile-event-section-title">Appointment Details</div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Artist</span>
            <span class="mobile-event-value ${!artist?.name ? 'empty' : ''}">${artist?.name || apt.artist_name || 'Nicht angegeben'}</span>
          </div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Start</span>
            <span class="mobile-event-value">${formatDateTime(dateStr, startTime)}</span>
          </div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">End</span>
            <span class="mobile-event-value">${endTime || 'Nicht angegeben'}</span>
          </div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Creator</span>
            <span class="mobile-event-value ${!apt.created_by_name ? 'empty' : ''}">${apt.created_by_name || 'Nicht angegeben'}</span>
          </div>
          <div class="mobile-event-field">
            <span class="mobile-event-label">Work Process</span>
            <span class="mobile-event-value">${categoryDisplay}</span>
          </div>
        </div>
      `;

      detail.classList.add('active');
    }

    function closeMobileEventDetail() {
      document.getElementById('mobileEventDetail')?.classList.remove('active');
    }

    window.openMobileEventDetail = openMobileEventDetail;
    window.closeMobileEventDetail = closeMobileEventDetail;

    // Keep old function for backwards compatibility
    function openMobileCalModal(apt) {
      openMobileEventDetail(apt);
    }

    function closeMobileCalModal() {
      closeMobileEventDetail();
    }

    // Mobile debug stub (debug popup removed)
    function mobileDebug(message, data = null) {
      // Silent - debug popup removed
    }

    // ==========================================
    // MOBILE DIENSTPLAN
    // ==========================================
    const mobileDpState = {
      currentWeekStart: getMonday(new Date())
    };

    function initMobileDienstplan() {
      console.log('ðŸ“‹ Initializing mobile dienstplan...');

      // REMOVE old listeners by cloning elements
      const prevBtn = document.getElementById('mobileDpPrevWeek');
      const nextBtn = document.getElementById('mobileDpNextWeek');
      const todayBtn = document.getElementById('mobileDpToday');

      // Clone and replace to remove all event listeners
      if (prevBtn) {
        const newPrev = prevBtn.cloneNode(true);
        prevBtn.parentNode.replaceChild(newPrev, prevBtn);
        newPrev.addEventListener('click', () => {
          const newDate = new Date(mobileDpState.currentWeekStart);
          newDate.setDate(newDate.getDate() - 7);
          mobileDpState.currentWeekStart = newDate;
          loadMobileDienstplanData();
          updateMobileHeaderTitle('dienstplan');
          updateDpTodayButtonStyle();
        });
      }

      if (nextBtn) {
        const newNext = nextBtn.cloneNode(true);
        nextBtn.parentNode.replaceChild(newNext, nextBtn);
        newNext.addEventListener('click', () => {
          const newDate = new Date(mobileDpState.currentWeekStart);
          newDate.setDate(newDate.getDate() + 7);
          mobileDpState.currentWeekStart = newDate;
          loadMobileDienstplanData();
          updateMobileHeaderTitle('dienstplan');
          updateDpTodayButtonStyle();
        });
      }

      if (todayBtn) {
        const newToday = todayBtn.cloneNode(true);
        todayBtn.parentNode.replaceChild(newToday, todayBtn);
        newToday.addEventListener('click', () => {
          mobileDpState.currentWeekStart = getMonday(new Date());
          loadMobileDienstplanData();
          updateMobileHeaderTitle('dienstplan');
          updateDpTodayButtonStyle();
        });
      }

      // Initial Heute-Button Styling
      updateDpTodayButtonStyle();

      // Load initial data
      loadMobileDienstplanData();
    }

    // Heute-Button Styling fÃ¼r Dienstplan
    function updateDpTodayButtonStyle() {
      const todayBtn = document.getElementById('mobileDpToday');
      if (!todayBtn) return;

      const today = new Date();
      const currentWeekMonday = getMonday(today);
      const displayedWeekMonday = mobileDpState.currentWeekStart;

      // PrÃ¼fe ob die angezeigte Woche die aktuelle Woche ist
      const isCurrentWeek = currentWeekMonday.toDateString() === displayedWeekMonday.toDateString();

      if (isCurrentWeek) {
        // Aktuelle Woche wird angezeigt - hellgrau
        todayBtn.classList.remove('highlight');
      } else {
        // Andere Woche wird angezeigt - dunkelgrau
        todayBtn.classList.add('highlight');
      }
    }

    async function loadMobileDienstplanData() {
      mobileDebug('============ DIENSTPLAN DEBUG ============');

      const container = document.getElementById('mobileDpDays');
      if (!container) {
        return;
      }

      // Get user
      const user = window.currentUser || currentUser;
      mobileDebug('User', { name: user?.username, id: user?.id, email: user?.email });

      if (!user) {
        mobileDebug('No user - showing login message');
        container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--macos-text-secondary);">Bitte anmelden</div>';
        return;
      }

      // Calculate date range
      const weekEnd = new Date(mobileDpState.currentWeekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      const startDate = mobileDpState.currentWeekStart.toISOString().split('T')[0];
      const endDate = weekEnd.toISOString().split('T')[0];

      // Update label
      const label = document.getElementById('mobileDpWeekLabel');
      if (label) {
        const fmt = d => `${d.getDate()}.${d.getMonth() + 1}.`;
        label.textContent = `Mo ${fmt(mobileDpState.currentWeekStart)} - So ${fmt(weekEnd)}`;
      }

      // Get ALL dienstplan data
      let allShifts = [];
      if (typeof CentralDataManager !== 'undefined') {
        if (CentralDataManager.data?.dienstplan) {
          allShifts = CentralDataManager.data.dienstplan;
        } else if (typeof dienstplanCache !== 'undefined') {
          allShifts = dienstplanCache;
        }
      }
      mobileDebug('Total shifts in system', allShifts.length);

      // Show ACTUAL date values from shifts
      if (allShifts.length > 0) {
        const sampleShift = allShifts[0];
        mobileDebug('Sample shift RAW dates', {
          start_date: sampleShift.start_date,
          end_date: sampleShift.end_date,
          start_date_type: typeof sampleShift.start_date
        });

        // Try to find ANY shift in December 2025
        const decemberShifts = allShifts.filter(s => {
          const sd = (s.start_date || '').toString();
          return sd.includes('2025-12');
        });
        mobileDebug('Shifts in December 2025', decemberShifts.length);

        if (decemberShifts.length > 0) {
          mobileDebug('First December shift date', decemberShifts[0].start_date);
        }
      }

      // Show sample shift structure
      if (allShifts.length > 0) {
        mobileDebug('Sample shift keys', Object.keys(allShifts[0]));
        mobileDebug('Sample shift', {
          artist_id: allShifts[0].artist_id,
          user_id: allShifts[0].user_id,
          profile_id: allShifts[0].profile_id,
          start_date: allShifts[0].start_date
        });
      }

      // Get artists
      let allArtists = [];
      if (typeof CentralDataManager !== 'undefined' && CentralDataManager.getArtists) {
        allArtists = CentralDataManager.getArtists() || [];
      }
      mobileDebug('Total artists', allArtists.length);

      // Find artist for current user - try multiple methods
      let matchingArtist = null;

      // Method 1: Match by email
      matchingArtist = allArtists.find(a =>
        a.email && user.email &&
        a.email.toLowerCase().trim() === user.email.toLowerCase().trim()
      );

      if (matchingArtist) {
        mobileDebug('Found artist by email', { name: matchingArtist.name, id: matchingArtist.id });
      } else {
        // Method 2: Match by name
        matchingArtist = allArtists.find(a =>
          a.name && user.username &&
          a.name.toLowerCase().trim() === user.username.toLowerCase().trim()
        );
        if (matchingArtist) {
          mobileDebug('Found artist by name', { name: matchingArtist.name, id: matchingArtist.id });
        }
      }

      if (!matchingArtist) {
        mobileDebug('No matching artist found!');
        mobileDebug('User email', user.email);
        mobileDebug('User name', user.username);
        mobileDebug('Sample artist emails', allArtists.slice(0, 5).map(a => a.email));
      }

      // Find shifts for the matching artist (if found)
      if (matchingArtist && allShifts.length > 0) {
        const artistShifts = allShifts.filter(s => s.artist_id === matchingArtist.id);
        mobileDebug('Total shifts for artist ' + matchingArtist.name, artistShifts.length);

        if (artistShifts.length > 0) {
          mobileDebug('Artist shift dates (first 5)', artistShifts.slice(0,5).map(s => s.start_date));
        }
      }

      // Filter by date range - with flexible date parsing
      mobileDebug('Date range', { start: startDate, end: endDate });

      let shifts = allShifts.filter(s => {
        const rawDate = s.start_date || s.date || '';

        // Handle various date formats
        let dateOnly;
        if (typeof rawDate === 'string') {
          // "2025-12-15" or "2025-12-15T00:00:00" or "2025-12-15T00:00:00.000Z"
          dateOnly = rawDate.split('T')[0];
        } else if (rawDate instanceof Date) {
          dateOnly = rawDate.toISOString().split('T')[0];
        } else {
          return false;
        }

        return dateOnly >= startDate && dateOnly <= endDate;
      });
      mobileDebug('Shifts in date range (after flexible parse)', shifts.length);

      // Now filter by artist
      if (matchingArtist && shifts.length > 0) {
        // Check what ID field the shifts use
        const sampleShift = shifts[0];
        mobileDebug('Shift ID fields', {
          artist_id: sampleShift.artist_id,
          user_id: sampleShift.user_id
        });

        const beforeCount = shifts.length;

        // Try matching on multiple possible ID fields
        shifts = shifts.filter(s =>
          s.artist_id === matchingArtist.id ||
          s.user_id === matchingArtist.id ||
          s.artist?.id === matchingArtist.id ||
          s.artist_id === user.id ||
          s.user_id === user.id
        );

        mobileDebug('After artist filter', { now: shifts.length, was: beforeCount });

        // If still 0, show what artist_ids exist
        if (shifts.length === 0) {
          const uniqueIds = [...new Set(allShifts.filter(s => {
            const sd = (s.start_date || '').split('T')[0];
            return sd >= startDate && sd <= endDate;
          }).map(s => s.artist_id))];
          mobileDebug('Artist IDs in this week', uniqueIds.slice(0, 10));
          mobileDebug('Looking for', { artistId: matchingArtist.id, userId: user.id });
        }
      }

      // TEMPORARY DEBUG: Show all shifts for this week, not filtered by artist
      if (shifts.length === 0) {
        mobileDebug('ðŸ”´ NO SHIFTS FOUND - Showing unfiltered data for debugging');

        // Re-filter without artist constraint
        shifts = allShifts.filter(s => {
          const rawDate = s.start_date || s.date || '';
          const dateOnly = rawDate.toString().split('T')[0];
          return dateOnly >= startDate && dateOnly <= endDate;
        });

        mobileDebug('Unfiltered shifts in date range', shifts.length);

        if (shifts.length > 0) {
          // Show who these shifts belong to
          const artistIds = [...new Set(shifts.map(s => s.artist_id))];
          mobileDebug('Artist IDs with shifts this week', artistIds.slice(0, 10));

          // Get artist names
          const artistNames = artistIds.slice(0, 5).map(id => {
            const a = allArtists.find(art => art.id === id);
            return a ? a.name : id;
          });
          mobileDebug('Artists with shifts', artistNames);
        }
      }

      // Count shifts by type
      if (shifts.length > 0) {
        const typeCounts = {};
        shifts.forEach(s => {
          const type = s.state || s.role || 'unknown';
          typeCounts[type] = (typeCounts[type] || 0) + 1;
        });
        mobileDebug('Shift type counts', typeCounts);

        // Log detailed shift types for debugging
        const shiftTypes = shifts.map(s => ({
          state: s.state,
          role: s.role,
          type: s.type,
          category: s.category
        }));
        mobileDebug('Shift types found', shiftTypes.slice(0, 5));
      }

      mobileDebug('============ END DEBUG ============');

      // Render days
      const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
      container.innerHTML = '';

      // SVG Icons for shift types (desktop style)
      const shiftIcons = {
        available: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
        vacation: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`,
        sick: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`,
        business: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>`,
        guestspot: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
        training: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`,
        convention: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
        homeoffice: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
        other: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
        default: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`
      };

      for (let i = 0; i < 7; i++) {
        const date = new Date(mobileDpState.currentWeekStart);
        date.setDate(date.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];

        const dayShifts = shifts.filter(s => {
          const sd = (s.start_date || '').toString().split('T')[0];
          return sd === dateStr;
        });

        // Determine card background color
        let cardBgColor = 'white';
        let cardBorderColor = 'transparent';
        let titleColor = '#1a1a1a';

        // If exactly one shift, use its color for the whole card
        if (dayShifts.length === 1) {
          const shiftType = (dayShifts[0].state || dayShifts[0].role || '').toLowerCase();

          if (shiftType.includes('available') || shiftType.includes('approved')) {
            cardBgColor = '#E8F5E9'; cardBorderColor = '#4CAF50'; titleColor = '#2E7D32';
          } else if (shiftType.includes('vacation') || shiftType.includes('urlaub')) {
            cardBgColor = '#FFF3E0'; cardBorderColor = '#FF9800'; titleColor = '#E65100';
          } else if (shiftType.includes('sick') || shiftType.includes('krank')) {
            cardBgColor = '#FFEBEE'; cardBorderColor = '#F44336'; titleColor = '#C62828';
          } else if (shiftType.includes('business')) {
            cardBgColor = '#E3F2FD'; cardBorderColor = '#2196F3'; titleColor = '#1565C0';
          } else if (shiftType.includes('guest')) {
            cardBgColor = '#F3E5F5'; cardBorderColor = '#9C27B0'; titleColor = '#6A1B9A';
          } else if (shiftType.includes('training')) {
            cardBgColor = '#E0F7FA'; cardBorderColor = '#00BCD4'; titleColor = '#00838F';
          } else if (shiftType.includes('convention')) {
            cardBgColor = '#FCE4EC'; cardBorderColor = '#E91E63'; titleColor = '#AD1457';
          } else if (shiftType.includes('home') || shiftType.includes('remote')) {
            cardBgColor = '#ECEFF1'; cardBorderColor = '#607D8B'; titleColor = '#37474F';
          } else if (shiftType.includes('other')) {
            cardBgColor = '#FFF8E1'; cardBorderColor = '#FFC107'; titleColor = '#FF8F00';
          } else if (shiftType.includes('frei') || shiftType.includes('off')) {
            cardBgColor = '#F5F5F5'; cardBorderColor = '#9E9E9E'; titleColor = '#757575';
          }
        }

        const card = document.createElement('div');
        card.className = 'mobile-dp-day-card';
        card.style.cssText = `
          background: ${cardBgColor};
          border-radius: 0;
          padding: 16px;
          margin-bottom: 12px;
          border: 1px solid ${cardBorderColor !== 'transparent' ? cardBorderColor : '#e0e0e0'};
        `;

        // Build content
        let content = '';

        if (dayShifts.length === 0) {
          // Empty state
          content = `
            <div style="
              background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
              border-radius: 0;
              padding: 24px 16px;
              text-align: center;
            ">
              <div style="font-weight:500;color:#6c757d;font-size:14px;">Keine EintrÃ¤ge</div>
              <div style="font-size:12px;color:#adb5bd;margin-top:4px;">Am ${dayNames[i]} ${date.getDate()}.${date.getMonth()+1}.</div>
            </div>
          `;
        } else if (dayShifts.length === 1) {
          // Single shift - show compact version (card is already colored)
          const s = dayShifts[0];
          const shiftType = s.state || s.role || 'Schicht';
          const startTime = s.working_start || '';
          const endTime = s.working_end || '';
          const locationName = s.location?.name || '';

          // Get icon
          const typeLower = shiftType.toLowerCase();
          let icon = shiftIcons.default;
          if (typeLower.includes('available') || typeLower.includes('approved')) icon = shiftIcons.available;
          else if (typeLower.includes('vacation') || typeLower.includes('urlaub')) icon = shiftIcons.vacation;
          else if (typeLower.includes('sick') || typeLower.includes('krank')) icon = shiftIcons.sick;
          else if (typeLower.includes('business')) icon = shiftIcons.business;
          else if (typeLower.includes('guest')) icon = shiftIcons.guestspot;
          else if (typeLower.includes('training')) icon = shiftIcons.training;
          else if (typeLower.includes('convention')) icon = shiftIcons.convention;
          else if (typeLower.includes('home') || typeLower.includes('remote')) icon = shiftIcons.homeoffice;
          else if (typeLower.includes('other')) icon = shiftIcons.other;

          let timeDisplay = '';
          if (startTime || endTime) {
            timeDisplay = `${startTime}${endTime ? ' - ' + endTime : ''}`;
          }

          // Get artist name from shift
          const artistName = s.artist?.name || s.artist_name || '';

          content = `
            <div style="display:flex;align-items:center;gap:12px;padding-top:8px;">
              <div style="color:${titleColor};flex-shrink:0;">
                ${icon}
              </div>
              <div style="flex:1;min-width:0;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <span style="font-weight:600;font-size:15px;color:${titleColor};">${shiftType}</span>
                  ${artistName ? `<span style="font-size:12px;font-weight:500;color:${titleColor};opacity:0.7;">${artistName}</span>` : ''}
                </div>
                ${timeDisplay ? `<div style="font-size:13px;color:${titleColor};opacity:0.8;margin-top:2px;">${timeDisplay}</div>` : ''}
                ${locationName ? `<div style="font-size:12px;color:${titleColor};opacity:0.7;margin-top:2px;">${locationName}</div>` : ''}
              </div>
            </div>
          `;
        } else {
          // Multiple shifts - render each with its own color
          content = dayShifts.map(s => {
            const shiftType = s.state || s.role || 'Schicht';
            const startTime = s.working_start || '';
            const endTime = s.working_end || '';
            const locationName = s.location?.name || '';

            const typeLower = shiftType.toLowerCase();
            let icon = shiftIcons.default;
            let bgColor = '#E3F2FD';
            let textColor = '#1565C0';
            let borderColor = '#2196F3';

            if (typeLower.includes('available') || typeLower.includes('approved')) {
              icon = shiftIcons.available; bgColor = '#E8F5E9'; textColor = '#2E7D32'; borderColor = '#4CAF50';
            } else if (typeLower.includes('vacation') || typeLower.includes('urlaub')) {
              icon = shiftIcons.vacation; bgColor = '#FFF3E0'; textColor = '#E65100'; borderColor = '#FF9800';
            } else if (typeLower.includes('sick') || typeLower.includes('krank')) {
              icon = shiftIcons.sick; bgColor = '#FFEBEE'; textColor = '#C62828'; borderColor = '#F44336';
            } else if (typeLower.includes('business')) {
              icon = shiftIcons.business; bgColor = '#E3F2FD'; textColor = '#1565C0'; borderColor = '#2196F3';
            } else if (typeLower.includes('guest')) {
              icon = shiftIcons.guestspot; bgColor = '#F3E5F5'; textColor = '#6A1B9A'; borderColor = '#9C27B0';
            } else if (typeLower.includes('training')) {
              icon = shiftIcons.training; bgColor = '#E0F7FA'; textColor = '#00838F'; borderColor = '#00BCD4';
            } else if (typeLower.includes('convention')) {
              icon = shiftIcons.convention; bgColor = '#FCE4EC'; textColor = '#AD1457'; borderColor = '#E91E63';
            } else if (typeLower.includes('home') || typeLower.includes('remote')) {
              icon = shiftIcons.homeoffice; bgColor = '#ECEFF1'; textColor = '#37474F'; borderColor = '#607D8B';
            } else if (typeLower.includes('other')) {
              icon = shiftIcons.other; bgColor = '#FFF8E1'; textColor = '#FF8F00'; borderColor = '#FFC107';
            }

            let timeDisplay = '';
            if (startTime || endTime) {
              timeDisplay = `${startTime}${endTime ? ' - ' + endTime : ''}`;
            }

            // Get artist name from shift
            const artistName = s.artist?.name || s.artist_name || '';

            return `
              <div style="background:${bgColor};border-radius:0;padding:14px 16px;margin-top:10px;border:1px solid ${borderColor};">
                <div style="display:flex;align-items:flex-start;gap:12px;">
                  <div style="color:${textColor};flex-shrink:0;margin-top:2px;">${icon}</div>
                  <div style="flex:1;min-width:0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                      <span style="font-weight:600;font-size:15px;color:${textColor};">${shiftType}</span>
                      ${artistName ? `<span style="font-size:12px;font-weight:500;color:${textColor};opacity:0.7;">${artistName}</span>` : ''}
                    </div>
                    ${timeDisplay ? `<div style="font-size:13px;color:${textColor};opacity:0.8;margin-top:4px;">${timeDisplay}</div>` : ''}
                    ${locationName ? `<div style="font-size:12px;color:${textColor};opacity:0.7;margin-top:3px;">${locationName}</div>` : ''}
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }

        card.innerHTML = `
          <div style="font-weight:700;font-size:15px;color:${titleColor};padding-bottom:8px;border-bottom:1px solid rgba(0,0,0,0.08);">
            ${dayNames[i]} ${date.getDate()}.${date.getMonth()+1}.
          </div>
          ${content}
        `;

        container.appendChild(card);
      }
    }

    // ==========================================
    // MOBILE DIENSTPLAN MONTH VIEW
    // ==========================================
    function toggleMobileDpMonthView() {
      const view = document.getElementById('mobileDpMonthView');
      if (view) {
        view.classList.add('active');
        renderMobileDpMonthView();
      }
    }

    function closeMobileDpMonthView() {
      document.getElementById('mobileDpMonthView')?.classList.remove('active');
    }

    function renderMobileDpMonthView() {
      const container = document.getElementById('mobileDpMonthsScroll');
      if (!container) return;

      // Get all shifts
      let allShifts = [];
      if (typeof CentralDataManager !== 'undefined' && CentralDataManager.data?.dienstplan) {
        allShifts = CentralDataManager.data.dienstplan || [];
      }

      // Get artists for name lookup
      let allArtists = [];
      if (typeof CentralDataManager !== 'undefined' && CentralDataManager.getArtists) {
        allArtists = CentralDataManager.getArtists() || [];
      }

      // ========================================
      // KRITISCH: ARTIST FILTER ANWENDEN
      // ========================================
      allShifts = filterShiftsByArtist(allShifts);
      console.log('ðŸ“… Dienstplan Monat - Gefilterte Shifts:', allShifts.length);

      // Render 12 months: current month + 11 future months
      const today = new Date();
      const months = [];

      for (let offset = 0; offset <= 11; offset++) {
        const monthDate = new Date(today.getFullYear(), today.getMonth() + offset, 1);
        months.push({
          month: monthDate.getMonth(),
          year: monthDate.getFullYear()
        });
      }

      container.innerHTML = months.map(m => renderSingleDpMonth(m.month, m.year, allShifts, allArtists)).join('');

      // Current month is now at index 0 - scroll to top
      setTimeout(() => {
        container.scrollTop = 0;
      }, 100);
    }

    function renderSingleDpMonth(month, year, allShifts, allArtists) {
      const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni',
                          'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
      const dayLabels = ['M', 'D', 'M', 'D', 'F', 'S', 'S'];

      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();

      // Get day of week for first day (0 = Sunday, convert to Monday = 0)
      let startDay = firstDay.getDay() - 1;
      if (startDay < 0) startDay = 6;

      // Build days array with padding
      const days = [];

      // Previous month padding - leere Platzhalter fÃ¼r Grid-Alignment (KEINE Tageszahlen)
      for (let i = 0; i < startDay; i++) {
        days.push({ day: '', month: null, year: null, otherMonth: true, isEmpty: true });
      }

      // Current month days - NUR diese werden angezeigt
      for (let d = 1; d <= daysInMonth; d++) {
        days.push({ day: d, month, year, otherMonth: false, isEmpty: false });
      }

      // Next month padding - REMOVED: month ends at last day, no padding cells

      // Get today for highlighting
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

      // Render days
      const daysHtml = days.map((d, idx) => {
        // Unsichtbare Platzhalter-Zellen fÃ¼r Grid-Alignment
        if (d.isEmpty) {
          return `<div style="min-height:60px;visibility:hidden;"></div>`;
        }

        const actualMonth = d.month < 0 ? 11 : (d.month > 11 ? 0 : d.month);
        const actualYear = d.month < 0 ? year - 1 : (d.month > 11 ? year + 1 : year);
        const dateStr = `${actualYear}-${String(actualMonth + 1).padStart(2, '0')}-${String(d.day).padStart(2, '0')}`;

        const isToday = dateStr === todayStr;
        const isWeekend = idx % 7 >= 5;

        // ========================================
        // SHIFTS FOR THIS DAY - Only for current month
        // ========================================
        let eventsHtml = '';
        let moreHtml = '';

        if (!d.otherMonth) {
          // Get shifts for this day
          const dayShifts = allShifts.filter(s => {
            const sd = (s.start_date || s.date || '').toString().split('T')[0];
            return sd === dateStr;
          });

          // Render mini events (max 4)
          eventsHtml = dayShifts.slice(0, 4).map(s => {
            const type = (s.state || s.role || 'other').toLowerCase();
            let typeClass = 'other';
            if (type.includes('available') || type.includes('approved')) typeClass = 'available';
            else if (type.includes('vacation') || type.includes('urlaub')) typeClass = 'vacation';
            else if (type.includes('sick') || type.includes('krank')) typeClass = 'sick';
            else if (type.includes('training')) typeClass = 'training';
            else if (type.includes('home')) typeClass = 'homeoffice';
            else if (type.includes('guest')) typeClass = 'guestspot';
            else if (type.includes('business')) typeClass = 'business';
            else if (type.includes('convention')) typeClass = 'convention';

            const artistName = s.artist?.name || '';
            const displayText = artistName ? artistName.substring(0, 6) : (s.state || 'Event').substring(0, 6);

            return `<div class="mobile-dp-mini-event ${typeClass}">${displayText}</div>`;
          }).join('');

          const moreCount = dayShifts.length - 4;
          moreHtml = moreCount > 0 ? `<div class="mobile-dp-more-events">+${moreCount}</div>` : '';
        }
        // ========================================

        return `
          <div class="mobile-dp-day-cell ${d.otherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''}"
               onclick="${d.otherMonth ? '' : `selectDayFromMonthView('${dateStr}')`}">
            <div class="mobile-dp-day-number">${d.day}</div>
            <div class="mobile-dp-day-events">
              ${eventsHtml}
              ${moreHtml}
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="mobile-dp-month-container">
          <div class="mobile-dp-month-name">${monthNames[month]} ${year}</div>
          <div class="mobile-dp-weekday-header">
            ${dayLabels.map(l => `<div class="mobile-dp-weekday-label">${l}</div>`).join('')}
          </div>
          <div class="mobile-dp-month-grid">
            ${daysHtml}
          </div>
        </div>
      `;
    }

    function selectDayFromMonthView(dateStr) {
      // Parse the date
      const [year, month, day] = dateStr.split('-').map(Number);
      const selectedDate = new Date(year, month - 1, day);

      // Get Monday of that week
      const monday = getMonday(selectedDate);

      // Update state
      mobileDpState.currentWeekStart = monday;

      // Close month view
      closeMobileDpMonthView();

      // Reload week view
      loadMobileDienstplanData();
      updateMobileHeaderTitle('dienstplan');
    }

    // Expose month view functions
    window.toggleMobileDpMonthView = toggleMobileDpMonthView;
    window.closeMobileDpMonthView = closeMobileDpMonthView;
    window.selectDayFromMonthView = selectDayFromMonthView;

    // ==========================================
    // MOBILE CALENDAR MONTH VIEW
    // ==========================================
    function toggleMobileCalMonthView() {
      const view = document.getElementById('mobileCalMonthView');
      if (!view) return;

      if (view.classList.contains('active')) {
        // SchlieÃŸen mit Animation
        view.classList.add('closing');
        setTimeout(() => {
          view.classList.remove('active', 'closing');
          view.style.display = 'none';
        }, 300);
      } else {
        // Sofortiges Ã–ffnen
        view.style.display = 'flex';
        void view.offsetWidth; // Force reflow fÃ¼r Animation
        view.classList.add('active');

        // NUR rendern wenn Container leer ist (preload sollte bereits geladen haben)
        const container = document.getElementById('mobileCalMonthsScroll');
        if (!container || !container.querySelector('.mobile-dp-month-container')) {
          renderMobileCalMonthView();
        }
      }
    }

    function closeMobileCalMonthView() {
      const view = document.getElementById('mobileCalMonthView');
      if (!view) return;

      view.classList.add('closing');
      setTimeout(() => {
        view.classList.remove('active', 'closing');
        view.style.display = 'none';
      }, 300);
    }

    // Preload Monatsansicht bei App-Start fÃ¼r schnelleres Ã–ffnen
    function preloadMobileCalMonthView() {
      // Nur auf Mobile ausfÃ¼hren
      if (window.innerWidth > 768) return;

      console.log('ðŸ“… Starting month view preload...');

      // Warte bis CentralDataManager bereit ist
      const checkReady = setInterval(() => {
        if (typeof CentralDataManager !== 'undefined' &&
            CentralDataManager.isReady &&
            CentralDataManager.isReady()) {
          clearInterval(checkReady);

          console.log('ðŸ“… CentralDataManager ready, pre-rendering month view...');

          // Render die Monatsansicht im Hintergrund (bleibt unsichtbar)
          const container = document.getElementById('mobileCalMonthsScroll');
          if (container && !container.querySelector('.mobile-dp-month-container')) {
            renderMobileCalMonthView();
            console.log('âœ… Month view pre-rendered');
          } else {
            console.log('ðŸ“… Month view already rendered');
          }
        }
      }, 500);

      // Timeout nach 10 Sekunden
      setTimeout(() => {
        clearInterval(checkReady);
        // Trotzdem versuchen zu rendern falls CentralDataManager nie ready wird
        const container = document.getElementById('mobileCalMonthsScroll');
        if (container && !container.querySelector('.mobile-dp-month-container')) {
          renderMobileCalMonthView();
          console.log('âœ… Month view pre-rendered (timeout fallback)');
        }
      }, 10000);
    }

    // Expose preload function
    window.preloadMobileCalMonthView = preloadMobileCalMonthView;

    function renderMobileCalMonthView() {
      const container = document.getElementById('mobileCalMonthsScroll');
      if (!container) return;

      // ========================================
      // APPOINTMENTS LADEN - OHNE FILTER
      // ========================================
      let allAppointments = [];

      // Method 1: CentralDataManager
      if (typeof CentralDataManager !== 'undefined') {
        if (typeof CentralDataManager.getAppointments === 'function') {
          allAppointments = CentralDataManager.getAppointments() || [];
        } else if (CentralDataManager.data?.appointments) {
          allAppointments = CentralDataManager.data.appointments || [];
        }
      }

      // Method 2: Fallback to global variable
      if (allAppointments.length === 0 && typeof window.allAppointments !== 'undefined') {
        allAppointments = window.allAppointments || [];
      }

      console.log('ðŸ“… MonatsÃ¼bersicht - Alle Appointments:', allAppointments.length);

      // Artists laden fÃ¼r Namen-Lookup
      let allArtists = [];
      if (typeof CentralDataManager !== 'undefined' && CentralDataManager.getArtists) {
        allArtists = CentralDataManager.getArtists() || [];
      }

      // KEIN Artist-Filter - zeige ALLE Termine

      // Render months from January 2024 to December 2026 (36 months)
      const months = [];
      const startYear = 2024;
      const startMonth = 0; // Januar
      const endYear = 2026;
      const endMonth = 11; // Dezember

      for (let year = startYear; year <= endYear; year++) {
        const monthStart = (year === startYear) ? startMonth : 0;
        const monthEnd = (year === endYear) ? endMonth : 11;
        for (let month = monthStart; month <= monthEnd; month++) {
          months.push({ month, year });
        }
      }

      container.innerHTML = months.map(m => renderSingleCalMonth(m.month, m.year, allAppointments, allArtists)).join('');

      // Scroll to current month
      const today = new Date();
      const currentMonthIndex = months.findIndex(m => m.year === today.getFullYear() && m.month === today.getMonth());
      setTimeout(() => {
        const monthElements = container.querySelectorAll('.mobile-dp-month-container');
        if (monthElements[currentMonthIndex]) {
          monthElements[currentMonthIndex].scrollIntoView({ behavior: 'auto', block: 'start' });
        }
      }, 100);
    }

    function renderSingleCalMonth(month, year, allAppointments, allArtists) {
      const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni',
                          'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
      const dayLabels = ['M', 'D', 'M', 'D', 'F', 'S', 'S'];

      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();

      // Get day of week for first day (0 = Sunday, convert to Monday = 0)
      let startDay = firstDay.getDay() - 1;
      if (startDay < 0) startDay = 6;

      // Build days array with padding
      const days = [];

      // Previous month padding - leere Platzhalter fÃ¼r Grid-Alignment
      for (let i = 0; i < startDay; i++) {
        days.push({ day: '', month: null, year: null, otherMonth: true, isEmpty: true });
      }

      // Current month days
      for (let d = 1; d <= daysInMonth; d++) {
        days.push({ day: d, month, year, otherMonth: false, isEmpty: false });
      }

      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

      // Category colors
      const categoryColors = {
        consultation: { bg: '#FFEBEE', color: '#C62828' },
        new_tattoo: { bg: '#E8F5E9', color: '#2E7D32' },
        continuing_tattoo: { bg: '#FFF3E0', color: '#E65100' },
        touch_up: { bg: '#F3E5F5', color: '#6A1B9A' },
        selfbooking: { bg: '#FFFDE7', color: '#F57F17' },
        wannado: { bg: '#FCE4EC', color: '#AD1457' },
        internal: { bg: '#ECEFF1', color: '#37474F' },
        default: { bg: '#E3F2FD', color: '#1565C0' }
      };

      // Render day cells
      const dayCells = days.map((d, idx) => {
        // Unsichtbare Platzhalter-Zellen fÃ¼r Grid-Alignment
        if (d.isEmpty) {
          return `<div style="min-height:60px;visibility:hidden;"></div>`;
        }

        const dateStr = `${d.year}-${String(d.month + 1).padStart(2, '0')}-${String(d.day).padStart(2, '0')}`;
        const isToday = dateStr === todayStr;
        const isWeekend = idx % 7 >= 5;

        // Appointments fÃ¼r diesen Tag finden
        let eventsHtml = '';
        let moreHtml = '';

        if (!d.otherMonth) {
          const dayAppts = allAppointments.filter(apt => {
            const aptDate = (
              apt.date ||
              apt.appointment_date ||
              apt.start ||
              apt.start_time ||
              apt.scheduled_date ||
              ''
            ).toString().split('T')[0];
            return aptDate === dateStr;
          });

          // Render mini events (max 3) mit Artist-Namen
          eventsHtml = dayAppts.slice(0, 3).map(apt => {
            // Artist-Name finden
            let artistName = '';
            if (apt.artist_id && allArtists) {
              const artist = allArtists.find(a => a.id === apt.artist_id);
              if (artist) artistName = artist.name || '';
            }
            if (!artistName && apt.artist?.name) {
              artistName = apt.artist.name;
            }
            if (!artistName) {
              artistName = apt.customer?.first_name || apt.customer_name || 'Event';
            }

            // Kategorie fÃ¼r Farbe
            let rawCategory = apt.work_process || apt.category || apt.type || apt.booking_type || '';
            let category = rawCategory.toLowerCase().trim().replace(/\s+/g, '_');

            if (category.includes('consult')) category = 'consultation';
            else if (category.includes('new') || category.includes('neu')) category = 'new_tattoo';
            else if (category.includes('continu') || category.includes('weiter')) category = 'continuing_tattoo';
            else if (category.includes('touch')) category = 'touch_up';
            else if (category.includes('self')) category = 'selfbooking';
            else if (category.includes('wanna')) category = 'wannado';
            else if (category.includes('internal') || category.includes('intern')) category = 'internal';
            else category = 'default';

            const colors = categoryColors[category] || categoryColors.default;

            return `<div class="mobile-dp-mini-event" style="background:${colors.bg};color:${colors.color};font-size:9px;padding:1px 3px;border-radius:3px;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${artistName.substring(0, 8)}</div>`;
          }).join('');

          const moreCount = dayAppts.length - 3;
          moreHtml = moreCount > 0 ? `<div style="font-size:8px;color:#86868b;text-align:center;">+${moreCount}</div>` : '';
        }

        return `
          <div class="mobile-dp-day-cell ${d.otherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''}"
               style="min-height:60px;padding:4px;border:1px solid rgba(0,0,0,0.05);display:flex;flex-direction:column;${isToday ? 'background:rgba(0,122,255,0.1);' : ''}"
               onclick="${d.otherMonth ? '' : `selectDayFromCalMonthView('${dateStr}')`}">
            <div class="mobile-dp-day-number" style="font-size:14px;font-weight:500;margin-bottom:2px;">${d.day}</div>
            <div class="mobile-dp-day-events" style="flex:1;display:flex;flex-direction:column;gap:1px;overflow:hidden;">
              ${eventsHtml}
              ${moreHtml}
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="mobile-dp-month-container">
          <div class="mobile-dp-month-name">${monthNames[month]} ${year}</div>
          <div class="mobile-dp-weekday-header">
            ${dayLabels.map(l => `<div class="mobile-dp-weekday-label">${l}</div>`).join('')}
          </div>
          <div class="mobile-dp-month-grid">${dayCells}</div>
        </div>
      `;
    }

    function selectDayFromCalMonthView(dateStr) {
      // Parse the date
      const [year, month, day] = dateStr.split('-').map(Number);
      const selectedDate = new Date(year, month - 1, day);

      // Update calendar state
      if (typeof mobileCalState !== 'undefined') {
        mobileCalState.currentDate = selectedDate;
      }

      // Close month view
      closeMobileCalMonthView();

      // Reload calendar day view
      if (typeof renderMobileCalendar === 'function') {
        renderMobileCalendar();
      }
      updateMobileHeaderTitle('calendar');
    }

    // Expose calendar month view functions
    window.toggleMobileCalMonthView = toggleMobileCalMonthView;
    window.closeMobileCalMonthView = closeMobileCalMonthView;
    window.selectDayFromCalMonthView = selectDayFromCalMonthView;

    function renderEmptyDienstplan(container) {
      renderDienstplanDays(container, []);
    }

    function renderDienstplanDays(container, shifts) {
      const days = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
      container.innerHTML = '';

      for (let i = 0; i < 7; i++) {
        const date = new Date(mobileDpState.currentWeekStart);
        date.setDate(date.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];

        const dayShifts = shifts.filter(s => s.start_date === dateStr);

        const card = document.createElement('div');
        card.className = 'mobile-dp-day-card';
        card.innerHTML = `
          <div class="mobile-dp-day-header">
            <span>${days[i]} ${date.getDate()}.${date.getMonth() + 1}.</span>
            <button class="mobile-dp-day-menu">â€¢â€¢â€¢</button>
          </div>
          ${dayShifts.length > 0 ? dayShifts.map(shift => `
            <div class="mobile-dp-shift">
              <div class="mobile-dp-shift-title">
                <span>ðŸ•</span> ${shift.state || shift.role || shift.shift_type || 'Schicht'}
              </div>
              <div class="mobile-dp-shift-info">${shift.working_start || shift.start_time || '09:00'} - ${shift.working_end || shift.end_time || '18:00'}</div>
            </div>
          `).join('') : `
            <div class="mobile-dp-no-shift">
              <div style="font-weight: 500; color: #64B5F6;">Keine Schichten</div>
              <div style="font-size: 12px; margin-top: 4px;">Am ${days[i]} ${date.getDate()}.${date.getMonth() + 1}. bist du nicht eingeteilt.</div>
            </div>
          `}
        `;
        container.appendChild(card);
      }
    }

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        if (window.matchMedia('(max-width: 768px)').matches) {
          initMobileCalendar();
          initMobileDienstplan();
        }
      });
    } else {
      if (window.matchMedia('(max-width: 768px)').matches) {
        initMobileCalendar();
        initMobileDienstplan();
      }
    }

    // ============================================
    // Guestspot View Toggle (List / Month / Year)
    // ============================================
    let guestspotCurrentView = 'list'; // 'list', 'month', 'year'
    let guestspotViewMonth = new Date(); // Aktueller Monat als Default
    let guestspotViewYear = new Date().getFullYear(); // Aktuelles Jahr als Default
    let guestspotCachedSlots = [];

    function toggleGuestspotView() {
      const views = ['list', 'month', 'year'];
      const currentIndex = views.indexOf(guestspotCurrentView);
      guestspotCurrentView = views[(currentIndex + 1) % views.length];

      // Bei Wechsel zu Month/Year: Aktuellen Monat/Jahr setzen
      if (guestspotCurrentView === 'month') {
        guestspotViewMonth = new Date();
      } else if (guestspotCurrentView === 'year') {
        guestspotViewYear = new Date().getFullYear();
      }

      updateGuestspotViewUI();
    }

    function resetGuestspotView() {
      // Reset to list view (called when switching tabs)
      guestspotCurrentView = 'list';
      guestspotViewMonth = new Date();
      guestspotViewYear = new Date().getFullYear();

      const viewLabel = document.getElementById('guestspotViewLabel');
      if (viewLabel) viewLabel.textContent = 'List';

      const listContainer = document.getElementById('waitlistSlotsContainer');
      const monthContainer = document.getElementById('guestspotMonthViewContainer');
      const yearContainer = document.getElementById('guestspotYearViewContainer');

      if (listContainer) listContainer.style.display = 'block';
      if (monthContainer) monthContainer.style.display = 'none';
      if (yearContainer) yearContainer.style.display = 'none';
    }

    function updateGuestspotViewUI() {
      const listContainer = document.getElementById('waitlistSlotsContainer');
      const monthContainer = document.getElementById('guestspotMonthViewContainer');
      const yearContainer = document.getElementById('guestspotYearViewContainer');
      const viewLabel = document.getElementById('guestspotViewLabel');
      const emptyState = document.getElementById('waitlistEmptyState');

      // Hide all containers first
      if (listContainer) listContainer.style.display = 'none';
      if (monthContainer) monthContainer.style.display = 'none';
      if (yearContainer) yearContainer.style.display = 'none';
      if (emptyState) emptyState.style.display = 'none';

      // Update label
      const labels = { list: 'List', month: 'Month', year: 'Year' };
      if (viewLabel) viewLabel.textContent = labels[guestspotCurrentView];

      // Show appropriate container
      if (guestspotCurrentView === 'list') {
        if (listContainer) listContainer.style.display = 'block';
        if (guestspotCachedSlots.length === 0 && emptyState) {
          emptyState.style.display = 'block';
        }
      } else if (guestspotCurrentView === 'month') {
        if (monthContainer) monthContainer.style.display = 'block';
        renderGuestspotMonthView();
      } else if (guestspotCurrentView === 'year') {
        if (yearContainer) yearContainer.style.display = 'block';
        renderGuestspotYearView();
      }
    }

    function changeGuestspotMonth(delta) {
      guestspotViewMonth.setMonth(guestspotViewMonth.getMonth() + delta);
      renderGuestspotMonthView();
    }

    function changeGuestspotYear(delta) {
      guestspotViewYear += delta;
      renderGuestspotYearView();
    }

    function renderGuestspotMonthView() {
      const titleEl = document.getElementById('guestspotMonthTitle');
      const gridEl = document.getElementById('guestspotMonthGrid');

      if (!titleEl || !gridEl) return;

      const year = guestspotViewMonth.getFullYear();
      const month = guestspotViewMonth.getMonth();

      // Set title
      titleEl.textContent = guestspotViewMonth.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });

      // Get first day and days in month
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDayOfWeek = (firstDay.getDay() + 6) % 7; // Monday = 0

      // Create slots lookup by date
      const slotsByDate = {};
      guestspotCachedSlots.forEach(slot => {
        if (slot.date_from && slot.date_to) {
          const from = new Date(slot.date_from);
          const to = new Date(slot.date_to);
          for (let d = new Date(from); d <= to; d.setDate(d.getDate() + 1)) {
            const key = d.toISOString().split('T')[0];
            if (!slotsByDate[key]) slotsByDate[key] = [];
            slotsByDate[key].push(slot);
          }
        }
      });

      // Build grid
      let html = '';

      // Day headers
      const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
      dayNames.forEach(day => {
        html += `<div style="text-align:center; font-size:12px; font-weight:600; color:#86868b; padding:8px 0;">${day}</div>`;
      });

      // Empty cells before first day
      for (let i = 0; i < startDayOfWeek; i++) {
        html += '<div></div>';
      }

      // Days - PHASE 7: Show past, today and future with color coding
      const today = new Date().toISOString().split('T')[0];
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const slots = slotsByDate[dateStr] || [];
        const isToday = dateStr === today;
        const isPast = dateStr < today;
        const hasSlots = slots.length > 0;

        // PHASE 7: Guest Spot items with color coding (paid/unpaid/canceled)
        let slotCards = '';
        if (hasSlots) {
          slotCards = slots.map(s => {
            const artistName = (s.artist_name || 'Artist').substring(0, 12);
            const isPaid = s.is_paid === true;
            const isCanceled = s.entry_status === 'canceled' || s.status === 'canceled';
            const timeFrom = s.time_from ? s.time_from.substring(0, 5) : '';

            // Determine status class
            let statusClass = isPaid ? 'paid' : 'unpaid';
            if (isCanceled) statusClass = 'canceled';
            if (isPast && !isToday) statusClass += ' past';

            // Cache the slot for click handler
            const cacheKey = cacheGuestSpotSlot(s);

            return `
              <div class="guest-spot-day-item ${statusClass}"
                   onclick="event.stopPropagation(); openGuestSpotDetailFromCache('${cacheKey}')"
                   title="${artistName}${timeFrom ? ' - ' + timeFrom : ''}${isPaid ? ' (Bezahlt)' : ' (Unbezahlt)'}${isCanceled ? ' (Storniert)' : ''}">
                <span class="artist-name">${artistName}</span>
                ${timeFrom ? `<span class="spot-time">${timeFrom}</span>` : ''}
              </div>
            `;
          }).join('');
        }

        // Day cell styling - slightly muted for past days
        const pastOpacity = isPast && !isToday ? 'opacity: 0.7;' : '';

        html += `
          <div
            data-date="${dateStr}"
            style="
              min-height:80px;
              height:auto;
              padding:4px;
              display:flex;
              flex-direction:column;
              align-items:stretch;
              border-radius:8px;
              background:var(--macos-elevated);
              border:${isToday ? '2px solid #007aff' : '1px solid var(--border-color)'};
              transition:all 0.2s;
              ${pastOpacity}
            "
          >
            <span style="font-size:12px; font-weight:${isToday ? '700' : '500'}; color:${isToday ? '#007aff' : 'var(--ink)'}; margin-bottom:4px;">${day}</span>
            <div style="display:flex; flex-direction:column; gap:2px; flex:1; overflow:visible;">
              ${slotCards}
            </div>
          </div>
        `;
      }

      gridEl.innerHTML = html;
    }

    // ============================================
    // PHASE 7: GUEST SPOT YEAR VIEW - Dienstplan Style
    // Shows horizontal months header with artists as rows
    // ============================================
    function renderGuestspotYearView() {
      const titleEl = document.getElementById('guestspotYearTitle');
      const gridEl = document.getElementById('guestspotYearGrid');

      if (!titleEl || !gridEl) return;

      titleEl.textContent = guestspotViewYear.toString();

      // Filter slots for the current year (only Guest Spots, NO waitlist)
      const yearSlots = guestspotCachedSlots.filter(slot => {
        if (!slot.date_from) return false;
        const date = new Date(slot.date_from);
        return date.getFullYear() === guestspotViewYear;
      });

      if (yearSlots.length === 0) {
        gridEl.innerHTML = `
          <div class="guestspot-year-view-empty">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 16px; opacity: 0.5;">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <p>Keine Guest Spots in ${guestspotViewYear}</p>
          </div>
        `;
        return;
      }

      // Group slots by artist
      const artistMap = new Map();

      yearSlots.forEach(slot => {
        const artistId = slot.artist_id || 'unknown';
        const artistName = slot.artist_name || 'Unknown Artist';
        const artistInsta = slot.instagram || slot.artist_instagram || '';
        const artistImage = slot.profile_image_url || slot.artist_image || '';

        if (!artistMap.has(artistId)) {
          artistMap.set(artistId, {
            id: artistId,
            name: artistName,
            instagram: artistInsta,
            image: artistImage,
            spots: []
          });
        }

        artistMap.get(artistId).spots.push(slot);
      });

      // Sort artists alphabetically
      const sortedArtists = Array.from(artistMap.values())
        .sort((a, b) => a.name.localeCompare(b.name));

      // Render Grid
      let html = '';

      sortedArtists.forEach(artist => {
        html += `
          <div class="guestspot-year-artist-row" data-artist-id="${artist.id}">
            <div class="guestspot-year-artist-name">
              <img src="${artist.image || 'https://via.placeholder.com/28'}" alt="${artist.name}" onerror="this.src='https://via.placeholder.com/28'">
              <div style="overflow:hidden;">
                <div class="name">${artist.name}</div>
                ${artist.instagram ? `<div class="instagram">@${artist.instagram}</div>` : ''}
              </div>
            </div>
        `;

        // For each month (0-11)
        for (let month = 0; month < 12; month++) {
          const monthStart = new Date(guestspotViewYear, month, 1);
          const monthEnd = new Date(guestspotViewYear, month + 1, 0);

          // Find spots that overlap with this month
          const monthSpots = artist.spots.filter(spot => {
            const spotStart = new Date(spot.date_from);
            const spotEnd = new Date(spot.date_to);
            return spotStart <= monthEnd && spotEnd >= monthStart;
          });

          html += `<div class="guestspot-year-month-cell" data-month="${month}">`;

          monthSpots.forEach(spot => {
            const isPaid = spot.is_paid === true;
            const isCanceled = spot.entry_status === 'canceled' || spot.status === 'canceled';
            let statusClass = isPaid ? 'paid' : 'unpaid';
            if (isCanceled) statusClass = 'canceled';

            const dateFrom = new Date(spot.date_from);
            const dateTo = new Date(spot.date_to);
            const dayCount = Math.ceil((dateTo - dateFrom) / (1000 * 60 * 60 * 24)) + 1;

            // Tooltip Info
            const tooltipText = `${dateFrom.toLocaleDateString('de-DE')} - ${dateTo.toLocaleDateString('de-DE')} (${dayCount} Tag${dayCount > 1 ? 'e' : ''})${isPaid ? ' âœ“ Bezahlt' : ' âœ— Unbezahlt'}${isCanceled ? ' (Storniert)' : ''}`;

            // Cache slot for click handler
            const cacheKey = cacheGuestSpotSlot(spot);

            // Show as indicator bar
            html += `
              <div class="guestspot-year-spot-indicator ${statusClass}"
                   title="${tooltipText}"
                   onclick="openGuestSpotDetailFromCache('${cacheKey}')">
              </div>
            `;
          });

          html += `</div>`;
        }

        html += `</div>`;
      });

      gridEl.innerHTML = html;
    }

    function scrollToGuestspotSlot(dateStr) {
      // Find slot that matches this date
      const matchingSlot = guestspotCachedSlots.find(slot => {
        if (!slot.date_from || !slot.date_to) return false;
        const from = new Date(slot.date_from).toISOString().split('T')[0];
        const to = new Date(slot.date_to).toISOString().split('T')[0];
        return dateStr >= from && dateStr <= to;
      });

      if (!matchingSlot) return;

      // Switch to list view
      guestspotCurrentView = 'list';
      updateGuestspotViewUI();

      // Wait for DOM update, then scroll to the slot card
      setTimeout(() => {
        const slotCard = document.querySelector(`.waitlist-slot-card[data-slot-id="${matchingSlot.id}"]`);
        if (slotCard) {
          slotCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // Highlight briefly
          slotCard.style.boxShadow = '0 0 0 3px #007aff';
          setTimeout(() => {
            slotCard.style.boxShadow = '';
          }, 2000);
        }
      }, 100);
    }

    // Expose functions globally
    window.toggleGuestspotView = toggleGuestspotView;
    window.resetGuestspotView = resetGuestspotView;
    window.changeGuestspotMonth = changeGuestspotMonth;
    window.changeGuestspotYear = changeGuestspotYear;
    window.scrollToGuestspotSlot = scrollToGuestspotSlot;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GUEST SPOT BOOKING SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Global Variables for Guest Spot System
    let selectedGuestSpotArtist = null;
    let currentGuestSpotBookingType = 'internal';
    let currentGuestSpotDetailData = null;
    let artistSearchTimeout = null;
    let guestSpotSlotsCache = {}; // Cache fÃ¼r Slot-Daten (vermeidet JSON in onclick)

    // ============================================
    // SLOT CACHE HELPER (vermeidet JSON in onclick)
    // ============================================

    function cacheGuestSpotSlot(slot) {
      if (!slot || !slot.id) return null;
      const cacheKey = slot.id;
      guestSpotSlotsCache[cacheKey] = slot;
      return cacheKey;
    }

    function getCachedGuestSpotSlot(cacheKey) {
      return guestSpotSlotsCache[cacheKey] || null;
    }

    function openGuestSpotDetailFromCache(cacheKey) {
      const slot = getCachedGuestSpotSlot(cacheKey);
      if (slot) {
        openGuestSpotDetailModal(slot);
      } else {
        console.error('Slot not found in cache:', cacheKey);
        if (typeof window.showNotification === 'function') {
          window.showNotification('Slot nicht gefunden', 'error');
        }
      }
    }

    window.cacheGuestSpotSlot = cacheGuestSpotSlot;
    window.getCachedGuestSpotSlot = getCachedGuestSpotSlot;
    window.openGuestSpotDetailFromCache = openGuestSpotDetailFromCache;

    // ============================================
    // SHARE SPLIT SYSTEM - Rang zu Share Mapping
    // ============================================

    const RANK_SHARE_MAP = {
      'Friends': { artist: 70, studio: 30 },
      'Crew':    { artist: 75, studio: 25 },
      'Fam':     { artist: 80, studio: 20 },
      'VIP':     { artist: 80, studio: 20 },
      // Fallback fÃ¼r alte RÃ¤nge (Ãœbergangszeit)
      'R1':      { artist: 70, studio: 30 },
      'R2':      { artist: 75, studio: 25 },
      'R3':      { artist: 80, studio: 20 },
      'R4':      { artist: 80, studio: 20 },
      'R5':      { artist: 80, studio: 20 },
      'default': { artist: 75, studio: 25 }
    };

    // ============================================
    // SVG ICONS fÃ¼r Guest Spot Modals
    // ============================================
    const GUEST_SPOT_ICONS = {
      selfBooking: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>`,
      accommodation: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
      lightbulb: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg>`,
      shareSplit: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
      settings: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
      checkCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
      info: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>`,
      paymentNote: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
      calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
      clock: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
      notes: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`
    };
    window.GUEST_SPOT_ICONS = GUEST_SPOT_ICONS;

    // Unterkunft-Felder Toggle
    function toggleAccommodationFields() {
      const checkbox = document.getElementById('guestSpotAccommodation');
      const fields = document.getElementById('accommodationFields');
      if (checkbox && fields) {
        fields.style.display = checkbox.checked ? 'block' : 'none';
        if (!checkbox.checked) {
          const costInput = document.getElementById('guestSpotAccommodationCost');
          if (costInput) costInput.value = '';
        }
      }
    }

    // Custom Share Slider Toggle
    function toggleCustomShareSlider() {
      const checkbox = document.getElementById('guestSpotCustomShare');
      const sliderContainer = document.getElementById('customShareSliderContainer');
      const isCustomInput = document.getElementById('guestSpotIsCustomShare');

      if (!checkbox || !sliderContainer) return;

      if (checkbox.checked) {
        sliderContainer.style.opacity = '1';
        sliderContainer.style.pointerEvents = 'auto';
        if (isCustomInput) isCustomInput.value = 'true';

        // Info-Text aktualisieren
        const sourceInfo = document.getElementById('shareSourceInfo');
        if (sourceInfo) {
          sourceInfo.innerHTML = '<span style="color:#ff9500;">âš™ï¸ Custom Share Split aktiv</span>';
        }
      } else {
        sliderContainer.style.opacity = '0.4';
        sliderContainer.style.pointerEvents = 'none';
        if (isCustomInput) isCustomInput.value = 'false';

        // ZurÃ¼ck zu Rang-basierten Werten
        if (selectedGuestSpotArtist && selectedGuestSpotArtist.rank) {
          updateShareDisplayFromRank(selectedGuestSpotArtist.rank);
        }
      }
    }

    // Slider-Wert Update
    function updateShareFromSlider(value) {
      const artistPercent = parseInt(value);
      const studioPercent = 100 - artistPercent;

      // Display aktualisieren
      const studioDisplay = document.getElementById('studioSharePercent');
      const artistDisplay = document.getElementById('artistSharePercent');
      const sliderStudio = document.getElementById('sliderStudioValue');
      const sliderArtist = document.getElementById('sliderArtistValue');

      if (studioDisplay) studioDisplay.textContent = studioPercent + '%';
      if (artistDisplay) artistDisplay.textContent = artistPercent + '%';
      if (sliderStudio) sliderStudio.textContent = studioPercent + '%';
      if (sliderArtist) sliderArtist.textContent = artistPercent + '%';

      // Hidden Inputs setzen
      const artistInput = document.getElementById('guestSpotShareArtist');
      const studioInput = document.getElementById('guestSpotShareStudio');
      if (artistInput) artistInput.value = artistPercent;
      if (studioInput) studioInput.value = studioPercent;
    }

    // Share-Anzeige basierend auf Rang aktualisieren
    function updateShareDisplayFromRank(rank) {
      const shares = RANK_SHARE_MAP[rank] || RANK_SHARE_MAP['default'];

      // Display aktualisieren
      const studioDisplay = document.getElementById('studioSharePercent');
      const artistDisplay = document.getElementById('artistSharePercent');
      const sliderStudio = document.getElementById('sliderStudioValue');
      const sliderArtist = document.getElementById('sliderArtistValue');
      const slider = document.getElementById('shareSlider');
      const sourceInfo = document.getElementById('shareSourceInfo');
      const rankInfo = document.getElementById('artistRankInfo');
      const rankBadge = document.getElementById('selectedArtistRankBadge');

      if (studioDisplay) studioDisplay.textContent = shares.studio + '%';
      if (artistDisplay) artistDisplay.textContent = shares.artist + '%';
      if (sliderStudio) sliderStudio.textContent = shares.studio + '%';
      if (sliderArtist) sliderArtist.textContent = shares.artist + '%';
      if (slider) slider.value = shares.artist;

      // Hidden Inputs setzen
      const artistInput = document.getElementById('guestSpotShareArtist');
      const studioInput = document.getElementById('guestSpotShareStudio');
      if (artistInput) artistInput.value = shares.artist;
      if (studioInput) studioInput.value = shares.studio;

      // Rang-Info anzeigen
      if (rankInfo) rankInfo.style.display = 'block';
      if (rankBadge) {
        rankBadge.textContent = rank;
        rankBadge.className = 'rank-badge rank-' + rank.toLowerCase();
      }

      // Source Info aktualisieren
      if (sourceInfo) {
        const customCheckbox = document.getElementById('guestSpotCustomShare');
        if (!customCheckbox || !customCheckbox.checked) {
          sourceInfo.innerHTML = `<span style="display:inline-flex; color:#34c759;">${GUEST_SPOT_ICONS.checkCircle}</span> <span>Basierend auf Artist Rang: <strong>${rank}</strong> (${shares.artist}/${shares.studio})</span>`;
        }
      }
    }

    // Reset Share Display (wenn kein Artist ausgewÃ¤hlt)
    function resetShareDisplay() {
      const studioDisplay = document.getElementById('studioSharePercent');
      const artistDisplay = document.getElementById('artistSharePercent');
      const sourceInfo = document.getElementById('shareSourceInfo');
      const rankInfo = document.getElementById('artistRankInfo');
      const artistInput = document.getElementById('guestSpotShareArtist');
      const studioInput = document.getElementById('guestSpotShareStudio');

      if (studioDisplay) studioDisplay.textContent = '-%';
      if (artistDisplay) artistDisplay.textContent = '-%';
      if (sourceInfo) sourceInfo.innerHTML = `<span style="display:inline-flex;">${GUEST_SPOT_ICONS.info}</span> <span>WÃ¤hle einen Artist um den Share zu sehen</span>`;
      if (rankInfo) rankInfo.style.display = 'none';
      if (artistInput) artistInput.value = '';
      if (studioInput) studioInput.value = '';
    }

    // Window Exports fÃ¼r neue Funktionen
    window.toggleAccommodationFields = toggleAccommodationFields;
    window.toggleCustomShareSlider = toggleCustomShareSlider;
    window.updateShareFromSlider = updateShareFromSlider;
    window.updateShareDisplayFromRank = updateShareDisplayFromRank;
    window.resetShareDisplay = resetShareDisplay;
    window.RANK_SHARE_MAP = RANK_SHARE_MAP;

    // Self Booking Mode Toggle
    function toggleSelfBookingMode() {
      const checkbox = document.getElementById('guestSpotSelfBooking');
      const isSelfBooking = checkbox?.checked || false;

      console.log('Self Booking Mode:', isSelfBooking ? 'ON' : 'OFF');

      // Optional: Visuelle Ã„nderungen basierend auf Self Booking
      // z.B. andere Beschriftungen oder Hinweise
    }

    window.toggleSelfBookingMode = toggleSelfBookingMode;

    // ============================================
    // MODAL OPEN/CLOSE FUNCTIONS
    // ============================================

    function openCreateGuestSpotModal() {
      console.log('ðŸ“… Opening Create Guest Spot Modal...');

      // Reset form
      const form = document.getElementById('createGuestSpotForm');
      if (form) form.reset();

      // Reset selected artist
      clearSelectedGuestSpotArtist();

      // NEU: Share-Felder zurÃ¼cksetzen
      resetShareDisplay();
      const customShareCheckbox = document.getElementById('guestSpotCustomShare');
      if (customShareCheckbox) customShareCheckbox.checked = false;
      const sliderContainer = document.getElementById('customShareSliderContainer');
      if (sliderContainer) {
        sliderContainer.style.opacity = '0.4';
        sliderContainer.style.pointerEvents = 'none';
      }
      const isCustomInput = document.getElementById('guestSpotIsCustomShare');
      if (isCustomInput) isCustomInput.value = 'false';

      // NEU: Unterkunft-Felder zurÃ¼cksetzen
      const accommodationCheckbox = document.getElementById('guestSpotAccommodation');
      if (accommodationCheckbox) accommodationCheckbox.checked = false;
      const accommodationFields = document.getElementById('accommodationFields');
      if (accommodationFields) accommodationFields.style.display = 'none';

      // Reset date picker
      if (typeof resetGuestSpotDatePicker === 'function') {
        resetGuestSpotDatePicker();
      }

      // Populate location dropdown
      populateGuestSpotLocationDropdown();

      // Show modal
      const modal = document.getElementById('createGuestSpotModal');
      if (modal) {
        modal.classList.add('active');
      }
    }

    function closeCreateGuestSpotModal() {
      const modal = document.getElementById('createGuestSpotModal');
      if (modal) {
        modal.classList.remove('active');
      }

      // Clear search results
      const resultsContainer = document.getElementById('guestSpotArtistResults');
      if (resultsContainer) {
        resultsContainer.style.display = 'none';
        resultsContainer.innerHTML = '';
      }
    }

    function openGuestSpotDetailModal(slotData) {
      console.log('ðŸ“‹ Opening Guest Spot Detail Modal...', slotData);

      currentGuestSpotDetailData = slotData;

      // Store IDs
      document.getElementById('guestSpotDetailId').value = slotData.id || '';
      document.getElementById('guestSpotDetailSlotIds').value = JSON.stringify(slotData.all_slot_ids || [slotData.id]);

      // Populate Artist Info
      const avatar = document.getElementById('guestSpotDetailAvatar');
      if (slotData.profile_picture_url) {
        avatar.src = slotData.profile_picture_url;
        avatar.style.display = 'block';
      } else {
        avatar.style.display = 'none';
      }

      document.getElementById('guestSpotDetailArtistName').textContent = slotData.artist_name || 'Unknown Artist';
      document.getElementById('guestSpotDetailArtistInstagram').textContent = slotData.instagram ? '@' + slotData.instagram : '';

      // Paid Badge
      const paidBadge = document.getElementById('guestSpotDetailPaidBadge');
      if (slotData.is_paid) {
        paidBadge.textContent = 'âœ“ Paid';
        paidBadge.style.background = '#34c759';
        paidBadge.style.color = 'white';
      } else {
        paidBadge.textContent = 'âœ— Unpaid';
        paidBadge.style.background = '#ff3b30';
        paidBadge.style.color = 'white';
      }

      // Date & Time
      const dateFrom = slotData.date_from ? new Date(slotData.date_from).toLocaleDateString('de-DE') : 'N/A';
      const dateTo = slotData.date_to ? new Date(slotData.date_to).toLocaleDateString('de-DE') : 'N/A';
      document.getElementById('guestSpotDetailDateRange').textContent = dateFrom === dateTo ? dateFrom : `${dateFrom} - ${dateTo}`;

      const timeFrom = slotData.time_from || '10:00';
      const timeTo = slotData.time_to || '18:00';
      document.getElementById('guestSpotDetailTimeRange').textContent = `${timeFrom} - ${timeTo}`;

      // Location
      document.getElementById('guestSpotDetailLocation').textContent =
        (slotData.location_name || 'Unknown') + (slotData.location_city ? ` (${slotData.location_city})` : '');

      // Booking Type
      const bookingType = slotData.booking_type || 'external';
      document.getElementById('guestSpotDetailBookingType').textContent =
        bookingType === 'internal' ? 'Interne Buchung' : 'Externe Artist Buchung';

      // Payment Info
      const internalPayment = document.getElementById('guestSpotDetailInternalPayment');
      const externalPayment = document.getElementById('guestSpotDetailExternalPayment');

      if (bookingType === 'internal') {
        internalPayment.style.display = 'block';
        externalPayment.style.display = 'none';

        document.getElementById('guestSpotDetailInternalDeposit').textContent =
          slotData.deposit_amount ? `â‚¬${parseFloat(slotData.deposit_amount).toFixed(2)}` : 'â‚¬0.00';
        document.getElementById('guestSpotDetailInternalOnsite').textContent =
          slotData.onsite_deposit ? `â‚¬${parseFloat(slotData.onsite_deposit).toFixed(2)}` : 'â‚¬0.00';
        document.getElementById('guestSpotDetailInternalNotes').textContent =
          slotData.payment_notes || '-';
      } else {
        internalPayment.style.display = 'none';
        externalPayment.style.display = 'block';

        document.getElementById('guestSpotDetailExternalTotal').textContent =
          slotData.total_price ? `â‚¬${parseFloat(slotData.total_price).toFixed(2)}` : 'â‚¬0.00';
        document.getElementById('guestSpotDetailExternalDeposit').textContent =
          slotData.deposit_amount ? `â‚¬${parseFloat(slotData.deposit_amount).toFixed(2)}` : 'â‚¬0.00';
        document.getElementById('guestSpotDetailStudioShare').textContent =
          slotData.studio_share ? `â‚¬${parseFloat(slotData.studio_share).toFixed(2)}` : 'â‚¬0.00';
        document.getElementById('guestSpotDetailArtistShare').textContent =
          slotData.artist_share ? `â‚¬${parseFloat(slotData.artist_share).toFixed(2)}` : 'â‚¬0.00';
        document.getElementById('guestSpotDetailExternalNotes').textContent =
          slotData.payment_notes || '-';
      }

      // Notes
      const notesSection = document.getElementById('guestSpotDetailNotesSection');
      if (slotData.notes) {
        notesSection.style.display = 'block';
        document.getElementById('guestSpotDetailNotes').textContent = slotData.notes;
      } else {
        notesSection.style.display = 'none';
      }

      // Canceled Info
      const canceledInfo = document.getElementById('guestSpotDetailCanceledInfo');
      if (slotData.status === 'canceled' || slotData.canceled_at) {
        canceledInfo.style.display = 'block';
        document.getElementById('guestSpotDetailCancelReason').textContent =
          slotData.cancel_reason || 'Kein Grund angegeben';
      } else {
        canceledInfo.style.display = 'none';
      }

      // Update Toggle Paid Button
      updateTogglePaidButton(slotData.is_paid);

      // Show view mode, hide edit mode
      document.getElementById('guestSpotViewMode').style.display = 'block';
      document.getElementById('guestSpotEditMode').style.display = 'none';

      // Check if slot is in the past or canceled
      const isPast = slotData.date_to && new Date(slotData.date_to) < new Date();
      const isCanceled = slotData.status === 'canceled' || slotData.canceled_at;

      // Hide/Show action buttons based on status
      const editBtn = document.getElementById('guestSpotEditBtn');
      const cancelBtn = document.getElementById('guestSpotCancelBtn');
      const deleteBtn = document.getElementById('guestSpotDeleteBtn');
      const paidBtn = document.getElementById('guestSpotTogglePaidBtn');
      const reactivateBtn = document.getElementById('guestSpotReactivateBtn');

      if (isCanceled) {
        // Canceled slots: Show Reactivate and Delete only
        if (editBtn) editBtn.style.display = 'none';
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (reactivateBtn) reactivateBtn.style.display = 'flex';
        if (deleteBtn) deleteBtn.style.display = 'flex';
        if (paidBtn) paidBtn.style.display = 'flex';
      } else if (isPast) {
        // Past slots: Hide edit/cancel/reactivate, show delete and paid
        if (editBtn) editBtn.style.display = 'none';
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (reactivateBtn) reactivateBtn.style.display = 'none';
        if (deleteBtn) deleteBtn.style.display = 'flex';
        if (paidBtn) paidBtn.style.display = 'flex';
      } else {
        // Active/upcoming slots: Show all standard buttons, hide reactivate
        if (editBtn) editBtn.style.display = 'flex';
        if (cancelBtn) cancelBtn.style.display = 'flex';
        if (reactivateBtn) reactivateBtn.style.display = 'none';
        if (deleteBtn) deleteBtn.style.display = 'flex';
        if (paidBtn) paidBtn.style.display = 'flex';
      }

      // Show modal
      const modal = document.getElementById('guestSpotDetailModal');
      if (modal) {
        modal.classList.add('active');
      }

      // Modal Styling fÃ¼r Animation und einheitliche HÃ¶he
      setTimeout(() => {
        const modalContent = document.querySelector('#guestSpotDetailModal .modal');
        if (modalContent) {
          modalContent.style.transition = 'transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), border-radius 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
          modalContent.style.zIndex = '10001';
          modalContent.style.position = 'relative';
          modalContent.style.height = '80vh';
          modalContent.style.maxHeight = '80vh';
          modalContent.style.overflowY = 'auto';
          modalContent.style.boxShadow = 'none';
        }
      }, 0);

      // NEU: Lade verknÃ¼pfte Appointments
      loadGuestSpotAppointments(slotData.id, slotData.share_percentage_artist, slotData.share_percentage_studio, slotData.self_booking || slotData.booking_type === 'external');
    }

    function closeGuestSpotDetailModal() {
      const modal = document.getElementById('guestSpotDetailModal');
      if (modal) {
        modal.classList.remove('active');
      }
      currentGuestSpotDetailData = null;
    }

    function updateTogglePaidButton(isPaid) {
      const btn = document.getElementById('guestSpotTogglePaidBtn');
      if (!btn) return;

      if (isPaid) {
        btn.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
          Paid
        `;
        btn.style.background = '#34c759';
        btn.style.color = 'white';
      } else {
        btn.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M18 6L6 18"/><path d="M6 6l12 12"/>
          </svg>
          Unpaid
        `;
        btn.style.background = '#ff3b30';
        btn.style.color = 'white';
      }
    }

    // ============================================
    // BOOKING TYPE SWITCHER
    // ============================================

    // DEPRECATED: Booking Type wurde durch Share System ersetzt
    function switchGuestSpotBookingType(type) {
      console.log('switchGuestSpotBookingType is deprecated - Share System is now used');
      return;
    }

    // ============================================
    // ARTIST LIVE-SEARCH
    // ============================================

    function initGuestSpotArtistSearch() {
      const searchInput = document.getElementById('guestSpotArtistSearch');
      const resultsContainer = document.getElementById('guestSpotArtistResults');

      if (!searchInput || !resultsContainer) return;

      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();

        // Clear previous timeout
        if (artistSearchTimeout) {
          clearTimeout(artistSearchTimeout);
        }

        // Hide results if empty
        if (query.length < 2) {
          resultsContainer.style.display = 'none';
          resultsContainer.innerHTML = '';
          return;
        }

        // Debounce search
        artistSearchTimeout = setTimeout(() => {
          searchArtistsForGuestSpot(query);
        }, 300);
      });

      // Close results when clicking outside
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
          resultsContainer.style.display = 'none';
        }
      });
    }

    async function searchArtistsForGuestSpot(query) {
      const resultsContainer = document.getElementById('guestSpotArtistResults');
      if (!resultsContainer) return;

      console.log('ðŸ” Searching artists for:', query);

      // Show loading
      resultsContainer.style.display = 'block';
      resultsContainer.innerHTML = '<div style="padding:12px; text-align:center; color:#86868b;">Suche...</div>';

      try {
        // Search by name OR instagram (case insensitive)
        const { data, error } = await supabase
          .from('artists')
          .select('id, name, instagram, profile_picture_url, is_guest, rank')
          .or(`name.ilike.%${query}%,instagram.ilike.%${query}%`)
          .order('name')
          .limit(10);

        if (error) throw error;

        if (!data || data.length === 0) {
          resultsContainer.innerHTML = '<div style="padding:12px; text-align:center; color:#86868b;">Keine Artists gefunden</div>';
          return;
        }

        // Render results
        resultsContainer.innerHTML = data.map(artist => `
          <div
            class="artist-search-result"
            onclick="selectGuestSpotArtist('${artist.id}', '${(artist.name || '').replace(/'/g, "\\'")}', '${artist.instagram || ''}', '${artist.profile_picture_url || ''}', '${artist.rank || ''}')"
            style="
              padding:10px 12px;
              display:flex;
              align-items:center;
              gap:10px;
              cursor:pointer;
              border-bottom:1px solid rgba(0,0,0,0.05);
              transition:background 0.2s;
            "
            onmouseover="this.style.background='rgba(0,0,0,0.03)';"
            onmouseout="this.style.background='transparent';"
          >
            ${artist.profile_picture_url
              ? `<img src="${artist.profile_picture_url}" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">`
              : `<div style="width:32px; height:32px; border-radius:50%; background:#e0e0e0; display:flex; align-items:center; justify-content:center; font-size:14px; color:#86868b;">${(artist.name || '?')[0]}</div>`
            }
            <div style="flex:1;">
              <div style="font-weight:500; font-size:14px;">${artist.name || 'Unknown'}</div>
              ${artist.instagram ? `<div style="font-size:12px; color:#86868b;">@${artist.instagram}</div>` : ''}
            </div>
            <span style="
              font-size:10px;
              padding:2px 6px;
              border-radius:4px;
              background:${artist.is_guest ? 'rgba(0,122,255,0.1)' : 'rgba(52,199,89,0.1)'};
              color:${artist.is_guest ? '#007aff' : '#34c759'};
            ">${artist.is_guest ? 'Guest' : 'Resident'}</span>
            ${artist.rank ? `<span class="rank-badge rank-${(artist.rank || '').toLowerCase()}" style="padding:2px 6px; border-radius:4px; font-size:10px; margin-left:4px;">${artist.rank}</span>` : ''}
          </div>
        `).join('');

      } catch (error) {
        console.error('âŒ Artist search error:', error);
        resultsContainer.innerHTML = '<div style="padding:12px; text-align:center; color:#ff3b30;">Fehler bei der Suche</div>';
      }
    }

    function selectGuestSpotArtist(id, name, instagram, profilePicture, rank) {
      console.log('âœ… Artist selected:', name, 'Rank:', rank);

      selectedGuestSpotArtist = { id, name, instagram, profilePicture, rank };

      // Update hidden input
      document.getElementById('guestSpotArtistId').value = id;

      // Update display
      const selectedDisplay = document.getElementById('guestSpotSelectedArtist');
      const avatar = document.getElementById('guestSpotArtistAvatar');
      const nameEl = document.getElementById('guestSpotArtistName');
      const instagramEl = document.getElementById('guestSpotArtistInstagram');

      if (profilePicture) {
        avatar.src = profilePicture;
        avatar.style.display = 'block';
      } else {
        avatar.style.display = 'none';
      }

      nameEl.textContent = name;
      instagramEl.textContent = instagram ? `@${instagram}` : '';
      selectedDisplay.style.display = 'block';

      // Clear search
      document.getElementById('guestSpotArtistSearch').value = '';
      document.getElementById('guestSpotArtistResults').style.display = 'none';

      // NEU: Share-Anzeige basierend auf Artist-Rang aktualisieren
      if (rank) {
        updateShareDisplayFromRank(rank);
      } else {
        // Fallback wenn kein Rang: Default verwenden
        updateShareDisplayFromRank('default');
      }
    }

    function clearSelectedGuestSpotArtist() {
      selectedGuestSpotArtist = null;
      document.getElementById('guestSpotArtistId').value = '';
      document.getElementById('guestSpotSelectedArtist').style.display = 'none';
      document.getElementById('guestSpotArtistSearch').value = '';

      // NEU: Share-Anzeige zurÃ¼cksetzen
      resetShareDisplay();
    }

    // Open Add Artist Modal from Guest Spot Modal
    function openAddArtistFromGuestSpot() {
      console.log('âž• Opening Add Artist from Guest Spot...');

      // Store flag to know we came from Guest Spot
      window.addArtistFromGuestSpot = true;

      // Reset form
      document.getElementById('addArtistForm')?.reset();

      // Get the modal
      const modal = document.getElementById('addArtistModal');
      if (modal) {
        // Add elevated class for higher z-index and slide-in animation
        modal.classList.add('elevated');
        modal.classList.add('active');

        // Store original close handler to clean up elevated class
        const originalCloseHandler = window.closeAddArtistModal;
        window.closeAddArtistModal = function() {
          modal.classList.remove('elevated');
          modal.classList.remove('active');
          // Restore original handler after closing
          if (originalCloseHandler && typeof originalCloseHandler === 'function') {
            window.closeAddArtistModal = originalCloseHandler;
          }
        };
      }
    }

    // ============================================
    // LOCATION DROPDOWN
    // ============================================

    function populateGuestSpotLocationDropdown() {
      const dropdown = document.getElementById('guestSpotLocation');
      if (!dropdown) return;

      // Clear existing options (except first)
      dropdown.innerHTML = '<option value="">-- Location auswÃ¤hlen --</option>';

      // Get locations from global variable or fetch from existing dropdown
      let locations = [];

      // Try global allLocations first
      if (typeof allLocations !== 'undefined' && Array.isArray(allLocations) && allLocations.length > 0) {
        locations = allLocations;
        console.log('ðŸ“ Using allLocations:', locations.length);
      }
      // Try to get from waitlist location dropdown as fallback
      else {
        const waitlistDropdown = document.getElementById('waitlistLocationDropdown');
        if (waitlistDropdown) {
          Array.from(waitlistDropdown.options).forEach(opt => {
            if (opt.value && opt.value !== 'all') {
              locations.push({ id: opt.value, name: opt.textContent });
            }
          });
          console.log('ðŸ“ Using waitlist dropdown locations:', locations.length);
        }
      }

      // If still empty, try dienstplan location dropdown
      if (locations.length === 0) {
        const dienstplanDropdown = document.getElementById('locationFilter');
        if (dienstplanDropdown) {
          Array.from(dienstplanDropdown.options).forEach(opt => {
            if (opt.value && opt.value !== 'all') {
              locations.push({ id: opt.value, name: opt.textContent });
            }
          });
          console.log('ðŸ“ Using dienstplan dropdown locations:', locations.length);
        }
      }

      locations.forEach(loc => {
        const option = document.createElement('option');
        option.value = loc.id;
        option.textContent = loc.name + (loc.city ? ` (${loc.city})` : '');
        dropdown.appendChild(option);
      });

      console.log('ðŸ“ Location dropdown populated with', locations.length, 'locations');
    }

    // ============================================
    // FORM SUBMIT HANDLER
    // ============================================

    async function handleCreateGuestSpotSubmit(e) {
      e.preventDefault();

      console.log('ðŸ“ Creating Guest Spot...');

      // Validate artist selected
      const artistId = document.getElementById('guestSpotArtistId').value;
      if (!artistId) {
        showNotification('Bitte wÃ¤hle einen Artist aus', 'error');
        return;
      }

      // Get form values
      const dateFrom = document.getElementById('guestSpotDateFrom').value;
      const dateTo = document.getElementById('guestSpotDateTo').value;
      const timeFrom = document.getElementById('guestSpotTimeFrom').value;
      const timeTo = document.getElementById('guestSpotTimeTo').value;
      const locationId = document.getElementById('guestSpotLocation').value;
      const notes = document.getElementById('guestSpotNotes').value;

      // Validate required fields
      if (!dateFrom || !dateTo || !locationId) {
        showNotification('Bitte fÃ¼lle alle Pflichtfelder aus', 'error');
        return;
      }

      // Validate date range
      if (new Date(dateFrom) > new Date(dateTo)) {
        showNotification('End-Datum muss nach Start-Datum liegen', 'error');
        return;
      }

      // Build slot data
      const slotData = {
        artist_id: artistId,
        location_id: locationId,
        date_from: dateFrom,
        date_to: dateTo,
        time_from: timeFrom || '10:00',
        time_to: timeTo || '18:00',
        notes: notes || null,
        status: new Date(dateFrom) <= new Date() ? 'active' : 'upcoming',
        is_paid: false,
        created_at: new Date().toISOString(),
        // NEU: Share-Felder
        share_percentage_artist: parseInt(document.getElementById('guestSpotShareArtist').value) || null,
        share_percentage_studio: parseInt(document.getElementById('guestSpotShareStudio').value) || null,
        custom_share: document.getElementById('guestSpotIsCustomShare').value === 'true',
        // NEU: Unterkunft-Felder
        accommodation_provided: document.getElementById('guestSpotAccommodation')?.checked || false,
        accommodation_cost: document.getElementById('guestSpotAccommodation')?.checked
          ? (parseFloat(document.getElementById('guestSpotAccommodationCost').value) || null)
          : null,
        // Self Booking (ersetzt booking_type internal/external)
        self_booking: document.getElementById('guestSpotSelfBooking')?.checked || false,
        booking_type: document.getElementById('guestSpotSelfBooking')?.checked ? 'external' : 'internal',
        // Zahlungsnotiz
        payment_notes: document.getElementById('guestSpotPaymentNotes')?.value || null
      };

      console.log('ðŸ“¤ Slot data:', slotData);

      try {
        // ========== OVERLAP VALIDIERUNG (DEAKTIVIERT - RPC Funktion fehlt) ==========
        // TODO: RPC check_guest_spot_overlap in Supabase erstellen
        // Dann diesen Block wieder aktivieren
        /*
        const { data: overlapData, error: overlapError } = await supabase
          .rpc('check_guest_spot_overlap', {
            p_artist_id: selectedGuestSpotArtist.id,
            p_date_from: dateFrom,
            p_date_to: dateTo,
            p_exclude_slot_id: null
          });

        if (overlapError) {
          console.error('Error checking overlap:', overlapError);
        }

        if (overlapData && overlapData.length > 0) {
          const overlap = overlapData[0];
          const overlapFrom = new Date(overlap.overlapping_date_from).toLocaleDateString('de-DE');
          const overlapTo = new Date(overlap.overlapping_date_to).toLocaleDateString('de-DE');
          showNotification(
            `${overlap.artist_name || 'Artist'} hat bereits einen Guest Spot vom ${overlapFrom} bis ${overlapTo}`,
            'error'
          );
          return;
        }
        */
        // ========== ENDE OVERLAP VALIDIERUNG ==========

        // Insert into upcoming_slots
        // The trigger will automatically create calendar entries!
        const { data, error } = await supabase
          .from('upcoming_slots')
          .insert([slotData])
          .select();

        if (error) {
          console.error('âŒ Database error:', error);
          throw error;
        }

        console.log('âœ… Guest Spot created:', data);

        // Dienstplan wird automatisch via Trigger erstellt (trg_sync_upcoming_to_dienstplan)

        // ========== INSTANT RELOAD ALLER ANSICHTEN ==========
        console.log('ðŸ”„ Instant reloading all views after Guest Spot creation...');

        // 1. Modal sofort schlieÃŸen
        closeCreateGuestSpotModal();

        // 2. Notification zeigen
        showNotification('Guest Spot erfolgreich erstellt!', 'success');

        // 3. Alle Ansichten parallel neu laden
        const reloadPromises = [];

        // Waitlist/Guest Spots Tab (basierend auf aktuellem Tab)
        if (currentListType === 'upcoming' && typeof loadUpcomingGuestSpotsTab === 'function') {
          reloadPromises.push(loadUpcomingGuestSpotsTab());
        } else if (typeof loadWaitlistSlots === 'function') {
          reloadPromises.push(loadWaitlistSlots(currentWaitlistLocation || 'all'));
        }

        // Kalender
        if (typeof loadEvents === 'function' && selectedLocationId) {
          reloadPromises.push(loadEvents(selectedLocationId));
        }

        // Dienstplan
        if (typeof loadDienstplanData === 'function') {
          reloadPromises.push(loadDienstplanData());
        } else if (typeof loadDienstplan === 'function') {
          reloadPromises.push(loadDienstplan());
        }

        // Warte auf alle Reloads parallel
        await Promise.all(reloadPromises);
        console.log('âœ… All views reloaded after Guest Spot creation');
        // ========== ENDE INSTANT RELOAD ==========

      } catch (error) {
        console.error('âŒ Error creating Guest Spot:', error);
        showNotification('Fehler beim Erstellen: ' + error.message, 'error');
      }
    }

    // ============================================
    // DIENSTPLAN AVAILABILITY FOR GUEST SPOTS
    // ============================================
    // HINWEIS: Die Funktionen createDienstplanForGuestSpot() und
    // deleteDienstplanForGuestSpot() wurden ENTFERNT (Phase 2 Cleanup).
    //
    // Supabase Trigger erledigen die Synchronisation automatisch:
    // - trg_sync_upcoming_to_dienstplan (bei INSERT)
    // - trg_sync_upcoming_to_dienstplan_update (bei UPDATE)
    // - trg_sync_upcoming_to_dienstplan_delete (bei DELETE)
    // - trg_sync_cancel_to_dienstplan (bei Cancel/Reactivate)
    // ============================================

    // ============================================
    // TOGGLE PAID STATUS
    // ============================================

    async function toggleGuestSpotPaid() {
      if (!currentGuestSpotDetailData) return;

      const slotIds = JSON.parse(document.getElementById('guestSpotDetailSlotIds').value || '[]');
      const currentPaid = currentGuestSpotDetailData.is_paid;
      const newPaid = !currentPaid;

      console.log('ðŸ’° Toggling paid status to:', newPaid);

      try {
        const { error } = await supabase
          .from('upcoming_slots')
          .update({ is_paid: newPaid })
          .in('id', slotIds);

        if (error) throw error;

        // Update local data
        currentGuestSpotDetailData.is_paid = newPaid;

        // Update UI
        updateTogglePaidButton(newPaid);

        const paidBadge = document.getElementById('guestSpotDetailPaidBadge');
        if (newPaid) {
          paidBadge.textContent = 'âœ“ Paid';
          paidBadge.style.background = '#34c759';
        } else {
          paidBadge.textContent = 'âœ— Unpaid';
          paidBadge.style.background = '#ff3b30';
        }

        showNotification(newPaid ? 'Als bezahlt markiert' : 'Als unbezahlt markiert', 'success');

        // Reload lists
        if (typeof loadWaitlistSlots === 'function') {
          await loadWaitlistSlots(currentWaitlistLocation);
        }

      } catch (error) {
        console.error('âŒ Error toggling paid status:', error);
        showNotification('Fehler: ' + error.message, 'error');
      }
    }

    // ============================================
    // CANCEL GUEST SPOT
    // ============================================

    async function cancelGuestSpot() {
      if (!currentGuestSpotDetailData) return;

      const reason = prompt('Grund fÃ¼r Stornierung (optional):');

      if (reason === null) return; // User clicked cancel

      const slotIds = JSON.parse(document.getElementById('guestSpotDetailSlotIds').value || '[]');

      console.log('âŒ Canceling Guest Spot:', slotIds);

      try {
        // Use the cancel_guest_spot function if available, otherwise update directly
        const { error } = await supabase
          .from('upcoming_slots')
          .update({
            status: 'canceled',
            canceled_at: new Date().toISOString(),
            cancel_reason: reason || null
          })
          .in('id', slotIds);

        if (error) throw error;

        showNotification('Guest Spot storniert', 'success');
        closeGuestSpotDetailModal();

        // ========== INSTANT RELOAD NACH CANCEL ==========
        console.log('ðŸ”„ Instant reloading all views after Guest Spot cancel...');

        const cancelReloadPromises = [];

        // Reload current tab
        if (currentListType === 'upcoming' && typeof loadUpcomingGuestSpotsTab === 'function') {
          cancelReloadPromises.push(loadUpcomingGuestSpotsTab());
        } else if (currentListType === 'active' && typeof loadActiveGuestSpotsTab === 'function') {
          cancelReloadPromises.push(loadActiveGuestSpotsTab());
        } else if (typeof loadWaitlistSlots === 'function') {
          cancelReloadPromises.push(loadWaitlistSlots(currentWaitlistLocation || 'all'));
        }

        // Kalender
        if (typeof loadEvents === 'function' && selectedLocationId) {
          cancelReloadPromises.push(loadEvents(selectedLocationId));
        }

        // Dienstplan
        if (typeof loadDienstplanData === 'function') {
          cancelReloadPromises.push(loadDienstplanData());
        }

        await Promise.all(cancelReloadPromises);
        console.log('âœ… All views reloaded after cancel');
        // ========== ENDE INSTANT RELOAD ==========

      } catch (error) {
        console.error('âŒ Error canceling Guest Spot:', error);
        showNotification('Fehler: ' + error.message, 'error');
      }
    }

    // ============================================
    // DELETE GUEST SPOT
    // ============================================

    async function deleteGuestSpot() {
      if (!currentGuestSpotDetailData) return;

      const slotIds = JSON.parse(document.getElementById('guestSpotDetailSlotIds').value || '[]');
      const slotCount = slotIds.length;

      const confirmMsg = slotCount > 1
        ? `${slotCount} zusammenhÃ¤ngende Slots wirklich ENDGÃœLTIG lÃ¶schen?`
        : 'Guest Spot wirklich ENDGÃœLTIG lÃ¶schen?';

      if (!confirm(confirmMsg)) return;

      console.log('ðŸ—‘ï¸ Deleting Guest Spot:', slotIds);

      try {
        // Dienstplan wird automatisch via Trigger gelÃ¶scht (trg_sync_upcoming_to_dienstplan_delete)

        // Delete the slots (cascade will handle calendar entries)
        const { error } = await supabase
          .from('upcoming_slots')
          .delete()
          .in('id', slotIds);

        if (error) throw error;

        showNotification('Guest Spot gelÃ¶scht', 'success');
        closeGuestSpotDetailModal();

        // ========== INSTANT RELOAD NACH DELETE ==========
        console.log('ðŸ”„ Instant reloading all views after Guest Spot delete...');

        const deleteReloadPromises = [];

        // Reload current tab
        switch(currentListType) {
          case 'upcoming':
            if (typeof loadUpcomingGuestSpotsTab === 'function') deleteReloadPromises.push(loadUpcomingGuestSpotsTab());
            break;
          case 'active':
            if (typeof loadActiveGuestSpotsTab === 'function') deleteReloadPromises.push(loadActiveGuestSpotsTab());
            break;
          case 'previous':
            if (typeof loadPreviousGuestSpots === 'function') deleteReloadPromises.push(loadPreviousGuestSpots(currentWaitlistLocation));
            break;
          case 'canceled':
            if (typeof loadCanceledGuestSpotsTab === 'function') deleteReloadPromises.push(loadCanceledGuestSpotsTab());
            break;
          default:
            if (typeof loadWaitlistSlots === 'function') deleteReloadPromises.push(loadWaitlistSlots(currentWaitlistLocation || 'all'));
        }

        // Kalender
        if (typeof loadEvents === 'function' && selectedLocationId) {
          deleteReloadPromises.push(loadEvents(selectedLocationId));
        }

        // Dienstplan
        if (typeof loadDienstplanData === 'function') {
          deleteReloadPromises.push(loadDienstplanData());
        }

        await Promise.all(deleteReloadPromises);
        console.log('âœ… All views reloaded after delete');
        // ========== ENDE INSTANT RELOAD ==========

      } catch (error) {
        console.error('âŒ Error deleting Guest Spot:', error);
        showNotification('Fehler: ' + error.message, 'error');
      }
    }

    // ============================================
    // REACTIVATE GUEST SPOT (Un-Cancel)
    // ============================================

    async function reactivateGuestSpot() {
      if (!currentGuestSpotDetailData) return;

      const slotIds = JSON.parse(document.getElementById('guestSpotDetailSlotIds').value || '[]');

      if (!confirm('Guest Spot wirklich reaktivieren?')) return;

      console.log('ðŸ”„ Reactivating Guest Spot:', slotIds);

      try {
        // Direkte UPDATE Query statt RPC (RPC reactivate_guest_spot existiert nicht)
        const today = new Date().toISOString().split('T')[0];
        const firstSlot = currentGuestSpotDetailData;
        const newStatus = new Date(firstSlot.date_from) <= new Date(today) ? 'active' : 'upcoming';

        const { data, error } = await supabase
          .from('upcoming_slots')
          .update({ status: newStatus })
          .in('id', slotIds)
          .select();

        if (error) throw error;

        showNotification('Guest Spot reaktiviert!', 'success');
        closeGuestSpotDetailModal();

        // ========== INSTANT RELOAD NACH REACTIVATE ==========
        console.log('ðŸ”„ Instant reloading all views after Guest Spot reactivate...');

        const reactivateReloadPromises = [];

        // Reload canceled tab (where we came from) and upcoming (where it goes)
        if (typeof loadCanceledGuestSpotsTab === 'function') {
          reactivateReloadPromises.push(loadCanceledGuestSpotsTab());
        }
        if (typeof loadUpcomingGuestSpotsTab === 'function') {
          reactivateReloadPromises.push(loadUpcomingGuestSpotsTab());
        }

        // Kalender
        if (typeof loadEvents === 'function' && selectedLocationId) {
          reactivateReloadPromises.push(loadEvents(selectedLocationId));
        }

        // Dienstplan
        if (typeof loadDienstplanData === 'function') {
          reactivateReloadPromises.push(loadDienstplanData());
        }

        await Promise.all(reactivateReloadPromises);
        console.log('âœ… All views reloaded after reactivate');
        // ========== ENDE INSTANT RELOAD ==========

      } catch (error) {
        console.error('âŒ Error reactivating Guest Spot:', error);
        showNotification('Fehler: ' + error.message, 'error');
      }
    }

    // ============================================
    // EDIT MODE (Placeholder - will be extended)
    // ============================================

    function openGuestSpotEditMode() {
      console.log('âœï¸ Opening Edit Mode...');

      if (!currentGuestSpotDetailData) return;

      const editContainer = document.getElementById('guestSpotEditMode');
      const viewContainer = document.getElementById('guestSpotViewMode');

      // Build edit form HTML
      const data = currentGuestSpotDetailData;
      const bookingType = data.booking_type || 'external';

      editContainer.innerHTML = `
        <form id="guestSpotEditForm" onsubmit="handleGuestSpotEditSubmit(event)">
          <!-- Date & Time -->
          <div style="margin-bottom:20px;">
            <label style="font-size:12px; font-weight:600; color:#86868b; text-transform:uppercase; display:block; margin-bottom:12px;">Zeitraum</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
              <div>
                <label style="font-size:13px; margin-bottom:4px; display:block;">Start Datum</label>
                <input type="date" id="editGuestSpotDateFrom" value="${data.date_from || ''}" required style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
              </div>
              <div>
                <label style="font-size:13px; margin-bottom:4px; display:block;">End Datum</label>
                <input type="date" id="editGuestSpotDateTo" value="${data.date_to || ''}" required style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
              </div>
              <div>
                <label style="font-size:13px; margin-bottom:4px; display:block;">Start Zeit</label>
                <input type="time" id="editGuestSpotTimeFrom" value="${data.time_from || '10:00'}" required style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
              </div>
              <div>
                <label style="font-size:13px; margin-bottom:4px; display:block;">End Zeit</label>
                <input type="time" id="editGuestSpotTimeTo" value="${data.time_to || '18:00'}" required style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
              </div>
            </div>
          </div>

          <!-- Location Dropdown -->
          <div style="margin-bottom:20px;">
            <label style="font-size:12px; font-weight:600; color:#86868b; text-transform:uppercase; display:block; margin-bottom:8px;">Location</label>
            <select id="editGuestSpotLocation" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; background:white;">
              ${(window.locationsCache || []).map(loc =>
                `<option value="${loc.id}" ${loc.id === data.location_id ? 'selected' : ''}>${loc.name}${loc.city ? ' (' + loc.city + ')' : ''}</option>`
              ).join('')}
            </select>
          </div>

          <!-- Booking Type (Read-Only Display) -->
          <div style="margin-bottom:20px; padding:12px; background:rgba(142,142,147,0.08); border-radius:8px;">
            <span style="font-size:12px; color:#86868b;">Buchungstyp (nicht Ã¤nderbar):</span>
            <span style="font-weight:600; margin-left:8px;">${bookingType === 'internal' ? 'Interne Buchung' : 'Externe Artist Buchung'}</span>
          </div>

          <!-- Payment Fields based on booking type -->
          ${bookingType === 'internal' ? `
            <div style="margin-bottom:20px; padding:16px; background:rgba(52, 199, 89, 0.08); border-radius:12px;">
              <div style="font-size:13px; font-weight:600; color:#34c759; margin-bottom:12px;">Zahlungsinformationen</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div>
                  <label style="font-size:13px; margin-bottom:4px; display:block;">Anzahlung (â‚¬)</label>
                  <input type="number" id="editGuestSpotDeposit" value="${data.deposit_amount || 0}" step="0.01" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
                </div>
                <div>
                  <label style="font-size:13px; margin-bottom:4px; display:block;">Vor Ort (â‚¬)</label>
                  <input type="number" id="editGuestSpotOnsite" value="${data.onsite_deposit || 0}" step="0.01" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
                </div>
              </div>
              <div style="margin-top:12px;">
                <label style="font-size:13px; margin-bottom:4px; display:block;">Zahlungsnotiz</label>
                <input type="text" id="editGuestSpotPaymentNotes" value="${data.payment_notes || ''}" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
              </div>
            </div>
          ` : `
            <div style="margin-bottom:20px; padding:16px; background:rgba(0, 122, 255, 0.08); border-radius:12px;">
              <div style="font-size:13px; font-weight:600; color:#007aff; margin-bottom:12px;">Zahlungsinformationen</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div>
                  <label style="font-size:13px; margin-bottom:4px; display:block;">Total Preis (â‚¬)</label>
                  <input type="number" id="editGuestSpotTotalPrice" value="${data.total_price || 0}" step="0.01" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
                </div>
                <div>
                  <label style="font-size:13px; margin-bottom:4px; display:block;">Deposit (â‚¬)</label>
                  <input type="number" id="editGuestSpotDeposit" value="${data.deposit_amount || 0}" step="0.01" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
                </div>
                <div>
                  <label style="font-size:13px; margin-bottom:4px; display:block;">Studio Share (â‚¬)</label>
                  <input type="number" id="editGuestSpotStudioShare" value="${data.studio_share || 0}" step="0.01" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
                </div>
                <div>
                  <label style="font-size:13px; margin-bottom:4px; display:block;">Artist Share (â‚¬)</label>
                  <input type="number" id="editGuestSpotArtistShare" value="${data.artist_share || 0}" step="0.01" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
                </div>
              </div>
              <div style="margin-top:12px;">
                <label style="font-size:13px; margin-bottom:4px; display:block;">Zahlungsnotiz</label>
                <input type="text" id="editGuestSpotPaymentNotes" value="${data.payment_notes || ''}" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.1); border-radius:8px;">
              </div>
            </div>
          `}

          <!-- Actions -->
          <div style="display:flex; gap:12px; justify-content:flex-end; padding-top:16px; border-top:1px solid rgba(0,0,0,0.1);">
            <button type="button" onclick="closeGuestSpotEditMode()" style="padding:10px 20px; border:1px solid rgba(0,0,0,0.1); border-radius:8px; background:white; cursor:pointer;">Abbrechen</button>
            <button type="submit" style="padding:10px 20px; border:none; border-radius:8px; background:#1d1d1f; color:white; cursor:pointer;">Speichern</button>
          </div>
        </form>
      `;

      // Switch view
      viewContainer.style.display = 'none';
      editContainer.style.display = 'block';
    }

    function closeGuestSpotEditMode() {
      document.getElementById('guestSpotViewMode').style.display = 'block';
      document.getElementById('guestSpotEditMode').style.display = 'none';
    }

    async function handleGuestSpotEditSubmit(e) {
      e.preventDefault();

      if (!currentGuestSpotDetailData) return;

      const slotIds = JSON.parse(document.getElementById('guestSpotDetailSlotIds').value || '[]');
      const bookingType = currentGuestSpotDetailData.booking_type || 'external';

      console.log('ðŸ’¾ Saving Guest Spot edits...');

      const updateData = {
        date_from: document.getElementById('editGuestSpotDateFrom').value,
        date_to: document.getElementById('editGuestSpotDateTo').value,
        time_from: document.getElementById('editGuestSpotTimeFrom').value,
        time_to: document.getElementById('editGuestSpotTimeTo').value,
        location_id: document.getElementById('editGuestSpotLocation')?.value || currentGuestSpotDetailData.location_id,
        payment_notes: document.getElementById('editGuestSpotPaymentNotes').value || null
      };

      if (bookingType === 'internal') {
        updateData.deposit_amount = parseFloat(document.getElementById('editGuestSpotDeposit').value) || 0;
        updateData.onsite_deposit = parseFloat(document.getElementById('editGuestSpotOnsite').value) || 0;
      } else {
        updateData.total_price = parseFloat(document.getElementById('editGuestSpotTotalPrice').value) || 0;
        updateData.deposit_amount = parseFloat(document.getElementById('editGuestSpotDeposit').value) || 0;
        updateData.studio_share = parseFloat(document.getElementById('editGuestSpotStudioShare').value) || 0;
        updateData.artist_share = parseFloat(document.getElementById('editGuestSpotArtistShare').value) || 0;
      }

      try {
        const { error } = await supabase
          .from('upcoming_slots')
          .update(updateData)
          .in('id', slotIds);

        if (error) throw error;

        showNotification('Guest Spot aktualisiert', 'success');
        closeGuestSpotDetailModal();

        // Reload data
        if (typeof loadWaitlistSlots === 'function') {
          await loadWaitlistSlots(currentWaitlistLocation);
        }
        if (typeof loadCalendarData === 'function') {
          await loadCalendarData();
        }

      } catch (error) {
        console.error('âŒ Error updating Guest Spot:', error);
        showNotification('Fehler: ' + error.message, 'error');
      }
    }

    // ============================================
    // INITIALIZE EVENT LISTENERS
    // ============================================

    function initGuestSpotSystem() {
      console.log('ðŸŽ¬ Initializing Guest Spot System...');

      // Init artist search
      initGuestSpotArtistSearch();

      // Date validation is now handled by custom date picker
      console.log('ðŸ“… Guest Spot using custom date picker');

      // Form submit handler
      const form = document.getElementById('createGuestSpotForm');
      if (form) {
        form.addEventListener('submit', handleCreateGuestSpotSubmit);
      }

      // Modal backdrop click to close
      const createModal = document.getElementById('createGuestSpotModal');
      if (createModal) {
        createModal.addEventListener('click', (e) => {
          if (e.target === createModal) {
            closeCreateGuestSpotModal();
          }
        });
      }

      const detailModal = document.getElementById('guestSpotDetailModal');
      if (detailModal) {
        detailModal.addEventListener('click', (e) => {
          if (e.target === detailModal) {
            closeGuestSpotDetailModal();
          }
        });
      }

      console.log('âœ… Guest Spot System initialized');
    }

    // Auto-init when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initGuestSpotSystem);
    } else {
      // DOM already loaded, init now
      setTimeout(initGuestSpotSystem, 100);
    }

    // ============================================
    // GUEST SPOT CALENDAR CLICK HANDLER
    // ============================================

    async function handleGuestSpotCalendarClick(guestSpotCalendarId) {
      console.log('ðŸ“… Guest Spot calendar entry clicked:', guestSpotCalendarId);

      // Extract the actual ID (remove 'guest-spot-' prefix if present)
      const calendarEntryId = guestSpotCalendarId.replace('guest-spot-', '');

      try {
        // Load the full guest spot data from the view
        const { data, error } = await supabase
          .from('guest_spot_calendar_view')
          .select('*')
          .eq('id', calendarEntryId)
          .single();

        if (error) throw error;

        if (data) {
          // Now load the parent guest spot with all info
          const { data: slotData, error: slotError } = await supabase
            .from('upcoming_slots_grouped')
            .select('*')
            .eq('id', data.guest_spot_id)
            .single();

          if (slotError) {
            console.warn('Could not load grouped slot, using calendar view data');
            // Use calendar view data as fallback
            openGuestSpotDetailModal({
              ...data,
              id: data.guest_spot_id,
              all_slot_ids: [data.guest_spot_id]
            });
          } else {
            openGuestSpotDetailModal(slotData);
          }
        }
      } catch (err) {
        console.error('Error loading guest spot details:', err);
        if (typeof window.showNotification === 'function') {
          window.showNotification('Fehler beim Laden der Details', 'error');
        }
      }
    }

    window.handleGuestSpotCalendarClick = handleGuestSpotCalendarClick;

    // ============================================
    // CUSTOM DATE PICKER FOR GUEST SPOT
    // ============================================

    let guestSpotDatePickerState = {
      activeField: null, // 'from' or 'to'
      viewMonth: new Date().getMonth(),
      viewYear: new Date().getFullYear(),
      selectedFrom: null,
      selectedTo: null
    };

    function openGuestSpotDatePicker(field) {
      console.log('ðŸ“… Opening date picker for:', field);

      guestSpotDatePickerState.activeField = field;

      // Close all popups first
      document.querySelectorAll('.guest-spot-calendar-popup').forEach(p => p.classList.remove('active'));

      // Get the popup element
      const popupId = field === 'from' ? 'guestSpotDateFromPopup' : 'guestSpotDateToPopup';
      const popup = document.getElementById(popupId);

      if (!popup) return;

      // Set initial view month based on selected date or today
      const today = new Date();
      if (field === 'from' && guestSpotDatePickerState.selectedFrom) {
        guestSpotDatePickerState.viewMonth = guestSpotDatePickerState.selectedFrom.getMonth();
        guestSpotDatePickerState.viewYear = guestSpotDatePickerState.selectedFrom.getFullYear();
      } else if (field === 'to' && guestSpotDatePickerState.selectedTo) {
        guestSpotDatePickerState.viewMonth = guestSpotDatePickerState.selectedTo.getMonth();
        guestSpotDatePickerState.viewYear = guestSpotDatePickerState.selectedTo.getFullYear();
      } else {
        guestSpotDatePickerState.viewMonth = today.getMonth();
        guestSpotDatePickerState.viewYear = today.getFullYear();
      }

      renderGuestSpotDatePicker(popup, field);
      popup.classList.add('active');

      // Close on outside click
      setTimeout(() => {
        document.addEventListener('click', closeGuestSpotDatePickerOnOutsideClick);
      }, 10);
    }

    function closeGuestSpotDatePickerOnOutsideClick(e) {
      if (!e.target.closest('.guest-spot-date-picker-container')) {
        document.querySelectorAll('.guest-spot-calendar-popup').forEach(p => p.classList.remove('active'));
        document.removeEventListener('click', closeGuestSpotDatePickerOnOutsideClick);
      }
    }

    function renderGuestSpotDatePicker(popup, field) {
      const state = guestSpotDatePickerState;
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const monthNames = ['Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni',
                          'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
      const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];

      // Calculate min date
      let minDate = new Date(today);
      if (field === 'to' && state.selectedFrom) {
        minDate = new Date(state.selectedFrom);
      }

      // Check if we can go to previous month
      const canGoPrev = new Date(state.viewYear, state.viewMonth, 1) > minDate;

      // Build calendar
      const firstDay = new Date(state.viewYear, state.viewMonth, 1);
      const lastDay = new Date(state.viewYear, state.viewMonth + 1, 0);

      // Adjust for Monday start (0 = Monday, 6 = Sunday)
      let startDayOfWeek = firstDay.getDay() - 1;
      if (startDayOfWeek < 0) startDayOfWeek = 6;

      let html = `
        <div class="guest-spot-calendar-header">
          <button type="button" class="guest-spot-calendar-nav" onclick="navigateGuestSpotDatePicker(-1, '${field}')" ${!canGoPrev ? 'disabled' : ''}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </button>
          <span class="guest-spot-calendar-title">${monthNames[state.viewMonth]} ${state.viewYear}</span>
          <button type="button" class="guest-spot-calendar-nav" onclick="navigateGuestSpotDatePicker(1, '${field}')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6"/>
            </svg>
          </button>
        </div>
        <div class="guest-spot-calendar-weekdays">
          ${dayNames.map(d => `<span>${d}</span>`).join('')}
        </div>
        <div class="guest-spot-calendar-days">
      `;

      // Empty cells before first day
      for (let i = 0; i < startDayOfWeek; i++) {
        html += `<button type="button" class="guest-spot-calendar-day other-month" disabled></button>`;
      }

      // Days of month
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(state.viewYear, state.viewMonth, day);
        const dateStr = formatDateForInput(date);

        const isToday = date.getTime() === today.getTime();
        const isDisabled = date < minDate;
        const isSelectedFrom = state.selectedFrom && date.getTime() === state.selectedFrom.getTime();
        const isSelectedTo = state.selectedTo && date.getTime() === state.selectedTo.getTime();
        const isSelected = (field === 'from' && isSelectedFrom) || (field === 'to' && isSelectedTo);

        let classes = 'guest-spot-calendar-day';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';

        html += `<button type="button" class="${classes}"
          ${isDisabled ? 'disabled' : `onclick="selectGuestSpotDate('${dateStr}', '${field}')"`}
        >${day}</button>`;
      }

      html += `</div>`;

      popup.innerHTML = html;
    }

    function navigateGuestSpotDatePicker(direction, field) {
      const state = guestSpotDatePickerState;
      state.viewMonth += direction;

      if (state.viewMonth > 11) {
        state.viewMonth = 0;
        state.viewYear++;
      } else if (state.viewMonth < 0) {
        state.viewMonth = 11;
        state.viewYear--;
      }

      const popupId = field === 'from' ? 'guestSpotDateFromPopup' : 'guestSpotDateToPopup';
      const popup = document.getElementById(popupId);
      if (popup) {
        renderGuestSpotDatePicker(popup, field);
      }
    }

    function selectGuestSpotDate(dateStr, field) {
      console.log('ðŸ“… Date selected:', dateStr, 'for field:', field);

      const date = new Date(dateStr);
      const state = guestSpotDatePickerState;

      if (field === 'from') {
        state.selectedFrom = date;
        document.getElementById('guestSpotDateFrom').value = dateStr;
        document.getElementById('guestSpotDateFromDisplay').textContent = formatDateForDisplay(date);

        // If end date is before start date, reset it
        if (state.selectedTo && state.selectedTo < date) {
          state.selectedTo = null;
          document.getElementById('guestSpotDateTo').value = '';
          document.getElementById('guestSpotDateToDisplay').textContent = 'Datum wÃ¤hlen...';
        }
      } else {
        state.selectedTo = date;
        document.getElementById('guestSpotDateTo').value = dateStr;
        document.getElementById('guestSpotDateToDisplay').textContent = formatDateForDisplay(date);
      }

      // Close popup
      document.querySelectorAll('.guest-spot-calendar-popup').forEach(p => p.classList.remove('active'));
      document.removeEventListener('click', closeGuestSpotDatePickerOnOutsideClick);
    }

    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDateForDisplay(date) {
      const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
      return date.toLocaleDateString('de-DE', options);
    }

    function resetGuestSpotDatePicker() {
      guestSpotDatePickerState.selectedFrom = null;
      guestSpotDatePickerState.selectedTo = null;
      const fromInput = document.getElementById('guestSpotDateFrom');
      const toInput = document.getElementById('guestSpotDateTo');
      const fromDisplay = document.getElementById('guestSpotDateFromDisplay');
      const toDisplay = document.getElementById('guestSpotDateToDisplay');
      if (fromInput) fromInput.value = '';
      if (toInput) toInput.value = '';
      if (fromDisplay) fromDisplay.textContent = 'Datum wÃ¤hlen...';
      if (toDisplay) toDisplay.textContent = 'Datum wÃ¤hlen...';
    }

    // Export date picker functions
    window.openGuestSpotDatePicker = openGuestSpotDatePicker;
    window.navigateGuestSpotDatePicker = navigateGuestSpotDatePicker;
    window.selectGuestSpotDate = selectGuestSpotDate;
    window.resetGuestSpotDatePicker = resetGuestSpotDatePicker;

    // ============================================
    // OPEN GUEST SPOT DETAIL FROM LIST (UPCOMING/PREVIOUS)
    // ============================================

    // DEPRECATED: Diese Funktion wurde durch openGuestSpotDetailFromCache ersetzt
    // Bleibt als Fallback fÃ¼r alte Aufrufe
    async function openGuestSpotDetailFromList(slotId) {
      console.log('ðŸ“‹ openGuestSpotDetailFromList called, slot:', slotId);

      // Versuche zuerst aus Cache
      const cached = getCachedGuestSpotSlot(slotId);
      if (cached) {
        openGuestSpotDetailModal(cached);
        return;
      }

      // Fallback: Lade aus Datenbank
      try {
        // Versuche upcoming_slots_grouped
        let { data, error } = await supabase
          .from('upcoming_slots_grouped')
          .select('*')
          .eq('id', slotId)
          .single();

        if (error || !data) {
          // Versuche previous_guest_spots_grouped
          const prevResult = await supabase
            .from('previous_guest_spots_grouped')
            .select('*')
            .eq('id', slotId)
            .single();

          data = prevResult.data;
          error = prevResult.error;
        }

        if (error || !data) {
          // Letzter Versuch: Direkt aus upcoming_slots
          const directResult = await supabase
            .from('upcoming_slots')
            .select(`
              *,
              artist:artists(id, name, instagram, profile_picture_url),
              location:locations(id, name, city)
            `)
            .eq('id', slotId)
            .single();

          if (directResult.data) {
            data = {
              ...directResult.data,
              artist_name: directResult.data.artist?.name,
              instagram: directResult.data.artist?.instagram,
              profile_picture_url: directResult.data.artist?.profile_picture_url,
              location_name: directResult.data.location?.name,
              location_city: directResult.data.location?.city,
              all_slot_ids: [slotId]
            };
          }
        }

        if (data) {
          // Cache fÃ¼r zukÃ¼nftige Aufrufe
          cacheGuestSpotSlot(data);
          openGuestSpotDetailModal(data);
        } else {
          console.error('Slot nicht gefunden:', slotId);
          if (typeof window.showNotification === 'function') {
            window.showNotification('Slot nicht gefunden', 'error');
          }
        }
      } catch (err) {
        console.error('Fehler beim Laden:', err);
        if (typeof window.showNotification === 'function') {
          window.showNotification('Fehler beim Laden: ' + err.message, 'error');
        }
      }
    }

    window.openGuestSpotDetailFromList = openGuestSpotDetailFromList;

    // ============================================
    // WINDOW EXPORTS
    // ============================================

    window.openCreateGuestSpotModal = openCreateGuestSpotModal;
    window.closeCreateGuestSpotModal = closeCreateGuestSpotModal;
    window.openGuestSpotDetailModal = openGuestSpotDetailModal;
    window.closeGuestSpotDetailModal = closeGuestSpotDetailModal;
    window.switchGuestSpotBookingType = switchGuestSpotBookingType;
    window.selectGuestSpotArtist = selectGuestSpotArtist;
    window.clearSelectedGuestSpotArtist = clearSelectedGuestSpotArtist;
    window.openAddArtistFromGuestSpot = openAddArtistFromGuestSpot;
    window.toggleGuestSpotPaid = toggleGuestSpotPaid;
    window.cancelGuestSpot = cancelGuestSpot;
    window.deleteGuestSpot = deleteGuestSpot;
    window.reactivateGuestSpot = reactivateGuestSpot;
    window.openGuestSpotEditMode = openGuestSpotEditMode;
    window.closeGuestSpotEditMode = closeGuestSpotEditMode;
    window.handleGuestSpotEditSubmit = handleGuestSpotEditSubmit;

    // ============================================
    // GUEST SPOT APPOINTMENTS SYSTEM
    // ============================================

    // Globale Variable fÃ¼r aktuellen Guest Spot
    let currentGuestSpotForAppointment = null;

    // Customer fÃ¼r Add Appointment Panel
    let selectedGsAptCustomer = null;
    let gsAptAppointmentType = 'new_tattoo'; // Default

    // Appointments fÃ¼r einen Guest Spot laden
    async function loadGuestSpotAppointments(guestSpotId, shareArtist, shareStudio, isSelfBooking) {
      const listContainer = document.getElementById('guestSpotAppointmentsList');
      const addBtnContainer = document.getElementById('addAppointmentBtnContainer');

      if (!listContainer) return;

      // Add Appointment Button nur bei Self Booking anzeigen
      if (addBtnContainer) {
        addBtnContainer.style.display = isSelfBooking ? 'block' : 'none';
      }

      // Speichere Guest Spot Info fÃ¼r Add Appointment
      currentGuestSpotForAppointment = {
        id: guestSpotId,
        shareArtist: shareArtist || 75,
        shareStudio: shareStudio || 25
      };

      try {
        // Lade Appointments die zu diesem Guest Spot gehÃ¶ren
        const { data: appointments, error } = await supabase
          .from('appointments')
          .select(`
            id, start, end, price, deposit_amount, artist_share_amount, studio_share_amount, status, notes,
            customer:customers(id, first_name, last_name, email, phone)
          `)
          .eq('guest_spot_id', guestSpotId)
          .order('start', { ascending: true });

        if (error) {
          console.error('Error loading guest spot appointments:', error);
          listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#ff3b30;">Fehler beim Laden</div>';
          return;
        }

        if (!appointments || appointments.length === 0) {
          listContainer.innerHTML = `
            <div style="padding:20px; text-align:center; color:#86868b;">
              <p style="margin:0;">Keine Appointments verknÃ¼pft</p>
              <p style="margin:8px 0 0 0; font-size:12px;">Appointments werden automatisch gematched wenn Artist + Datum Ã¼bereinstimmen</p>
            </div>
          `;
          return;
        }

        // Render Appointments
        listContainer.innerHTML = appointments.map(apt => {
          const customerName = apt.customer
            ? `${apt.customer.first_name || ''} ${apt.customer.last_name || ''}`.trim() || 'Unknown'
            : 'Unknown Customer';

          const aptDate = apt.start ? new Date(apt.start) : null;
          const dateStr = aptDate ? aptDate.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' }) : '-';
          const timeStr = aptDate ? aptDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '';

          const price = parseFloat(apt.price) || 0;
          const deposit = parseFloat(apt.deposit_amount) || 0;
          const artistAmount = apt.artist_share_amount || (price * (shareArtist || 75) / 100);
          const studioAmount = apt.studio_share_amount || (price * (shareStudio || 25) / 100);

          const statusColors = {
            'scheduled': { bg: '#007aff', text: 'Geplant' },
            'completed': { bg: '#34c759', text: 'Abgeschlossen' },
            'canceled': { bg: '#ff3b30', text: 'Storniert' },
            'no_show': { bg: '#ff9500', text: 'No Show' }
          };
          const status = statusColors[apt.status] || { bg: '#86868b', text: apt.status || 'Unbekannt' };

          return `
            <div class="guest-spot-appointment-card" style="
              padding:16px;
              background:white;
              border-radius:10px;
              border:1px solid rgba(0,0,0,0.08);
              margin-bottom:12px;
              box-shadow:0 1px 3px rgba(0,0,0,0.04);
            ">
              <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                <div>
                  <div style="font-weight:600; font-size:15px; color:#1d1d1f;">${customerName}</div>
                  <div style="font-size:13px; color:#86868b; margin-top:2px; display:flex; align-items:center; gap:4px;"><span style="display:inline-flex;">${GUEST_SPOT_ICONS.calendar}</span> ${dateStr} ${timeStr ? '<span style="margin:0 4px;">â€¢</span><span style="display:inline-flex;">' + GUEST_SPOT_ICONS.clock + '</span> ' + timeStr : ''}</div>
                </div>
                <span style="
                  padding:4px 10px;
                  border-radius:6px;
                  font-size:11px;
                  font-weight:600;
                  background:${status.bg};
                  color:white;
                ">${status.text}</span>
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:12px; background:rgba(0,0,0,0.02); border-radius:8px;">
                <div>
                  <div style="font-size:11px; color:#86868b; margin-bottom:2px;">Gesamtpreis</div>
                  <div style="font-size:16px; font-weight:600; color:#1d1d1f;">â‚¬${price.toFixed(2)}</div>
                </div>
                <div>
                  <div style="font-size:11px; color:#86868b; margin-bottom:2px;">Deposit</div>
                  <div style="font-size:16px; font-weight:600; color:#1d1d1f;">â‚¬${deposit.toFixed(2)}</div>
                </div>
                <div>
                  <div style="font-size:11px; color:#86868b; margin-bottom:2px;">Studio (${shareStudio || 25}%)</div>
                  <div style="font-size:14px; font-weight:500; color:#1d1d1f;">â‚¬${studioAmount.toFixed(2)}</div>
                </div>
                <div>
                  <div style="font-size:11px; color:#86868b; margin-bottom:2px;">Artist (${shareArtist || 75}%)</div>
                  <div style="font-size:14px; font-weight:500; color:#34c759;">â‚¬${(artistAmount - deposit).toFixed(2)}</div>
                  ${deposit > 0 ? `<div style="font-size:10px; color:#86868b;">(â‚¬${artistAmount.toFixed(2)} - â‚¬${deposit.toFixed(2)} Deposit)</div>` : ''}
                </div>
              </div>

              ${apt.notes ? `<div style="margin-top:12px; padding:8px 12px; background:rgba(255,204,0,0.1); border-radius:6px; font-size:12px; color:#86868b; display:flex; align-items:flex-start; gap:6px;"><span style="display:inline-flex; flex-shrink:0;">${GUEST_SPOT_ICONS.notes}</span> ${apt.notes}</div>` : ''}
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Error in loadGuestSpotAppointments:', err);
        listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#ff3b30;">Fehler beim Laden</div>';
      }
    }

    // Window Export
    window.loadGuestSpotAppointments = loadGuestSpotAppointments;

    // Add Appointment Panel fÃ¼r Self-Booking Guest Spots (Slide-in von rechts)
    function openAddGuestSpotAppointmentModal() {
      if (!currentGuestSpotForAppointment || !currentGuestSpotDetailData) {
        showNotification('Kein Guest Spot ausgewÃ¤hlt', 'error');
        return;
      }

      const gs = currentGuestSpotDetailData;
      const dateFrom = gs.date_from;
      const dateTo = gs.date_to;

      // Entferne existierendes Panel falls vorhanden
      const existingPanel = document.getElementById('addGuestSpotAppointmentPanel');
      if (existingPanel) existingPanel.remove();

      // Hole das Guest Spot Detail Modal fÃ¼r relative Positionierung
      const detailModal = document.getElementById('guestSpotDetailModal');
      const modalContent = detailModal ? detailModal.querySelector('.modal') : null;

      if (!modalContent) {
        console.error('Guest Spot Detail Modal nicht gefunden');
        return;
      }

      // Erstelle das Slide-in Panel
      const panelHtml = `
        <div id="addGuestSpotAppointmentPanel" style="
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 560px;
          max-width: 95vw;
          height: 80vh;
          background: white;
          border-radius: 16px;
          border-top-left-radius: 0;
          border-bottom-left-radius: 0;
          transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
          z-index: 9998;
          display: flex;
          flex-direction: column;
          overflow: hidden;
        ">
          <!-- Header -->
          <div style="
            padding: 16px 20px;
            background: white;
            color: #1d1d1f;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
          ">
            <h3 style="margin: 0; font-size: 17px; font-weight: 600;">Add Appointment</h3>
            <button onclick="closeAddGuestSpotAppointmentModal()" style="
              background: rgba(0,0,0,0.05);
              border: none;
              border-radius: 6px;
              padding: 6px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: background 0.2s;
            " onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.05)'">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#1d1d1f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>

          <!-- Content -->
          <div style="flex: 1; overflow-y: auto; padding: 20px;">
            <!-- Zeitraum Info -->
            <div style="
              padding: 12px 16px;
              background: white;
              border-radius: 10px;
              margin-bottom: 20px;
              border: 1px solid rgba(0,0,0,0.06);
            ">
              <div style="font-size: 12px; color: #86868b; margin-bottom: 4px;">Guest Spot Zeitraum</div>
              <div style="font-size: 14px; font-weight: 500; color: #1d1d1f;">
                ${new Date(dateFrom).toLocaleDateString('de-DE')} - ${new Date(dateTo).toLocaleDateString('de-DE')}
              </div>
            </div>

            <!-- Customer Section -->
            <div style="margin-bottom: 20px;">
              <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px; color: #1d1d1f;">Kunde</label>

              <!-- Selected Customer Display (hidden initially) -->
              <div id="gsAptSelectedCustomer" style="display: none; padding: 12px; background: white; border-radius: 10px; border: 2px solid #34c759; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 36px; height: 36px; border-radius: 50%; background: #f5f5f7; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #1d1d1f;" id="gsAptCustomerAvatar">?</div>
                    <div>
                      <div style="font-weight: 600; font-size: 14px; color: #1d1d1f;" id="gsAptCustomerName">-</div>
                      <div style="font-size: 12px; color: #86868b;" id="gsAptCustomerEmail">-</div>
                    </div>
                  </div>
                  <button type="button" onclick="clearGsAptCustomer()" style="
                    background: none;
                    border: none;
                    color: #ff3b30;
                    cursor: pointer;
                    padding: 4px;
                    display: flex;
                    align-items: center;
                  ">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Search Input -->
              <div id="gsAptCustomerSearchContainer" style="position: relative;">
                <div style="display: flex; gap: 8px;">
                  <div style="flex: 1; position: relative;">
                    <input type="text" id="gsAptCustomerSearch" placeholder="Kunde suchen..." oninput="searchGsAptCustomers(this.value)" style="
                      width: 100%;
                      padding: 12px 12px 12px 36px;
                      border: 1px solid rgba(0,0,0,0.1);
                      border-radius: 10px;
                      font-size: 14px;
                      background: white;
                      box-sizing: border-box;
                    ">
                    <svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #86868b;" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"></circle>
                      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                  </div>
                  <button type="button" onclick="openGsAptAddCustomerModal()" style="
                    padding: 12px;
                    border: none;
                    border-radius: 10px;
                    background: #1d1d1f;
                    color: white;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  " title="Neuen Kunden anlegen">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </button>
                </div>

                <!-- Search Results Dropdown -->
                <div id="gsAptCustomerResults" style="
                  display: none;
                  position: absolute;
                  top: 100%;
                  left: 0;
                  right: 48px;
                  background: white;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 10px;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                  max-height: 200px;
                  overflow-y: auto;
                  z-index: 100;
                  margin-top: 4px;
                "></div>
              </div>
            </div>

            <!-- Appointment Type Selection -->
            <div style="margin-bottom: 20px;">
              <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 10px; color: #1d1d1f;">Termin-Typ</label>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">

                <!-- New Tattoo -->
                <div class="gs-apt-type-card" data-type="new_tattoo" onclick="selectGsAptType('new_tattoo')" style="
                  padding: 16px 12px;
                  background: rgba(52, 199, 89, 0.05);
                  border: 2px solid #34c759;
                  border-radius: 12px;
                  cursor: pointer;
                  text-align: center;
                  transition: all 0.2s;
                ">
                  <div style="color: #34c759; margin-bottom: 6px; display: flex; justify-content: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                  </div>
                  <div style="font-size: 13px; font-weight: 500; color: #1d1d1f;">New Tattoo</div>
                </div>

                <!-- Continuing Tattoo -->
                <div class="gs-apt-type-card" data-type="continuing_tattoo" onclick="selectGsAptType('continuing_tattoo')" style="
                  padding: 16px 12px;
                  background: white;
                  border: 2px solid rgba(0,0,0,0.1);
                  border-radius: 12px;
                  cursor: pointer;
                  text-align: center;
                  transition: all 0.2s;
                ">
                  <div style="color: #007aff; margin-bottom: 6px; display: flex; justify-content: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                      <path d="M21 3v5h-5"></path>
                    </svg>
                  </div>
                  <div style="font-size: 13px; font-weight: 500; color: #1d1d1f;">Continuing</div>
                </div>

                <!-- Touch Up -->
                <div class="gs-apt-type-card" data-type="touch_up" onclick="selectGsAptType('touch_up')" style="
                  padding: 16px 12px;
                  background: white;
                  border: 2px solid rgba(0,0,0,0.1);
                  border-radius: 12px;
                  cursor: pointer;
                  text-align: center;
                  transition: all 0.2s;
                ">
                  <div style="color: #ff9500; margin-bottom: 6px; display: flex; justify-content: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 20h9"></path>
                      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                  </div>
                  <div style="font-size: 13px; font-weight: 500; color: #1d1d1f;">Touch Up</div>
                </div>

                <!-- Selfbooking -->
                <div class="gs-apt-type-card" data-type="selfbooking" onclick="selectGsAptType('selfbooking')" style="
                  padding: 16px 12px;
                  background: white;
                  border: 2px solid rgba(0,0,0,0.1);
                  border-radius: 12px;
                  cursor: pointer;
                  text-align: center;
                  transition: all 0.2s;
                ">
                  <div style="color: #af52de; margin-bottom: 6px; display: flex; justify-content: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                  </div>
                  <div style="font-size: 13px; font-weight: 500; color: #1d1d1f;">Selfbooking</div>
                </div>

              </div>
              <input type="hidden" id="gsAptTypeInput" value="new_tattoo">
            </div>

            <!-- Datum -->
            <div style="margin-bottom: 16px;">
              <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px; color: #1d1d1f;">Datum</label>
              <input type="date" id="gsAptDate" min="${dateFrom}" max="${dateTo}" required style="
                width: 100%;
                padding: 12px;
                border: 1px solid rgba(0,0,0,0.1);
                border-radius: 10px;
                font-size: 14px;
                background: white;
                box-sizing: border-box;
              ">
            </div>

            <!-- Zeit -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
              <div>
                <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px; color: #1d1d1f;">Start</label>
                <input type="time" id="gsAptTimeStart" value="10:00" required style="
                  width: 100%;
                  padding: 12px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 10px;
                  font-size: 14px;
                  background: white;
                  box-sizing: border-box;
                ">
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px; color: #1d1d1f;">Ende</label>
                <input type="time" id="gsAptTimeEnd" value="18:00" required style="
                  width: 100%;
                  padding: 12px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 10px;
                  font-size: 14px;
                  background: white;
                  box-sizing: border-box;
                ">
              </div>
            </div>

            <!-- Preis und Deposit -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
              <div>
                <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px; color: #1d1d1f;">Gesamtpreis (â‚¬)</label>
                <input type="number" id="gsAptPrice" step="0.01" min="0" placeholder="0.00" required style="
                  width: 100%;
                  padding: 12px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 10px;
                  font-size: 14px;
                  background: white;
                  box-sizing: border-box;
                " oninput="calculateGsAptShares()">
              </div>
              <div>
                <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px; color: #1d1d1f;">Deposit (â‚¬)</label>
                <input type="number" id="gsAptDeposit" step="0.01" min="0" placeholder="0.00" style="
                  width: 100%;
                  padding: 12px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 10px;
                  font-size: 14px;
                  background: white;
                  box-sizing: border-box;
                " oninput="calculateGsAptShares()">
              </div>
            </div>

            <!-- Share Berechnung -->
            <div style="
              padding: 16px;
              background: white;
              border-radius: 10px;
              margin-bottom: 16px;
              border: 1px solid rgba(0,0,0,0.06);
            ">
              <div style="font-size: 12px; font-weight: 600; color: #86868b; text-transform: uppercase; margin-bottom: 12px;">Share Split</div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-size: 13px; color: #86868b;">Studio (${currentGuestSpotForAppointment?.shareStudio || 25}%)</span>
                <span id="gsAptStudioShare" style="font-size: 14px; font-weight: 600; color: #1d1d1f;">â‚¬0.00</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="font-size: 13px; color: #86868b;">Artist (${currentGuestSpotForAppointment?.shareArtist || 75}%) - Deposit</span>
                <span id="gsAptArtistShare" style="font-size: 14px; font-weight: 600; color: #34c759;">â‚¬0.00</span>
              </div>
            </div>

            <!-- Notizen -->
            <div style="margin-bottom: 20px;">
              <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px; color: #1d1d1f;">Notizen (optional)</label>
              <textarea id="gsAptNotes" rows="3" placeholder="ZusÃ¤tzliche Infos..." style="
                width: 100%;
                padding: 12px;
                border: 1px solid rgba(0,0,0,0.1);
                border-radius: 10px;
                font-size: 14px;
                resize: vertical;
                background: white;
                box-sizing: border-box;
                font-family: inherit;
              "></textarea>
            </div>
          </div>

          <!-- Footer Actions -->
          <div style="
            padding: 16px 20px;
            background: white;
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            gap: 12px;
            flex-shrink: 0;
          ">
            <button type="button" onclick="closeAddGuestSpotAppointmentModal()" style="
              flex: 1;
              padding: 12px;
              border: 1px solid rgba(0,0,0,0.1);
              border-radius: 10px;
              background: white;
              color: #1d1d1f;
              font-size: 14px;
              font-weight: 500;
              cursor: pointer;
              transition: background 0.2s;
            " onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
              Abbrechen
            </button>
            <button type="button" onclick="saveGuestSpotAppointment()" style="
              flex: 1;
              padding: 12px;
              border: none;
              border-radius: 10px;
              background: #1d1d1f;
              color: white;
              font-size: 14px;
              font-weight: 500;
              cursor: pointer;
              transition: background 0.2s;
            " onmouseover="this.style.background='#3a3a3c'" onmouseout="this.style.background='#1d1d1f'">
              Speichern
            </button>
          </div>
        </div>
      `;

      // FÃ¼ge Panel als Sibling NEBEN dem Modal ein (nicht innerhalb)
      modalContent.insertAdjacentHTML('afterend', panelHtml);

      // Setze Default-Datum
      const dateInput = document.getElementById('gsAptDate');
      if (dateInput) dateInput.value = dateFrom;

      // Trigger Slide-in Animation
      // ERST Modal nach links, DANN Panel nach rechts hervor
      requestAnimationFrame(() => {
        const guestSpotModal = document.querySelector('#guestSpotDetailModal .modal');

        // Modal sofort nach links schieben
        if (guestSpotModal) {
          guestSpotModal.classList.add('guest-spot-modal-shifted');
        }

        // Panel mit minimalem Delay nach rechts (damit Modal zuerst weg ist)
        setTimeout(() => {
          const panel = document.getElementById('addGuestSpotAppointmentPanel');
          if (panel) {
            // Panel slided nach rechts (295px fÃ¼r saubere Trennung)
            panel.style.transform = 'translate(calc(-50% + 295px), -50%)';
          }
        }, 50);
      });

      // Reset Customer und Type Selection
      selectedGsAptCustomer = null;
      gsAptAppointmentType = 'new_tattoo';

      console.log('âœ… Add Appointment Panel opened (slide-in)');
    }

    function closeAddGuestSpotAppointmentModal() {
      const panel = document.getElementById('addGuestSpotAppointmentPanel');

      if (panel) {
        // ERST: Panel slided zurÃ¼ck hinter das Modal
        panel.style.transform = 'translate(-50%, -50%)';

        // DANN: Nach der Animation das Modal zurÃ¼ck zur Mitte
        // VerzÃ¶gerung damit Panel zuerst hinter dem Modal verschwindet
        setTimeout(() => {
          const guestSpotModal = document.querySelector('#guestSpotDetailModal .modal');
          if (guestSpotModal) {
            guestSpotModal.classList.remove('guest-spot-modal-shifted');
          }
        }, 50);

        // Entferne nach Animation
        setTimeout(() => {
          panel.remove();
        }, 300);
      }

      // Fallback fÃ¼r altes Modal (falls noch vorhanden)
      const oldModal = document.getElementById('addGuestSpotAppointmentModal');
      if (oldModal) oldModal.remove();

      // Reset selections
      selectedGsAptCustomer = null;
      gsAptAppointmentType = 'new_tattoo';
    }

    function calculateGsAptShares() {
      const price = parseFloat(document.getElementById('gsAptPrice')?.value) || 0;
      const deposit = parseFloat(document.getElementById('gsAptDeposit')?.value) || 0;

      const shareArtist = currentGuestSpotForAppointment?.shareArtist || 75;
      const shareStudio = currentGuestSpotForAppointment?.shareStudio || 25;

      const studioAmount = price * shareStudio / 100;
      const artistAmount = (price * shareArtist / 100) - deposit;

      const studioEl = document.getElementById('gsAptStudioShare');
      const artistEl = document.getElementById('gsAptArtistShare');

      if (studioEl) studioEl.textContent = `â‚¬${studioAmount.toFixed(2)}`;
      if (artistEl) artistEl.textContent = `â‚¬${artistAmount.toFixed(2)}`;
    }

    async function saveGuestSpotAppointment() {
      if (!currentGuestSpotForAppointment || !currentGuestSpotDetailData) {
        showNotification('Fehler: Kein Guest Spot ausgewÃ¤hlt', 'error');
        return;
      }

      const gs = currentGuestSpotDetailData;
      const dateVal = document.getElementById('gsAptDate')?.value;
      const timeStart = document.getElementById('gsAptTimeStart')?.value;
      const timeEnd = document.getElementById('gsAptTimeEnd')?.value;
      const price = parseFloat(document.getElementById('gsAptPrice')?.value) || 0;
      const deposit = parseFloat(document.getElementById('gsAptDeposit')?.value) || 0;
      const notes = document.getElementById('gsAptNotes')?.value || null;

      if (!dateVal || !timeStart || !timeEnd || price <= 0) {
        showNotification('Bitte fÃ¼lle alle Pflichtfelder aus', 'error');
        return;
      }

      const shareArtist = currentGuestSpotForAppointment.shareArtist;
      const shareStudio = currentGuestSpotForAppointment.shareStudio;

      // Validierung: Customer muss ausgewÃ¤hlt sein
      if (!selectedGsAptCustomer) {
        showNotification('Bitte einen Kunden auswÃ¤hlen', 'error');
        return;
      }

      const appointmentData = {
        guest_spot_id: gs.id,
        artist_id: gs.artist_id,
        location_id: gs.location_id,
        customer_id: selectedGsAptCustomer.id,
        booking_type: gsAptAppointmentType || 'new_tattoo',
        start: `${dateVal}T${timeStart}:00`,
        end: `${dateVal}T${timeEnd}:00`,
        price: price,
        deposit_amount: deposit,
        artist_share_amount: (price * shareArtist / 100) - deposit,
        studio_share_amount: price * shareStudio / 100,
        status: 'scheduled',
        notes: notes,
        created_at: new Date().toISOString()
      };

      console.log('ðŸ“… Creating Guest Spot Appointment:', {
        guest_spot_id: appointmentData.guest_spot_id,
        artist_id: appointmentData.artist_id,
        location_id: appointmentData.location_id,
        customer_id: appointmentData.customer_id,
        booking_type: appointmentData.booking_type,
        date: appointmentData.start
      });

      try {
        const { data, error } = await supabase
          .from('appointments')
          .insert([appointmentData])
          .select();

        if (error) throw error;

        console.log('âœ… Guest Spot Appointment created:', data);
        showNotification('Appointment erstellt!', 'success');

        // Modal schlieÃŸen und Liste aktualisieren
        closeAddGuestSpotAppointmentModal();
        loadGuestSpotAppointments(gs.id, shareArtist, shareStudio, true);

      } catch (err) {
        console.error('Error saving appointment:', err);
        showNotification('Fehler beim Speichern: ' + err.message, 'error');
      }
    }

    // Window Exports
    window.openAddGuestSpotAppointmentModal = openAddGuestSpotAppointmentModal;
    window.closeAddGuestSpotAppointmentModal = closeAddGuestSpotAppointmentModal;
    window.calculateGsAptShares = calculateGsAptShares;
    window.saveGuestSpotAppointment = saveGuestSpotAppointment;

    // ============================================
    // CUSTOMER SEARCH FÃœR ADD APPOINTMENT PANEL
    // ============================================

    // Customer suchen
    function searchGsAptCustomers(query) {
      const resultsContainer = document.getElementById('gsAptCustomerResults');
      if (!resultsContainer) return;

      if (!query || query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
      }

      const searchLower = query.toLowerCase();

      // Suche in gecachten Customers
      const customers = window.allCustomers || [];
      const filtered = customers
        .filter(c => {
          const name = `${c.first_name || ''} ${c.last_name || ''}`.toLowerCase();
          const email = (c.email || '').toLowerCase();
          const phone = (c.phone || '').toLowerCase();
          return name.includes(searchLower) || email.includes(searchLower) || phone.includes(searchLower);
        })
        .slice(0, 10);

      if (filtered.length === 0) {
        resultsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: #86868b; font-size: 13px;">Keine Kunden gefunden</div>';
        resultsContainer.style.display = 'block';
        return;
      }

      resultsContainer.innerHTML = filtered.map(customer => {
        const name = `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unbekannt';
        const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const email = customer.email || '-';
        const phone = customer.phone || '';

        return `
          <div onclick="selectGsAptCustomer(${JSON.stringify(customer).replace(/"/g, '&quot;')})" style="
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: background 0.15s;
          " onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
            <div style="
              width: 32px;
              height: 32px;
              border-radius: 50%;
              background: #e5e5ea;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 12px;
              font-weight: 600;
              color: #1d1d1f;
            ">${initials}</div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 14px; font-weight: 500; color: #1d1d1f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</div>
              <div style="font-size: 12px; color: #86868b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${email}${phone ? ' â€¢ ' + phone : ''}</div>
            </div>
          </div>
        `;
      }).join('');

      resultsContainer.style.display = 'block';
    }

    // Customer auswÃ¤hlen
    function selectGsAptCustomer(customer) {
      selectedGsAptCustomer = customer;

      const name = `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unbekannt';
      const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

      // Update Display
      const display = document.getElementById('gsAptSelectedCustomer');
      const avatar = document.getElementById('gsAptCustomerAvatar');
      const nameEl = document.getElementById('gsAptCustomerName');
      const emailEl = document.getElementById('gsAptCustomerEmail');
      const searchContainer = document.getElementById('gsAptCustomerSearchContainer');
      const resultsContainer = document.getElementById('gsAptCustomerResults');

      if (display) display.style.display = 'block';
      if (avatar) avatar.textContent = initials;
      if (nameEl) nameEl.textContent = name;
      if (emailEl) emailEl.textContent = customer.email || customer.phone || '-';
      if (searchContainer) searchContainer.style.display = 'none';
      if (resultsContainer) resultsContainer.style.display = 'none';

      console.log('âœ… Customer selected for appointment:', name);
    }

    // Customer Auswahl lÃ¶schen
    function clearGsAptCustomer() {
      selectedGsAptCustomer = null;

      const display = document.getElementById('gsAptSelectedCustomer');
      const searchContainer = document.getElementById('gsAptCustomerSearchContainer');
      const searchInput = document.getElementById('gsAptCustomerSearch');

      if (display) display.style.display = 'none';
      if (searchContainer) searchContainer.style.display = 'block';
      if (searchInput) searchInput.value = '';
    }

    // Appointment Type auswÃ¤hlen
    function selectGsAptType(type) {
      gsAptAppointmentType = type;

      // Update hidden input
      const input = document.getElementById('gsAptTypeInput');
      if (input) input.value = type;

      // Update visual selection
      document.querySelectorAll('.gs-apt-type-card').forEach(card => {
        const cardType = card.getAttribute('data-type');
        if (cardType === type) {
          card.style.borderColor = '#34c759';
          card.style.background = 'rgba(52, 199, 89, 0.05)';
        } else {
          card.style.borderColor = 'rgba(0,0,0,0.1)';
          card.style.background = 'white';
        }
      });

      console.log('âœ… Appointment type selected:', type);
    }

    // Add Customer Mini-Modal
    function openGsAptAddCustomerModal() {
      // Entferne existierendes Modal falls vorhanden
      const existing = document.getElementById('gsAptAddCustomerModal');
      if (existing) existing.remove();

      const modalHtml = `
        <div id="gsAptAddCustomerModal" style="
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          z-index: 10003;
          display: flex;
          align-items: center;
          justify-content: center;
        " onclick="if(event.target === this) closeGsAptAddCustomerModal()">
          <div style="
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
          " onclick="event.stopPropagation()">
            <!-- Header -->
            <div style="
              padding: 16px 20px;
              background: #1d1d1f;
              color: white;
              display: flex;
              align-items: center;
              justify-content: space-between;
            ">
              <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Neuen Kunden anlegen</h3>
              <button onclick="closeGsAptAddCustomerModal()" style="
                background: rgba(255,255,255,0.1);
                border: none;
                border-radius: 6px;
                padding: 6px;
                cursor: pointer;
                display: flex;
              ">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>

            <!-- Content -->
            <div style="padding: 20px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                  <label style="font-size: 12px; font-weight: 500; color: #86868b; display: block; margin-bottom: 4px;">Vorname *</label>
                  <input type="text" id="gsAptNewCustomerFirstName" required style="
                    width: 100%;
                    padding: 10px 12px;
                    border: 1px solid rgba(0,0,0,0.1);
                    border-radius: 8px;
                    font-size: 14px;
                    box-sizing: border-box;
                  ">
                </div>
                <div>
                  <label style="font-size: 12px; font-weight: 500; color: #86868b; display: block; margin-bottom: 4px;">Nachname</label>
                  <input type="text" id="gsAptNewCustomerLastName" style="
                    width: 100%;
                    padding: 10px 12px;
                    border: 1px solid rgba(0,0,0,0.1);
                    border-radius: 8px;
                    font-size: 14px;
                    box-sizing: border-box;
                  ">
                </div>
              </div>

              <div style="margin-bottom: 16px;">
                <label style="font-size: 12px; font-weight: 500; color: #86868b; display: block; margin-bottom: 4px;">E-Mail</label>
                <input type="email" id="gsAptNewCustomerEmail" style="
                  width: 100%;
                  padding: 10px 12px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 8px;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
              </div>

              <div style="margin-bottom: 20px;">
                <label style="font-size: 12px; font-weight: 500; color: #86868b; display: block; margin-bottom: 4px;">Telefon</label>
                <input type="tel" id="gsAptNewCustomerPhone" style="
                  width: 100%;
                  padding: 10px 12px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 8px;
                  font-size: 14px;
                  box-sizing: border-box;
                ">
              </div>

              <!-- Actions -->
              <div style="display: flex; gap: 12px;">
                <button type="button" onclick="closeGsAptAddCustomerModal()" style="
                  flex: 1;
                  padding: 12px;
                  border: 1px solid rgba(0,0,0,0.1);
                  border-radius: 10px;
                  background: white;
                  color: #1d1d1f;
                  font-size: 14px;
                  font-weight: 500;
                  cursor: pointer;
                ">Abbrechen</button>
                <button type="button" onclick="saveGsAptNewCustomer()" style="
                  flex: 1;
                  padding: 12px;
                  border: none;
                  border-radius: 10px;
                  background: #1d1d1f;
                  color: white;
                  font-size: 14px;
                  font-weight: 500;
                  cursor: pointer;
                ">Anlegen</button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // Focus auf erstes Input
      setTimeout(() => {
        document.getElementById('gsAptNewCustomerFirstName')?.focus();
      }, 100);
    }

    function closeGsAptAddCustomerModal() {
      const modal = document.getElementById('gsAptAddCustomerModal');
      if (modal) modal.remove();
    }

    async function saveGsAptNewCustomer() {
      const firstName = document.getElementById('gsAptNewCustomerFirstName')?.value?.trim();
      const lastName = document.getElementById('gsAptNewCustomerLastName')?.value?.trim();
      const email = document.getElementById('gsAptNewCustomerEmail')?.value?.trim();
      const phone = document.getElementById('gsAptNewCustomerPhone')?.value?.trim();

      if (!firstName) {
        showNotification('Bitte Vorname eingeben', 'error');
        return;
      }

      try {
        const { data, error } = await supabase
          .from('customers')
          .insert([{
            first_name: firstName,
            last_name: lastName || null,
            email: email || null,
            phone: phone || null,
            created_at: new Date().toISOString()
          }])
          .select()
          .single();

        if (error) throw error;

        console.log('âœ… New customer created:', data);
        showNotification('Kunde angelegt!', 'success');

        // Add to cache
        if (window.allCustomers) {
          window.allCustomers.unshift(data);
        }

        // Select the new customer
        selectGsAptCustomer(data);

        // Close modal
        closeGsAptAddCustomerModal();

      } catch (err) {
        console.error('Error creating customer:', err);
        showNotification('Fehler: ' + err.message, 'error');
      }
    }

    // Window Exports
    window.searchGsAptCustomers = searchGsAptCustomers;
    window.selectGsAptCustomer = selectGsAptCustomer;
    window.clearGsAptCustomer = clearGsAptCustomer;
    window.selectGsAptType = selectGsAptType;
    window.openGsAptAddCustomerModal = openGsAptAddCustomerModal;
    window.closeGsAptAddCustomerModal = closeGsAptAddCustomerModal;
    window.saveGsAptNewCustomer = saveGsAptNewCustomer;

    // ============================================
    // BUG ANALYZER - Debug Tool (Console Only)
    // ============================================

    async function runBugAnalyzer() {
      console.log('');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ðŸ” BUG ANALYZER - Starting diagnostic checks...');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      const issues = [];
      const warnings = [];
      const info = [];

      // CHECK 1: Supabase Connection
      try {
        const { count } = await supabase.from('locations').select('*', { count: 'exact', head: true });
        info.push(`âœ… Supabase: Connected (${count} locations)`);
      } catch (e) {
        issues.push('âŒ Supabase: ' + e.message);
      }

      // CHECK 2: Required Functions
      const funcs = ['openGuestSpotDetailModal', 'loadUpcomingGuestSpotsTab', 'loadActiveGuestSpotsTab',
                     'loadCanceledGuestSpotsTab', 'reactivateGuestSpot', 'switchListType'];
      funcs.forEach(fn => {
        if (typeof window[fn] === 'function') {
          info.push(`âœ… ${fn}(): Available`);
        } else {
          warnings.push(`âš ï¸ ${fn}(): NOT FOUND`);
        }
      });

      // CHECK 3: Required DOM Elements
      const els = ['createGuestSpotModal', 'guestSpotDetailModal', 'waitlistTypeToggle', 'waitlistSlotsContainer'];
      els.forEach(id => {
        if (document.getElementById(id)) {
          info.push(`âœ… #${id}: Found`);
        } else {
          warnings.push(`âš ï¸ #${id}: NOT FOUND`);
        }
      });

      // CHECK 4: Sub-Tab Buttons
      const tabButtons = document.querySelectorAll('.list-toggle-option');
      info.push(`âœ… Sub-Tab Buttons: ${tabButtons.length} found`);
      if (tabButtons.length !== 5) {
        warnings.push(`âš ï¸ Expected 5 sub-tabs, found ${tabButtons.length}`);
      }

      // CHECK 5: RPC Functions
      for (const rpc of ['check_guest_spot_overlap', 'reactivate_guest_spot']) {
        try {
          await supabase.rpc(rpc, { p_artist_id: '00000000-0000-0000-0000-000000000000' });
          info.push(`âœ… RPC ${rpc}: Available`);
        } catch (e) {
          if (e.message.includes('does not exist')) {
            issues.push(`âŒ RPC ${rpc}: NOT IN DATABASE`);
          } else {
            info.push(`âœ… RPC ${rpc}: Available`);
          }
        }
      }

      // CHECK 6: Views
      for (const view of ['upcoming_slots_grouped', 'previous_guest_spots_grouped', 'guest_spot_calendar_view']) {
        try {
          const { data } = await supabase.from(view).select('*').limit(1);
          info.push(`âœ… View ${view}: Accessible`);
        } catch (e) {
          issues.push(`âŒ View ${view}: ${e.message}`);
        }
      }

      // CHECK 7: Current State
      // Safe check for current list type
      const listType = (typeof currentListType !== 'undefined') ? currentListType : 'unknown';
      info.push('ðŸ“Š Current List Type: ' + listType);
      // Safe check for currentWaitlistLocation
      const safeWaitlistLocation = (typeof currentWaitlistLocation !== 'undefined') ? currentWaitlistLocation : 'all';
      info.push(`ðŸ“ Current Location: ${safeWaitlistLocation}`);

      // CHECK 8: Guest Spots Count
      try {
        const today = new Date().toISOString().split('T')[0];

        const { count: upcomingCount } = await supabase
          .from('upcoming_slots')
          .select('*', { count: 'exact', head: true })
          .gte('date_from', today)
          .neq('status', 'canceled');

        const { count: activeCount } = await supabase
          .from('upcoming_slots')
          .select('*', { count: 'exact', head: true })
          .lte('date_from', today)
          .gte('date_to', today)
          .neq('status', 'canceled');

        const { count: canceledCount } = await supabase
          .from('upcoming_slots')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'canceled');

        info.push(`ðŸ“… Upcoming: ${upcomingCount}, Active: ${activeCount}, Canceled: ${canceledCount}`);
      } catch (e) {
        warnings.push(`âš ï¸ Could not count guest spots: ${e.message}`);
      }

      // RESULTS
      console.log('');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ðŸ“Š RESULTS: ' + issues.length + ' issues, ' + warnings.length + ' warnings');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      if (issues.length) {
        console.log('ðŸ”´ ISSUES:');
        issues.forEach(i => console.log('   ' + i));
      }
      if (warnings.length) {
        console.log('ðŸŸ¡ WARNINGS:');
        warnings.forEach(w => console.log('   ' + w));
      }
      console.log('ðŸŸ¢ PASSED: ' + info.length + ' checks');
      info.forEach(i => console.log('   ' + i));

      console.log('');
      console.log('ðŸ’¡ Run again: runBugAnalyzer()');

      return { issues, warnings, info };
    }

    window.runBugAnalyzer = runBugAnalyzer;

    // Auto-run nach 7 Sekunden (optional - kann mit window.skipBugAnalyzer = true verhindert werden)
    setTimeout(() => {
      if (!window.skipBugAnalyzer) {
        console.log('ðŸ” Running Bug Analyzer (auto)...');
        runBugAnalyzer();
      }
    }, 7000);

  </script>

  <!-- Image Modal for Reference Images -->
  <div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <span class="image-modal-close">&times;</span>
    <img id="modalImage" src="" alt="Reference Image">
  </div>

  <!-- ==========================================
       MOBILE CALENDAR VIEW (Multi-Artist Grid)
       Only visible on mobile < 768px
       ========================================== -->
  <div class="mobile-calendar-view" id="mobileCalendarView" style="display:flex;flex-direction:column;height:100%;">

    <!-- Header entfernt - Datum nicht mehr angezeigt -->

    <!-- Wochenleiste (OBEN) -->
    <div class="mobile-cal-week-strip" id="mobileCalWeekStrip">
      <!-- Wird via JS gefÃ¼llt -->
    </div>

    <!-- Navigation Buttons (UNTER der Wochenleiste) -->
    <div class="mobile-cal-week-nav" style="padding:8px 16px;">
      <button class="mobile-cal-month-btn" onclick="toggleMobileCalMonthView()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="4" width="18" height="18" rx="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
      </button>
      <button class="mobile-cal-nav-btn" onclick="mobileCalPrevDay()">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <button class="mobile-cal-today-btn" onclick="mobileCalToday()">Heute</button>
      <button class="mobile-cal-nav-btn" onclick="mobileCalNextDay()">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
    </div>

    <!-- Hauptbereich: Zeitleiste + Artist-Spalten -->
    <div class="mobile-cal-grid-wrapper">

      <!-- Zeitleiste links - aligned mit Terminen -->
      <div class="mobile-cal-time-column">
        <div class="mobile-cal-time-header"></div>
        <div class="mobile-cal-time-slot" data-hour="9">09:00</div>
        <div class="mobile-cal-time-slot" data-hour="10">10:00</div>
        <div class="mobile-cal-time-slot" data-hour="11">11:00</div>
        <div class="mobile-cal-time-slot" data-hour="12">12:00</div>
        <div class="mobile-cal-time-slot" data-hour="13">13:00</div>
        <div class="mobile-cal-time-slot" data-hour="14">14:00</div>
        <div class="mobile-cal-time-slot" data-hour="15">15:00</div>
        <div class="mobile-cal-time-slot" data-hour="16">16:00</div>
        <div class="mobile-cal-time-slot" data-hour="17">17:00</div>
        <div class="mobile-cal-time-slot" data-hour="18">18:00</div>
        <div class="mobile-cal-time-slot" data-hour="19">19:00</div>
        <div class="mobile-cal-time-slot" data-hour="20">20:00</div>
        <div class="mobile-cal-time-slot" data-hour="21">21:00</div>
        <div class="mobile-cal-time-slot" data-hour="22">22:00</div>
      </div>

      <!-- Horizontal scrollbarer Artist-Bereich -->
      <div class="mobile-cal-artists-scroll" id="mobileCalArtistsScroll">
        <!-- Artist-Spalten werden via JS gefÃ¼llt -->
      </div>

    </div> <!-- Ende mobile-cal-grid-wrapper -->

    <!-- Legacy containers for backwards compatibility -->
    <div id="mobileCalWeekdays" style="display:none;"></div>
    <div id="mobileCalHours" style="display:none;"></div>
  </div>

  <!-- Mobile Calendar Month View -->
  <div class="mobile-cal-month-view" id="mobileCalMonthView">
    <div class="mobile-dp-month-header">
      <button class="mobile-dp-month-back" onclick="closeMobileCalMonthView()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        ZurÃ¼ck
      </button>
      <h2>MonatsÃ¼bersicht</h2>
    </div>
    <div class="mobile-dp-months-scroll" id="mobileCalMonthsScroll"></div>
  </div>

  <!-- Mobile Calendar Event Detail Modal -->
  <div class="mobile-cal-modal" id="mobileCalModal">
    <div class="mobile-cal-modal-content">
      <div class="mobile-cal-modal-header">
        <span id="mobileCalModalTitle">Termin Details</span>
        <button class="mobile-cal-modal-close" onclick="closeMobileCalModal()">âœ•</button>
      </div>
      <div class="mobile-cal-modal-body" id="mobileCalModalBody">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- ==========================================
       MOBILE DIENSTPLAN VIEW
       Only visible on mobile < 768px
       ========================================== -->
  <div class="mobile-dienstplan-view" id="mobileDienstplanView">
    <!-- Week Selector -->
    <div class="mobile-dp-header">
      <button class="mobile-dp-week-dropdown" id="mobileDpWeekDropdown">
        <span id="mobileDpWeekLabel">Mo 16.12. - So 22.12.</span>
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </button>
    </div>

    <!-- Week Navigation -->
    <div class="mobile-dp-week-nav">
      <!-- Month View Button -->
      <button class="mobile-dp-nav-btn" id="mobileDpMonthViewBtn" onclick="toggleMobileDpMonthView()" style="flex-shrink:0;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="4" width="18" height="18" rx="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
      </button>
      <button class="mobile-dp-nav-btn" id="mobileDpPrevWeek">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <button class="mobile-dp-today-btn" id="mobileDpToday">Heute</button>
      <button class="mobile-dp-nav-btn" id="mobileDpNextWeek">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
    </div>

    <!-- Days List -->
    <div class="mobile-dp-days" id="mobileDpDays">
      <!-- Will be populated by JS with user-specific shifts -->
    </div>
  </div>

  <!-- Mobile Dienstplan Month View -->
  <div class="mobile-dp-month-view" id="mobileDpMonthView">
    <div class="mobile-dp-month-header">
      <button class="mobile-dp-month-back" onclick="closeMobileDpMonthView()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        ZurÃ¼ck
      </button>
      <span class="mobile-dp-month-title" id="mobileDpMonthTitle">MonatsÃ¼bersicht</span>
    </div>
    <div class="mobile-dp-months-scroll" id="mobileDpMonthsScroll">
      <!-- Months will be rendered here -->
    </div>
  </div>

  <!-- Mobile Footer Navigation -->
  <div class="mobile-footer-nav" id="mobileFooterNav">
    <div class="mobile-nav-item active" data-mobile-view="dashboard" onclick="handleMobileNav('dashboard', this)">
      <!-- Avatar statt Icon fÃ¼r Dashboard -->
      <div class="mobile-nav-avatar" id="mobileNavAvatar">
        <img src="" alt="" class="mobile-nav-avatar-img" id="mobileNavAvatarImg" style="display:none;">
        <span class="mobile-nav-avatar-initials" id="mobileNavAvatarInitials">?</span>
      </div>
    </div>

    <div class="mobile-nav-item" data-mobile-view="calendar" onclick="handleMobileNav('calendar', this)">
      <!-- Outline Icon (Standard) -->
      <svg class="mobile-nav-icon nav-icon-outline" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="1.5"/>
        <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <!-- Fill Icon (Aktiv) -->
      <svg class="mobile-nav-icon nav-icon-fill" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path d="M19 4H17V2H15V4H9V2H7V4H5C3.9 4 3 4.9 3 6V20C3 21.1 3.9 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4ZM19 20H5V10H19V20Z"/>
      </svg>
    </div>

    <div class="mobile-nav-item" data-mobile-view="dienstplan" onclick="handleMobileNav('dienstplan', this)">
      <!-- Outline Icon (Standard) -->
      <svg class="mobile-nav-icon nav-icon-outline" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <!-- Fill Icon (Aktiv) -->
      <svg class="mobile-nav-icon nav-icon-fill" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z"/>
      </svg>
    </div>
  </div>

  <!-- Project Detail Modal -->
  <div class="project-detail-modal" id="projectDetailModal">
    <div class="project-detail-content">
      <div class="project-detail-header">
        <button class="project-detail-back" id="closeProjectDetailBtn">
          â† ZurÃ¼ck
        </button>
        <button class="project-menu-btn" id="projectDetailMenuBtn">â‹®</button>
      </div>
      <div class="project-detail-body" id="projectDetailBody">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Mobile Calendar Event Detail View -->
  <div class="mobile-event-detail" id="mobileEventDetail">
    <div class="mobile-event-detail-header">
      <button class="mobile-event-back" onclick="closeMobileEventDetail()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        ZurÃ¼ck
      </button>
      <span class="mobile-event-category-badge" id="mobileEventCategory">Consultation</span>
    </div>

    <div class="mobile-event-detail-content" id="mobileEventDetailContent">
      <!-- Content loaded dynamically -->
    </div>
  </div>

</body>
</html><!-- VERSION: v128 - Removed weekly statistics badges, moved version indicator to welcome banner -->
