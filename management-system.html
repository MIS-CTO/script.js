<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Management System</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg:#fafafa; --ink:#1d1d1f; --muted:#86868b; --panel:rgba(255,255,255,0.8); --stroke:rgba(0,0,0,0.06);
      --brand:#1d1d1f; --brand-ink:#ffffff; --accent:#0071e3; --radius:12px;
      --shadow:0 2px 16px rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.04);
      --location-primary:#43A047;
      --location-light:#E8F5E9;
      --location-dark:#2E7D32;
      --location-accent:#66BB6A;
    }
    * { box-sizing:border-box; }
    body {
      font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;
      background:#fafafa;
      color:var(--ink); margin:0; font-size:15px; line-height:1.47059;
      -webkit-font-smoothing:antialiased;
    }
    nav {
      position:sticky; top:0; z-index:50; display:flex; gap:18px; align-items:center;
      background:rgba(255,255,255,0.72); backdrop-filter:saturate(180%) blur(20px);
      padding:12px 28px; border-bottom:1px solid rgba(0,0,0,0.08);
    }
    nav a {
      color:var(--ink);
      text-decoration:none;
      font-weight:500;
      font-size:14px;
      padding:6px 4px;
      border-bottom:2px solid transparent;
      opacity:0.85;
      cursor:pointer;
      transition:opacity 0.2s ease, border-color 0.2s ease;
    }
    nav a:hover { opacity:1; }
    nav a.active { border-color:var(--ink); opacity:1; }
    section { display:none; padding:24px 5vw; max-width:100%; margin:0 auto; }
    section.active { display:block; }
    h2 { margin:0 0 12px; font-size:22px; font-weight:600; letter-spacing:-0.022em; }
    .badge {
      background:rgba(255,255,255,0.95);
      border:1px solid rgba(0,0,0,0.04);
      border-radius:18px;
      padding:6px 14px;
      font-size:13px;
      box-shadow:0 1px 3px rgba(0,0,0,0.06);
      display:inline-block;
      margin-right:8px;
      margin-bottom:8px;
    }
    .calendar-controls {
      display:flex; gap:12px; margin-bottom:16px; align-items:center; flex-wrap:wrap;
    }
    .btn-nav {
      background:#e0e0e5;
      color:#1d1d1f;
      border:none;
      padding:9px 16px;
      border-radius:999px;
      font-weight:400;
      cursor:pointer;
      font-size:14px;
      transition:background 0.2s ease;
    }
    .btn-nav:hover { background:#d2d2d7; }
    input, select, textarea {
      padding:9px 12px;
      border:1px solid rgba(0,0,0,0.1);
      border-radius:999px;
      font-size:14px;
      font-family:inherit;
      background:rgba(255,255,255,0.95);
      transition:border-color 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline:none;
      border-color:var(--accent);
    }
    table {
      width:100%;
      border-collapse:collapse;
      border:1px solid rgba(0,0,0,0.06);
      border-radius:12px;
      overflow:hidden;
      background:rgba(255,255,255,0.95);
      box-shadow:var(--shadow);
    }
    thead { background:var(--panel); }
    th, td { text-align:left; padding:10px 12px; border-bottom:1px solid var(--stroke); }
    tbody tr:last-child td { border-bottom:none; }
    .calendar-container {
      background:rgba(255,255,255,0.95);
      border:1px solid rgba(0,0,0,0.06);
      border-radius:12px;
      box-shadow:var(--shadow);
      overflow:auto;
      width:100%;
    }
    .calendar-grid {
      display:grid; grid-template-columns:120px repeat(22, 1fr); min-width:100%;
    }
    .calendar-header { display:contents; }
    .slot-header {
      background:#F5F5F7; color:#1d1d1f; padding:14px; font-weight:600;
      text-align:center; border-bottom:1px solid rgba(0,0,0,0.1);
      border-right:1px solid rgba(0,0,0,0.1); position:sticky; left:0; z-index:10;
      min-height:56px; display:flex; align-items:center; justify-content:center;
      grid-column:1/2; font-size:14px; letter-spacing:-0.01em;
    }
    .hour-header {
      background:#F5F5F7; color:#86868b; padding:12px; font-weight:500;
      text-align:center; border-right:none; border-bottom:1px solid rgba(0,0,0,0.1);
      min-height:56px; display:flex; align-items:center; justify-content:center;
      font-size:13px; letter-spacing:-0.01em;
    }
    .slot-row { display:contents; }
    .slot-label {
      background:rgba(255,255,255,0.98);
      padding:14px;
      font-weight:500;
      border-right:1px solid rgba(0,0,0,0.08);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      left:0;
      z-index:5;
      min-height:100px;
      display:flex;
      align-items:center;
      justify-content:center;
      grid-column:1;
      font-size:13px;
      color:#86868b;
    }
    .slot-label.empty {
      min-height:40px;
      background:rgba(240,240,240,0.98);
      color:#999;
      font-size:12px;
      font-weight:400;
    }
    .slot-label.empty .slot-number {
      font-weight:500;
      color:#666;
    }
    .slot-label.empty .empty-text {
      margin-left:6px;
      font-style:italic;
    }
    .category-header {
      background:#F5F5F7; color:#1d1d1f; padding:12px 14px; font-weight:600;
      border-right:1px solid rgba(0,0,0,0.1); border-bottom:1px solid rgba(0,0,0,0.1);
      position:sticky; left:0; z-index:6; min-height:48px;
      display:flex; align-items:center; justify-content:flex-start; grid-column:1/2;
      font-size:14px; letter-spacing:-0.01em;
    }
    .category-spacer {
      background:#FAFAFA; border-right:none; border-bottom:1px solid rgba(0,0,0,0.06);
      min-height:48px;
    }
    .slot-cell {
      border-bottom:1px solid rgba(0,0,0,0.06);
      border-right:1px solid rgba(0,0,0,0.06);
      min-height:100px;
      padding:6px;
      position:relative;
      background:rgba(255,255,255,0.8);
      transition:background 0.15s ease;
    }
    .slot-cell.empty-slot {
      min-height:50px;
      background:rgba(245,245,245,0.6);
      cursor:default;
    }
    .slot-cell.empty-slot:hover {
      background:rgba(245,245,245,0.6);
    }
    .slot-row.empty-row .slot-label {
      min-height:50px;
      background:rgba(249,249,249,0.5);
      color:var(--muted);
      font-size:12px;
    }
    .slot-row.empty-row .slot-label::after {
      content: " - Empty";
      font-weight:400;
      font-size:11px;
      color:#999;
      margin-left:4px;
    }
    .slot-row.empty-row .slot-cell {
      min-height:50px;
    }
    .slot-cell.half-hour { border-right:1px solid rgba(0,0,0,0.04); }
    .slot-cell:hover { background:rgba(0,113,227,0.02); }
    .event {
      background:rgba(255,255,255,0.95);
      color:#1d1d1f;
      padding:8px 10px;
      border-radius:6px;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.2s ease;
      word-break:break-word;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:flex-start;
      border-left:4px solid var(--location-primary);
      box-shadow:0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
      overflow:hidden;
      line-height:1.3;
    }
    .event:hover {
      box-shadow:0 4px 12px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.06);
      transform:translateY(-1px);
      z-index:10;
    }
    .event.guest {
      border-left-color:#42A5F5;
    }
    .event.resident {
      border-left-color:var(--location-primary);
    }
    .event.events {
      border-left-color:#5856D6;
    }
    
    /* Booking Type Colors - Light backgrounds with colored borders */
    .event[data-type="consultation"] {
      background:rgba(102, 187, 106, 0.15);
      border-left-color:#43A047;
    }
    .event[data-type="new_tattoo"] {
      background:rgba(236, 64, 122, 0.15);
      border-left-color:#C2185B;
    }
    .event[data-type="continuing_tattoo"] {
      background:rgba(66, 165, 245, 0.15);
      border-left-color:#1976D2;
    }
    .event[data-type="touch_up"] {
      background:rgba(255, 235, 59, 0.25);
      border-left-color:#FBC02D;
    }
    .event[data-type="selfbooking"] {
      background:rgba(141, 110, 99, 0.15);
      border-left-color:#5D4037;
    }
    .event[data-type="wannado"] {
      background:rgba(171, 71, 188, 0.15);
      border-left-color:#7B1FA2;
    }
    .event[data-type="internal"] {
      background:rgba(239, 83, 80, 0.15);
      border-left-color:#C62828;
    }
    .event[data-type="move"] {
      background:rgba(38, 198, 218, 0.15);
      border-left-color:#00838F;
    }
    .event[data-type="reserved"] {
      background:rgba(120, 144, 156, 0.15);
      border-left-color:#455A64;
    }
    .event[data-type="no_show"] {
      background:rgba(189, 189, 189, 0.1);
      border-left-color:#757575;
    }
    
    /* Dienstplan Styles */
    .dienstplan-grid {
      background:rgba(255,255,255,0.95);
      border:1px solid rgba(0,0,0,0.06);
      border-radius:12px;
      box-shadow:var(--shadow);
      overflow:auto;
    }
    
    .category-section {
      border-bottom:1px solid rgba(0,0,0,0.06);
    }
    
    .category-section:last-child {
      border-bottom:none;
    }
    
    .category-header-btn {
      width:100%;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      background:#f5f5f5;
      color:#1d1d1f;
      border:none;
      padding:12px 16px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:background 0.2s ease;
      font-family:inherit;
      text-align:left;
    }
    
    .category-header-btn:hover {
      background:#e8e8e8;
    }
    
    .category-header-btn .arrow {
      margin-right:8px;
      transition:transform 0.3s ease;
      font-size:12px;
      display:inline-block;
      width:16px;
    }
    
    .category-header-btn.active .arrow {
      transform:rotate(90deg);
    }
    
    .category-content {
      display:none;
    }
    
    .category-content.active {
      display:block;
    }
    
    .person-row-container {
      display:contents;
    }
    
    .dienstplan-table {
      width:100%;
      display:grid;
      grid-template-columns:150px repeat(31, 80px);
      border-collapse:collapse;
    }
    
    .dp-header-row {
      display:contents;
    }
    
    .dp-name-header {
      background:rgba(249,249,249,0.98);
      padding:12px;
      font-weight:600;
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      left:0;
      z-index:5;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      font-size:13px;
      color:#666;
      background:rgba(255,255,255,0.98);
    }
    
    .dp-day-header {
      background:var(--location-light);
      padding:8px 4px;
      font-weight:400;
      text-align:center;
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      font-size:11px;
      min-height:50px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
    }
    
    .dp-day-header .weekday {
      font-weight:500;
      color:#666;
      font-size:10px;
    }
    
    .dp-day-header .day-num {
      font-size:13px;
      font-weight:600;
      color:#1d1d1f;
    }
    
    .dp-row {
      display:contents;
    }
    
    .dp-name-cell {
      background:rgba(255,255,255,0.98);
      padding:10px 12px 10px 32px;
      font-weight:400;
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      left:0;
      z-index:4;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      font-size:13px;
      color:#1d1d1f;
    }
    
    .dp-cell {
      border-right:1px solid rgba(0,0,0,0.06);
      border-bottom:1px solid rgba(0,0,0,0.06);
      min-height:40px;
      background:rgba(255,255,255,0.8);
      transition:background 0.15s ease;
      cursor:pointer;
    }
    
    .dp-cell:hover {
      background:rgba(0,113,227,0.04);
    }
    
    .dp-cell.working {
      background:var(--location-accent);
    }
    
    .dp-cell.off {
      background:#FFEBEE;
    }
    
    .dp-cell.vacation {
      background:#FFF3E0;
    }
    
    /* Apple-style Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 51px;
      height: 31px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e5e5ea;
      transition: .3s;
      border-radius: 15.5px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 27px;
      width: 27px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 27px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 3px 1px rgba(0,0,0,0.06);
    }
    
    input:checked + .toggle-slider {
      background-color: #34c759;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    
    .current-time-indicator {
      position: absolute;
      top: 100px;
      bottom: 0;
      width: 2px;
      background: #ff3b30;
      z-index: 20;
      pointer-events: none;
    }
    
    .current-time-indicator::before {
      content: '';
      position: absolute;
      left: -3px;
      top: 0;
      width: 8px;
      height: 8px;
      background: #ff3b30;
      border-radius: 50%;
    }
    
    /* Modal Styles */
    .modal-backdrop {
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.5);
      backdrop-filter:blur(4px);
      z-index:1000;
      align-items:center;
      justify-content:center;
    }
    
    .modal-backdrop.active {
      display:flex;
    }
    
    .modal {
      background:white;
      border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,0.2);
      padding:24px;
      max-width:500px;
      width:90%;
      max-height:80vh;
      overflow-y:auto;
    }
    
    .modal h3 {
      margin:0 0 20px;
      font-size:20px;
      font-weight:600;
    }
    
    .modal-form {
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    
    .form-group {
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    
    .form-group label {
      font-size:13px;
      font-weight:500;
      color:var(--muted);
    }
    
    .modal-actions {
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:20px;
    }
    
    .btn {
      padding:10px 20px;
      border-radius:8px;
      border:none;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.2s ease;
      font-family:inherit;
    }
    
    .btn-primary {
      background:var(--accent);
      color:white;
    }
    
    .btn-primary:hover {
      background:#0077ED;
    }
    
    .btn-secondary {
      background:#f5f5f5;
      color:var(--ink);
    }
    
    .btn-secondary:hover {
      background:#e5e5e5;
    }
    
    .btn-danger {
      background:#ff3b30;
      color:white;
    }
    
    .btn-danger:hover {
      background:#ff2d20;
    }
    
    .btn-icon {
      background:transparent;
      border:none;
      cursor:pointer;
      padding:6px;
      border-radius:6px;
      color:var(--muted);
      transition:all 0.2s ease;
      font-size:16px;
    }
    
    .btn-icon:hover {
      background:rgba(0,0,0,0.05);
      color:var(--ink);
    }
    
    /* Artist List Styles */
    .artist-list {
      list-style:none;
      padding:0;
      margin:16px 0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .artist-item {
      background:white;
      border:1px solid rgba(0,0,0,0.06);
      border-radius:10px;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition:all 0.2s ease;
    }
    
    .artist-item:hover {
      border-color:rgba(0,0,0,0.12);
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
    }
    
    .artist-info {
      display:flex;
      align-items:center;
      gap:12px;
      flex:1;
    }
    
    .artist-name {
      font-weight:500;
      font-size:15px;
    }
    
    .artist-badge {
      background:var(--location-light);
      color:var(--location-dark);
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:500;
    }
    
    .artist-badge.guest {
      background:#e3f2fd;
      color:#1565c0;
    }
    
    .artist-location {
      background:#FFF3E0;
      color:#E65100;
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:500;
    }
    
    .artist-rank {
      background:#F3E5F5;
      color:#7B1FA2;
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:500;
    }
    
    .customer-rank {
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:600;
    }
    
    .customer-rank.bronze {
      background:#D7CCC8;
      color:#4E342E;
    }
    
    .customer-rank.silver {
      background:#E0E0E0;
      color:#424242;
    }
    
    .customer-rank.gold {
      background:#FFF9C4;
      color:#F57F17;
    }
    
    .customer-rank.platinum {
      background:#E1F5FE;
      color:#01579B;
    }
    
    /* Sort Controls */
    .sort-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }
    
    .artist-instagram {
      color:var(--muted);
      font-size:13px;
      margin-left:8px;
    }
    
    .artist-actions {
      display:flex;
      gap:4px;
    }
    
    /* Customer Table Styles */
    #customersTable tbody tr {
      transition:background 0.15s ease;
    }
    
    #customersTable tbody tr:hover {
      background:rgba(0,113,227,0.02);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .artist-item {
        flex-direction:column;
        align-items:flex-start;
        gap:12px;
      }
      
      .artist-actions {
        width:100%;
        justify-content:flex-end;
      }
    }
    
    /* Request Management Styles */
    .request-item {
      padding:16px;
      border-radius:10px;
      margin-bottom:8px;
      cursor:pointer;
      transition:all 0.2s;
      border:1px solid rgba(0,0,0,0.06);
      background:white;
    }
    .request-item:hover {
      background:rgba(0,113,227,0.04);
      border-color:var(--accent);
      transform:translateX(2px);
    }
    .request-item.active {
      background:rgba(0,113,227,0.08);
      border-color:var(--accent);
      box-shadow:0 2px 8px rgba(0,113,227,0.15);
    }
    .request-item.new-status {
      background:#fff3cd;
      border-color:#ffc107;
    }
    .request-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .request-id {
      font-size:11px;
      color:var(--muted);
      font-weight:600;
      font-family:monospace;
    }
    .request-badge {
      padding:4px 10px;
      border-radius:12px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .request-badge.open_request { background:#dc3545; color:white; }
    .request-badge.pending { background:#ffc107; color:#000; }
    .request-badge.scheduled { background:#28a745; color:white; }
    .request-badge.finished { background:#6c757d; color:white; }
    .request-badge.canceled { background:#dc3545; color:white; }
    .request-name {
      font-size:15px;
      font-weight:600;
      margin-bottom:4px;
      color:var(--ink);
    }
    .request-date {
      font-size:12px;
      color:var(--muted);
    }
    
    /* Request Detail Styles */
    .detail-section {
      margin-bottom:32px;
    }
    .detail-section h3 {
      font-size:18px;
      font-weight:600;
      margin-bottom:16px;
      color:var(--ink);
      border-bottom:2px solid rgba(0,0,0,0.06);
      padding-bottom:8px;
    }
    .detail-grid {
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:16px;
    }
    .detail-item {
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .detail-label {
      font-size:11px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.8px;
    }
    .detail-value {
      font-size:15px;
      color:var(--ink);
      font-weight:500;
    }
    .action-buttons {
      display:flex;
      gap:12px;
      margin-top:32px;
      padding-top:24px;
      border-top:1px solid rgba(0,0,0,0.06);
      flex-wrap:wrap;
    }
    .btn {
      padding:12px 24px;
      border-radius:10px;
      border:none;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      font-family:inherit;
    }
    .btn-primary {
      background:var(--accent);
      color:white;
    }
    .btn-primary:hover {
      background:#0077ed;
      box-shadow:0 4px 12px rgba(0,113,227,0.3);
      transform:translateY(-1px);
    }
    .btn-success {
      background:#28a745;
      color:white;
    }
    .btn-success:hover {
      background:#218838;
      box-shadow:0 4px 12px rgba(40,167,69,0.3);
      transform:translateY(-1px);
    }
    .btn-danger {
      background:#dc3545;
      color:white;
    }
    .btn-danger:hover {
      background:#c82333;
      box-shadow:0 4px 12px rgba(220,53,69,0.3);
      transform:translateY(-1px);
    }
    .btn-secondary {
      background:#f5f5f7;
      color:var(--ink);
    }
    .btn-secondary:hover {
      background:#e8e8ed;
    }
  </style>
</head>
<body>
  <nav>
    <a id="tab-dashboard" class="active">Dashboard</a>
    <a id="tab-artists">Artists</a>
    <a id="tab-customers">Customers</a>
    <a id="tab-requests">Requests</a>
    <a id="tab-calendar">Calendar</a>
    <a id="tab-dienstplan">Dienstplan</a>
    <a id="tab-analytics">Analytics</a>
  </nav>

  <section id="dashboard-section" class="active">
    <h2>Dashboard</h2>
    <div>
      <span class="badge" id="badge-pending">Pending: —</span>
      <span class="badge" id="badge-scheduled">Scheduled: —</span>
      <span class="badge" id="badge-residents">Residents: —</span>
      <span class="badge" id="badge-guests">Guests: —</span>
    </div>
  </section>

  <section id="requests-section">
    <h2>Request Management</h2>
    
    <!-- Sub Navigation -->
    <div style="position:relative; background:#e8e8ed; border-radius:28px; padding:6px; margin-bottom:24px; display:inline-flex; gap:0;">
      <div id="requestsIndicator" style="position:absolute; top:6px; left:6px; height:calc(100% - 12px); background:white; border-radius:22px; transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow:0 3px 8px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08); z-index:1; pointer-events:none;"></div>
      <button class="request-tab active" data-status="open_request" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#1d1d1f; font-family:inherit; transition:color 0.2s; white-space:nowrap;">
        New Requests
        <span id="badge-new" style="display:inline-block; background:#dc3545; color:white; font-size:10px; font-weight:700; padding:2px 6px; border-radius:10px; margin-left:6px; min-width:18px; text-align:center;">0</span>
      </button>
      <button class="request-tab" data-status="my-requests" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">My Requests</button>
      <button class="request-tab" data-status="pending" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">In Progress</button>
      <button class="request-tab" data-status="scheduled" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Scheduled</button>
      <button class="request-tab" data-status="finished" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Finished</button>
      <button class="request-tab" data-status="canceled" style="position:relative; z-index:2; padding:10px 24px; border:none; background:transparent; border-radius:22px; font-size:14px; font-weight:500; cursor:pointer; color:#86868b; font-family:inherit; transition:color 0.2s; white-space:nowrap;">Canceled</button>
    </div>
    
    <!-- Two Column Layout -->
    <div style="display:grid; grid-template-columns:350px 1fr; gap:24px; height:calc(100vh - 250px);">
      <!-- Request List -->
      <div id="requestsList" style="background:rgba(255,255,255,0.95); border-radius:12px; padding:16px; box-shadow:var(--shadow); overflow-y:auto; border:1px solid rgba(0,0,0,0.06);">
        <!-- Requests will be loaded here -->
      </div>
      
      <!-- Request Detail Panel -->
      <div id="requestDetail" style="background:rgba(255,255,255,0.95); border-radius:12px; padding:32px; box-shadow:var(--shadow); overflow-y:auto; border:1px solid rgba(0,0,0,0.06);">
        <div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--muted); font-size:16px;">
          Select a request to view details
        </div>
      </div>
    </div>
  </section>

  <section id="calendar-section">
    <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
      <h2 style="margin:0; font-size:28px; font-weight:700;">Booking Calendar</h2>
      <div id="currentDateDisplayTop" style="font-weight:700; font-size:28px; color:var(--ink);"></div>
    </div>
    
    <!-- Event Type Legend -->
    <div style="display:flex; gap:16px; margin-bottom:50px; padding:16px 20px; background:rgba(255,255,255,0.95); border-radius:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,0.06);">
      <span style="font-weight:500; font-size:13px; color:var(--muted);">Booking Types:</span>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#66BB6A;"></div>
        <span style="font-size:13px; color:var(--ink);">Consultation</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#EC407A;"></div>
        <span style="font-size:13px; color:var(--ink);">New Tattoo</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#42A5F5;"></div>
        <span style="font-size:13px; color:var(--ink);">Continuing Tattoo</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#FFEB3B;"></div>
        <span style="font-size:13px; color:var(--ink);">Touch Up</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#8D6E63;"></div>
        <span style="font-size:13px; color:var(--ink);">Selfbooking</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#AB47BC;"></div>
        <span style="font-size:13px; color:var(--ink);">WannaDo</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#EF5350;"></div>
        <span style="font-size:13px; color:var(--ink);">Internal</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#26C6DA;"></div>
        <span style="font-size:13px; color:var(--ink);">Move</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#78909C;"></div>
        <span style="font-size:13px; color:var(--ink);">Reserved</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#FFFFFF; border:1px solid #BDBDBD;"></div>
        <span style="font-size:13px; color:var(--ink);">No Show</span>
      </div>
    </div>
    
    <div class="calendar-controls">
      <div style="display:flex; align-items:center; gap:8px; margin-right:40px;">
        <label style="font-weight:600; font-size:14px;">Location:</label>
        <select id="locationDropdown" style="min-width:200px;"></select>
      </div>
      <button id="prevDayBtn" class="btn-nav">‹ Prev</button>
      <input type="date" id="datePickerInput">
      <button id="todayBtn" class="btn-nav">Today</button>
      <button id="nextDayBtn" class="btn-nav" style="margin-right:40px;">Next ›</button>
      <div style="display:flex; gap:24px; align-items:center; margin-left:auto;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
          <span style="font-weight:700;">Events</span>
          <label class="toggle-switch">
            <input type="checkbox" id="checkEvents" checked>
            <span class="toggle-slider"></span>
          </label>
        </label>
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
          <span style="font-weight:700;">Residents</span>
          <label class="toggle-switch">
            <input type="checkbox" id="checkResidents" checked>
            <span class="toggle-slider"></span>
          </label>
        </label>
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
          <span style="font-weight:700;">Guests</span>
          <label class="toggle-switch">
            <input type="checkbox" id="checkGuests" checked>
            <span class="toggle-slider"></span>
          </label>
        </label>
      </div>
    </div>
    
    <!-- Create Buttons Row -->
    <div style="margin-bottom:16px; display:flex; gap:12px;">
      <button id="createEventBtn" class="btn-nav" style="background:#333; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Create Event</span>
      </button>
      <button id="createBookingBtn" class="btn-nav" style="background:#333; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Create Booking</span>
      </button>
    </div>
    
    <div id="locationInfo" style="margin-bottom:12px; padding:10px 16px; background:rgba(255,255,255,0.95); border-radius:10px; font-size:13px; color:var(--muted); box-shadow:0 1px 3px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);"></div>
    <div class="calendar-container" id="calendarContainer"></div>
  </section>

  <section id="dienstplan-section">
    <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
      <h2 style="margin:0; font-size:28px; font-weight:700;">Dienstplan</h2>
      <div id="dienstplanMonth" style="font-weight:700; font-size:28px; color:var(--ink);"></div>
    </div>
    
    <!-- Status Legend -->
    <div style="display:flex; gap:16px; margin-bottom:24px; padding:16px 20px; background:rgba(255,255,255,0.95); border-radius:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,0.06);">
      <span style="font-weight:500; font-size:13px; color:var(--muted);">Status:</span>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#2196F3;"></div>
        <span style="font-size:13px; color:var(--ink);">Home office</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#FF9800;"></div>
        <span style="font-size:13px; color:var(--ink);">Business trip</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#4CAF50;"></div>
        <span style="font-size:13px; color:var(--ink);">Vacation</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#9C27B0;"></div>
        <span style="font-size:13px; color:var(--ink);">Others</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#F44336;"></div>
        <span style="font-size:13px; color:var(--ink);">Sick</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="width:12px; height:12px; border-radius:3px; background:#795548;"></div>
        <span style="font-size:13px; color:var(--ink);">Guestspot</span>
      </div>
    </div>
    
    <div class="calendar-controls" style="margin-bottom:24px;">
      <div style="display:flex; align-items:center; gap:8px; margin-right:40px;">
        <label style="font-weight:600; font-size:14px;">Location:</label>
        <select id="dienstplanLocationDropdown" style="min-width:200px;"></select>
      </div>
      <button id="prevMonthBtn" class="btn-nav">‹ Vorheriger Monat</button>
      <button id="currentMonthBtn" class="btn-nav">Aktueller Monat</button>
      <button id="nextMonthBtn" class="btn-nav">Nächster Monat ›</button>
    </div>
    
    <div id="dienstplanContainer" style="width:100%; overflow-x:auto; overflow-y:visible;"></div>
  </section>

  <section id="artists-section">
    <h2>Artists</h2>
    
    <!-- Sort Controls -->
    <div class="sort-controls">
      <label style="font-weight:600; font-size:14px;">Sort by:</label>
      <select id="artistSortBy" class="btn-nav" style="padding:8px 16px;">
        <option value="name">Name</option>
        <option value="rank">Rank</option>
        <option value="location">Location</option>
      </select>
      <button id="artistSortOrder" class="btn-nav" data-order="asc">↑ Ascending</button>
    </div>
    
    <!-- Search Bar and Add Button Row -->
    <div style="display:flex; justify-content:space-between; align-items:center; gap:20px; margin-bottom:20px; flex-wrap:wrap;">
      <div style="position:relative; flex:1; min-width:300px; max-width:500px;">
        <svg style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:16px; height:16px; pointer-events:none;" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="artistSearchInput" placeholder="Search artists by name or Instagram..." style="width:100%; padding:12px 16px 12px 42px; font-size:15px; border:1px solid rgba(0,0,0,0.1); border-radius:999px;">
      </div>
      
      <button id="addArtistBtn" class="btn-nav" style="background:#1d1d1f; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Add Artist</span>
      </button>
    </div>
    
    <ul id="artistList" class="artist-list"></ul>
  </section>

  <section id="customers-section">
    <h2>Customers</h2>
    
    <!-- Sort Controls -->
    <div class="sort-controls">
      <label style="font-weight:600; font-size:14px;">Sort by:</label>
      <select id="customerSortBy" class="btn-nav" style="padding:8px 16px;">
        <option value="name">Name</option>
        <option value="rank">Rank</option>
        <option value="created">Created Date</option>
      </select>
      <button id="customerSortOrder" class="btn-nav" data-order="desc">↓ Descending</button>
    </div>
    
    <!-- Search Bar and Add Button Row -->
    <div style="display:flex; justify-content:space-between; align-items:center; gap:20px; margin-bottom:20px; flex-wrap:wrap;">
      <div style="position:relative; flex:1; min-width:300px; max-width:500px;">
        <svg style="position:absolute; left:14px; top:50%; transform:translateY(-50%); width:16px; height:16px; pointer-events:none;" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input 
          type="text" 
          id="customerSearchInput" 
          placeholder="Search customers by name, email or phone..." 
          style="width:100%; padding:12px 16px 12px 42px; font-size:15px; border:1px solid rgba(0,0,0,0.1); border-radius:999px;">
      </div>
      
      <button id="addCustomerBtn" class="btn-nav" style="background:#1d1d1f; color:white; display:flex; align-items:center; gap:8px; padding:10px 20px; white-space:nowrap;">
        <span style="font-size:18px; font-weight:600;">+</span>
        <span>Add Customer</span>
      </button>
    </div>
    
    <table id="customersTable">
      <thead>
        <tr>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Rank</th>
          <th>Created</th>
          <th style="text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody id="customersTableBody"></tbody>
    </table>
  </section>

  <section id="analytics-section">
    <h2>Analytics</h2>
    <p style="color:var(--muted);">Coming soon...</p>
  </section>

  <!-- Add Artist Modal -->
  <div class="modal-backdrop" id="addArtistModal">
    <div class="modal">
      <h3>Add New Artist</h3>
      <form class="modal-form" id="addArtistForm">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="addArtistName" required placeholder="Artist name">
        </div>
        <div class="form-group">
          <label>Instagram Handle</label>
          <input type="text" id="addArtistInstagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="addArtistType">
            <option value="resident">Resident</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        <div class="form-group">
          <label>Location</label>
          <select id="addArtistLocation" required>
            <option value="">-- Select Location --</option>
          </select>
        </div>        </div>
        <div class="form-group">
          <label>City Location</label>
          <select id="addArtistCityLocation" required>
            <option value="">-- Select Location --</option>
            <option value="Stuttgart">Stuttgart</option>
            <option value="Köln">Köln</option>
            <option value="München">München</option>
            <option value="Berlin">Berlin</option>
          </select>
        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="addArtistRank" required>
            <option value="">-- Select Rank --</option>
            <option value="R1">R1</option>
            <option value="R2">R2</option>
            <option value="R3">R3</option>
            <option value="R4">R4</option>
            <option value="R5">R5</option>
          </select>
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="addArtistActive" checked>
            Active
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelAddArtist">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Artist</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Artist Modal -->
  <div class="modal-backdrop" id="editArtistModal">
    <div class="modal">
      <h3>Edit Artist</h3>
      <form class="modal-form" id="editArtistForm">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="editArtistName" required>
        </div>
        <div class="form-group">
          <label>Instagram Handle</label>
          <input type="text" id="editArtistInstagram" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="editArtistType">
            <option value="resident">Resident</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="editArtistActive">
            Active
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelEditArtist">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Assign Team Member Modal -->
  <div class="modal-backdrop" id="assignModal">
    <div class="modal">
      <h3>Assign to Team Member</h3>
      <form class="modal-form" id="assignForm">
        <div class="form-group">
          <label>Team Member</label>
          <select id="assignTeamMember" required>
            <option value="">-- Select Team Member --</option>
            <option value="member1">Name 1</option>
            <option value="member2">Name 2</option>
            <option value="member3">Name 3</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelAssign">Cancel</button>
          <button type="submit" class="btn btn-primary">Assign</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Schedule Appointment Modal -->
  <div class="modal-backdrop" id="scheduleModal">
    <div class="modal">
      <h3>Schedule Appointment</h3>
      <form class="modal-form" id="scheduleForm">
        <div class="form-group">
          <label>Artist</label>
          <select id="scheduleArtist" required>
            <option value="">-- Select Artist --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="scheduleDate" required>
        </div>
        <div class="form-group">
          <label>Start Time</label>
          <select id="scheduleStartTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="form-group">
          <label>End Time</label>
          <select id="scheduleEndTime" required>
            <option value="">-- Select Time --</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
            <option value="18:00">18:00</option>
            <option value="18:30">18:30</option>
            <option value="19:00">19:00</option>
            <option value="19:30">19:30</option>
            <option value="20:00">20:00</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelSchedule">Cancel</button>
          <button type="submit" class="btn btn-success">Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cancel Appointment Modal -->
  <div class="modal-backdrop" id="cancelModal">
    <div class="modal">
      <h3>Cancel Appointment</h3>
      <p style="margin-bottom:20px; color:var(--muted); font-size:15px;">Are you sure you want to cancel this appointment?</p>
      <form class="modal-form" id="cancelForm">
        <div class="form-group">
          <label>Cancellation Reason</label>
          <textarea id="cancelReason" placeholder="Please provide a reason for cancellation..." required style="border-radius:10px;"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelCancelModal">No, Keep it</button>
          <button type="submit" class="btn btn-danger">Yes, Cancel Appointment</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal-backdrop" id="addCustomerModal">
    <div class="modal">
      <h3>Add New Customer</h3>
      <form class="modal-form" id="addCustomerForm">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="addCustomerFirstName" required>
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="addCustomerLastName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="addCustomerEmail" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="addCustomerPhone">
        </div>        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="addCustomerRank">
            <option value="">-- No Rank --</option>
            <option value="Bronze">Bronze</option>
            <option value="Silver">Silver</option>
            <option value="Gold">Gold</option>
            <option value="Platinum">Platinum</option>
          </select>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelAddCustomer">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Customer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Customer Modal -->
  <div class="modal-backdrop" id="editCustomerModal">
    <div class="modal">
      <h3>Edit Customer</h3>
      <form class="modal-form" id="editCustomerForm">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="editCustomerFirstName" required>
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="editCustomerLastName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="editCustomerEmail" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="editCustomerPhone">
        </div>        </div>
        <div class="form-group">
          <label>Rank</label>
          <select id="editCustomerRank">
            <option value="">-- No Rank --</option>
            <option value="Bronze">Bronze</option>
            <option value="Silver">Silver</option>
            <option value="Gold">Gold</option>
            <option value="Platinum">Platinum</option>
          </select>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelEditCustomer">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Event Modal -->
  <div class="modal-backdrop" id="createEventModal">
    <div class="modal" style="max-width:600px;">
      <h3>Create New Event</h3>
      <form class="modal-form" id="createEventForm">
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="createEventTitle" placeholder="e.g. Team Meeting, Workshop, etc." required>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <input type="text" id="createEventType" placeholder="e.g. Meeting, Training, Workshop" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="createEventDescription" placeholder="Event details and notes..." style="border-radius:10px; min-height:80px; resize:vertical;"></textarea>
        </div>
        
        <div class="form-group">
          <label>Visible for Groups</label>
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px; background:rgba(0,0,0,0.02); border-radius:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:600; grid-column:1/-1; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:4px;">
              <input type="checkbox" id="groupCheckboxAll" style="width:auto; padding:0;">
              All Groups
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="geschäftsführung" style="width:auto; padding:0;">
              Geschäftsführung
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="management" style="width:auto; padding:0;">
              Management
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="booking_team" style="width:auto; padding:0;">
              Booking Team
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="mediadepartment" style="width:auto; padding:0;">
              Mediadepartment
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="resident_artists" style="width:auto; padding:0;">
              Resident Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="guest_artists" style="width:auto; padding:0;">
              Guest Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="azubis" style="width:auto; padding:0;">
              Azubis
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:normal;">
              <input type="checkbox" class="group-checkbox" value="andere" style="width:auto; padding:0;">
              Andere
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
            <input type="checkbox" id="createEventAttendanceRequired" style="width:auto; padding:0;">
            <span style="font-weight:500;">Anwesenheitspflicht</span>
          </label>
          <p style="font-size:12px; color:var(--muted); margin:4px 0 0 24px;">Markieren Sie dieses Event als verpflichtend für alle ausgewählten Gruppen</p>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="createEventDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="createEventStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="createEventEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelCreateEvent">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Event</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Event Modal -->
  <div class="modal-backdrop" id="editEventModal">
    <div class="modal" style="max-width:600px;">
      <h3>Edit Event</h3>
      <form class="modal-form" id="editEventForm">
        <input type="hidden" id="editEventId">
        
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="editEventTitle" placeholder="e.g. Team Meeting" required>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <input type="text" id="editEventType" placeholder="e.g. Meeting, Workshop, Training" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="editEventDescription" placeholder="Add details about this event..." style="border-radius:10px; min-height:80px;"></textarea>
        </div>
        
        <div class="form-group">
          <label>Visible for Groups</label>
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px; background:rgba(0,0,0,0.02); border-radius:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:600; grid-column:1/-1; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:4px;">
              <input type="checkbox" id="editGroupCheckboxAll" style="width:auto; padding:0;">
              All Groups
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="geschäftsführung" style="width:auto; padding:0;">
              Geschäftsführung
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="management" style="width:auto; padding:0;">
              Management
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="booking_team" style="width:auto; padding:0;">
              Booking Team
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="mediadepartment" style="width:auto; padding:0;">
              Mediadepartment
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="resident_artists" style="width:auto; padding:0;">
              Resident Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="guest_artists" style="width:auto; padding:0;">
              Guest Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="azubis" style="width:auto; padding:0;">
              Azubis
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="andere" style="width:auto; padding:0;">
              Andere
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
            <input type="checkbox" id="editEventAttendanceRequired" style="width:auto; padding:0;">
            <span style="font-weight:500;">Anwesenheitspflicht</span>
          </label>
          <p style="font-size:12px; color:var(--muted); margin:4px 0 0 24px;">Markieren Sie dieses Event als verpflichtend für alle ausgewählten Gruppen</p>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="editEventDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="editEventStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="editEventEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete Event</button>
          <div style="flex:1;"></div>
          <button type="button" class="btn btn-secondary" id="cancelEditEvent">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Booking Modal -->
  <div class="modal-backdrop" id="editBookingModal">
    <div class="modal" style="max-width:600px;">
      <h3>Edit Booking</h3>
      <form class="modal-form" id="editBookingForm">
        <input type="hidden" id="editBookingId">
        
        <div class="form-group">
          <label>Customer Name</label>
          <input type="text" id="editBookingCustomer" placeholder="Customer Name" required>
        </div>
        
        <div class="form-group">
          <label>Booking Type</label>
          <select id="editBookingType" required>
            <option value="">-- Select Type --</option>
            <option value="consultation">Consultation</option>
            <option value="new_tattoo">New Tattoo</option>
            <option value="continuing_tattoo">Continuing Tattoo</option>
            <option value="touch_up">Touch Up</option>
            <option value="selfbooking">Selfbooking</option>
            <option value="wannado">WannaDo</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Artist</label>
          <input type="text" id="editBookingArtistName" disabled style="background:#f5f5f5;">
          <input type="hidden" id="editBookingArtistId">
          <p style="font-size:12px; color:var(--muted); margin:4px 0 0 0;">Artist cannot be changed after booking creation</p>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="editBookingDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="editBookingStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="editBookingEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteBookingBtn">Delete Booking</button>
          <div style="flex:1;"></div>
          <button type="button" class="btn btn-secondary" id="cancelEditBooking">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Booking Modal -->
  <div class="modal-backdrop" id="editEventModal">
    <div class="modal" style="max-width:600px;">
      <h3>Edit Event</h3>
      <form class="modal-form" id="editEventForm">
        <input type="hidden" id="editEventId">
        
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="editEventTitle" placeholder="e.g. Team Meeting" required>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <input type="text" id="editEventType" placeholder="e.g. Meeting, Workshop, Training" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="editEventDescription" placeholder="Add details about this event..." style="border-radius:10px; min-height:80px;"></textarea>
        </div>
        
        <div class="form-group">
          <label>Visible for Groups</label>
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px; background:rgba(0,0,0,0.02); border-radius:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:600; grid-column:1/-1; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:4px;">
              <input type="checkbox" id="editGroupCheckboxAll" style="width:auto; padding:0;">
              All Groups
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="geschäftsführung" style="width:auto; padding:0;">
              Geschäftsführung
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="management" style="width:auto; padding:0;">
              Management
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="booking_team" style="width:auto; padding:0;">
              Booking Team
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="mediadepartment" style="width:auto; padding:0;">
              Mediadepartment
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="resident_artists" style="width:auto; padding:0;">
              Resident Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="guest_artists" style="width:auto; padding:0;">
              Guest Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="azubis" style="width:auto; padding:0;">
              Azubis
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="andere" style="width:auto; padding:0;">
              Andere
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
            <input type="checkbox" id="editEventAttendanceRequired" style="width:auto; padding:0;">
            <span style="font-weight:500;">Anwesenheitspflicht</span>
          </label>
          <p style="font-size:12px; color:var(--muted); margin:4px 0 0 24px;">Markieren Sie dieses Event als verpflichtend für alle ausgewählten Gruppen</p>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="editEventDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="editEventStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="editEventEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete Event</button>
          <div style="flex:1;"></div>
          <button type="button" class="btn btn-secondary" id="cancelEditEvent">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Booking Modal -->
  <div class="modal-backdrop" id="createBookingModal">
    <div class="modal" style="max-width:600px;">
      <h3>Create New Booking</h3>
      <form class="modal-form" id="createBookingForm">
        <div class="form-group">
          <label>Customer Name</label>
          <input type="text" id="createBookingCustomer" placeholder="e.g. John Doe" required>
        </div>
        
        <div class="form-group">
          <label>Booking Type</label>
          <select id="createBookingType" required>
            <option value="">-- Select Type --</option>
            <option value="consultation">Consultation</option>
            <option value="new_tattoo">New Tattoo</option>
            <option value="continuing_tattoo">Continuing Tattoo</option>
            <option value="touch_up">Touch Up</option>
            <option value="selfbooking">Selfbooking</option>
            <option value="wannado">WannaDo</option>
            <option value="internal">Internal</option>
            <option value="move">Move</option>
            <option value="reserved">Reserved</option>
            <option value="no_show">No Show</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Artist Type</label>
          <select id="createBookingArtistType" required>
            <option value="">-- Select Artist Type --</option>
            <option value="resident">Resident</option>
            <option value="guest">Guest</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Search Artist</label>
          <input type="text" id="createBookingArtistSearch" placeholder="Type to search artist..." disabled>
          <input type="hidden" id="createBookingArtistId">
          <div id="artistSearchResults" style="display:none; max-height:200px; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); border-radius:8px; margin-top:4px; background:white;"></div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="createBookingDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="createBookingStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="createBookingEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelCreateBooking">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Booking</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit/View Event Modal -->
  <div class="modal-backdrop" id="editEventModal">
    <div class="modal" style="max-width:600px;">
      <h3 id="editEventModalTitle">Event Details</h3>
      <form class="modal-form" id="editEventForm">
        <div class="form-group">
          <label>Event Title</label>
          <input type="text" id="editEventTitle" required>
        </div>
        
        <div class="form-group">
          <label>Event Type</label>
          <input type="text" id="editEventType" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="editEventDescription" rows="3" style="border-radius:10px; resize:vertical;"></textarea>
        </div>
        
        <div class="form-group" id="editEventArtistGroup" style="display:none;">
          <label>Artist</label>
          <input type="text" id="editEventArtistName" readonly style="background:rgba(0,0,0,0.05);">
        </div>
        
        <div class="form-group" id="editEventGroupsContainer">
          <label>Visible for Groups</label>
          <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px; background:rgba(0,0,0,0.02); border-radius:10px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; font-weight:600; grid-column:1/-1; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:4px;">
              <input type="checkbox" id="editGroupCheckboxAll" style="width:auto; padding:0;">
              All Groups
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="geschäftsführung" style="width:auto; padding:0;">
              Geschäftsführung
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="management" style="width:auto; padding:0;">
              Management
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="booking_team" style="width:auto; padding:0;">
              Booking Team
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="mediadepartment" style="width:auto; padding:0;">
              Mediadepartment
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="resident_artists" style="width:auto; padding:0;">
              Resident Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="guest_artists" style="width:auto; padding:0;">
              Guest Artists
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="azubis" style="width:auto; padding:0;">
              Azubis
            </label>
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;">
              <input type="checkbox" class="edit-group-checkbox" value="andere" style="width:auto; padding:0;">
              Andere
            </label>
          </div>
        </div>
        
        <div class="form-group" id="editEventAttendanceGroup">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px;">
            <input type="checkbox" id="editEventAttendanceRequired" style="width:auto; padding:0;">
            <span style="font-weight:500;">Anwesenheitspflicht</span>
          </label>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr; gap:16px;">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="editEventDate" required>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Start Time</label>
            <select id="editEventStartTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>End Time</label>
            <select id="editEventEndTime" required>
              <option value="">-- Select Time --</option>
              <option value="10.0">10:00</option>
              <option value="10.5">10:30</option>
              <option value="11.0">11:00</option>
              <option value="11.5">11:30</option>
              <option value="12.0">12:00</option>
              <option value="12.5">12:30</option>
              <option value="13.0">13:00</option>
              <option value="13.5">13:30</option>
              <option value="14.0">14:00</option>
              <option value="14.5">14:30</option>
              <option value="15.0">15:00</option>
              <option value="15.5">15:30</option>
              <option value="16.0">16:00</option>
              <option value="16.5">16:30</option>
              <option value="17.0">17:00</option>
              <option value="17.5">17:30</option>
              <option value="18.0">18:00</option>
              <option value="18.5">18:30</option>
              <option value="19.0">19:00</option>
              <option value="19.5">19:30</option>
              <option value="20.0">20:00</option>
            </select>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete Event</button>
          <div style="flex:1;"></div>
          <button type="button" class="btn btn-secondary" id="cancelEditEvent">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://auxxyehgzkozdjylhqnx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1eHh5ZWhnemtvemRqeWxocW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDczODgsImV4cCI6MjA3NjEyMzM4OH0.bg8NunF2qkps28Aj0ZqY35eKK--QOu8NduCkFyqp5KA";
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentDate = new Date();
    let dienstplanDate = new Date();
    let events = [];
    let allArtists = [];
    let allTeamMembers = [];
    
    // Sorting state
    let artistSortConfig = { field: 'name', order: 'asc' };
    let customerSortConfig = { field: 'created_at', order: 'desc' };
    let currentEditingEvent = null;
    let selectedLocationId = null;
    let selectedDienstplanLocationId = null;
    let currentLocationName = '';
    let openCategories = new Set();
    
    // Category visibility state
    let visibleCategories = {
      events: true,
      residents: true,
      guests: true
    };

    // Google-inspirierte Farbschemata pro Location
    const locationColors = {
      'mommy': {
        primary: '#8E24AA',      // Purple
        light: '#F3E5F5',
        dark: '#6A1B9A',
        accent: '#BA68C8'
      },
      'gon': {
        primary: '#1976D2',      // Blue
        light: '#E3F2FD',
        dark: '#0D47A1',
        accent: '#42A5F5'
      },
      'muttersöhne': {
        primary: '#43A047',      // Green
        light: '#E8F5E9',
        dark: '#2E7D32',
        accent: '#66BB6A'
      },
      'pardon': {
        primary: '#E53935',      // Red
        light: '#FFEBEE',
        dark: '#C62828',
        accent: '#EF5350'
      },
      'default': {
        primary: '#111827',      // Dark Gray
        light: '#F3F4F6',
        dark: '#0F172A',
        accent: '#6B7280'
      }
    };

    function getLocationColors(locationName) {
      const name = (locationName || '').toLowerCase();
      if (name.includes('mommy')) return locationColors.mommy;
      if (name.includes('gon')) return locationColors.gon;
      if (name.includes('muttersöhne') || name.includes('muttersohne')) return locationColors.muttersöhne;
      if (name.includes('pardon')) return locationColors.pardon;
      return locationColors.default;
    }

    
    
    // Sorting Functions
    function sortArtists(artists, field, order) {
      const sorted = [...artists].sort((a, b) => {
        let aVal, bVal;
        
        if (field === 'name') {
          aVal = (a.name || '').toLowerCase();
          bVal = (b.name || '').toLowerCase();
        } else if (field === 'rank') {
          const rankOrder = { 'R1': 1, 'R2': 2, 'R3': 3, 'R4': 4, 'R5': 5 };
          aVal = rankOrder[a.rank] || 999;
          bVal = rankOrder[b.rank] || 999;
        } else if (field === 'location') {
          aVal = (a.city_location || '').toLowerCase();
          bVal = (b.city_location || '').toLowerCase();
        }
        
        if (aVal < bVal) return order === 'asc' ? -1 : 1;
        if (aVal > bVal) return order === 'asc' ? 1 : -1;
        return 0;
      });
      
      return sorted;
    }
    
    function sortCustomers(customers, field, order) {
      const sorted = [...customers].sort((a, b) => {
        let aVal, bVal;
        
        if (field === 'name') {
          aVal = `${a.first_name || ''} ${a.last_name || ''}`.toLowerCase();
          bVal = `${b.first_name || ''} ${b.last_name || ''}`.toLowerCase();
        } else if (field === 'rank') {
          const rankOrder = { 'Bronze': 1, 'Silver': 2, 'Gold': 3, 'Platinum': 4 };
          aVal = rankOrder[a.rank] || 0;
          bVal = rankOrder[b.rank] || 0;
        } else if (field === 'created') {
          aVal = new Date(a.created_at).getTime();
          bVal = new Date(b.created_at).getTime();
        }
        
        if (aVal < bVal) return order === 'asc' ? -1 : 1;
        if (aVal > bVal) return order === 'asc' ? 1 : -1;
        return 0;
      });
      
      return sorted;
    }

    function applyLocationTheme(colors) {
      const root = document.documentElement;
      root.style.setProperty('--location-primary', colors.primary);
      root.style.setProperty('--location-light', colors.light);
      root.style.setProperty('--location-dark', colors.dark);
      root.style.setProperty('--location-accent', colors.accent);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const tabs = document.querySelectorAll("nav a");
      const sections = document.querySelectorAll("section");

      await loadInitialData();

      // Request tabs initialization function
      function initRequestTabs() {
        const requestTabs = document.querySelectorAll('.request-tab');
        const requestsIndicator = document.getElementById('requestsIndicator');
        
        console.log('Init Request tabs found:', requestTabs.length);
        console.log('Init Indicator element:', requestsIndicator);
        
        if (!requestsIndicator || requestTabs.length === 0) {
          console.error('Missing indicator or tabs');
          return;
        }
        
        function updateRequestsIndicator(tab) {
          if (!requestsIndicator || !tab) return;
          
          const tabRect = tab.getBoundingClientRect();
          const containerRect = tab.parentElement.getBoundingClientRect();
          const left = tabRect.left - containerRect.left;
          const width = tabRect.width;
          
          console.log('Updating indicator - Left:', left, 'Width:', width);
          
          requestsIndicator.style.width = `${width}px`;
          requestsIndicator.style.transform = `translateX(${left}px)`;
        }
        
        // Initialize indicator position
        setTimeout(() => {
          const activeTab = document.querySelector('.request-tab.active');
          if (activeTab) {
            console.log('Initializing indicator for active tab');
            updateRequestsIndicator(activeTab);
          }
        }, 50);
        
        // Add click listeners
        requestTabs.forEach((tab, index) => {
          console.log('Adding click listener to tab', index, tab.textContent);
          
          // Remove old listeners by cloning
          const newTab = tab.cloneNode(true);
          tab.parentNode.replaceChild(newTab, tab);
          
          newTab.addEventListener('click', function(e) {
            console.log('Tab clicked:', this.textContent, 'Status:', this.dataset.status);
            
            // Update current status
            currentRequestStatus = this.dataset.status;
            console.log('Updated currentRequestStatus to:', currentRequestStatus);
            
            document.querySelectorAll('.request-tab').forEach(t => {
              t.classList.remove('active');
              t.style.color = '#86868b';
            });
            this.classList.add('active');
            this.style.color = '#1d1d1f';
            
            updateRequestsIndicator(this);
            
            // Close detail view when switching tabs
            selectedRequestId = null;
            closeRequestDetail();
            
            loadRequests();
          });
        });
      }

      function showSection(tab) {
        tabs.forEach(x => x.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));
        tab.classList.add("active");
        
        const tabName = tab.id.replace("tab-", "");
        const target = document.getElementById(tabName + "-section");
        if (target) {
          target.classList.add("active");
          if (tabName === "dashboard") loadDashboard();
          else if (tabName === "requests") {
            loadRequests();
            initRequestTabs();
          }
          else if (tabName === "calendar") renderCalendar();
          else if (tabName === "dienstplan") renderDienstplan();
          else if (tabName === "artists") loadArtists();
          else if (tabName === "customers") loadCustomers();
        }
      }

      tabs.forEach(tab => tab.addEventListener("click", () => showSection(tab)));

      async function loadInitialData() {
        try {
          const { data: artists } = await supabase.from('artists').select('*');
          allArtists = artists || [];
          console.log('Artists loaded:', allArtists.length);
          
          // Load team members
          const { data: teamMembers } = await supabase.from('team_members').select('*').order('category', { ascending: true }).order('name', { ascending: true });
          allTeamMembers = teamMembers || [];
          console.log('Team members loaded:', allTeamMembers.length);
          
          const { data: locations } = await supabase.from('locations').select('*').order('name', { ascending: true });
          console.log('Locations loaded:', locations?.length);
          
          if (locations && locations.length > 0) {
            // Finde "mommy i'm sorry" oder nimm die erste Location
            const mommyLocation = locations.find(l => l.name.toLowerCase().includes("mommy"));
            selectedLocationId = mommyLocation ? mommyLocation.id : locations[0].id;
            selectedDienstplanLocationId = selectedLocationId;
            
            // Set initial location name and theme
            const initialLocation = locations.find(l => l.id === selectedLocationId);
            if (initialLocation) {
              currentLocationName = initialLocation.name;
              const colors = getLocationColors(currentLocationName);
              applyLocationTheme(colors);
            }
            
            const locSelect = document.getElementById('locationDropdown');
            locSelect.innerHTML = locations.map(l => 
              `<option value="${l.id}" ${l.id === selectedLocationId ? 'selected' : ''}>${l.name}</option>`
            ).join('');
            
            locSelect.onchange = async (e) => {
              selectedLocationId = e.target.value;
              console.log('Location changed to:', selectedLocationId);
              
              // Get location name and apply theme
              const selectedLocation = locations.find(l => l.id === selectedLocationId);
              if (selectedLocation) {
                currentLocationName = selectedLocation.name;
                const colors = getLocationColors(currentLocationName);
                applyLocationTheme(colors);
              }
              
              await loadEvents();
              renderCalendar();
            };
            
            // Dienstplan Location Dropdown
            const dienstplanLocSelect = document.getElementById('dienstplanLocationDropdown');
            dienstplanLocSelect.innerHTML = locations.map(l => 
              `<option value="${l.id}" ${l.id === selectedDienstplanLocationId ? 'selected' : ''}>${l.name}</option>`
            ).join('');
            
            dienstplanLocSelect.onchange = (e) => {
              selectedDienstplanLocationId = e.target.value;
              console.log('Dienstplan location changed to:', selectedDienstplanLocationId);
              renderDienstplan();
            };
          }
          
          await loadEvents();
          await loadDashboard();
        } catch(err) {
          console.error("Load error:", err);
          alert("Error loading data: " + err.message);
        }
      }

      async function loadDashboard() {
        try {
          const { data: reqs } = await supabase.from('requests').select('*');
          const { data: artists } = await supabase.from('artists').select('*');
          
          document.getElementById('badge-pending').textContent = `Pending: ${reqs?.filter(r=>r.status==='pending').length || 0}`;
          document.getElementById('badge-scheduled').textContent = `Scheduled: ${reqs?.filter(r=>r.status==='scheduled').length || 0}`;
          document.getElementById('badge-residents').textContent = `Residents: ${artists?.filter(a=>!a.is_guest).length || 0}`;
          document.getElementById('badge-guests').textContent = `Guests: ${artists?.filter(a=>a.is_guest).length || 0}`;
        } catch(err) {
          console.error("Dashboard error:", err);
        }
      }

      let allRequests = [];
      let currentRequestStatus = 'open_request';
      let selectedRequestId = null;
      let currentUser = null; // null = not logged in, 'member1'/'member2'/'member3' = logged in
      
      async function loadRequests() {
        try {
          const { data, error } = await supabase
            .from('requests')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          
          allRequests = data || [];
          
          // Filter by status
          let filteredRequests = allRequests;
          if (currentRequestStatus === 'my-requests') {
            filteredRequests = allRequests.filter(r => r.assigned_to === currentUser);
          } else if (currentRequestStatus !== 'all') {
            filteredRequests = allRequests.filter(r => r.status === currentRequestStatus);
          }
          
          renderRequestsList(filteredRequests);
          updateRequestBadges();
        } catch(err) {
          console.error("Requests error:", err);
        }
      }
      
      function renderRequestsList(requests) {
        const listEl = document.getElementById('requestsList');
        
        // Check if viewing "My Requests" without being logged in
        if (currentRequestStatus === 'my-requests' && !currentUser) {
          listEl.innerHTML = `
            <div style="text-align:center; padding:60px 20px; color:var(--muted);">
              <div style="font-size:48px; margin-bottom:16px;">🔒</div>
              <div style="font-size:18px; font-weight:600; margin-bottom:8px; color:var(--ink);">Nicht angemeldet</div>
              <div style="font-size:14px;">Bitte melden Sie sich an, um Ihre zugewiesenen Requests zu sehen.</div>
            </div>
          `;
          return;
        }
        
        if (requests.length === 0) {
          let emptyMessage = 'No requests found';
          if (currentRequestStatus === 'my-requests') {
            emptyMessage = 'Sie haben keine zugewiesenen Requests';
          } else if (currentRequestStatus === 'open_request') {
            emptyMessage = 'Keine neuen Requests';
          } else if (currentRequestStatus === 'pending') {
            emptyMessage = 'Keine Requests in Bearbeitung';
          } else if (currentRequestStatus === 'scheduled') {
            emptyMessage = 'Keine geplanten Termine';
          } else if (currentRequestStatus === 'finished') {
            emptyMessage = 'Keine abgeschlossenen Requests';
          } else if (currentRequestStatus === 'canceled') {
            emptyMessage = 'Keine stornierten Requests';
          }
          
          listEl.innerHTML = `<div style="text-align:center; padding:40px; color:var(--muted);">${emptyMessage}</div>`;
          return;
        }
        
        // Status display names mapping
        const statusNames = {
          'open_request': 'New',
          'pending': 'Pending',
          'scheduled': 'Scheduled',
          'finished': 'Finished',
          'canceled': 'Canceled'
        };
        
        listEl.innerHTML = requests.map(req => `
          <div class="request-item ${req.status === 'open_request' ? 'new-status' : ''}" data-id="${req.id}">
            <div class="request-header">
              <div class="request-id">#${req.id.substring(0, 8).toUpperCase()}</div>
              <div class="request-badge ${req.status}">${statusNames[req.status] || req.status}</div>
            </div>
            <div class="request-name">${req.first_name || ''} ${req.last_name || ''}</div>
            <div class="request-date">${new Date(req.created_at).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
          </div>
        `).join('');
        
        // Add click handlers with toggle functionality
        document.querySelectorAll('.request-item').forEach(item => {
          item.addEventListener('click', () => {
            const isAlreadyActive = item.classList.contains('active');
            
            // Remove active class from all items
            document.querySelectorAll('.request-item').forEach(i => i.classList.remove('active'));
            
            if (isAlreadyActive) {
              // If clicking on already active item, close detail view
              selectedRequestId = null;
              closeRequestDetail();
            } else {
              // Otherwise, open the clicked item
              item.classList.add('active');
              selectedRequestId = item.dataset.id;
              showRequestDetail(selectedRequestId);
            }
          });
        });
      }
      
      function closeRequestDetail() {
        const detailEl = document.getElementById('requestDetail');
        detailEl.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--muted); font-size:16px;">
            Select a request to view details
          </div>
        `;
      }
      
      function showRequestDetail(requestId) {
        const request = allRequests.find(r => r.id === requestId);
        if (!request) return;
        
        const detailEl = document.getElementById('requestDetail');
        
        // Status display names
        const statusNames = {
          'open_request': 'New',
          'pending': 'Pending',
          'scheduled': 'Scheduled',
          'finished': 'Finished',
          'canceled': 'Canceled'
        };
        
        let actions = '';
        if (request.status === 'open_request') {
          actions = `<button class="btn btn-primary" onclick="assignRequest()">Assign to Team Member</button>`;
        } else if (request.status === 'pending') {
          actions = `<button class="btn btn-success" onclick="scheduleAppointment()">Schedule Appointment</button>`;
        } else if (request.status === 'scheduled') {
          actions = `<button class="btn btn-danger" onclick="cancelAppointment()">Cancel Appointment</button>`;
        }
        
        detailEl.innerHTML = `
          <div class="detail-section">
            <h3>Customer Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Name</div>
                <div class="detail-value">${request.first_name || ''} ${request.last_name || ''}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Email</div>
                <div class="detail-value">${request.email || '-'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Phone</div>
                <div class="detail-value">${request.customer_phone || '-'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Status</div>
                <div class="detail-value"><span class="request-badge ${request.status}">${statusNames[request.status] || request.status}</span></div>
              </div>
            </div>
          </div>
          
          <div class="detail-section">
            <h3>Request Details</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <div class="detail-label">Placement</div>
                <div class="detail-value">${request.placement || '-'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Size</div>
                <div class="detail-value">${request.size || '-'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Style</div>
                <div class="detail-value">${request.style || '-'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Preferred Artist</div>
                <div class="detail-value">${request.preferred_artist || 'Any'}</div>
              </div>
            </div>
            ${request.description ? `
              <div class="detail-item" style="margin-top:16px;">
                <div class="detail-label">Description</div>
                <div class="detail-value">${request.description}</div>
              </div>
            ` : ''}
          </div>
          
          ${request.assigned_to ? `
            <div class="detail-section">
              <h3>Assignment</h3>
              <div class="detail-item">
                <div class="detail-label">Assigned To</div>
                <div class="detail-value">${request.assigned_to}</div>
              </div>
            </div>
          ` : ''}
          
          ${request.scheduled_date ? `
            <div class="detail-section">
              <h3>Appointment</h3>
              <div class="detail-grid">
                <div class="detail-item">
                  <div class="detail-label">Artist</div>
                  <div class="detail-value">${request.artist_name || '-'}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Date</div>
                  <div class="detail-value">${new Date(request.scheduled_date).toLocaleDateString('de-DE')}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Start Time</div>
                  <div class="detail-value">${request.start_time || '-'}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">End Time</div>
                  <div class="detail-value">${request.end_time || '-'}</div>
                </div>
              </div>
            </div>
          ` : ''}
          
          ${request.cancel_reason ? `
            <div class="detail-section">
              <h3>Cancellation</h3>
              <div class="detail-item">
                <div class="detail-label">Reason</div>
                <div class="detail-value">${request.cancel_reason}</div>
              </div>
            </div>
          ` : ''}
          
          ${actions ? `<div class="action-buttons">${actions}</div>` : ''}
        `;
      }
      
      function updateRequestBadges() {
        const newCount = allRequests.filter(r => r.status === 'open_request').length;
        const badgeEl = document.getElementById('badge-new');
        if (badgeEl) {
          badgeEl.textContent = newCount;
          badgeEl.style.display = newCount > 0 ? 'inline-block' : 'none';
        }
      }
      
      // Request Tab Switching is handled in initRequestTabs()
      
      // Assign Request
      window.assignRequest = function() {
        document.getElementById('assignModal').classList.add('active');
      };
      
      document.getElementById('cancelAssign')?.addEventListener('click', () => {
        document.getElementById('assignModal').classList.remove('active');
      });
      
      document.getElementById('assignForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const teamMember = document.getElementById('assignTeamMember').value;
        
        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'pending',
              assigned_to: teamMember
            })
            .eq('id', selectedRequestId);
          
          if (error) throw error;
          
          document.getElementById('assignModal').classList.remove('active');
          document.getElementById('assignForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('Request assigned successfully!');
        } catch (err) {
          alert('Error assigning request: ' + err.message);
        }
      });
      
      // Schedule Appointment
      window.scheduleAppointment = async function() {
        // Load artists
        const { data: artists } = await supabase.from('artists').select('*');
        const artistSelect = document.getElementById('scheduleArtist');
        artistSelect.innerHTML = '<option value="">-- Select Artist --</option>' +
          (artists || []).map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        
        document.getElementById('scheduleModal').classList.add('active');
      };
      
      document.getElementById('cancelSchedule')?.addEventListener('click', () => {
        document.getElementById('scheduleModal').classList.remove('active');
      });
      
      document.getElementById('scheduleForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const artistId = document.getElementById('scheduleArtist').value;
        const date = document.getElementById('scheduleDate').value;
        const startTime = document.getElementById('scheduleStartTime').value;
        const endTime = document.getElementById('scheduleEndTime').value;
        
        try {
          // Get artist name
          const { data: artist } = await supabase
            .from('artists')
            .select('name')
            .eq('id', artistId)
            .single();
          
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'scheduled',
              artist_id: artistId,
              artist_name: artist?.name,
              scheduled_date: date,
              start_time: startTime,
              end_time: endTime
            })
            .eq('id', selectedRequestId);
          
          if (error) throw error;
          
          document.getElementById('scheduleModal').classList.remove('active');
          document.getElementById('scheduleForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('Appointment scheduled successfully!');
        } catch (err) {
          alert('Error scheduling appointment: ' + err.message);
        }
      });
      
      // Cancel Appointment
      window.cancelAppointment = function() {
        document.getElementById('cancelModal').classList.add('active');
      };
      
      document.getElementById('cancelCancelModal')?.addEventListener('click', () => {
        document.getElementById('cancelModal').classList.remove('active');
      });
      
      document.getElementById('cancelForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const reason = document.getElementById('cancelReason').value;
        
        try {
          const { error } = await supabase
            .from('requests')
            .update({
              status: 'canceled',
              cancel_reason: reason
            })
            .eq('id', selectedRequestId);
          
          if (error) throw error;
          
          document.getElementById('cancelModal').classList.remove('active');
          document.getElementById('cancelForm').reset();
          await loadRequests();
          showRequestDetail(selectedRequestId);
          alert('Appointment canceled');
        } catch (err) {
          alert('Error canceling appointment: ' + err.message);
        }
      });
      
      // Auto-move scheduled to finished (check every minute)
      setInterval(async () => {
        const now = new Date();
        const scheduledRequests = allRequests.filter(r => r.status === 'scheduled' && r.scheduled_date && r.end_time);
        
        for (const req of scheduledRequests) {
          const endDateTime = new Date(`${req.scheduled_date}T${req.end_time}`);
          if (now > endDateTime) {
            await supabase
              .from('requests')
              .update({ status: 'finished' })
              .eq('id', req.id);
          }
        }
        
        if (scheduledRequests.length > 0) {
          await loadRequests();
        }
      }, 60000); // Check every minute

      let currentEditArtistId = null;
      let currentEditCustomerId = null;

      async function loadArtists() {
        try {
          const { data } = await supabase.from('artists').select('*');
          allArtists = data || [];
          
          // Apply sorting
          const sorted = sortArtists(allArtists, artistSortConfig.field, artistSortConfig.order);
          const list = document.getElementById('artistList');
          
          if (!data || data.length === 0) {
            list.innerHTML = '<li style="padding:20px; text-align:center; color:var(--muted);">No artists yet. Add one above!</li>';
            return;
          }
          
          list.innerHTML = sorted.map(artist => `
            <li class="artist-item">
              <div class="artist-info">
                <span class="artist-name">${artist.name}</span>
                <span class="artist-badge ${artist.is_guest ? 'guest' : ''}">${artist.is_guest ? 'Guest' : 'Resident'}</span>
                ${artist.city_location ? `<span class="artist-location">${artist.city_location}</span>` : ''}
                ${artist.rank ? `<span class="artist-rank">${artist.rank}</span>` : ''}
                ${artist.instagram ? `<span class="artist-instagram">@${artist.instagram}</span>` : ''}
                ${!artist.active ? '<span style="color:#ff3b30; font-size:12px; margin-left:8px;">(Inactive)</span>' : ''}
              </div>
              <div class="artist-actions">
                <button class="btn-icon" onclick="editArtist('${artist.id}')" title="Edit">✏️</button>
                <button class="btn-icon" onclick="deleteArtist('${artist.id}')" title="Delete">🗑️</button>
              </div>
            </li>
          `).join('');
        } catch(err) {
          console.error("Artists error:", err);
        }
      }

      let allCustomers = [];
      
      async function loadCustomers(searchTerm = '') {
        try {
          const { data: customers } = await supabase.from('customers').select('*').order('created_at', { ascending: false });
          
          allCustomers = customers || [];
          
          // Filter customers if search term provided
          let filteredCustomers = allCustomers;
          if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filteredCustomers = allCustomers.filter(customer => 
              (customer.first_name?.toLowerCase().includes(term)) ||
              (customer.last_name?.toLowerCase().includes(term)) ||
              (customer.email?.toLowerCase().includes(term)) ||
              (customer.phone?.toLowerCase().includes(term))
            );
          }
          
          const tbody = document.getElementById('customersTableBody');
          
          if (filteredCustomers.length === 0) {
            if (searchTerm) {
              tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--muted);">No customers found matching your search</td></tr>';
            } else {
              tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--muted);">No customers yet</td></tr>';
            }
            return;
          }
          
          tbody.innerHTML = filteredCustomers.map(customer => `
            <tr>
              <td>${customer.first_name || '-'}</td>
              <td>${customer.last_name || '-'}</td>
              <td>${customer.email || '-'}</td>
              <td>${customer.phone || '-'}</td>
              <td>${customer.rank ? `<span class="customer-rank ${customer.rank.toLowerCase()}">${customer.rank}</span>` : '-'}</td>
              <td style="font-size:13px; color:var(--muted);">${new Date(customer.created_at).toLocaleDateString()}</td>
              <td style="text-align:right;">
                <button class="btn-icon" onclick="editCustomer('${customer.id}')" title="Edit">✏️</button>
                <button class="btn-icon" onclick="deleteCustomer('${customer.id}')" title="Delete">🗑️</button>
              </td>
            </tr>
          `).join('');
        } catch(err) {
          console.error("Customers error:", err);
        }
      }      
      // Customer Sort Controls
      document.getElementById('customerSortBy')?.addEventListener('change', (e) => {
        customerSortConfig.field = e.target.value;
        loadCustomers();
      });
      
      document.getElementById('customerSortOrder')?.addEventListener('click', function() {
        customerSortConfig.order = customerSortConfig.order === 'asc' ? 'desc' : 'asc';
        this.dataset.order = customerSortConfig.order;
        this.innerHTML = customerSortConfig.order === 'asc' ? '↑ Ascending' : '↓ Descending';
        loadCustomers();
      });

      async function loadEvents() {
        try {
          if (!selectedLocationId) {
            console.log('No location selected');
            events = [];
            return;
          }
          
          const { data, error } = await supabase
            .from('events')
            .select('*')
            .eq('location_id', selectedLocationId);
          
          if (error) throw error;
          
          console.log(`Events loaded for location ${selectedLocationId}:`, data?.length);
          
          events = (data || []).map(e => {
            const artist = allArtists.find(a => a.id === e.artist_id);
            const start = new Date(e.start_time);
            const end = new Date(e.end_time);
            
            // Determine category:
            // - If no artist_id, it's an 'events' category event
            // - If artist exists and is guest, it's 'guest'
            // - If artist exists and is not guest, it's 'resident'
            let category = 'events';
            if (e.artist_id && artist) {
              category = artist.is_guest ? 'guest' : 'resident';
            }
            
            return {
              id: e.id,
              date: e.start_time.split('T')[0],
              category: category,
              slot: e.slot || 1, // Use slot from database, default to 1 if not set
              title: e.title || artist?.name || 'Event',
              type: e.type || null,
              artistName: artist?.name || null,
              customerName: e.title || null,
              attendanceRequired: e.attendance_required || false,
              startHour: start.getHours() + start.getMinutes()/60,
              endHour: end.getHours() + end.getMinutes()/60
            };
          });
          
          // Update Location Info
          const { data: locationData } = await supabase
            .from('locations')
            .select('name')
            .eq('id', selectedLocationId)
            .single();
          
          const infoDiv = document.getElementById('locationInfo');
          if (infoDiv) {
            infoDiv.textContent = `📍 Showing ${events.length} appointment${events.length !== 1 ? 's' : ''} for ${locationData?.name || 'this location'}`;
          }
          
          console.log('Processed events:', events);
        } catch(err) {
          console.error("Events error:", err);
          events = [];
        }
      }
      
      // Find available slot for a given date, category, start and end hour
      function findAvailableSlot(date, category, startHour, endHour) {
        // Get all events for this date and category
        const dateEvents = events.filter(e => 
          e.date === date && 
          e.category === category
        );
        
        // Check each slot from 1-10
        for (let slot = 1; slot <= 10; slot++) {
          // Check if this slot has any overlapping events
          const hasConflict = dateEvents.some(e => 
            e.slot === slot &&
            !(endHour <= e.startHour || startHour >= e.endHour)
          );
          
          if (!hasConflict) {
            return slot; // Found a free slot
          }
        }
        
        return null; // All slots are occupied
      }

      function renderCalendar() {
        const dateStr = currentDate.toISOString().split('T')[0];
        document.getElementById('datePickerInput').value = dateStr;
        
        // Update date display (z.B. "Mo. 20. Oktober 2025")
        const dateDisplayTop = document.getElementById('currentDateDisplayTop');
        if (dateDisplayTop) {
          const day = currentDate.getDate();
          const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 
                              'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
          const month = monthNames[currentDate.getMonth()];
          const year = currentDate.getFullYear();
          const weekdayShort = currentDate.toLocaleDateString('de-DE', { weekday: 'short' });
          const formattedDate = `${weekdayShort} ${day}. ${month} ${year}`;
          dateDisplayTop.textContent = formattedDate;
        }
        
        // Check if today
        const today = new Date();
        const isToday = dateStr === today.toISOString().split('T')[0];
        
        const container = document.getElementById('calendarContainer');
        if (!container) return;

        let html = '<div class="calendar-grid" style="position:relative;">';
        
        html += '<div class="calendar-header"><div class="slot-header">Slots</div>';
        for (let h = 10; h <= 20; h++) html += `<div class="hour-header" style="grid-column:span 2;">${h}:00</div>`;
        html += '</div>';

        // Define categories to render
        const categoriesToRender = [
          { key: 'events', label: 'Events', visible: visibleCategories.events },
          { key: 'resident', label: 'Residents', visible: visibleCategories.residents },
          { key: 'guest', label: 'Guests', visible: visibleCategories.guests }
        ];

        categoriesToRender.forEach(({ key, label, visible }) => {
          const cat = key === 'events' ? 'events' : key;
          
          // Always show category header
          html += '<div class="calendar-header"><div class="category-header">' + label + '</div>';
          for (let h = 10; h <= 20; h++) html += '<div class="category-spacer" style="grid-column:span 2;"></div>';
          html += '</div>';

          // Only show slots if visible
          if (visible) {
            for (let slot = 1; slot <= 10; slot++) {
              // Check if this slot has any events
              const slotHasEvents = events.some(e => 
                e.date === dateStr && e.slot === slot && e.category === cat
              );
              
              const rowClass = slotHasEvents ? '' : 'empty-row';
              
              html += `<div class="slot-row ${rowClass}"><div class="slot-label">Slot ${slot}</div>`;
              
              // Collect all events for this slot
              const slotEvents = events.filter(e => 
                e.date === dateStr && e.slot === slot && e.category === cat
              );
              
              // Create cells and track which are occupied
              const cells = [];
              for (let h = 10; h <= 20; h++) {
                [0, 0.5].forEach(offset => {
                  const currentTime = h + offset;
                  cells.push({
                    time: currentTime,
                    occupied: false,
                    event: null
                  });
                });
              }
              
              // Mark cells as occupied by events and create event blocks
              slotEvents.forEach(evt => {
                const startIndex = Math.max(0, Math.floor((evt.startHour - 10) * 2));
                const endIndex = Math.min(cells.length, Math.ceil((evt.endHour - 10) * 2));
                const span = endIndex - startIndex;
                
                if (span > 0 && startIndex < cells.length) {
                  cells[startIndex].event = evt;
                  cells[startIndex].span = span;
                  
                  // Mark all cells in the span as occupied
                  for (let i = startIndex; i < endIndex && i < cells.length; i++) {
                    cells[i].occupied = true;
                  }
                }
              });
              
              // Render cells
              cells.forEach((cell, index) => {
                if (cell.event) {
                  // This is the start of an event - create a spanning div
                  const isHalfHour = (index % 2) === 1;
                  const typeAttr = cell.event.type ? `data-type="${cell.event.type}"` : '';
                  
                  // Format start time
                  const startHour = Math.floor(cell.event.startHour);
                  const startMin = Math.round((cell.event.startHour % 1) * 60);
                  const timeStr = `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}`;
                  
                  // Type label mapping
                  const typeLabels = {
                    'consultation': 'Consultation',
                    'new_tattoo': 'New Tattoo',
                    'continuing_tattoo': 'Continuing',
                    'touch_up': 'Touch Up',
                    'selfbooking': 'Selfbooking',
                    'wannado': 'WannaDo',
                    'internal': 'Internal',
                    'move': 'Move',
                    'reserved': 'Reserved',
                    'no_show': 'No Show'
                  };
                  
                  const typeLabel = cell.event.type ? typeLabels[cell.event.type] || cell.event.type : '';
                  
                  // Build content based on category
                  let content = '';
                  if (cat === 'events') {
                    // For events: just time and title
                    content = `
                      <div style="font-weight:600; font-size:13px; margin-bottom:2px;">${timeStr}</div>
                      <div style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${cell.event.title}</div>
                    `;
                  } else {
                    // For bookings: time, customer, artist, type
                    content = `
                      <div style="font-weight:600; font-size:13px; margin-bottom:3px;">${timeStr}</div>
                      ${cell.event.customerName ? `<div style="font-size:12px; font-weight:500; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:2px;">${cell.event.customerName}</div>` : ''}
                      ${cell.event.artistName ? `<div style="font-size:11px; color:rgba(0,0,0,0.65); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:2px;">${cell.event.artistName}</div>` : ''}
                      ${typeLabel ? `<div style="font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; opacity:0.8;">${typeLabel}</div>` : ''}
                    `;
                  }
                  
                  // Add attendance required indicator for events
                  const attendanceIndicator = (cat === 'events' && cell.event.attendanceRequired) ? 
                    `<div style="position:absolute; top:8px; right:8px; width:8px; height:8px; background:#ff3b30; border-radius:50%; box-shadow:0 1px 3px rgba(255,59,48,0.4);"></div>` : '';
                  
                  html += `<div class="slot-cell ${isHalfHour ? 'half-hour' : ''}" style="grid-column: span ${cell.span}; position: relative;">
                    <div class="event ${cat}" ${typeAttr} data-event-id="${cell.event.id}" onclick="openEditEventModal('${cell.event.id}')" style="position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px; display:flex; flex-direction:column; justify-content:flex-start; align-items:flex-start; overflow:hidden;">
                      ${content}
                      ${attendanceIndicator}
                    </div>
                  </div>`;
                } else if (!cell.occupied) {
                  // This cell is not part of any event - render empty cell
                  const isHalfHour = (index % 2) === 1;
                  html += `<div class="slot-cell ${isHalfHour ? 'half-hour' : ''}"></div>`;
                }
                // If occupied but not the event start, we skip it (it's covered by the span)
              });
              
              html += '</div>';
            }
          }
        });

        html += '</div>';
        container.innerHTML = html;
        
        // Add current time indicator if today
        if (isToday) {
          addCurrentTimeIndicator();
          // Update every minute
          setInterval(updateCurrentTimeIndicator, 60000);
        }
      }
      
      function addCurrentTimeIndicator() {
        const now = new Date();
        const currentHour = now.getHours() + now.getMinutes() / 60;
        
        // Only show if current time is within calendar range (10-20)
        if (currentHour < 10 || currentHour > 20) return;
        
        updateCurrentTimeIndicator();
      }
      
      function updateCurrentTimeIndicator() {
        // Remove old indicator
        const oldIndicator = document.querySelector('.current-time-indicator');
        if (oldIndicator) oldIndicator.remove();
        
        const now = new Date();
        const currentHour = now.getHours() + now.getMinutes() / 60;
        
        // Only show if current time is within calendar range
        if (currentHour < 10 || currentHour > 20) return;
        
        const calendarGrid = document.querySelector('.calendar-grid');
        if (!calendarGrid) return;
        
        // Calculate position (10:00 = 0%, 20:00 = 100%)
        const startHour = 10;
        const endHour = 20;
        const totalHours = endHour - startHour;
        const hoursFromStart = currentHour - startHour;
        const percentage = (hoursFromStart / totalHours) * 100;
        
        // Calculate pixel position
        // Grid has 1 slot column (120px) + 22 time columns
        const slotColumnWidth = 120;
        const gridWidth = calendarGrid.offsetWidth;
        const timeColumnsWidth = gridWidth - slotColumnWidth;
        const pixelPosition = slotColumnWidth + (timeColumnsWidth * percentage / 100);
        
        const indicator = document.createElement('div');
        indicator.className = 'current-time-indicator';
        indicator.style.left = `${pixelPosition}px`;
        indicator.style.top = '0';
        indicator.style.bottom = '0';
        
        calendarGrid.appendChild(indicator);
      }

      document.getElementById('prevDayBtn').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() - 1);
        renderCalendar();
      });

      document.getElementById('nextDayBtn').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() + 1);
        renderCalendar();
      });

      document.getElementById('todayBtn').addEventListener('click', () => {
        currentDate = new Date();
        renderCalendar();
      });

      document.getElementById('datePickerInput').addEventListener('change', (e) => {
        currentDate = new Date(e.target.value);
        renderCalendar();
      });
      
      // Add Artist Button - Opens Add Artist Modal
      document.getElementById('addArtistBtn')?.addEventListener('click', async () => {
        // Populate location dropdown
        const { data: locations } = await supabase.from('locations').select('*').order('name', { ascending: true });
        const locSelect = document.getElementById('addArtistLocation');
        if (locSelect && locations) {
          locSelect.innerHTML = '<option value="">-- Select Location --</option>' + 
            locations.map(l => `<option value="${l.id}" ${l.id === selectedLocationId ? 'selected' : ''}>${l.name}</option>`).join('');
        }
        
        // Open modal
        document.getElementById('addArtistModal').classList.add('active');
      });
      
      // Cancel Add Artist
      document.getElementById('cancelAddArtist')?.addEventListener('click', () => {
        document.getElementById('addArtistModal').classList.remove('active');
        document.getElementById('addArtistForm').reset();
      });
      
      // Submit Add Artist Form
      document.getElementById('addArtistForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('addArtistName').value.trim();
        const instagram = document.getElementById('addArtistInstagram').value.trim();
        const type = document.getElementById('addArtistType').value;
        const locationId = document.getElementById('addArtistLocation').value;
        const active = document.getElementById('addArtistActive').checked;
        
        if (!name || !locationId) return alert('Please enter name and select location');
        
        try {
          const { error } = await supabase.from('artists').insert({
            name,
            instagram: instagram || null,
            is_guest: type === 'guest',
            active,
            location_id: locationId
          });
          
          if (error) throw error;
          
          document.getElementById('addArtistModal').classList.remove('active');
          document.getElementById('addArtistForm').reset();
          await loadInitialData();
          await loadArtists();      
      // Artist Sort Controls
      document.getElementById('artistSortBy')?.addEventListener('change', (e) => {
        artistSortConfig.field = e.target.value;
        loadArtists();
      });
      
      document.getElementById('artistSortOrder')?.addEventListener('click', function() {
        artistSortConfig.order = artistSortConfig.order === 'asc' ? 'desc' : 'asc';
        this.dataset.order = artistSortConfig.order;
        this.innerHTML = artistSortConfig.order === 'asc' ? '↑ Ascending' : '↓ Descending';
        loadArtists();
      });
          alert('Artist added successfully!');
        } catch(err) {
          alert('Error: ' + err.message);
        }
      });
      
      // Add Customer Button - Opens Add Customer Modal
      document.getElementById('addCustomerBtn')?.addEventListener('click', () => {
        document.getElementById('addCustomerModal').classList.add('active');
      });
      
      // Cancel Add Customer
      document.getElementById('cancelAddCustomer')?.addEventListener('click', () => {
        document.getElementById('addCustomerModal').classList.remove('active');
        document.getElementById('addCustomerForm').reset();
      });
      
      // Submit Add Customer Form
      document.getElementById('addCustomerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const firstName = document.getElementById('addCustomerFirstName').value.trim();
        const lastName = document.getElementById('addCustomerLastName').value.trim();
        const email = document.getElementById('addCustomerEmail').value.trim();
        const phone = document.getElementById('addCustomerPhone').value.trim();
        
        if (!firstName || !lastName || !email) {
          return alert('Please fill in first name, last name, and email');
        }
        
        try {
          const { error } = await supabase.from('customers').insert({
            first_name: firstName,
            last_name: lastName,
            email,
            phone: phone || null,
            rank: rank || null
          });
          
          if (error) throw error;
          
          document.getElementById('addCustomerModal').classList.remove('active');
          document.getElementById('addCustomerForm').reset();
          await loadCustomers();
          alert('Customer added successfully!');
        } catch(err) {
          alert('Error: ' + err.message);
        }
      });
      
      // Artist Search Filter
      document.getElementById('artistSearchInput')?.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const artistItems = document.querySelectorAll('.artist-item');
        
        artistItems.forEach(item => {
          const artistName = item.querySelector('.artist-name')?.textContent.toLowerCase() || '';
          const artistInstagram = item.querySelector('.artist-instagram')?.textContent.toLowerCase() || '';
          
          if (artistName.includes(searchTerm) || artistInstagram.includes(searchTerm)) {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
      });
      
      // Edit Artist Functions
      window.editArtist = async function(artistId) {
        const artist = allArtists.find(a => a.id === artistId);
        if (!artist) return;
        
        currentEditArtistId = artistId;
        
        document.getElementById('editArtistName').value = artist.name;
        document.getElementById('editArtistInstagram').value = artist.instagram || '';
        document.getElementById('editArtistType').value = artist.is_guest ? 'guest' : 'resident';
        document.getElementById('editArtistActive').checked = artist.active;
        
        document.getElementById('editArtistModal').classList.add('active');
      };
      
      document.getElementById('cancelEditArtist')?.addEventListener('click', () => {
        document.getElementById('editArtistModal').classList.remove('active');
        currentEditArtistId = null;
      });
      
      document.getElementById('editArtistForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('editArtistName').value.trim();
        const instagram = document.getElementById('editArtistInstagram').value.trim();
        const type = document.getElementById('editArtistType').value;
        const active = document.getElementById('editArtistActive').checked;
        
        if (!name) return alert('Name is required');
        
        try {
          const { error } = await supabase
            .from('artists')
            .update({
              name,
              instagram: instagram || null,
              is_guest: type === 'guest',
              active
            })
            .eq('id', currentEditArtistId);
          
          if (error) throw error;
          
          document.getElementById('editArtistModal').classList.remove('active');
          currentEditArtistId = null;
          
          await loadArtists();
          renderCalendar();
          alert('Artist updated successfully!');
        } catch (err) {
          alert('Error updating artist: ' + err.message);
        }
      });
      
      // Delete Artist Function
      window.deleteArtist = async function(artistId) {
        const artist = allArtists.find(a => a.id === artistId);
        if (!artist) return;
        
        if (!confirm(`Are you sure you want to delete "${artist.name}"? This action cannot be undone.`)) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('artists')
            .delete()
            .eq('id', artistId);
          
          if (error) throw error;
          
          await loadArtists();
          renderCalendar();
          alert('Artist deleted successfully!');
        } catch (err) {
          alert('Error deleting artist: ' + err.message);
        }
      };
      
      // Edit Customer Functions
      window.editCustomer = async function(customerId) {
        try {
          const { data, error } = await supabase
            .from('customers')
            .select('*')
            .eq('id', customerId)
            .single();
          
          if (error) throw error;
          if (!data) return;
          
          currentEditCustomerId = customerId;
          
          document.getElementById('editCustomerFirstName').value = data.first_name || '';
          document.getElementById('editCustomerLastName').value = data.last_name || '';
          document.getElementById('editCustomerEmail').value = data.email || '';
          document.getElementById('editCustomerPhone').value = data.phone || '';
          document.getElementById('editCustomerRank').value = data.rank || '';
          
          document.getElementById('editCustomerModal').classList.add('active');
        } catch (err) {
          alert('Error loading customer: ' + err.message);
        }
      };
      
      document.getElementById('cancelEditCustomer')?.addEventListener('click', () => {
        document.getElementById('editCustomerModal').classList.remove('active');
        currentEditCustomerId = null;
      });
      
      document.getElementById('editCustomerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const firstName = document.getElementById('editCustomerFirstName').value.trim();
        const lastName = document.getElementById('editCustomerLastName').value.trim();
        const email = document.getElementById('editCustomerEmail').value.trim();
        const phone = document.getElementById('editCustomerPhone').value.trim();
        
        if (!firstName || !lastName || !email) {
          return alert('First name, last name, and email are required');
        }
        
        try {
          const { error } = await supabase
            .from('customers')
            .update({
              first_name: firstName,
              last_name: lastName,
              email,
              phone: phone || null,
              rank: rank || null
            })
            .eq('id', currentEditCustomerId);
          
          if (error) throw error;
          
          document.getElementById('editCustomerModal').classList.remove('active');
          currentEditCustomerId = null;
          
          await loadCustomers();
          alert('Customer updated successfully!');
        } catch (err) {
          alert('Error updating customer: ' + err.message);
        }
      });
      
      // Delete Customer Function
      window.deleteCustomer = async function(customerId) {
        try {
          const { data, error } = await supabase
            .from('customers')
            .select('first_name, last_name')
            .eq('id', customerId)
            .single();
          
          if (error) throw error;
          if (!data) return;
          
          if (!confirm(`Are you sure you want to delete "${data.first_name} ${data.last_name}"? This action cannot be undone.`)) {
            return;
          }
          
          const { error: deleteError } = await supabase
            .from('customers')
            .delete()
            .eq('id', customerId);
          
          if (deleteError) throw deleteError;
          
          await loadCustomers();
          alert('Customer deleted successfully!');
        } catch (err) {
          alert('Error deleting customer: ' + err.message);
        }
      };
      
      // Close modals on backdrop click
      document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.addEventListener('click', (e) => {
          if (e.target === backdrop) {
            backdrop.classList.remove('active');
          }
        });
      });
      
      // Create Event Functions
      document.getElementById('createEventBtn')?.addEventListener('click', () => {
        // Set current date as default
        const dateInput = document.getElementById('createEventDate');
        if (dateInput) {
          dateInput.value = currentDate.toISOString().split('T')[0];
        }
        
        // Open modal
        document.getElementById('createEventModal').classList.add('active');
      });
      
      // "All Groups" checkbox handler
      document.getElementById('groupCheckboxAll')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const groupCheckboxes = document.querySelectorAll('.group-checkbox');
        groupCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });
      
      // Individual group checkbox handler - uncheck "All" if any individual is unchecked
      document.querySelectorAll('.group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const allCheckbox = document.getElementById('groupCheckboxAll');
          if (allCheckbox) {
            allCheckbox.checked = allChecked;
          }
        });
      });
      
      document.getElementById('cancelCreateEvent')?.addEventListener('click', () => {
        document.getElementById('createEventModal').classList.remove('active');
        document.getElementById('createEventForm').reset();
      });
      
      document.getElementById('createEventForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('createEventTitle').value.trim();
        const type = document.getElementById('createEventType').value.trim();
        const description = document.getElementById('createEventDescription').value.trim();
        const date = document.getElementById('createEventDate').value;
        const startHour = parseFloat(document.getElementById('createEventStartTime').value);
        const endHour = parseFloat(document.getElementById('createEventEndTime').value);
        const attendanceRequired = document.getElementById('createEventAttendanceRequired').checked;
        
        // Collect selected groups
        const selectedGroups = [];
        const groupCheckboxes = document.querySelectorAll('.group-checkbox:checked');
        groupCheckboxes.forEach(checkbox => {
          selectedGroups.push(checkbox.value);
        });
        
        // Validation
        if (!title || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Events category is always 'events'
        const category = 'events';
        
        // Find available slot
        const slot = findAvailableSlot(date, category, startHour, endHour);
        
        if (slot === null) {
          return alert('All slots are occupied for this time range. Please choose a different time or date.');
        }
        
        try {
          // Create event in Supabase
          const { data, error } = await supabase.from('events').insert({
            title,
            type,
            description: description || null,
            visible_groups: selectedGroups.length > 0 ? selectedGroups : null,
            attendance_required: attendanceRequired,
            slot: slot,
            artist_id: null,
            location_id: selectedLocationId,
            start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
            end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
          });
          
          if (error) throw error;
          
          // Add to local events array
          events.push({
            id: data?.[0]?.id || Date.now(),
            title,
            type,
            description,
            visible_groups: selectedGroups,
            attendance_required: attendanceRequired,
            date,
            slot,
            startHour,
            endHour,
            category,
            artist_id: null
          });
          
          // Close modal and reset form
          document.getElementById('createEventModal').classList.remove('active');
          document.getElementById('createEventForm').reset();
          
          // Uncheck all group checkboxes
          groupCheckboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) checkbox.checked = false;
          });
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event created successfully!');
        } catch (err) {
          console.error('Error creating event:', err);
          alert('Error creating event: ' + err.message);
        }
      });
      
      // Create Booking Button - Opens Create Booking Modal
      document.getElementById('createBookingBtn')?.addEventListener('click', () => {
        // Set current date as default
        const dateInput = document.getElementById('createBookingDate');
        if (dateInput) {
          dateInput.value = currentDate.toISOString().split('T')[0];
        }
        
        // Reset artist search
        document.getElementById('createBookingArtistSearch').value = '';
        document.getElementById('createBookingArtistSearch').disabled = true;
        document.getElementById('createBookingArtistId').value = '';
        document.getElementById('artistSearchResults').style.display = 'none';
        
        // Open modal
        document.getElementById('createBookingModal').classList.add('active');
      });
      
      // Artist Type change handler
      document.getElementById('createBookingArtistType')?.addEventListener('change', (e) => {
        const artistType = e.target.value;
        const searchInput = document.getElementById('createBookingArtistSearch');
        
        if (artistType) {
          searchInput.disabled = false;
          searchInput.value = '';
          document.getElementById('createBookingArtistId').value = '';
          document.getElementById('artistSearchResults').style.display = 'none';
        } else {
          searchInput.disabled = true;
          searchInput.value = '';
          document.getElementById('createBookingArtistId').value = '';
          document.getElementById('artistSearchResults').style.display = 'none';
        }
      });
      
      // Artist search functionality
      document.getElementById('createBookingArtistSearch')?.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        const artistType = document.getElementById('createBookingArtistType').value;
        const resultsDiv = document.getElementById('artistSearchResults');
        
        if (!searchTerm || !artistType) {
          resultsDiv.style.display = 'none';
          return;
        }
        
        // Filter artists by type and search term
        const isGuest = artistType === 'guest';
        const filteredArtists = allArtists.filter(artist => 
          artist.is_guest === isGuest && 
          artist.active &&
          artist.name.toLowerCase().includes(searchTerm)
        );
        
        if (filteredArtists.length === 0) {
          resultsDiv.innerHTML = '<div style="padding:12px; color:var(--muted); font-size:13px;">No artists found</div>';
          resultsDiv.style.display = 'block';
          return;
        }
        
        resultsDiv.innerHTML = filteredArtists.map(artist => `
          <div class="artist-search-result" data-id="${artist.id}" data-name="${artist.name}" style="padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.06); font-size:14px; transition:background 0.15s;">
            ${artist.name}${artist.instagram ? ` <span style="color:var(--muted); font-size:12px;">@${artist.instagram}</span>` : ''}
          </div>
        `).join('');
        
        resultsDiv.style.display = 'block';
        
        // Add click handlers
        document.querySelectorAll('.artist-search-result').forEach(item => {
          item.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(0,113,227,0.06)';
          });
          item.addEventListener('mouseleave', function() {
            this.style.background = '';
          });
          item.addEventListener('click', function() {
            const artistId = this.dataset.id;
            const artistName = this.dataset.name;
            document.getElementById('createBookingArtistSearch').value = artistName;
            document.getElementById('createBookingArtistId').value = artistId;
            resultsDiv.style.display = 'none';
          });
        });
      });
      
      
      // Create Booking Modal Handlers
      document.getElementById('cancelCreateBooking')?.addEventListener('click', () => {
        document.getElementById('createBookingModal').classList.remove('active');
        document.getElementById('createBookingForm').reset();
      });
      
      document.getElementById('createBookingForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const customerName = document.getElementById('createBookingCustomer').value.trim();
        const type = document.getElementById('createBookingType').value;
        const artistId = document.getElementById('createBookingArtistId').value;
        const date = document.getElementById('createBookingDate').value;
        const startHour = parseFloat(document.getElementById('createBookingStartTime').value);
        const endHour = parseFloat(document.getElementById('createBookingEndTime').value);
        
        // Validation
        if (!customerName || !type || !artistId || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Determine category based on artist
        const artist = allArtists.find(a => a.id === artistId);
        const category = artist?.is_guest ? 'guest' : 'resident';
        
        // Find available slot
        const slot = findAvailableSlot(date, category, startHour, endHour);
        
        if (slot === null) {
          return alert('All slots are occupied for this time range. Please choose a different time or date.');
        }
        
        try {
          // Create booking in Supabase events table
          const { data, error } = await supabase.from('events').insert({
            title: customerName,
            type,
            slot: slot,
            artist_id: artistId,
            location_id: selectedLocationId,
            start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
            end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
          });
          
          if (error) throw error;
          
          // Add to local events array
          events.push({
            id: data?.[0]?.id || Date.now(),
            title: customerName,
            type,
            date,
            slot,
            startHour,
            endHour,
            category,
            artist_id: artistId
          });
          
          // Close modal and reset form
          document.getElementById('createBookingModal').classList.remove('active');
          document.getElementById('createBookingForm').reset();
          document.getElementById('createBookingArtistSearch').disabled = true;
          document.getElementById('createBookingArtistId').value = '';
          document.getElementById('artistSearchResults').style.display = 'none';
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Booking created successfully!');
        } catch (err) {
          console.error('Error creating booking:', err);
          alert('Error creating booking: ' + err.message);
        }
      });
      
      // Customer Search
      document.getElementById('customerSearchInput')?.addEventListener('input', (e) => {
        const searchTerm = e.target.value.trim();
        loadCustomers(searchTerm);
      });
      
      // Customer Search
      document.getElementById('customerSearchInput')?.addEventListener('input', (e) => {
        const searchTerm = e.target.value.trim();
        loadCustomers(searchTerm);
      });
      
      // Edit Event Modal Functions
      window.openEditEventModal = async function(eventId) {
        const event = events.find(e => e.id === eventId);
        if (!event) return;
        
        currentEditingEvent = event;
        
        // Load full event data from Supabase
        const { data, error } = await supabase
          .from('events')
          .select('*')
          .eq('id', eventId)
          .single();
        
        if (error) {
          console.error('Error loading event:', error);
          alert('Error loading event details');
          return;
        }
        
        // Fill form with event data
        document.getElementById('editEventTitle').value = data.title || '';
        document.getElementById('editEventType').value = data.type || '';
        document.getElementById('editEventDescription').value = data.description || '';
        document.getElementById('editEventDate').value = event.date;
        document.getElementById('editEventStartTime').value = event.startHour;
        document.getElementById('editEventEndTime').value = event.endHour;
        
        // Handle artist display (for bookings)
        if (data.artist_id) {
          const artist = allArtists.find(a => a.id === data.artist_id);
          document.getElementById('editEventArtistName').value = artist?.name || 'Unknown Artist';
          document.getElementById('editEventArtistGroup').style.display = 'block';
          document.getElementById('editEventGroupsContainer').style.display = 'none';
          document.getElementById('editEventAttendanceGroup').style.display = 'none';
          document.getElementById('editEventModalTitle').textContent = 'Booking Details';
        } else {
          document.getElementById('editEventArtistGroup').style.display = 'none';
          document.getElementById('editEventGroupsContainer').style.display = 'block';
          document.getElementById('editEventAttendanceGroup').style.display = 'block';
          document.getElementById('editEventModalTitle').textContent = 'Event Details';
          
          // Set visible groups checkboxes
          const visibleGroups = data.visible_groups || [];
          document.querySelectorAll('.edit-group-checkbox').forEach(checkbox => {
            checkbox.checked = visibleGroups.includes(checkbox.value);
          });
          
          // Set "All Groups" checkbox
          const allChecked = document.querySelectorAll('.edit-group-checkbox').length === visibleGroups.length;
          document.getElementById('editGroupCheckboxAll').checked = allChecked;
          
          // Set attendance required
          document.getElementById('editEventAttendanceRequired').checked = data.attendance_required || false;
        }
        
        // Open modal
        document.getElementById('editEventModal').classList.add('active');
      };
      
      // "All Groups" checkbox handler for edit modal
      document.getElementById('editGroupCheckboxAll')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox');
        groupCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });
      
      // Individual group checkbox handler for edit modal
      document.querySelectorAll('.edit-group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.edit-group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const allCheckbox = document.getElementById('editGroupCheckboxAll');
          if (allCheckbox) {
            allCheckbox.checked = allChecked;
          }
        });
      });
      
      // Cancel edit event
      document.getElementById('cancelEditEvent')?.addEventListener('click', () => {
        document.getElementById('editEventModal').classList.remove('active');
        currentEditingEvent = null;
      });
      
      // Delete event
      document.getElementById('deleteEventBtn')?.addEventListener('click', async () => {
        if (!currentEditingEvent) return;
        
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .delete()
            .eq('id', currentEditingEvent.id);
          
          if (error) throw error;
          
          // Remove from local array
          events = events.filter(e => e.id !== currentEditingEvent.id);
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          currentEditingEvent = null;
          
          // Refresh calendar
          renderCalendar();
          
          alert('Event deleted successfully!');
        } catch (err) {
          console.error('Error deleting event:', err);
          alert('Error deleting event: ' + err.message);
        }
      });
      
      // Save edited event
      document.getElementById('editEventForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentEditingEvent) return;
        
        const title = document.getElementById('editEventTitle').value.trim();
        const type = document.getElementById('editEventType').value.trim();
        const description = document.getElementById('editEventDescription').value.trim();
        const date = document.getElementById('editEventDate').value;
        const startHour = parseFloat(document.getElementById('editEventStartTime').value);
        const endHour = parseFloat(document.getElementById('editEventEndTime').value);
        
        // Validation
        if (!title || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Prepare update data
        const updateData = {
          title,
          type,
          description: description || null,
          start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
          end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
        };
        
        // Add event-specific fields (not for bookings)
        if (currentEditingEvent.category === 'events') {
          const selectedGroups = [];
          const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox:checked');
          groupCheckboxes.forEach(checkbox => {
            selectedGroups.push(checkbox.value);
          });
          
          updateData.visible_groups = selectedGroups.length > 0 ? selectedGroups : null;
          updateData.attendance_required = document.getElementById('editEventAttendanceRequired').checked;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .update(updateData)
            .eq('id', currentEditingEvent.id);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          currentEditingEvent = null;
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event updated successfully!');
        } catch (err) {
          console.error('Error updating event:', err);
          alert('Error updating event: ' + err.message);
        }
      });
      
      // Edit Event Modal Functions
      window.openEditEventModal = async function(eventId) {
        const event = events.find(e => e.id === eventId);
        if (!event) {
          console.error('Event not found:', eventId);
          return;
        }
        
        // Load full event data from Supabase to get all fields
        const { data: fullEvent, error } = await supabase
          .from('events')
          .select('*')
          .eq('id', eventId)
          .single();
        
        if (error) {
          console.error('Error loading event:', error);
          alert('Error loading event details');
          return;
        }
        
        // Check if this is a booking (has artist_id) or an event
        if (fullEvent.artist_id) {
          // This is a booking - open booking modal
          openEditBookingModal(eventId, fullEvent, event);
        } else {
          // This is an event - open event modal
          openEditEventModalInternal(eventId, fullEvent, event);
        }
      };
      
      // Internal function to open event modal
      function openEditEventModalInternal(eventId, fullEvent, event) {
        // Populate form fields
        document.getElementById('editEventId').value = eventId;
        document.getElementById('editEventTitle').value = fullEvent.title || '';
        document.getElementById('editEventType').value = fullEvent.type || '';
        document.getElementById('editEventDescription').value = fullEvent.description || '';
        document.getElementById('editEventDate').value = event.date;
        document.getElementById('editEventStartTime').value = event.startHour.toString();
        document.getElementById('editEventEndTime').value = event.endHour.toString();
        document.getElementById('editEventAttendanceRequired').checked = fullEvent.attendance_required || false;
        
        // Clear all group checkboxes first
        document.querySelectorAll('.edit-group-checkbox').forEach(cb => cb.checked = false);
        
        // Set selected groups
        if (fullEvent.visible_groups && Array.isArray(fullEvent.visible_groups)) {
          fullEvent.visible_groups.forEach(group => {
            const checkbox = document.querySelector(`.edit-group-checkbox[value="${group}"]`);
            if (checkbox) checkbox.checked = true;
          });
          
          // Check if all groups are selected
          const allCheckboxes = document.querySelectorAll('.edit-group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          document.getElementById('editGroupCheckboxAll').checked = allChecked;
        }
        
        // Open modal
        document.getElementById('editEventModal').classList.add('active');
      }
      
      // Function to open booking modal
      function openEditBookingModal(bookingId, fullBooking, booking) {
        // Find artist
        const artist = allArtists.find(a => a.id === fullBooking.artist_id);
        
        // Populate form fields
        document.getElementById('editBookingId').value = bookingId;
        document.getElementById('editBookingCustomer').value = fullBooking.title || '';
        document.getElementById('editBookingType').value = fullBooking.type || '';
        document.getElementById('editBookingArtistName').value = artist?.name || 'Unknown Artist';
        document.getElementById('editBookingArtistId').value = fullBooking.artist_id;
        document.getElementById('editBookingDate').value = booking.date;
        document.getElementById('editBookingStartTime').value = booking.startHour.toString();
        document.getElementById('editBookingEndTime').value = booking.endHour.toString();
        
        // Open modal
        document.getElementById('editBookingModal').classList.add('active');
      }
      
      // Edit "All Groups" checkbox handler
      document.getElementById('editGroupCheckboxAll')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox');
        groupCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });
      
      // Individual edit group checkbox handler
      document.querySelectorAll('.edit-group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const allCheckboxes = document.querySelectorAll('.edit-group-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const allCheckbox = document.getElementById('editGroupCheckboxAll');
          if (allCheckbox) {
            allCheckbox.checked = allChecked;
          }
        });
      });
      
      // Cancel edit event
      document.getElementById('cancelEditEvent')?.addEventListener('click', () => {
        document.getElementById('editEventModal').classList.remove('active');
      });
      
      // Submit edit event form
      document.getElementById('editEventForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const eventId = document.getElementById('editEventId').value;
        const title = document.getElementById('editEventTitle').value.trim();
        const type = document.getElementById('editEventType').value.trim();
        const description = document.getElementById('editEventDescription').value.trim();
        const date = document.getElementById('editEventDate').value;
        const startHour = parseFloat(document.getElementById('editEventStartTime').value);
        const endHour = parseFloat(document.getElementById('editEventEndTime').value);
        const attendanceRequired = document.getElementById('editEventAttendanceRequired').checked;
        
        // Collect selected groups
        const selectedGroups = [];
        const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox:checked');
        groupCheckboxes.forEach(checkbox => {
          selectedGroups.push(checkbox.value);
        });
        
        // Validation
        if (!title || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Get current event to check if date/time changed
        const currentEvent = events.find(e => e.id === eventId);
        let newSlot = currentEvent?.slot || 1;
        
        // If date or time changed, find a new available slot
        if (currentEvent && (currentEvent.date !== date || currentEvent.startHour !== startHour || currentEvent.endHour !== endHour)) {
          // Temporarily remove current event from events array for slot calculation
          const tempEvents = events.filter(e => e.id !== eventId);
          const oldEvents = events;
          events = tempEvents;
          
          const availableSlot = findAvailableSlot(date, 'events', startHour, endHour);
          
          // Restore events array
          events = oldEvents;
          
          if (availableSlot === null) {
            return alert('All slots are occupied for this new time range. Please choose a different time or date.');
          }
          newSlot = availableSlot;
        }
        
        try {
          // Update event in Supabase
          const { error } = await supabase
            .from('events')
            .update({
              title,
              type,
              description: description || null,
              visible_groups: selectedGroups.length > 0 ? selectedGroups : null,
              attendance_required: attendanceRequired,
              slot: newSlot,
              start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
              end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
            })
            .eq('id', eventId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event updated successfully!');
        } catch (err) {
          console.error('Error updating event:', err);
          alert('Error updating event: ' + err.message);
        }
      });
      
      // Delete event
      document.getElementById('deleteEventBtn')?.addEventListener('click', async () => {
        const eventId = document.getElementById('editEventId').value;
        
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .delete()
            .eq('id', eventId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editEventModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Event deleted successfully!');
        } catch (err) {
          console.error('Error deleting event:', err);
          alert('Error deleting event: ' + err.message);
        }
      });
      
      // Edit Booking Modal Functions
      document.getElementById('cancelEditBooking')?.addEventListener('click', () => {
        document.getElementById('editBookingModal').classList.remove('active');
      });
      
      // Submit edit booking form
      document.getElementById('editBookingForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const bookingId = document.getElementById('editBookingId').value;
        const customerName = document.getElementById('editBookingCustomer').value.trim();
        const type = document.getElementById('editBookingType').value;
        const artistId = document.getElementById('editBookingArtistId').value;
        const date = document.getElementById('editBookingDate').value;
        const startHour = parseFloat(document.getElementById('editBookingStartTime').value);
        const endHour = parseFloat(document.getElementById('editBookingEndTime').value);
        
        // Validation
        if (!customerName || !type || !date || !startHour || !endHour) {
          return alert('Please fill in all required fields');
        }
        
        if (endHour <= startHour) {
          return alert('End time must be after start time');
        }
        
        // Get current booking to check if date/time changed
        const currentBooking = events.find(e => e.id === bookingId);
        let newSlot = currentBooking?.slot || 1;
        
        // If date or time changed, find a new available slot
        if (currentBooking && (currentBooking.date !== date || currentBooking.startHour !== startHour || currentBooking.endHour !== endHour)) {
          // Determine category
          const artist = allArtists.find(a => a.id === artistId);
          const category = artist?.is_guest ? 'guest' : 'resident';
          
          // Temporarily remove current booking from events array for slot calculation
          const tempEvents = events.filter(e => e.id !== bookingId);
          const oldEvents = events;
          events = tempEvents;
          
          const availableSlot = findAvailableSlot(date, category, startHour, endHour);
          
          // Restore events array
          events = oldEvents;
          
          if (availableSlot === null) {
            return alert('All slots are occupied for this new time range. Please choose a different time or date.');
          }
          newSlot = availableSlot;
        }
        
        try {
          // Update booking in Supabase
          const { error } = await supabase
            .from('events')
            .update({
              title: customerName,
              type,
              slot: newSlot,
              start_time: `${date}T${String(Math.floor(startHour)).padStart(2, '0')}:${String((startHour % 1) * 60).padStart(2, '0')}:00`,
              end_time: `${date}T${String(Math.floor(endHour)).padStart(2, '0')}:${String((endHour % 1) * 60).padStart(2, '0')}:00`
            })
            .eq('id', bookingId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editBookingModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Booking updated successfully!');
        } catch (err) {
          console.error('Error updating booking:', err);
          alert('Error updating booking: ' + err.message);
        }
      });
      
      // Delete booking
      document.getElementById('deleteBookingBtn')?.addEventListener('click', async () => {
        const bookingId = document.getElementById('editBookingId').value;
        
        if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
          return;
        }
        
        try {
          const { error } = await supabase
            .from('events')
            .delete()
            .eq('id', bookingId);
          
          if (error) throw error;
          
          // Close modal
          document.getElementById('editBookingModal').classList.remove('active');
          
          // Reload events and refresh calendar
          await loadEvents();
          renderCalendar();
          
          alert('Booking deleted successfully!');
        } catch (err) {
          console.error('Error deleting booking:', err);
          alert('Error deleting booking: ' + err.message);
        }
      });
      
      // Category checkboxes
      document.getElementById('checkEvents').addEventListener('change', (e) => {
        visibleCategories.events = e.target.checked;
        renderCalendar();
      });
      
      document.getElementById('checkResidents').addEventListener('change', (e) => {
        visibleCategories.residents = e.target.checked;
        renderCalendar();
      });
      
      document.getElementById('checkGuests').addEventListener('change', (e) => {
        visibleCategories.guests = e.target.checked;
        renderCalendar();
      });
      
      document.getElementById('prevMonthBtn')?.addEventListener('click', () => {
        dienstplanDate.setMonth(dienstplanDate.getMonth() - 1);
        renderDienstplan();
      });
      
      document.getElementById('nextMonthBtn')?.addEventListener('click', () => {
        dienstplanDate.setMonth(dienstplanDate.getMonth() + 1);
        renderDienstplan();
      });
      
      document.getElementById('currentMonthBtn')?.addEventListener('click', () => {
        dienstplanDate = new Date();
        renderDienstplan();
      });
    });

    function renderDienstplan() {
      const monthDisplay = document.getElementById('dienstplanMonth');
      const container = document.getElementById('dienstplanContainer');
      if (!monthDisplay || !container) return;
      
      const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 
                          'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
      const month = monthNames[dienstplanDate.getMonth()];
      const year = dienstplanDate.getFullYear();
      monthDisplay.textContent = `${month} ${year}`;
      
      // Get location colors
      const locationData = document.querySelector('#dienstplanLocationDropdown option:checked')?.textContent || '';
      const colors = getLocationColors(locationData);
      
      const daysInMonth = new Date(dienstplanDate.getFullYear(), dienstplanDate.getMonth() + 1, 0).getDate();
      
      // Group team members by category
      const categories = [];
      const categoryNames = ['Geschäftsführung', 'Management', 'Booking Team', 'Mediadepartment', 'Resident Artists', 'Guest Artists', 'Azubis', 'Andere'];
      
      categoryNames.forEach(categoryName => {
        const members = allTeamMembers.filter(m => m.category === categoryName && m.active);
        if (members.length > 0 || categoryName === 'Resident Artists' || categoryName === 'Guest Artists') {
          // For Artist categories, use artists instead
          if (categoryName === 'Resident Artists') {
            const residentArtists = allArtists.filter(a => !a.is_guest && a.active);
            if (residentArtists.length > 0) {
              categories.push({
                name: categoryName,
                people: residentArtists.map(a => a.name)
              });
            }
          } else if (categoryName === 'Guest Artists') {
            const guestArtists = allArtists.filter(a => a.is_guest && a.active);
            if (guestArtists.length > 0) {
              categories.push({
                name: categoryName,
                people: guestArtists.map(a => a.name)
              });
            }
          } else {
            categories.push({
              name: categoryName,
              people: members.map(m => m.name)
            });
          }
        }
      });
      
      let html = '<table style="width:auto; min-width:100%; border-collapse:collapse; background:white; table-layout:fixed;">';
      
      // Header row with days
      html += '<thead><tr>';
      html += '<th style="position:sticky; left:0; z-index:20; background:rgba(249,249,249,0.98); padding:12px; text-align:left; border-right:1px solid rgba(0,0,0,0.06); border-bottom:1px solid rgba(0,0,0,0.06); font-size:13px; color:#666; width:150px; min-width:150px; max-width:150px;">Resources</th>';
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(dienstplanDate.getFullYear(), dienstplanDate.getMonth(), day);
        const weekday = date.toLocaleDateString('de-DE', { weekday: 'short' }).toUpperCase();
        
        // Check if this is today
        const today = new Date();
        const isToday = date.getDate() === today.getDate() && 
                        date.getMonth() === today.getMonth() && 
                        date.getFullYear() === today.getFullYear();
        
        const todayStyle = isToday ? 'background:#ff3b30; color:white;' : `background:${colors.light};`;
        
        html += `<th style="${todayStyle} padding:8px 4px; text-align:center; border-right:1px solid rgba(0,0,0,0.06); border-bottom:1px solid rgba(0,0,0,0.06); font-size:11px; width:80px; min-width:80px; max-width:80px;">
                   <div style="font-size:13px; font-weight:600; ${isToday ? 'color:white;' : 'color:#1d1d1f;'}">${day}</div>
                   <div style="font-size:10px; font-weight:500; ${isToday ? 'color:rgba(255,255,255,0.9);' : 'color:#666;'} margin-top:2px;">${weekday}</div>
                 </th>`;
      }
      html += '</tr></thead>';
      
      html += '<tbody>';
      
      categories.forEach((cat, catIndex) => {
        // Category header row
        html += `<tr class="category-row">
                   <td colspan="${daysInMonth + 1}" style="padding:0; border-bottom:1px solid rgba(0,0,0,0.06);">
                     <button class="category-header-btn" data-category="${catIndex}" style="width:100%; display:flex; align-items:center; justify-content:flex-start; background:#f5f5f5; color:#1d1d1f; border:none; padding:12px 16px; font-size:14px; font-weight:600; cursor:pointer; text-align:left; font-family:inherit;">
                       <span class="arrow" style="margin-right:8px; font-size:12px; display:inline-block; width:16px; transition:transform 0.3s ease;">▶</span>
                       <span>${cat.name}</span>
                     </button>
                   </td>
                 </tr>`;
        
        // People rows (hidden by default)
        cat.people.forEach((person, personIndex) => {
          html += `<tr class="person-row" data-category="${catIndex}" style="display:none;">
                     <td style="position:sticky; left:0; z-index:10; background:rgba(255,255,255,0.98); padding:10px 12px 10px 32px; text-align:left; border-right:1px solid rgba(0,0,0,0.06); border-bottom:1px solid rgba(0,0,0,0.06); font-size:13px; color:#1d1d1f; width:150px; min-width:150px; max-width:150px;">${person}</td>`;
          
          for (let day = 1; day <= daysInMonth; day++) {
            html += `<td style="border-right:1px solid rgba(0,0,0,0.06); border-bottom:1px solid rgba(0,0,0,0.06); background:rgba(255,255,255,0.8); cursor:pointer; padding:0; width:80px; min-width:80px; max-width:80px;">
                       <div class="dp-cell" data-cat="${catIndex}" data-person="${personIndex}" data-day="${day}" style="width:100%; height:100%; min-height:40px;"></div>
                     </td>`;
          }
          
          html += '</tr>';
        });
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
      
      // Add event listeners
      document.querySelectorAll('.category-header-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const catIndex = this.dataset.category;
          const arrow = this.querySelector('.arrow');
          const personRows = document.querySelectorAll(`.person-row[data-category="${catIndex}"]`);
          const isOpen = openCategories.has(catIndex);
          
          if (isOpen) {
            personRows.forEach(row => row.style.display = 'none');
            arrow.style.transform = 'rotate(0deg)';
            openCategories.delete(catIndex);
          } else {
            personRows.forEach(row => row.style.display = 'table-row');
            arrow.style.transform = 'rotate(90deg)';
            openCategories.add(catIndex);
          }
        });
      });
      
      // Restore previously open categories
      openCategories.forEach(catIndex => {
        const btn = document.querySelector(`.category-header-btn[data-category="${catIndex}"]`);
        const arrow = btn?.querySelector('.arrow');
        const personRows = document.querySelectorAll(`.person-row[data-category="${catIndex}"]`);
        
        if (btn && arrow) {
          personRows.forEach(row => row.style.display = 'table-row');
          arrow.style.transform = 'rotate(90deg)';
        }
      });
      
      // Cell click handlers with location colors
      document.querySelectorAll('.dp-cell').forEach(cell => {
        cell.addEventListener('click', function() {
          if (!this.classList.contains('working') && !this.classList.contains('off') && !this.classList.contains('vacation')) {
            this.classList.add('working');
            this.style.background = colors.accent;
          } else if (this.classList.contains('working')) {
            this.classList.remove('working');
            this.classList.add('off');
            this.style.background = '#FFEBEE';
          } else if (this.classList.contains('off')) {
            this.classList.remove('off');
            this.classList.add('vacation');
            this.style.background = '#FFF3E0';
          } else {
            this.classList.remove('vacation');
            this.style.background = '';
          }
        });
      });
    }
  </script>
</body>
</html>
