<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">

  <!-- ============================================ -->
  <!-- PWA META-TAGS - iPhone + iPad Kompatibel    -->
  <!-- ============================================ -->

  <!-- Basis PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- iPad-spezifische Erg√§nzungen -->
  <meta name="apple-touch-fullscreen" content="yes">
  <meta name="HandheldFriendly" content="true">
  <meta name="MobileOptimized" content="width">

  <!-- Status Bar Styling -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MIS Agreement">

  <!-- Theme -->
  <meta name="theme-color" content="#000000">
  <meta name="msapplication-navbutton-color" content="#000000">
  <meta name="msapplication-TileColor" content="#000000">

  <!-- Viewport - iPad-optimiert -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">

  <!-- Verhindert automatische Erkennung -->
  <meta name="format-detection" content="telephone=no">
  <meta name="format-detection" content="date=no">
  <meta name="format-detection" content="address=no">
  <meta name="format-detection" content="email=no">

  <!-- App Icons f√ºr Homescreen -->
  <link rel="apple-touch-icon" href="icons/agreement-icon-180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/agreement-icon-152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/agreement-icon-167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/agreement-icon-180.png">

  <!-- Splash Screens f√ºr iPad -->
  <!-- iPad Pro 12.9" -->
  <link rel="apple-touch-startup-image"
        href="splash/splash-2048x2732.png"
        media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">
  <!-- iPad Pro 11" -->
  <link rel="apple-touch-startup-image"
        href="splash/splash-1668x2388.png"
        media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)">
  <!-- iPad Pro 10.5" -->
  <link rel="apple-touch-startup-image"
        href="splash/splash-1668x2224.png"
        media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)">
  <!-- iPad Mini, Air -->
  <link rel="apple-touch-startup-image"
        href="splash/splash-1536x2048.png"
        media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)">

  <!-- Web App Manifest -->
  <link rel="manifest" href="manifest-agreement.json">

  <title>MOMMY I'M SORRY - Agreement</title>

  <!-- Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    /* ============================================ */
    /* KIOSK MODE / PWA STYLES                     */
    /* ============================================ */

    /* Verhindert Pull-to-Refresh und Overscroll */
    html, body {
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      position: fixed;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* Verhindert Text-Selektion (Kiosk-Sicherheit) */
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    /* Inputs und Textareas erlauben Selektion */
    input,
    textarea,
    [contenteditable="true"] {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    /* Verhindert Zoom bei Input-Focus auf iOS */
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    textarea,
    select {
      font-size: 16px !important;
    }

    /* Extra padding wenn als PWA (f√ºr Status Bar) */
    .pwa-standalone .app-container {
      padding-top: calc(20px + env(safe-area-inset-top));
    }

    /* ============================================ */
    /* END KIOSK MODE                              */
    /* ============================================ */

    /* ============================================ */
    /* IPAD-SPEZIFISCHE PWA STYLES                 */
    /* ============================================ */

    /* iPad Safe Areas (f√ºr Home Indicator) */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .app-container {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
    }

    /* iPad Landscape (falls rotiert) */
    @media screen and (min-width: 768px) and (orientation: landscape) {
      .device-ipad .form-container {
        max-width: 600px;
        margin: 0 auto;
      }
    }

    /* iPad Viewport Height Fix (100vh Bug) */
    .device-ipad.pwa-standalone {
      height: 100%;
      height: -webkit-fill-available;
    }

    /* Verstecke "Add to Homescreen" Hinweis wenn bereits Standalone */
    .pwa-standalone .install-hint,
    .pwa-standalone .browser-warning {
      display: none !important;
    }

    /* iPad Touch Optimierungen */
    .device-ipad button,
    .device-ipad .btn,
    .device-ipad input,
    .device-ipad select,
    .device-ipad textarea {
      /* Gr√∂√üere Touch-Targets f√ºr iPad */
      min-height: 50px;
      font-size: 17px; /* Verhindert Zoom bei Focus */
    }

    /* iPad Signature Canvas gr√∂√üer */
    .device-ipad .signature-canvas {
      height: 250px;
    }

    /* Verhindere Rubber-Band Effekt auf iPad */
    .device-ipad.pwa-standalone {
      position: fixed;
      overflow: hidden;
      width: 100%;
      height: 100%;
    }

    .device-ipad.pwa-standalone .scroll-content {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
      height: 100%;
    }

    /* ============================================ */
    /* INSTALL HINT POPUP STYLES                   */
    /* ============================================ */

    .install-hint {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      z-index: 10000;
      animation: slideUp 0.4s ease;
    }

    .install-hint-content {
      background: #1a1a1a;
      color: #fff;
      padding: 16px 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: relative;
      border: 1px solid #333;
    }

    .install-hint-close {
      position: absolute;
      top: 8px;
      right: 12px;
      background: none;
      border: none;
      color: #999;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      min-height: auto !important;
    }

    .install-hint-icon {
      flex-shrink: 0;
      width: 44px;
      height: 44px;
      background: #333;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .install-hint-text {
      font-size: 14px;
      line-height: 1.4;
    }

    .install-hint .share-icon {
      display: inline-block;
      background: #007AFF;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Verstecke im Standalone Modus */
    .pwa-standalone .install-hint {
      display: none !important;
    }

    /* App Wrapper f√ºr Scroll-Fix */
    .app-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
    }

    .scroll-content {
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }

    /* ============================================ */
    /* END IPAD STYLES                             */
    /* ============================================ */

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      /* Dark Mode Editorial Palette */
      --bg-primary: #0a0a0a;
      --bg-secondary: #141414;
      --bg-elevated: #1a1a1a;
      --bg-card: #1f1f1f;

      --text-primary: #f5f5f5;
      --text-secondary: #a0a0a0;
      --text-muted: #666666;

      --border-subtle: #2a2a2a;
      --border-default: #333333;
      --border-strong: #444444;

      --accent: #b8b8b8;
      --accent-soft: rgba(184, 184, 184, 0.15);
      --success: #4ade80;
      --error: #f87171;

      /* Typography */
      --font-display: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      --font-body: 'DM Sans', -apple-system, sans-serif;

      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --space-2xl: 48px;
      --space-3xl: 64px;

      /* Transitions */
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-in-out: cubic-bezier(0.65, 0, 0.35, 1);
    }

    body {
      font-family: var(--font-body);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      line-height: 1.6;
    }

    /* Subtle noise texture overlay */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.02;
      pointer-events: none;
      z-index: 0;
    }

    /* Container */
    .app-container {
      max-width: 720px;
      margin: 0 auto;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      padding: var(--space-2xl) var(--space-xl);
      position: relative;
      z-index: 1;
    }

    /* Logo - Hidden */
    .logo-container {
      display: none;
    }

    .logo svg {
      width: 48px;
      height: 48px;
      margin-bottom: var(--space-md);
      opacity: 0.9;
    }

    .logo svg line {
      stroke: var(--text-primary);
    }

    .logo-text {
      font-family: var(--font-display);
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    /* Language Toggle */
    .language-toggle {
      position: absolute;
      top: var(--space-xl);
      right: var(--space-xl);
      display: flex;
      gap: var(--space-sm);
    }

    .lang-btn {
      width: 32px;
      height: 24px;
      border: none;
      border-radius: 0;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s var(--ease-out);
      overflow: hidden;
      opacity: 0.5;
    }

    .lang-btn:hover {
      opacity: 0.8;
    }

    .lang-btn.active {
      opacity: 1;
    }

    .lang-btn .flag-icon {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lang-btn .flag-icon svg {
      width: 24px;
      height: 18px;
      border-radius: 2px;
    }

    /* Screens */
    .screen {
      display: none;
      flex: 1;
      flex-direction: column;
      animation: screenEnter 0.5s var(--ease-out);
    }

    .screen.active {
      display: flex;
    }

    @keyframes screenEnter {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(-20px); }
    }

    /* Start Screen */
    .start-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .start-question {
      font-family: var(--font-display);
      font-size: 36px;
      font-weight: 300;
      margin-bottom: var(--space-3xl);
      line-height: 1.35;
      color: var(--text-primary);
      max-width: 500px;
    }

    .choice-buttons {
      display: flex;
      gap: var(--space-lg);
    }

    .choice-btn {
      width: 220px;
      padding: var(--space-xl) var(--space-lg);
      border: none;
      border-radius: 16px;
      background: transparent;
      cursor: pointer;
      transition: all 0.4s var(--ease-out);
      position: relative;
      overflow: hidden;
    }

    .choice-btn::before {
      display: none;
    }

    .choice-btn:hover {
      transform: translateY(-6px);
    }

    .choice-btn:hover .choice-btn-icon {
      border-color: var(--accent);
    }

    .choice-btn:active {
      transform: translateY(-2px);
    }

    .choice-btn-icon {
      width: 56px;
      height: 56px;
      margin: 0 auto var(--space-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-default);
      border-radius: 14px;
      position: relative;
      z-index: 1;
      transition: border-color 0.3s var(--ease-out);
    }

    .choice-btn-icon svg {
      width: 28px;
      height: 28px;
      stroke: var(--accent);
      stroke-width: 1.5;
      fill: none;
    }

    .choice-btn-title {
      font-family: var(--font-display);
      font-size: 22px;
      font-weight: 500;
      margin-bottom: var(--space-sm);
      color: var(--text-primary);
      position: relative;
      z-index: 1;
    }

    .choice-btn-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      z-index: 1;
    }

    /* Search Screen - REMOVED FOR GDPR COMPLIANCE */

    /* Form Screen */
    .form-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Progress Bar */
    .progress-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-2xl);
      padding: var(--space-md) 0;
    }

    .progress-step {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border-subtle);
      transition: all 0.4s var(--ease-out);
      position: relative;
    }

    .progress-step.active {
      background: var(--accent);
      transform: scale(1.4);
      box-shadow: 0 0 12px var(--accent-soft);
    }

    .progress-step.completed {
      background: var(--accent);
    }

    .progress-line {
      width: 36px;
      height: 1px;
      background: var(--border-subtle);
      transition: all 0.4s var(--ease-out);
    }

    .progress-line.completed {
      background: var(--accent);
    }

    .progress-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-left: var(--space-md);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Form Steps */
    .form-step {
      display: none;
      flex: 1;
      flex-direction: column;
      animation: fadeIn 0.5s var(--ease-out);
    }

    .form-step.active {
      display: flex;
    }

    .step-title {
      font-family: var(--font-display);
      font-size: 32px;
      font-weight: 300;
      margin-bottom: var(--space-xl);
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: var(--space-lg);
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: var(--space-sm);
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-label .required {
      color: var(--error);
    }

    .form-input {
      width: 100%;
      padding: var(--space-md) var(--space-lg);
      font-family: var(--font-body);
      font-size: 16px;
      border: 1px solid var(--border-default);
      border-radius: 0;
      background: var(--bg-card);
      color: var(--text-primary);
      transition: all 0.3s var(--ease-out);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .form-input.error {
      border-color: var(--error);
    }

    textarea.form-input {
      resize: vertical;
      min-height: 100px;
      line-height: 1.5;
    }

    /* Checkbox */
    .checkbox-group {
      display: flex;
      align-items: flex-start;
      gap: var(--space-md);
      padding: var(--space-lg);
      border: 1px solid var(--border-subtle);
      border-radius: 0;
      margin-bottom: var(--space-md);
      cursor: pointer;
      transition: all 0.3s var(--ease-out);
      background: var(--bg-secondary);
    }

    .checkbox-group:hover {
      border-color: var(--border-strong);
      background: var(--bg-card);
    }

    .checkbox-group.checked {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .checkbox-custom {
      width: 22px;
      height: 22px;
      border: 1px solid var(--border-strong);
      border-radius: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.3s var(--ease-out);
      background: var(--bg-card);
    }

    .checkbox-custom svg {
      width: 14px;
      height: 14px;
      stroke: var(--bg-primary);
      stroke-width: 3;
      opacity: 0;
      transform: scale(0);
      transition: all 0.25s var(--ease-out);
    }

    .checkbox-group.checked .checkbox-custom {
      background: var(--accent);
      border-color: var(--accent);
    }

    .checkbox-group.checked .checkbox-custom svg {
      opacity: 1;
      transform: scale(1);
    }

    .checkbox-label {
      flex: 1;
    }

    .checkbox-label-title {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: var(--space-xs);
      color: var(--text-primary);
    }

    .checkbox-label-desc {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .checkbox-group input[type="checkbox"] {
      display: none;
    }

    /* Consent Scroll Box */
    .consent-scroll-box {
      max-height: 200px;
      overflow-y: auto;
      padding: var(--space-lg);
      border: 1px solid var(--border-subtle);
      background: var(--bg-secondary);
      margin-bottom: var(--space-lg);
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-secondary);
    }

    .consent-scroll-box::-webkit-scrollbar {
      width: 6px;
    }

    .consent-scroll-box::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    .consent-scroll-box::-webkit-scrollbar-thumb {
      background: var(--border-strong);
    }

    /* Instagram Handle Input (conditional) */
    .conditional-input {
      margin-left: 38px;
      margin-top: var(--space-sm);
      padding: var(--space-md);
      background: var(--bg-elevated);
      border-radius: 0;
      display: none;
      border: 1px solid var(--border-subtle);
    }

    .conditional-input.visible {
      display: block;
      animation: fadeIn 0.3s var(--ease-out);
    }

    .instagram-input {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .instagram-input span {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-muted);
    }

    .instagram-input input {
      flex: 1;
      padding: var(--space-sm) var(--space-md);
      font-family: var(--font-body);
      font-size: 15px;
      border: 1px solid var(--border-default);
      border-radius: 0;
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .instagram-input input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Signature Canvas */
    .signature-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .signature-info {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: var(--space-md);
      text-align: center;
    }

    .signature-canvas-wrapper {
      flex: 1;
      min-height: 250px;
      border: 1px solid var(--border-default);
      border-radius: 0;
      position: relative;
      background: #fafafa;
      overflow: hidden;
    }

    .signature-canvas {
      width: 100%;
      height: 100%;
      touch-action: none;
      cursor: crosshair;
    }

    .signature-placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-muted);
      font-size: 15px;
      pointer-events: none;
      transition: opacity 0.3s var(--ease-out);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-sm);
    }

    .signature-placeholder svg {
      width: 32px;
      height: 32px;
      stroke: var(--text-muted);
      stroke-width: 1.5;
      fill: none;
      opacity: 0.5;
    }

    .signature-canvas-wrapper.has-signature .signature-placeholder {
      opacity: 0;
    }

    .clear-signature-btn {
      margin-top: var(--space-md);
      padding: var(--space-sm) var(--space-lg);
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 500;
      border: 1px solid var(--border-default);
      border-radius: 0;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      cursor: pointer;
      align-self: flex-start;
      transition: all 0.3s var(--ease-out);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .clear-signature-btn svg {
      width: 16px;
      height: 16px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }

    .clear-signature-btn:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    /* Confirmation Summary */
    .confirmation-summary {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 0;
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
    }

    .summary-section {
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-lg);
      border-bottom: 1px solid var(--border-subtle);
    }

    .summary-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .summary-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--accent);
      margin-bottom: var(--space-md);
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: var(--space-sm);
    }

    .summary-label {
      color: var(--text-muted);
    }

    .summary-value {
      font-weight: 500;
      text-align: right;
      color: var(--text-primary);
    }

    .summary-value.success {
      color: var(--success);
    }

    .summary-value.error {
      color: var(--error);
    }

    .summary-signature {
      max-width: 180px;
      max-height: 70px;
      border: 1px solid var(--border-default);
      border-radius: 0;
      background: #fff;
    }

    /* Navigation Buttons */
    .form-nav {
      display: flex;
      justify-content: space-between;
      gap: var(--space-md);
      margin-top: auto;
      padding-top: var(--space-xl);
    }

    .btn {
      padding: var(--space-md) var(--space-xl);
      font-family: var(--font-body);
      font-size: 15px;
      font-weight: 500;
      border-radius: 0;
      cursor: pointer;
      transition: all 0.3s var(--ease-out);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: 1px solid var(--border-default);
    }

    .btn-secondary svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }

    .btn-secondary:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg-primary);
      flex: 1;
    }

    .btn-primary svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(184, 184, 184, 0.3);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
    }

    /* Success Screen */
    .success-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .success-checkmark {
      width: 100px;
      height: 100px;
      margin-bottom: var(--space-xl);
    }

    .success-checkmark circle {
      stroke: var(--success);
      stroke-width: 3;
      fill: none;
      stroke-dasharray: 283;
      stroke-dashoffset: 283;
      animation: circleAnim 0.6s var(--ease-out) forwards;
    }

    .success-checkmark path {
      stroke: var(--success);
      stroke-width: 3;
      fill: none;
      stroke-dasharray: 50;
      stroke-dashoffset: 50;
      animation: checkAnim 0.4s var(--ease-out) forwards 0.4s;
    }

    @keyframes circleAnim {
      to { stroke-dashoffset: 0; }
    }

    @keyframes checkAnim {
      to { stroke-dashoffset: 0; }
    }

    .success-title {
      font-family: var(--font-display);
      font-size: 36px;
      font-weight: 300;
      margin-bottom: var(--space-sm);
      color: var(--text-primary);
    }

    .success-message {
      font-size: 16px;
      color: var(--text-muted);
      margin-bottom: var(--space-2xl);
    }

    .countdown-bar {
      width: 180px;
      height: 3px;
      background: var(--border-subtle);
      border-radius: 2px;
      overflow: hidden;
    }

    .countdown-progress {
      height: 100%;
      background: var(--accent);
      animation: countdown 5s linear forwards;
    }

    @keyframes countdown {
      from { width: 100%; }
      to { width: 0%; }
    }

    /* Back Button */
    .back-btn {
      position: absolute;
      top: var(--space-xl);
      left: var(--space-xl);
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 0;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s var(--ease-out);
      opacity: 0.6;
    }

    .back-btn:hover {
      opacity: 1;
    }

    .back-btn svg {
      width: 20px;
      height: 20px;
      stroke: var(--text-secondary);
      stroke-width: 2;
      fill: none;
    }

    /* Loading Spinner */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 10, 10, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s var(--ease-out);
    }

    .loading-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 2px solid var(--border-subtle);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error Toast */
    .toast {
      position: fixed;
      bottom: var(--space-xl);
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: var(--space-md) var(--space-lg);
      background: var(--error);
      color: #fff;
      border-radius: 0;
      font-size: 14px;
      font-weight: 500;
      z-index: 1001;
      opacity: 0;
      transition: all 0.4s var(--ease-out);
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* AGB Link */
    .agb-link {
      color: var(--accent);
      text-decoration: none;
      border-bottom: 1px solid var(--accent);
      transition: opacity 0.2s;
    }

    .agb-link:hover {
      opacity: 0.8;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .app-container {
        padding: var(--space-lg) var(--space-md);
      }

      .language-toggle {
        display: none;
      }

      .back-btn {
        top: var(--space-lg);
        left: var(--space-md);
      }

      .choice-buttons {
        flex-direction: column;
        gap: var(--space-md);
      }

      .choice-btn {
        width: 100%;
      }

      .start-question {
        font-size: 28px;
      }

      .step-title {
        font-size: 26px;
      }
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <div class="scroll-content">
      <div class="app-container">
    <!-- Language Toggle -->
    <div class="language-toggle">
      <button class="lang-btn active" data-lang="de" aria-label="Deutsch">
        <span class="flag-icon">
          <svg viewBox="0 0 5 3" xmlns="http://www.w3.org/2000/svg">
            <rect width="5" height="1" y="0" fill="#000"/>
            <rect width="5" height="1" y="1" fill="#D00"/>
            <rect width="5" height="1" y="2" fill="#FFCE00"/>
          </svg>
        </span>
      </button>
      <button class="lang-btn" data-lang="en" aria-label="English">
        <span class="flag-icon">
          <svg viewBox="0 0 60 30" xmlns="http://www.w3.org/2000/svg">
            <clipPath id="s"><path d="M0,0 v30 h60 v-30 z"/></clipPath>
            <clipPath id="t"><path d="M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z"/></clipPath>
            <g clip-path="url(#s)">
              <path d="M0,0 v30 h60 v-30 z" fill="#012169"/>
              <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/>
              <path d="M0,0 L60,30 M60,0 L0,30" clip-path="url(#t)" stroke="#C8102E" stroke-width="4"/>
              <path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/>
              <path d="M30,0 v30 M0,15 h60" stroke="#C8102E" stroke-width="6"/>
            </g>
          </svg>
        </span>
      </button>
    </div>

    <!-- Logo -->
    <div class="logo-container">
      <div class="logo">
        <svg viewBox="0 0 100 100">
          <line x1="25" y1="35" x2="75" y2="35" stroke="#000" stroke-width="3"/>
          <line x1="25" y1="65" x2="75" y2="65" stroke="#000" stroke-width="3"/>
          <line x1="70" y1="20" x2="30" y2="80" stroke="#000" stroke-width="3"/>
        </svg>
      </div>
      <div class="logo-text">MOMMY I'M SORRY</div>
    </div>

    <!-- Screen 1: Start -->
    <div id="screen-start" class="screen active">
      <div class="start-content">
        <h1 class="start-question" data-i18n="firstVisit">Ist dies dein erster Besuch bei uns?</h1>
        <div class="choice-buttons">
          <button class="choice-btn" onclick="handleFirstVisit(true)">
            <div class="choice-btn-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 22V12M12 12C12 12 12 8 8 5C4 2 2 4 2 4C2 4 4 10 8 12C10 13 12 12 12 12ZM12 12C12 12 12 8 16 5C20 2 22 4 22 4C22 4 20 10 16 12C14 13 12 12 12 12Z"/>
              </svg>
            </div>
            <div class="choice-btn-title" data-i18n="yes">Ja</div>
            <div class="choice-btn-subtitle" data-i18n="firstTime">Erster Besuch</div>
          </button>
          <button class="choice-btn" onclick="handleFirstVisit(false)">
            <div class="choice-btn-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 21V19C20 16.79 18.21 15 16 15H8C5.79 15 4 16.79 4 19V21M12 11C14.21 11 16 9.21 16 7C16 4.79 14.21 3 12 3C9.79 3 8 4.79 8 7C8 9.21 9.79 11 12 11Z"/>
                <path d="M19 8L21 6M21 8L19 6" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="choice-btn-title" data-i18n="no">Nein</div>
            <div class="choice-btn-subtitle" data-i18n="beenHere">War schon hier</div>
          </button>
        </div>
      </div>
    </div>

    <!-- Screen 2: Search - REMOVED FOR GDPR COMPLIANCE -->

    <!-- Screen 3: Form -->
    <div id="screen-form" class="screen">
      <button class="back-btn" onclick="goBack()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>

      <div class="form-container">
        <!-- Progress Bar -->
        <div class="progress-bar">
          <div class="progress-step active" data-step="1"></div>
          <div class="progress-line"></div>
          <div class="progress-step" data-step="2"></div>
          <div class="progress-line"></div>
          <div class="progress-step" data-step="3"></div>
          <div class="progress-line"></div>
          <div class="progress-step" data-step="4"></div>
          <div class="progress-line"></div>
          <div class="progress-step" data-step="5"></div>
          <span class="progress-text"><span data-i18n="step">Schritt</span> <span id="currentStepNum">1</span> <span data-i18n="of">von</span> 5</span>
        </div>

        <!-- Step 1: Personal Data -->
        <div class="form-step active" data-step="1">
          <h2 class="step-title" data-i18n="personalData">Pers√∂nliche Daten</h2>

          <div class="form-group">
            <label class="form-label" data-i18n="firstName">Vorname <span class="required">*</span></label>
            <input type="text" class="form-input" id="firstName" required>
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="lastName">Nachname <span class="required">*</span></label>
            <input type="text" class="form-input" id="lastName" required>
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="dateOfBirth">Geburtsdatum <span class="required">*</span></label>
            <input type="text" class="form-input" id="dateOfBirth" placeholder="TT.MM.JJJJ" data-i18n-placeholder="dateOfBirthPlaceholder" required maxlength="10">
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="email">E-Mail</label>
            <input type="email" class="form-input" id="email">
          </div>

          <div class="form-nav">
            <div></div>
            <button class="btn btn-primary" onclick="nextStep()" data-i18n="next">Weiter</button>
          </div>
        </div>

        <!-- Step 2: Health -->
        <div class="form-step" data-step="2">
          <h2 class="step-title" data-i18n="health">Gesundheit</h2>

          <div class="form-group">
            <label class="form-label" data-i18n="allergies">Allergien</label>
            <textarea class="form-input" id="allergies" data-i18n-placeholder="allergiesPlaceholder"
                      placeholder="z.B. Latex, bestimmte Farben..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="medications">Medikamente</label>
            <textarea class="form-input" id="medications" data-i18n-placeholder="medicationsPlaceholder"
                      placeholder="Aktuelle Medikamente..."></textarea>
          </div>

          <div class="form-group">
            <label class="checkbox-group" id="healthConditionsGroup">
              <input type="checkbox" id="hasHealthConditions">
              <div class="checkbox-custom">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div class="checkbox-label">
                <div class="checkbox-label-title" data-i18n="healthConditions">Gesundheitliche Bedingungen</div>
                <div class="checkbox-label-desc" data-i18n="healthConditionsInfo">HIV, Hepatitis, Epilepsie, Diabetes oder andere relevante Bedingungen</div>
              </div>
            </label>

            <div class="conditional-input" id="healthDetailsWrapper">
              <textarea class="form-input" id="healthDetails" data-i18n-placeholder="healthDetailsPlaceholder"
                        placeholder="Bitte beschreibe deine gesundheitlichen Bedingungen"></textarea>
            </div>
          </div>

          <div class="form-nav">
            <button class="btn btn-secondary" onclick="prevStep()" data-i18n="back">Zur√ºck</button>
            <button class="btn btn-primary" onclick="nextStep()" data-i18n="next">Weiter</button>
          </div>
        </div>

        <!-- Step 3: Consent -->
        <div class="form-step" data-step="3">
          <h2 class="step-title" data-i18n="consent">Einwilligungen</h2>

          <!-- Scrollable Consent Text -->
          <div class="consent-scroll-box" id="consentText" data-i18n-html="consentScrollText">
            <strong>Allgemeine Gesch√§ftsbedingungen</strong><br><br><strong>1.</strong> Eine T√§towierung bei MOMMY I'M SORRY setzt grunds√§tzlich die Vollj√§hrigkeit voraus. Es gelten keine Ausnahmen.<br><br><strong>2.</strong> Der Kunde ist verpflichtet, MOMMY I'M SORRY √ºber m√∂gliche Allergien, Medikamente oder Krankheiten zu informieren (z. B. HIV, Hepatitis, Epilepsie, Diabetes etc.). Au√üerdem ist der Konsum von Alkohol und Drogen unmittelbar vor dem Termin nicht gestattet und kann bei Missachtung aus unterschiedlichen Gr√ºnden zum Abbruch der Sitzung f√ºhren. Es gelten unsere AGB.<br><br><strong>3.</strong> Das T√§towieren stellt einen Eingriff in die k√∂rperliche Integrit√§t dar. Mit seiner Unterschrift willigt der Kunde in den T√§towierprozess ein und best√§tigt, umfassend √ºber alle Risiken aufgekl√§rt worden zu sein (insbesondere √ºber die Gefahr von Infektionen oder Entz√ºndungen, allergische Reaktionen, Kreislaufbeschwerden, Schmerzen sowie √ºber seine Nachsorgepflicht). Um diese Risiken nach M√∂glichkeit zu minimieren, garantiert MOMMY I'M SORRY die strikte Beachtung aller gesetzlich vorgeschriebenen Hygienestandards und weist den Kunden nachdr√ºcklich darauf hin, die ausgeh√§ndigten Pflegehinweise zu beachten.<br><br><strong>4.</strong> Es kann sein, dass w√§hrend des Heilungsprozesses gewisse Motivver√§nderungen eintreten (Besenreiser, sogenannte Blow-outs, Farb- und Intensit√§tsverlust, Farbuntersp√ºlungen ins Bindegewebe, unkontrollierter Farbverlauf unter der Haut). Solche Ver√§nderungen k√∂nnen auf einer normalen Hautreaktion basieren, beruhen aber oftmals auf fehlerhafter Nachsorge. Der Kunde wurde √ºber die notwendige Nachsorge der T√§towierung aufgekl√§rt und nimmt zur Kenntnis, dass Nachl√§ssigkeit zu qualitativen Verlusten f√ºhren kann. F√ºr die bezeichneten Risiken √ºbernimmt der Kunde die alleinige Verantwortung.<br><br><strong>5.</strong> MOMMY I'M SORRY erstellt f√ºr jeden Kunden ein individuelles Tattoo-Motiv, sofern nicht anders gew√ºnscht oder vereinbart. Die gefertigten Motive dienen als Vorlage, die eine Vorstellung davon erm√∂glichen soll, wie das Tattoo aussehen wird. Absolute Identit√§t zwischen dem gezeichneten Motiv und der T√§towierung wird es nie geben k√∂nnen, da die Haut ein besonderes Medium ist, das sich naturgem√§√ü anders verh√§lt als Papier. Es kann z. B. zu einer anderen Farbwirkung oder Intensit√§t der Farben kommen. Zudem erfordert die T√§towierung eine Anpassung des Entwurfs an die individuelle K√∂rperform. Unter Umst√§nden k√∂nnen punktuelle Abweichungen von der Vorlage erforderlich sein. Die notwendige k√ºnstlerische Freiheit wird dem T√§towierer einger√§umt.<br><br><strong>6.</strong> Die Haut ist ein sensibles Organ, das nicht immer gleicherma√üen zur Aufnahme von Farbe in der Lage ist. Sollte nach Auffassung des T√§towierers am Tag der Sitzung die k√∂rperliche Verfassung des Kunden ein optimales Ergebnis gef√§hrden (z. B. starkes Bluten), beh√§lt sich MOMMY I'M SORRY vor, die Sitzung abzubrechen und zu verschieben.<br><br><strong>7.</strong> Sogenanntes Nachstechen ist grunds√§tzlich in den ersten f√ºnf Monaten nach Abschluss des Auftrages inklusive, sofern keine anderen Vereinbarungen mit dem K√ºnstler getroffen worden sind. Bitte erkundige dich vorher bei deinem gew√§hlten K√ºnstler.<br><br><strong>Einwilligung zur Bildnutzung</strong><br><br>Im Zuge des T√§towierprozesses werden m√∂glicherweise von MOMMY I'M SORRY Video- und Fotoaufnahmen zu sp√§teren Promotionszwecken erstellt. Die Aufnahmen werden ohne Namensnennung ver√∂ffentlicht, sofern ich nicht ausdr√ºcklich der Verlinkung meines Profils zustimme (siehe unten).<br><br>Mit der Unterzeichnung dieser Vereinbarung best√§tige ich, dass ich diese Bedingungen gelesen und verstanden habe.
          </div>

          <label class="checkbox-group" id="termsGroup">
            <input type="checkbox" id="termsAccepted" required>
            <div class="checkbox-custom">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="checkbox-label">
              <div class="checkbox-label-title">
                <span data-i18n="termsAcceptPre">Ich habe die </span>
                <a href="#" class="agb-link" onclick="event.stopPropagation(); showAGB()">AGB</a>
                <span data-i18n="termsAcceptPost"> gelesen und akzeptiere diese</span>
                <span class="required">*</span>
              </div>
            </div>
          </label>

          <label class="checkbox-group" id="socialMediaTagGroup">
            <input type="checkbox" id="socialMediaTagAccepted">
            <div class="checkbox-custom">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="checkbox-label">
              <div class="checkbox-label-title" data-i18n="socialMediaTag">Mein Profil darf verlinkt werden</div>
            </div>
          </label>

          <div class="conditional-input" id="instagramHandleWrapper">
            <div class="instagram-input">
              <span>@</span>
              <input type="text" id="instagramHandle" data-i18n-placeholder="instagramPlaceholder" placeholder="dein_handle">
            </div>
          </div>

          <div class="form-nav">
            <button class="btn btn-secondary" onclick="prevStep()" data-i18n="back">Zur√ºck</button>
            <button class="btn btn-primary" onclick="nextStep()" data-i18n="next">Weiter</button>
          </div>
        </div>

        <!-- Step 4: Signature -->
        <div class="form-step" data-step="4">
          <h2 class="step-title" data-i18n="signature">Unterschrift</h2>

          <div class="signature-container">
            <p class="signature-info" data-i18n="signatureInfo">Bitte unterschreibe mit deinem Finger im Feld unten</p>

            <div class="signature-canvas-wrapper" id="signatureWrapper">
              <canvas class="signature-canvas" id="signatureCanvas"></canvas>
              <div class="signature-placeholder" data-i18n="signHere">Hier unterschreiben</div>
            </div>

            <button class="clear-signature-btn" onclick="clearSignature()" data-i18n="clear">L√∂schen</button>
          </div>

          <div class="form-nav">
            <button class="btn btn-secondary" onclick="prevStep()" data-i18n="back">Zur√ºck</button>
            <button class="btn btn-primary" onclick="nextStep()" data-i18n="next">Weiter</button>
          </div>
        </div>

        <!-- Step 5: Confirmation -->
        <div class="form-step" data-step="5">
          <h2 class="step-title" data-i18n="confirmation">Best√§tigung</h2>

          <p style="color: var(--muted); margin-bottom: 24px;" data-i18n="reviewData">Bitte √ºberpr√ºfe deine Angaben</p>

          <div class="confirmation-summary" id="confirmationSummary">
            <!-- Filled by JavaScript -->
          </div>

          <div class="form-nav">
            <button class="btn btn-secondary" onclick="prevStep()" data-i18n="back">Zur√ºck</button>
            <button class="btn btn-primary" onclick="submitAgreement()" data-i18n="submit">Absenden</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Screen 4: Success -->
    <div id="screen-success" class="screen">
      <div class="success-content">
        <svg class="success-checkmark" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45"/>
          <path d="M30 50 L45 65 L70 35"/>
        </svg>
        <h2 class="success-title" data-i18n="thankYou">Vielen Dank!</h2>
        <p class="success-message" data-i18n="saved">Deine Einwilligung wurde gespeichert.</p>
        <div class="countdown-bar">
          <div class="countdown-progress"></div>
        </div>
      </div>
    </div>
  </div><!-- /.app-container -->
    </div><!-- /.scroll-content -->
  </div><!-- /.app-wrapper -->

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ============================================
    // PWA STANDALONE DETECTION - iPhone + iPad
    // ============================================

    // Mehrere Methoden zur Erkennung (iPad braucht mehr Checks)
    const isStandalone = (function() {
      // Method 1: Standard display-mode
      if (window.matchMedia('(display-mode: standalone)').matches) return true;

      // Method 2: iOS Safari (navigator.standalone)
      if (window.navigator.standalone === true) return true;

      // Method 3: URL Parameter (Fallback)
      if (window.location.search.includes('standalone=true')) return true;

      // Method 4: Android TWA
      if (document.referrer.includes('android-app://')) return true;

      // Method 5: Check if opened from homescreen (kein Referrer, kein Opener)
      if (!document.referrer && !window.opener && window.history.length === 1) {
        // K√∂nnte Standalone sein, aber nicht 100% sicher
        return 'maybe';
      }

      return false;
    })();

    // iPad-spezifische Erkennung (neue iPads melden sich als "MacIntel")
    const isIPad = (function() {
      return navigator.maxTouchPoints > 1 && /Mac/.test(navigator.platform);
    })();

    const isIPhone = /iPhone/.test(navigator.userAgent);
    const isIOS = isIPad || isIPhone;

    // Logging
    console.log('üì± Device Detection:', {
      isStandalone,
      isIPad,
      isIPhone,
      isIOS,
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      standalone: navigator.standalone
    });

    // Body-Klassen f√ºr CSS
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add(isStandalone ? 'pwa-standalone' : 'pwa-browser');
      document.body.classList.add(isIPad ? 'device-ipad' : 'device-other');
      document.body.classList.add(isIOS ? 'device-ios' : 'device-non-ios');

      if (isStandalone === true) {
        console.log('‚úÖ Running as PWA Standalone');
      } else if (isStandalone === 'maybe') {
        console.log('‚ùì Possibly running as PWA Standalone');
      } else {
        console.log('‚ÑπÔ∏è Running in Browser');
      }
    });

    // Wenn Standalone: Verhindere versehentliche Navigation
    if (isStandalone === true) {
      // Verhindere "Verlassen" der App
      window.addEventListener('beforeunload', (e) => {
        e.preventDefault();
        e.returnValue = '';
      });

      // Verhindere Link-Klicks die aus der App f√ºhren w√ºrden
      document.addEventListener('click', (e) => {
        const link = e.target.closest('a[href]');
        if (link && link.href && !link.href.includes(window.location.hostname)) {
          e.preventDefault();
          console.log('üö´ External link blocked:', link.href);
        }
      });
    }

    // Register Service Worker (optional - for offline support)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw-agreement.js')
        .then(reg => console.log('‚úÖ Service Worker registered'))
        .catch(err => console.log('‚ÑπÔ∏è Service Worker not available'));
    }

    // ============================================
    // INSTALL PROMPT F√úR IPAD (wenn nicht Standalone)
    // ============================================

    function showInstallInstructions() {
      // Nur anzeigen wenn: iPad + nicht Standalone + noch nicht dismissed
      if (!isIPad || isStandalone === true || sessionStorage.getItem('installDismissed')) {
        return;
      }

      const installHint = document.createElement('div');
      installHint.className = 'install-hint';
      installHint.innerHTML = `
        <div class="install-hint-content">
          <button class="install-hint-close" onclick="this.parentElement.parentElement.remove(); sessionStorage.setItem('installDismissed', 'true');">‚úï</button>
          <div class="install-hint-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
          </div>
          <div class="install-hint-text">
            <strong>F√ºr beste Erfahrung:</strong><br>
            Tippe auf <span class="share-icon">‚ñ°‚Üë</span> und dann<br>
            <strong>"Zum Home-Bildschirm"</strong>
          </div>
        </div>
      `;

      document.body.appendChild(installHint);
    }

    // Nach 2 Sekunden anzeigen
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(showInstallInstructions, 2000);
    });

    // ============================================
    // END PWA DETECTION
    // ============================================

    // Supabase Configuration
    const SUPABASE_URL = "https://auxxyehgzkozdjylhqnx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1eHh5ZWhnemtvemRqeWxocW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDczODgsImV4cCI6MjA3NjEyMzM4OH0.bg8NunF2qkps28Aj0ZqY35eKK--QOu8NduCkFyqp5KA";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Translations
    const translations = {
      de: {
        firstVisit: 'Ist dies dein erster Besuch bei uns?',
        yes: 'Ja',
        no: 'Nein',
        firstTime: 'Erster Besuch',
        beenHere: 'War schon hier',
        personalData: 'Pers√∂nliche Daten',
        firstName: 'Vorname',
        lastName: 'Nachname',
        dateOfBirth: 'Geburtsdatum',
        dateOfBirthPlaceholder: 'TT.MM.JJJJ',
        email: 'E-Mail',
        health: 'Gesundheit',
        allergies: 'Allergien',
        allergiesPlaceholder: 'z.B. Latex, bestimmte Farben...',
        medications: 'Medikamente',
        medicationsPlaceholder: 'Aktuelle Medikamente...',
        healthConditions: 'Gesundheitliche Bedingungen',
        healthConditionsInfo: 'HIV, Hepatitis, Epilepsie, Diabetes oder andere relevante Bedingungen',
        healthDetailsPlaceholder: 'Bitte beschreibe deine gesundheitlichen Bedingungen',
        consent: 'Einwilligungen',
        termsAcceptPre: 'Ich habe die ',
        termsAcceptPost: ' gelesen und akzeptiere diese',
        consentScrollText: '<strong>Allgemeine Gesch√§ftsbedingungen</strong><br><br><strong>1.</strong> Eine T√§towierung bei MOMMY I\'M SORRY setzt grunds√§tzlich die Vollj√§hrigkeit voraus. Es gelten keine Ausnahmen.<br><br><strong>2.</strong> Der Kunde ist verpflichtet, MOMMY I\'M SORRY √ºber m√∂gliche Allergien, Medikamente oder Krankheiten zu informieren (z. B. HIV, Hepatitis, Epilepsie, Diabetes etc.). Au√üerdem ist der Konsum von Alkohol und Drogen unmittelbar vor dem Termin nicht gestattet und kann bei Missachtung aus unterschiedlichen Gr√ºnden zum Abbruch der Sitzung f√ºhren. Es gelten unsere AGB.<br><br><strong>3.</strong> Das T√§towieren stellt einen Eingriff in die k√∂rperliche Integrit√§t dar. Mit seiner Unterschrift willigt der Kunde in den T√§towierprozess ein und best√§tigt, umfassend √ºber alle Risiken aufgekl√§rt worden zu sein (insbesondere √ºber die Gefahr von Infektionen oder Entz√ºndungen, allergische Reaktionen, Kreislaufbeschwerden, Schmerzen sowie √ºber seine Nachsorgepflicht). Um diese Risiken nach M√∂glichkeit zu minimieren, garantiert MOMMY I\'M SORRY die strikte Beachtung aller gesetzlich vorgeschriebenen Hygienestandards und weist den Kunden nachdr√ºcklich darauf hin, die ausgeh√§ndigten Pflegehinweise zu beachten.<br><br><strong>4.</strong> Es kann sein, dass w√§hrend des Heilungsprozesses gewisse Motivver√§nderungen eintreten (Besenreiser, sogenannte Blow-outs, Farb- und Intensit√§tsverlust, Farbuntersp√ºlungen ins Bindegewebe, unkontrollierter Farbverlauf unter der Haut). Solche Ver√§nderungen k√∂nnen auf einer normalen Hautreaktion basieren, beruhen aber oftmals auf fehlerhafter Nachsorge. Der Kunde wurde √ºber die notwendige Nachsorge der T√§towierung aufgekl√§rt und nimmt zur Kenntnis, dass Nachl√§ssigkeit zu qualitativen Verlusten f√ºhren kann. F√ºr die bezeichneten Risiken √ºbernimmt der Kunde die alleinige Verantwortung.<br><br><strong>5.</strong> MOMMY I\'M SORRY erstellt f√ºr jeden Kunden ein individuelles Tattoo-Motiv, sofern nicht anders gew√ºnscht oder vereinbart. Die gefertigten Motive dienen als Vorlage, die eine Vorstellung davon erm√∂glichen soll, wie das Tattoo aussehen wird. Absolute Identit√§t zwischen dem gezeichneten Motiv und der T√§towierung wird es nie geben k√∂nnen, da die Haut ein besonderes Medium ist, das sich naturgem√§√ü anders verh√§lt als Papier. Es kann z. B. zu einer anderen Farbwirkung oder Intensit√§t der Farben kommen. Zudem erfordert die T√§towierung eine Anpassung des Entwurfs an die individuelle K√∂rperform. Unter Umst√§nden k√∂nnen punktuelle Abweichungen von der Vorlage erforderlich sein. Die notwendige k√ºnstlerische Freiheit wird dem T√§towierer einger√§umt.<br><br><strong>6.</strong> Die Haut ist ein sensibles Organ, das nicht immer gleicherma√üen zur Aufnahme von Farbe in der Lage ist. Sollte nach Auffassung des T√§towierers am Tag der Sitzung die k√∂rperliche Verfassung des Kunden ein optimales Ergebnis gef√§hrden (z. B. starkes Bluten), beh√§lt sich MOMMY I\'M SORRY vor, die Sitzung abzubrechen und zu verschieben.<br><br><strong>7.</strong> Sogenanntes Nachstechen ist grunds√§tzlich in den ersten f√ºnf Monaten nach Abschluss des Auftrages inklusive, sofern keine anderen Vereinbarungen mit dem K√ºnstler getroffen worden sind. Bitte erkundige dich vorher bei deinem gew√§hlten K√ºnstler.<br><br><strong>Einwilligung zur Bildnutzung</strong><br><br>Im Zuge des T√§towierprozesses werden m√∂glicherweise von MOMMY I\'M SORRY Video- und Fotoaufnahmen zu sp√§teren Promotionszwecken erstellt. Die Aufnahmen werden ohne Namensnennung ver√∂ffentlicht, sofern ich nicht ausdr√ºcklich der Verlinkung meines Profils zustimme (siehe unten).<br><br>Mit der Unterzeichnung dieser Vereinbarung best√§tige ich, dass ich diese Bedingungen gelesen und verstanden habe.',
        socialMediaTag: 'Mein Profil darf verlinkt werden',
        instagramPlaceholder: 'dein_handle',
        signature: 'Unterschrift',
        signatureInfo: 'Bitte unterschreibe mit deinem Finger im Feld unten',
        signHere: 'Hier unterschreiben',
        clear: 'L√∂schen',
        confirmation: 'Best√§tigung',
        reviewData: 'Bitte √ºberpr√ºfe deine Angaben',
        submit: 'Absenden',
        back: 'Zur√ºck',
        next: 'Weiter',
        thankYou: 'Vielen Dank!',
        saved: 'Deine Einwilligung wurde gespeichert.',
        step: 'Schritt',
        of: 'von',
        required: 'Pflichtfeld',
        summaryPersonal: 'Pers√∂nliche Daten',
        summaryHealth: 'Gesundheit',
        summaryConsent: 'Einwilligungen',
        summarySignature: 'Unterschrift',
        none: 'Keine Angabe',
        accepted: 'Akzeptiert',
        notAccepted: 'Nicht akzeptiert',
        errorRequired: 'Bitte f√ºlle alle Pflichtfelder aus',
        errorSignature: 'Bitte unterschreibe das Formular',
        errorTerms: 'Bitte akzeptiere die AGB',
        errorSubmit: 'Fehler beim Speichern. Bitte versuche es erneut.',
        errorAge: 'Du musst mindestens 18 Jahre alt sein',
        errorDateFormat: 'Bitte gib das Datum im Format TT.MM.JJJJ ein'
      },
      en: {
        firstVisit: 'Is this your first visit?',
        yes: 'Yes',
        no: 'No',
        firstTime: 'First visit',
        beenHere: 'Been here before',
        personalData: 'Personal Information',
        firstName: 'First Name',
        lastName: 'Last Name',
        dateOfBirth: 'Date of Birth',
        dateOfBirthPlaceholder: 'DD.MM.YYYY',
        email: 'Email',
        health: 'Health',
        allergies: 'Allergies',
        allergiesPlaceholder: 'e.g. Latex, certain inks...',
        medications: 'Medications',
        medicationsPlaceholder: 'Current medications...',
        healthConditions: 'Health Conditions',
        healthConditionsInfo: 'HIV, Hepatitis, Epilepsy, Diabetes or other relevant conditions',
        healthDetailsPlaceholder: 'Please describe your health conditions',
        consent: 'Consent',
        termsAcceptPre: 'I have read and accept the ',
        termsAcceptPost: '',
        consentScrollText: '<strong>Terms and Conditions</strong><br><br><strong>1.</strong> A tattoo at MOMMY I\'M SORRY requires the customer to be of legal age (18+). No exceptions apply.<br><br><strong>2.</strong> The customer is obligated to inform MOMMY I\'M SORRY about any allergies, medications, or illnesses (e.g., HIV, Hepatitis, Epilepsy, Diabetes, etc.). Furthermore, the consumption of alcohol and drugs immediately before the appointment is not permitted and may lead to cancellation of the session for various reasons. Our terms and conditions apply.<br><br><strong>3.</strong> Tattooing constitutes an intervention in physical integrity. By signing, the customer consents to the tattooing process and confirms having been comprehensively informed about all risks (particularly the risk of infections or inflammations, allergic reactions, circulatory problems, pain, and aftercare obligations). To minimize these risks as much as possible, MOMMY I\'M SORRY guarantees strict compliance with all legally required hygiene standards and strongly advises the customer to follow the provided care instructions.<br><br><strong>4.</strong> During the healing process, certain changes to the design may occur (spider veins, so-called blow-outs, color and intensity loss, color bleeding into connective tissue, uncontrolled color spread under the skin). Such changes may be based on normal skin reactions but are often due to improper aftercare. The customer has been informed about the necessary aftercare and acknowledges that negligence may lead to quality loss. The customer assumes sole responsibility for these risks.<br><br><strong>5.</strong> MOMMY I\'M SORRY creates an individual tattoo design for each customer, unless otherwise desired or agreed. The designs serve as templates to give an idea of how the tattoo will look. Absolute identity between the drawn design and the tattoo will never be possible, as skin is a special medium that naturally behaves differently than paper. For example, different color effects or intensity may occur. Additionally, the tattoo requires adaptation of the design to the individual body shape. Point-by-point deviations from the template may be necessary. The necessary artistic freedom is granted to the tattoo artist.<br><br><strong>6.</strong> The skin is a sensitive organ that is not always equally capable of absorbing color. If, in the tattoo artist\'s opinion, the customer\'s physical condition on the day of the session jeopardizes an optimal result (e.g., heavy bleeding), MOMMY I\'M SORRY reserves the right to cancel and reschedule the session.<br><br><strong>7.</strong> So-called touch-ups are generally included within the first five months after completion of the order, unless other arrangements have been made with the artist. Please inquire with your chosen artist beforehand.<br><br><strong>Consent for Image Use</strong><br><br>During the tattooing process, MOMMY I\'M SORRY may create video and photo recordings for later promotional purposes. The recordings will be published without identifying information unless I explicitly consent to having my profile linked (see below).<br><br>By signing this agreement, I confirm that I have read and understood these terms.',
        socialMediaTag: 'My profile may be tagged',
        instagramPlaceholder: 'your_handle',
        signature: 'Signature',
        signatureInfo: 'Please sign with your finger in the field below',
        signHere: 'Sign here',
        clear: 'Clear',
        confirmation: 'Confirmation',
        reviewData: 'Please review your information',
        submit: 'Submit',
        back: 'Back',
        next: 'Next',
        thankYou: 'Thank you!',
        saved: 'Your consent has been saved.',
        step: 'Step',
        of: 'of',
        required: 'Required',
        summaryPersonal: 'Personal Information',
        summaryHealth: 'Health',
        summaryConsent: 'Consent',
        summarySignature: 'Signature',
        none: 'Not specified',
        accepted: 'Accepted',
        notAccepted: 'Not accepted',
        errorRequired: 'Please fill in all required fields',
        errorSignature: 'Please sign the form',
        errorTerms: 'Please accept the terms and conditions',
        errorSubmit: 'Error saving. Please try again.',
        errorAge: 'You must be at least 18 years old',
        errorDateFormat: 'Please enter the date in DD.MM.YYYY format'
      }
    };

    // State
    let currentLang = 'de';
    let currentStep = 1;
    let selectedCustomer = null;
    let signatureCanvas = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initLanguageToggle();
      initCheckboxes();
      initSignatureCanvas();
      updateTranslations();
    });

    // Language Toggle
    function initLanguageToggle() {
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const lang = btn.dataset.lang;
          if (lang !== currentLang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.documentElement.lang = lang;
            updateTranslations();
          }
        });
      });
    }

    function updateTranslations() {
      const tr = translations[currentLang];

      // Text content
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (tr[key]) {
          el.textContent = tr[key];
        }
      });

      // Placeholders
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.dataset.i18nPlaceholder;
        if (tr[key]) {
          el.placeholder = tr[key];
        }
      });

      // HTML content (for scroll boxes)
      document.querySelectorAll('[data-i18n-html]').forEach(el => {
        const key = el.dataset.i18nHtml;
        if (tr[key]) {
          el.innerHTML = tr[key];
        }
      });
    }

    function t(key) {
      return translations[currentLang][key] || key;
    }

    // Navigation
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    window.goToStart = function() {
      selectedCustomer = null;
      currentStep = 1;
      resetForm();
      showScreen('screen-start');
    };

    window.goBack = function() {
      if (currentStep === 1) {
        window.goToStart();
      }
    };

    // First Visit Handler - Both options go to form (GDPR compliant)
    window.handleFirstVisit = function(isFirst) {
      // Both paths lead to the same form for GDPR compliance
      // No customer search/listing to avoid data exposure
      window.startNewCustomerForm();
    };

    window.startNewCustomerForm = function() {
      selectedCustomer = null;
      resetForm();
      currentStep = 1;
      updateProgressBar();
      showScreen('screen-form');
    };

    // Customer Search - REMOVED FOR GDPR COMPLIANCE
    // No customer data is displayed or searched to protect privacy

    // Checkboxes
    function initCheckboxes() {
      // Toggle checkbox styling
      document.querySelectorAll('.checkbox-group').forEach(group => {
        const checkbox = group.querySelector('input[type="checkbox"]');

        group.addEventListener('click', (e) => {
          if (e.target.tagName === 'A') return;
          checkbox.checked = !checkbox.checked;
          group.classList.toggle('checked', checkbox.checked);

          // Handle conditional inputs
          if (checkbox.id === 'hasHealthConditions') {
            document.getElementById('healthDetailsWrapper').classList.toggle('visible', checkbox.checked);
          }
          if (checkbox.id === 'socialMediaTagAccepted') {
            document.getElementById('instagramHandleWrapper').classList.toggle('visible', checkbox.checked);
          }
        });
      });
    }

    // Signature Canvas
    function initSignatureCanvas() {
      const canvas = document.getElementById('signatureCanvas');
      const wrapper = document.getElementById('signatureWrapper');
      const ctx = canvas.getContext('2d');

      let isDrawing = false;
      let lastX = 0;
      let lastY = 0;

      function setupCanvas() {
        const rect = wrapper.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;

        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';

        ctx.scale(dpr, dpr);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#000';
      }

      function getPosition(e) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return {
          x: touch.clientX - rect.left,
          y: touch.clientY - rect.top
        };
      }

      function startDrawing(e) {
        e.preventDefault();
        isDrawing = true;
        const pos = getPosition(e);
        lastX = pos.x;
        lastY = pos.y;
        wrapper.classList.add('has-signature');
      }

      function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();

        const pos = getPosition(e);

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();

        lastX = pos.x;
        lastY = pos.y;
      }

      function stopDrawing() {
        isDrawing = false;
      }

      // Touch events
      canvas.addEventListener('touchstart', startDrawing);
      canvas.addEventListener('touchmove', draw);
      canvas.addEventListener('touchend', stopDrawing);

      // Mouse events (for testing)
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseleave', stopDrawing);

      // Setup on resize
      window.addEventListener('resize', setupCanvas);
      setTimeout(setupCanvas, 100);

      signatureCanvas = {
        canvas,
        ctx,
        wrapper,
        resize: setupCanvas,
        clear: () => {
          const rect = wrapper.getBoundingClientRect();
          ctx.clearRect(0, 0, rect.width, rect.height);
          wrapper.classList.remove('has-signature');
        },
        isEmpty: () => {
          return !wrapper.classList.contains('has-signature');
        },
        toDataURL: () => {
          return canvas.toDataURL('image/png');
        }
      };
    }

    window.clearSignature = function() {
      if (signatureCanvas) {
        signatureCanvas.clear();
      }
    };

    // Form Steps
    function updateProgressBar() {
      document.querySelectorAll('.progress-step').forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed');

        if (stepNum === currentStep) {
          step.classList.add('active');
        } else if (stepNum < currentStep) {
          step.classList.add('completed');
        }
      });

      document.querySelectorAll('.progress-line').forEach((line, index) => {
        line.classList.toggle('completed', index + 1 < currentStep);
      });

      document.getElementById('currentStepNum').textContent = currentStep;

      document.querySelectorAll('.form-step').forEach(step => {
        step.classList.toggle('active', parseInt(step.dataset.step) === currentStep);
      });
    }

    // Parse DD.MM.YYYY date format
    function parseDateDMY(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split('.');
      if (parts.length !== 3) return null;
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      const year = parseInt(parts[2], 10);
      if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
      if (day < 1 || day > 31 || month < 1 || month > 12 || year < 1900 || year > 2100) return null;
      return new Date(year, month - 1, day);
    }

    // Convert DD.MM.YYYY to YYYY-MM-DD for database
    function convertToISODate(dateStr) {
      const date = parseDateDMY(dateStr);
      if (!date) return null;
      return date.toISOString().split('T')[0];
    }

    function validateStep(step) {
      if (step === 1) {
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const dob = document.getElementById('dateOfBirth').value.trim();

        if (!firstName || !lastName || !dob) {
          showToast(t('errorRequired'));
          return false;
        }

        // Parse DD.MM.YYYY format
        const birthDate = parseDateDMY(dob);
        if (!birthDate) {
          showToast(t('errorDateFormat'));
          return false;
        }

        // Check if customer is at least 18 years old
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        if (age < 18) {
          showToast(t('errorAge'));
          return false;
        }
      }

      if (step === 3) {
        const termsAccepted = document.getElementById('termsAccepted').checked;
        if (!termsAccepted) {
          showToast(t('errorTerms'));
          return false;
        }
      }

      if (step === 4) {
        if (signatureCanvas.isEmpty()) {
          showToast(t('errorSignature'));
          return false;
        }
      }

      return true;
    }

    window.nextStep = function() {
      if (!validateStep(currentStep)) return;

      if (currentStep < 5) {
        currentStep++;
        updateProgressBar();

        if (currentStep === 4) {
          // Resize signature canvas when step becomes visible
          setTimeout(() => {
            if (signatureCanvas) signatureCanvas.resize();
          }, 50);
        }

        if (currentStep === 5) {
          renderConfirmationSummary();
        }
      }
    };

    window.prevStep = function() {
      if (currentStep > 1) {
        currentStep--;
        updateProgressBar();

        if (currentStep === 4) {
          // Resize signature canvas when step becomes visible
          setTimeout(() => {
            if (signatureCanvas) signatureCanvas.resize();
          }, 50);
        }
      }
    };

    function renderConfirmationSummary() {
      const summary = document.getElementById('confirmationSummary');
      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      const dob = document.getElementById('dateOfBirth').value;
      const email = document.getElementById('email').value;
      const allergies = document.getElementById('allergies').value;
      const medications = document.getElementById('medications').value;
      const termsAccepted = document.getElementById('termsAccepted').checked;
      const socialMediaTag = document.getElementById('socialMediaTagAccepted').checked;
      const instagramHandle = document.getElementById('instagramHandle').value;
      const signatureData = signatureCanvas.toDataURL();

      const dobParsed = parseDateDMY(dob);
      const dobFormatted = dobParsed ? dobParsed.toLocaleDateString(currentLang === 'de' ? 'de-DE' : 'en-GB') : (dob || '-');

      summary.innerHTML = `
        <div class="summary-section">
          <div class="summary-section-title">${t('summaryPersonal')}</div>
          <div class="summary-row">
            <span class="summary-label">${t('firstName')}</span>
            <span class="summary-value">${firstName}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">${t('lastName')}</span>
            <span class="summary-value">${lastName}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">${t('dateOfBirth')}</span>
            <span class="summary-value">${dobFormatted}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">${t('email')}</span>
            <span class="summary-value">${email || '-'}</span>
          </div>
        </div>

        <div class="summary-section">
          <div class="summary-section-title">${t('summaryHealth')}</div>
          <div class="summary-row">
            <span class="summary-label">${t('allergies')}</span>
            <span class="summary-value">${allergies || t('none')}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">${t('medications')}</span>
            <span class="summary-value">${medications || t('none')}</span>
          </div>
        </div>

        <div class="summary-section">
          <div class="summary-section-title">${t('summaryConsent')}</div>
          <div class="summary-row">
            <span class="summary-label">AGB</span>
            <span class="summary-value">${termsAccepted ? t('accepted') : t('notAccepted')}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">${t('socialMediaTag')}</span>
            <span class="summary-value">${socialMediaTag ? (instagramHandle ? '@' + instagramHandle : t('accepted')) : t('notAccepted')}</span>
          </div>
        </div>

        <div class="summary-section">
          <div class="summary-section-title">${t('summarySignature')}</div>
          <img src="${signatureData}" alt="Signature" class="summary-signature">
        </div>
      `;
    }

    // Submit
    window.submitAgreement = async function() {
      showLoading(true);

      try {
        const formData = {
          firstName: document.getElementById('firstName').value.trim(),
          lastName: document.getElementById('lastName').value.trim(),
          dateOfBirth: convertToISODate(document.getElementById('dateOfBirth').value.trim()) || null,
          email: document.getElementById('email').value.trim() || null,
          allergies: document.getElementById('allergies').value.trim() || null,
          medications: document.getElementById('medications').value.trim() || null,
          hasHealthConditions: document.getElementById('hasHealthConditions').checked,
          healthDetails: document.getElementById('healthDetails').value.trim() || null,
          termsAccepted: document.getElementById('termsAccepted').checked,
          socialMediaTagAccepted: document.getElementById('socialMediaTagAccepted').checked,
          instagramHandle: document.getElementById('instagramHandle').value.trim() || null
        };

        const signatureData = signatureCanvas.toDataURL();
        const customerId = selectedCustomer?.id || null;

        // Auto-match appointment
        let appointmentId = null;
        if (customerId) {
          appointmentId = await autoMatchAppointment(customerId);
        }

        // Save agreement
        const { data: agreement, error } = await supabaseClient
          .from('agreements')
          .insert([{
            customer_id: customerId,
            appointment_id: appointmentId,
            first_name: formData.firstName,
            last_name: formData.lastName,
            date_of_birth: formData.dateOfBirth,
            email: formData.email,
            allergies: formData.allergies,
            medications: formData.medications,
            has_health_conditions: formData.hasHealthConditions,
            health_conditions_details: formData.healthDetails,
            terms_accepted: formData.termsAccepted,
            social_media_tag_accepted: formData.socialMediaTagAccepted,
            social_media_handle: formData.instagramHandle,
            signature_data: signatureData,
            signed_at: new Date().toISOString(),
            language: currentLang
          }])
          .select()
          .single();

        if (error) throw error;

        // Update customer allergies if known customer
        if (customerId && (formData.allergies || formData.medications)) {
          await supabaseClient
            .from('customers')
            .update({
              allergies: formData.allergies,
              medications: formData.medications,
              health_notes: formData.healthDetails
            })
            .eq('id', customerId);
        }

        showLoading(false);
        showSuccessScreen();

      } catch (err) {
        console.error('Submit error:', err);
        showLoading(false);
        showToast(t('errorSubmit'));
      }
    };

    async function autoMatchAppointment(customerId) {
      try {
        const today = new Date().toISOString().split('T')[0];

        const { data: appointments, error } = await supabaseClient
          .from('appointments')
          .select('id')
          .eq('customer_id', customerId)
          .gte('start', `${today}T00:00:00`)
          .lte('start', `${today}T23:59:59`)
          .order('start', { ascending: true })
          .limit(1);

        if (error) throw error;

        if (appointments && appointments.length > 0) {
          return appointments[0].id;
        }

        return null;
      } catch (err) {
        console.error('Auto-match error:', err);
        return null;
      }
    }

    function showSuccessScreen() {
      showScreen('screen-success');

      // Auto-reset after 5 seconds
      setTimeout(() => {
        goToStart();
      }, 5000);
    }

    // UI Helpers
    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('visible', show);
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('visible');

      setTimeout(() => {
        toast.classList.remove('visible');
      }, 3000);
    }

    function resetForm() {
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('dateOfBirth').value = '';
      document.getElementById('email').value = '';
      document.getElementById('allergies').value = '';
      document.getElementById('medications').value = '';
      document.getElementById('healthDetails').value = '';
      document.getElementById('instagramHandle').value = '';

      document.querySelectorAll('.checkbox-group').forEach(group => {
        const checkbox = group.querySelector('input[type="checkbox"]');
        checkbox.checked = false;
        group.classList.remove('checked');
      });

      document.getElementById('healthDetailsWrapper').classList.remove('visible');
      document.getElementById('instagramHandleWrapper').classList.remove('visible');

      if (signatureCanvas) {
        signatureCanvas.clear();
      }
    }

    window.showAGB = function() {
      // TODO: Show AGB modal or link
      window.open('https://mommyimsorry.de/agb', '_blank');
    };

    // Expose showSuccessScreen for testing
    window.showSuccessScreen = showSuccessScreen;
  </script>
</body>
</html>
